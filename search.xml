<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>æ‰“é€  L5 çº§äººæœºååŒä¸å…¨åŒå·¥è¯­éŸ³çš„ AI é¢è¯•å®˜</title>
      <link href="/2025/12/01/agent-advance-high/"/>
      <url>/2025/12/01/agent-advance-high/</url>
      
        <content type="html"><![CDATA[<h1>ğŸš€ [å®æˆ˜] è¿›åŒ–ï¼ä»è„šæœ¬åˆ°æ•°å­—å‘˜å·¥ï¼šæ‰“é€  L5 çº§äººæœºååŒä¸å…¨åŒå·¥è¯­éŸ³çš„ AI é¢è¯•å®˜</h1><blockquote><p><strong>æ‘˜è¦</strong>ï¼šä»Šå¤©æ˜¯ä¸€ä¸ªé‡Œç¨‹ç¢‘ã€‚æˆ‘ä»¬å°† <code>JD_Agent</code> ä»ä¸€ä¸ªç®€å•çš„ RAG é—®ç­”å·¥å…·ï¼Œå½»åº•é‡æ„ä¸ºä¸€ä¸ªå…·å¤‡ <strong>L5 çº§åˆ«è‡ªä¸»æ€§</strong> çš„å¤šæ™ºèƒ½ä½“ç³»ç»Ÿã€‚åŒæ—¶ï¼Œæˆ‘ä»¬æ”»å…‹äº† <strong>å…¨åŒå·¥è¯­éŸ³äº¤äº’</strong> å’Œ <strong>DeepSeek é£æ ¼æ€è€ƒè¿‡ç¨‹</strong> çš„å·¥ç¨‹éš¾é¢˜ï¼Œè®© AI ä¸ä»…èƒ½â€œæ€è€ƒâ€ï¼Œè¿˜èƒ½åƒçœŸäººä¸€æ ·â€œå€¾å¬â€å’Œâ€œè¡¨è¾¾â€ã€‚</p></blockquote><hr><h2 id="ğŸŒŸ-æ¶æ„å…¨æ™¯å›¾-The-Big-Picture">ğŸŒŸ æ¶æ„å…¨æ™¯å›¾ (The Big Picture)</h2><p>åœ¨ v2.0 ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬ä¸å†ç®€å•çš„çº¿æ€§è°ƒç”¨ LLMï¼Œè€Œæ˜¯æ„å»ºäº†ä¸€ä¸ªå¤æ‚çš„<strong>å¤šæ™ºèƒ½ä½“åä½œç½‘ç»œ</strong>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    User((ğŸ™â€â™‚ï¸ ç”¨æˆ·)) &lt;--&gt;|Web Audio / SSE| Frontend[ğŸ–¥ï¸ Next.js å‰ç«¯]</span><br><span class="line">    Frontend &lt;--&gt;|HTTP / Stream| Backend[âš™ï¸ FastAPI åç«¯]</span><br><span class="line"></span><br><span class="line">    subgraph &quot;ğŸ§  æ™ºèƒ½ä½“å¤§è„‘ (LangGraph)&quot;</span><br><span class="line">        Start(å¼€å§‹) --&gt; Parser[ğŸ” èŒä½è§£æå‘˜]</span><br><span class="line">        Parser --&gt; Researcher[ğŸ•µï¸ å•†ä¸šæƒ…æŠ¥å‘˜]</span><br><span class="line">        Parser --&gt; TechLead[ğŸ’» æŠ€æœ¯é¢è¯•å®˜]</span><br><span class="line">        </span><br><span class="line">        Researcher --&gt; Context&#123;ä¿¡æ¯æ±‡æ€»&#125;</span><br><span class="line">        TechLead --&gt; Reviewer[âš–ï¸ è´¨é‡æ£€å¯Ÿå‘˜]</span><br><span class="line">        </span><br><span class="line">        Reviewer --&gt;|è¯„åˆ† &lt; 85| TechLead</span><br><span class="line">        Reviewer --&gt;|è¯„åˆ† &gt;= 85| End(âœ… è¾“å‡ºæŠ¥å‘Š)</span><br><span class="line">        </span><br><span class="line">        Reviewer -.-&gt;|æ‹¿æä¸å‡†| Human[ğŸ›‘ äººå·¥ä»‹å…¥]</span><br><span class="line">        Human --&gt; TechLead</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    subgraph &quot;ğŸ”Š è¯­éŸ³äº¤äº’å±‚&quot;</span><br><span class="line">        ASR[ğŸ‘‚ Whisper ASR]</span><br><span class="line">        TTS[ğŸ—£ï¸ macOS Native TTS]</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    Backend --&gt; ASR</span><br><span class="line">    Backend --&gt; TTS</span><br><span class="line">    Backend --&gt; Start</span><br></pre></td></tr></table></figure><hr><h2 id="æ ¸å¿ƒçªç ´ä¸€ï¼šL5-çº§å¤šæ™ºèƒ½ä½“ååŒ-LangGraph">æ ¸å¿ƒçªç ´ä¸€ï¼šL5 çº§å¤šæ™ºèƒ½ä½“ååŒ (LangGraph)</h2><p>æˆ‘ä»¬è¦è§£å†³çš„æ ¸å¿ƒç—›ç‚¹æ˜¯ï¼š<strong>AI ç”Ÿæˆçš„å†…å®¹å¾€å¾€ä¸å¤Ÿæ·±åº¦ï¼Œæˆ–è€…ä¸€æœ¬æ­£ç»èƒ¡è¯´å…«é“ã€‚</strong><br>è§£å†³æ–¹æ¡ˆæ˜¯å¼•å…¥ <strong>Reviewer (è´¨æ£€å‘˜)</strong> è§’è‰²ï¼Œå½¢æˆè´¨é‡é—­ç¯ã€‚</p><h3 id="1-å®šä¹‰â€œå›¢é˜Ÿâ€-The-Team">1. å®šä¹‰â€œå›¢é˜Ÿâ€ (The Team)</h3><p>æˆ‘ä»¬ä¸å†æ˜¯ä¸€ä¸ª Agent æ‰“å¤©ä¸‹ï¼Œè€Œæ˜¯é€šè¿‡ <code>LangGraph</code> ç»„å»ºäº†ä¸€ä¸ªè™šæ‹Ÿå›¢é˜Ÿï¼š</p><ul><li><strong>Tech Lead</strong>: è´Ÿè´£æ ¹æ® JD å‡ºé¢˜ã€‚</li><li><strong>Reviewer</strong>: è´Ÿè´£ç»™é¢˜ç›®æ‰“åˆ†ã€‚å¦‚æœä¸åˆæ ¼ï¼Œæ‰“å›é‡å†™ã€‚</li></ul><h3 id="2-ä»£ç å®ç°-Workflow">2. ä»£ç å®ç° (Workflow)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># src/app/graph/workflow.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰è·¯ç”±é€»è¾‘ï¼šå†³å®šæ˜¯â€œé€šè¿‡â€è¿˜æ˜¯â€œé‡å†™â€</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">qa_router</span>(<span class="params">state: AgentState</span>):</span><br><span class="line">    <span class="comment"># 1. é˜²æ­¢æ­»å¾ªç¯</span></span><br><span class="line">    <span class="keyword">if</span> state[<span class="string">&quot;iteration_count&quot;</span>] &gt; <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;approved&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. è´¨é‡æŠŠå…³</span></span><br><span class="line">    <span class="keyword">if</span> state[<span class="string">&quot;quality_score&quot;</span>] &gt;= <span class="number">85</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;approved&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;rejected&quot;</span> <span class="comment"># â¬…ï¸ è¿™é‡Œçš„ rejected ä¼šå¯¼è‡´å›æ»š</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„å»ºå›¾</span></span><br><span class="line">workflow = StateGraph(AgentState)</span><br><span class="line">workflow.add_node(<span class="string">&quot;tech_lead&quot;</span>, tech_lead_node)</span><br><span class="line">workflow.add_node(<span class="string">&quot;reviewer&quot;</span>, reviewer_node)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–æ’å¾ªç¯</span></span><br><span class="line">workflow.add_edge(<span class="string">&quot;tech_lead&quot;</span>, <span class="string">&quot;reviewer&quot;</span>)</span><br><span class="line">workflow.add_conditional_edges(</span><br><span class="line">    <span class="string">&quot;reviewer&quot;</span>,</span><br><span class="line">    qa_router,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;approved&quot;</span>: END,</span><br><span class="line">        <span class="string">&quot;rejected&quot;</span>: <span class="string">&quot;tech_lead&quot;</span> <span class="comment"># ğŸ”„ å…³é”®ï¼šæ‰“å›é‡å†™</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><hr><h2 id="æ ¸å¿ƒçªç ´äºŒï¼šDeepSeek-é£æ ¼çš„â€œæ€è€ƒè¿‡ç¨‹â€-UI">æ ¸å¿ƒçªç ´äºŒï¼šDeepSeek é£æ ¼çš„â€œæ€è€ƒè¿‡ç¨‹â€ UI</h2><p>ä¸ºäº†ç¼“è§£ L5 æ¶æ„æ¨ç†æ—¶é—´é•¿ï¼ˆå¯èƒ½è¾¾ 1-2 åˆ†é’Ÿï¼‰å¸¦æ¥çš„ç„¦è™‘æ„Ÿï¼Œæˆ‘ä»¬å¤åˆ»äº† DeepSeek R1 çš„äº¤äº’ä½“éªŒï¼š<strong>æŠŠ AI çš„æ€è€ƒè¿‡ç¨‹é€æ˜åŒ–</strong>ã€‚</p><h3 id="1-åŒæµåè®®è®¾è®¡-Dual-Stream-Protocol">1. åŒæµåè®®è®¾è®¡ (Dual Stream Protocol)</h3><p>åç«¯ä¸å†åªè¿”å›æ–‡æœ¬ï¼Œè€Œæ˜¯è¿”å› <strong>JSON äº‹ä»¶æµ</strong>ï¼š</p><ul><li><code>type: &quot;thought&quot;</code> -&gt; æ€è€ƒæ­¥éª¤ï¼ˆå¦‚â€œæ­£åœ¨æ£€ç´¢è´¢æŠ¥â€¦â€ï¼‰</li><li><code>type: &quot;token&quot;</code> -&gt; æœ€ç»ˆå›å¤å†…å®¹</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åç«¯ SSE æ¨é€çš„æ•°æ®æµç¤ºä¾‹</span></span><br><span class="line">data<span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;thought&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;æ­£åœ¨åˆ†æ JD æŠ€æœ¯æ ˆ...&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">data<span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;thought&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;æ­£åœ¨æ„æ€è¿½é—®ç­–ç•¥...&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">data<span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;token&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;æ‚¨å¥½ï¼Œ&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">data<span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;token&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;æ ¹æ®æ‚¨çš„ç»å†...&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="2-å‰ç«¯å¯è§†åŒ–ç»„ä»¶-Thinking-Block">2. å‰ç«¯å¯è§†åŒ–ç»„ä»¶ (Thinking Block)</h3><p>å‰ç«¯å®ç°äº†ä¸€ä¸ªå¯æŠ˜å çš„é¢æ¿ï¼Œå®æ—¶æ¸²æŸ“ <code>thought</code> æµã€‚</p><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/components/ThinkingBlock.tsx</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">ThinkingBlock</span>(<span class="params">&#123; thoughts, isFinished &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;bg-gray-50 border rounded-xl p-4&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;flex items-center gap-2 text-gray-500&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          &#123;isFinished ? <span class="tag">&lt;<span class="name">BrainCircuit</span> /&gt;</span> : <span class="tag">&lt;<span class="name">Loader2</span> <span class="attr">className</span>=<span class="string">&quot;animate-spin&quot;</span>/&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;isFinished ? &quot;æ·±åº¦æ€è€ƒå®Œæˆ&quot; : &quot;DeepSeek æ­£åœ¨æ€è€ƒ...&quot;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       </span></span><br><span class="line"><span class="language-xml">       &#123;/* åŠ¨æ€æ¸²æŸ“æ€è€ƒæ­¥éª¤ */&#125;</span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">ul</span> <span class="attr">className</span>=<span class="string">&quot;mt-2 space-y-1 border-l-2 border-gray-200 pl-4&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          &#123;thoughts.map(step =&gt; (</span></span><br><span class="line"><span class="language-xml">             <span class="tag">&lt;<span class="name">li</span> <span class="attr">className</span>=<span class="string">&quot;text-xs text-gray-600 animate-in fade-in&quot;</span>&gt;</span>&#123;step&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          ))&#125;</span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="æ ¸å¿ƒçªç ´ä¸‰ï¼šå…¨åŒå·¥è¯­éŸ³äº¤äº’-ASR-TTS">æ ¸å¿ƒçªç ´ä¸‰ï¼šå…¨åŒå·¥è¯­éŸ³äº¤äº’ (ASR + TTS)</h2><p>æˆ‘ä»¬å®ç°äº† <strong>å½•éŸ³ -&gt; ASR -&gt; LLM -&gt; TTS</strong> çš„å®Œæ•´é—­ç¯ï¼Œè®© AI å˜èº«ä¸ºçœŸæ­£çš„é¢è¯•å®˜ã€‚</p><h3 id="1-è¯­éŸ³åˆæˆ-TTS-çš„é¿å‘ä¹‹è·¯">1. è¯­éŸ³åˆæˆ (TTS) çš„é¿å‘ä¹‹è·¯</h3><p>è¿™æ˜¯ä»Šå¤©é‡åˆ°çš„æœ€å¤§å·¥ç¨‹æŒ‘æˆ˜ã€‚</p><ul><li>âŒ <strong>Edge-TTS</strong>: åœ¨å›½å†…ç½‘ç»œç¯å¢ƒä¸‹é¢‘ç¹æŠ¥ <code>503 Service Unavailable</code>ï¼Œä¸ç¨³å®šã€‚</li><li>âŒ <strong>Pyttsx3</strong>: ç”Ÿæˆçš„ AIFF æ ¼å¼åœ¨ Chrome æµè§ˆå™¨ä¸­æ— æ³•æ’­æ”¾ (<code>NotSupportedError</code>)ã€‚</li><li>âœ… <strong>macOS åŸç”Ÿ <code>say</code> å‘½ä»¤</strong>: <strong>æœ€ç»ˆæ–¹æ¡ˆï¼</strong></li></ul><p>åˆ©ç”¨ Mac ç³»ç»Ÿåº•å±‚çš„ <code>say</code> å‘½ä»¤ç”Ÿæˆ <code>.m4a</code> æ–‡ä»¶ï¼Œæ—¢åˆ©ç”¨äº† Siri çš„é«˜è´¨é‡è¯­éŸ³ï¼Œåˆåšåˆ°äº†<strong>é›¶ç½‘ç»œå»¶è¿Ÿã€é›¶æˆæœ¬</strong>ã€‚</p><p><strong>åç«¯å®ç° (FastAPI):</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"><span class="meta">@router.post(<span class="params"><span class="string">&quot;/audio/tts&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">text_to_speech</span>(<span class="params">text: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Mac ä¸“å±é»‘ç§‘æŠ€ï¼šè°ƒç”¨ç³»ç»Ÿåº•å±‚ TTS</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    tmp_path = <span class="string">f&quot;/tmp/<span class="subst">&#123;uuid.uuid4()&#125;</span>.m4a&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è°ƒç”¨ç³»ç»Ÿå‘½ä»¤ï¼Œç›´æ¥ç”Ÿæˆ m4a (æµè§ˆå™¨å…¼å®¹æ€§æå¥½)</span></span><br><span class="line">    subprocess.run([<span class="string">&quot;say&quot;</span>, <span class="string">&quot;-o&quot;</span>, tmp_path, text])</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(tmp_path, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> Response(content=f.read(), media_type=<span class="string">&quot;audio/mp4&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="2-å‰ç«¯éŸ³é¢‘é˜Ÿåˆ—-Audio-Queue">2. å‰ç«¯éŸ³é¢‘é˜Ÿåˆ— (Audio Queue)</h3><p>ä¸ºäº†é˜²æ­¢æµå¼ç”Ÿæˆæ—¶è¯­éŸ³é‡å ï¼ˆAI è¿˜åœ¨æ‰“å­—ï¼Œä¸Šä¸€å¥è¿˜æ²¡è¯»å®Œï¼Œä¸‹ä¸€å¥åˆæ¥äº†ï¼‰ï¼Œæˆ‘ä»¬åœ¨å‰ç«¯å®ç°äº†ä¸€ä¸ª<strong>åˆ†å¥ç¼“å†²é˜Ÿåˆ—</strong>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant SSE as åç«¯æµ</span><br><span class="line">    participant Parser as å‰ç«¯è§£æå™¨</span><br><span class="line">    participant Queue as éŸ³é¢‘é˜Ÿåˆ—</span><br><span class="line">    participant Player as æ’­æ”¾å™¨</span><br><span class="line"></span><br><span class="line">    SSE-&gt;&gt;Parser: &quot;ä½ å¥½ï¼Œ&quot;</span><br><span class="line">    SSE-&gt;&gt;Parser: &quot;æˆ‘æ˜¯&quot;</span><br><span class="line">    SSE-&gt;&gt;Parser: &quot;é¢è¯•å®˜ã€‚&quot; (æ£€æµ‹åˆ°æ ‡ç‚¹)</span><br><span class="line">    Parser-&gt;&gt;Queue: å…¥é˜Ÿ: &quot;ä½ å¥½ï¼Œæˆ‘æ˜¯é¢è¯•å®˜ã€‚&quot;</span><br><span class="line">    </span><br><span class="line">    loop é˜Ÿåˆ—ç›‘å¬</span><br><span class="line">        Queue-&gt;&gt;Player: å–å‡ºç¬¬ä¸€å¥</span><br><span class="line">        Player--&gt;&gt;Player: æ’­æ”¾ä¸­...</span><br><span class="line">        Player-&gt;&gt;Queue: æ’­æ”¾ç»“æŸ (onEnded)</span><br><span class="line">    end</span><br></pre></td></tr></table></figure><hr><h2 id="ğŸ› ï¸-è¸©å‘å®å½•-Troubleshooting">ğŸ› ï¸ è¸©å‘å®å½• (Troubleshooting)</h2><h3 id="ğŸ›-Bug-1-React-ä¸¥æ ¼æ¨¡å¼ä¸‹çš„â€œå¤è¯»æœºâ€">ğŸ› Bug 1: React ä¸¥æ ¼æ¨¡å¼ä¸‹çš„â€œå¤è¯»æœºâ€</h3><ul><li><strong>ç°è±¡</strong>ï¼šAI å›å¤å‡ºç° AABB é‡å¤ï¼ˆå¦‚â€œå¥½å¥½â€¦çš„çš„â€¦â€ï¼‰ã€‚</li><li><strong>åŸå› </strong>ï¼š<code>Next.js</code> å¼€å‘ç¯å¢ƒä¸‹ <code>React.StrictMode</code> ä¼šæ‰§è¡Œä¸¤æ¬¡ <code>setState</code>ã€‚è€Œæˆ‘ä»¬çš„ä»£ç ä¸­ç›´æ¥ä¿®æ”¹äº†å¯¹è±¡å±æ€§ (<code>msg.content += chunk</code>)ã€‚</li><li><strong>ä¿®å¤</strong>ï¼šä¸¥æ ¼éµå¾ª <strong>Immutability</strong> åŸåˆ™ã€‚</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âœ… æ­£ç¡®å†™æ³•</span></span><br><span class="line"><span class="title function_">setMessages</span>(<span class="function"><span class="params">prev</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> newMsgs = [...prev];</span><br><span class="line">    <span class="comment">// åˆ›å»ºæ–°å¯¹è±¡ï¼Œè€Œä¸æ˜¯ä¿®æ”¹å¼•ç”¨</span></span><br><span class="line">    newMsgs[lastIndex] = &#123; ...lastMsg, <span class="attr">content</span>: lastMsg.<span class="property">content</span> + chunk &#125;; </span><br><span class="line">    <span class="keyword">return</span> newMsgs;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="ğŸ›-Bug-2-Worker-is-not-defined">ğŸ› Bug 2: <code>Worker is not defined</code></h3><ul><li><strong>ç°è±¡</strong>ï¼šå¼•å…¥å½•éŸ³åº“ <code>react-media-recorder</code> åé¡µé¢å´©æºƒã€‚</li><li><strong>åŸå› </strong>ï¼šNext.js æœåŠ¡ç«¯æ¸²æŸ“ (SSR) æ— æ³•è®¿é—®æµè§ˆå™¨ç‰¹æœ‰çš„ Worker APIã€‚</li><li><strong>ä¿®å¤</strong>ï¼šä½¿ç”¨ <code>dynamic import</code> éš”ç¦»åŠ è½½ã€‚</li></ul><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">ChatInput</span> = <span class="title function_">dynamic</span>(<span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;@/components/ChatInput&quot;</span>), &#123; <span class="attr">ssr</span>: <span class="literal">false</span> &#125;);</span><br></pre></td></tr></table></figure><hr><h2 id="ğŸ”®-æ€»ç»“">ğŸ”® æ€»ç»“</h2><p>ç°åœ¨çš„ <code>JD_Agent</code> å·²ç»ä¸ä»…ä»…æ˜¯ä¸€ä¸ªä»£ç  demoï¼Œå®ƒå…·å¤‡äº†ï¼š</p><ol><li><strong>å¤§è„‘</strong>ï¼šæ‡‚åæ€ã€ä¼šçº é”™çš„å¤šæ™ºèƒ½ä½“å›¢é˜Ÿã€‚</li><li><strong>å˜´å·´</strong>ï¼šé›¶å»¶è¿Ÿçš„æœ¬åœ° TTSã€‚</li><li><strong>é¢œå€¼</strong>ï¼šåª²ç¾ DeepSeek çš„ç°ä»£åŒ– UIã€‚</li></ol><p><strong>Next Step</strong>: æˆ‘ä»¬å°†å°è¯•å¼•å…¥ <strong>WebRTC</strong>ï¼Œå°†ç°åœ¨çš„â€œå¯¹è®²æœºæ¨¡å¼â€å‡çº§ä¸ºçœŸæ­£çš„â€œæ‰“æ–­å¼å®æ—¶é€šè¯â€ã€‚</p><p><em>Keep Building, Keep Evolving.</em> ğŸš€</p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å®æ—¶è¯­éŸ³æ¨¡æ‹Ÿé¢è¯•</title>
      <link href="/2025/11/30/tts-asr-agent/"/>
      <url>/2025/11/30/tts-asr-agent/</url>
      
        <content type="html"><![CDATA[<p><strong>GitHub ä»“åº“</strong>: <a href="https://github.com/caozhaoqi/jd_agent">https://github.com/caozhaoqi/jd_agent</a></p><blockquote><p><strong>æ‘˜è¦</strong>ï¼šåœ¨å®ç°äº†åŸºäº JD ç”Ÿæˆé¢è¯•æŒ‡å—ï¼ˆv1.0ï¼‰åï¼Œæˆ‘ä»¬å¹¶æœªæ­¢æ­¥ã€‚æœ¬æ–‡è®°å½•äº† <code>jd_agent</code> é¡¹ç›®çš„é‡å¤§å‡çº§ï¼šå¼•å…¥ <strong>æ¨¡æ‹Ÿé¢è¯•ï¼ˆMock Interviewï¼‰</strong> æ¨¡å¼ï¼Œå¹¶é›†æˆäº† <strong>ASRï¼ˆè¯­éŸ³è¯†åˆ«ï¼‰</strong> ä¸ <strong>TTSï¼ˆè¯­éŸ³åˆæˆï¼‰</strong> æŠ€æœ¯ã€‚æˆ‘ä»¬é€šè¿‡ <strong>FastAPI</strong> çš„æµå¼å“åº”ã€<strong>Next.js</strong> çš„éŸ³é¢‘é˜Ÿåˆ—ç®¡ç†ä»¥åŠ <strong>åŒæ¨¡å‹é…ç½®ç­–ç•¥</strong>ï¼Œæ‰“é€ äº†ä¸€ä¸ªèƒ½å¤Ÿâ€œå¬æ‡‚ä½ ã€å¹¶å¼€å£æé—®â€çš„ AI é¢è¯•å®˜ã€‚</p></blockquote><hr><h2 id="1-æ¶æ„å‡çº§ï¼šä»å•å‘ç”Ÿæˆåˆ°åŒå‘äº¤äº’">1. æ¶æ„å‡çº§ï¼šä»å•å‘ç”Ÿæˆåˆ°åŒå‘äº¤äº’</h2><p>v1.0 ç‰ˆæœ¬ä¸»è¦è§£å†³çš„æ˜¯â€œä¿¡æ¯æå–â€é—®é¢˜ï¼ˆJD -&gt; æŠ¥å‘Šï¼‰ã€‚<br>v2.0 ç‰ˆæœ¬åˆ™è‡´åŠ›äºè§£å†³â€œå®æˆ˜æ¼”ç»ƒâ€é—®é¢˜ï¼ˆç”¨æˆ· &lt;-&gt; AI é¢è¯•å®˜ï¼‰ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬åœ¨æ¶æ„ä¸­å¼•å…¥äº† <strong>éŸ³é¢‘å±‚ (Audio Layer)</strong> å’Œ <strong>ä¼šè¯çŠ¶æ€ç®¡ç†</strong>ã€‚</p><h3 id="1-1-ç³»ç»Ÿæ¶æ„å›¾-v2-0">1.1 ç³»ç»Ÿæ¶æ„å›¾ (v2.0)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    User((ç”¨æˆ·)) </span><br><span class="line">    </span><br><span class="line">    subgraph Frontend [Next.js Client]</span><br><span class="line">        Microphone --&gt;|Audio Blob| ASR_Handler</span><br><span class="line">        Chat_UI --&gt;|Text Stream| SSE_Reader</span><br><span class="line">        SSE_Reader --&gt;|Sentence Buffer| Audio_Queue</span><br><span class="line">        Audio_Queue --&gt;|Text Segments| TTS_Player</span><br><span class="line">        TTS_Player --&gt; Speaker</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph Backend [FastAPI Server]</span><br><span class="line">        ASR_Handler --&gt;|POST /audio/transcribe| Whisper_Service</span><br><span class="line">        Chat_UI --&gt;|POST /chat/stream| Chat_Service</span><br><span class="line">        TTS_Player --&gt;|POST /audio/tts| TTS_Service</span><br><span class="line">        </span><br><span class="line">        subgraph Services</span><br><span class="line">            Chat_Service[LangChain Chat Flow]</span><br><span class="line">            Whisper_Service[ASR Adapter]</span><br><span class="line">            TTS_Service[TTS Adapter]</span><br><span class="line">        end</span><br><span class="line">        </span><br><span class="line">        subgraph Model_Layer [Model Factory]</span><br><span class="line">            Chat_Service --&gt;|Text Generation| DeepSeek_V3</span><br><span class="line">            Whisper_Service &amp; TTS_Service --&gt;|Audio Processing| SiliconFlow/OpenAI</span><br><span class="line">        end</span><br><span class="line">    end</span><br></pre></td></tr></table></figure><hr><h2 id="2-æ ¸å¿ƒåŠŸèƒ½å®ç°ç»†èŠ‚">2. æ ¸å¿ƒåŠŸèƒ½å®ç°ç»†èŠ‚</h2><h3 id="2-1-æ¨¡æ‹Ÿé¢è¯•ä¸æµå¼å¯¹è¯-Streaming-Chat">2.1 æ¨¡æ‹Ÿé¢è¯•ä¸æµå¼å¯¹è¯ (Streaming Chat)</h3><p>ä¸ºäº†æ¨¡æ‹ŸçœŸå®çš„é¢è¯•åœºæ™¯ï¼Œæˆ‘ä»¬æ‘’å¼ƒäº†â€œç”Ÿæˆå®Œæ¯•å†ä¸€æ¬¡æ€§è¿”å›â€çš„æ¨¡å¼ï¼Œå…¨é¢æ‹¥æŠ± <strong>SSE (Server-Sent Events)</strong>ã€‚</p><ul><li><strong>åç«¯å®ç°</strong>ï¼šä½¿ç”¨ <code>LangChain</code> çš„ <code>.astream()</code> æ–¹æ³•é…åˆ FastAPI çš„ <code>StreamingResponse</code>ã€‚</li><li><strong>Prompt è®¾è®¡</strong>ï¼šæ ¹æ® Session æ ‡é¢˜åŠ¨æ€åˆ‡æ¢ System Promptã€‚å¦‚æœæ£€æµ‹åˆ°æ˜¯é¢è¯•æ¨¡å¼ï¼ŒAI å˜èº«ä¸ºâ€œä¸¥å‰çš„é¢è¯•å®˜â€ï¼Œæ¯æ¬¡åªé—®ä¸€ä¸ªé—®é¢˜ï¼Œå¹¶æ ¹æ®å€™é€‰äººçš„å›ç­”è¿›è¡Œè¿½é—®ã€‚</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/api/endpoints.py</span></span><br><span class="line"><span class="meta">@router.post(<span class="params"><span class="string">&quot;/chat/stream&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">stream_chat</span>(<span class="params">req: ChatRequest</span>):</span><br><span class="line">    <span class="comment"># åŠ¨æ€æ³¨å…¥äººè®¾</span></span><br><span class="line">    system_prompt = <span class="string">&quot;ä½ æ˜¯ä¸€åä¸“ä¸šçš„é¢è¯•å®˜ã€‚è¯·æ ¹æ®æ±‚èŒè€…çš„å›ç­”è¿›è¡Œè¿½é—®...&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">generate</span>():</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">for</span> chunk <span class="keyword">in</span> chain.astream(messages):</span><br><span class="line">            <span class="keyword">yield</span> <span class="string">f&quot;data: <span class="subst">&#123;chunk&#125;</span>\n\n&quot;</span></span><br><span class="line">        <span class="keyword">yield</span> <span class="string">&quot;data: [DONE]\n\n&quot;</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> StreamingResponse(generate(), media_type=<span class="string">&quot;text/event-stream&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="2-2-è¯­éŸ³äº¤äº’é—­ç¯-The-Voice-Loop">2.2 è¯­éŸ³äº¤äº’é—­ç¯ (The Voice Loop)</h3><p>è¿™æ˜¯æœ¬æ¬¡å‡çº§çš„æŠ€æœ¯é«˜åœ°ã€‚æˆ‘ä»¬å®ç°äº†ä¸€ä¸ªå®Œæ•´çš„è¯­éŸ³äº¤äº’å¾ªç¯ï¼š<strong>å½•éŸ³ -&gt; ASR -&gt; LLM æ€è€ƒ -&gt; TTS æœ—è¯»</strong>ã€‚</p><h4 id="A-ASR-å¬">A. ASR (å¬)</h4><p>å‰ç«¯ä½¿ç”¨ <code>react-media-recorder</code> æ•è·éŸ³é¢‘ Blobï¼Œåç«¯å¯¹æ¥ <strong>OpenAI å…¼å®¹æ¥å£</strong>ï¼ˆå¦‚ SiliconFlow çš„ <code>SenseVoiceSmall</code>ï¼Œè¯†åˆ«é€Ÿåº¦æå¿«ï¼‰ã€‚</p><h4 id="B-TTS-è¯´-å…³é”®ä¼˜åŒ–ï¼šéŸ³é¢‘é˜Ÿåˆ—-Audio-Queue">B. TTS (è¯´) - å…³é”®ä¼˜åŒ–ï¼šéŸ³é¢‘é˜Ÿåˆ— (Audio Queue)</h4><p>ä¸ºäº†è§£å†³â€œAI è¯´è¯å¡é¡¿â€æˆ–â€œå¤šé‡è¯­éŸ³é‡å â€çš„é—®é¢˜ï¼Œæˆ‘ä»¬åœ¨å‰ç«¯å®ç°äº†ä¸€ä¸ª<strong>éŸ³é¢‘æ’­æ”¾é˜Ÿåˆ—</strong>ã€‚</p><p><strong>ç—›ç‚¹</strong>ï¼šAI ç”Ÿæˆé€Ÿåº¦å¾ˆå¿«ï¼Œå¦‚æœæ¯æ”¶åˆ°ä¸€æ®µæ–‡å­—å°±è¯·æ±‚æ’­æ”¾ï¼Œå£°éŸ³ä¼šé‡å ã€‚å¦‚æœç­‰å…¨éƒ¨ç”Ÿæˆå®Œå†æ’­æ”¾ï¼Œç”¨æˆ·ç­‰å¾…æ—¶é—´å¤ªé•¿ã€‚<br><strong>æ–¹æ¡ˆ</strong>ï¼š</p><ol><li><strong>åˆ†å¥æ£€æµ‹</strong>ï¼šå‰ç«¯ç›‘å¬ SSE æµï¼Œåˆ©ç”¨æ ‡ç‚¹ç¬¦å·ï¼ˆ<code>ã€‚ï¼Ÿï¼</code>ï¼‰åˆ‡åˆ†å¥å­ã€‚</li><li><strong>å…¥é˜Ÿ</strong>ï¼šåˆ‡åˆ†å¥½çš„å¥å­æ¨å…¥ <code>audioQueue</code>ã€‚</li><li><strong>ä¸²è¡Œæ’­æ”¾</strong>ï¼š<code>processAudioQueue</code> é€’å½’å‡½æ•°ç¡®ä¿ä¸Šä¸€å¥æ’­å®Œæ‰è¯·æ±‚ä¸‹ä¸€å¥ã€‚</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hooks/useAudioQueue.ts</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">processAudioQueue</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (isPlayingRef.<span class="property">current</span> || queue.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    isPlayingRef.<span class="property">current</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">const</span> text = queue.<span class="title function_">shift</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¯·æ±‚ TTS API å¹¶æ’­æ”¾</span></span><br><span class="line">    <span class="keyword">const</span> audio = <span class="keyword">new</span> <span class="title class_">Audio</span>(tts_url);</span><br><span class="line">    audio.<span class="property">onended</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        isPlayingRef.<span class="property">current</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="title function_">processAudioQueue</span>(); <span class="comment">// é€’å½’å¤„ç†ä¸‹ä¸€å¥</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">await</span> audio.<span class="title function_">play</span>();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><hr><h2 id="3-åŸºç¡€è®¾æ–½ä¸é…ç½®ç­–ç•¥-Infrastructure">3. åŸºç¡€è®¾æ–½ä¸é…ç½®ç­–ç•¥ (Infrastructure)</h2><p>åœ¨å¼•å…¥è¯­éŸ³åŠŸèƒ½æ—¶ï¼Œæˆ‘ä»¬é‡åˆ°äº†ä¸€ä¸ªå…¸å‹çš„å·¥ç¨‹é—®é¢˜ï¼š<strong>DeepSeek å¾ˆå¼ºï¼Œä½†å®ƒä¸æ”¯æŒéŸ³é¢‘</strong>ã€‚</p><p>ä¸ºäº†å…¼é¡¾<strong>æ™ºèƒ½ï¼ˆæ–‡æœ¬ï¼‰<strong>ä¸</strong>åŠŸèƒ½ï¼ˆè¯­éŸ³ï¼‰</strong>ï¼Œæˆ‘ä»¬è®¾è®¡äº†<strong>åŒæ¨¡å‹é…ç½®ç­–ç•¥</strong>ã€‚</p><h3 id="3-1-åˆ†ç¦»é…ç½®-env-config-py">3.1 åˆ†ç¦»é…ç½® (<code>.env</code> &amp; <code>config.py</code>)</h3><p>æˆ‘ä»¬å°† LLM çš„é…ç½®ä¸ Audio çš„é…ç½®å®Œå…¨è§£è€¦ï¼Œå®ç°äº†â€œå¤§è„‘â€ç”¨ DeepSeekï¼Œâ€œå˜´å·´å’Œè€³æœµâ€ç”¨ OpenAI/SiliconFlowã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/core/config.py</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Settings</span>(<span class="title class_ inherited__">BaseSettings</span>):</span><br><span class="line">    <span class="comment"># å¤§è„‘ï¼šDeepSeek V3 (é«˜æ™ºå•†ï¼Œä½æˆæœ¬)</span></span><br><span class="line">    OPENAI_API_KEY: <span class="built_in">str</span> </span><br><span class="line">    OPENAI_API_BASE: <span class="built_in">str</span> = <span class="string">&quot;https://api.deepseek.com&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># äº”å®˜ï¼šSiliconFlow / OpenAI (å¤„ç†è¯­éŸ³)</span></span><br><span class="line">    AUDIO_API_KEY: <span class="type">Optional</span>[<span class="built_in">str</span>]</span><br><span class="line">    AUDIO_API_BASE: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="string">&quot;https://api.siliconflow.cn/v1&quot;</span></span><br><span class="line">    ASR_MODEL: <span class="built_in">str</span> = <span class="string">&quot;FunAudioLLM/SenseVoiceSmall&quot;</span></span><br></pre></td></tr></table></figure><p>è¿™ç§è®¾è®¡ä½¿å¾—ç³»ç»Ÿæå…·çµæ´»æ€§ï¼Œå¯ä»¥åœ¨ä¸ä¿®æ”¹ä»£ç çš„æƒ…å†µä¸‹ï¼Œéšæ„æ›´æ¢åº•å±‚çš„è¯­éŸ³æœåŠ¡å•†ã€‚</p><hr><h2 id="4-å‰ç«¯å·¥ç¨‹åŒ–è¸©å‘è®°å½•-Troubleshooting">4. å‰ç«¯å·¥ç¨‹åŒ–è¸©å‘è®°å½• (Troubleshooting)</h2><p>åœ¨ Next.js + React çš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è§£å†³äº†å‡ ä¸ªæ£˜æ‰‹çš„ Bugã€‚</p><h3 id="å‘ä½-1ï¼šWorker-is-not-defined">å‘ä½ 1ï¼š<code>Worker is not defined</code></h3><ul><li><strong>ç°è±¡</strong>ï¼šå¼•å…¥ <code>react-media-recorder</code> åï¼Œé¡µé¢åˆ·æ–°ç›´æ¥æŠ¥é”™ã€‚</li><li><strong>åŸå› </strong>ï¼šNext.js é»˜è®¤è¿›è¡ŒæœåŠ¡ç«¯æ¸²æŸ“ (SSR)ï¼Œè€Œå½•éŸ³åº“ä¾èµ–æµè§ˆå™¨ç‰¹æœ‰çš„ <code>Worker</code> APIï¼ŒNode.js ç¯å¢ƒé‡Œæ²¡æœ‰ã€‚</li><li><strong>è§£å†³</strong>ï¼šä½¿ç”¨ <code>next/dynamic</code> è¿›è¡ŒåŠ¨æ€å¯¼å…¥ï¼Œå¹¶ç¦ç”¨ SSRã€‚<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">ChatInput</span> = <span class="title function_">dynamic</span>(<span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;@/components/ChatInput&quot;</span>), &#123; <span class="attr">ssr</span>: <span class="literal">false</span> &#125;);</span><br></pre></td></tr></table></figure></li></ul><h3 id="å‘ä½-2ï¼šå¸ƒå±€é®æŒ¡ä¸æ»šåŠ¨å¤±æ•ˆ">å‘ä½ 2ï¼šå¸ƒå±€é®æŒ¡ä¸æ»šåŠ¨å¤±æ•ˆ</h3><ul><li><strong>ç°è±¡</strong>ï¼šè¾“å…¥æ¡†ä½¿ç”¨ <code>absolute</code> å®šä½ï¼Œå¯¼è‡´èŠå¤©è®°å½•è¿‡é•¿æ—¶è¢«è¾“å…¥æ¡†é®æŒ¡ï¼Œæ— æ³•çœ‹åˆ°æœ€åä¸€æ¡æ¶ˆæ¯ã€‚</li><li><strong>è§£å†³</strong>ï¼šé‡æ„ CSS å¸ƒå±€ï¼Œæ”¾å¼ƒç»å¯¹å®šä½ï¼Œæ”¹ç”¨ <strong>Flexbox</strong>ã€‚<ul><li>å®¹å™¨ï¼š<code>flex flex-col h-screen</code></li><li>æ¶ˆæ¯åŒºï¼š<code>flex-1 overflow-y-auto</code></li><li>è¾“å…¥åŒºï¼š<code>flex-shrink-0</code> (å›ºå®šåœ¨åº•éƒ¨ï¼ŒæŒ¤å‹æ¶ˆæ¯åŒºé«˜åº¦)</li></ul></li></ul><h3 id="å‘ä½-3ï¼šMarkdown-æ ·å¼ä¸¢å¤±">å‘ä½ 3ï¼šMarkdown æ ·å¼ä¸¢å¤±</h3><ul><li><strong>ç°è±¡</strong>ï¼šAI å›å¤çš„ Markdown æ²¡æœ‰æ ¼å¼ï¼ˆæ— åŠ ç²—ã€æ— åˆ—è¡¨ï¼‰ã€‚</li><li><strong>è§£å†³</strong>ï¼šå¼•å…¥ <code>@tailwindcss/typography</code> æ’ä»¶ï¼Œå¹¶æ­£ç¡®åŒ…è£¹ <code>prose</code> ç±»åã€‚<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;div className=<span class="string">&quot;prose prose-sm ...&quot;</span>&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">ReactMarkdown</span>&gt;</span>&#123;content&#125;<span class="tag">&lt;/<span class="name">ReactMarkdown</span>&gt;</span></span></span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure></li></ul><hr><h2 id="5-æ€»ç»“">5. æ€»ç»“</h2><p>é€šè¿‡æœ¬æ¬¡ v2.0 çš„è¿­ä»£ï¼Œ<code>jd_agent</code> å·²ç»ä¸ä»…ä»…æ˜¯ä¸€ä¸ªç®€å•çš„æ–‡æœ¬åˆ†æå·¥å…·ï¼Œè€Œæ˜¯ä¸€ä¸ªå…·å¤‡<strong>å¤šæ¨¡æ€äº¤äº’èƒ½åŠ›</strong>çš„æ™ºèƒ½åŠ©æ‰‹ã€‚</p><ul><li><strong>æŠ€æœ¯æ ˆ</strong>: FastAPI, LangChain, Next.js, Tailwind, Web Audio API.</li><li><strong>æ ¸å¿ƒçªç ´</strong>: è§£å†³äº† LLM ç”Ÿæˆä¸ TTS æ’­æ”¾çš„æ—¶åºåŒæ­¥é—®é¢˜ï¼Œå®ç°äº†æµç•…çš„è¯­éŸ³å¯¹è¯ä½“éªŒã€‚</li></ul><hr><p><em>å¸Œæœ›è¿™ç¯‡å®æˆ˜è®°å½•èƒ½ä¸ºæ­£åœ¨æ„å»º AI Agent çš„å¼€å‘è€…æä¾›å‚è€ƒï¼</em></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä»é›¶æ„å»ºå…¨æ ˆ AI ç®€å†åŠ©æ‰‹ï¼šå¤åˆ» DeepSeek äº¤äº’ä¸é•¿æœŸè®°å¿†å®ç°</title>
      <link href="/2025/11/29/llm-agent-memory/"/>
      <url>/2025/11/29/llm-agent-memory/</url>
      
        <content type="html"><![CDATA[<h1>[ç¡¬æ ¸å®æˆ˜] ä»é›¶æ„å»ºå…¨æ ˆ AI ç®€å†åŠ©æ‰‹ï¼šå¤åˆ» DeepSeek äº¤äº’ä¸é•¿æœŸè®°å¿†å®ç°</h1><blockquote><p><strong>æ‘˜è¦</strong>ï¼šå¦‚ä½•å°†ä¸€ä¸ªç®€å•çš„ LangChain Demo è¿›åŒ–ä¸ºç”Ÿäº§çº§çš„ AI SaaS åº”ç”¨ï¼Ÿæœ¬æ–‡è®°å½•äº† <code>JD_Agent</code> é¡¹ç›®çš„é‡Œç¨‹ç¢‘å¼æ›´æ–°ã€‚æˆ‘ä»¬å¼•å…¥äº† <strong>Next.js</strong> å¤åˆ» DeepSeek çš„ä¸æ»‘ UIï¼ŒåŸºäº <strong>SQLModel</strong> å®ç°äº†å®Œæ•´çš„ç”¨æˆ·é‰´æƒä¸ä¼šè¯ç®¡ç†ï¼Œå¹¶åˆ©ç”¨ <strong>RAG æŠ€æœ¯</strong> å®ç°äº†â€œç®€å†è§£æä¸é•¿æœŸè®°å¿†â€åŠŸèƒ½ï¼Œè®© AI çœŸæ­£æ‹¥æœ‰äº†â€œè®°ä½ç”¨æˆ·â€çš„èƒ½åŠ›ã€‚</p></blockquote><hr><h2 id="1-é¡¹ç›®æ¼”è¿›ï¼šä»-Script-åˆ°-Product">1. é¡¹ç›®æ¼”è¿›ï¼šä» Script åˆ° Product</h2><p>åœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬çš„ <code>JD_Agent</code> åªæ˜¯ä¸€ä¸ªæ— çŠ¶æ€çš„ API æ¥å£ï¼šç”¨æˆ·å‘ JDï¼ŒAI è¿”å›åˆ†æã€‚<br>ä½†ä¸€ä¸ªçœŸæ­£çš„ AI äº§å“éœ€è¦å…·å¤‡ï¼š</p><ol><li><strong>ç”¨æˆ·ç³»ç»Ÿ</strong>ï¼šæ•°æ®éš”ç¦»ï¼Œæ¯ä¸ªäººåªèƒ½çœ‹è‡ªå·±çš„å†å²ã€‚</li><li><strong>äº¤äº’ä½“éªŒ</strong>ï¼šæµå¼è¾“å‡ºã€Markdown æ¸²æŸ“ã€å†å²è®°å½•å›æº¯ã€‚</li><li><strong>é•¿æœŸè®°å¿†</strong>ï¼šè®°ä½ç”¨æˆ·çš„ç®€å†èƒŒæ™¯ï¼Œä¸éœ€è¦æ¯æ¬¡ Prompt éƒ½é‡å¤â€œæˆ‘æ˜¯ Python å¼€å‘â€¦â€ã€‚</li></ol><p>ä»Šå¤©ï¼Œæˆ‘ä»¬å®Œæˆäº†è¿™æ¬¡<strong>å…¨æ ˆé‡æ„</strong>ã€‚</p><hr><h2 id="2-æŠ€æœ¯æ ˆå…¨æ™¯">2. æŠ€æœ¯æ ˆå…¨æ™¯</h2><ul><li><strong>Frontend</strong>: Next.js 14 (App Router) + Tailwind CSS + Lucide React</li><li><strong>Backend</strong>: FastAPI + Uvicorn</li><li><strong>Database</strong>: SQLModel (SQLite) + Alembic</li><li><strong>Auth</strong>: JWT (OAuth2PasswordBearer) + Passlib (Bcrypt)</li><li><strong>AI Core</strong>: LangChain + OpenAI/DeepSeek + FAISS (RAG)</li></ul><hr><h2 id="3-æ ¸å¿ƒåŠŸèƒ½å®ç°">3. æ ¸å¿ƒåŠŸèƒ½å®ç°</h2><h3 id="3-1-å®Œç¾å¤åˆ»-DeepSeek-çš„äº¤äº’ç•Œé¢">3.1 å®Œç¾å¤åˆ» DeepSeek çš„äº¤äº’ç•Œé¢</h3><p>æˆ‘ä»¬æŠ›å¼ƒäº†ç®€é™‹çš„ HTMLï¼Œé‡‡ç”¨ <strong>Next.js + Tailwind</strong> æ‰“é€ äº†ç°ä»£åŒ–çš„ Chat UIã€‚</p><ul><li><strong>å¸ƒå±€æ”»åš</strong>ï¼šä¸ºäº†å®ç°â€œé¡¶éƒ¨å›ºå®šã€ä¾§è¾¹æ ç‹¬ç«‹æ»šåŠ¨ã€è¾“å…¥æ¡†åº•éƒ¨æ‚¬æµ®ä¸”ä¸é®æŒ¡å†…å®¹â€ï¼Œæˆ‘ä»¬é‡‡ç”¨äº† <code>fixed inset-0</code> é”æ­»è§†å£é«˜åº¦ï¼Œå¹¶é…åˆ <code>pb-[200px]</code> çš„åº•éƒ¨å†…è¾¹è·ç­–ç•¥ã€‚</li><li><strong>Markdown æ¸²æŸ“</strong>ï¼šåç«¯è¿”å›çš„ç»“æ„åŒ– JSON æŠ¥å‘Šï¼Œåœ¨å‰ç«¯è¢«åŠ¨æ€ç»„è£…æˆ Markdownï¼Œå¹¶é€šè¿‡ <code>react-markdown</code> æ¸²æŸ“å‡ºæ¼‚äº®çš„æ’ç‰ˆã€‚</li></ul><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‰ç«¯å¸ƒå±€æ ¸å¿ƒ Trick</span></span><br><span class="line">&lt;div className=<span class="string">&quot;fixed inset-0 flex ...&quot;</span>&gt;</span><br><span class="line">  &#123;<span class="comment">/* ä¾§è¾¹æ  */</span>&#125;</span><br><span class="line">  &lt;div className=<span class="string">&quot;w-[260px] hidden md:flex ...&quot;</span>&gt;...&lt;/div&gt;</span><br><span class="line">  </span><br><span class="line">  &#123;<span class="comment">/* ä¸»èŠå¤©åŒº */</span>&#125;</span><br><span class="line">  &lt;div className=<span class="string">&quot;flex-1 flex flex-col h-full relative&quot;</span>&gt;</span><br><span class="line">     &#123;<span class="comment">/* æ¶ˆæ¯åˆ—è¡¨ï¼šåº•éƒ¨ç•™ç™½é˜²æ­¢è¢«è¾“å…¥æ¡†é®æŒ¡ */</span>&#125;</span><br><span class="line">     &lt;div className=<span class="string">&quot;flex-1 overflow-y-auto pb-[200px]&quot;</span>&gt;...&lt;/div&gt;</span><br><span class="line">     </span><br><span class="line">     &#123;<span class="comment">/* æ‚¬æµ®è¾“å…¥æ¡†ï¼šèƒŒæ™¯æ¸å˜é€æ˜ */</span>&#125;</span><br><span class="line">     &lt;div className=<span class="string">&quot;absolute bottom-0 ... bg-gradient-to-t ...&quot;</span>&gt;...&lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure><h3 id="3-2-é•¿æœŸè®°å¿†ï¼šç®€å†è§£æä¸ç”¨æˆ·ç”»åƒ-LTM">3.2 é•¿æœŸè®°å¿†ï¼šç®€å†è§£æä¸ç”¨æˆ·ç”»åƒ (LTM)</h3><p>è¿™æ˜¯æœ¬æ¬¡æ›´æ–°çš„<strong>çµé­‚åŠŸèƒ½</strong>ã€‚æˆ‘ä»¬ä¸å¸Œæœ› AI èŠå®Œå°±å¿˜ï¼Œè€Œæ˜¯æ„å»ºäº†ä¸€ä¸ª<strong>é•¿æœŸè®°å¿†ç³»ç»Ÿ (Long-Term Memory)</strong>ã€‚</p><p><strong>å®ç°æµç¨‹</strong>ï¼š</p><ol><li><strong>ä¸Šä¼ </strong>ï¼šç”¨æˆ·ä¸Šä¼  PDF/Word ç®€å†ã€‚</li><li><strong>è§£æ</strong>ï¼šåç«¯ä½¿ç”¨ <code>pdfplumber</code> æå–çº¯æ–‡æœ¬ã€‚</li><li><strong>ETL</strong>ï¼šåˆ©ç”¨ LangChain çš„ <code>resume_extractor</code> é“¾ï¼Œä»æ‚ä¹±çš„ç®€å†ä¸­æå–å‡º<strong>ç»“æ„åŒ–ç”»åƒ</strong>ï¼ˆå¦‚ï¼š<code>tech_stack: [&quot;Python&quot;, &quot;FastAPI&quot;]</code>, <code>experience: &quot;5å¹´&quot;</code>ï¼‰ã€‚</li><li><strong>å­˜å‚¨</strong>ï¼šå­˜å…¥ <code>UserProfile</code> æ•°æ®åº“è¡¨ã€‚</li><li><strong>å›æƒ³</strong>ï¼šä¸‹æ¬¡ç”¨æˆ·å‘é€ JD æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨è¯»å– <code>UserProfile</code>ï¼Œæ³¨å…¥åˆ° System Prompt ä¸­ã€‚</li></ol><p><strong>åç«¯ä»£ç ç‰‡æ®µ (Service Layer)</strong>ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app/services/interview_service.py</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">generate_interview_guide</span>(<span class="params">request, db, user_id</span>):</span><br><span class="line">    <span class="comment"># 1. è¯»å–é•¿æœŸè®°å¿† (ä»æ•°æ®åº“è·å–ç”¨æˆ·ç”»åƒ)</span></span><br><span class="line">    ltm_profile = get_user_profile_str(db, user_id)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. è¯»å–çŸ­æœŸè®°å¿† (ä» ChatMessage è¡¨è·å–æœ€è¿‘å¯¹è¯)</span></span><br><span class="line">    chat_history = get_recent_chat_history(db, user_id)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. å¸¦ç€è®°å¿†å»æ€è€ƒ</span></span><br><span class="line">    task_tech = generate_tech_async(</span><br><span class="line">        ...,</span><br><span class="line">        user_profile=ltm_profile, <span class="comment"># &lt;--- æ³¨å…¥é•¿æœŸè®°å¿†</span></span><br><span class="line">        chat_history=chat_history <span class="comment"># &lt;--- æ³¨å…¥çŸ­æœŸè®°å¿†</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure><h3 id="3-3-æ•°æ®é—­ç¯ï¼šä¼šè¯å†å²ç®¡ç†">3.3 æ•°æ®é—­ç¯ï¼šä¼šè¯å†å²ç®¡ç†</h3><p>ä¸ºäº†å®ç°ä¾§è¾¹æ çš„â€œå†å²è®°å½•â€åŠŸèƒ½ï¼Œæˆ‘ä»¬å¼•å…¥äº† <strong>SQLModel</strong>ã€‚</p><ul><li><p><strong>è¡¨ç»“æ„è®¾è®¡</strong>ï¼š</p><ul><li><code>User</code>: å­˜å‚¨ç”¨æˆ·åã€åŠ å¯†å¯†ç ã€‚</li><li><code>ChatSession</code>: ä»£è¡¨ä¸€æ¬¡å¯¹è¯ï¼ˆå¦‚â€œç¥å·é‚¦é‚¦é¢è¯•å‡†å¤‡â€ï¼‰ã€‚</li><li><code>ChatMessage</code>: å­˜å‚¨å…·ä½“çš„ User/Assistant æ¶ˆæ¯å†…å®¹ã€‚</li></ul></li><li><p><strong>éš¾ç‚¹å¤„ç†</strong>ï¼šPydantic å¯¹è±¡æ— æ³•ç›´æ¥å­˜å…¥æ•°æ®åº“ï¼Œæˆ‘ä»¬åœ¨å­˜åº“å‰å°†å…¶åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²ï¼Œåœ¨è¯»å–æ—¶å†ååºåˆ—åŒ–ï¼Œç¡®ä¿å‰ç«¯èƒ½æ‹¿åˆ°ç»“æ„åŒ–çš„ <code>meta</code> æ•°æ®è¿›è¡Œæ¸²æŸ“ã€‚</p></li></ul><hr><h2 id="4-å·¥ç¨‹åŒ–è¸©å‘å®å½•">4. å·¥ç¨‹åŒ–è¸©å‘å®å½•</h2><p>åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è§£å†³äº†ä¸€ç³»åˆ—çœŸå®çš„å·¥ç¨‹é—®é¢˜ï¼š</p><h3 id="å‘ä½-1ï¼šTailwind-CSS-æ ·å¼å¤±æ•ˆ">å‘ä½ 1ï¼šTailwind CSS æ ·å¼å¤±æ•ˆ</h3><ul><li><strong>ç°è±¡</strong>ï¼šé¡µé¢å…ƒç´ å †å åœ¨å·¦ä¸Šè§’ï¼Œæ ·å¼å…¨æ— ã€‚</li><li><strong>åŸå› </strong>ï¼šNext.js åˆå§‹åŒ–æ—¶ <code>tailwind.config.js</code> è·¯å¾„é…ç½®é”™è¯¯ï¼Œä¸”è¯¯è£…äº†ä¸å…¼å®¹çš„ Tailwind v4 ç‰ˆæœ¬ã€‚</li><li><strong>è§£å†³</strong>ï¼šé™çº§è‡³ <code>tailwindcss@3.4.17</code>ï¼Œå¹¶æ‰‹åŠ¨ä¿®æ­£ <code>content</code> è·¯å¾„è¦†ç›– <code>src/</code> ç›®å½•ã€‚</li></ul><h3 id="å‘ä½-2ï¼šBcrypt-ç‰ˆæœ¬å†²çª">å‘ä½ 2ï¼šBcrypt ç‰ˆæœ¬å†²çª</h3><ul><li><strong>ç°è±¡</strong>ï¼šæ³¨å†Œæ—¶æŠ¥é”™ <code>AttributeError: module 'bcrypt' has no attribute '__about__'</code>ã€‚</li><li><strong>åŸå› </strong>ï¼š<code>passlib</code> åº“ä¸æœ€æ–°ç‰ˆ <code>bcrypt 4.0+</code> ä¸å…¼å®¹ã€‚</li><li><strong>è§£å†³</strong>ï¼šå¼ºåˆ¶é”å®šç‰ˆæœ¬ <code>pip install &quot;bcrypt==3.2.2&quot;</code>ã€‚</li></ul><h3 id="å‘ä½-3ï¼šLangChain-å‚æ•°ä¸¢å¤±">å‘ä½ 3ï¼šLangChain å‚æ•°ä¸¢å¤±</h3><ul><li><strong>ç°è±¡</strong>ï¼š<code>KeyError: &quot;Input to ChatPromptTemplate is missing variables &#123;'user_profile'&#125;&quot;</code>ã€‚</li><li><strong>åŸå› </strong>ï¼šåœ¨ Prompt æ¨¡æ¿ä¸­å®šä¹‰äº† <code>&#123;user_profile&#125;</code> å ä½ç¬¦ï¼Œä½†åœ¨ Chain è°ƒç”¨ (<code>ainvoke</code>) æ—¶å¿˜è®°ä¼ å…¥è¯¥å‚æ•°ã€‚</li><li><strong>è§£å†³</strong>ï¼šåœ¨ Service å±‚è·å–è®°å¿†åï¼Œæ˜¾å¼ä¼ é€’ç»™ Chainã€‚</li></ul><hr><h2 id="5-æ€»ç»“ä¸å±•æœ›">5. æ€»ç»“ä¸å±•æœ›</h2><p>é€šè¿‡ä»Šå¤©çš„è¿­ä»£ï¼Œ<code>JD_Agent</code> å·²ç»å…·å¤‡äº†ä¸€ä¸ªå•†ä¸šåŒ– AI äº§å“çš„é›å½¢ï¼š</p><ul><li><strong>å¥½çœ‹</strong>ï¼šåª²ç¾ DeepSeek çš„ UIã€‚</li><li><strong>å¥½ç”¨</strong>ï¼šæ”¯æŒç®€å†ä¸€é”®è§£æï¼ŒAI è¶Šç”¨è¶Šæ‡‚ä½ ã€‚</li><li><strong>ç¨³å¥</strong>ï¼šå®Œæ•´çš„é‰´æƒä¸æ—¥å¿—ç³»ç»Ÿã€‚</li></ul><p><strong>ä¸‹ä¸€æ­¥è®¡åˆ’</strong>ï¼š</p><ol><li><strong>å¤šæ™ºèƒ½ä½“æ¨¡æ‹Ÿé¢è¯•</strong>ï¼šå¼•å…¥ä¸¤ä¸ª Agent äº’ç›¸å¯¹è¯ï¼Œç”¨æˆ·æ—è§‚â€œæ¨¡æ‹Ÿé¢è¯•â€è¿‡ç¨‹ï¼ˆåŸºäº SSE æµå¼è¾“å‡ºï¼‰ã€‚</li><li><strong>è¯­éŸ³äº¤äº’</strong>ï¼šæ¥å…¥ TTS/ASRï¼Œå®ç°çœŸæ­£çš„è¯­éŸ³æ¨¡æ‹Ÿé¢è¯•ã€‚</li></ol><hr><p><em>æŠ€æœ¯æ”¹å˜ç”Ÿæ´»ï¼ŒAI èµ‹èƒ½æ±‚èŒã€‚å¦‚æœä½ å¯¹è¿™ä¸ªé¡¹ç›®æ„Ÿå…´è¶£ï¼Œæ¬¢è¿å…³æ³¨æˆ‘çš„ GitHubï¼</em></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäº RAG ä¸ Agent åä½œçš„æ™ºèƒ½é¢è¯•åŠ©æ‰‹å¼€å‘æŒ‡å—</title>
      <link href="/2025/11/28/agent-rag-jd/"/>
      <url>/2025/11/28/agent-rag-jd/</url>
      
        <content type="html"><![CDATA[<h1>å®æˆ˜ï¼šå¦‚ä½•è®© AI â€œè¯»æ‡‚â€æˆ‘çš„åšå®¢ï¼Ÿâ€”â€”åŸºäº RAG ä¸ Agent åä½œçš„æ™ºèƒ½é¢è¯•åŠ©æ‰‹å¼€å‘æŒ‡å—</h1><blockquote><p><strong>æ‘˜è¦</strong>ï¼šåœ¨å¤§æ¨¡å‹æ—¶ä»£ï¼Œå¦‚ä½•è®© AI ä¸ä»…å…·å¤‡é€šç”¨çŸ¥è¯†ï¼Œè¿˜èƒ½åˆ©ç”¨æˆ‘ä»¬ç§æœ‰çš„æ•°æ®ï¼ˆå¦‚ä¸ªäººåšå®¢ã€æŠ€æœ¯ç¬”è®°ï¼‰è¿›è¡Œå›ç­”ï¼Ÿæœ¬æ–‡å°†æ‹†è§£ä¸€ä¸ªçœŸå®é¡¹ç›® <code>JD_Agent</code> çš„å®ç°è¿‡ç¨‹ã€‚æˆ‘ä»¬åˆ©ç”¨ <strong>FastAPI + LangChain</strong> æ„å»ºäº†ä¸€ä¸ªæ™ºèƒ½ä½“ï¼Œå®ƒä¸ä»…èƒ½åˆ†æå²—ä½ JDï¼Œè¿˜èƒ½é€šè¿‡ <strong>RAG æŠ€æœ¯</strong> æ£€ç´¢æˆ‘çš„æœ¬åœ° Markdown åšå®¢ï¼Œç”Ÿæˆç»“åˆäº†æˆ‘ä¸ªäººæŠ€æœ¯ç§¯ç´¯çš„ä¸“å±é¢è¯•æŒ‡å—ã€‚</p></blockquote><hr><h2 id="ä¸€ã€-ä¸ºä»€ä¹ˆè¦åšè¿™ä¸ªï¼Ÿï¼ˆç—›ç‚¹ä¸æ€è·¯ï¼‰">ä¸€ã€ ä¸ºä»€ä¹ˆè¦åšè¿™ä¸ªï¼Ÿï¼ˆç—›ç‚¹ä¸æ€è·¯ï¼‰</h2><p>åœ¨å‡†å¤‡é¢è¯•æ—¶ï¼Œæˆ‘ä»¬ç»å¸¸é‡åˆ°ä¸¤ä¸ªé—®é¢˜ï¼š</p><ol><li><strong>JD åˆ†æå¤ªç´¯</strong>ï¼šæ¯ä¸ªå²—ä½çš„æŠ€æœ¯æ ˆä¸åŒï¼Œéœ€è¦é’ˆå¯¹æ€§å¤ä¹ ã€‚</li><li><strong>çŸ¥è¯†é—å¿˜</strong>ï¼šæ˜æ˜ä»¥å‰å†™è¿‡å…³äº Docker æˆ– Redis çš„åšå®¢ç¬”è®°ï¼Œä½†é¢è¯•æ—¶ä¸€æ—¶æƒ³ä¸èµ·æ¥ç»†èŠ‚ã€‚</li></ol><p><strong>æˆ‘çš„è§£å†³æ–¹æ¡ˆ</strong>ï¼š<br>æ„å»ºä¸€ä¸ª <strong>AI Agent</strong>ã€‚</p><ol><li>å®ƒèƒ½<strong>è‡ªåŠ¨åˆ†æ</strong>æˆ‘æŠ•é€’çš„ JDï¼ˆå²—ä½æè¿°ï¼‰ï¼Œæå–æ ¸å¿ƒæŠ€æœ¯æ ˆã€‚</li><li>å®ƒæ‹¥æœ‰ä¸€ä¸ª<strong>å¤–æŒ‚å¤§è„‘ï¼ˆçŸ¥è¯†åº“ï¼‰</strong>ï¼Œå­˜å‚¨äº†æˆ‘æ‰€æœ‰çš„åšå®¢æ–‡ç« ã€‚</li><li>åœ¨ç”Ÿæˆé¢è¯•é¢˜æ—¶ï¼Œå®ƒä¼š<strong>ä¼˜å…ˆå‚è€ƒ</strong>æˆ‘çš„åšå®¢å†…å®¹ï¼Œå¹¶å‘Šè¯‰æˆ‘ï¼šâ€œè¿™ä¸ªé—®é¢˜ä½ å¯ä»¥å¤ä¹ ä½ å†™çš„è¿™ç¯‡æ–‡ç« ã€‚â€</li></ol><hr><h2 id="äºŒã€-æ ¸å¿ƒåŸç†ï¼šRAG-ä¸-Agent-çš„åä½œ">äºŒã€ æ ¸å¿ƒåŸç†ï¼šRAG ä¸ Agent çš„åä½œ</h2><p>åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬é‡‡ç”¨äº† <strong>RAG (Retrieval-Augmented Generation)</strong> æ¶æ„ã€‚</p><h3 id="1-ä»€ä¹ˆæ˜¯-RAGï¼Ÿ">1. ä»€ä¹ˆæ˜¯ RAGï¼Ÿ</h3><p>å¦‚æœæŠŠå¤§æ¨¡å‹ï¼ˆLLMï¼‰æ¯”ä½œä¸€ä¸ªâ€œè¶…çº§å­¦éœ¸â€ï¼Œé‚£ RAG å°±æ˜¯ç»™äº†å­¦éœ¸ä¸€æœ¬â€œå¼€å·è€ƒè¯•çš„ä¹¦â€ã€‚</p><ul><li><strong>LLM</strong>ï¼šè´Ÿè´£é€»è¾‘æ¨ç†ã€è¯­è¨€ç»„ç»‡ã€‚</li><li><strong>Knowledge Base</strong>ï¼šè´Ÿè´£æä¾›ç²¾å‡†çš„ã€ç§æœ‰çš„äº‹å®æ•°æ®ï¼ˆæˆ‘çš„åšå®¢ï¼‰ã€‚</li></ul><h3 id="2-åä½œæµç¨‹å›¾">2. åä½œæµç¨‹å›¾</h3><p>æ•´ä¸ªç³»ç»Ÿçš„è¿ä½œæµç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    User[ç”¨æˆ·è¾“å…¥ JD] --&gt;|1. æäº¤| Agent[æ™ºèƒ½ä½“æ ¸å¿ƒ (Service)]</span><br><span class="line">    </span><br><span class="line">    subgraph Analysis [é˜¶æ®µä¸€: æ„å›¾è¯†åˆ«]</span><br><span class="line">        Agent --&gt;|2. è§£æ JD| Parser[LLM è§£æå™¨]</span><br><span class="line">        Parser --&gt;|æå–å…³é”®è¯: Python, Docker| Keywords[æŠ€æœ¯æ ˆåˆ—è¡¨]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph Retrieval [é˜¶æ®µäºŒ: RAG æ£€ç´¢]</span><br><span class="line">        Keywords --&gt;|3. æŸ¥è¯¢å‘é‡åº“| VectorDB[(FAISS å‘é‡åº“)]</span><br><span class="line">        VectorDB --&gt;|4. è¿”å›åšå®¢ç‰‡æ®µ + æ¥æº| Context[çŸ¥è¯†åº“ä¸Šä¸‹æ–‡]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph Generation [é˜¶æ®µä¸‰: å¢å¼ºç”Ÿæˆ]</span><br><span class="line">        Context --&gt;|5. æ³¨å…¥ Prompt| Generator[LLM ç”Ÿæˆå™¨]</span><br><span class="line">        Generator --&gt;|6. ç”Ÿæˆé¢è¯•é¢˜ &amp; å¼•ç”¨æ¥æº| Output[æœ€ç»ˆæŠ¥å‘Š]</span><br><span class="line">    end</span><br></pre></td></tr></table></figure><hr><h2 id="ä¸‰ã€-å…³é”®æŠ€æœ¯å®ç°">ä¸‰ã€ å…³é”®æŠ€æœ¯å®ç°</h2><h3 id="1-æ„å»ºçŸ¥è¯†åº“-The-Embedding-Pipeline">1. æ„å»ºçŸ¥è¯†åº“ (The Embedding Pipeline)</h3><p>è¿™æ˜¯ RAG çš„åœ°åŸºã€‚æˆ‘ä»¬éœ€è¦æŠŠ Markdown æ ¼å¼çš„åšå®¢æ–‡ç« è½¬æ¢æˆè®¡ç®—æœºèƒ½ç†è§£çš„â€œå‘é‡â€ã€‚</p><p><strong>æŠ€æœ¯æ ˆ</strong>ï¼š<code>LangChain</code> + <code>BGE-Small-zh</code> + <code>FAISS</code></p><ul><li><strong>æ•°æ®æ¸…æ´— (ETL)</strong>ï¼š<br>ä½¿ç”¨ <code>MarkdownHeaderTextSplitter</code> æŒ‰ç« èŠ‚åˆ‡åˆ†æ–‡ç« ï¼Œä¿è¯è¯­ä¹‰å®Œæ•´æ€§ã€‚</li><li><strong>å‘é‡åŒ– (Embedding)</strong>ï¼š<br>æˆ‘ä»¬é€‰ç”¨äº† <strong>BAAI/bge-small-zh-v1.5</strong> æ¨¡å‹ã€‚å®ƒèƒ½å°†ä¸€æ®µæ–‡å­—è½¬æ¢ä¸º 512 ç»´çš„æµ®ç‚¹æ•°ç»„ã€‚<blockquote><p><em>åŸç†</em>ï¼šè¯­ä¹‰ç›¸è¿‘çš„å¥å­ï¼ˆå¦‚â€œDockerå®¹å™¨â€å’Œâ€œå®¹å™¨åŒ–éƒ¨ç½²â€ï¼‰ï¼Œåœ¨å‘é‡ç©ºé—´ä¸­çš„è·ç¦»éå¸¸è¿‘ã€‚</p></blockquote></li><li><strong>å­˜å‚¨ç»“æ„</strong>ï¼š<br>å­˜å…¥ FAISS çš„ä¸ä»…æ˜¯å‘é‡ï¼Œè¿˜åŒ…å« <strong>Payload</strong>ï¼ˆåŸæ–‡ï¼‰å’Œ <strong>Metadata</strong>ï¼ˆå…ƒæ•°æ®ï¼Œå¦‚æ–‡ä»¶åï¼‰ã€‚</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ ¸å¿ƒä»£ç ç‰‡æ®µï¼šå…¥åº“é€»è¾‘</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_index</span>():</span><br><span class="line">    <span class="comment"># 1. åŠ è½½åšå®¢ Markdown</span></span><br><span class="line">    docs = load_and_split_markdown(<span class="string">&quot;source/_posts&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. åˆå§‹åŒ– BGE æ¨¡å‹ (ä½¿ç”¨å›½å†…é•œåƒ)</span></span><br><span class="line">    embedding_model = HuggingFaceEmbeddings(model_name=<span class="string">&quot;BAAI/bge-small-zh-v1.5&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. å‘é‡åŒ–å¹¶å­˜å…¥ FAISS</span></span><br><span class="line">    vector_store = FAISS.from_documents(docs, embedding_model)</span><br><span class="line">    vector_store.save_local(<span class="string">&quot;blog_faiss_index&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="2-Agent-çš„å¤§è„‘ï¼šå¼‚æ­¥ç¼–æ’-Orchestration">2. Agent çš„å¤§è„‘ï¼šå¼‚æ­¥ç¼–æ’ (Orchestration)</h3><p>ä¸ºäº†è®©ç”¨æˆ·ä½“éªŒè¾¾åˆ°æè‡´ï¼ˆå¿«ï¼ï¼‰ï¼Œåç«¯ä¸èƒ½ä¸²è¡Œå¤„ç†ã€‚æˆ‘ä»¬åˆ©ç”¨ <strong>Python Asyncio</strong> å®ç°äº†å¹¶è¡Œä»»åŠ¡æµã€‚</p><ul><li><strong>æŠ€æœ¯æŒ‘æˆ˜</strong>ï¼šå¦‚ä½•åŒæ—¶è¿›è¡Œâ€œå…¬å¸èƒŒæ™¯è°ƒæŸ¥â€å’Œâ€œçŸ¥è¯†åº“æ£€ç´¢â€ï¼Ÿ</li><li><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š<code>asyncio.gather</code>ã€‚</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ ¸å¿ƒä»£ç ç‰‡æ®µï¼šå¹¶è¡Œç¼–æ’</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">generate_interview_guide</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="comment"># 1. å…ˆè§£æ JD (å‰ç½®ä¾èµ–)</span></span><br><span class="line">    jd_meta = <span class="keyword">await</span> parse_jd_async(request.jd_text)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. æ„é€ æŸ¥è¯¢ï¼šç”¨ JD é‡Œçš„æŠ€æœ¯æ ˆå»æŸ¥åšå®¢</span></span><br><span class="line">    query = <span class="string">&quot; &quot;</span>.join(jd_meta.tech_stack)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. å¹¶è¡Œæ‰§è¡Œï¼š(æŸ¥åšå®¢) &amp; (æŸ¥å…¬å¸èƒŒæ™¯) &amp; (å‡ºé€šç”¨é¢˜)</span></span><br><span class="line">    task_rag = kb_engine.search(query)</span><br><span class="line">    task_research = research_company(jd_meta.company_name)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å¹¶å‘ç­‰å¾…ç»“æœ</span></span><br><span class="line">    rag_result, company_info = <span class="keyword">await</span> asyncio.gather(task_rag, task_research)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 4. å°†æŸ¥åˆ°çš„åšå®¢å†…å®¹æ³¨å…¥ Prompt</span></span><br><span class="line">    final_report = <span class="keyword">await</span> generate_final_report(context=rag_result[<span class="string">&#x27;context&#x27;</span>])</span><br></pre></td></tr></table></figure><h3 id="3-ä¸Šä¸‹æ–‡æ³¨å…¥-Context-Injection">3. ä¸Šä¸‹æ–‡æ³¨å…¥ (Context Injection)</h3><p>è¿™æ˜¯è®© AI â€œè¯»æ‡‚â€åšå®¢çš„å…³é”®ä¸€æ­¥ã€‚æˆ‘ä»¬åŠ¨æ€æ„å»ºäº† Prompt Templateã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">prompt_template = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">ä½ æ˜¯ä¸€ä¸ªèµ„æ·±æŠ€æœ¯é¢è¯•å®˜ã€‚</span></span><br><span class="line"><span class="string">è¯·æ ¹æ®ä»¥ä¸‹ã€å‚è€ƒçŸ¥è¯†åº“ã€‘ï¼ˆè¿™æ˜¯ç”¨æˆ·çš„ä¸ªäººåšå®¢ç¬”è®°ï¼‰æ¥ç”Ÿæˆé¢è¯•é¢˜ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ã€å‚è€ƒçŸ¥è¯†åº“ã€‘ï¼š</span></span><br><span class="line"><span class="string">&#123;kb_context&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¯·åœ¨ç”Ÿæˆé¢˜ç›®æ—¶ï¼Œæ˜ç¡®æŒ‡å‡ºç”¨æˆ·åœ¨åšå®¢ä¸­å¯¹è¯¥çŸ¥è¯†ç‚¹çš„ç†è§£ã€‚</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure><hr><h2 id="å››ã€-é‡åˆ°çš„å‘ä¸ä¼˜åŒ–-Troubleshooting">å››ã€ é‡åˆ°çš„å‘ä¸ä¼˜åŒ– (Troubleshooting)</h2><p>åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è§£å†³äº†å‡ ä¸ªå…¸å‹çš„å·¥ç¨‹é—®é¢˜ï¼š</p><ol><li><p><strong>æ¨¡å‹ä¸‹è½½å¡é¡¿</strong>ï¼š</p><ul><li><em>é—®é¢˜</em>ï¼šHuggingFace å›½å†…æ— æ³•ç›´è¿ã€‚</li><li><em>è§£å†³</em>ï¼šåœ¨ä»£ç é¡¶éƒ¨è®¾ç½® <code>os.environ['HF_ENDPOINT'] = 'https://hf-mirror.com'</code> å¼ºåˆ¶èµ°é•œåƒã€‚</li></ul></li><li><p><strong>Pydantic æ•°æ®æ ¡éªŒé”™è¯¯</strong>ï¼š</p><ul><li><em>é—®é¢˜</em>ï¼šæœ‰æ—¶å€™ RAG æ²¡æŸ¥åˆ°æ•°æ®ï¼Œè¿”å› <code>None</code>ï¼Œå¯¼è‡´æ¥å£æŠ¥é”™ã€‚</li><li><em>è§£å†³</em>ï¼šåœ¨ Schema å®šä¹‰ä¸­ä½¿ç”¨ <code>Optional[List[str]] = []</code>ï¼Œå¢å¼ºç³»ç»Ÿçš„é²æ£’æ€§ã€‚</li></ul></li><li><p><strong>å¤§æ¨¡å‹â€œå¹»è§‰â€</strong>ï¼š</p><ul><li><em>é—®é¢˜</em>ï¼šAI ç¼–é€ åšå®¢é‡Œæ²¡æœ‰çš„å†…å®¹ã€‚</li><li><em>è§£å†³</em>ï¼šåœ¨ Prompt ä¸­åŠ å…¥çº¦æŸâ€”â€”â€œä»…ä¾æ®å‚è€ƒçŸ¥è¯†åº“å›ç­”ï¼Œå¦‚æœçŸ¥è¯†åº“æœªæåŠï¼Œè¯·å¿½ç•¥â€ã€‚</li></ul></li></ol><hr><h2 id="äº”ã€-æœ€ç»ˆæ•ˆæœ">äº”ã€ æœ€ç»ˆæ•ˆæœ</h2><p>å½“ç”¨æˆ·è¾“å…¥ä¸€ä¸ªåŒ…å« <strong>â€œPython, Dockerâ€</strong> çš„ JD æ—¶ï¼š</p><ol><li><strong>åç«¯</strong> è¿…é€Ÿå®šä½åˆ°æœ¬åœ°åšå®¢ä¸­çš„ <code>Dockeréƒ¨ç½²ç¬”è®°.md</code> å’Œ <code>Pythonå¹¶å‘ç¼–ç¨‹.md</code>ã€‚</li><li><strong>AI</strong> ç”Ÿæˆçš„é¢è¯•æŒ‡å—ä¸­å†™é“ï¼š<blockquote><p><strong>Q1: è¯·è°ˆè°ˆ Docker çš„éš”ç¦»æœºåˆ¶ï¼Ÿ</strong><br><em>å‚è€ƒå›ç­”è¦ç‚¹</em>ï¼šæ ¹æ®ä½ çš„åšå®¢ <strong>ã€Š<a href="http://xn--Docker-gl3pp3z6v2awsl.md">Dockeréƒ¨ç½²ç¬”è®°.md</a>ã€‹</strong>ï¼Œä½ æ›¾æ€»ç»“è¿‡ Namespace è´Ÿè´£èµ„æºéš”ç¦»ï¼ŒCgroups è´Ÿè´£èµ„æºé™åˆ¶â€¦</p></blockquote></li><li><strong>å‰ç«¯</strong> ç•Œé¢åº•éƒ¨ä¼šå±•ç¤ºï¼š<blockquote><p>ğŸ“š <strong>çŸ¥è¯†åº“å¼•ç”¨</strong>ï¼š</p><ul><li>ğŸ“„ <code>Dockeréƒ¨ç½²ç¬”è®°.md</code></li></ul></blockquote></li></ol><p>è¿™ä¸ä»…æ˜¯ä¸€ä¸ªé¢è¯•é¢˜ç”Ÿæˆå™¨ï¼Œæ›´æ˜¯ä¸€ä¸ª<strong>å”¤é†’æ²‰ç¡çŸ¥è¯†çš„ç¬¬äºŒå¤§è„‘</strong>ã€‚</p><hr><h2 id="å…­ã€-æ€»ç»“">å…­ã€ æ€»ç»“</h2><p>æœ¬é¡¹ç›®é€šè¿‡ <strong>FastAPI</strong> æ„å»ºé«˜æ€§èƒ½åç«¯ï¼Œ<strong>LangChain</strong> å¤„ç†å¤æ‚çš„ LLM é€»è¾‘ï¼Œ<strong>FAISS</strong> å®ç°æ¯«ç§’çº§çŸ¥è¯†æ£€ç´¢ã€‚å®ƒå±•ç¤ºäº† <strong>LLM Ops (å¤§æ¨¡å‹å·¥ç¨‹åŒ–)</strong> çš„æ ¸å¿ƒæ€è·¯ï¼š<strong>ä¸ä»…è¦ä¼šè°ƒ APIï¼Œæ›´è¦æ‡‚å¾—å¦‚ä½•ç®¡ç†æ•°æ®æµå’Œä¸Šä¸‹æ–‡ã€‚</strong></p><p>å¦‚æœä½ ä¹Ÿæƒ³ä¸ºè‡ªå·±çš„çŸ¥è¯†åº“è£…ä¸Š AI å¼•æ“ï¼Œæ¬¢è¿å‚è€ƒæˆ‘çš„ GitHub ä»“åº“ï¼š[<a href="https://github.com/caozhaoqi/jd_agent">https://github.com/caozhaoqi/jd_agent</a>]</p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäº FastAPI + LangChain çš„ç®€å•agentå®ç°</title>
      <link href="/2025/11/26/agent-research-llm/"/>
      <url>/2025/11/26/agent-research-llm/</url>
      
        <content type="html"><![CDATA[<p><strong>GitHub ä»“åº“</strong>: <a href="https://github.com/caozhaoqi/jd_agent">https://github.com/caozhaoqi/jd_agent</a></p><blockquote><p><strong>æ‘˜è¦</strong>ï¼šåœ¨ AI Agent å¼€å‘ä¸­ï¼Œå¦‚ä½•å¹³è¡¡å¤§æ¨¡å‹çš„ç”Ÿæˆè´¨é‡ä¸æ¥å£çš„å“åº”é€Ÿåº¦ï¼Ÿæœ¬æ–‡å°†è¯¦ç»†æ‹†è§£ <code>jd_agent</code> é¡¹ç›®ã€‚è¿™æ˜¯ä¸€ä¸ªåŸºäºå²—ä½æè¿°ï¼ˆJDï¼‰è‡ªåŠ¨ç”Ÿæˆç»“æ„åŒ–é¢è¯•æŒ‡å—çš„æ™ºèƒ½ä½“ã€‚æˆ‘ä»¬é‡‡ç”¨ <strong>FastAPI</strong> ä½œä¸ºåç«¯ï¼Œåˆ©ç”¨ <strong>LangChain</strong> è¿›è¡Œé€»è¾‘ç¼–æ’ï¼Œå¹¶é€šè¿‡ <strong>Asyncio</strong> å®ç°å¹¶è¡Œæ¨ç†ï¼Œå°†ä»»åŠ¡è€—æ—¶ä» 30s+ ä¼˜åŒ–è‡³ 10s çº§ã€‚æ­¤å¤–ï¼Œæœ¬æ–‡è¿˜è®°å½•äº†ä» OpenAI è¿ç§»è‡³ DeepSeek çš„å®æˆ˜ç»éªŒåŠå·¥ç¨‹è¸©å‘è®°å½•ã€‚</p></blockquote><hr><h2 id="1-é¡¹ç›®èƒŒæ™¯ä¸ç—›ç‚¹">1. é¡¹ç›®èƒŒæ™¯ä¸ç—›ç‚¹</h2><p>åœ¨æ±‚èŒè¿‡ç¨‹ä¸­ï¼Œé’ˆå¯¹æ¯ä¸ªå²—ä½è¿›è¡Œæ·±åº¦å‡†å¤‡ï¼ˆåˆ†ææŠ€æœ¯æ ˆã€é¢„æµ‹é¢è¯•é¢˜ã€è°ƒç ”å…¬å¸èƒŒæ™¯ï¼‰æ˜¯éå¸¸è€—æ—¶çš„ã€‚<br>ä¼ ç»Ÿçš„ ChatGPT äº¤äº’æ–¹å¼è™½ç„¶å¯è¡Œï¼Œä½†å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š</p><ul><li><strong>Prompt é‡å¤åŠ³åŠ¨</strong>ï¼šæ¯æ¬¡éƒ½è¦è¾“å…¥ä¸€å¤§æ®µ Promptã€‚</li><li><strong>è¾“å‡ºéç»“æ„åŒ–</strong>ï¼šç”Ÿæˆçš„æ–‡æœ¬éš¾ä»¥ç›´æ¥ç”¨äºåç»­çš„æ•°æ®å­˜å‚¨æˆ–å‰ç«¯å±•ç¤ºã€‚</li><li><strong>å“åº”ç¼“æ…¢</strong>ï¼šåˆ†æ JDã€å‡ºæŠ€æœ¯é¢˜ã€å‡º HR é¢˜ã€èƒŒè°ƒå…¬å¸ï¼Œå¦‚æœä¸²è¡Œæ‰§è¡Œï¼Œç­‰å¾…æ—¶é—´æé•¿ã€‚</li></ul><p>æœ¬é¡¹ç›®æ—¨åœ¨é€šè¿‡<strong>å·¥ç¨‹åŒ–</strong>æ‰‹æ®µè§£å†³ä¸Šè¿°é—®é¢˜ï¼Œæ„å»ºä¸€ä¸ª<strong>å¯æ‰©å±•ã€é«˜å¹¶å‘ã€ç»“æ„åŒ–è¾“å‡º</strong>çš„ AI Agent åç«¯ã€‚</p><hr><h2 id="2-æŠ€æœ¯æ¶æ„è®¾è®¡-System-Architecture">2. æŠ€æœ¯æ¶æ„è®¾è®¡ (System Architecture)</h2><p>ä¸ºäº†ä¿è¯ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ï¼Œæœ¬é¡¹ç›®é‡‡ç”¨äº†<strong>åˆ†å±‚æ¶æ„ (Layered Architecture)</strong>ã€‚</p><h3 id="2-1-æ¶æ„åˆ†å±‚å›¾">2.1 æ¶æ„åˆ†å±‚å›¾</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    Client[å‰ç«¯/å®¢æˆ·ç«¯] --&gt;|HTTP/SSE| API[API Interface Layer]</span><br><span class="line">    </span><br><span class="line">    subgraph Backend [FastAPI Backend]</span><br><span class="line">        API --&gt; Service[Service Layer (Orchestration)]</span><br><span class="line">        </span><br><span class="line">        subgraph Parallel_Execution [å¼‚æ­¥å¹¶è¡Œæ‰§è¡ŒåŒº]</span><br><span class="line">            Task_A[JD Meta Parser]</span><br><span class="line">            Task_B[Tech Question Generator]</span><br><span class="line">            Task_C[Company Research Agent]</span><br><span class="line">        end</span><br><span class="line">        </span><br><span class="line">        Service --&gt; Task_A</span><br><span class="line">        Task_A --&gt; Task_B</span><br><span class="line">        Task_A --&gt; Task_C</span><br><span class="line">        </span><br><span class="line">        Task_B &amp; Task_C --&gt; Task_D[HR Question Generator]</span><br><span class="line">        </span><br><span class="line">        Task_B --&gt; Chains[LangChain Logic]</span><br><span class="line">        Task_C --&gt; Chains</span><br><span class="line">        </span><br><span class="line">        Chains --&gt; LLM_Factory[LLM Factory (OpenAI/DeepSeek)]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    Service --&gt;|Structured JSON| Client</span><br></pre></td></tr></table></figure><h3 id="2-2-æ ¸å¿ƒç»„ä»¶">2.2 æ ¸å¿ƒç»„ä»¶</h3><ul><li><strong>Web æ¡†æ¶</strong>: <code>FastAPI</code> (åˆ©ç”¨å…¶åŸç”Ÿå¼‚æ­¥ç‰¹æ€§å¤„ç† IO å¯†é›†å‹ä»»åŠ¡)ã€‚</li><li><strong>LLM ç¼–æ’</strong>: <code>LangChain</code> (ç®¡ç† Promptã€Chain å’Œ OutputParser)ã€‚</li><li><strong>æ•°æ®éªŒè¯</strong>: <code>Pydantic</code> (å¼ºåˆ¶ LLM è¾“å‡ºç¬¦åˆ Schema çš„ JSON)ã€‚</li><li><strong>å¹¶å‘æ§åˆ¶</strong>: <code>Python Asyncio</code> (å®ç°å¤š Chain å¹¶è¡Œè°ƒç”¨)ã€‚</li><li><strong>æ¨¡å‹å±‚</strong>: æ”¯æŒ <code>OpenAI</code> åè®®ï¼Œå®æµ‹å®Œç¾å…¼å®¹ <code>DeepSeek-V3</code>ã€‚</li></ul><hr><h2 id="3-æ ¸å¿ƒå®ç°ç»†èŠ‚-Implementation-Details">3. æ ¸å¿ƒå®ç°ç»†èŠ‚ (Implementation Details)</h2><h3 id="3-1-å¼ºåˆ¶ç»“æ„åŒ–è¾“å‡º-Structured-Output">3.1 å¼ºåˆ¶ç»“æ„åŒ–è¾“å‡º (Structured Output)</h3><p>å¤§æ¨¡å‹å¤©ç”Ÿå–œæ¬¢â€œèŠå¤©â€ï¼Œä¸ºäº†è®©å®ƒè¾“å‡º JSONï¼Œæˆ‘ä»¬æ‘’å¼ƒäº†ä¸ç¨³å®šçš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œè½¬è€Œä½¿ç”¨ LangChain çš„ <code>PydanticOutputParser</code>ã€‚</p><p><strong>Schema å®šä¹‰ (<code>schemas/interview.py</code>):</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">InterviewReport</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    meta: JDMetaData</span><br><span class="line">    tech_questions: <span class="type">List</span>[InterviewQuestion]</span><br><span class="line">    hr_questions: <span class="type">List</span>[InterviewQuestion]</span><br><span class="line">    <span class="comment"># ä½¿ç”¨ Optional å¤„ç†éå¿…å¡«é¡¹ï¼Œå¢å¼ºé²æ£’æ€§</span></span><br><span class="line">    system_design_question: <span class="type">Optional</span>[InterviewQuestion] = <span class="literal">None</span></span><br></pre></td></tr></table></figure><p><strong>Chain å®ç° (<code>chains/tech_gen.py</code>):</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">parser = PydanticOutputParser(pydantic_object=QuestionList)</span><br><span class="line">prompt = ChatPromptTemplate.from_template(</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ...</span></span><br><span class="line"><span class="string">    è¯·ä¸¥æ ¼æŒ‰ç…§ JSON æ ¼å¼è¾“å‡º:</span></span><br><span class="line"><span class="string">    &#123;format_instructions&#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># æ³¨å…¥ Pydantic ç”Ÿæˆçš„ Schema æŒ‡ä»¤</span></span><br><span class="line">chain = prompt | llm | parser</span><br></pre></td></tr></table></figure><h3 id="3-2-å¼‚æ­¥å¹¶å‘ç¼–æ’-Asyncio-Optimization">3.2 å¼‚æ­¥å¹¶å‘ç¼–æ’ (Asyncio Optimization)</h3><p>è¿™æ˜¯æœ¬é¡¹ç›®æ€§èƒ½æå‡çš„å…³é”®ã€‚</p><ul><li><strong>ä¸²è¡Œæ¨¡å¼</strong>ï¼šè§£æ JD (5s) -&gt; æŸ¥å…¬å¸ (10s) -&gt; å‡ºæŠ€æœ¯é¢˜ (10s) -&gt; å‡º HR é¢˜ (5s) = <strong>30s+</strong></li><li><strong>å¹¶è¡Œæ¨¡å¼</strong>ï¼šè§£æ JD (5s) -&gt; [æŸ¥å…¬å¸ | å‡ºæŠ€æœ¯é¢˜] (åŒæ—¶è¿›è¡Œ, å–æœ€å¤§å€¼ 10s) -&gt; å‡º HR é¢˜ = <strong>çº¦ 15s</strong></li></ul><p><strong>Service å±‚å®ç° (<code>services/interview_service.py</code>):</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">generate_interview_guide</span>(<span class="params">request: JDRequest</span>):</span><br><span class="line">    <span class="comment"># 1. å‰ç½®ä¾èµ–ï¼šå¿…é¡»å…ˆè§£æ JD</span></span><br><span class="line">    jd_meta = <span class="keyword">await</span> parse_jd_async(request.jd_text)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. æ„é€ å¹¶è¡Œä»»åŠ¡ (Fire tasks)</span></span><br><span class="line">    <span class="comment"># æŠ€æœ¯é¢˜ä¸ä¾èµ–å…¬å¸èƒŒæ™¯</span></span><br><span class="line">    task_tech = generate_tech_async(jd_meta.tech_stack, jd_meta.years_required)</span><br><span class="line">    <span class="comment"># å…¬å¸èƒŒè°ƒæ˜¯ç½‘ç»œ IO å¯†é›†å‹</span></span><br><span class="line">    task_research = research_company(jd_meta.company_name)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. æ ¸å¿ƒï¼šå¹¶å‘ç­‰å¾…</span></span><br><span class="line">    tech_qs, company_info = <span class="keyword">await</span> asyncio.gather(task_tech, task_research)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 4. åç½®ä¾èµ–ï¼šHR é¢˜ä¾èµ–å…¬å¸èƒŒæ™¯</span></span><br><span class="line">    hr_qs = <span class="keyword">await</span> generate_hr_async(jd_meta.soft_skills, company_info)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> InterviewReport(...)</span><br></pre></td></tr></table></figure><h3 id="3-3-å…¼å®¹å¤šæ¨¡å‹çš„-LLM-å·¥å‚">3.3 å…¼å®¹å¤šæ¨¡å‹çš„ LLM å·¥å‚</h3><p>ä¸ºäº†åœ¨å¼€å‘é˜¶æ®µèŠ‚çœæˆæœ¬ï¼ˆä½¿ç”¨ DeepSeekï¼‰ï¼Œåœ¨ç”Ÿäº§é˜¶æ®µè¿½æ±‚ç¨³å®šï¼ˆä½¿ç”¨ OpenAIï¼‰ï¼Œæˆ‘ä»¬è®¾è®¡äº†å·¥å‚æ¨¡å¼ã€‚</p><p><strong>é…ç½®è§£è€¦ (<code>core/config.py</code>):</strong><br>é€šè¿‡ <code>.env</code> æ–‡ä»¶åŠ¨æ€åˆ‡æ¢åº•åº§ï¼Œæ— éœ€ä¿®æ”¹ä¸šåŠ¡ä»£ç ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Settings</span>(<span class="title class_ inherited__">BaseSettings</span>):</span><br><span class="line">    OPENAI_API_KEY: <span class="built_in">str</span></span><br><span class="line">    OPENAI_API_BASE: <span class="built_in">str</span> = <span class="string">&quot;https://api.deepseek.com&quot;</span> <span class="comment"># é»˜è®¤æŒ‡å‘ DeepSeek</span></span><br><span class="line">    MODEL_NAME: <span class="built_in">str</span> = <span class="string">&quot;deepseek-chat&quot;</span></span><br></pre></td></tr></table></figure><hr><h2 id="4-å·¥ç¨‹åŒ–è¸©å‘ä¸è§£å†³æ–¹æ¡ˆ-Troubleshooting">4. å·¥ç¨‹åŒ–è¸©å‘ä¸è§£å†³æ–¹æ¡ˆ (Troubleshooting)</h2><p>åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬é‡åˆ°äº†æ•°ä¸ªçœŸå®çš„å·¥ç¨‹æŒ‘æˆ˜ï¼Œä»¥ä¸‹æ˜¯æ’æŸ¥è®°å½•ã€‚</p><h3 id="å‘ä½-1ï¼šAPI-ä½™é¢ä¸é‰´æƒæ··æ·†-429-vs-402">å‘ä½ 1ï¼šAPI ä½™é¢ä¸é‰´æƒæ··æ·† (429 vs 402)</h3><ul><li><strong>ç°è±¡</strong>: ç¨‹åºå´©æºƒï¼ŒæŠ¥é”™ <code>openai.RateLimitError: Error code: 429</code> æˆ– <code>402 Payment Required</code>ã€‚</li><li><strong>åˆ†æ</strong>:<ul><li><code>429</code> é€šå¸¸æŒ‡é€Ÿç‡é™åˆ¶ï¼Œä½† OpenAI åœ¨ä½™é¢ä¸è¶³æ—¶ä¹Ÿä¼šæŠ¥è¿™ä¸ªé”™ï¼ˆ<code>insufficient_quota</code>ï¼‰ã€‚</li><li><code>402</code> æ˜¯æ˜ç¡®çš„ä½™é¢ä¸ºé›¶ã€‚</li></ul></li><li><strong>è§£å†³</strong>:<ul><li>ä¸è¦æ­»ç£•ä»£ç é€»è¾‘ã€‚</li><li>åˆ‡æ¢è‡³ <strong>DeepSeek</strong>ï¼ˆå……å€¼ 10 å…ƒäººæ°‘å¸å¯ç”¨å¾ˆä¹…ï¼‰æˆ– <strong>SiliconFlow</strong>ï¼ˆå…è´¹é¢åº¦ï¼‰ã€‚</li><li>ä¿®æ”¹ <code>.env</code> å³å¯è§£å†³ã€‚</li></ul></li></ul><h3 id="å‘ä½-2ï¼šPydantic-å­—æ®µæ ¡éªŒå¼‚å¸¸">å‘ä½ 2ï¼šPydantic å­—æ®µæ ¡éªŒå¼‚å¸¸</h3><ul><li><strong>ç°è±¡</strong>: <code>ValidationError: system_design_question Input should be a valid dictionary</code>ã€‚</li><li><strong>åˆ†æ</strong>: ä¸šåŠ¡é€»è¾‘ä¸­æŸäº›æƒ…å†µä¸‹æœªç”Ÿæˆç³»ç»Ÿè®¾è®¡é¢˜ï¼Œè¿”å›äº† <code>None</code>ï¼Œä½† Schema å®šä¹‰é»˜è®¤ä¸ºå¿…å¡«ã€‚</li><li><strong>è§£å†³</strong>: ä½¿ç”¨ <code>Optional</code> ç±»å‹æç¤ºã€‚<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line">system_design_question: <span class="type">Optional</span>[InterviewQuestion] = <span class="literal">None</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="å‘ä½-3ï¼šSSL-è¯ä¹¦è­¦å‘Š-Mac-ç¯å¢ƒ">å‘ä½ 3ï¼šSSL è¯ä¹¦è­¦å‘Š (Mac ç¯å¢ƒ)</h3><ul><li><strong>ç°è±¡</strong>: <code>NotOpenSSLWarning: urllib3 v2 only supports OpenSSL 1.1.1+</code></li><li><strong>åˆ†æ</strong>: macOS è‡ªå¸¦çš„ LibreSSL ç‰ˆæœ¬è¿‡ä½ï¼Œä¸æ–°ç‰ˆ <code>urllib3</code> ä¸å…¼å®¹ã€‚</li><li><strong>è§£å†³</strong>: é™çº§ urllib3 æˆ–ä½¿ç”¨ Homebrew å‡çº§ OpenSSLã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install <span class="string">&quot;urllib3&lt;2.0&quot;</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="å‘ä½-4ï¼šNginx-åå‘ä»£ç†è¶…æ—¶-504-Gateway-Time-out">å‘ä½ 4ï¼šNginx åå‘ä»£ç†è¶…æ—¶ (504 Gateway Time-out)</h3><ul><li><strong>ç°è±¡</strong>: çˆ¬è™«æˆ–é•¿æ–‡æœ¬ç”Ÿæˆä»»åŠ¡è€—æ—¶è¶…è¿‡ 60sï¼Œå‰ç«¯æ”¶åˆ° 504 é”™è¯¯ã€‚</li><li><strong>åˆ†æ</strong>: Nginx é»˜è®¤ <code>proxy_read_timeout</code> ä¸º 60sã€‚</li><li><strong>è§£å†³</strong>: åœ¨ Nginx é…ç½®ä¸­é’ˆå¯¹ API è·¯ç”±å¢åŠ è¶…æ—¶æ—¶é—´ã€‚<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /api/ &#123;</span><br><span class="line">    <span class="attribute">proxy_read_timeout</span> <span class="number">600s</span>;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:8000;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h2 id="5-æ€»ç»“ä¸å±•æœ›">5. æ€»ç»“ä¸å±•æœ›</h2><p><code>jd_agent</code> é¡¹ç›®å±•ç¤ºäº†å¦‚ä½•å°†ä¸€ä¸ªç®€å•çš„ Prompt äº¤äº’è½¬åŒ–ä¸ºä¸€ä¸ª<strong>å·¥ä¸šçº§çš„åç«¯æœåŠ¡</strong>ã€‚</p><p><strong>æ ¸å¿ƒæ”¶ç›Š</strong>:</p><ol><li><strong>æ•ˆç‡æå‡</strong>: å¹¶è¡Œå¤„ç†ä½¿å“åº”é€Ÿåº¦æå‡ <strong>300%</strong>ã€‚</li><li><strong>æˆæœ¬é™ä½</strong>: é€šè¿‡ LLM å·¥å‚æ¨¡å¼åˆ‡æ¢è‡³ DeepSeekï¼ŒToken æˆæœ¬é™ä½ <strong>90%</strong>ã€‚</li><li><strong>ç¨³å®šæ€§</strong>: å¼ºç±»å‹æ ¡éªŒå’Œé‡è¯•æœºåˆ¶ä¿è¯äº†æœåŠ¡çš„é²æ£’æ€§ã€‚</li></ol><p><strong>åç»­è§„åˆ’</strong>:</p><ul><li>å¼•å…¥ <strong>Redis</strong> ç¼“å­˜ JD è§£æç»“æœï¼Œé¿å…é‡å¤æ‰£è´¹ã€‚</li><li>é›†æˆ <strong>Celery</strong> å¤„ç†è¶…é•¿è€—æ—¶çš„ç³»ç»Ÿè®¾è®¡é¢˜ç”Ÿæˆã€‚</li><li>å¼€å‘ <strong>React/Next.js</strong> å‰ç«¯ï¼Œå®ç°æµå¼ Markdown æ¸²æŸ“ã€‚</li></ul><hr><p><em>å¦‚æœä½ è§‰å¾—è¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿åœ¨ GitHub ä¸Šç‚¹ä¸ª Star â­ï¸ï¼</em></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å®ç°é«˜å¯ç”¨ MySQL é›†ç¾¤</title>
      <link href="/2025/09/30/mysql-cluster-use/"/>
      <url>/2025/09/30/mysql-cluster-use/</url>
      
        <content type="html"><![CDATA[<h3 id="å‡†å¤‡é˜¶æ®µï¼šé¡¹ç›®ç»“æ„">å‡†å¤‡é˜¶æ®µï¼šé¡¹ç›®ç»“æ„</h3><blockquote><p>é¦–å…ˆï¼Œåœ¨æ‚¨çš„æœåŠ¡å™¨ä¸Šåˆ›å»ºä¸€ä¸ªé¡¹ç›®æ–‡ä»¶å¤¹ï¼Œç»“æ„å¦‚ä¸‹ï¼š</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql_cluster/</span><br><span class="line">â”œâ”€â”€ docker-compose.yml</span><br><span class="line">â”œâ”€â”€ proxysql/</span><br><span class="line">â”‚   â””â”€â”€ proxysql.cnf</span><br><span class="line">â””â”€â”€ mysql/</span><br><span class="line">    â”œâ”€â”€ master/</span><br><span class="line">    â”‚   â””â”€â”€ conf/</span><br><span class="line">    â”‚       â””â”€â”€ master.cnf</span><br><span class="line">    â”œâ”€â”€ slave1/</span><br><span class="line">    â”‚   â””â”€â”€ conf/</span><br><span class="line">    â”‚       â””â”€â”€ slave1.cnf</span><br><span class="line">    â””â”€â”€ slave2/</span><br><span class="line">        â””â”€â”€ conf/</span><br><span class="line">            â””â”€â”€ slave2.cnf</span><br></pre></td></tr></table></figure><h3 id="é˜¶æ®µä¸€ï¼šç¼–å†™é…ç½®æ–‡ä»¶">é˜¶æ®µä¸€ï¼šç¼–å†™é…ç½®æ–‡ä»¶</h3><h4 id="1-ä¸»åº“é…ç½®-mysql-master-conf-master-cnf">1. ä¸»åº“é…ç½® (<code>mysql/master/conf/master.cnf</code>)</h4><p>è¿™ä¸ªæ–‡ä»¶å®šä¹‰äº†ä¸»åº“çš„ç‰¹å®šé…ç½®ã€‚</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">server-id</span>               = <span class="number">100</span></span><br><span class="line"><span class="attr">log-bin</span>                 = /var/lib/mysql/mysql-bin</span><br><span class="line"><span class="attr">gtid-mode</span>               = <span class="literal">ON</span></span><br><span class="line"><span class="attr">enforce-gtid-consistency</span>= <span class="literal">ON</span></span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„</strong>ï¼šæˆ‘ä»¬ä½¿ç”¨äº† <code>GTID</code> æ¨¡å¼ï¼Œè¿™æ˜¯æ¯”ä¼ ç»ŸåŸºäº <code>File</code> å’Œ <code>Position</code> æ›´ç°ä»£ã€æ›´å¯é çš„å¤åˆ¶æ–¹å¼ã€‚</p><h4 id="2-ä»åº“é…ç½®-mysql-slave1-conf-slave1-cnf-å’Œ-slave2-cnf">2. ä»åº“é…ç½® (<code>mysql/slave1/conf/slave1.cnf</code> å’Œ <code>slave2.cnf</code>)</h4><p>ä¸¤ä¸ªä»åº“çš„é…ç½®ç±»ä¼¼ï¼Œåªéœ€æ›´æ”¹ <code>server-id</code>ã€‚</p><p><strong><code>slave1.cnf</code>:</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">server-id</span>               = <span class="number">101</span></span><br><span class="line"><span class="attr">gtid-mode</span>               = <span class="literal">ON</span></span><br><span class="line"><span class="attr">enforce-gtid-consistency</span>= <span class="literal">ON</span></span><br><span class="line"><span class="attr">read-only</span>               = <span class="number">1</span></span><br></pre></td></tr></table></figure><p><strong><code>slave2.cnf</code>:</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">server-id</span>               = <span class="number">102</span></span><br><span class="line"><span class="attr">gtid-mode</span>               = <span class="literal">ON</span></span><br><span class="line"><span class="attr">enforce-gtid-consistency</span>= <span class="literal">ON</span></span><br><span class="line"><span class="attr">read-only</span>               = <span class="number">1</span></span><br></pre></td></tr></table></figure><h4 id="3-ProxySQL-é…ç½®-proxysql-proxysql-cnf">3. ProxySQL é…ç½® (<code>proxysql/proxysql.cnf</code>)</h4><p>è¿™ä¸ªæ–‡ä»¶ç”¨äºåˆå§‹åŒ– ProxySQL çš„é…ç½®ã€‚</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">admin_variables</span>=</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">admin_credentials</span>=<span class="string">&quot;admin:admin&quot;</span></span><br><span class="line">    <span class="attr">mysql_ifaces</span>=<span class="string">&quot;0.0.0.0:6032&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attr">mysql_variables</span>=</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">connect_timeout_server</span>=<span class="number">3000</span></span><br><span class="line">    <span class="attr">monitor_username</span>=<span class="string">&quot;monitor_user&quot;</span></span><br><span class="line">    <span class="attr">monitor_password</span>=<span class="string">&quot;monitor_password&quot;</span></span><br><span class="line">    <span class="attr">monitor_connect_timeout</span>=<span class="number">2000</span></span><br><span class="line">    <span class="attr">monitor_ping_timeout</span>=<span class="number">1000</span></span><br><span class="line">    <span class="attr">monitor_read_only_interval</span>=<span class="number">1000</span></span><br><span class="line">    <span class="attr">monitor_read_only_timeout</span>=<span class="number">1000</span></span><br><span class="line">    <span class="attr">commands_stats</span>=<span class="string">&quot;enabled&quot;</span></span><br><span class="line">    <span class="attr">connect_timeout_server_max</span>=<span class="number">10000</span></span><br><span class="line">    <span class="attr">stacksize</span>=<span class="number">1048576</span></span><br><span class="line">    <span class="attr">threads</span>=<span class="number">4</span></span><br><span class="line">    <span class="attr">max_connections</span>=<span class="number">2048</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„</strong>ï¼šè¿™é‡Œæˆ‘ä»¬å®šä¹‰äº† ProxySQL çš„ç®¡ç†ç”¨æˆ· (<code>admin:admin</code>) å’Œä¸€ä¸ªç”¨äºç›‘æ§åç«¯ MySQL å¥åº·çŠ¶æ€çš„ç›‘æ§ç”¨æˆ· (<code>monitor_user:monitor_password</code>)ã€‚</p><h4 id="4-Docker-Compose-æ–‡ä»¶-docker-compose-yml">4. Docker Compose æ–‡ä»¶ (<code>docker-compose.yml</code>)</h4><p>è¿™æ˜¯æ•´ä¸ªæ¶æ„çš„æ ¸å¿ƒç¼–æ’æ–‡ä»¶ã€‚å®ƒå®šä¹‰äº†æ‰€æœ‰çš„æœåŠ¡ã€ç½‘ç»œå’Œæ•°æ®å·ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="comment"># ä¸»æ•°æ®åº“</span></span><br><span class="line">  <span class="attr">mysql_master:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:8.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mysql_master</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">your_root_password</span></span><br><span class="line">      <span class="attr">MYSQL_DATABASE:</span> <span class="string">my_app_db</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./mysql/master/conf:/etc/mysql/conf.d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql_master_data:/var/lib/mysql</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql_cluster_net</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ä»æ•°æ®åº“1</span></span><br><span class="line">  <span class="attr">mysql_slave1:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:8.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mysql_slave1</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">your_root_password</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./mysql/slave1/conf:/etc/mysql/conf.d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql_slave1_data:/var/lib/mysql</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql_cluster_net</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql_master</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ä»æ•°æ®åº“2</span></span><br><span class="line">  <span class="attr">mysql_slave2:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:8.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mysql_slave2</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">your_root_password</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./mysql/slave2/conf:/etc/mysql/conf.d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql_slave2_data:/var/lib/mysql</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql_cluster_net</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql_master</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ProxySQL ä¸­é—´ä»¶</span></span><br><span class="line">  <span class="attr">proxysql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">proxysql/proxysql:2.4.4</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">proxysql</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6032:6032&quot;</span> <span class="comment"># ç®¡ç†ç«¯å£</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6033:6033&quot;</span> <span class="comment"># å®¢æˆ·ç«¯è¿æ¥ç«¯å£</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./proxysql/proxysql.cnf:/etc/proxysql.cnf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">proxysql_data:/var/lib/proxysql</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql_cluster_net</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql_master</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql_slave1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql_slave2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰æ•°æ®å·</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">mysql_master_data:</span></span><br><span class="line">  <span class="attr">mysql_slave1_data:</span></span><br><span class="line">  <span class="attr">mysql_slave2_data:</span></span><br><span class="line">  <span class="attr">proxysql_data:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ç½‘ç»œ</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">mysql_cluster_net:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure><p><strong>è¯·åŠ¡å¿…å°† <code>your_root_password</code> æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„å¼ºå¯†ç ã€‚</strong></p><h3 id="é˜¶æ®µäºŒï¼šå¯åŠ¨å’Œé…ç½®é›†ç¾¤">é˜¶æ®µäºŒï¼šå¯åŠ¨å’Œé…ç½®é›†ç¾¤</h3><ol><li><p><strong>å¯åŠ¨æ‰€æœ‰æœåŠ¡</strong>ï¼š<br>åœ¨ <code>mysql_cluster</code> æ–‡ä»¶å¤¹ä¸‹ï¼Œè¿è¡Œå‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure><p>Docker ä¼šè‡ªåŠ¨æ‹‰å–é•œåƒå¹¶æŒ‰é¡ºåºå¯åŠ¨æ‰€æœ‰å®¹å™¨ã€‚</p></li><li><p><strong>é…ç½®ä¸»ä»å¤åˆ¶</strong>ï¼š<br>æˆ‘ä»¬éœ€è¦è¿›å…¥ä¸»åº“å®¹å™¨ï¼Œåˆ›å»ºå¤åˆ¶ç”¨æˆ·å’Œ ProxySQL çš„ç›‘æ§ç”¨æˆ·ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿›å…¥ä¸»åº“å®¹å™¨</span></span><br><span class="line">docker <span class="built_in">exec</span> -it mysql_master bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç™»å½•MySQL</span></span><br><span class="line">mysql -u root -p</span><br><span class="line"><span class="comment"># (è¾“å…¥æ‚¨åœ¨docker-composeä¸­è®¾ç½®çš„å¯†ç )</span></span><br></pre></td></tr></table></figure><p>åœ¨MySQLå‘½ä»¤è¡Œä¸­æ‰§è¡Œï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- åˆ›å»ºå¤åˆ¶ç”¨æˆ·</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;repl_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;repl_password&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> REPLICATION SLAVE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ›å»ºProxySQLç›‘æ§ç”¨æˆ·</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;monitor_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;monitor_password&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> USAGE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;monitor_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure><p><strong>ç°åœ¨ï¼Œé…ç½®ä¸¤ä¸ªä»åº“</strong>ã€‚è¿›å…¥æ¯ä¸ªä»åº“å®¹å™¨ï¼Œæ‰§è¡Œ <code>CHANGE MASTER TO</code> å‘½ä»¤ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿›å…¥ä»åº“1å®¹å™¨</span></span><br><span class="line">docker <span class="built_in">exec</span> -it mysql_slave1 bash</span><br><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure><p>åœ¨ä»åº“1çš„MySQLå‘½ä»¤è¡Œä¸­æ‰§è¡Œï¼ˆå¯¹ä»åº“2é‡å¤æ­¤æ“ä½œï¼‰ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ä½¿ç”¨GTIDè‡ªåŠ¨å®šä½ï¼Œæ¯”File/Positionæ›´ç®€å•</span></span><br><span class="line">CHANGE MASTER <span class="keyword">TO</span></span><br><span class="line">  MASTER_HOST<span class="operator">=</span><span class="string">&#x27;mysql_master&#x27;</span>,  <span class="comment">-- ä½¿ç”¨Dockerçš„æœåŠ¡å</span></span><br><span class="line">  MASTER_USER<span class="operator">=</span><span class="string">&#x27;repl_user&#x27;</span>,</span><br><span class="line">  MASTER_PASSWORD<span class="operator">=</span><span class="string">&#x27;repl_password&#x27;</span>,</span><br><span class="line">  MASTER_AUTO_POSITION<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">START</span> SLAVE;</span><br><span class="line"><span class="comment">-- éªŒè¯çŠ¶æ€</span></span><br><span class="line"><span class="keyword">SHOW</span> SLAVE STATUS\G; </span><br></pre></td></tr></table></figure><p>åœ¨ä»åº“2ä¸Šé‡å¤ä»¥ä¸Š <code>CHANGE MASTER TO</code> å’Œ <code>START SLAVE</code> çš„æ­¥éª¤ã€‚</p></li><li><p><strong>é…ç½® ProxySQL</strong>ï¼š<br>è¿æ¥åˆ° ProxySQL çš„ç®¡ç†åå°ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ³¨æ„ï¼Œæ˜¯ä»æ‚¨çš„å®¿ä¸»æœºè¿æ¥ï¼Œä¸æ˜¯åœ¨å®¹å™¨é‡Œ</span></span><br><span class="line">mysql -u admin -padmin -h 127.0.0.1 -P 6032</span><br></pre></td></tr></table></figure><p>åœ¨ ProxySQL ç®¡ç†åå°æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- è®¾ç½®ç›‘æ§ç”¨æˆ·å‡­è¯ï¼ˆä¸proxysql.cnfå’ŒMySQLä¸­åˆ›å»ºçš„ä¸€è‡´ï¼‰</span></span><br><span class="line"><span class="keyword">UPDATE</span> global_variables <span class="keyword">SET</span> variable_value<span class="operator">=</span><span class="string">&#x27;monitor_user&#x27;</span> <span class="keyword">WHERE</span> variable_name<span class="operator">=</span><span class="string">&#x27;mysql-monitor_username&#x27;</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> global_variables <span class="keyword">SET</span> variable_value<span class="operator">=</span><span class="string">&#x27;monitor_password&#x27;</span> <span class="keyword">WHERE</span> variable_name<span class="operator">=</span><span class="string">&#x27;mysql-monitor_password&#x27;</span>;</span><br><span class="line">LOAD MYSQL VARIABLES <span class="keyword">TO</span> RUNTIME;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- é…ç½®åç«¯MySQLæœåŠ¡å™¨</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> mysql_servers(hostgroup_id, hostname, port) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">10</span>, <span class="string">&#x27;mysql_master&#x27;</span>, <span class="number">3306</span>), <span class="comment">-- å†™å…¥ç»„ (ä¸»åº“)</span></span><br><span class="line">(<span class="number">20</span>, <span class="string">&#x27;mysql_slave1&#x27;</span>, <span class="number">3306</span>), <span class="comment">-- è¯»å–ç»„ (ä»åº“1)</span></span><br><span class="line">(<span class="number">20</span>, <span class="string">&#x27;mysql_slave2&#x27;</span>, <span class="number">3306</span>); <span class="comment">-- è¯»å–ç»„ (ä»åº“2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- é…ç½®åº”ç”¨è¿æ¥ç”¨æˆ·</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> mysql_users(username, password, default_hostgroup) <span class="keyword">VALUES</span> </span><br><span class="line">(<span class="string">&#x27;app_user&#x27;</span>, <span class="string">&#x27;app_password&#x27;</span>, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- å®šä¹‰è¯»å†™åˆ†ç¦»è§„åˆ™</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> mysql_query_rules(rule_id, active, match_digest, destination_hostgroup, apply) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;^SELECT.*&#x27;</span>, <span class="number">20</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="number">2</span>, <span class="number">1</span>, <span class="string">&#x27;.*&#x27;</span>, <span class="number">10</span>, <span class="number">1</span>); <span class="comment">-- ä¸€ä¸ªæ›´ç®€å•çš„è§„åˆ™ï¼šåŒ¹é…SELECTçš„å»è¯»å–ç»„ï¼Œå…¶ä»–æ‰€æœ‰éƒ½å»å†™å…¥ç»„</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- åŠ è½½å¹¶ä¿å­˜é…ç½®</span></span><br><span class="line">LOAD MYSQL SERVERS <span class="keyword">TO</span> RUNTIME;</span><br><span class="line">LOAD MYSQL USERS <span class="keyword">TO</span> RUNTIME;</span><br><span class="line">LOAD MYSQL QUERY RULES <span class="keyword">TO</span> RUNTIME;</span><br><span class="line">SAVE MYSQL SERVERS <span class="keyword">TO</span> DISK;</span><br><span class="line">SAVE MYSQL USERS <span class="keyword">TO</span> DISK;</span><br><span class="line">SAVE MYSQL QUERY RULES <span class="keyword">TO</span> DISK;</span><br></pre></td></tr></table></figure></li></ol><h3 id="proxy-sql-web">proxy-sql-web</h3><ul><li>docker-compose.yml</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">proxysql-web:</span></span><br><span class="line">    <span class="comment"># --- ä¿®æ”¹ç‚¹åœ¨è¿™é‡Œ ---</span></span><br><span class="line">    <span class="comment"># ä½¿ç”¨ä¸€ä¸ªåœ¨ Docker Hub ä¸Šå…¬å¼€å¯ç”¨çš„é•œåƒ</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">kishorj/proxysql-web:latest</span></span><br><span class="line">    <span class="comment"># ------------------</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">proxysql-web</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:80&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB_HOST=192.168.10.158</span> <span class="comment"># æ‚¨çš„ ProxySQL æœåŠ¡å™¨ IP</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB_PORT=6032</span>         <span class="comment"># ProxySQL ç®¡ç†ç«¯å£</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB_USER=admin</span>          <span class="comment"># ProxySQL ç®¡ç†ç”¨æˆ·å</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB_PASS=admin</span>          <span class="comment"># ProxySQL ç®¡ç†å¯†ç </span></span><br></pre></td></tr></table></figure><ul><li>run</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> docker-compose up -d</span><br></pre></td></tr></table></figure><h3 id="é˜¶æ®µä¸‰ï¼šåˆ‡æ¢åº”ç”¨">é˜¶æ®µä¸‰ï¼šåˆ‡æ¢åº”ç”¨</h3><p>ç°åœ¨ï¼Œæ‚¨çš„æ•´ä¸ªé«˜å¯ç”¨é›†ç¾¤å·²ç»åœ¨ Docker ä¸­è¿è¡Œèµ·æ¥äº†ã€‚æœ€åä¸€æ­¥å°±æ˜¯å°†æ‚¨æ‰€æœ‰200å¤šå°ç”µè„‘ä¸Šçš„åº”ç”¨ç¨‹åºçš„æ•°æ®åº“è¿æ¥é…ç½®ï¼ŒæŒ‡å‘ ProxySQL å®¹å™¨æš´éœ²çš„ç«¯å£ã€‚</p><ul><li><strong>Host</strong>: è¿è¡Œ Docker çš„é‚£å°æœåŠ¡å™¨çš„ IP åœ°å€ã€‚</li><li><strong>Port</strong>: <code>6033</code></li><li><strong>User</strong>: <code>app_user</code></li><li><strong>Password</strong>: <code>app_password</code></li></ul><h3 id="ä¼˜ç‚¹æ€»ç»“">ä¼˜ç‚¹æ€»ç»“</h3><ul><li><strong>ç¯å¢ƒä¸€è‡´æ€§</strong>ï¼šæ— è®ºéƒ¨ç½²åˆ°å“ªå°æœºå™¨ï¼Œæ•´ä¸ªé›†ç¾¤çš„ç¯å¢ƒéƒ½æ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚</li><li><strong>å¿«é€Ÿéƒ¨ç½²ä¸é”€æ¯</strong>ï¼šä½¿ç”¨ <code>docker-compose up -d</code> å’Œ <code>docker-compose down -v</code> å¯ä»¥ç§’çº§åˆ›å»ºå’Œå½»åº•é”€æ¯æ•´å¥—ç¯å¢ƒï¼Œéå¸¸é€‚åˆæµ‹è¯•å’Œå¼€å‘ã€‚</li><li><strong>ç®€åŒ–ç®¡ç†</strong>ï¼šæœåŠ¡ä¹‹é—´çš„ç½‘ç»œå’Œä¾èµ–å…³ç³»ç”± Docker Compose ç®¡ç†ï¼Œæ¯”æ‰‹åŠ¨é…ç½®ç½‘ç»œå’Œé˜²ç«å¢™ç®€å•å¾—å¤šã€‚</li><li><strong>èµ„æºéš”ç¦»</strong>ï¼šæ¯ä¸ªæœåŠ¡éƒ½åœ¨è‡ªå·±çš„å®¹å™¨ä¸­è¿è¡Œï¼Œäº’ä¸å¹²æ‰°ã€‚</li></ul><p>è¿™ä¸ª Docker åŒ–çš„æ–¹æ¡ˆä¸ºæ‚¨æä¾›äº†ä¸€ä¸ªå¯ç§»æ¤ã€å¯å¤ç°ã€é«˜åº¦è‡ªåŠ¨åŒ–çš„æ–¹å¼æ¥éƒ¨ç½²å’Œç®¡ç†æ‚¨çš„MySQLè¯»å†™åˆ†ç¦»é›†ç¾¤ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨Devpiä¸Nginxæ„å»ºé«˜å¯ç”¨PyPIé•œåƒæº</title>
      <link href="/2025/09/17/pypi-mirror-self/"/>
      <url>/2025/09/17/pypi-mirror-self/</url>
      
        <content type="html"><![CDATA[<h2 id="ä½¿ç”¨Devpiä¸Nginxæ„å»ºé«˜å¯ç”¨PyPIé•œåƒæº">ä½¿ç”¨Devpiä¸Nginxæ„å»ºé«˜å¯ç”¨PyPIé•œåƒæº</h2><h3 id="å‰è¨€ï¼šä¸ºä»€ä¹ˆä½ çš„pip-installåˆè¶…æ—¶äº†ï¼Ÿ">å‰è¨€ï¼šä¸ºä»€ä¹ˆä½ çš„<code>pip install</code>åˆè¶…æ—¶äº†ï¼Ÿ</h3><p>å¯¹äºæ¯ä¸€ä½Pythonå¼€å‘è€…æ¥è¯´ï¼Œ<code>pip install</code> æ— ç–‘æ˜¯æœ€å¸¸ç”¨çš„å‘½ä»¤ä¹‹ä¸€ã€‚ç„¶è€Œï¼Œå›¢é˜Ÿå¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šé‡åˆ°è¿™äº›ç—›ç‚¹ï¼š</p><ul><li><strong>é€Ÿåº¦ç“¶é¢ˆ</strong>ï¼šå›¢é˜Ÿå‡ åå·äººï¼ŒCI/CDæµæ°´çº¿ä¸Šç™¾ä¸ªä»»åŠ¡ï¼Œå…¨éƒ½ä»å›½å¤–çš„å®˜æ–¹PyPIæºæ‹‰å–åŒ…ï¼Œä¸‹è½½é€Ÿåº¦æ…¢å¾—ä»¤äººæŠ“ç‹‚ï¼Œä¸¥é‡å½±å“å¼€å‘å’Œéƒ¨ç½²æ•ˆç‡ã€‚</li><li><strong>å•ç‚¹æ•…éšœ</strong>ï¼šå®˜æ–¹PyPIå¶å°”ä¼šæŠ–åŠ¨ï¼Œæˆ–è€…å…¬å¸å‡ºå£ç½‘ç»œå‡ºç°é—®é¢˜ï¼Œå¯¼è‡´æ‰€æœ‰ä¾èµ–å®‰è£…å¤±è´¥ï¼Œç ”å‘æµç¨‹ç¬é—´åœæ‘†ã€‚</li><li><strong>å®‰å…¨ä¸åˆè§„</strong>ï¼šæ— æ³•å¯¹å›¢é˜Ÿä½¿ç”¨çš„ç¬¬ä¸‰æ–¹åŒ…è¿›è¡Œç»Ÿä¸€ç®¡ç†å’Œå®‰å…¨å®¡è®¡ã€‚</li><li><strong>ç§æœ‰åŒ…æ‰˜ç®¡</strong>ï¼šå›¢é˜Ÿå†…éƒ¨å¼€å‘çš„å…¬å…±åº“æ— å¤„å®‰æ”¾ï¼Œåªèƒ½é€šè¿‡Gitä»“åº“ç­‰åŸå§‹æ–¹å¼å…±äº«ã€‚</li></ul><p>ä¸ºäº†å½»åº•è§£å†³è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª<strong>ç§æœ‰çš„ã€é«˜é€Ÿçš„ã€ä¸”æ°¸ä¸å®•æœº</strong>çš„PythonåŒ…ä»“åº“ã€‚ä»Šå¤©ï¼Œæˆ‘å°†æ‰‹æŠŠæ‰‹å¸¦ä½ ä½¿ç”¨ä¸šç•Œæœ€å¼ºå¤§çš„å¼€æºå·¥å…· <strong><code>devpi</code></strong> å’Œ <strong><code>Nginx</code></strong>ï¼Œæ„å»ºä¸€ä¸ªå…·å¤‡è‡ªåŠ¨æ•…éšœè½¬ç§»èƒ½åŠ›çš„é«˜å¯ç”¨PyPIé•œåƒæºã€‚</p><p><strong>æœ€ç»ˆç›®æ ‡</strong>ï¼šæ— è®ºæ¸…åæºã€é˜¿é‡Œæºè¿˜æ˜¯å…¶ä»–ä»»ä½•ä¸€ä¸ªé•œåƒæŒ‚äº†ï¼Œæˆ‘ä»¬çš„ <code>pip install</code> ä¾ç„¶èƒ½ä¸æ»‘æµç•…åœ°è¿è¡Œï¼Œå¯¹å¼€å‘è€…å®Œå…¨é€æ˜ï¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">+-----------+     +-------------------+     +-------------------------+     +--------------------------+</span><br><span class="line">|           |     |                   |     |                         |     |   Tsinghua Mirror       |</span><br><span class="line">|  å¼€å‘è€…   | --&gt; |  devpi æœåŠ¡å™¨      | --&gt; |  Nginx åå‘ä»£ç†          | --&gt; |  (Upstream 1)            |</span><br><span class="line">| (pip)     |     | (ç¼“å­˜/ç§æœ‰åŒ…)      |     | (å¤„ç†ä¸Šæ¸¸æ•…éšœè½¬ç§»)       |     +--------------------------+</span><br><span class="line">|           |     |                   |     |                         |     |  Aliyun Mirror         |</span><br><span class="line">+-----------+     +-------------------+     +-------------------------+ --&gt; |  (Upstream 2)            |</span><br><span class="line">                                                                            +--------------------------+</span><br><span class="line">                                                                            |  USTC Mirror             |</span><br><span class="line">                                                                          -&gt;|  (Upstream 3)            |</span><br><span class="line">                                                                            +--------------------------+</span><br><span class="line">                                                                            |  ... and so on           |</span><br><span class="line">                                                                            +--------------------------+</span><br></pre></td></tr></table></figure><h3 id="ç¬¬ä¸€ç« ï¼šæ ¸å¿ƒæ­¦å™¨ä»‹ç»-Devpi-ä¸-Nginx">ç¬¬ä¸€ç« ï¼šæ ¸å¿ƒæ­¦å™¨ä»‹ç» - Devpi ä¸ Nginx</h3><p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹ä¸¤ä½ä¸»è§’ï¼š</p><ol><li><p><strong>Devpi</strong>: ä¸€ä¸ªåŠŸèƒ½å®Œå¤‡çš„PythonåŒ…æœåŠ¡å™¨ã€‚å®ƒä¸ä»…ä»…æ˜¯ <code>pypi.org</code> çš„ä¸€ä¸ªç¼“å­˜ä»£ç†ï¼Œæ›´æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ç§æœ‰åŒ…ä»“åº“å’Œç‰ˆæœ¬å‘å¸ƒç®¡ç†å·¥å…·ã€‚æˆ‘ä»¬å°†ä¸»è¦åˆ©ç”¨å®ƒçš„<strong>ç¼“å­˜é•œåƒ</strong>åŠŸèƒ½ã€‚</p></li><li><p><strong>Nginx</strong>: ä¸€æ¬¾é«˜æ€§èƒ½çš„HTTPå’Œåå‘ä»£ç†æœåŠ¡å™¨ã€‚åœ¨è¿™é‡Œï¼Œå®ƒå°†æ‰®æ¼”æˆ‘ä»¬é•œåƒæºçš„â€œæ™ºèƒ½è°ƒåº¦å‘˜â€å’Œâ€œæ•…éšœå“¨å…µâ€ï¼Œè´Ÿè´£ç›‘æµ‹ä¸Šæ¸¸é•œåƒæºçš„å¥åº·çŠ¶å†µï¼Œå¹¶åœ¨æŸä¸ªæºå‡ºç°é—®é¢˜æ—¶ï¼Œè‡ªåŠ¨å°†æµé‡åˆ‡æ¢åˆ°å¥åº·çš„å¤‡ç”¨æºä¸Šã€‚</p></li></ol><h3 id="ç¬¬äºŒç« ï¼šåŸºç¡€å»ºè®¾-æ­å»ºDevpiç¼“å­˜æœåŠ¡å™¨">ç¬¬äºŒç« ï¼šåŸºç¡€å»ºè®¾ - æ­å»ºDevpiç¼“å­˜æœåŠ¡å™¨</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªèƒ½ç¨³å®šè¿è¡Œçš„<code>devpi</code>æœåŠ¡ã€‚</p><h4 id="æ­¥éª¤-1-å‡†å¤‡æœåŠ¡å™¨ä¸å®‰è£…Devpi">æ­¥éª¤ 1: å‡†å¤‡æœåŠ¡å™¨ä¸å®‰è£…Devpi</h4><p>åœ¨ä¸€å°LinuxæœåŠ¡å™¨ï¼ˆæœ¬æ•™ç¨‹ä»¥Ubuntuä¸ºä¾‹ï¼‰ä¸Šï¼Œç¡®ä¿å·²å®‰è£…Pythonå’Œpipã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ›´æ–°å¹¶å®‰è£…ä¾èµ–</span></span><br><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install -y python3 python3-pip</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… devpi-server</span></span><br><span class="line">pip3 install devpi-server</span><br><span class="line"></span><br><span class="line">devpi-init</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="æ­¥éª¤-2-åˆå§‹åŒ–Devpi">æ­¥éª¤ 2: åˆå§‹åŒ–Devpi</h4><p>è¿™ä¸ªä¸€æ¬¡æ€§æ“ä½œä¼šä¸ºä½ åˆ›å»ºæ•°æ®ç›®å½•å’Œ <code>root</code> è¶…çº§ç®¡ç†å‘˜ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">devpi-init</span><br></pre></td></tr></table></figure><p>åœ¨æç¤ºä¸­ï¼Œä¸º <code>root</code> ç”¨æˆ·è®¾ç½®ä¸€ä¸ªå®‰å…¨çš„å¯†ç ï¼Œå¹¶ç‰¢ç‰¢è®°ä½å®ƒã€‚</p><h4 id="æ­¥éª¤-3-è®©Devpiåœ¨åå°ç¨³å®šè¿è¡Œ">æ­¥éª¤ 3: è®©Devpiåœ¨åå°ç¨³å®šè¿è¡Œ</h4><p>ä¸ºäº†ç”Ÿäº§ç¯å¢ƒçš„ç¨³å®šï¼Œæˆ‘ä»¬å°† <code>devpi</code> é…ç½®æˆä¸€ä¸ª <code>systemd</code> ç³»ç»ŸæœåŠ¡ï¼Œå®ç°å¼€æœºè‡ªå¯å’Œåå°è¿è¡Œã€‚</p><ol><li><p><strong>åˆ›å»ºæœåŠ¡æ–‡ä»¶</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> nano /etc/systemd/system/devpi.service</span><br></pre></td></tr></table></figure></li><li><p><strong>ç²˜è´´ä»¥ä¸‹é…ç½®</strong> (æ³¨æ„ä¿®æ”¹ <code>User</code> å’Œ <code>ExecStart</code> ä¸­çš„è·¯å¾„ä¸ºä½ è‡ªå·±çš„):</p></li></ol><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(venv) czq2@czq2:~/clip-video$ sudo cat /etc/systemd/system/devpi.service</span><br><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=devpi-server daemon</span><br><span class="line"><span class="attr">After</span>=network.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=simple</span><br><span class="line"><span class="attr">User</span>=czq2</span><br><span class="line"><span class="attr">Group</span>=czq2</span><br><span class="line"><span class="attr">ExecStart</span>=/home/czq2/clip-video/venv/bin/devpi-server --host=<span class="number">0.0</span>.<span class="number">0.0</span> --port=<span class="number">3141</span></span><br><span class="line"><span class="attr">Restart</span>=<span class="literal">on</span>-failure</span><br><span class="line"><span class="attr">RestartSec</span>=<span class="number">5</span>s</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure><ul><li><code>--host=0.0.0.0</code> ç¡®ä¿å±€åŸŸç½‘å†…çš„å…¶ä»–æœºå™¨å¯ä»¥è®¿é—®ã€‚</li></ul><ol start="3"><li><strong>å¯åŠ¨å¹¶éªŒè¯æœåŠ¡</strong>:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload</span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> devpi  <span class="comment"># å¼€æœºè‡ªå¯</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl start devpi   <span class="comment"># å¯åŠ¨</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl status devpi  <span class="comment"># æ£€æŸ¥çŠ¶æ€</span></span><br></pre></td></tr></table></figure>çœ‹åˆ°ç»¿è‰²çš„ <code>active (running)</code>ï¼Œæ­å–œä½ ï¼ŒåŸºç¡€çš„ <code>devpi</code> é•œåƒæœåŠ¡å·²ç»æˆåŠŸè¿è¡Œåœ¨ <code>http://&lt;ä½ çš„æœåŠ¡å™¨IP&gt;:3141</code> ä¸Šäº†ï¼</li></ol><ul><li>æˆåŠŸè¾“å‡º</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">(venv) czq2@czq2:~/clip-video$ <span class="built_in">sudo</span> systemctl start devpi</span><br><span class="line">(venv) czq2@czq2:~/clip-video$ <span class="built_in">sudo</span> systemctl status devpi</span><br><span class="line">â— devpi.service - devpi-server daemon</span><br><span class="line">     Loaded: loaded (/etc/systemd/system/devpi.service; enabled; preset: enabled)</span><br><span class="line">     Active: active (running) since Wed 2025-09-17 07:19:23 UTC; 3s ago</span><br><span class="line">   Main PID: 1619813 (devpi-server)</span><br><span class="line">      Tasks: 54 (<span class="built_in">limit</span>: 309293)</span><br><span class="line">     Memory: 41.4M (peak: 553.5M)</span><br><span class="line">        CPU: 15.733s</span><br><span class="line">     CGroup: /system.slice/devpi.service</span><br><span class="line">             â””â”€1619813 /home/czq2/clip-video/venv/bin/python3 /home/czq2/clip-video/venv/bin/devpi-server --host=0.0.0.0 --p&gt;</span><br><span class="line"></span><br><span class="line">Sep 17 07:19:23 czq2 devpi-server[1619813]: 2025-09-17 07:19:23,634 WARNI NOCTX No secret file provided, creating a new rand&gt;</span><br><span class="line">Sep 17 07:19:25 czq2 devpi-server[1619813]: 2025-09-17 07:19:25,757 INFO  [ASYN] Starting asyncio event loop</span><br><span class="line">Sep 17 07:19:25 czq2 devpi-server[1619813]: 2025-09-17 07:19:25,777 INFO  NOCTX devpi-server version: 6.17.0</span><br><span class="line">Sep 17 07:19:25 czq2 devpi-server[1619813]: 2025-09-17 07:19:25,777 INFO  NOCTX serverdir: /home/czq2/.devpi/server</span><br><span class="line">Sep 17 07:19:25 czq2 devpi-server[1619813]: 2025-09-17 07:19:25,777 INFO  NOCTX uuid: 0c7aa3d0d1874fd596c8936cd007d305</span><br><span class="line">Sep 17 07:19:25 czq2 devpi-server[1619813]: 2025-09-17 07:19:25,777 INFO  NOCTX serving at url: http://0.0.0.0:3141 (might b&gt;</span><br><span class="line">Sep 17 07:19:25 czq2 devpi-server[1619813]: 2025-09-17 07:19:25,777 INFO  NOCTX using 50 threads</span><br><span class="line">Sep 17 07:19:25 czq2 devpi-server[1619813]: 2025-09-17 07:19:25,777 INFO  NOCTX bug tracker: https://github.com/devpi/devpi/&gt;</span><br><span class="line">Sep 17 07:19:25 czq2 devpi-server[1619813]: 2025-09-17 07:19:25,777 INFO  NOCTX Hit Ctrl-C to quit.</span><br><span class="line">Sep 17 07:19:25 czq2 devpi-server[1619813]: 2025-09-17 07:19:25,785 INFO  Serving on http://0.0.0.0:3141</span><br></pre></td></tr></table></figure><ul><li>é”™è¯¯åˆ†æ</li></ul> <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> journalctl -u devpi.service -n 50 --no-pager</span><br></pre></td></tr></table></figure><h3 id="ç¬¬ä¸‰ç« ï¼šæ„å»ºæŠ¤åŸæ²³-Nginxé«˜å¯ç”¨åå‘ä»£ç†">ç¬¬ä¸‰ç« ï¼šæ„å»ºæŠ¤åŸæ²³ - Nginxé«˜å¯ç”¨åå‘ä»£ç†</h3><p>ç°åœ¨ï¼Œæˆ‘ä»¬è¦ä¸º <code>devpi</code> æ„å»ºä¸€ä¸ªåšå›ºçš„å‰å“¨ç«™ï¼Œè®©å®ƒä¸å†ç›´æ¥ä¾èµ–ä»»ä½•å•ä¸€çš„ä¸Šæ¸¸æºã€‚</p><h4 id="æ­¥éª¤-1-å®‰è£…-Nginx">æ­¥éª¤ 1: å®‰è£… Nginx</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install -y nginx</span><br></pre></td></tr></table></figure><h4 id="æ­¥éª¤-2-ç¼–å†™Nginxé«˜å¯ç”¨é…ç½®">æ­¥éª¤ 2: ç¼–å†™Nginxé«˜å¯ç”¨é…ç½®</h4><p>è¿™æ˜¯å®ç°è‡ªåŠ¨æ•…éšœè½¬ç§»çš„<strong>æ ¸å¿ƒ</strong>ã€‚</p><ol><li><p><strong>åˆ›å»ºNginxé…ç½®æ–‡ä»¶</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> nano /etc/nginx/sites-available/pypi-proxy</span><br></pre></td></tr></table></figure></li><li><p><strong>ç²˜è´´ä»¥ä¸‹é­”æ³•é…ç½®</strong>:</p></li></ol><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># /etc/nginx/sites-available/pypi-proxy</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## å®šä¹‰ä¸€ä¸ªä¸Šæ¸¸æœåŠ¡å™¨ç»„ï¼Œè¿™æ¬¡å…¨éƒ¨ä½¿ç”¨ HTTPS</span></span><br><span class="line"></span><br><span class="line"><span class="section">upstream</span> pypi_mirrors_https &#123;</span><br><span class="line">    <span class="comment"># ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç›´æ¥æŒ‡å‘ HTTPS åŸŸåï¼Œç«¯å£ 443 æ˜¯é»˜è®¤çš„ï¼Œå¯ä»¥ä¸å†™</span></span><br><span class="line">    <span class="attribute">server</span> pypi.tuna.tsinghua.edu.cn:<span class="number">443</span>;</span><br><span class="line">    <span class="attribute">server</span> mirrors.aliyun.com:<span class="number">443</span>;</span><br><span class="line">    <span class="attribute">server</span> pypi.mirrors.ustc.edu.cn:<span class="number">443</span>;</span><br><span class="line">    <span class="attribute">server</span> mirrors.cloud.tencent.com:<span class="number">443</span>;</span><br><span class="line">    <span class="attribute">server</span> repo.huaweicloud.com:<span class="number">443</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8888</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="comment"># ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†è¯·æ±‚ä»£ç†åˆ°æˆ‘ä»¬æ–°çš„ HTTPS æœåŠ¡å™¨ç»„</span></span><br><span class="line">        <span class="attribute">proxy_pass</span> https://pypi_mirrors_https;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ•…éšœè½¬ç§»çš„é…ç½®ä¿æŒä¸å˜</span></span><br><span class="line">        <span class="attribute">proxy_next_upstream</span> <span class="literal">error</span> timeout http_500 http_502 http_503 http_504;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_connect_timeout</span> <span class="number">10s</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ã€é‡è¦ã€‘å½“ä»£ç†åˆ° HTTPS ä¸Šæ¸¸æ—¶ï¼Œå¿…é¡»æ­£ç¡®è®¾ç½® Host å¤´</span></span><br><span class="line">        <span class="comment"># è¿™é‡Œçš„ $host ä¼šæ˜¯ä¸Šæ¸¸æœåŠ¡å™¨ç»„çš„åç§°ï¼Œä¸ºäº†æ­£ç¡®æ€§ï¼Œæˆ‘ä»¬åº”è¯¥ä¼ é€’åŸå§‹è¯·æ±‚çš„Host</span></span><br><span class="line">        <span class="comment"># æˆ–è€…ç›´æ¥ç¡¬ç¼–ç ä¸º pypi.tuna.tsinghua.edu.cn ç­‰ï¼Œä½†ä¼ é€’åŸå§‹Hostæ›´çµæ´»</span></span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$proxy_host</span>; <span class="comment"># ä½¿ç”¨ $proxy_host å˜é‡</span></span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰å¢åŠ  SSL ç›¸å…³çš„ä»£ç†è®¾ç½®</span></span><br><span class="line">        <span class="attribute">proxy_ssl_server_name</span> <span class="literal">on</span>; <span class="comment"># è¿™ä¼šè®©Nginxåœ¨TLSæ¡æ‰‹ä¸­å‘é€æ­£ç¡®çš„æœåŠ¡å™¨åç§°(SNI)</span></span><br><span class="line">        <span class="attribute">proxy_ssl_session_reuse</span> <span class="literal">on</span>; <span class="comment"># å¯ç”¨SSLä¼šè¯å¤ç”¨ä»¥æé«˜æ€§èƒ½</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li><strong>å¯ç”¨é…ç½®å¹¶é‡å¯Nginx</strong>:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">ln</span> -s /etc/nginx/sites-available/pypi-proxy /etc/nginx/sites-enabled/</span><br><span class="line"><span class="built_in">sudo</span> nginx -t          <span class="comment"># æµ‹è¯•é…ç½®è¯­æ³•</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl restart nginx <span class="comment"># é‡å¯Nginx</span></span><br></pre></td></tr></table></figure>ç°åœ¨ï¼Œä¸€ä¸ªå¼ºå¤§çš„ã€èƒ½è‡ªåŠ¨åˆ‡æ¢æºçš„åå‘ä»£ç†å·²ç»åœ¨ <code>http://192.168.10.158:8088</code> ä¸Šä¸ºä½ å¾…å‘½ã€‚</li></ol><hr><h3 id="ç¬¬å››ç« ï¼šåˆä½“ï¼å°†Devpiæ¥å…¥Nginxä»£ç†">ç¬¬å››ç« ï¼šåˆä½“ï¼å°†Devpiæ¥å…¥Nginxä»£ç†</h3><p>ä¸‡äº‹ä¿±å¤‡ï¼Œåªå·®æœ€åä¸€æ­¥ï¼šè®© <code>devpi</code> é€šè¿‡æˆ‘ä»¬çš„ Nginx â€œæŠ¤åŸæ²³â€å»è®¿é—®ä¸–ç•Œã€‚</p><ol><li><p><strong>åœæ­¢DevpiæœåŠ¡</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl stop devpi</span><br></pre></td></tr></table></figure></li><li><p><strong>ä¿®æ”¹Devpiçš„å¯åŠ¨å‚æ•°</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> nano /etc/systemd/system/devpi.service</span><br></pre></td></tr></table></figure></li><li><p>åœ¨ <code>ExecStart</code> è¡Œçš„æœ«å°¾ï¼Œæ·»åŠ  <code>--mirror-url</code> å‚æ•°ï¼ŒæŒ‡å‘æˆ‘ä»¬çš„Nginxä»£ç†ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="attr">ExecStart</span>=/home/your_username/.local/bin/devpi-server --host=<span class="number">0.0</span>.<span class="number">0.0</span> --port=<span class="number">3141</span> --mirror-url http://<span class="number">192.168</span>.<span class="number">10.158</span>:<span class="number">8088</span>/pypi</span><br><span class="line"><span class="comment"># ...</span></span><br></pre></td></tr></table></figure></li><li><p><strong>é‡æ–°åŠ è½½å¹¶å¯åŠ¨Devpi</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload</span><br><span class="line"><span class="built_in">sudo</span> systemctl start devpi</span><br></pre></td></tr></table></figure></li></ol><hr><h3 id="ç¬¬äº”ç« ï¼šäº«å—æˆæœ-é…ç½®å®¢æˆ·ç«¯">ç¬¬äº”ç« ï¼šäº«å—æˆæœ - é…ç½®å®¢æˆ·ç«¯</h3><p>ç°åœ¨ï¼Œè®©å›¢é˜Ÿçš„æ‰€æœ‰å¼€å‘è€…å’ŒCI/CDæœåŠ¡å™¨éƒ½äº«å—åˆ°è¿™ä¸ªç¨³å®šé«˜é€Ÿçš„é•œåƒæºå§ï¼</p><p>åœ¨æ¯ä¸€å°å®¢æˆ·ç«¯æœºå™¨ä¸Šï¼Œåˆ›å»ºæˆ–ä¿®æ”¹ <code>~/.pip/pip.conf</code> (macOS/Linux) æˆ– <code>%APPDATA%\pip\pip.ini</code> (Windows) æ–‡ä»¶ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[global]</span></span><br><span class="line"><span class="attr">index-url</span> = http://<span class="number">192.168</span>.<span class="number">10.158</span>:<span class="number">3141</span>/root/pypi/</span><br><span class="line"><span class="attr">trusted-host</span> = <span class="number">192.168</span>.<span class="number">10.158</span></span><br></pre></td></tr></table></figure><ul><li><code>index-url</code> æŒ‡å‘æˆ‘ä»¬æ­å»ºçš„ <code>devpi</code> æœåŠ¡ã€‚</li><li><code>trusted-host</code> å‘Šè¯‰ <code>pip</code> è¿™æ˜¯ä¸€ä¸ªå¯ä¿¡ä»»çš„HTTPæºã€‚</li></ul><h3 id="ä½¿ç”¨docker-compose-æ­å»º-devpi">ä½¿ç”¨docker compose æ­å»º devpi</h3><ul><li>docker-comose.yml</li></ul> <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># version å±æ€§å·²è¿‡æ—¶ï¼Œå¯ä»¥ç§»é™¤</span></span><br><span class="line"><span class="comment"># version: &quot;2.3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="comment"># æœåŠ¡1ï¼šé«˜å¯ç”¨ Nginx åå‘ä»£ç†</span></span><br><span class="line">  <span class="attr">nginx-proxy:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">devpi-nginx-proxy</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="comment"># å°†æˆ‘ä»¬çš„ stream é…ç½®æ–‡ä»¶æŒ‚è½½åˆ°å®¹å™¨ä¸­</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx_conf/nginx.conf:/etc/nginx/nginx.conf:ro</span></span><br><span class="line">    <span class="comment"># è¿™ä¸ªæœåŠ¡åªåœ¨å†…éƒ¨ä½¿ç”¨ï¼Œä¸éœ€è¦æš´éœ²ç«¯å£åˆ°å®¿ä¸»æœº</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># æœåŠ¡2ï¼šDevpi æœåŠ¡å™¨</span></span><br><span class="line">  <span class="attr">devpi-lib:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">devpi-lib</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">lowinli98/devpi:v0.2</span></span><br><span class="line">    <span class="attr">expose:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7104</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;7104:7104&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DEVPISERVER_HOST=0.0.0.0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DEVPISERVER_PORT=7104</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DEVPISERVER_ROOT_PASSWORD=111</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DEVPISERVER_USER=czq</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DEVPISERVER_PASSWORD=111</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DEVPISERVER_MIRROR_INDEX=pypi</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DEVPISERVER_LIB_INDEX=devpi</span></span><br><span class="line">      <span class="comment"># --- ã€æ ¸å¿ƒä¿®æ”¹ã€‘---</span></span><br><span class="line">      <span class="comment"># å°†ä¸Šæ¸¸é•œåƒæºæŒ‡å‘æˆ‘ä»¬å†…éƒ¨çš„ nginx-proxy æœåŠ¡çš„ 443 ç«¯å£</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SOURCE_MIRROR_URL=http://nginx-proxy</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./volume:/var/lib/devpi</span></span><br><span class="line">    <span class="comment"># ã€é‡è¦ã€‘ç¡®ä¿ devpi æœåŠ¡ä¾èµ–äº nginx-proxy æœåŠ¡</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nginx-proxy</span></span><br></pre></td></tr></table></figure><ul><li>nignx conf</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"># nginx_conf/nginx.conf (HTTP ä»£ç†ç‰ˆæœ¬)</span><br><span class="line"></span><br><span class="line">events &#123;&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    # å®šä¹‰é«˜å¯ç”¨çš„ PyPI é•œåƒä¸Šæ¸¸æœåŠ¡å™¨æ± </span><br><span class="line">    upstream pypi_mirrors_https &#123;</span><br><span class="line">        server pypi.tuna.tsinghua.edu.cn:443;</span><br><span class="line">        server mirrors.aliyun.com:443;</span><br><span class="line">        server pypi.mirrors.ustc.edu.cn:443;</span><br><span class="line">        server mirrors.cloud.tencent.com:443;</span><br><span class="line">        server pypi.douban.com:443;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        # ç›‘å¬å®¹å™¨å†…éƒ¨çš„ 80 ç«¯å£ï¼Œæ¥æ”¶æ¥è‡ª devpi-lib çš„ HTTP è¯·æ±‚</span><br><span class="line">        listen 80;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            # å°†è¯·æ±‚ä»£ç†åˆ° HTTPS ä¸Šæ¸¸</span><br><span class="line">            proxy_pass https://pypi_mirrors_https;</span><br><span class="line"></span><br><span class="line">            # --- ä»£ç†æ ¸å¿ƒé…ç½® ---</span><br><span class="line">            proxy_next_upstream error timeout http_502 http_503 http_504;</span><br><span class="line">            proxy_connect_timeout 10s;</span><br><span class="line"></span><br><span class="line">            # --- å…³é”®çš„è¯·æ±‚å¤´ä¸ SSL/TLS é…ç½® ---</span><br><span class="line">            proxy_set_header Host $proxy_host;</span><br><span class="line">            proxy_ssl_server_name on;</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">            proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">            proxy_ssl_session_reuse on;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>docker run</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> docker-compose up -d --build</span><br></pre></td></tr></table></figure><h3 id="è‡ªå»ºdevpié•œåƒ">è‡ªå»ºdevpié•œåƒ</h3><ul><li>Dockerfile</li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dockerfile (æœ€ç»ˆç¨³å®šç‰ˆ)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ä¸€ä¸ªå®˜æ–¹çš„ã€è½»é‡çº§çš„ Python 3.9 åŸºç¡€é•œåƒ</span></span><br><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.9</span>-slim</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å®¹å™¨å†…çš„å·¥ä½œç›®å½•</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ã€æ„å»ºæ—¶ç½‘ç»œä¼˜åŒ–ã€‘</span></span><br><span class="line"><span class="comment"># å°† pip çš„é»˜è®¤æºè®¾ç½®ä¸ºé«˜é€Ÿçš„é•œåƒæº</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip config <span class="built_in">set</span> global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- ã€æ ¸å¿ƒ Bug ä¿®å¤ &amp; ç‰ˆæœ¬é”å®šã€‘ ---</span></span><br><span class="line"><span class="comment"># å®‰è£…åº”ç”¨ç¨‹åºåŠå…¶ä¾èµ–ï¼Œå¹¶é”å®šæ‰€æœ‰æ ¸å¿ƒç»„ä»¶çš„ç‰ˆæœ¬</span></span><br><span class="line"><span class="comment"># devpi-server 6.9.x æ˜¯ä¸€ä¸ªéå¸¸ç¨³å®šçš„ç³»åˆ—</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install --no-cache-dir --upgrade pip &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    pip install --no-cache-dir \</span></span><br><span class="line"><span class="language-bash">        <span class="string">&quot;devpi-server==6.9.2&quot;</span> \</span></span><br><span class="line"><span class="language-bash">        <span class="string">&quot;devpi-web==4.1.0&quot;</span> \</span></span><br><span class="line"><span class="language-bash">        <span class="string">&quot;httpx==0.22.0&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæ•°æ®å·æŒ‚è½½ç‚¹</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> /var/lib/devpi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ã€æƒé™ä¿®å¤ã€‘</span></span><br><span class="line"><span class="comment"># å°†æ•°æ®ç›®å½•çš„æ‰€æœ‰è€…æ›´æ”¹ä¸ºé root ç”¨æˆ· (UID 1000)</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chown</span> -R 1000:1000 /var/lib/devpi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ã€å®‰å…¨å®è·µã€‘</span></span><br><span class="line"><span class="comment"># å°†å®¹å™¨çš„é»˜è®¤è¿è¡Œç”¨æˆ·åˆ‡æ¢ä¸ºé root ç”¨æˆ·</span></span><br><span class="line"><span class="keyword">USER</span> <span class="number">1000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å£°æ˜å®¹å™¨å°†è¦ç›‘å¬çš„ç«¯å£</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">7104</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰å®¹å™¨å¯åŠ¨æ—¶è¦æ‰§è¡Œçš„é»˜è®¤å‘½ä»¤</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;devpi-server&quot;</span>, <span class="string">&quot;--serverdir&quot;</span>, <span class="string">&quot;/var/lib/devpi&quot;</span>, <span class="string">&quot;--host&quot;</span>, <span class="string">&quot;0.0.0.0&quot;</span>, <span class="string">&quot;--port&quot;</span>, <span class="string">&quot;7104&quot;</span>]</span></span><br></pre></td></tr></table></figure><ul><li>docker-compose.yml</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.yml (æœ€ç»ˆã€å†³å®šæ€§ç‰ˆæœ¬)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">nginx-proxy:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">devpi-nginx-proxy</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">http_proxy=http://192.168.12.80:7890</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https_proxy=http://192.168.12.80:7890</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">HTTP_PROXY=http://192.168.12.80:7890</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">HTTPS_PROXY=http://192.168.12.80:7890</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx_conf/nginx.conf:/etc/nginx/nginx.conf:ro</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">devpi-lib:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">devpi-lib</span></span><br><span class="line">    <span class="comment"># --- ã€æ ¸å¿ƒä¿®æ”¹ã€‘---</span></span><br><span class="line">    <span class="comment"># ä¸å†ä½¿ç”¨æ—§çš„ imageï¼Œè€Œæ˜¯ä½¿ç”¨ build æŒ‡ä»¤</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span>  <span class="comment"># è¡¨ç¤ºä½¿ç”¨å½“å‰ç›®å½•ä¸‹çš„ Dockerfile æ¥æ„å»ºé•œåƒ</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;7104:7104&quot;</span></span><br><span class="line">    <span class="comment"># ã€é‡è¦ã€‘æˆ‘ä»¬ä¸å†éœ€è¦æ—§é•œåƒçš„ç¯å¢ƒå˜é‡æ¥è‡ªåŠ¨åŒ–é…ç½®</span></span><br><span class="line">    <span class="comment"># æˆ‘ä»¬å°†åœ¨å¯åŠ¨åï¼Œæ‰‹åŠ¨è¿›è¡Œä¸€æ¬¡æ€§é…ç½®ï¼Œè¿™æ›´å¯é </span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">http_proxy=http://192.168.12.80:7890</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https_proxy=http://192.168.12.80:7890</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">HTTP_PROXY=http://192.168.12.80:7890</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">HTTPS_PROXY=http://192.168.12.80:7890</span></span><br><span class="line">        <span class="comment"># environment:</span></span><br><span class="line">    <span class="comment">#   - ... (å¯ä»¥å…¨éƒ¨åˆ é™¤)</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="comment"># æ•°æ®å·ä¾ç„¶éœ€è¦ï¼Œç”¨äºæŒä¹…åŒ– devpi çš„æ•°æ®</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./volume:/var/lib/devpi</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nginx-proxy</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li><ol><li><strong>åœ¨ä½ çš„å®¢æˆ·ç«¯ç”µè„‘ä¸Šï¼Œå®‰è£… <code>devpi-client</code></strong>:</li></ol>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> -R czq2:czq2 ./volume <span class="comment"># æ›´æ”¹ç›®å½•æƒé™</span></span><br><span class="line">pip install devpi-client</span><br></pre></td></tr></table></figure></li><li><ol start="2"><li><strong>ç™»å½•åˆ°ä½ çš„æ–° <code>devpi</code> æœåŠ¡å™¨</strong>:</li></ol>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŒ‡å‘æœåŠ¡å™¨</span></span><br><span class="line">devpi use http://&lt;ä½ çš„æœåŠ¡å™¨IP&gt;:7104</span><br><span class="line"></span><br><span class="line"><span class="comment"># é¦–æ¬¡ç™»å½• root ç”¨æˆ·ï¼Œdevpi-server ä¼šè‡ªåŠ¨åˆ›å»ºï¼Œæ— éœ€å¯†ç </span></span><br><span class="line"><span class="comment"># ç„¶åä¼šå¼ºåˆ¶ä½ è®¾ç½®æ–°å¯†ç </span></span><br><span class="line">devpi login root --password=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># (æŒ‰ç…§æç¤ºè¾“å…¥ä½ çš„æ–° root å¯†ç )</span></span><br></pre></td></tr></table></figure></li><li><ol start="3"><li><strong>ã€å…³é”®ã€‘é…ç½® <code>root/pypi</code> é•œåƒ</strong>:<br>é»˜è®¤çš„ <code>root/pypi</code> æŒ‡å‘ <code>pypi.org</code>ã€‚æˆ‘ä»¬éœ€è¦å°†å®ƒä¿®æ”¹ä¸ºæŒ‡å‘æˆ‘ä»¬å†…éƒ¨çš„ <code>nginx-proxy</code>ã€‚</li></ol>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¡®ä¿ä½ å·²ç™»å½• root</span></span><br><span class="line">devpi index root/pypi mirror_url=http://nginx-proxy</span><br></pre></td></tr></table></figure><ul><li><strong>æ³¨æ„</strong>: è¿™é‡Œçš„ <code>http://nginx-proxy</code> æ˜¯ <code>devpi-lib</code> å®¹å™¨å†…éƒ¨è®¿é—® <code>nginx-proxy</code> å®¹å™¨çš„åœ°å€ã€‚<code>devpi-server</code> åœ¨æ”¶åˆ°è¿™ä¸ªé…ç½®åï¼Œå®ƒå†…éƒ¨å‘èµ·çš„è¯·æ±‚å°±ä¼šèµ°è¿™æ¡è·¯ã€‚</li></ul></li><li><ol start="4"><li><strong>éªŒè¯</strong>:<br>åœ¨ä½ çš„å®¢æˆ·ç«¯ç”µè„‘ä¸Šï¼Œé…ç½®å¥½ <code>pip</code> æŒ‡å‘ <code>http://&lt;æœåŠ¡å™¨IP&gt;:7104/root/pypi/</code>ï¼Œç„¶åæ‰§è¡Œ <code>pip install numpy</code>ã€‚</li></ol></li></ul><h3 id="æˆåŠŸæ—¥å¿—">æˆåŠŸæ—¥å¿—</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">(.venv) czq2@czq2:~/pypi-docker$ sudo docker logs devpi-lib</span><br><span class="line">2025-09-22 02:56:36,728 INFO  [req12] POST /+login</span><br><span class="line">2025-09-22 02:57:08,329 INFO  [req13] GET /root/pypi</span><br><span class="line">2025-09-22 02:57:08,339 INFO  [req14] PATCH /root/pypi</span><br><span class="line">2025-09-22 02:57:08,342 INFO  [req14] [Wtx13] modified index root/pypi: &#123;&#x27;type&#x27;: &#x27;mirror&#x27;, &#x27;volatile&#x27;: False, &#x27;title&#x27;: &#x27;PyPI&#x27;, &#x27;mirror_url&#x27;: &#x27;http://mirrors.aliyun.com/pypi/simple/&#x27;, &#x27;mirror_web_url_fmt&#x27;: &#x27;https://pypi.org/project/&#123;name&#125;/&#x27;&#125;</span><br><span class="line">2025-09-22 02:57:08,345 INFO  [req14] [Wtx13] fswriter14: committed at 14</span><br><span class="line">2025-09-22 02:57:08,351 INFO  [req15] GET /root/pypi</span><br><span class="line">2025-09-22 02:57:25,788 INFO  [req16] GET /root/pypi/opencv-python/</span><br><span class="line">2025-09-22 02:57:40,843 INFO  [req17] GET /root/pypi/opencv-python/</span><br><span class="line">2025-09-22 02:57:41,058 INFO  [req18] GET /root</span><br><span class="line">2025-09-22 02:57:41,533 INFO  [req19] GET /+static-4.1.0/favicon.ico</span><br><span class="line">2025-09-22 02:57:43,732 INFO  [Wtx14] fswriter15: committed at 15</span><br><span class="line">2025-09-22 02:57:43,885 INFO  [NOTI] [Rtx15] indexing &#x27;root/pypi&#x27; mirror with 658356 projects</span><br><span class="line">2025-09-22 02:57:44,305 INFO  [IDX] Indexer queue size ~ 2</span><br><span class="line">2025-09-22 02:57:46,680 INFO  [req20] GET /root</span><br><span class="line">2025-09-22 02:57:47,303 INFO  [IDX] Committing 2500 new documents to search index.</span><br><span class="line">2025-09-22 02:57:47,410 INFO  [req21] GET /root/pypi</span><br><span class="line">2025-09-22 02:57:48,180 INFO  [req22] GET /root/pypi/+simple/</span><br><span class="line">2025-09-22 02:57:48,183 INFO  [req22] starting +simple</span><br><span class="line">2025-09-22 02:57:52,640 INFO  [req23] GET /root/pypi/+simple/</span><br><span class="line">2025-09-22 02:57:52,643 INFO  [req23] starting +simple</span><br><span class="line">2025-09-22 02:58:00,856 INFO  [IDX] Indexer queue size ~ 23</span><br><span class="line">2025-09-22 02:58:03,872 INFO  [IDX] Committing 2500 new documents to search index.</span><br><span class="line">2025-09-22 02:58:13,593 INFO  [IDX] Indexer queue size ~ 43</span><br><span class="line">2025-09-22 02:58:16,637 INFO  [IDX] Committing 2500 new documents to search index.</span><br><span class="line">2025-09-22 02:58:24,550 INFO  [IDX] Indexer queue size ~ 63</span><br><span class="line">2025-09-22 02:58:27,063 INFO  [req24] GET /root/dev/+simple/</span><br><span class="line">2025-09-22 02:58:27,068 INFO  [req24] starting +simple</span><br><span class="line">2025-09-22 02:58:31,043 INFO  [IDX] Committing 2500 new documents to search index.</span><br><span class="line">2025-09-22 02:58:36,905 INFO  [IDX] Indexer queue size ~ 84</span><br><span class="line">2025-09-22 02:58:40,109 INFO  [IDX] Committing 2500 new documents to search index.</span><br><span class="line">2025-09-22 02:58:46,493 INFO  [IDX] Indexer queue size ~ 105</span><br><span class="line">2025-09-22 02:58:49,808 INFO  [IDX] Committing 2500 new documents to search index.</span><br><span class="line">2025-09-22 02:58:57,171 INFO  [req25] GET /root/pypi/opencv-python/</span><br><span class="line">2025-09-22 02:58:57,452 INFO  [req26] GET /root/pypi/+f/092/c16da4c5a163a/opencv_python-4.12.0.88-cp37-abi3-manylinux2014_x86_64.manylinux_2_17_x86_64.whl</span><br><span class="line">2025-09-22 02:58:57,703 INFO  [req26] [Rtx15] reading remote: URL(&#x27;http://mirrors.aliyun.com/pypi/packages/68/1f/795e7f4aa2eacc59afa4fb61a2e35e510d06414dd5a802b51a012d691b37/opencv_python-4.12.0.88-cp37-abi3-manylinux2014_x86_64.manylinux_2_17_x86_64.whl&#x27;), target root/pypi/+f/092/c16da4c5a163a/opencv_python-4.12.0.88-cp37-abi3-manylinux2014_x86_64.manylinux_2_17_x86_64.whl</span><br><span class="line">2025-09-22 02:58:58,698 INFO  [IDX] Indexer queue size ~ 125</span><br><span class="line">2025-09-22 02:59:02,452 INFO  [IDX] Committing 2500 new documents to search index.</span><br><span class="line">2025-09-22 02:59:13,134 INFO  [Wtx15] fswriter16: committed at 16</span><br><span class="line">2025-09-22 02:59:13,406 INFO  [req27] GET /root/pypi/numpy/</span><br><span class="line">2025-09-22 02:59:16,152 INFO  [IDX] Indexer queue size ~ 144</span><br><span class="line">2025-09-22 02:59:20,559 INFO  [IDX] Committing 2500 new documents to search index.</span><br><span class="line">2025-09-22 02:59:22,506 INFO  [Wtx16] fswriter17: committed at 17</span><br><span class="line">2025-09-22 02:59:22,974 INFO  [req28] GET /root/pypi/+f/fd8/3c01228a68873/numpy-2.2.6-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl</span><br><span class="line">2025-09-22 02:59:23,201 INFO  [req28] [Rtx17] reading remote: URL(&#x27;http://mirrors.aliyun.com/pypi/packages/8c/3d/1e1db36cfd41f895d266b103df00ca5b3cbe965184df824dec5c08c6b803/numpy-2.2.6-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl&#x27;), target root/pypi/+f/fd8/3c01228a68873/numpy-2.2.6-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl</span><br><span class="line">2025-09-22 02:59:25,317 INFO  [Wtx17] fswriter18: committed at 18</span><br><span class="line">2025-09-22 02:59:29,854 INFO  [IDX] Indexer queue size ~ 157</span><br><span class="line">2025-09-22 02:59:32,438 INFO  [req29] GET /czq/devpi</span><br><span class="line">2025-09-22 02:59:33,214 INFO  [req30] GET /czq/devpi/+simple/</span><br><span class="line">2025-09-22 02:59:33,219 INFO  [req30] starting +simple</span><br><span class="line">2025-09-22 02:59:33,222 WARNI [req30] [Rtx18] Index czq/devpi refers to non-existing base czq/pypi.</span><br><span class="line">2025-09-22 02:59:33,419 INFO  [IDX] Committing 2500 new documents to search index.</span><br><span class="line">2025-09-22 02:59:35,333 INFO  [req31] GET /root/dev</span><br><span class="line">2025-09-22 02:59:36,071 INFO  [req32] GET /root/dev/+simple/</span><br><span class="line">2025-09-22 02:59:36,073 INFO  [req32] starting +simple</span><br><span class="line">2025-09-22 02:59:45,543 INFO  [IDX] Indexer queue size ~ 183</span><br><span class="line">2025-09-22 02:59:49,092 INFO  [IDX] Committing 2500 new documents to search index.</span><br><span class="line">2025-09-22 02:59:59,191 INFO  [IDX] Indexer queue size ~ 204</span><br><span class="line">2025-09-22 02:59:59,375 INFO  [req33] GET /</span><br><span class="line">2025-09-22 03:00:02,409 INFO  [req34] GET /+search</span><br><span class="line">2025-09-22 03:00:03,190 INFO  [IDX] Committing 2500 new documents to search index.</span><br><span class="line">2025-09-22 03:00:12,782 INFO  [IDX] Indexer queue size ~ 223</span><br><span class="line">2025-09-22 03:00:16,424 INFO  [IDX] Committing 2500 new documents to search index.</span><br><span class="line">2025-09-22 03:00:22,925 INFO  [IDX] Indexer queue size ~ 243</span><br></pre></td></tr></table></figure><h2 id="python-æ­å»ºé«˜å¯ç”¨">python æ­å»ºé«˜å¯ç”¨</h2><ul><li>python flask</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ha_proxy.py</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, Response, request</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- é«˜å¯ç”¨é•œåƒæºåˆ—è¡¨ ---</span></span><br><span class="line"><span class="comment"># å°†æŒ‰ç…§è¿™ä¸ªé¡ºåºå°è¯•ã€‚å¯ä»¥éšæ„å¢åˆ æˆ–è°ƒæ•´é¡ºåºã€‚</span></span><br><span class="line">UPSTREAM_MIRRORS = [</span><br><span class="line">    <span class="string">&quot;https://pypi.tuna.tsinghua.edu.cn/simple&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://mirrors.aliyun.com/pypi/simple&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://pypi.mirrors.ustc.edu.cn/simple&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://mirrors.cloud.tencent.com/pypi/simple&quot;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿æ¥å’Œè¯»å–çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line">TIMEOUT = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&lt;path:path&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">proxy</span>(<span class="params">path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æ¥æ”¶æ¥è‡ª devpi-server çš„æ‰€æœ‰è¯·æ±‚ï¼Œå¹¶å°è¯•ä»ä¸Šæ¸¸é•œåƒåˆ—è¡¨ä¸­è·å–ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> base_url <span class="keyword">in</span> UPSTREAM_MIRRORS:</span><br><span class="line">        url = <span class="string">f&quot;<span class="subst">&#123;base_url&#125;</span>/<span class="subst">&#123;path&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;HA-PROXY: Attempting to fetch from <span class="subst">&#123;url&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># `requests` ä¼šè‡ªåŠ¨ä½¿ç”¨ HTTP_PROXY/HTTPS_PROXY ç¯å¢ƒå˜é‡</span></span><br><span class="line">            response = requests.get(url, timeout=TIMEOUT, stream=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># å¦‚æœè¯·æ±‚æˆåŠŸ (ä¾‹å¦‚ 200 OK)</span></span><br><span class="line">            <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;HA-PROXY: Success from <span class="subst">&#123;url&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="comment"># ä½¿ç”¨æµå¼å“åº”ï¼Œé¿å…å¤§æ–‡ä»¶å ç”¨è¿‡å¤šå†…å­˜</span></span><br><span class="line">                <span class="keyword">return</span> Response(response.iter_content(chunk_size=<span class="number">8192</span>),</span><br><span class="line">                                status=response.status_code,</span><br><span class="line">                                content_type=response.headers[<span class="string">&#x27;Content-Type&#x27;</span>])</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># å¦‚æœæ˜¯ 404ï¼Œè¯´æ˜è¿™ä¸ªæºæ²¡æœ‰è¿™ä¸ªåŒ…ï¼Œç«‹å³å°è¯•ä¸‹ä¸€ä¸ª</span></span><br><span class="line">            <span class="keyword">elif</span> response.status_code == <span class="number">404</span>:</span><br><span class="line">                 <span class="built_in">print</span>(<span class="string">f&quot;HA-PROXY: Got 404 from <span class="subst">&#123;url&#125;</span>, trying next mirror.&quot;</span>)</span><br><span class="line">                 <span class="keyword">continue</span> <span class="comment"># ç»§ç»­ä¸‹ä¸€ä¸ªå¾ªç¯</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># å…¶ä»–å®¢æˆ·ç«¯é”™è¯¯ï¼Œä¹Ÿå°è¯•ä¸‹ä¸€ä¸ª</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;HA-PROXY: Got client error <span class="subst">&#123;response.status_code&#125;</span> from <span class="subst">&#123;url&#125;</span>, trying next mirror.&quot;</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> requests.exceptions.RequestException <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># æ•è·æ‰€æœ‰ç½‘ç»œå±‚é¢çš„é”™è¯¯ (å¦‚è¶…æ—¶ã€è¿æ¥å¤±è´¥)</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;HA-PROXY: Failed to connect to <span class="subst">&#123;base_url&#125;</span>. Error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span> <span class="comment"># ç»§ç»­ä¸‹ä¸€ä¸ªå¾ªç¯</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¦‚æœæ‰€æœ‰é•œåƒæºéƒ½å°è¯•å¤±è´¥</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;HA-PROXY: All upstream mirrors failed for path: <span class="subst">&#123;path&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> Response(<span class="string">&quot;All upstream mirrors failed.&quot;</span>, status=<span class="number">502</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># ç›‘å¬åœ¨ 8000 ç«¯å£ï¼Œåªæ¥å—æ¥è‡ªå®¹å™¨å†…éƒ¨çš„è¿æ¥</span></span><br><span class="line">    app.run(host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure><ul><li>supervisord.conf</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">; supervisord.conf (æœ€ç»ˆç”Ÿäº§ç‰ˆ)</span><br><span class="line"></span><br><span class="line">[supervisord]</span><br><span class="line">nodaemon=true</span><br><span class="line"></span><br><span class="line">[program:devpi]</span><br><span class="line">command=devpi-server --serverdir /var/lib/devpi --host 0.0.0.0 --port 7104</span><br><span class="line">user=devpiuser ; &lt;--- ä¿®æ”¹è¿™é‡Œ</span><br><span class="line">autostart=true</span><br><span class="line">autorestart=true</span><br><span class="line">stderr_logfile=/var/log/supervisor/devpi_err.log</span><br><span class="line">stdout_logfile=/var/log/supervisor/devpi_out.log</span><br><span class="line"></span><br><span class="line">[program:ha_proxy]</span><br><span class="line">command=python3 /app/ha_proxy.py</span><br><span class="line">user=devpiuser ; &lt;--- ä¿®æ”¹è¿™é‡Œ</span><br><span class="line">autostart=true</span><br><span class="line">autorestart=true</span><br><span class="line">stderr_logfile=/var/log/supervisor/ha_proxy_err.log</span><br><span class="line">stdout_logfile=/var/log/supervisor/ha_proxy_out.log</span><br></pre></td></tr></table></figure><h3 id="åŒæ­¥æ›´æ–°dockerfileå’Œdocker-compose-yml">åŒæ­¥æ›´æ–°dockerfileå’Œdocker-compose.yml</h3><ul><li>Dockerfile</li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dockerfile (æœ€ç»ˆç”Ÿäº§ç‰ˆ)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.9</span>-slim</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&#x27;s/deb.debian.org/mirrors.aliyun.com/g&#x27;</span> /etc/apt/sources.list.d/debian.sources</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip config <span class="built_in">set</span> global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- ã€å…³é”®ä¿®å¤ã€‘åˆ›å»ºä¸€ä¸ªä¸“ç”¨çš„é root ç”¨æˆ· ---</span></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªåä¸º devpiuser çš„ç³»ç»Ÿç»„å’Œç”¨æˆ·ï¼Œå¹¶æŒ‡å®šå…¶ ID ä¸º 1000</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> adduser \</span></span><br><span class="line"><span class="language-bash">    --system \</span></span><br><span class="line"><span class="language-bash">    --group \</span></span><br><span class="line"><span class="language-bash">    --uid 1000 \</span></span><br><span class="line"><span class="language-bash">    --no-create-home \</span></span><br><span class="line"><span class="language-bash">    --disabled-password \</span></span><br><span class="line"><span class="language-bash">    devpiuser</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- å®‰è£…æ‰€æœ‰ä¾èµ– ---</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y supervisor &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    pip install --no-cache-dir --upgrade pip &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    pip install --no-cache-dir \</span></span><br><span class="line"><span class="language-bash">        <span class="string">&quot;devpi-server==6.9.2&quot;</span> \</span></span><br><span class="line"><span class="language-bash">        <span class="string">&quot;devpi-web==4.1.0&quot;</span> \</span></span><br><span class="line"><span class="language-bash">        <span class="string">&quot;httpx==0.22.0&quot;</span> \</span></span><br><span class="line"><span class="language-bash">        <span class="string">&quot;flask&quot;</span> \</span></span><br><span class="line"><span class="language-bash">        <span class="string">&quot;requests&quot;</span> &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- å¤åˆ¶é…ç½®æ–‡ä»¶å’Œè„šæœ¬ ---</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> supervisord.conf /etc/supervisor/conf.d/supervisord.conf</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ha_proxy.py /app/ha_proxy.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- æƒé™ä¿®å¤ ---</span></span><br><span class="line"><span class="comment"># ä½¿ç”¨æ–°åˆ›å»ºçš„ç”¨æˆ·å devpiuser æ¥è®¾ç½®æƒé™</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> -p /var/log/supervisor</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> /var/lib/devpi</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chown</span> -R devpiuser:devpiuser /var/lib/devpi</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chown</span> -R devpiuser:devpiuser /var/log/supervisor</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®¹å™¨å°†ä»¥ root å¯åŠ¨ï¼Œç”± supervisor è´Ÿè´£é™æƒ</span></span><br><span class="line"><span class="comment"># USER devpiuser (è¿™é‡Œä¸éœ€è¦ï¼Œsupervisor ä¼šå¤„ç†)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">7104</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/usr/bin/supervisord&quot;</span>]</span></span><br></pre></td></tr></table></figure><ul><li>docker-compose.yml</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.yml (ä¸æœ€ç»ˆé«˜å¯ç”¨ç‰ˆ Dockerfile é…åˆä½¿ç”¨)</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.7&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">devpi-lib:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">devpi-lib</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;7104:7104&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">devpi-data:/var/lib/devpi</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="comment"># ä»£ç†é…ç½®ä¾ç„¶éœ€è¦ï¼Œha_proxy.py ä¼šä½¿ç”¨å®ƒ</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">http_proxy=http://192.168.12.80:7890</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https_proxy=http://192.168.12.80:7890</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">HTTP_PROXY=http://192.168.12.80:7890</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">HTTPS_PROXY=http://192.168.12.80:7890</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">devpi-data:</span></span><br></pre></td></tr></table></figure><ul><li>docker build</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> docker-compose up -d --build --force-recreate</span><br></pre></td></tr></table></figure><ul><li>mirror set</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">devpi login root --password=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># å°† mirror_url æŒ‡å‘æˆ‘ä»¬å†…éƒ¨çš„ HA ä»£ç†æœåŠ¡</span></span><br><span class="line">devpi index root/pypi mirror_url=http://127.0.0.1:8000/</span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure><h2 id="See">See</h2><ul><li><ol><li><a href="https://github.com/devpi/devpi">https://github.com/devpi/devpi</a></li></ol></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨ Docker Compose å¿«é€Ÿéƒ¨ç½² Shadowsocks ä»£ç†æœåŠ¡æ•™ç¨‹</title>
      <link href="/2025/08/29/ss-build-doc/"/>
      <url>/2025/08/29/ss-build-doc/</url>
      
        <content type="html"><![CDATA[<h2 id="åŸºç¡€ç¯å¢ƒ">åŸºç¡€ç¯å¢ƒ</h2><h4 id="1-1-æ›´æ–°ç³»ç»Ÿè½¯ä»¶åŒ…åˆ—è¡¨">1.1 æ›´æ–°ç³»ç»Ÿè½¯ä»¶åŒ…åˆ—è¡¨</h4><p>é¦–å…ˆï¼Œè¿æ¥åˆ°æ‚¨çš„æœåŠ¡å™¨ï¼Œç„¶åè¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥æ›´æ–°ç³»ç»Ÿçš„è½¯ä»¶åŒ…ç´¢å¼•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get update -y</span><br></pre></td></tr></table></figure><p>d</p><h4 id="1-2-å®‰è£…-Docker-çš„ä¾èµ–é¡¹">1.2 å®‰è£… Docker çš„ä¾èµ–é¡¹</h4><p>æ¥ä¸‹æ¥ï¼Œå®‰è£…ä¸€äº›å¿…è¦çš„è½¯ä»¶åŒ…ï¼Œä»¥å…è®¸ <code>apt</code> é€šè¿‡ HTTPS ä½¿ç”¨ Docker çš„è½¯ä»¶ä»“åº“ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install -y \</span><br><span class="line">    apt-transport-https \</span><br><span class="line">    ca-certificates \</span><br><span class="line">    curl \</span><br><span class="line">    software-properties-common</span><br></pre></td></tr></table></figure><h4 id="1-3-æ·»åŠ -Docker-å®˜æ–¹-GPG-å¯†é’¥">1.3 æ·»åŠ  Docker å®˜æ–¹ GPG å¯†é’¥</h4><p>ä¸ºäº†å®‰å…¨èµ·è§ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ  Docker çš„å®˜æ–¹ GPG å¯†é’¥ã€‚è¿™ä¼šéªŒè¯æˆ‘ä»¬ä¸‹è½½çš„ Docker è½¯ä»¶åŒ…æ˜¯å®˜æ–¹å‘å¸ƒçš„ï¼Œæœªç»ç¯¡æ”¹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºç”¨äºå­˜æ”¾å¯†é’¥çš„ç›®å½•</span></span><br><span class="line"><span class="built_in">sudo</span> install -m 0755 -d /etc/apt/keyrings</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½ Docker çš„ GPG å¯†é’¥</span></span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | <span class="built_in">sudo</span> gpg --dearmor -o /etc/apt/keyrings/docker.gpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹å¯†é’¥æ–‡ä»¶çš„æƒé™</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> a+r /etc/apt/keyrings/docker.gpg</span><br></pre></td></tr></table></figure><h4 id="1-4-è®¾ç½®-Docker-çš„-APT-è½¯ä»¶æº">1.4 è®¾ç½® Docker çš„ APT è½¯ä»¶æº</h4><p>ç°åœ¨ï¼Œæˆ‘ä»¬å°† Docker çš„å®˜æ–¹è½¯ä»¶æºåœ°å€æ·»åŠ åˆ°æˆ‘ä»¬ç³»ç»Ÿçš„æºåˆ—è¡¨ä¸­ã€‚è¿™æ ·ï¼Œ<code>apt</code> å‘½ä»¤å°±èƒ½æ‰¾åˆ°å¹¶å®‰è£… Docker äº†ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> \</span><br><span class="line">  <span class="string">&quot;deb [arch=<span class="subst">$(dpkg --print-architecture)</span> signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">  <span class="subst">$(. /etc/os-release &amp;&amp; echo <span class="string">&quot;<span class="variable">$VERSION_CODENAME</span>&quot;</span>)</span> stable&quot;</span> | \</span><br><span class="line">  <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null```</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 1.5 å®‰è£… Docker å¼•æ“å’Œ Compose V2</span></span><br><span class="line"></span><br><span class="line">å†æ¬¡æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨ï¼Œä»¥åŒ…å«æ¥è‡ª Docker å®˜æ–¹æºçš„è½¯ä»¶åŒ…ä¿¡æ¯ï¼Œç„¶åæ‰§è¡Œå®‰è£…ï¼š</span><br><span class="line"></span><br><span class="line">```bash</span><br><span class="line"><span class="comment"># å†æ¬¡æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get update -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… Docker å¼•æ“, å‘½ä»¤è¡Œå·¥å…·, containerd å’Œ Docker Compose V2 æ’ä»¶</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin</span><br></pre></td></tr></table></figure><h4 id="1-6-å¯é€‰ä½†æ¨è-é…ç½®é-root-ç”¨æˆ·è¿è¡Œ-Docker">1.6 (å¯é€‰ä½†æ¨è) é…ç½®é root ç”¨æˆ·è¿è¡Œ Docker</h4><p>æ¯æ¬¡éƒ½è¾“å…¥ <code>sudo</code> æ¥è¿è¡Œ Docker å‘½ä»¤å¾ˆéº»çƒ¦ã€‚æˆ‘ä»¬å¯ä»¥å°†å½“å‰ç”¨æˆ·æ·»åŠ åˆ° <code>docker</code> ç”¨æˆ·ç»„ï¼Œä»è€Œå…å» <code>sudo</code>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†æ‚¨çš„ç”¨æˆ·ï¼ˆ$USER æ˜¯ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œä»£è¡¨å½“å‰ç”¨æˆ·ï¼‰æ·»åŠ åˆ° docker ç»„</span></span><br><span class="line"><span class="built_in">sudo</span> usermod -aG docker <span class="variable">$USER</span></span><br></pre></td></tr></table></figure><p><strong>é‡è¦æç¤ºï¼š</strong> æ‰§è¡Œæ­¤å‘½ä»¤åï¼Œæ‚¨éœ€è¦<strong>å®Œå…¨é€€å‡º SSH ä¼šè¯å¹¶é‡æ–°ç™»å½•</strong>ï¼Œæ‰èƒ½ä½¿æƒé™æ›´æ”¹ç”Ÿæ•ˆï¼</p><hr><h3 id="ç¬¬äºŒæ­¥ï¼šé…ç½®å¹¶éƒ¨ç½²-Shadowsocks-æœåŠ¡">ç¬¬äºŒæ­¥ï¼šé…ç½®å¹¶éƒ¨ç½² Shadowsocks æœåŠ¡</h3><p>ç¯å¢ƒå‡†å¤‡å¥½åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹å®šä¹‰å’Œéƒ¨ç½²æˆ‘ä»¬çš„ Shadowsocks æœåŠ¡äº†ã€‚</p><h4 id="2-1-åˆ›å»ºä¸€ä¸ªå·¥ä½œç›®å½•">2.1 åˆ›å»ºä¸€ä¸ªå·¥ä½œç›®å½•</h4><p>ä¸ºæˆ‘ä»¬çš„é¡¹ç›®åˆ›å»ºä¸€ä¸ªä¸“é—¨çš„ç›®å½•ï¼Œè¿™æ ·å¯ä»¥ä¿æŒæ•´æ´ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªåä¸º ss çš„ç›®å½•å¹¶è¿›å…¥</span></span><br><span class="line"><span class="built_in">mkdir</span> ~/ss</span><br><span class="line"><span class="built_in">cd</span> ~/ss</span><br></pre></td></tr></table></figure><h4 id="2-2-ç¼–å†™-docker-compose-yml-é…ç½®æ–‡ä»¶">2.2 ç¼–å†™ <code>docker-compose.yml</code> é…ç½®æ–‡ä»¶</h4><p>è¿™æ˜¯æ•´ä¸ªéƒ¨ç½²çš„æ ¸å¿ƒã€‚æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªåä¸º <code>docker-compose.yml</code> çš„æ–‡ä»¶ï¼Œå®ƒåƒä¸€ä»½è“å›¾ï¼Œè¯¦ç»†æè¿°äº†æˆ‘ä»¬çš„æœåŠ¡åº”è¯¥å¦‚ä½•è¿è¡Œã€‚</p><p>ä½¿ç”¨æ‚¨å–œæ¬¢çš„æ–‡æœ¬ç¼–è¾‘å™¨ï¼ˆè¿™é‡Œä»¥ <code>nano</code> ä¸ºä¾‹ï¼Œå®ƒæ¯” <code>vim</code> æ›´æ˜“ä¸Šæ‰‹ï¼‰åˆ›å»ºæ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim docker-compose.yml</span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œå°†ä»¥ä¸‹å†…å®¹<strong>å¤åˆ¶å¹¶ç²˜è´´</strong>åˆ°ç¼–è¾‘å™¨ä¸­ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ Compose æ–‡ä»¶æ ¼å¼çš„ç‰ˆæœ¬ 3</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰æ‰€æœ‰æœåŠ¡</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="comment"># å®šä¹‰ä¸€ä¸ªåä¸º &quot;shadowsocks&quot; çš„æœåŠ¡</span></span><br><span class="line">  <span class="attr">shadowsocks:</span></span><br><span class="line">    <span class="comment"># æŒ‡å®šè¦ä½¿ç”¨çš„ Docker é•œåƒï¼Œæˆ‘ä»¬ä½¿ç”¨å®˜æ–¹çš„ shadowsocks-libev</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">shadowsocks/shadowsocks-libev</span></span><br><span class="line">    <span class="comment"># ç»™è¿è¡Œçš„å®¹å™¨èµ·ä¸€ä¸ªå›ºå®šçš„åå­—ï¼Œæ–¹ä¾¿æˆ‘ä»¬ç®¡ç†</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">shadowsocks</span></span><br><span class="line">    <span class="comment"># è®¾ç½®ç«¯å£æ˜ å°„ (æ ¼å¼: &quot;ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£&quot;)</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="comment"># å°†æœåŠ¡å™¨çš„ TCP 8388 ç«¯å£æ˜ å°„åˆ°å®¹å™¨çš„ TCP 8388 ç«¯å£</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8388:8388/tcp&quot;</span></span><br><span class="line">      <span class="comment"># å°†æœåŠ¡å™¨çš„ UDP 8388 ç«¯å£ä¹Ÿæ˜ å°„å‡ºå» (ç”¨äºæ¸¸æˆã€è§†é¢‘é€šè¯ç­‰)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8388:8388/udp&quot;</span></span><br><span class="line">    <span class="comment"># è®¾ç½®å®¹å™¨çš„é‡å¯ç­–ç•¥</span></span><br><span class="line">    <span class="comment"># unless-stopped: é™¤éæˆ‘ä»¬æ‰‹åŠ¨åœæ­¢å®¹å™¨ï¼Œå¦åˆ™å®ƒæ€»æ˜¯åœ¨é€€å‡ºåè‡ªåŠ¨é‡å¯</span></span><br><span class="line">    <span class="comment"># (åŒ…æ‹¬æœåŠ¡å™¨é‡å¯åï¼ŒæœåŠ¡ä¹Ÿä¼šè‡ªåŠ¨æ‹‰èµ·ï¼Œéå¸¸çœå¿ƒ)</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="comment"># è®¾ç½®å®¹å™¨å†…çš„ç¯å¢ƒå˜é‡ï¼Œç”¨äºé…ç½® Shadowsocks</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="comment"># è®¾ç½®åŠ å¯†æ–¹æ³•ï¼Œchacha20-ietf-poly1305 æ˜¯ç›®å‰æ¨èçš„å®‰å…¨ä¸”é«˜æ•ˆçš„ç®—æ³•</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">METHOD=chacha20-ietf-poly1305</span></span><br><span class="line">      <span class="comment"># åœ¨è¿™é‡Œè®¾ç½®æ‚¨çš„è¿æ¥å¯†ç ï¼è¯·åŠ¡å¿…æ›¿æ¢æˆä¸€ä¸ªæ‚¨è‡ªå·±çš„å¼ºå¯†ç ï¼</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PASSWORD=YOUR_STRONG_PASSWORD_HERE</span></span><br></pre></td></tr></table></figure><p><strong>é‡è¦é…ç½®ä¿®æ”¹ï¼š</strong></p><ul><li><strong><code>PASSWORD</code></strong>: å°† <code>YOUR_STRONG_PASSWORD_HERE</code> <strong>æ›¿æ¢ä¸ºæ‚¨è‡ªå·±è®¾å®šçš„ä¸€ä¸ªå¼ºå¯†ç </strong>ã€‚è¿™æ˜¯æ‚¨çš„å®¢æˆ·ç«¯è¿æ¥æ—¶éœ€è¦ç”¨åˆ°çš„å‡­è¯ã€‚</li><li><strong><code>ports</code></strong>: å¦‚æœæ‚¨æœåŠ¡å™¨çš„ <code>8388</code> ç«¯å£å·²è¢«å…¶ä»–æœåŠ¡å ç”¨ï¼Œæ‚¨å¯ä»¥ä¿®æ”¹ä¸»æœºç«¯å£ã€‚ä¾‹å¦‚ï¼Œæ”¹æˆ <code>&quot;10086:8388/tcp&quot;</code>ï¼Œè¿™æ ·æ‚¨çš„å®¢æˆ·ç«¯å°±éœ€è¦è¿æ¥æœåŠ¡å™¨çš„ <code>10086</code> ç«¯å£ã€‚</li></ul><p>ä¿®æ”¹å®Œæˆåï¼Œåœ¨ <code>nano</code> ç¼–è¾‘å™¨ä¸­ï¼ŒæŒ‰ <code>Ctrl + X</code>ï¼Œç„¶åæŒ‰ <code>Y</code>ï¼Œæœ€åæŒ‰ <code>Enter</code> ä¿å­˜å¹¶é€€å‡ºã€‚</p><h4 id="2-3-å¯åŠ¨-Shadowsocks-æœåŠ¡">2.3 å¯åŠ¨ Shadowsocks æœåŠ¡</h4><p>ç°åœ¨ï¼Œæ¿€åŠ¨äººå¿ƒçš„æ—¶åˆ»åˆ°äº†ï¼åœ¨ <code>docker-compose.yml</code> æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ï¼ˆå³ <code>~/ss</code>ï¼‰ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ³¨æ„ï¼šå¦‚æœæ‚¨åœ¨ 1.6 æ­¥ä¸­é…ç½®äº†ç”¨æˆ·ç»„ï¼Œè¿™é‡Œå°±ä¸éœ€è¦ sudo äº†</span></span><br><span class="line"><span class="comment"># æ–°ç‰ˆå‘½ä»¤ (æ¨è)</span></span><br><span class="line">docker compose up -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ—§ç‰ˆå‘½ä»¤ (ä¹Ÿèƒ½å·¥ä½œ)</span></span><br><span class="line"><span class="comment"># docker-compose up -d</span></span><br></pre></td></tr></table></figure><ul><li><code>up</code>: å‘Šè¯‰ Docker Compose å¯åŠ¨å¹¶è¿è¡ŒæœåŠ¡ã€‚</li><li><code>-d</code>: (<code>--detach</code>) å‚æ•°è¡¨ç¤ºåœ¨åå°è¿è¡ŒæœåŠ¡ã€‚è¿™æ˜¯å¿…é¡»çš„ï¼Œå¦åˆ™å½“æ‚¨å…³é—­ SSH çª—å£æ—¶ï¼ŒæœåŠ¡ä¹Ÿä¼šåœæ­¢ã€‚</li></ul><p>Docker Compose ç°åœ¨ä¼šè‡ªåŠ¨ï¼š</p><ol><li>æ£€æŸ¥ <code>docker-compose.yml</code> æ–‡ä»¶ã€‚</li><li>ä» Docker Hub ä¸Šæ‹‰å– <code>shadowsocks/shadowsocks-libev</code> é•œåƒï¼ˆå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œï¼‰ã€‚</li><li>æ ¹æ®æ‚¨çš„é…ç½®åˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªåä¸º <code>shadowsocks</code> çš„å®¹å™¨ã€‚</li></ol><hr><h3 id="ç¬¬ä¸‰æ­¥ï¼šéªŒè¯æœåŠ¡ä¸å®¢æˆ·ç«¯é…ç½®">ç¬¬ä¸‰æ­¥ï¼šéªŒè¯æœåŠ¡ä¸å®¢æˆ·ç«¯é…ç½®</h3><blockquote><p>æœåŠ¡å¯åŠ¨åï¼Œæˆ‘ä»¬éœ€è¦ç¡®è®¤å®ƒæ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œå¹¶é…ç½®å®¢æˆ·ç«¯è¿›è¡Œè¿æ¥ã€‚</p></blockquote><h4 id="3-1-æ£€æŸ¥å®¹å™¨è¿è¡ŒçŠ¶æ€">3.1 æ£€æŸ¥å®¹å™¨è¿è¡ŒçŠ¶æ€</h4><p>è¿è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å½“å‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></table></figure><p>æ‚¨åº”è¯¥èƒ½çœ‹åˆ°ç±»ä¼¼ä¸‹é¢çš„è¾“å‡ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CONTAINER ID   IMAGE                           COMMAND                  CREATED         STATUS         PORTS                                                 NAMES</span><br><span class="line">a1b2c3d4e5f6   shadowsocks/shadowsocks-libev   &quot;/usr/bin/ss-server â€¦&quot;   30 seconds ago   Up 29 seconds   0.0.0.0:8388-&gt;8388/tcp, 0.0.0.0:8388-&gt;8388/udp   shadowsocks</span><br></pre></td></tr></table></figure><p>è¯·å…³æ³¨ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li><strong><code>IMAGE</code></strong>: ç¡®è®¤æ˜¯ <code>shadowsocks/shadowsocks-libev</code>ã€‚</li><li><strong><code>STATUS</code></strong>: å¿…é¡»æ˜¯ <code>Up ...</code>ï¼Œè¡¨ç¤ºæ­£åœ¨å¥åº·è¿è¡Œã€‚å¦‚æœæ˜¯ <code>Exited</code>ï¼Œè¯´æ˜å¯åŠ¨å¤±è´¥ã€‚</li><li><strong><code>PORTS</code></strong>: ç¡®è®¤ç«¯å£æ˜ å°„æ­£ç¡®ã€‚</li><li><strong><code>NAMES</code></strong>: ç¡®è®¤æ˜¯ <code>shadowsocks</code>ã€‚</li></ul><h4 id="3-2-æŸ¥çœ‹æœåŠ¡æ—¥å¿—">3.2 æŸ¥çœ‹æœåŠ¡æ—¥å¿—</h4><p>å¦‚æœå®¹å™¨å¯åŠ¨å¤±è´¥ï¼Œæˆ–è€…æ‚¨æƒ³ç¡®è®¤æœåŠ¡çš„å†…éƒ¨è¿è¡Œæƒ…å†µï¼ŒæŸ¥çœ‹æ—¥å¿—æ˜¯æœ€ä½³æ–¹å¼ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs shadowsocks</span><br></pre></td></tr></table></figure><p>æˆåŠŸçš„æ—¥å¿—ä¼šæ˜¾ç¤ºæœåŠ¡æ­£åœ¨ç›‘å¬ç«¯å£ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INFO: initializing ciphers... chacha20-ietf-poly1305</span><br><span class="line">INFO: listening at 0.0.0.0:8388</span><br></pre></td></tr></table></figure><h4 id="3-3-é…ç½®æ‚¨çš„å®¢æˆ·ç«¯">3.3 é…ç½®æ‚¨çš„å®¢æˆ·ç«¯</h4><p>ç°åœ¨ï¼Œæ‚¨å¯ä»¥åœ¨æ‚¨çš„ç”µè„‘æˆ–æ‰‹æœºä¸Šé…ç½® Shadowsocks å®¢æˆ·ç«¯äº†ã€‚å¡«å…¥ä»¥ä¸‹ä¿¡æ¯ï¼š</p><ul><li><strong>æœåŠ¡å™¨åœ°å€ (Server Address)</strong>: <code>æ‚¨æœåŠ¡å™¨çš„å…¬ç½‘ IP åœ°å€</code></li><li><strong>æœåŠ¡å™¨ç«¯å£ (Server Port)</strong>: <code>8388</code> (æˆ–è€…æ‚¨åœ¨ <code>docker-compose.yml</code> ä¸­è®¾ç½®çš„ä¸»æœºç«¯å£)</li><li><strong>å¯†ç  (Password)</strong>: <code>æ‚¨åœ¨ docker-compose.yml ä¸­è®¾ç½®çš„å¯†ç </code></li><li><strong>åŠ å¯†æ–¹æ³• (Encryption/Method)</strong>: <code>chacha20-ietf-poly1305</code></li></ul><p>ä¿å­˜é…ç½®å¹¶è¿æ¥ï¼Œç°åœ¨æ‚¨åº”è¯¥å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ï¼</p><hr><h3 id="ç¬¬å››æ­¥ï¼šå¸¸ç”¨ç®¡ç†å‘½ä»¤">ç¬¬å››æ­¥ï¼šå¸¸ç”¨ç®¡ç†å‘½ä»¤</h3><ul><li><strong>åœæ­¢æœåŠ¡</strong>:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨ ~/ss ç›®å½•ä¸‹è¿è¡Œ</span></span><br><span class="line">docker compose down</span><br></pre></td></tr></table></figure></li><li><strong>é‡å¯æœåŠ¡</strong>:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨ ~/ss ç›®å½•ä¸‹è¿è¡Œ</span></span><br><span class="line">docker compose restart</span><br></pre></td></tr></table></figure></li><li><strong>æ›´æ–°æœåŠ¡ (ä¾‹å¦‚æ›´æ–° Shadowsocks é•œåƒ)</strong>:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨ ~/ss ç›®å½•ä¸‹è¿è¡Œ</span></span><br><span class="line"><span class="comment"># 1. æ‹‰å–æœ€æ–°çš„é•œåƒ</span></span><br><span class="line">docker compose pull</span><br><span class="line"><span class="comment"># 2. é‡æ–°åˆ›å»ºå¹¶å¯åŠ¨å®¹å™¨</span></span><br><span class="line">docker compose up -d</span><br></pre></td></tr></table></figure></li></ul><h2 id="å®¢æˆ·ç«¯">å®¢æˆ·ç«¯</h2><ul><li>windows</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/shadowsocks/shadowsocks-windows</span><br></pre></td></tr></table></figure><ul><li>android</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/shadowsocks/shadowsocks-android</span><br></pre></td></tr></table></figure><h2 id="ä»£ç†æ¨¡å¼">ä»£ç†æ¨¡å¼</h2><ul><li><p>ç¦ç”¨ (Disabled)ï¼šä¸ä½¿ç”¨ä»£ç†ã€‚ç­‰åŒäºå–æ¶ˆå‹¾é€‰â€œå¯ç”¨ç³»ç»Ÿä»£ç†â€ã€‚</p></li><li><p>PAC æ¨¡å¼ (PAC)ï¼šæ¨èæ—¥å¸¸ä½¿ç”¨ã€‚æ­¤æ¨¡å¼ä¸‹ï¼Œå®¢æˆ·ç«¯ä¼šæ ¹æ®ä¸€ä¸ªåä¸º PAC (Proxy Auto-Config) çš„è§„åˆ™åˆ—è¡¨æ¥åˆ¤æ–­ã€‚</p></li><li><p>å…¨å±€æ¨¡å¼ (Global)ï¼šæ‰€æœ‰ç½‘ç»œæµé‡éƒ½å¼ºåˆ¶é€šè¿‡ä»£ç†æœåŠ¡å™¨ã€‚</p></li></ul><h2 id="See">See</h2><ul><li><a href="https://github.com/shadowsocks/shadowsocks-rust">https://github.com/shadowsocks/shadowsocks-rust</a></li><li><a href="https://github.com/shadowsocks/shadowsocks-windows">https://github.com/shadowsocks/shadowsocks-windows</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PyAVç”¨äºè§†é¢‘å‰ªè¾‘å¤„ç†</title>
      <link href="/2025/08/14/pyav-use-video/"/>
      <url>/2025/08/14/pyav-use-video/</url>
      
        <content type="html"><![CDATA[<h1>PyAVç”¨äºè§†é¢‘å‰ªè¾‘å¤„ç†</h1><blockquote><p>PyAVæ˜¯FFmpegåº“çš„Pythonicç»‘å®šã€‚å®ƒå…è®¸ä½ ç›´æ¥åœ¨Pythonä»£ç ä¸­ï¼Œä»¥ä¸€ç§æå…¶ç²¾ç»†å’Œé«˜æ•ˆçš„æ–¹å¼è®¿é—®FFmpegçš„å†…éƒ¨åŠŸèƒ½ã€‚è¿™æ„å‘³ç€ï¼š</p></blockquote><ul><li><strong>å†…å­˜æ“ä½œ</strong>ï¼šç›´æ¥åœ¨å†…å­˜ä¸­å¤„ç†è§†é¢‘å¸§å’ŒéŸ³é¢‘æ ·æœ¬ï¼Œæ— éœ€åˆ›å»ºå¤§é‡ä¸´æ—¶æ–‡ä»¶ã€‚</li><li><strong>ç²¾ç»†æ§åˆ¶</strong>ï¼šä½ å¯ä»¥å®Œå…¨æ§åˆ¶å®¹å™¨çš„è§£å¤ç”¨ã€æ•°æ®åŒ…çš„è§£ç ã€å¸§çš„å¤„ç†å’Œç¼–ç çš„æ¯ä¸€ä¸ªç¯èŠ‚ã€‚</li><li><strong>ç¡¬ä»¶åŠ é€Ÿ</strong>ï¼šå¯ä»¥åˆ©ç”¨GPUï¼ˆå¦‚macOSçš„VideoToolbox, Linux/Windowsçš„CUDA/NVENCï¼‰æ¥æå¤§åœ°åŠ é€Ÿè§£ç å’Œç¼–ç è¿‡ç¨‹ã€‚</li><li><strong>é«˜åº¦é›†æˆ</strong>ï¼šå¯ä»¥æ— ç¼åœ°å°†è§†é¢‘å¸§ä¸NumPyã€Pillowç­‰æµè¡Œçš„Pythonåº“ç»“åˆä½¿ç”¨ã€‚</li></ul><h3 id="PyAVçš„æ ¸å¿ƒæ¦‚å¿µ">PyAVçš„æ ¸å¿ƒæ¦‚å¿µ</h3><blockquote><p>åœ¨æ·±å…¥ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œå®ƒä»¬ç›´æ¥æ˜ å°„è‡ªFFmpegï¼š</p></blockquote><ol><li><strong>å®¹å™¨ (Container)</strong>: æŒ‡çš„æ˜¯è§†é¢‘æ–‡ä»¶æœ¬èº«ï¼Œæ¯”å¦‚ä¸€ä¸ª<code>.mp4</code>æˆ–<code>.mkv</code>æ–‡ä»¶ã€‚å®ƒæ˜¯ä¸€ä¸ªâ€œå®¹å™¨â€ï¼Œé‡Œé¢è£…ç€å„ç§æ•°æ®æµã€‚</li><li><strong>æµ (Stream)</strong>: æŒ‡çš„æ˜¯å®¹å™¨å†…çš„æ•°æ®è½¨é“ã€‚ä¸€ä¸ªè§†é¢‘æ–‡ä»¶é€šå¸¸è‡³å°‘åŒ…å«ä¸€ä¸ªè§†é¢‘æµå’Œä¸€ä¸ªéŸ³é¢‘æµï¼Œæœ‰æ—¶è¿˜ä¼šæœ‰å­—å¹•æµã€‚</li><li><strong>æ•°æ®åŒ… (Packet)</strong>: ä»æµä¸­è¯»å–çš„ä¸€å°å—<strong>å‹ç¼©å</strong>çš„æ•°æ®ã€‚</li><li><strong>å¸§ (Frame)</strong>: ä¸€ä¸ªæ•°æ®åŒ…ç»è¿‡<strong>è§£ç å</strong>å¾—åˆ°çš„æ•°æ®ã€‚å¯¹äºè§†é¢‘æµï¼Œå®ƒæ˜¯ä¸€å¼ å›¾ç‰‡ï¼›å¯¹äºéŸ³é¢‘æµï¼Œå®ƒæ˜¯ä¸€æ®µå£°éŸ³æ ·æœ¬ã€‚</li></ol><blockquote><p>æ ‡å‡†çš„å¤„ç†æµç¨‹æ˜¯ï¼š<strong>æ‰“å¼€å®¹å™¨ â†’ æ‰¾åˆ°éœ€è¦çš„æµ â†’ ä»æµä¸­è§£å¤ç”¨(demux)æ•°æ®åŒ… â†’ è§£ç (decode)æ•°æ®åŒ…å¾—åˆ°å¸§ â†’ (å¤„ç†å¸§) â†’ ç¼–ç (encode)å¤„ç†åçš„å¸§å˜å›æ•°æ®åŒ… â†’ å°†æ•°æ®åŒ…æ··åˆ(mux)åˆ°æ–°çš„è¾“å‡ºå®¹å™¨ â†’ å…³é—­å®¹å™¨</strong>ã€‚</p></blockquote><h2 id="ç®€å•å®‰è£…">ç®€å•å®‰è£…</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install av</span><br><span class="line">conda install av -c conda-forge</span><br></pre></td></tr></table></figure><h3 id="åŠŸèƒ½">åŠŸèƒ½</h3><ul><li><p>libavformat: containers, audio/video/subtitle streams, packets;</p></li><li><p>libavdevice (by specifying a format to containers);</p></li><li><p>libavcodec: Codec, CodecContext, BitStreamFilterContext, audio/video frames, data planes, subtitles;</p></li><li><p>libavfilter: Filter, Graph;</p></li><li><p>libswscale: VideoReformatter;</p></li><li><p>libswresample: AudioResampler;</p></li></ul><h3 id="simple-demo">simple demo</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> av</span><br><span class="line"></span><br><span class="line">av.logging.set_level(av.logging.VERBOSE)</span><br><span class="line">container = av.<span class="built_in">open</span>(path_to_video)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> index, frame <span class="keyword">in</span> <span class="built_in">enumerate</span>(container.decode(video=<span class="number">0</span>)):</span><br><span class="line">    frame.to_image().save(<span class="string">f&quot;frame-<span class="subst">&#123;index:04d&#125;</span>.jpg&quot;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --- è°ƒåº¦å™¨å‡½æ•° ---</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">crop_video_pyav</span>(<span class="params">input_video_path, output_video_path, ...</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æ ¹æ®ç¯å¢ƒè‡ªåŠ¨é€‰æ‹©æœ€ä½³æ–¹å¼è£å‰ªè§†é¢‘ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># æ£€æŸ¥ç¡¬ä»¶åŠ é€Ÿæ˜¯å¦å—æ”¯æŒ</span></span><br><span class="line">    <span class="keyword">if</span> HW_ACCEL_SUPPORTED:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># ä¼˜å…ˆå°è¯•ç¡¬ä»¶åŠ é€Ÿ</span></span><br><span class="line">            logger.info(<span class="string">&quot;æ£€æµ‹åˆ°ç¡¬ä»¶åŠ é€Ÿæ”¯æŒï¼Œå°è¯• Metal è·¯å¾„...&quot;</span>)</span><br><span class="line">            success = _crop_video_pyav_metal(...)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> success:</span><br><span class="line">                <span class="comment"># å¦‚æœç¡¬ä»¶è·¯å¾„æ˜ç¡®è¿”å›å¤±è´¥ï¼Œåˆ™é™çº§</span></span><br><span class="line">                logger.warning(<span class="string">&quot;ç¡¬ä»¶åŠ é€Ÿè·¯å¾„æ‰§è¡Œå¤±è´¥ï¼Œè‡ªåŠ¨é™çº§åˆ°çº¯è½¯ä»¶æ¨¡å¼ã€‚&quot;</span>)</span><br><span class="line">                success = _crop_video_software(...)</span><br><span class="line">            <span class="keyword">return</span> success</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># å¦‚æœç¡¬ä»¶è·¯å¾„æ„å¤–å´©æºƒï¼Œåˆ™é™çº§</span></span><br><span class="line">            logger.error(<span class="string">f&quot;ç¡¬ä»¶åŠ é€Ÿè·¯å¾„æ‰§è¡Œæ—¶å‘ç”Ÿæ„å¤–å¼‚å¸¸: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            logger.warning(<span class="string">&quot;è‡ªåŠ¨é™çº§åˆ°çº¯è½¯ä»¶æ¨¡å¼ã€‚&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> _crop_video_software(...)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># ä¸æ”¯æŒç¡¬ä»¶åŠ é€Ÿï¼Œç›´æ¥èµ°è½¯ä»¶è·¯å¾„</span></span><br><span class="line">        logger.info(<span class="string">&quot;æœªæ£€æµ‹åˆ°ç¡¬ä»¶åŠ é€Ÿæ”¯æŒï¼Œä½¿ç”¨çº¯è½¯ä»¶è·¯å¾„ã€‚&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> _crop_video_software(...)</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ·±å…¥åˆ†æè¿™ä¸¤ç§æ ¸å¿ƒå®ç°ã€‚</p><h3 id="Part-1-å¥å£®çš„åŸºçŸ³-â€”â€”-çº¯è½¯ä»¶-CPU-å®ç°">Part 1: å¥å£®çš„åŸºçŸ³ â€”â€” çº¯è½¯ä»¶ (CPU) å®ç°</h3><p>è¿™æ˜¯æˆ‘ä»¬åå¤‡æ–¹æ¡ˆçš„æ ¸å¿ƒï¼Œä¹Ÿæ˜¯ç†è§£PyAVåŸºç¡€æ“ä½œçš„æœ€ä½³å…¥å£ã€‚å®ƒä¸ä¾èµ–ä»»ä½•ç‰¹æ®Šçš„ç¡¬ä»¶ï¼Œå¯ä»¥åœ¨ä»»ä½•å¹³å°ä¸Šè¿è¡Œã€‚</p><h4 id="æ ¸å¿ƒæ­¥éª¤">æ ¸å¿ƒæ­¥éª¤</h4><ol><li><p><strong>å‚æ•°å‡†å¤‡</strong>:<br>æœ€å…³é”®çš„ä¸€æ­¥æ˜¯ç¡®ä¿è¾“å‡ºçš„åˆ†è¾¨ç‡æ°¸è¿œæ˜¯å¶æ•°ã€‚åƒ <code>libx264</code> è¿™æ ·çš„H.264ç¼–ç å™¨æ— æ³•å¤„ç†å®½åº¦æˆ–é«˜åº¦ä¸ºå¥‡æ•°çš„è§†é¢‘ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">final_w = w - (w % <span class="number">2</span>)</span><br><span class="line">final_h = h - (h % <span class="number">2</span>)</span><br></pre></td></tr></table></figure></li><li><p><strong>æ‰“å¼€è¾“å…¥/è¾“å‡ºå®¹å™¨</strong>:<br>ä½¿ç”¨ <code>av.open()</code>ï¼Œå°±åƒPythonå†…ç½®çš„ <code>open()</code> ä¸€æ ·ç®€å•ï¼Œä½†å®ƒå¯ä»¥åŒæ—¶ç”¨äºè¯»å’Œå†™ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> av.<span class="built_in">open</span>(input_video_path, mode=<span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> in_container:</span><br><span class="line">    <span class="keyword">with</span> av.<span class="built_in">open</span>(output_video_path, mode=<span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> out_container:</span><br><span class="line">        <span class="comment"># ...</span></span><br></pre></td></tr></table></figure></li><li><p><strong>åˆ›å»ºè¾“å‡ºæµ</strong>:<br>æœ€ç®€å•çš„æ–¹å¼æ˜¯ä»è¾“å…¥æµåˆ›å»ºæ¨¡æ¿ã€‚è¿™ä¼šè‡ªåŠ¨å¤åˆ¶ç¼–è§£ç å™¨ã€ç ç‡ç­‰å¤§éƒ¨åˆ†å‚æ•°ã€‚ç„¶åæˆ‘ä»¬å†æ‰‹åŠ¨è¦†ç›–éœ€è¦ä¿®æ”¹çš„å‚æ•°ï¼Œæ¯”å¦‚æ–°çš„å®½åº¦å’Œé«˜åº¦ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥æ‰¾æ‰€æœ‰è¾“å…¥æµ</span></span><br><span class="line">in_video_stream = in_container.streams.video[<span class="number">0</span>]</span><br><span class="line">in_audio_stream = in_container.streams.audio[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»æ¨¡æ¿åˆ›å»ºè¾“å‡ºæµ</span></span><br><span class="line">out_video_stream = out_container.add_stream_from_template(in_video_stream)</span><br><span class="line">out_audio_stream = out_container.add_stream_from_template(in_audio_stream)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¦†ç›–è§†é¢‘æµçš„å°ºå¯¸</span></span><br><span class="line">out_video_stream.width = final_w</span><br><span class="line">out_video_stream.height = final_h</span><br></pre></td></tr></table></figure></li><li><p><strong>æ ¸å¿ƒå¤„ç†å¾ªç¯</strong>:<br>è¿™æ˜¯æœ€ç²¾å½©çš„éƒ¨åˆ†ï¼Œå®Œç¾ä½“ç°äº†PyAVä¸Pillowçš„ç»“åˆã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> packet <span class="keyword">in</span> in_container.demux(streams_to_demux):</span><br><span class="line">    <span class="keyword">if</span> packet.stream.<span class="built_in">type</span> == <span class="string">&#x27;video&#x27;</span>:</span><br><span class="line">        <span class="keyword">for</span> frame <span class="keyword">in</span> packet.decode():</span><br><span class="line">            <span class="comment"># a. è§£ç å¸§å¹¶è½¬æ¢ä¸ºPillow Imageå¯¹è±¡</span></span><br><span class="line">            img = frame.to_image()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># b. ä½¿ç”¨Pillowçš„å¼ºå¤§åŠŸèƒ½è¿›è¡Œå›¾åƒå¤„ç†</span></span><br><span class="line">            cropped_img = img.crop((x, y, x + w, y + h))</span><br><span class="line">            <span class="keyword">if</span> needs_scaling:</span><br><span class="line">                cropped_img = cropped_img.resize((final_w, final_h))</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># c. å°†å¤„ç†åçš„Pillow Imageè½¬æ¢å›PyAVçš„VideoFrame</span></span><br><span class="line">            new_frame = av.VideoFrame.from_image(cropped_img)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># d. ç¼–ç æ–°å¸§å¹¶æ··åˆåˆ°è¾“å‡ºæ–‡ä»¶</span></span><br><span class="line">            <span class="keyword">for</span> out_packet <span class="keyword">in</span> out_video_stream.encode(new_frame):</span><br><span class="line">                out_container.mux(out_packet)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> packet.stream.<span class="built_in">type</span> == <span class="string">&#x27;audio&#x27;</span>:</span><br><span class="line">        <span class="comment"># éŸ³é¢‘ç›´é€šï¼šä¸è§£ç ï¼Œç›´æ¥å¤åˆ¶æ•°æ®åŒ…ï¼Œæ•ˆç‡æœ€é«˜</span></span><br><span class="line">        packet.stream = out_audio_stream</span><br><span class="line">        out_container.mux(packet)</span><br></pre></td></tr></table></figure></li><li><p><strong>å†²æ´— (Flush) ç¼–ç å™¨</strong>:<br>å¤„ç†å®Œæ‰€æœ‰å¸§åï¼Œç¼–ç å™¨çš„å†…éƒ¨å¯èƒ½è¿˜ç¼“å­˜ç€ä¸€äº›æ•°æ®ã€‚æˆ‘ä»¬é€šè¿‡å‘é€ä¸€ä¸ª <code>None</code> æ¥å‘Šè¯‰å®ƒç»“æŸç¼–ç ï¼Œå¹¶æ¸…ç©ºæ‰€æœ‰ç¼“å†²åŒºã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> out_packet <span class="keyword">in</span> out_video_stream.encode(<span class="literal">None</span>):</span><br><span class="line">    out_container.mux(out_packet)</span><br></pre></td></tr></table></figure></li></ol><h3 id="Part-2-æè‡´æ€§èƒ½-â€”â€”-Metalç¡¬ä»¶åŠ é€Ÿ-GPU-å®ç°">Part 2: æè‡´æ€§èƒ½ â€”â€” Metalç¡¬ä»¶åŠ é€Ÿ (GPU) å®ç°</h3><p>è¿™æ˜¯è„šæœ¬çš„â€œé«˜æ€§èƒ½æ¨¡å¼â€ï¼Œä¸“é—¨ä¸ºmacOSè®¾è®¡ã€‚å®ƒå°½å¯èƒ½åœ°å°†æ‰€æœ‰æ“ä½œéƒ½ç•™åœ¨GPUä¸Šï¼Œé¿å…äº†æ˜‚è´µçš„CPU&lt;-&gt;GPUæ•°æ®æ‹·è´ã€‚</p><h4 id="æ ¸å¿ƒæ­¥éª¤-2">æ ¸å¿ƒæ­¥éª¤</h4><ol><li><p><strong>åˆ›å»ºç¡¬ä»¶è®¾å¤‡ä¸Šä¸‹æ–‡</strong>:<br>è¿™æ˜¯å¼€å¯ç¡¬ä»¶åŠ é€Ÿçš„ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬å‘Šè¯‰PyAVæˆ‘ä»¬è¦ä½¿ç”¨è‹¹æœçš„ <code>videotoolbox</code> æ¡†æ¶ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hw_device = av.hwdevice.Device(<span class="string">&quot;videotoolbox&quot;</span>)</span><br></pre></td></tr></table></figure></li><li><p><strong>é…ç½®ç¡¬ä»¶è§£ç </strong>:<br>è¿™æ˜¯ç°ä»£PyAVä¸­é…ç½®ç¡¬ä»¶è§£ç çš„å…³é”®ã€‚æˆ‘ä»¬ä¸æ˜¯æ‰‹åŠ¨è®¾ç½®ä¸Šä¸‹æ–‡ï¼Œè€Œæ˜¯ä¸ºè¾“å…¥æµçš„ <code>codec_context</code> æä¾›ä¸€ä¸ª <code>get_format</code> å›è°ƒå‡½æ•°ã€‚å½“è§£ç å™¨å‡†å¤‡å¥½æ—¶ï¼Œå®ƒä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°å¹¶æä¾›ä¸€ä¸ªå®ƒæ”¯æŒçš„åƒç´ æ ¼å¼åˆ—è¡¨ã€‚æˆ‘ä»¬çš„å‡½æ•°åªéœ€ä»ä¸­é€‰æ‹© <code>'videotoolbox'</code> æ ¼å¼å³å¯ã€‚è¿™å‘Šè¯‰è§£ç å™¨ï¼šâ€œè¯·ç›´æ¥å°†å¸§è§£ç åˆ°GPUæ˜¾å­˜ä¸­ï¼Œä¸è¦ä¸‹è½½åˆ°CPUå†…å­˜ã€‚â€</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">hw_pix_fmt = <span class="string">&#x27;videotoolbox&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_hw_format</span>(<span class="params">formats</span>):</span><br><span class="line">    <span class="keyword">for</span> fmt <span class="keyword">in</span> formats:</span><br><span class="line">        <span class="keyword">if</span> fmt.name == hw_pix_fmt:</span><br><span class="line">            <span class="keyword">return</span> fmt</span><br><span class="line">    <span class="keyword">raise</span> av.EncoderNotFoundError(<span class="string">&quot;æœªæ‰¾åˆ° &#x27;videotoolbox&#x27; ç¡¬ä»¶æ ¼å¼ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">in_stream.codec_context.get_format = get_hw_format</span><br></pre></td></tr></table></figure></li><li><p><strong>æ„å»ºç¡¬ä»¶æ»¤é•œå›¾ (Filter Graph)</strong>:<br>è£å‰ªå’Œç¼©æ”¾æ˜¯é€šè¿‡FFmpegçš„æ»¤é•œç³»ç»Ÿå®Œæˆçš„ã€‚PyAVå…è®¸æˆ‘ä»¬ç”¨ä»£ç æ„å»ºè¿™ä¸ªå¤„ç†é“¾ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">graph = av.<span class="built_in">filter</span>.Graph()</span><br><span class="line">buffer_src = graph.add_buffer(template=in_stream) <span class="comment"># è¾“å…¥æº</span></span><br><span class="line">buffer_sink = graph.add(<span class="string">&quot;buffersink&quot;</span>) <span class="comment"># è¾“å‡ºæ±‡</span></span><br><span class="line"></span><br><span class="line">filter_chain = <span class="string">f&quot;crop=<span class="subst">&#123;...&#125;</span>,scale=<span class="subst">&#123;...&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é“¾æ¥ï¼šæº -&gt; æ»¤é•œé“¾ -&gt; æ±‡</span></span><br><span class="line">filters = graph.add_filter(filter_chain, <span class="string">&quot;filters&quot;</span>)</span><br><span class="line">buffer_src.link_to(filters)</span><br><span class="line">filters.link_to(buffer_sink)</span><br><span class="line"></span><br><span class="line">graph.configure()</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ€å·§å¦™çš„æ˜¯ï¼Œå³ä½¿ <code>crop</code> å’Œ <code>scale</code> æ»¤é•œæ˜¯çº¯CPUæ“ä½œï¼ŒFFmpegä¹Ÿä¼šåœ¨åå°<strong>è‡ªåŠ¨</strong>å¤„ç†ç¡¬ä»¶å¸§çš„ä¸‹è½½ï¼ˆGPU-&gt;CPUï¼‰ã€åº”ç”¨æ»¤é•œã€å†ä¸Šä¼ ï¼ˆCPU-&gt;GPUï¼‰çš„è¿‡ç¨‹ã€‚</p></li><li><p><strong>é…ç½®ç¡¬ä»¶ç¼–ç </strong>:<br>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä½¿ç”¨ <code>h264_videotoolbox</code> ç¼–ç å™¨çš„è¾“å‡ºæµã€‚å®ƒä¼šè‡ªåŠ¨æ¥æ”¶æ¥è‡ªæ»¤é•œå›¾çš„ã€å·²ç»å¤„ç†å¥½çš„å¸§ï¼ˆè¿™äº›å¸§å¯èƒ½åœ¨CPUä¸Šï¼Œä¹Ÿå¯èƒ½åœ¨GPUä¸Šï¼Œç¼–ç å™¨ä¼šè‡ªåŠ¨å¤„ç†ï¼‰ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">out_stream = out_container.add_stream(<span class="string">&quot;h264_videotoolbox&quot;</span>, rate=rate)</span><br><span class="line">out_stream.width = final_w</span><br><span class="line">out_stream.height = final_h</span><br><span class="line">out_stream.pix_fmt = <span class="string">&quot;nv12&quot;</span> <span class="comment"># VideoToolbox ç¼–ç å™¨åå¥½çš„åƒç´ æ ¼å¼</span></span><br></pre></td></tr></table></figure></li><li><p><strong>ç¡¬ä»¶å¤„ç†å¾ªç¯</strong>:<br>å¾ªç¯çš„ä¸»ä½“ç»“æ„ç±»ä¼¼ï¼Œä½†æ“ä½œå¯¹è±¡å˜æˆäº†æ»¤é•œå›¾ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> frame <span class="keyword">in</span> packet.decode(): <span class="comment"># è§£ç å‡ºçš„ frame æ˜¯ä¸€ä¸ªæŒ‡å‘GPUæ˜¾å­˜çš„ç¡¬ä»¶å¸§</span></span><br><span class="line">    graph.push(frame) <span class="comment"># å°†ç¡¬ä»¶å¸§æ¨å…¥æ»¤é•œå›¾å¤„ç†</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            filtered_frame = buffer_sink.pull() <span class="comment"># ä»æ»¤é•œå›¾æ‹‰å–å¤„ç†å¥½çš„å¸§</span></span><br><span class="line">            <span class="keyword">for</span> out_packet <span class="keyword">in</span> out_stream.encode(filtered_frame):</span><br><span class="line">                output_container.mux(out_packet)</span><br><span class="line">        <span class="keyword">except</span> (av.error.EOFError, av.error.BlockingIOError):</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="å®é™…å¤„ç†">å®é™…å¤„ç†</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥å½“å‰ PyAV ç¯å¢ƒæ˜¯å¦æ”¯æŒç¡¬ä»¶åŠ é€Ÿ</span></span><br><span class="line">HW_ACCEL_SUPPORTED = <span class="built_in">hasattr</span>(av, <span class="string">&#x27;hwdevice&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> HW_ACCEL_SUPPORTED:</span><br><span class="line">    <span class="comment"># è¿›ä¸€æ­¥æ£€æŸ¥å¹³å°æ˜¯å¦ä¸º macOS</span></span><br><span class="line">    <span class="keyword">if</span> platform.system() == <span class="string">&#x27;Darwin&#x27;</span>:</span><br><span class="line">        logger.info(<span class="string">&quot;ç¡¬ä»¶åŠ é€Ÿ (VideoToolbox) å¯ç”¨ã€‚å°†ä¼˜å…ˆä½¿ç”¨ Metal è·¯å¾„ã€‚&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        HW_ACCEL_SUPPORTED = <span class="literal">False</span></span><br><span class="line">        logger.warning(<span class="string">&quot;PyAV æ”¯æŒç¡¬ä»¶åŠ é€Ÿï¼Œä½†å½“å‰ç³»ç»Ÿä¸æ˜¯ macOSã€‚VideoToolbox ä¸å¯ç”¨ã€‚&quot;</span>)</span><br><span class="line">        logger.warning(<span class="string">&quot;æ‰€æœ‰è§†é¢‘å¤„ç†å°†å›é€€åˆ°çº¯è½¯ä»¶æ¨¡å¼ã€‚&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    logger.warning(<span class="string">&quot;å½“å‰ PyAV ç¯å¢ƒä¸­æœªæ‰¾åˆ°ç¡¬ä»¶åŠ é€Ÿæ¨¡å— (&#x27;av.hwdevice&#x27;)ã€‚&quot;</span>)</span><br><span class="line">    logger.warning(<span class="string">&quot;æ‰€æœ‰è§†é¢‘å¤„ç†å°†å›é€€åˆ°çº¯è½¯ä»¶æ¨¡å¼ï¼Œé€Ÿåº¦ä¼šè¾ƒæ…¢ã€‚&quot;</span>)</span><br><span class="line">    logger.warning(<span class="string">&quot;è¦è§£å†³æ­¤é—®é¢˜ï¼Œè¯·ç¡®ä¿æ‚¨çš„é¡¹ç›®è§£é‡Šå™¨é…ç½®æ­£ç¡®ï¼Œå¹¶ä½¿ç”¨äº†å®Œæ•´ç¼–è¯‘çš„ PyAV åº“ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 2. ä¸»è°ƒåº¦å™¨å‡½æ•° ---</span></span><br><span class="line"><span class="comment"># æ‚¨çš„å¤–éƒ¨ä»£ç åº”è¯¥åªè°ƒç”¨è¿™ä¸ªå‡½æ•°</span></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">crop_video_pyav</span>(<span class="params"></span></span><br><span class="line"><span class="params">        input_video_path: <span class="built_in">str</span>, output_video_path: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">        crop_x: <span class="built_in">float</span>, crop_y: <span class="built_in">float</span>, crop_w: <span class="built_in">float</span>, crop_h: <span class="built_in">float</span>,</span></span><br><span class="line"><span class="params">        log_queue=<span class="literal">None</span>,  <span class="comment"># log_queue å’Œå…¶ä»–å‚æ•°ä¿ç•™ä»¥å…¼å®¹æ‚¨çš„æ¥å£</span></span></span><br><span class="line"><span class="params">        min_short_side_output_px: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        assigned_gpu_id: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        **kwargs  <span class="comment"># æ•è·ä»»ä½•å…¶ä»–æœªä½¿ç”¨çš„å‚æ•°</span></span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æ ¹æ®ç¯å¢ƒè‡ªåŠ¨é€‰æ‹©æœ€ä½³æ–¹å¼è£å‰ªè§†é¢‘ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    å¦‚æœæ”¯æŒç¡¬ä»¶åŠ é€Ÿï¼Œåˆ™å°è¯•ä½¿ç”¨Metalè·¯å¾„ï¼›å¦åˆ™ï¼Œæˆ–Metalè·¯å¾„å¤±è´¥æ—¶ï¼Œ</span></span><br><span class="line"><span class="string">    è‡ªåŠ¨å›é€€åˆ°çº¯è½¯ä»¶è·¯å¾„ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    crop_params = &#123;</span><br><span class="line">        <span class="string">&#x27;x&#x27;</span>: crop_x, <span class="string">&#x27;y&#x27;</span>: crop_y, <span class="string">&#x27;w&#x27;</span>: crop_w, <span class="string">&#x27;h&#x27;</span>: crop_h</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> HW_ACCEL_SUPPORTED:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># ä¼˜å…ˆå°è¯•ç¡¬ä»¶åŠ é€Ÿè·¯å¾„</span></span><br><span class="line">            logger.info(<span class="string">f&quot;æ£€æµ‹åˆ°ç¡¬ä»¶åŠ é€Ÿæ”¯æŒï¼Œå°è¯• Metal è·¯å¾„...&quot;</span>)</span><br><span class="line">            success = _crop_video_pyav_metal(</span><br><span class="line">                input_video_path, output_video_path, crop_params,</span><br><span class="line">                min_short_side_output_px</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> success:</span><br><span class="line">                logger.warning(<span class="string">&quot;ç¡¬ä»¶åŠ é€Ÿè·¯å¾„æ‰§è¡Œå¤±è´¥ï¼Œè‡ªåŠ¨é™çº§åˆ°çº¯è½¯ä»¶æ¨¡å¼ã€‚&quot;</span>)</span><br><span class="line">                success = _crop_video_software(</span><br><span class="line">                    input_video_path, output_video_path, crop_params,</span><br><span class="line">                    min_short_side_output_px</span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">return</span> success</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.opt(exception=<span class="literal">True</span>).error(<span class="string">f&quot;ç¡¬ä»¶åŠ é€Ÿè·¯å¾„æ‰§è¡Œæ—¶å‘ç”Ÿæ„å¤–å¼‚å¸¸: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            logger.warning(<span class="string">&quot;è‡ªåŠ¨é™çº§åˆ°çº¯è½¯ä»¶æ¨¡å¼ã€‚&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> _crop_video_software(</span><br><span class="line">                input_video_path, output_video_path, crop_params,</span><br><span class="line">                min_short_side_output_px</span><br><span class="line">            )</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># å¦‚æœä¸€å¼€å§‹å°±ä¸æ”¯æŒç¡¬ä»¶åŠ é€Ÿï¼Œç›´æ¥èµ°è½¯ä»¶è·¯å¾„</span></span><br><span class="line">        logger.info(<span class="string">f&quot;æœªæ£€æµ‹åˆ°ç¡¬ä»¶åŠ é€Ÿæ”¯æŒï¼Œä½¿ç”¨çº¯è½¯ä»¶è·¯å¾„ã€‚&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> _crop_video_software(</span><br><span class="line">            input_video_path, output_video_path, crop_params,</span><br><span class="line">            min_short_side_output_px</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 3. ç¡¬ä»¶åŠ é€Ÿå®ç° (å†…éƒ¨å‡½æ•°) ---</span></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_crop_video_pyav_metal</span>(<span class="params"></span></span><br><span class="line"><span class="params">        input_video_path: <span class="built_in">str</span>, output_video_path: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">        crop_rect: <span class="type">Dict</span>,</span></span><br><span class="line"><span class="params">        min_short_side_output_px: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ä½¿ç”¨ PyAV å’Œ VideoToolbox (Metal) è¿›è¡Œç¡¬ä»¶åŠ é€Ÿçš„è§†é¢‘è£å‰ªã€‚</span></span><br><span class="line"><span class="string">    è¿™æ˜¯ä¸€ä¸ªå†…éƒ¨å‡½æ•°ï¼Œå‡è®¾ç¡¬ä»¶æ”¯æŒå·²ç¡®è®¤ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    logger.info(<span class="string">f&quot;Metalè·¯å¾„: å¼€å§‹å¤„ç† <span class="subst">&#123;os.path.basename(input_video_path)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å‚æ•°å‡†å¤‡</span></span><br><span class="line">    crop_w_f = <span class="built_in">int</span>(crop_rect[<span class="string">&#x27;w&#x27;</span>]) - (<span class="built_in">int</span>(crop_rect[<span class="string">&#x27;w&#x27;</span>]) % <span class="number">2</span>)</span><br><span class="line">    crop_h_f = <span class="built_in">int</span>(crop_rect[<span class="string">&#x27;h&#x27;</span>]) - (<span class="built_in">int</span>(crop_rect[<span class="string">&#x27;h&#x27;</span>]) % <span class="number">2</span>)</span><br><span class="line">    crop_x_f = <span class="built_in">int</span>(crop_rect[<span class="string">&#x27;x&#x27;</span>]) - (<span class="built_in">int</span>(crop_rect[<span class="string">&#x27;x&#x27;</span>]) % <span class="number">2</span>)</span><br><span class="line">    crop_y_f = <span class="built_in">int</span>(crop_rect[<span class="string">&#x27;y&#x27;</span>]) - (<span class="built_in">int</span>(crop_rect[<span class="string">&#x27;y&#x27;</span>]) % <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">if</span> crop_w_f &lt;= <span class="number">0</span> <span class="keyword">or</span> crop_h_f &lt;= <span class="number">0</span>: <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    final_w, final_h = crop_w_f, crop_h_f</span><br><span class="line">    needs_scaling = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> min_short_side_output_px <span class="keyword">and</span> <span class="built_in">min</span>(crop_w_f, crop_h_f) &lt; min_short_side_output_px:</span><br><span class="line">        needs_scaling = <span class="literal">True</span></span><br><span class="line">        scale_factor = min_short_side_output_px / <span class="built_in">min</span>(crop_w_f, crop_h_f)</span><br><span class="line">        final_w = math.ceil((crop_w_f * scale_factor) / <span class="number">2</span>) * <span class="number">2</span></span><br><span class="line">        final_h = math.ceil((crop_h_f * scale_factor) / <span class="number">2</span>) * <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    input_container = <span class="literal">None</span></span><br><span class="line">    output_container = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># --- ç¡¬ä»¶è®¾å¤‡ä¸å®¹å™¨ ---</span></span><br><span class="line">        logger.debug(<span class="string">&quot;Metalè·¯å¾„: åˆ›å»º VideoToolbox ä¸Šä¸‹æ–‡ã€‚&quot;</span>)</span><br><span class="line">        hw_device = av.hwdevice.Device(<span class="string">&quot;videotoolbox&quot;</span>)</span><br><span class="line"></span><br><span class="line">        input_container = av.<span class="built_in">open</span>(input_video_path, mode=<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">        output_container = av.<span class="built_in">open</span>(output_video_path, mode=<span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">        in_stream = input_container.streams.video[<span class="number">0</span>]</span><br><span class="line">        in_stream.thread_type = <span class="string">&quot;AUTO&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- é…ç½®ç¡¬ä»¶è§£ç  (ç°ä»£æ–¹å¼) ---</span></span><br><span class="line">        logger.debug(<span class="string">&quot;Metalè·¯å¾„: é…ç½®ç¡¬ä»¶è§£ç ã€‚&quot;</span>)</span><br><span class="line">        hw_pix_fmt = <span class="string">&#x27;videotoolbox&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">get_hw_format</span>(<span class="params">formats</span>):</span><br><span class="line">            <span class="keyword">for</span> fmt <span class="keyword">in</span> formats:</span><br><span class="line">                <span class="keyword">if</span> fmt.name == hw_pix_fmt:</span><br><span class="line">                    <span class="keyword">return</span> fmt</span><br><span class="line">            <span class="keyword">raise</span> av.EncoderNotFoundError(<span class="string">f&quot;æœªæ‰¾åˆ° &#x27;<span class="subst">&#123;hw_pix_fmt&#125;</span>&#x27; ç¡¬ä»¶æ ¼å¼ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">        in_stream.codec_context.get_format = get_hw_format</span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- é…ç½®æ»¤é•œå›¾ ---</span></span><br><span class="line">        <span class="comment"># FFmpeg ä¼šåœ¨åå°è‡ªåŠ¨æ’å…¥ hwupload/hwdownload æ»¤é•œ</span></span><br><span class="line">        logger.debug(<span class="string">&quot;Metalè·¯å¾„: é…ç½®æ»¤é•œå›¾ã€‚&quot;</span>)</span><br><span class="line">        graph = av.<span class="built_in">filter</span>.Graph()</span><br><span class="line">        buffer_src = graph.add_buffer(template=in_stream)</span><br><span class="line"></span><br><span class="line">        filter_chain = <span class="string">f&quot;crop=<span class="subst">&#123;crop_w_f&#125;</span>:<span class="subst">&#123;crop_h_f&#125;</span>:<span class="subst">&#123;crop_x_f&#125;</span>:<span class="subst">&#123;crop_y_f&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">if</span> needs_scaling:</span><br><span class="line">            filter_chain += <span class="string">f&quot;,scale=<span class="subst">&#123;final_w&#125;</span>:<span class="subst">&#123;final_h&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ»¤é•œå›¾çš„ç»ˆç‚¹æ˜¯ buffer_sink</span></span><br><span class="line">        buffer_sink = graph.add(<span class="string">&quot;buffersink&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># é“¾æ¥æ»¤é•œ</span></span><br><span class="line">        buffer_src.link_to(graph.add_filter(filter_chain, <span class="string">&quot;filters&quot;</span>))</span><br><span class="line">        graph.get_filter(<span class="string">&quot;filters&quot;</span>).link_to(buffer_sink)</span><br><span class="line"></span><br><span class="line">        graph.configure()</span><br><span class="line">        logger.info(<span class="string">f&quot;Metalè·¯å¾„: æ»¤é•œå›¾é…ç½®æˆåŠŸ: &#x27;<span class="subst">&#123;filter_chain&#125;</span>&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- é…ç½®ç¡¬ä»¶ç¼–ç  ---</span></span><br><span class="line">        logger.debug(<span class="string">&quot;Metalè·¯å¾„: é…ç½®ç¡¬ä»¶ç¼–ç ã€‚&quot;</span>)</span><br><span class="line">        rate = in_stream.base_rate <span class="keyword">or</span> in_stream.guessed_rate <span class="keyword">or</span> in_stream.average_rate</span><br><span class="line">        out_stream = output_container.add_stream(<span class="string">&quot;h264_videotoolbox&quot;</span>, rate=rate)</span><br><span class="line">        out_stream.width = final_w</span><br><span class="line">        out_stream.height = final_h</span><br><span class="line">        out_stream.pix_fmt = <span class="string">&quot;nv12&quot;</span>  <span class="comment"># VideoToolbox ç¼–ç å™¨é€šå¸¸ä½¿ç”¨ nv12</span></span><br><span class="line">        out_stream.time_base = in_stream.time_base</span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- éŸ³é¢‘æµå¤„ç† (ç›´é€š) ---</span></span><br><span class="line">        in_audio_stream = <span class="built_in">next</span>((s <span class="keyword">for</span> s <span class="keyword">in</span> input_container.streams <span class="keyword">if</span> s.<span class="built_in">type</span> == <span class="string">&#x27;audio&#x27;</span>), <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> in_audio_stream:</span><br><span class="line">            out_audio_stream = output_container.add_stream(<span class="string">&#x27;aac&#x27;</span>, template=in_audio_stream)</span><br><span class="line">            streams_to_demux = (in_stream, in_audio_stream)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            out_audio_stream = <span class="literal">None</span></span><br><span class="line">            streams_to_demux = in_stream</span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- æ ¸å¿ƒå¤„ç†å¾ªç¯ ---</span></span><br><span class="line">        <span class="keyword">for</span> packet <span class="keyword">in</span> input_container.demux(streams_to_demux):</span><br><span class="line">            <span class="keyword">if</span> packet.dts <span class="keyword">is</span> <span class="literal">None</span>: <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> packet.stream.<span class="built_in">type</span> == <span class="string">&#x27;video&#x27;</span>:</span><br><span class="line">                <span class="keyword">for</span> frame <span class="keyword">in</span> packet.decode():</span><br><span class="line">                    graph.push(frame)</span><br><span class="line">                    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                        <span class="keyword">try</span>:</span><br><span class="line">                            filtered_frame = buffer_sink.pull()</span><br><span class="line">                            <span class="keyword">for</span> out_packet <span class="keyword">in</span> out_stream.encode(filtered_frame):</span><br><span class="line">                                output_container.mux(out_packet)</span><br><span class="line">                        <span class="keyword">except</span> (av.error.EOFError, av.error.BlockingIOError):</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">elif</span> out_audio_stream <span class="keyword">and</span> packet.stream.<span class="built_in">type</span> == <span class="string">&#x27;audio&#x27;</span>:</span><br><span class="line">                packet.stream = out_audio_stream</span><br><span class="line">                output_container.mux(packet)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- å†²æ´—(Flush) ---</span></span><br><span class="line">        logger.debug(<span class="string">&quot;Metalè·¯å¾„: å†²æ´—æ»¤é•œå’Œç¼–ç å™¨ã€‚&quot;</span>)</span><br><span class="line">        graph.push(<span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                filtered_frame = buffer_sink.pull()</span><br><span class="line">                <span class="keyword">for</span> out_packet <span class="keyword">in</span> out_stream.encode(filtered_frame):</span><br><span class="line">                    output_container.mux(out_packet)</span><br><span class="line">            <span class="keyword">except</span> (av.error.EOFError, av.error.BlockingIOError):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> out_packet <span class="keyword">in</span> out_stream.encode(<span class="literal">None</span>):</span><br><span class="line">            output_container.mux(out_packet)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ­£å¸¸å…³é—­</span></span><br><span class="line">        output_container.close()</span><br><span class="line">        input_container.close()</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">f&quot;Metalè·¯å¾„: è§†é¢‘å¤„ç†æˆåŠŸ -&gt; <span class="subst">&#123;os.path.basename(output_video_path)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.opt(exception=<span class="literal">True</span>).error(<span class="string">f&quot;Metalè·¯å¾„å¤„ç†æ—¶å‘ç”Ÿè‡´å‘½é”™è¯¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># æ¸…ç†</span></span><br><span class="line">        <span class="keyword">if</span> output_container:</span><br><span class="line">            output_container.close()</span><br><span class="line">        <span class="keyword">if</span> input_container:</span><br><span class="line">            input_container.close()</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(output_video_path):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                os.remove(output_video_path)</span><br><span class="line">            <span class="keyword">except</span> OSError:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 4. çº¯è½¯ä»¶å¤‡ç”¨æ–¹æ¡ˆ (å†…éƒ¨å‡½æ•°) ---</span></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_crop_video_software</span>(<span class="params"></span></span><br><span class="line"><span class="params">        input_video_path: <span class="built_in">str</span>, output_video_path: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">        crop_rect: <span class="type">Dict</span>,</span></span><br><span class="line"><span class="params">        min_short_side_output_px: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ä½¿ç”¨çº¯è½¯ä»¶ (CPU) è¿›è¡Œè§†é¢‘è£å‰ªçš„å¤‡ç”¨æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="string">    è¿™ä¸ªæ–¹æ³•æ€»æ˜¯å¯ç”¨çš„ï¼Œä½†é€Ÿåº¦æ¯”ç¡¬ä»¶åŠ é€Ÿæ…¢ã€‚</span></span><br><span class="line"><span class="string">    å®ƒç¡®ä¿è¾“å‡ºå°ºå¯¸ä¸ºå¶æ•°ï¼Œä»¥å…¼å®¹H.264ç­‰ç¼–ç å™¨ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    logger.info(<span class="string">f&quot;è½¯ä»¶è·¯å¾„: å¼€å§‹å¤„ç† <span class="subst">&#123;os.path.basename(input_video_path)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    input_container = <span class="literal">None</span></span><br><span class="line">    output_container = <span class="literal">None</span></span><br><span class="line">    success = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># --- 1. å‚æ•°å‡†å¤‡ (å…³é”®ä¿®æ­£éƒ¨åˆ†) ---</span></span><br><span class="line">        x, y, w, h = <span class="built_in">int</span>(crop_rect[<span class="string">&#x27;x&#x27;</span>]), <span class="built_in">int</span>(crop_rect[<span class="string">&#x27;y&#x27;</span>]), <span class="built_in">int</span>(crop_rect[<span class="string">&#x27;w&#x27;</span>]), <span class="built_in">int</span>(crop_rect[<span class="string">&#x27;h&#x27;</span>])</span><br><span class="line">        <span class="keyword">if</span> w &lt;= <span class="number">0</span> <span class="keyword">or</span> h &lt;= <span class="number">0</span>:</span><br><span class="line">            logger.error(<span class="string">f&quot;è£å‰ªå°ºå¯¸æ— æ•ˆ (w=<span class="subst">&#123;w&#125;</span>, h=<span class="subst">&#123;h&#125;</span>)ã€‚&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># åˆå§‹çš„æœ€ç»ˆå°ºå¯¸å°±æ˜¯è£å‰ªåçš„å°ºå¯¸</span></span><br><span class="line">        final_w, final_h = w, h</span><br><span class="line">        needs_scaling = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ£€æŸ¥æ˜¯å¦éœ€è¦ç¼©æ”¾</span></span><br><span class="line">        <span class="keyword">if</span> min_short_side_output_px <span class="keyword">and</span> <span class="built_in">min</span>(w, h) &lt; min_short_side_output_px:</span><br><span class="line">            needs_scaling = <span class="literal">True</span></span><br><span class="line">            scale_factor = min_short_side_output_px / <span class="built_in">min</span>(w, h)</span><br><span class="line">            final_w = <span class="built_in">int</span>(w * scale_factor)</span><br><span class="line">            final_h = <span class="built_in">int</span>(h * scale_factor)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># *** æ ¸å¿ƒä¿®æ­£ï¼šç¡®ä¿æœ€ç»ˆçš„è¾“å‡ºå°ºå¯¸æ°¸è¿œæ˜¯å¶æ•° ***</span></span><br><span class="line">        <span class="comment"># è¿™å¯¹äº H.264 (libx264) å’Œè®¸å¤šå…¶ä»–ç¼–ç å™¨è‡³å…³é‡è¦</span></span><br><span class="line">        final_w = final_w - (final_w % <span class="number">2</span>)</span><br><span class="line">        final_h = final_h - (final_h % <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> final_w &lt;= <span class="number">0</span> <span class="keyword">or</span> final_h &lt;= <span class="number">0</span>:</span><br><span class="line">            logger.error(<span class="string">f&quot;è®¡ç®—åçš„è¾“å‡ºå°ºå¯¸æ— æ•ˆ (<span class="subst">&#123;final_w&#125;</span>x<span class="subst">&#123;final_h&#125;</span>)ã€‚&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- 2. æ‰“å¼€å®¹å™¨å¹¶è®¾ç½®æµ ---</span></span><br><span class="line">        <span class="keyword">with</span> av.<span class="built_in">open</span>(input_video_path, mode=<span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> in_container:</span><br><span class="line">            <span class="keyword">with</span> av.<span class="built_in">open</span>(output_video_path, mode=<span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> out_container:</span><br><span class="line"></span><br><span class="line">                <span class="comment"># a. æŸ¥æ‰¾æ‰€æœ‰è¾“å…¥æµ</span></span><br><span class="line">                in_video_stream = <span class="built_in">next</span>((s <span class="keyword">for</span> s <span class="keyword">in</span> in_container.streams <span class="keyword">if</span> s.<span class="built_in">type</span> == <span class="string">&#x27;video&#x27;</span>), <span class="literal">None</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> in_video_stream:</span><br><span class="line">                    logger.error(<span class="string">&quot;è¾“å…¥æ–‡ä»¶ä¸­æœªæ‰¾åˆ°è§†é¢‘æµã€‚&quot;</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">                in_video_stream.thread_type = <span class="string">&quot;AUTO&quot;</span></span><br><span class="line"></span><br><span class="line">                in_audio_stream = <span class="built_in">next</span>((s <span class="keyword">for</span> s <span class="keyword">in</span> in_container.streams <span class="keyword">if</span> s.<span class="built_in">type</span> == <span class="string">&#x27;audio&#x27;</span>), <span class="literal">None</span>)</span><br><span class="line">                in_subtitle_stream = <span class="built_in">next</span>((s <span class="keyword">for</span> s <span class="keyword">in</span> in_container.streams <span class="keyword">if</span> s.<span class="built_in">type</span> == <span class="string">&#x27;subtitle&#x27;</span>), <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># b. ä¸ºæ¯ä¸ªè¾“å…¥æµåˆ›å»ºå¯¹åº”çš„è¾“å‡ºæµ</span></span><br><span class="line">                out_video_stream = out_container.add_stream_from_template(in_video_stream)</span><br><span class="line">                out_video_stream.width = final_w</span><br><span class="line">                out_video_stream.height = final_h</span><br><span class="line"></span><br><span class="line">                out_audio_stream = out_container.add_stream_from_template(in_audio_stream) <span class="keyword">if</span> in_audio_stream <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">                out_subtitle_stream = out_container.add_stream_from_template(</span><br><span class="line">                    in_subtitle_stream) <span class="keyword">if</span> in_subtitle_stream <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">                streams_to_demux = [s <span class="keyword">for</span> s <span class="keyword">in</span> [in_video_stream, in_audio_stream, in_subtitle_stream] <span class="keyword">if</span> s]</span><br><span class="line"></span><br><span class="line">                <span class="comment"># --- 3. æ ¸å¿ƒå¤„ç†å¾ªç¯ ---</span></span><br><span class="line">                <span class="keyword">for</span> packet <span class="keyword">in</span> in_container.demux(streams_to_demux):</span><br><span class="line">                    <span class="keyword">if</span> packet.dts <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> packet.stream.<span class="built_in">type</span> == <span class="string">&#x27;video&#x27;</span>:</span><br><span class="line">                        <span class="keyword">for</span> frame <span class="keyword">in</span> packet.decode():</span><br><span class="line">                            img = frame.to_image()</span><br><span class="line"></span><br><span class="line">                            <span class="comment"># è£å‰ª</span></span><br><span class="line">                            cropped_img = img.crop((x, y, x + w, y + h))</span><br><span class="line"></span><br><span class="line">                            <span class="comment"># å¦‚æœéœ€è¦ï¼Œè¿›è¡Œç¼©æ”¾</span></span><br><span class="line">                            <span class="keyword">if</span> needs_scaling:</span><br><span class="line">                                <span class="comment"># Pillow çš„ resize éœ€è¦ä¸€ä¸ª (width, height) å…ƒç»„</span></span><br><span class="line">                                cropped_img = cropped_img.resize((final_w, final_h))</span><br><span class="line"></span><br><span class="line">                            new_frame = av.VideoFrame.from_image(cropped_img)</span><br><span class="line">                            new_frame.pts = frame.pts</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">for</span> out_packet <span class="keyword">in</span> out_video_stream.encode(new_frame):</span><br><span class="line">                                out_container.mux(out_packet)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">elif</span> packet.stream.<span class="built_in">type</span> == <span class="string">&#x27;audio&#x27;</span> <span class="keyword">and</span> out_audio_stream:</span><br><span class="line">                        packet.stream = out_audio_stream</span><br><span class="line">                        out_container.mux(packet)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">elif</span> packet.stream.<span class="built_in">type</span> == <span class="string">&#x27;subtitle&#x27;</span> <span class="keyword">and</span> out_subtitle_stream:</span><br><span class="line">                        packet.stream = out_subtitle_stream</span><br><span class="line">                        out_container.mux(packet)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># --- 4. å†²æ´—(Flush)è§†é¢‘ç¼–ç å™¨ ---</span></span><br><span class="line">                logger.debug(<span class="string">&quot;è½¯ä»¶è·¯å¾„: å†²æ´—è§†é¢‘ç¼–ç å™¨ã€‚&quot;</span>)</span><br><span class="line">                <span class="keyword">for</span> out_packet <span class="keyword">in</span> out_video_stream.encode(<span class="literal">None</span>):</span><br><span class="line">                    out_container.mux(out_packet)</span><br><span class="line"></span><br><span class="line">        success = <span class="literal">True</span></span><br><span class="line">        logger.info(<span class="string">f&quot;è½¯ä»¶è·¯å¾„: è§†é¢‘å¤„ç†æˆåŠŸ -&gt; <span class="subst">&#123;os.path.basename(output_video_path)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.opt(exception=<span class="literal">True</span>).error(<span class="string">f&quot;è½¯ä»¶è·¯å¾„å¤„ç†æ—¶å‘ç”Ÿé”™è¯¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">if</span> output_container <span class="keyword">and</span> <span class="keyword">not</span> output_container.closed:</span><br><span class="line">            output_container.close()</span><br><span class="line">        <span class="keyword">if</span> input_container <span class="keyword">and</span> <span class="keyword">not</span> input_container.closed:</span><br><span class="line">            input_container.close()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> success <span class="keyword">and</span> os.path.exists(output_video_path):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                os.remove(output_video_path)</span><br><span class="line">                logger.info(<span class="string">f&quot;å·²æ¸…ç†å¤±è´¥çš„è¾“å‡ºæ–‡ä»¶: <span class="subst">&#123;output_video_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> OSError <span class="keyword">as</span> err:</span><br><span class="line">                logger.warning(<span class="string">f&quot;æ¸…ç†å¤±è´¥çš„è¾“å‡ºæ–‡ä»¶æ—¶å‡ºé”™: <span class="subst">&#123;err&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><h2 id="one-more-thing">one more thing</h2><ul><li>gpu acc</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># GPU Acceleration Defaults</span></span><br><span class="line">GPU_ACCELERATION_DEFAULT = &#123;</span><br><span class="line">    <span class="string">&quot;gpu_opencv_decode&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">    <span class="string">&quot;opencv_cuda_device&quot;</span>: <span class="number">0</span>,  <span class="comment"># Default/primary GPU for OpenCV CUDA operations</span></span><br><span class="line">    <span class="string">&quot;ffmpeg_hwaccel&quot;</span>: <span class="string">&quot;videotoolbox&quot;</span>,     <span class="comment"># e.g., &quot;cuda&quot;, &quot;qsv&quot;, &quot;vaapi&quot;, &quot;videotoolbox&quot;</span></span><br><span class="line">    <span class="string">&quot;ffmpeg_gpu_encoder&quot;</span>: <span class="string">&quot;h264_videotoolbox&quot;</span>, <span class="comment"># e.g., &quot;h264_nvenc&quot;, &quot;hevc_qsv&quot;, h264_videotoolbox</span></span><br><span class="line">    <span class="string">&quot;gpu_ids_to_use&quot;</span>: <span class="string">&quot;0&quot;</span>      <span class="comment"># New: Comma-separated list of GPU IDs (e.g., &quot;0,1&quot;) for general processing</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GPU_ACCELERATION_DEFAULT_win = &#123;</span><br><span class="line">    <span class="string">&quot;gpu_opencv_decode&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">    <span class="string">&quot;opencv_cuda_device&quot;</span>: <span class="number">0</span>,  <span class="comment"># Default/primary GPU for OpenCV CUDA operations</span></span><br><span class="line">    <span class="string">&quot;ffmpeg_hwaccel&quot;</span>: <span class="string">&quot;cuda&quot;</span>,     <span class="comment"># e.g., &quot;cuda&quot;, &quot;qsv&quot;, &quot;vaapi&quot;, &quot;videotoolbox&quot;</span></span><br><span class="line">    <span class="string">&quot;ffmpeg_gpu_encoder&quot;</span>: <span class="string">&quot;h264_nvenc&quot;</span>, <span class="comment"># e.g., &quot;h264_nvenc&quot;, &quot;hevc_qsv&quot;, h264_videotoolbox</span></span><br><span class="line">    <span class="string">&quot;gpu_ids_to_use&quot;</span>: <span class="string">&quot;0&quot;</span>      <span class="comment"># New: Comma-separated list of GPU IDs (e.g., &quot;0,1&quot;) for general processing</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="See">See</h2><ul><li>1.<a href="https://github.com/PyAV-Org/PyAV/tree/main/docs/api">https://github.com/PyAV-Org/PyAV/tree/main/docs/api</a></li><li>2.<a href="https://ffmpeg.org/documentation.html">https://ffmpeg.org/documentation.html</a></li><li>3.<a href="https://pyav.basswood-io.com/docs/stable/">https://pyav.basswood-io.com/docs/stable/</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°å­—æ°´å°ç³»ç»Ÿå®ç°</title>
      <link href="/2025/07/22/watermark-gen-valid/"/>
      <url>/2025/07/22/watermark-gen-valid/</url>
      
        <content type="html"><![CDATA[<h2 id="å®ç°æµç¨‹æ¡†æ¶">å®ç°æµç¨‹æ¡†æ¶</h2><p>æ— è®ºä½¿ç”¨å“ªç§æŠ€æœ¯ï¼Œä¸€ä¸ªå®Œæ•´çš„æ•°å­—æ°´å°ç³»ç»Ÿé€šå¸¸éƒ½åŒ…æ‹¬ä¸¤ä¸ªåŸºæœ¬è¿‡ç¨‹ï¼š</p><ol><li><p><strong>æ°´å°åµŒå…¥ (Watermark Embedding)</strong>ï¼š</p><ul><li><strong>è¾“å…¥</strong>ï¼šåŸå§‹è½½ä½“ï¼ˆå¦‚å›¾ç‰‡Aï¼‰ã€æ°´å°ä¿¡æ¯ï¼ˆå¦‚å­—ç¬¦ä¸²&quot;ID:123&quot;æˆ–ä¸€ä¸ªLogoå›¾ç‰‡Bï¼‰ã€‚</li><li><strong>è¿‡ç¨‹</strong>ï¼šé€šè¿‡ç‰¹å®šç®—æ³•ï¼Œå°†æ°´å°ä¿¡æ¯Bå¤„ç†åï¼Œâ€œå åŠ â€æˆ–â€œèå…¥â€åˆ°åŸå§‹è½½ä½“Aä¸­ã€‚</li><li><strong>è¾“å‡º</strong>ï¼šä¸€ä¸ªå¸¦æœ‰æ°´å°ã€ä½†çœ‹èµ·æ¥å’ŒåŸå§‹è½½ä½“å‡ ä¹æ²¡åŒºåˆ«çš„è½½ä½“Aâ€™ã€‚</li></ul></li><li><p><strong>æ°´å°æå–/æ£€æµ‹ (Watermark Extraction/Detection)</strong>ï¼š</p><ul><li><strong>è¾“å…¥</strong>ï¼šå¯èƒ½è¢«ä¿®æ”¹è¿‡çš„å¸¦æ°´å°è½½ä½“Aâ€™'ï¼Œæœ‰æ—¶è¿˜éœ€è¦åŸå§‹è½½ä½“Aæˆ–åŸå§‹æ°´å°Bä½œä¸ºå‚è€ƒã€‚</li><li><strong>è¿‡ç¨‹</strong>ï¼šé€šè¿‡ä¸åµŒå…¥è¿‡ç¨‹ç›¸é€†çš„ç®—æ³•ï¼Œä»è½½ä½“Aâ€™'ä¸­è§£ç å‡ºéšè—çš„æ°´å°ä¿¡æ¯ã€‚</li><li><strong>è¾“å‡º</strong>ï¼šæå–å‡ºçš„æ°´å°ä¿¡æ¯Bâ€™ï¼Œæˆ–è€…ä¸€ä¸ªâ€œæ˜¯/å¦â€çš„åˆ¤æ–­ï¼ˆç¡®è®¤æ˜¯å¦å­˜åœ¨æŸä¸ªç‰¹å®šæ°´å°ï¼‰ã€‚</li></ul></li></ol><blockquote><p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥çœ‹å®ç°è¿™äº›æµç¨‹çš„å…·ä½“æŠ€æœ¯ã€‚</p></blockquote><hr><h3 id="ä¸€ã€-ç©ºåŸŸï¼ˆSpatial-Domainï¼‰æŠ€æœ¯">ä¸€ã€ ç©ºåŸŸï¼ˆSpatial Domainï¼‰æŠ€æœ¯</h3><p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šç›´æ¥ä¿®æ”¹åŸå§‹å›¾åƒçš„åƒç´ å€¼ï¼ˆæ¯”å¦‚RGBå€¼ï¼‰æ¥åµŒå…¥ä¿¡æ¯ã€‚è¿™ç§æ–¹æ³•ç›´è§‚ã€ç®€å•ã€‚</p><h4 id="å…¸å‹æŠ€æœ¯ï¼šLSB-Least-Significant-Bit-ç®—æ³•">å…¸å‹æŠ€æœ¯ï¼šLSB (Least Significant Bit) ç®—æ³•</h4><p>è¿™æ˜¯æœ€ç»å…¸ã€æœ€ç®€å•çš„ç©ºåŸŸæ°´å°æŠ€æœ¯ã€‚</p><ul><li><p><strong>åŸç†</strong>ï¼š</p><ul><li>è®¡ç®—æœºä¸­çš„å›¾åƒï¼Œæ¯ä¸ªåƒç´ çš„é¢œè‰²ç”±è‹¥å¹²ä¸ªäºŒè¿›åˆ¶ä½ï¼ˆbitsï¼‰è¡¨ç¤ºã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ª8ä½çš„ç°åº¦å›¾åƒï¼Œæ¯ä¸ªåƒç´ çš„ç°åº¦å€¼èŒƒå›´æ˜¯0-255ï¼Œç”±8ä¸ªäºŒè¿›åˆ¶ä½ç»„æˆã€‚</li><li><strong>æœ€ä½æœ‰æ•ˆä½ (LSB)</strong> å°±æ˜¯è¿™8ä¸ªä½ä¸­æœ€å³è¾¹çš„é‚£ä¸€ä½ã€‚æ”¹å˜è¿™ä¸€ä½ï¼Œå¯¹åƒç´ å€¼çš„æ•´ä½“å½±å“æœ€å°ï¼ˆæœ€å¤šæ”¹å˜1ï¼‰ï¼Œäººçœ¼åŸºæœ¬æ— æ³•å¯Ÿè§‰ã€‚</li><li><strong>åµŒå…¥æ–¹æ³•</strong>ï¼šå°†è¦éšè—çš„æ°´å°ä¿¡æ¯ï¼ˆæ¯”å¦‚ä¸€å¼ é»‘ç™½Logoå›¾ç‰‡ï¼‰è½¬æ¢æˆäºŒè¿›åˆ¶æµï¼ˆ0å’Œ1çš„åºåˆ—ï¼‰ã€‚ç„¶åï¼Œç”¨è¿™ä¸ªäºŒè¿›åˆ¶æµå»æ›¿æ¢åŸå§‹å›¾åƒä¸­æ¯ä¸ªï¼ˆæˆ–éƒ¨åˆ†ï¼‰åƒç´ çš„LSBã€‚<ul><li>å¦‚æœè¦åµŒå…¥<code>1</code>ï¼Œå°±æŠŠåƒç´ çš„LSBæ”¹æˆ<code>1</code>ã€‚</li><li>å¦‚æœè¦åµŒå…¥<code>0</code>ï¼Œå°±æŠŠåƒç´ çš„LSBæ”¹æˆ<code>0</code>ã€‚</li></ul></li></ul></li><li><p><strong>æå–æ–¹æ³•</strong>ï¼šç›´æ¥è¯»å–å¸¦æ°´å°å›¾åƒä¸­ç›¸åº”åƒç´ çš„LSBï¼Œå°±èƒ½è¿˜åŸå‡ºéšè—çš„äºŒè¿›åˆ¶æµï¼Œä»è€Œé‡æ„æ°´å°ä¿¡æ¯ã€‚</p></li><li><p><strong>ä¼˜ç‚¹</strong>ï¼š</p><ul><li><strong>å®ç°ç®€å•</strong>ï¼šç®—æ³•éå¸¸ç›´æ¥ã€‚</li><li><strong>å®¹é‡å¤§</strong>ï¼šæ¯ä¸ªåƒç´ éƒ½èƒ½è—1æ¯”ç‰¹ä¿¡æ¯ï¼Œå¯ä»¥éšè—å¤§é‡æ•°æ®ã€‚</li><li><strong>éšè”½æ€§å¥½</strong>ï¼šå¯¹è§†è§‰å½±å“æå°ã€‚</li></ul></li><li><p><strong>ç¼ºç‚¹</strong>ï¼š</p><ul><li><strong>é²æ£’æ€§æå·®ï¼ˆéå¸¸è„†å¼±ï¼‰</strong>ï¼šè¿™æ˜¯å®ƒçš„è‡´å‘½å¼±ç‚¹ã€‚ä»»ä½•å¯¹å›¾åƒçš„è½»å¾®å¤„ç†ï¼Œå¦‚ <strong>JPEGå‹ç¼©ã€ç¼©æ”¾ã€è£å‰ªã€åŠ ä¸ªæ»¤é•œ</strong>ï¼Œéƒ½ä¼šç ´åLSBå±‚çš„æ•°æ®ï¼Œå¯¼è‡´æ°´å°å®Œå…¨ä¸¢å¤±ã€‚</li></ul></li><li><p><strong>åº”ç”¨åœºæ™¯</strong>ï¼šä¸»è¦ç”¨äº<strong>è„†å¼±æ°´å°</strong>ï¼Œå³<strong>å†…å®¹å®Œæ•´æ€§è®¤è¯</strong>ã€‚å› ä¸ºåªè¦å›¾ç‰‡è¢«æ”¹åŠ¨ï¼Œæ°´å°å°±ä¼šè¢«ç ´åï¼Œä»è€Œå¯ä»¥è¯æ˜â€œæ­¤å›¾å·²è¢«ä¿®æ”¹â€ã€‚</p></li></ul><hr><h3 id="äºŒã€-å˜æ¢åŸŸï¼ˆTransform-Domainï¼‰æŠ€æœ¯">äºŒã€ å˜æ¢åŸŸï¼ˆTransform Domainï¼‰æŠ€æœ¯</h3><p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šä¸ç›´æ¥æ”¹åƒç´ å€¼ï¼Œè€Œæ˜¯å…ˆå¯¹å›¾åƒè¿›è¡Œæ•°å­¦å˜æ¢ï¼ˆå¦‚å‚…é‡Œå¶å˜æ¢ã€ä½™å¼¦å˜æ¢ï¼‰ï¼Œå°†å…¶ä»ç©ºåŸŸè½¬æ¢åˆ°å¦ä¸€ä¸ªåŸŸï¼ˆå¦‚é¢‘åŸŸï¼‰ã€‚ç„¶åï¼Œåœ¨å˜æ¢åçš„åŸŸä¸­ä¿®æ”¹ç³»æ•°æ¥åµŒå…¥æ°´å°ã€‚è¿™æ˜¯ç›®å‰ä¸»æµçš„ã€<strong>é²æ£’æ°´å°</strong>çš„å®ç°æ–¹å¼ã€‚</p><p><strong>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Ÿ</strong><br>å› ä¸ºåƒJPEGå‹ç¼©è¿™æ ·çš„æ“ä½œï¼Œä¸»è¦ä¸¢å¼ƒçš„æ˜¯å›¾åƒçš„<strong>é«˜é¢‘ä¿¡æ¯</strong>ï¼ˆç»†èŠ‚ï¼‰ï¼Œè€Œä¿ç•™<strong>ä¸­ä½é¢‘ä¿¡æ¯</strong>ï¼ˆè½®å»“ã€ä¸»è¦èƒ½é‡ï¼‰ã€‚å¦‚æœåœ¨ä¸­ä½é¢‘ç³»æ•°é‡ŒåµŒå…¥æ°´å°ï¼Œé‚£ä¹ˆå³ä½¿ç»è¿‡å‹ç¼©ï¼Œæ°´å°ä¿¡æ¯ä¹Ÿèƒ½å¤§æ¦‚ç‡è¢«ä¿ç•™ä¸‹æ¥ã€‚</p><h4 id="1-åŸºäºDCTï¼ˆç¦»æ•£ä½™å¼¦å˜æ¢ï¼‰çš„æŠ€æœ¯">1. åŸºäºDCTï¼ˆç¦»æ•£ä½™å¼¦å˜æ¢ï¼‰çš„æŠ€æœ¯</h4><ul><li><strong>èƒŒæ™¯</strong>ï¼šDCTæ˜¯ <strong>JPEG å‹ç¼©</strong>çš„æ ¸å¿ƒç®—æ³•ã€‚å®ƒå°†å›¾åƒåˆ†æˆ8x8çš„å°å—ï¼Œç„¶åå¯¹æ¯ä¸ªå—è¿›è¡ŒDCTå˜æ¢ï¼Œå¾—åˆ°ä¸€ä¸ªé¢‘ç‡ç³»æ•°çŸ©é˜µã€‚è¿™ä¸ªçŸ©é˜µä¸­ï¼Œå·¦ä¸Šè§’æ˜¯ä½é¢‘ç³»æ•°ï¼ˆèƒ½é‡é›†ä¸­ï¼‰ï¼Œå³ä¸‹è§’æ˜¯é«˜é¢‘ç³»æ•°ã€‚</li><li><strong>åµŒå…¥æ–¹æ³•</strong>ï¼š<ol><li>å°†åŸå§‹å›¾åƒåˆ†å—ï¼ˆå¦‚8x8ï¼‰ã€‚</li><li>å¯¹æ¯ä¸ªå—è¿›è¡ŒDCTå˜æ¢ã€‚</li><li>é€‰æ‹©<strong>ä¸­é¢‘åŒºåŸŸ</strong>çš„ç³»æ•°è¿›è¡Œä¿®æ”¹ã€‚ä¸ºä»€ä¹ˆæ˜¯ä¸­é¢‘ï¼Ÿå› ä¸ºä½é¢‘ç³»æ•°å¯¹è§†è§‰å½±å“å¤ªå¤§ï¼Œé«˜é¢‘ç³»æ•°å®¹æ˜“åœ¨å‹ç¼©ä¸­ä¸¢å¤±ï¼Œä¸­é¢‘æ˜¯æœ€ä½³å¹³è¡¡ç‚¹ã€‚</li><li>æ ¹æ®æ°´å°ä¿¡æ¯ï¼ˆ0æˆ–1ï¼‰æ¥ä¿®æ”¹è¿™äº›ä¸­é¢‘ç³»æ•°ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡é‡åŒ–æˆ–æ¯”è¾ƒä¸¤ä¸ªç³»æ•°çš„å¤§å°æ¥åµŒå…¥1æ¯”ç‰¹ä¿¡æ¯ã€‚</li><li>å¯¹ä¿®æ”¹åçš„ç³»æ•°çŸ©é˜µè¿›è¡Œ<strong>é€†DCTå˜æ¢</strong> (IDCT)ï¼Œå¾—åˆ°å¸¦æ°´å°çš„å›¾åƒå—ã€‚</li></ol></li><li><strong>ä¼˜ç‚¹</strong>ï¼š<ul><li><strong>é²æ£’æ€§å¼º</strong>ï¼šå¯¹JPEGå‹ç¼©ã€è½»å¾®å™ªå£°ã€äº®åº¦è°ƒæ•´ç­‰æœ‰å¾ˆå¥½çš„æŠµæŠ—èƒ½åŠ›ã€‚</li><li><strong>éšè”½æ€§å¥½</strong>ï¼šåˆ©ç”¨äº†äººç±»è§†è§‰ç³»ç»Ÿå¯¹ä¸­é¢‘å˜åŒ–ä¸æ•æ„Ÿçš„ç‰¹æ€§ã€‚</li></ul></li><li><strong>åº”ç”¨åœºæ™¯</strong>ï¼š<strong>ç‰ˆæƒä¿æŠ¤</strong>ã€<strong>ç›—ç‰ˆè¿½è¸ª</strong>ç­‰éœ€è¦å¼ºé²æ£’æ€§çš„åœºåˆã€‚</li></ul><h4 id="2-åŸºäºDWTï¼ˆç¦»æ•£å°æ³¢å˜æ¢ï¼‰çš„æŠ€æœ¯">2. åŸºäºDWTï¼ˆç¦»æ•£å°æ³¢å˜æ¢ï¼‰çš„æŠ€æœ¯</h4><ul><li><strong>èƒŒæ™¯</strong>ï¼šDWTæ˜¯ <strong>JPEG 2000</strong> å‹ç¼©æ ‡å‡†çš„æ ¸å¿ƒã€‚ä¸DCTä¸åŒï¼ŒDWTèƒ½å¯¹æ•´ä¸ªå›¾åƒè¿›è¡Œå¤šåˆ†è¾¨ç‡åˆ†æï¼Œå¾—åˆ°ä¸åŒå°ºåº¦å’Œæ–¹å‘çš„å­å¸¦ï¼ˆä½é¢‘ã€æ°´å¹³ç»†èŠ‚ã€å‚ç›´ç»†èŠ‚ã€å¯¹è§’çº¿ç»†èŠ‚ï¼‰ã€‚</li><li><strong>åµŒå…¥æ–¹æ³•</strong>ï¼š<ol><li>å¯¹æ•´ä¸ªå›¾åƒè¿›è¡ŒDWTå˜æ¢ã€‚</li><li>æ°´å°é€šå¸¸è¢«åµŒå…¥åˆ°<strong>ä¸­ã€ä½é¢‘å­å¸¦</strong>çš„ç³»æ•°ä¸­ã€‚</li><li>å› ä¸ºDWTæä¾›äº†å›¾åƒçš„ç©ºé—´å’Œé¢‘ç‡å±€éƒ¨åŒ–ä¿¡æ¯ï¼Œæ‰€ä»¥å®ƒå¯¹è£å‰ªã€ç¼©æ”¾ç­‰å‡ ä½•æ”»å‡»çš„æŠµæŠ—æ€§æ›´å¥½ã€‚</li></ol></li><li><strong>ä¼˜ç‚¹</strong>ï¼š<ul><li><strong>å¤šåˆ†è¾¨ç‡ç‰¹æ€§</strong>ï¼šé²æ£’æ€§æ¯”DCTæ›´å…¨é¢ï¼Œå°¤å…¶åœ¨æŠ—å‡ ä½•æ”»å‡»æ–¹é¢ã€‚</li><li><strong>ä¸äººç±»è§†è§‰ç³»ç»Ÿï¼ˆHVSï¼‰åŒ¹é…æ›´å¥½</strong>ï¼šå¯ä»¥æ›´ç²¾ç»†åœ°æ§åˆ¶æ°´å°çš„åµŒå…¥å¼ºåº¦ï¼Œè¾¾åˆ°æ›´å¥½çš„éšè”½æ€§ã€‚</li></ul></li><li><strong>åº”ç”¨åœºæ™¯</strong>ï¼šåŒDCTï¼Œç”¨äºéœ€è¦æ›´é«˜é²æ£’æ€§çš„ç‰ˆæƒä¿æŠ¤ç³»ç»Ÿã€‚</li></ul><h4 id="3-åŸºäºDFTï¼ˆç¦»æ•£å‚…é‡Œå¶å˜æ¢ï¼‰çš„æŠ€æœ¯">3. åŸºäºDFTï¼ˆç¦»æ•£å‚…é‡Œå¶å˜æ¢ï¼‰çš„æŠ€æœ¯</h4><ul><li><strong>èƒŒæ™¯</strong>ï¼šDFTå°†å›¾åƒè½¬æ¢æˆå¹…åº¦å’Œç›¸ä½è°±ã€‚</li><li><strong>ç‰¹ç‚¹</strong>ï¼šå›¾åƒçš„å¹…åº¦è°±å¯¹<strong>æ—‹è½¬ã€ç¼©æ”¾å’Œå¹³ç§»ï¼ˆRSTæ”»å‡»ï¼‰</strong> å…·æœ‰ä¸å˜æ€§æˆ–ç‰¹å®šçš„å˜åŒ–è§„å¾‹ã€‚</li><li><strong>åµŒå…¥æ–¹æ³•</strong>ï¼šé€šè¿‡ä¿®æ”¹DFTå˜æ¢åçš„<strong>å¹…åº¦è°±</strong>æ¥åµŒå…¥æ°´å°ã€‚</li><li><strong>ä¼˜ç‚¹</strong>ï¼š<ul><li>å¯¹æ—‹è½¬ã€ç¼©æ”¾ç­‰å‡ ä½•æ”»å‡»å…·æœ‰å¤©ç„¶çš„é²æ£’æ€§ã€‚</li></ul></li><li><strong>ç¼ºç‚¹</strong>ï¼š<ul><li>å®ç°å¤æ‚ï¼Œä¸”å®¹æ˜“å‡ºç°å›¾åƒå—æ•ˆåº”ã€‚</li></ul></li><li><strong>åº”ç”¨åœºæ™¯</strong>ï¼šä¸»è¦ç”¨äºæŠµæŠ—å‡ ä½•å˜æ¢çš„ç‰¹å®šåœºåˆã€‚</li></ul><hr><h2 id="å®ç°">å®ç°</h2><h3 id="æ ¸å¿ƒçš„Pythonåº“ï¼š">æ ¸å¿ƒçš„Pythonåº“ï¼š</h3><ul><li><strong>Pillow (PIL Fork)</strong>: ç”¨äºå›¾åƒçš„è¯»å†™å’ŒåŸºæœ¬çš„åƒç´ æ“ä½œï¼ˆå®ç°LSBï¼‰ã€‚</li><li><strong>NumPy</strong>: ç”¨äºé«˜æ•ˆçš„æ•°ç»„å’ŒçŸ©é˜µè¿ç®—ï¼Œæ˜¯æ‰€æœ‰å›¾åƒå¤„ç†çš„åŸºç¡€ã€‚</li><li><strong>PyWavelets (pywt)</strong>: ç”¨äºå®ç°DWTï¼ˆç¦»æ•£å°æ³¢å˜æ¢ï¼‰ã€‚</li><li><strong>OpenCV-Python (cv2)</strong>: åŠŸèƒ½æœ€å¼ºå¤§çš„è®¡ç®—æœºè§†è§‰åº“ï¼Œå¯ä»¥æ–¹ä¾¿åœ°å®ç°DCTã€DFTä»¥åŠå„ç§å›¾åƒå¤„ç†æ“ä½œã€‚</li></ul><hr><h3 id="1-ç©ºåŸŸ-Spatial-Domain-LSB-ç®—æ³•">1. ç©ºåŸŸ (Spatial Domain) - LSB ç®—æ³•</h3><p><strong>æ ¸å¿ƒåº“</strong>: <code>Pillow</code> (PIL), <code>NumPy</code></p><p>è¿™ä¸ªç®—æ³•ä¸ä¾èµ–å¤æ‚çš„æ•°å­¦åº“ï¼ŒPillowå’ŒNumPyè¶³ä»¥èƒœä»»ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode_lsb</span>(<span class="params">image_path, secret_message</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å°†ç§˜å¯†ä¿¡æ¯åµŒå…¥åˆ°å›¾ç‰‡çš„LSBå±‚&quot;&quot;&quot;</span></span><br><span class="line">    img = Image.<span class="built_in">open</span>(image_path, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">    width, height = img.size</span><br><span class="line">    img_array = np.array(img)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. å°†ç§˜å¯†ä¿¡æ¯è½¬æ¢ä¸ºäºŒè¿›åˆ¶æµ</span></span><br><span class="line">    binary_secret = <span class="string">&#x27;&#x27;</span>.join([<span class="built_in">format</span>(<span class="built_in">ord</span>(c), <span class="string">&#x27;08b&#x27;</span>) <span class="keyword">for</span> c <span class="keyword">in</span> secret_message])</span><br><span class="line">    binary_secret += <span class="string">&#x27;1111111111111110&#x27;</span> <span class="comment"># æ·»åŠ ç»“æŸæ ‡è®°</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(binary_secret) &gt; width * height * <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;ä¿¡æ¯è¿‡é•¿ï¼Œæ— æ³•åµŒå…¥åˆ°å›¾ç‰‡ä¸­ï¼&quot;</span>)</span><br><span class="line"></span><br><span class="line">    data_index = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 2. éå†åƒç´ å¹¶ä¿®æ”¹LSB</span></span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(height):</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(width):</span><br><span class="line">            pixel = img_array[y, x]</span><br><span class="line">            <span class="comment"># éå†RGBä¸‰ä¸ªé€šé“</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">                <span class="keyword">if</span> data_index &lt; <span class="built_in">len</span>(binary_secret):</span><br><span class="line">                    <span class="comment"># æ¸…é™¤LSBå¹¶è®¾ç½®æ–°çš„ä½</span></span><br><span class="line">                    pixel[i] = (pixel[i] &amp; <span class="number">0xFE</span>) | <span class="built_in">int</span>(binary_secret[data_index])</span><br><span class="line">                    data_index += <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> data_index &gt;= <span class="built_in">len</span>(binary_secret):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> data_index &gt;= <span class="built_in">len</span>(binary_secret):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. åˆ›å»ºå¹¶ä¿å­˜æ–°å›¾ç‰‡</span></span><br><span class="line">    encoded_image = Image.fromarray(img_array)</span><br><span class="line">    encoded_image.save(<span class="string">&quot;encoded_image.png&quot;</span>, <span class="string">&quot;PNG&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ä¿¡æ¯åµŒå…¥æˆåŠŸï¼Œå·²ä¿å­˜ä¸º encoded_image.png&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode_lsb</span>(<span class="params">image_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä»å›¾ç‰‡çš„LSBå±‚æå–ç§˜å¯†ä¿¡æ¯&quot;&quot;&quot;</span></span><br><span class="line">    img = Image.<span class="built_in">open</span>(image_path, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">    img_array = np.array(img)</span><br><span class="line">    width, height = img.size</span><br><span class="line"></span><br><span class="line">    binary_data = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 1. éå†åƒç´ å¹¶æå–LSB</span></span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(height):</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(width):</span><br><span class="line">            pixel = img_array[y, x]</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">                binary_data += <span class="built_in">str</span>(pixel[i] &amp; <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. æ‰¾åˆ°ç»“æŸæ ‡è®°å¹¶è½¬æ¢ä¿¡æ¯</span></span><br><span class="line">    end_marker = <span class="string">&#x27;1111111111111110&#x27;</span></span><br><span class="line">    end_index = binary_data.find(end_marker)</span><br><span class="line">    <span class="keyword">if</span> end_index != -<span class="number">1</span>:</span><br><span class="line">        secret_binary = binary_data[:end_index]</span><br><span class="line">        secret_message = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(secret_binary), <span class="number">8</span>):</span><br><span class="line">            byte = secret_binary[i:i+<span class="number">8</span>]</span><br><span class="line">            secret_message += <span class="built_in">chr</span>(<span class="built_in">int</span>(byte, <span class="number">2</span>))</span><br><span class="line">        <span class="keyword">return</span> secret_message</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;æœªæ‰¾åˆ°ç»“æŸæ ‡è®°æˆ–ä¿¡æ¯ã€‚&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- ä½¿ç”¨ç¤ºä¾‹ ---</span></span><br><span class="line"><span class="comment"># è¯·å‡†å¤‡ä¸€å¼ åä¸º &#x27;original.png&#x27; çš„å›¾ç‰‡</span></span><br><span class="line"><span class="comment"># encode_lsb(&#x27;original.png&#x27;, &quot;This is a secret message!&quot;)</span></span><br><span class="line"><span class="comment"># message = decode_lsb(&#x27;encoded_image.png&#x27;)</span></span><br><span class="line"><span class="comment"># print(f&quot;æå–åˆ°çš„ä¿¡æ¯: &#123;message&#125;&quot;)</span></span><br></pre></td></tr></table></figure><hr><h3 id="2-å˜æ¢åŸŸ-Transform-Domain-DCT-ç®—æ³•">2. å˜æ¢åŸŸ (Transform Domain) - DCT ç®—æ³•</h3><p><strong>æ ¸å¿ƒåº“</strong>: <code>OpenCV-Python (cv2)</code>, <code>NumPy</code></p><p>OpenCV æä¾›äº†éå¸¸æ–¹ä¾¿çš„ <code>cv2.dct()</code> å’Œ <code>cv2.idct()</code> å‡½æ•°ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dct_watermark_embed</span>(<span class="params">image_path, watermark_path, alpha=<span class="number">0.1</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åŸºäºDCTçš„ä¸­é¢‘å¸¦åµŒå…¥å›¾åƒæ°´å°&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 1. å‡†å¤‡è½½ä½“å’Œæ°´å°</span></span><br><span class="line">    img = cv2.imread(image_path, cv2.IMREAD_GRAYSCALE)</span><br><span class="line">    watermark = cv2.imread(watermark_path, cv2.IMREAD_GRAYSCALE)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç¡®ä¿æ°´å°å°ºå¯¸å°äºè½½ä½“</span></span><br><span class="line">    watermark = cv2.resize(watermark, (img.shape[<span class="number">1</span>], img.shape[<span class="number">0</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. å¯¹è½½ä½“å›¾åƒè¿›è¡ŒDCTå˜æ¢</span></span><br><span class="line">    img_dct = cv2.dct(np.float32(img))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. å¯¹æ°´å°å›¾åƒè¿›è¡ŒDCTå˜æ¢ (ä¹Ÿå¯ä»¥ç›´æ¥ç”¨äºŒå€¼åŒ–æ°´å°)</span></span><br><span class="line">    watermark_dct = cv2.dct(np.float32(watermark))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 4. å°†æ°´å°çš„DCTç³»æ•°åŠ åˆ°è½½ä½“çš„ä¸­é¢‘DCTç³»æ•°ä¸Š</span></span><br><span class="line">    <span class="comment"># è¿™é‡Œç®€å•åœ°å°†æ•´ä¸ªæ°´å°DCTåŠ åˆ°è½½ä½“DCTä¸Šï¼Œæ›´å¤æ‚çš„ä¼šé€‰æ‹©ç‰¹å®šåŒºåŸŸ</span></span><br><span class="line">    <span class="comment"># alpha æ˜¯åµŒå…¥å¼ºåº¦</span></span><br><span class="line">    result_dct = img_dct + alpha * watermark_dct</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 5. è¿›è¡Œé€†DCTå˜æ¢</span></span><br><span class="line">    result_img = cv2.idct(result_dct)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è£å‰ªå€¼åˆ° 0-255 å¹¶è½¬æ¢ä¸ºuint8</span></span><br><span class="line">    result_img = np.clip(result_img, <span class="number">0</span>, <span class="number">255</span>).astype(np.uint8)</span><br><span class="line"></span><br><span class="line">    cv2.imwrite(<span class="string">&#x27;dct_embedded_image.png&#x27;</span>, result_img)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;DCTæ°´å°åµŒå…¥æˆåŠŸï¼&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dct_watermark_extract</span>(<span class="params">embedded_image_path, original_image_path, alpha=<span class="number">0.1</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æå–DCTæ°´å°ï¼ˆéœ€è¦åŸå§‹å›¾åƒï¼‰&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># è¿™æ˜¯ä¸€ä¸ªéç›²æ°´å°æå–çš„ä¾‹å­</span></span><br><span class="line">    embedded_img = cv2.imread(embedded_image_path, cv2.IMREAD_GRAYSCALE)</span><br><span class="line">    original_img = cv2.imread(original_image_path, cv2.IMREAD_GRAYSCALE)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. å¯¹å¸¦æ°´å°å›¾åƒå’ŒåŸå§‹å›¾åƒåˆ†åˆ«åšDCT</span></span><br><span class="line">    embedded_dct = cv2.dct(np.float32(embedded_img))</span><br><span class="line">    original_dct = cv2.dct(np.float32(original_img))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. ç›¸å‡å¹¶é™¤ä»¥å¼ºåº¦å› å­ï¼Œå¾—åˆ°æ°´å°çš„DCTç³»æ•°</span></span><br><span class="line">    extracted_watermark_dct = (embedded_dct - original_dct) / alpha</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. é€†DCTå˜æ¢ï¼Œæ¢å¤æ°´å°</span></span><br><span class="line">    extracted_watermark = cv2.idct(extracted_watermark_dct)</span><br><span class="line">    extracted_watermark = np.clip(extracted_watermark, <span class="number">0</span>, <span class="number">255</span>).astype(np.uint8)</span><br><span class="line"></span><br><span class="line">    cv2.imwrite(<span class="string">&#x27;dct_extracted_watermark.png&#x27;</span>, extracted_watermark)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;DCTæ°´å°æå–æˆåŠŸï¼&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- ä½¿ç”¨ç¤ºä¾‹ ---</span></span><br><span class="line"><span class="comment"># è¯·å‡†å¤‡ &#x27;original.png&#x27; å’Œ &#x27;watermark_logo.png&#x27;</span></span><br><span class="line"><span class="comment"># dct_watermark_embed(&#x27;original.png&#x27;, &#x27;watermark_logo.png&#x27;, alpha=0.1)</span></span><br><span class="line"><span class="comment"># dct_watermark_extract(&#x27;dct_embedded_image.png&#x27;, &#x27;original.png&#x27;, alpha=0.1)</span></span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„</strong>: ä¸Šè¿°DCTç¤ºä¾‹æ˜¯ä¸€ä¸ª<strong>éç›²æ°´å°</strong>ï¼Œæå–æ—¶éœ€è¦åŸå§‹å›¾åƒã€‚å®ç°ç›²æ°´å°ï¼ˆæ— éœ€åŸå›¾ï¼‰ä¼šæ›´å¤æ‚ï¼Œé€šå¸¸æ¶‰åŠåœ¨ä¸­é¢‘å¸¦é€‰æ‹©ç‰¹å®šçš„ç³»æ•°å¯¹è¿›è¡Œæ¯”è¾ƒï¼Œè€Œä¸æ˜¯ç›´æ¥å åŠ ã€‚</p><hr><h3 id="3-å˜æ¢åŸŸ-Transform-Domain-DWT-ç®—æ³•">3. å˜æ¢åŸŸ (Transform Domain) - DWT ç®—æ³•</h3><p><strong>æ ¸å¿ƒåº“</strong>: <code>PyWavelets (pywt)</code>, <code>NumPy</code>, <code>OpenCV-Python (cv2)</code></p><p><code>pywt</code> æ˜¯Pythonä¸­è¿›è¡Œå°æ³¢å˜æ¢çš„æ ‡å‡†åº“ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pywt</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dwt_watermark_embed</span>(<span class="params">image_path, watermark_path, alpha=<span class="number">0.1</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åŸºäºDWTçš„LLå­å¸¦åµŒå…¥å›¾åƒæ°´å°&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 1. å‡†å¤‡è½½ä½“å’Œæ°´å°</span></span><br><span class="line">    img = cv2.imread(image_path, cv2.IMREAD_GRAYSCALE)</span><br><span class="line">    watermark = cv2.imread(watermark_path, cv2.IMREAD_GRAYSCALE)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. å¯¹è½½ä½“å›¾åƒè¿›è¡ŒDWTå˜æ¢</span></span><br><span class="line">    <span class="comment"># &#x27;haar&#x27; æ˜¯æœ€ç®€å•çš„å°æ³¢åŸº</span></span><br><span class="line">    coeffs_img = pywt.dwt2(img, <span class="string">&#x27;haar&#x27;</span>)</span><br><span class="line">    LL, (LH, HL, HH) = coeffs_img</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç¡®ä¿æ°´å°å°ºå¯¸ä¸LLå­å¸¦åŒ¹é…</span></span><br><span class="line">    watermark_resized = cv2.resize(watermark, (LL.shape[<span class="number">1</span>], LL.shape[<span class="number">0</span>]))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. å°†æ°´å°æ·»åŠ åˆ°ä½é¢‘å­å¸¦ (LL)</span></span><br><span class="line">    <span class="comment"># LLå­å¸¦èƒ½é‡æœ€é›†ä¸­ï¼Œé²æ£’æ€§æœ€å¼ºï¼Œä½†å¯¹ç”»è´¨å½±å“ä¹Ÿæœ€å¤§</span></span><br><span class="line">    LL_watermarked = LL + alpha * watermark_resized</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4. é‡æ„å›¾åƒ</span></span><br><span class="line">    coeffs_watermarked = (LL_watermarked, (LH, HL, HH))</span><br><span class="line">    img_watermarked = pywt.idwt2(coeffs_watermarked, <span class="string">&#x27;haar&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    img_watermarked = np.clip(img_watermarked, <span class="number">0</span>, <span class="number">255</span>).astype(np.uint8)</span><br><span class="line">    cv2.imwrite(<span class="string">&#x27;dwt_embedded_image.png&#x27;</span>, img_watermarked)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;DWTæ°´å°åµŒå…¥æˆåŠŸï¼&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dwt_watermark_extract</span>(<span class="params">embedded_image_path, original_image_path, alpha=<span class="number">0.1</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æå–DWTæ°´å°ï¼ˆéœ€è¦åŸå§‹å›¾åƒï¼‰&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># åŒæ ·æ˜¯éç›²æ°´å°æå–</span></span><br><span class="line">    embedded_img = cv2.imread(embedded_image_path, cv2.IMREAD_GRAYSCALE)</span><br><span class="line">    original_img = cv2.imread(original_image_path, cv2.IMREAD_GRAYSCALE)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. å¯¹ä¸¤å¼ å›¾åˆ†åˆ«åšDWT</span></span><br><span class="line">    coeffs_embedded = pywt.dwt2(embedded_img, <span class="string">&#x27;haar&#x27;</span>)</span><br><span class="line">    LL_embedded, _ = coeffs_embedded</span><br><span class="line">    </span><br><span class="line">    coeffs_original = pywt.dwt2(original_img, <span class="string">&#x27;haar&#x27;</span>)</span><br><span class="line">    LL_original, _ = coeffs_original</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. æå–æ°´å°</span></span><br><span class="line">    extracted_watermark = (LL_embedded - LL_original) / alpha</span><br><span class="line">    </span><br><span class="line">    extracted_watermark = np.clip(extracted_watermark, <span class="number">0</span>, <span class="number">255</span>).astype(np.uint8)</span><br><span class="line">    cv2.imwrite(<span class="string">&#x27;dwt_extracted_watermark.png&#x27;</span>, extracted_watermark)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;DWTæ°´å°æå–æˆåŠŸï¼&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- ä½¿ç”¨ç¤ºä¾‹ ---</span></span><br><span class="line"><span class="comment"># è¯·å‡†å¤‡ &#x27;original.png&#x27; å’Œ &#x27;watermark_logo.png&#x27;</span></span><br><span class="line"><span class="comment"># dwt_watermark_embed(&#x27;original.png&#x27;, &#x27;watermark_logo.png&#x27;, alpha=0.2)</span></span><br><span class="line"><span class="comment"># dwt_watermark_extract(&#x27;dwt_embedded_image.png&#x27;, &#x27;original.png&#x27;, alpha=0.2)</span></span><br></pre></td></tr></table></figure><hr><h3 id="4-å˜æ¢åŸŸ-Transform-Domain-DFT-ç®—æ³•">4. å˜æ¢åŸŸ (Transform Domain) - DFT ç®—æ³•</h3><p><strong>æ ¸å¿ƒåº“</strong>: <code>NumPy</code>, <code>OpenCV-Python (cv2)</code></p><p>DFTçš„å®ç°ä¸DCTç±»ä¼¼ï¼Œä½†é€šå¸¸ç”¨äºæŠµæŠ—å‡ ä½•æ”»å‡»ã€‚è¿™é‡Œæä¾›ä¸€ä¸ªåŸºç¡€çš„åµŒå…¥æ€è·¯ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dft_watermark_embed</span>(<span class="params">image_path, watermark_path, alpha=<span class="number">100</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åŸºäºDFTå¹…åº¦è°±åµŒå…¥æ°´å°&quot;&quot;&quot;</span></span><br><span class="line">    img = cv2.imread(image_path, cv2.IMREAD_GRAYSCALE)</span><br><span class="line">    watermark = cv2.imread(watermark_path, cv2.IMREAD_GRAYSCALE)</span><br><span class="line">    watermark = cv2.resize(watermark, (img.shape[<span class="number">1</span>], img.shape[<span class="number">0</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. DFTå˜æ¢</span></span><br><span class="line">    <span class="comment"># OpenCVçš„dftéœ€è¦è¾“å…¥float32ï¼Œå¹¶ä¼šè¾“å‡ºåŒé€šé“å¤æ•°ç»“æœ</span></span><br><span class="line">    dft = cv2.dft(np.float32(img), flags=cv2.DFT_COMPLEX_OUTPUT)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. å°†é¢‘è°±ä¸­å¿ƒç§»åˆ°å›¾åƒä¸­å¤®ï¼Œä¾¿äºè§‚å¯Ÿå’Œæ“ä½œ</span></span><br><span class="line">    dft_shift = np.fft.fftshift(dft)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. è®¡ç®—å¹…åº¦å’Œç›¸ä½è°±</span></span><br><span class="line">    magnitude_spectrum = cv2.magnitude(dft_shift[:,:,<span class="number">0</span>], dft_shift[:,:,<span class="number">1</span>])</span><br><span class="line">    phase_spectrum = cv2.phase(dft_shift[:,:,<span class="number">0</span>], dft_shift[:,:,<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4. åœ¨å¹…åº¦è°±ä¸Šæ·»åŠ æ°´å°</span></span><br><span class="line">    magnitude_spectrum_watermarked = magnitude_spectrum + alpha * watermark</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 5. æ ¹æ®æ–°çš„å¹…åº¦å’Œæ—§çš„ç›¸ä½ï¼Œé‡æ„DFTç»“æœ</span></span><br><span class="line">    real_part = magnitude_spectrum_watermarked * np.cos(phase_spectrum)</span><br><span class="line">    imag_part = magnitude_spectrum_watermarked * np.sin(phase_spectrum)</span><br><span class="line">    dft_shift_watermarked = cv2.merge([real_part, imag_part])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 6. å°†é¢‘è°±ä¸­å¿ƒç§»å›å·¦ä¸Šè§’</span></span><br><span class="line">    dft_watermarked = np.fft.ifftshift(dft_shift_watermarked)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 7. é€†DFTå˜æ¢</span></span><br><span class="line">    img_back = cv2.idft(dft_watermarked)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è·å–å®éƒ¨å¹¶æ¢å¤å›¾åƒ</span></span><br><span class="line">    img_back = cv2.magnitude(img_back[:,:,<span class="number">0</span>], img_back[:,:,<span class="number">1</span>])</span><br><span class="line">    </span><br><span class="line">    img_back = np.clip(img_back, <span class="number">0</span>, <span class="number">255</span>).astype(np.uint8)</span><br><span class="line">    cv2.imwrite(<span class="string">&#x27;dft_embedded_image.png&#x27;</span>, img_back)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;DFTæ°´å°åµŒå…¥æˆåŠŸï¼&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- ä½¿ç”¨ç¤ºä¾‹ ---</span></span><br><span class="line"><span class="comment"># è¯·å‡†å¤‡ &#x27;original.png&#x27; å’Œ &#x27;watermark_logo.png&#x27;</span></span><br><span class="line"><span class="comment"># dft_watermark_embed(&#x27;original.png&#x27;, &#x27;watermark_logo.png&#x27;, alpha=100)</span></span><br><span class="line"><span class="comment"># æå–DFTæ°´å°é€šå¸¸ä¹Ÿéœ€è¦åŸå§‹å›¾åƒï¼Œè¿‡ç¨‹ä¸DCT/DWTç±»ä¼¼ã€‚</span></span><br></pre></td></tr></table></figure><h3 id="å®‰è£…ä¾èµ–åº“">å®‰è£…ä¾èµ–åº“</h3><ul><li>pipå®‰è£…ï¼š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pillow numpy opencv-python pywavelets</span><br></pre></td></tr></table></figure><h2 id="demo">demo</h2><h3 id="æ°´å°ä¿¡æ¯åµŒå…¥ï¼ˆLSBï¼‰">æ°´å°ä¿¡æ¯åµŒå…¥ï¼ˆLSBï¼‰</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_message_to_binary</span>(<span class="params">message: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Converts a string message into its binary representation.&quot;&quot;&quot;</span></span><br><span class="line">    binary_message = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">format</span>(<span class="built_in">ord</span>(char), <span class="string">&#x27;08b&#x27;</span>) <span class="keyword">for</span> char <span class="keyword">in</span> message)</span><br><span class="line">    <span class="keyword">return</span> binary_message</span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_binary_to_message</span>(<span class="params">binary_message: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Converts a binary string back into a string message.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># Ensure the binary string is a multiple of 8</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(binary_message) % <span class="number">8</span> != <span class="number">0</span>:</span><br><span class="line">        logger.warning(<span class="string">&quot;Binary string length is not a multiple of 8; data may be incomplete.&quot;</span>)</span><br><span class="line">        binary_message = binary_message[:-(<span class="built_in">len</span>(binary_message) % <span class="number">8</span>)]</span><br><span class="line"></span><br><span class="line">    message = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(binary_message), <span class="number">8</span>):</span><br><span class="line">        byte = binary_message[i:i + <span class="number">8</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(byte) == <span class="number">8</span>:</span><br><span class="line">            message += <span class="built_in">chr</span>(<span class="built_in">int</span>(byte, <span class="number">2</span>))</span><br><span class="line">    <span class="keyword">return</span> message</span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode_lsb</span>(<span class="params">input_image_path: <span class="built_in">str</span>, secret_message: <span class="built_in">str</span>, output_image_path: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Encodes a secret message into an image using the LSB (Least Significant Bit) technique.</span></span><br><span class="line"><span class="string">    The output image will be saved in a lossless format (PNG) to preserve the watermark.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        input_image_path (str): The path to the source image.</span></span><br><span class="line"><span class="string">        secret_message (str): The message to hide.</span></span><br><span class="line"><span class="string">        output_image_path (str): The path to save the watermarked image.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        logger.info(<span class="string">f&quot;Starting LSB encoding for &#x27;<span class="subst">&#123;input_image_path&#125;</span>&#x27;...&quot;</span>)</span><br><span class="line">        image = Image.<span class="built_in">open</span>(input_image_path, <span class="string">&#x27;r&#x27;</span>).convert(<span class="string">&quot;RGBA&quot;</span>) <span class="comment"># Convert to RGBA for consistency</span></span><br><span class="line">        width, height = image.size</span><br><span class="line">        img_array = np.array(<span class="built_in">list</span>(image.getdata()))</span><br><span class="line"></span><br><span class="line">        channels = <span class="number">4</span>  <span class="comment"># We are using RGBA</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Add a unique delimiter to know where the message ends</span></span><br><span class="line">        binary_secret_message = _message_to_binary(secret_message + <span class="string">&quot;####&quot;</span>)</span><br><span class="line">        required_pixels = <span class="built_in">len</span>(binary_secret_message)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> required_pixels &gt; width * height * channels:</span><br><span class="line">            logger.error(<span class="string">&quot;Error: Message is too long to be encoded in this image.&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Modify the LSB of the pixel data</span></span><br><span class="line">        data_index = <span class="number">0</span></span><br><span class="line">        flat_array = img_array.flatten()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(flat_array)):</span><br><span class="line">            <span class="keyword">if</span> data_index &lt; required_pixels:</span><br><span class="line">                <span class="comment"># Change the LSB of the color value</span></span><br><span class="line">                flat_array[i] = <span class="built_in">int</span>(<span class="built_in">bin</span>(flat_array[i])[<span class="number">2</span>:-<span class="number">1</span>] + binary_secret_message[data_index], <span class="number">2</span>)</span><br><span class="line">                data_index += <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">break</span> <span class="comment"># Stop once the message is encoded</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Create a new image with the modified pixel data</span></span><br><span class="line">        encoded_image = Image.fromarray(flat_array.reshape(height, width, channels).astype(<span class="string">&#x27;uint8&#x27;</span>), image.mode)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Save as PNG to ensure lossless storage of the watermark</span></span><br><span class="line">        encoded_image.save(output_image_path, <span class="string">&quot;PNG&quot;</span>)</span><br><span class="line">        logger.info(<span class="string">f&quot;Successfully encoded message into &#x27;<span class="subst">&#123;output_image_path&#125;</span>&#x27;.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        logger.error(<span class="string">f&quot;Error: Input image not found at &#x27;<span class="subst">&#123;input_image_path&#125;</span>&#x27;.&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.exception(<span class="string">f&quot;An unexpected error occurred during encoding: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode_lsb</span>(<span class="params">encoded_image_path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span> | <span class="literal">None</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Decodes a secret message from an image using the LSB technique.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        encoded_image_path (str): The path to the watermarked image.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        The decoded secret message, or None if an error occurs or no message is found.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        logger.info(<span class="string">f&quot;Starting LSB decoding for &#x27;<span class="subst">&#123;encoded_image_path&#125;</span>&#x27;...&quot;</span>)</span><br><span class="line">        image = Image.<span class="built_in">open</span>(encoded_image_path, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">        img_array = np.array(<span class="built_in">list</span>(image.getdata()))</span><br><span class="line"></span><br><span class="line">        binary_data = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> pixel <span class="keyword">in</span> img_array:</span><br><span class="line">            <span class="keyword">for</span> value <span class="keyword">in</span> pixel:</span><br><span class="line">                binary_data += <span class="built_in">bin</span>(value)[-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Find the delimiter by decoding byte by byte</span></span><br><span class="line">        decoded_message = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(binary_data), <span class="number">8</span>):</span><br><span class="line">            byte = binary_data[i:i+<span class="number">8</span>]</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(byte) &lt; <span class="number">8</span>:</span><br><span class="line">                <span class="keyword">break</span> <span class="comment"># End of data</span></span><br><span class="line">            decoded_message += <span class="built_in">chr</span>(<span class="built_in">int</span>(byte, <span class="number">2</span>))</span><br><span class="line">            <span class="keyword">if</span> decoded_message.endswith(<span class="string">&quot;####&quot;</span>):</span><br><span class="line">                logger.info(<span class="string">&quot;Successfully decoded the message.&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> decoded_message[:-<span class="number">4</span>]  <span class="comment"># Return message without the delimiter</span></span><br><span class="line"></span><br><span class="line">        logger.warning(<span class="string">&quot;Could not find the end-of-message delimiter in the image.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        logger.error(<span class="string">f&quot;Error: Encoded image not found at &#x27;<span class="subst">&#123;encoded_image_path&#125;</span>&#x27;.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.exception(<span class="string">f&quot;An unexpected error occurred during decoding: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure><h3 id="æ°´å°ä¿¡æ¯éªŒè¯">æ°´å°ä¿¡æ¯éªŒè¯</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">valid_img_msg</span>(<span class="params">image_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Command-line tool to decode an invisible watermark from an image file.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    image_path = Path(image_path)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> image_path.is_file():</span><br><span class="line">        logger.debug(<span class="string">f&quot;Error: File not found at &#x27;<span class="subst">&#123;image_path&#125;</span>&#x27;&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    logger.debug(<span class="string">f&quot;Verifying &#x27;<span class="subst">&#123;image_path.name&#125;</span>&#x27;...&quot;</span>)</span><br><span class="line">    decoded_message = decode_lsb(<span class="built_in">str</span>(image_path))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> decoded_message:</span><br><span class="line">        logger.debug(<span class="string">&quot;\n--- âœ… Watermark Found! ---&quot;</span>)</span><br><span class="line">        <span class="comment"># Pretty logger.debug the decoded information</span></span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> decoded_message.split(<span class="string">&#x27;|&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;:&#x27;</span> <span class="keyword">in</span> item:</span><br><span class="line">                key, value = item.split(<span class="string">&#x27;:&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">                logger.debug(<span class="string">f&quot;  - <span class="subst">&#123;key.strip():&lt;<span class="number">15</span>&#125;</span>: <span class="subst">&#123;value.strip()&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                logger.debug(<span class="string">f&quot;  - <span class="subst">&#123;item&#125;</span>&quot;</span>)</span><br><span class="line">        logger.debug(<span class="string">&quot;--------------------------\n&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.debug(<span class="string">&quot;\n--- âŒ No Watermark Found ---&quot;</span>)</span><br><span class="line">        logger.debug(<span class="string">&quot;No hidden message could be decoded from this image.&quot;</span>)</span><br><span class="line">        logger.debug(<span class="string">&quot;--------------------------\n&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> decoded_message</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="æ°´å°ä¿¡æ¯åµŒå…¥ï¼ˆEXIFï¼‰">æ°´å°ä¿¡æ¯åµŒå…¥ï¼ˆEXIFï¼‰</h3> <figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> piexif</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ UserComment çš„æ ‡å‡†å‰ç¼€ï¼ŒUNDEFINED è¡¨ç¤ºæœªå®šä¹‰ç¼–ç ï¼Œå…è®¸æˆ‘ä»¬ä½¿ç”¨ UTF-8ã€‚</span></span><br><span class="line"><span class="comment"># è¿™æ˜¯ç¬¦åˆ EXIF è§„èŒƒçš„æ¨èåšæ³•ã€‚</span></span><br><span class="line">USER_COMMENT_PREFIX = <span class="string">b&#x27;UNDEFINED\x00&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode_exif</span>(<span class="params">input_image_path: <span class="built_in">str</span>, secret_message: <span class="built_in">str</span>, output_image_path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    å°†ç§˜å¯†ä¿¡æ¯ä½œä¸ºéšå½¢æ°´å°ç¼–ç åˆ°å›¾ç‰‡çš„EXIFå…ƒæ•°æ®ä¸­ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        input_image_path: è¾“å…¥å›¾ç‰‡çš„è·¯å¾„ã€‚</span></span><br><span class="line"><span class="string">        secret_message: è¦éšè—çš„ä¿¡æ¯ã€‚</span></span><br><span class="line"><span class="string">        output_image_path: ä¿å­˜å¸¦æ°´å°å›¾ç‰‡çš„è·¯å¾„ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        å¦‚æœç¼–ç æˆåŠŸï¼Œè¿”å› Trueï¼Œå¦åˆ™è¿”å› Falseã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        logger.info(<span class="string">f&quot;æ­£åœ¨ä¸º &#x27;<span class="subst">&#123;Path(input_image_path).name&#125;</span>&#x27; æ·»åŠ EXIFæ°´å°...&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ‰“å¼€å›¾ç‰‡</span></span><br><span class="line">        image = Image.<span class="built_in">open</span>(input_image_path)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å¤åˆ¶åŸå§‹å›¾ç‰‡ä¿¡æ¯ï¼Œä»¥ä¾¿åœ¨ä¿å­˜æ—¶ä¿ç•™è´¨é‡ã€DPIç­‰è®¾ç½®</span></span><br><span class="line">        image_info = image.info.copy()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ£€æŸ¥å›¾ç‰‡æ˜¯å¦å·²æœ‰EXIFæ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºä¸€ä¸ªç©ºçš„</span></span><br><span class="line">        exif_dict = &#123;&#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;exif&quot;</span> <span class="keyword">in</span> image_info <span class="keyword">and</span> image_info[<span class="string">&#x27;exif&#x27;</span>]:</span><br><span class="line">            exif_dict = piexif.load(image_info[<span class="string">&quot;exif&quot;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># [FIXED] ç¡®ä¿ &#x27;Exif&#x27; å­å­—å…¸å­˜åœ¨ï¼Œé˜²æ­¢ KeyError</span></span><br><span class="line">        <span class="keyword">if</span> piexif.ImageIFD.ExifPtr <span class="keyword">not</span> <span class="keyword">in</span> exif_dict:</span><br><span class="line">             exif_dict[<span class="string">&#x27;Exif&#x27;</span>] = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># [FIXED] å°†ç§˜å¯†ä¿¡æ¯ç¼–ç å¹¶æ·»åŠ æ ‡å‡†å‰ç¼€ï¼Œç„¶åæ”¾å…¥ UserComment å­—æ®µ</span></span><br><span class="line">        <span class="comment"># è¿™æ˜¯å­˜å‚¨ä»»æ„ç”¨æˆ·æ•°æ®çš„æ ‡å‡†å­—æ®µ</span></span><br><span class="line">        user_comment_payload = USER_COMMENT_PREFIX + secret_message.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        exif_dict[<span class="string">&#x27;Exif&#x27;</span>][piexif.ExifIFD.UserComment] = user_comment_payload</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å°†æ›´æ–°åçš„EXIFå­—å…¸è½¬æ¢ä¸ºå­—èŠ‚æµ</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            exif_bytes = piexif.dump(exif_dict)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># æœ‰æ—¶ EXIF æ•°æ®å¯èƒ½åŒ…å« piexif ä¸æ”¯æŒçš„æ ¼å¼</span></span><br><span class="line">            logger.error(<span class="string">f&quot;æ— æ³•åºåˆ—åŒ– EXIF æ•°æ®: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># å°è¯•ç§»é™¤å¯èƒ½å¯¼è‡´é—®é¢˜çš„ç¼©ç•¥å›¾æ•°æ®</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;thumbnail&#x27;</span> <span class="keyword">in</span> exif_dict:</span><br><span class="line">                <span class="keyword">del</span> exif_dict[<span class="string">&#x27;thumbnail&#x27;</span>]</span><br><span class="line">                exif_bytes = piexif.dump(exif_dict)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># [FIXED] ä¿å­˜å›¾ç‰‡ï¼Œå¹¶é™„ä¸Šæ–°çš„EXIFæ•°æ®</span></span><br><span class="line">        <span class="comment"># å¯¹äº JPEGï¼Œä¼ é€’åŸå§‹ info å­—å…¸ä»¥ä¿ç•™è´¨é‡ç­‰è®¾ç½®</span></span><br><span class="line">        <span class="comment"># å¯¹äº PNG ç­‰å…¶ä»–æ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨ exif å‚æ•°</span></span><br><span class="line">        <span class="keyword">if</span> image.<span class="built_in">format</span> == <span class="string">&#x27;JPEG&#x27;</span>:</span><br><span class="line">            image.save(output_image_path, <span class="string">&quot;jpeg&quot;</span>, exif=exif_bytes, **image_info)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            image.save(output_image_path, exif=exif_bytes)</span><br><span class="line"></span><br><span class="line">        logger.success(<span class="string">f&quot;æˆåŠŸå°†EXIFæ°´å°å†™å…¥ &#x27;<span class="subst">&#123;Path(output_image_path).name&#125;</span>&#x27;.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        logger.error(<span class="string">f&quot;è¾“å…¥æ–‡ä»¶æœªæ‰¾åˆ°: <span class="subst">&#123;input_image_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.exception(<span class="string">f&quot;æ·»åŠ EXIFæ°´å°æ—¶å‘ç”Ÿé”™è¯¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode_exif</span>(<span class="params">encoded_image_path: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">str</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ä»å›¾ç‰‡çš„EXIFå…ƒæ•°æ®ä¸­è§£ç å‡ºéšè—çš„ç§˜å¯†ä¿¡æ¯ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        encoded_image_path: å¸¦æ°´å°å›¾ç‰‡çš„è·¯å¾„ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        è§£ç åçš„ä¿¡æ¯å­—ç¬¦ä¸²ï¼Œå¦‚æœæœªæ‰¾åˆ°æˆ–å‘ç”Ÿé”™è¯¯åˆ™è¿”å› Noneã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        logger.info(<span class="string">f&quot;æ­£åœ¨ä» &#x27;<span class="subst">&#123;Path(encoded_image_path).name&#125;</span>&#x27; è§£ç EXIFæ°´å°...&quot;</span>)</span><br><span class="line"></span><br><span class="line">        image = Image.<span class="built_in">open</span>(encoded_image_path)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ£€æŸ¥å›¾ç‰‡æ˜¯å¦æœ‰EXIFæ•°æ®</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;exif&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> image.info <span class="keyword">or</span> <span class="keyword">not</span> image.info[<span class="string">&#x27;exif&#x27;</span>]:</span><br><span class="line">            logger.warning(<span class="string">&quot;å›¾ç‰‡ä¸­æœªæ‰¾åˆ°EXIFæ•°æ®ã€‚&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># åŠ è½½EXIFæ•°æ®</span></span><br><span class="line">        exif_dict = piexif.load(image.info[<span class="string">&quot;exif&quot;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># [FIXED] å®‰å…¨åœ°ä» UserComment å­—æ®µè¯»å–ä¿¡æ¯ï¼Œé˜²æ­¢ KeyError</span></span><br><span class="line">        exif_ifd = exif_dict.get(<span class="string">&#x27;Exif&#x27;</span>, &#123;&#125;)</span><br><span class="line">        user_comment_bytes = exif_ifd.get(piexif.ExifIFD.UserComment)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> user_comment_bytes:</span><br><span class="line">            <span class="comment"># [FIXED] æ£€æŸ¥æ˜¯å¦å­˜åœ¨æˆ‘ä»¬å®šä¹‰çš„å‰ç¼€ï¼Œå¹¶å‰¥ç¦»å®ƒ</span></span><br><span class="line">            <span class="keyword">if</span> user_comment_bytes.startswith(USER_COMMENT_PREFIX):</span><br><span class="line">                message_bytes = user_comment_bytes[<span class="built_in">len</span>(USER_COMMENT_PREFIX):]</span><br><span class="line">                <span class="comment"># å°†å­—èŠ‚è§£ç å›å­—ç¬¦ä¸²</span></span><br><span class="line">                decoded_message = message_bytes.decode(<span class="string">&#x27;utf-8&#x27;</span>, errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">                logger.success(<span class="string">&quot;æˆåŠŸè§£ç EXIFæ°´å°ã€‚&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> decoded_message</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                logger.warning(<span class="string">&quot;åœ¨&#x27;UserComment&#x27;å­—æ®µä¸­æ‰¾åˆ°æ•°æ®ï¼Œä½†ä¸åŒ…å«é¢„æœŸçš„æ°´å°å‰ç¼€ã€‚&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logger.warning(<span class="string">&quot;åœ¨EXIFä¸­æœªæ‰¾åˆ°&#x27;UserComment&#x27;æ°´å°å­—æ®µã€‚&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        logger.error(<span class="string">f&quot;æ–‡ä»¶æœªæ‰¾åˆ°: <span class="subst">&#123;encoded_image_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.exception(<span class="string">f&quot;è§£ç EXIFæ°´å°æ—¶å‘ç”Ÿé”™è¯¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="æŠ€æœ¯æ€»ç»“å¯¹æ¯”">æŠ€æœ¯æ€»ç»“å¯¹æ¯”</h3><table><thead><tr><th style="text-align:left">æŠ€æœ¯ç±»åˆ«</th><th style="text-align:left">æ ¸å¿ƒç®—æ³•</th><th style="text-align:left">ä¸»è¦ä¼˜ç‚¹</th><th style="text-align:left">ä¸»è¦ç¼ºç‚¹</th><th style="text-align:left">å…¸å‹åº”ç”¨</th></tr></thead><tbody><tr><td style="text-align:left"><strong>ç©ºåŸŸ (Spatial Domain)</strong></td><td style="text-align:left"><strong>LSB</strong></td><td style="text-align:left">å®ç°ç®€å•ã€å®¹é‡å¤§</td><td style="text-align:left"><strong>é²æ£’æ€§æå·®</strong>ï¼Œä¸€ç¢°å°±å</td><td style="text-align:left"><strong>å®Œæ•´æ€§è®¤è¯ (è„†å¼±æ°´å°)</strong></td></tr><tr><td style="text-align:left"><strong>å˜æ¢åŸŸ (Transform Domain)</strong></td><td style="text-align:left"><strong>DCT</strong></td><td style="text-align:left"><strong>å¯¹å‹ç¼©é²æ£’</strong>ã€éšè”½æ€§å¥½</td><td style="text-align:left">å¯¹å‡ ä½•æ”»å‡»æŠµæŠ—åŠ›ä¸€èˆ¬</td><td style="text-align:left"><strong>ç‰ˆæƒä¿æŠ¤ (é²æ£’æ°´å°)</strong></td></tr><tr><td style="text-align:left"><strong>å˜æ¢åŸŸ (Transform Domain)</strong></td><td style="text-align:left"><strong>DWT</strong></td><td style="text-align:left"><strong>ç»¼åˆé²æ£’æ€§å¼º</strong>ï¼Œå°¤å…¶å¯¹è£å‰ªç­‰</td><td style="text-align:left">ç®—æ³•æ¯”DCTå¤æ‚</td><td style="text-align:left"><strong>ç‰ˆæƒä¿æŠ¤ (é²æ£’æ°´å°)</strong></td></tr><tr><td style="text-align:left"><strong>å˜æ¢åŸŸ (Transform Domain)</strong></td><td style="text-align:left"><strong>DFT</strong></td><td style="text-align:left"><strong>å¯¹æ—‹è½¬/ç¼©æ”¾é²æ£’</strong></td><td style="text-align:left">å®ç°å¤æ‚ï¼Œå¯èƒ½å½±å“ç”»è´¨</td><td style="text-align:left"><strong>æŠµæŠ—å‡ ä½•æ”»å‡»çš„ç‰¹æ®Šåº”ç”¨</strong></td></tr></tbody></table><p>ç®€å•æ¥è¯´ï¼š</p><ul><li>æƒ³åš<strong>é˜²ä¼ªæ ‡ç­¾</strong>ï¼Œä¸€æ”¹å°±å¤±æ•ˆï¼Œç”¨ <strong>LSB</strong>ã€‚</li><li>æƒ³åš<strong>ç‰ˆæƒå°ç« </strong>ï¼Œä¸æ€•å‹ç¼©å’ŒåŸºæœ¬å¤„ç†ï¼Œç”¨ <strong>DCT</strong> æˆ– <strong>DWT</strong>ã€‚å®ƒä»¬æ˜¯ç›®å‰æœ€å®ç”¨å’Œæœ€ä¸»æµçš„é²æ£’æ°´å°æŠ€æœ¯ã€‚</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker éƒ¨ç½² Tailscale</title>
      <link href="/2025/07/17/tailscale-docker-build/"/>
      <url>/2025/07/17/tailscale-docker-build/</url>
      
        <content type="html"><![CDATA[<h2 id="ç®€ä»‹">ç®€ä»‹</h2><h3 id="ä¸€ã€Tailscale-åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ">ä¸€ã€Tailscale åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>ä½ å¯ä»¥æŠŠå®ƒç†è§£æˆä¸€ä¸ª**â€œä¸ºä½ æ‰€æœ‰è®¾å¤‡æ‰“é€ çš„ã€ç§äººçš„ã€åŠ å¯†çš„è™šæ‹Ÿå±€åŸŸç½‘â€**ã€‚</p><ul><li><strong>ä¼ ç»Ÿçš„VPN</strong>ï¼šåƒæ˜¯åœ¨ä½ å®¶ï¼ˆå±€åŸŸç½‘ï¼‰å’Œå…¬å¸ï¼ˆå¦ä¸€ä¸ªå±€åŸŸç½‘ï¼‰ä¹‹é—´æŒ–äº†ä¸€æ¡ç§˜å¯†éš§é“ã€‚</li><li><strong>Tailscale</strong>ï¼šæ›´åƒæ˜¯ç»™ä½ çš„æ¯ä¸€å°è®¾å¤‡ï¼ˆNASã€ç”µè„‘ã€æ‰‹æœºã€å¹³æ¿ï¼‰éƒ½ç©¿ä¸Šäº†ä¸€ä»¶â€œéšèº«è¡£â€ï¼Œå¹¶ç»™å®ƒä»¬ä¸€ä¸ªç§˜å¯†çš„è”ç»œæš—å·ã€‚æ— è®ºè¿™äº›è®¾å¤‡èº«å¤„ä¸–ç•Œä½•åœ°ï¼Œåªè¦å®ƒä»¬éƒ½ç©¿ç€è¿™ä»¶â€œéšèº«è¡£â€ï¼ˆå®‰è£…äº† Tailscale å®¢æˆ·ç«¯å¹¶ç”¨åŒä¸€è´¦å·ç™»å½•ï¼‰ï¼Œå®ƒä»¬å°±èƒ½äº’ç›¸çœ‹è§ã€äº’ç›¸é€šä¿¡ï¼Œä»¿ä½›å°±åœ¨åŒä¸€ä¸ªæˆ¿é—´é‡Œã€‚</li></ul><p>è¿™ä¸ªâ€œè™šæ‹Ÿå±€åŸŸç½‘â€æ˜¯å»ºç«‹åœ¨äº’è”ç½‘ä¹‹ä¸Šçš„ï¼Œä½†å®ƒåˆæ˜¯å®Œå…¨éš”ç¦»å’ŒåŠ å¯†çš„ï¼Œå¤–ç•Œæ— æ³•çª¥æ¢ã€‚</p><h3 id="äºŒã€å®ƒå¦‚ä½•è§£å†³ä½ çš„-NAS-å¤–é“¾é—®é¢˜ï¼Ÿ">äºŒã€å®ƒå¦‚ä½•è§£å†³ä½ çš„ NAS å¤–é“¾é—®é¢˜ï¼Ÿ</h3><p>Tailscale é€šè¿‡ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒåŠŸèƒ½æ¥è§£å†³ä½ çš„é—®é¢˜ï¼š</p><ol><li><strong>ç¨³å®šçš„è™šæ‹Ÿ IP åœ°å€</strong>ï¼šä¸€æ—¦ä½ çš„ NAS åŠ å…¥äº† Tailscale ç½‘ç»œï¼Œå®ƒä¼šè¢«åˆ†é…ä¸€ä¸ª <code>100.x.x.x</code> å¼€å¤´çš„ã€ç‹¬ä¸€æ— äºŒä¸”å›ºå®šçš„ IP åœ°å€ã€‚ä½ å†ä¹Ÿä¸ç”¨å…³å¿ƒå®¶é‡Œå®½å¸¦çš„å…¬ç½‘ IP æ˜¯ä¸æ˜¯å˜äº†ã€‚</li><li><strong>é›¶é…ç½®ç©¿é€ (Zero-config NAT traversal)</strong>ï¼šä½ ä¸éœ€è¦åœ¨è·¯ç”±å™¨ä¸Šåšä»»ä½•ç«¯å£è½¬å‘ã€‚Tailscale ä¼šè‡ªåŠ¨æƒ³åŠæ³•åœ¨ä½ çš„è®¾å¤‡ä¹‹é—´â€œæ‰“æ´â€ï¼Œå»ºç«‹ç‚¹å¯¹ç‚¹ï¼ˆP2Pï¼‰çš„åŠ å¯†è¿æ¥ã€‚è¿™æ„å‘³ç€æ•°æ®ä¼ è¾“é€Ÿåº¦å¾ˆå¿«ï¼Œå› ä¸ºå¤§éƒ¨åˆ†æ—¶é—´æ•°æ®æ˜¯ç›´è¿çš„ï¼Œä¸ç»è¿‡ç¬¬ä¸‰æ–¹æœåŠ¡å™¨ä¸­è½¬ã€‚</li><li><strong>æé«˜çš„å®‰å…¨æ€§</strong>ï¼šå®ƒåŸºäºç›®å‰æœ€å…ˆè¿›çš„ VPN åè®® <strong>WireGuardÂ®</strong> æ„å»ºï¼Œæ‰€æœ‰é€šä¿¡éƒ½æ˜¯ç«¯åˆ°ç«¯åŠ å¯†çš„ã€‚å› ä¸ºä½ æ²¡æœ‰åœ¨è·¯ç”±å™¨ä¸Šå¼€æ”¾ä»»ä½•ç«¯å£ï¼Œæ‰€ä»¥ä½ çš„ NAS ä¸ä¼šæš´éœ²åœ¨å…¬ç½‘ä¸Šï¼Œå¤§å¤§é™ä½äº†è¢«é»‘å®¢æ‰«æå’Œæ”»å‡»çš„é£é™©ã€‚</li><li><strong>è®¾å¤‡é—´çš„æ— ç¼è®¿é—®</strong>ï¼šåªè¦ä½ çš„ç”µè„‘æˆ–æ‰‹æœºä¹Ÿå®‰è£…å¹¶ç™»å½•äº† Tailscaleï¼Œä½ å°±å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ï¼Œç›´æ¥é€šè¿‡ NAS çš„é‚£ä¸ª <code>100.x.x.x</code> è™šæ‹Ÿ IP æ¥è®¿é—®å®ƒçš„ç®¡ç†é¡µé¢ã€File Station ç­‰æ‰€æœ‰æœåŠ¡ï¼Œä½“éªŒå’Œåœ¨å®¶é‡Œä¸€æ¨¡ä¸€æ ·ã€‚</li></ol><h2 id="éƒ¨ç½²">éƒ¨ç½²</h2><h3 id="éƒ¨ç½²æ–¹å¼ä¸€ï¼šä½¿ç”¨-docker-run-å‘½ä»¤ï¼ˆå•æ¬¡éƒ¨ç½²ï¼‰">éƒ¨ç½²æ–¹å¼ä¸€ï¼šä½¿ç”¨ <code>docker run</code> å‘½ä»¤ï¼ˆå•æ¬¡éƒ¨ç½²ï¼‰</h3><p>è¿™æ˜¯æœ€ç›´æ¥çš„æ–¹å¼ï¼Œé€‚åˆå¿«é€Ÿå¯åŠ¨ã€‚</p><h4 id="æ­¥éª¤-1ï¼šå‡†å¤‡æŒä¹…åŒ–ç›®å½•">æ­¥éª¤ 1ï¼šå‡†å¤‡æŒä¹…åŒ–ç›®å½•</h4><p>ä¸ºäº†è®© Tailscale çš„çŠ¶æ€ï¼ˆä¸»è¦æ˜¯å®ƒçš„èº«ä»½å¯†é’¥ï¼‰åœ¨å®¹å™¨é‡å¯åä¸ä¸¢å¤±ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ªç›®å½•æ¥æŒä¹…åŒ–å­˜å‚¨å®ƒã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é€šè¿‡ SSH ç™»å½•åˆ°ä½ çš„ NAS æˆ–æœåŠ¡å™¨</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /path/to/your/appdata/tailscale</span><br><span class="line"><span class="comment"># æ³¨æ„ï¼šè¯·å°† /path/to/your/appdata æ›¿æ¢ä¸ºä½ è‡ªå·±å­˜æ”¾åº”ç”¨æ•°æ®çš„å®é™…è·¯å¾„</span></span><br><span class="line"><span class="comment"># ä¾‹å¦‚ï¼Œåœ¨ç¾¤æ™–ä¸Šå¯èƒ½æ˜¯ /volume1/docker/tailscale</span></span><br></pre></td></tr></table></figure><h4 id="æ­¥éª¤-2ï¼šè¿è¡Œ-Docker-å®¹å™¨">æ­¥éª¤ 2ï¼šè¿è¡Œ Docker å®¹å™¨</h4><p>å¤åˆ¶å¹¶æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ã€‚è¿™æ¡å‘½ä»¤å·²ç»åŒ…å«äº†è¿è¡Œ Tailscale æ‰€éœ€çš„æ‰€æœ‰å…³é”®é…ç½®ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  --name=tailscaled \</span><br><span class="line">  -v /path/to/your/appdata/tailscale:/var/lib/tailscale \</span><br><span class="line">  -v /dev/net/tun:/dev/net/tun \</span><br><span class="line">  --network=host \</span><br><span class="line">  --cap-add=NET_ADMIN \</span><br><span class="line">  --cap-add=NET_RAW \</span><br><span class="line">  --restart unless-stopped \</span><br><span class="line">  tailscale/tailscale</span><br></pre></td></tr></table></figure><p><strong>å‘½ä»¤å‚æ•°è¯¦è§£ï¼š</strong></p><ul><li><code>docker run -d</code>: åœ¨åå°ï¼ˆdetached modeï¼‰è¿è¡Œå®¹å™¨ã€‚</li><li><code>--name=tailscaled</code>: ç»™å®¹å™¨èµ·ä¸€ä¸ªå¥½è®°çš„åå­—ï¼Œæ–¹ä¾¿ç®¡ç†ã€‚</li><li><code>-v /path/to/your/appdata/tailscale:/var/lib/tailscale</code>: <strong>ã€æ ¸å¿ƒã€‘</strong> å°†ä¸»æœºä¸Šçš„ç›®å½•æŒ‚è½½åˆ°å®¹å™¨å†…ï¼Œç”¨äºä¿å­˜ Tailscale çš„çŠ¶æ€ã€‚<strong>åŠ¡å¿…æ›¿æ¢ä¸ºä½ è‡ªå·±çš„è·¯å¾„</strong>ã€‚</li><li><code>-v /dev/net/tun:/dev/net/tun</code>: å°†ä¸»æœºçš„ TUN è®¾å¤‡æŒ‚è½½åˆ°å®¹å™¨å†…ï¼Œè¿™æ˜¯ Tailscale åˆ›å»ºè™šæ‹Ÿç½‘å¡æ‰€å¿…éœ€çš„ã€‚</li><li><code>--network=host</code>: <strong>ã€æ ¸å¿ƒã€‘</strong> è®©å®¹å™¨ç›´æ¥ä½¿ç”¨ä¸»æœºçš„ç½‘ç»œï¼Œè¿™æ˜¯æœ€ç®€å•ä¸”åŠŸèƒ½æœ€å…¨çš„æ¨¡å¼ã€‚å®¹å™¨å¯ä»¥è½»æ¾è®¿é—®ä¸»æœºçš„æ‰€æœ‰ç«¯å£ï¼Œä¹Ÿæ–¹ä¾¿å°†ä¸»æœºä½œä¸ºå­ç½‘è·¯ç”±ï¼ˆSubnet Routerï¼‰ã€‚</li><li><code>--cap-add=NET_ADMIN --cap-add=NET_RAW</code>: æˆäºˆå®¹å™¨æ“ä½œç½‘ç»œæ¥å£æ‰€éœ€çš„ Linux Capabilities æƒé™ã€‚</li><li><code>--restart unless-stopped</code>: è®¾ç½®å®¹å™¨çš„é‡å¯ç­–ç•¥ï¼Œé™¤éæ‰‹åŠ¨åœæ­¢ï¼Œå¦åˆ™ Docker é‡å¯æ—¶ä¼šè‡ªåŠ¨å¯åŠ¨è¯¥å®¹å™¨ã€‚</li><li><code>tailscale/tailscale</code>: æŒ‡å®šè¦ä½¿ç”¨çš„å®˜æ–¹ Docker é•œåƒã€‚</li></ul><h4 id="æ­¥éª¤-3ï¼šå°†-NAS-åŠ å…¥ä½ çš„-Tailscale-ç½‘ç»œ">æ­¥éª¤ 3ï¼šå°† NAS åŠ å…¥ä½ çš„ Tailscale ç½‘ç»œ</h4><p>å®¹å™¨å·²ç»åœ¨è¿è¡Œäº†ï¼Œä½†å®ƒè¿˜ä¸çŸ¥é“è‡ªå·±æ˜¯è°ã€‚æˆ‘ä»¬éœ€è¦æ‰§è¡Œä¸€æ¡å‘½ä»¤æ¥è®©å®ƒç™»å½•ã€‚</p><ol><li><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå¯åŠ¨ Tailscale å¹¶è·å–ç™»å½•é“¾æ¥ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> tailscaled tailscale up</span><br></pre></td></tr></table></figure></li><li><p>å‘½ä»¤æ‰§è¡Œåï¼Œç»ˆç«¯ä¼šè¾“å‡ºä¸€ä¸ªç™»å½• URLï¼Œçœ‹èµ·æ¥åƒè¿™æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">To authenticate, visit:</span><br><span class="line"></span><br><span class="line">    https://login.tailscale.com/a/123456789ABC</span><br></pre></td></tr></table></figure></li><li><p>å¤åˆ¶è¿™ä¸ª URLï¼Œåœ¨ä½ çš„ç”µè„‘æµè§ˆå™¨ä¸­æ‰“å¼€ï¼Œç”¨ä½ çš„ Tailscale è´¦æˆ·ç™»å½•å¹¶æˆæƒè¿™å°æ–°è®¾å¤‡ã€‚</p></li><li><p>æˆæƒæˆåŠŸåï¼Œå›åˆ°ä½ çš„ <a href="https://login.tailscale.com/admin/machines">Tailscale Admin Console</a> åå°ï¼Œä½ å°±èƒ½çœ‹åˆ°è¿™å°æ–°è®¾å¤‡å·²ç»åŠ å…¥äº†ä½ çš„ç½‘ç»œã€‚</p></li></ol><p><strong>è‡³æ­¤ï¼Œä½ çš„ NAS å·²ç»æˆåŠŸé€šè¿‡ Docker åŠ å…¥äº† Tailscale ç½‘ç»œï¼</strong> ä½ å¯ä»¥åœ¨ä»»ä½•å…¶ä»–å·²ç™»å½• Tailscale çš„è®¾å¤‡ä¸Šï¼Œé€šè¿‡åˆ†é…çš„ <code>100.x.x.x</code> IP åœ°å€æ¥è®¿é—®ä½ çš„ NASã€‚</p><hr><h3 id="éƒ¨ç½²æ–¹å¼äºŒï¼šä½¿ç”¨-docker-composeï¼ˆæ¨èï¼Œä¾¿äºç®¡ç†ï¼‰">éƒ¨ç½²æ–¹å¼äºŒï¼šä½¿ç”¨ <code>docker-compose</code>ï¼ˆæ¨èï¼Œä¾¿äºç®¡ç†ï¼‰</h3><p>å¦‚æœä½ éœ€è¦ç®¡ç†å¤šä¸ªå®¹å™¨ï¼Œæˆ–è€…å¸Œæœ›å°†é…ç½®ä»¥æ–‡ä»¶å½¢å¼ä¿å­˜ä¸‹æ¥ï¼Œ<code>docker-compose</code> æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚</p><h4 id="æ­¥éª¤-1ï¼šåˆ›å»º-docker-compose-yml-æ–‡ä»¶">æ­¥éª¤ 1ï¼šåˆ›å»º <code>docker-compose.yml</code> æ–‡ä»¶</h4><p>åœ¨ä½ å–œæ¬¢çš„ä½ç½®ï¼ˆä¾‹å¦‚ <code>/volume1/docker/tailscale</code>ï¼‰åˆ›å»ºä¸€ä¸ªåä¸º <code>docker-compose.yml</code> çš„æ–‡ä»¶ï¼Œå¹¶å°†ä»¥ä¸‹å†…å®¹ç²˜è´´è¿›å»ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.7&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">tailscaled:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tailscale/tailscale</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">tailscaled</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">my-nas</span> <span class="comment"># åœ¨ Tailscale ç®¡ç†åå°æ˜¾ç¤ºçš„è®¾å¤‡å</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data:/var/lib/tailscale</span> <span class="comment"># å°†çŠ¶æ€ä¿å­˜åœ¨å½“å‰ç›®å½•ä¸‹çš„ data æ–‡ä»¶å¤¹</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/dev/net/tun:/dev/net/tun</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">cap_add:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">NET_ADMIN</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">NET_RAW</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„ï¼š</strong></p><ul><li><code>hostname</code>: ä½ å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªåå­—ï¼Œè¿™æ ·åœ¨ Tailscale åå°ä¸€çœ¼å°±èƒ½è®¤å‡ºæ˜¯å“ªå°è®¾å¤‡ã€‚</li><li><code>volumes</code>: <code>- ./data:/var/lib/tailscale</code> è¿™ç§ç›¸å¯¹è·¯å¾„çš„å†™æ³•è¡¨ç¤ºå°†çŠ¶æ€æ–‡ä»¶ä¿å­˜åœ¨ <code>docker-compose.yml</code> æ–‡ä»¶åŒçº§çš„ <code>data</code> æ–‡ä»¶å¤¹å†…ï¼Œéå¸¸æ–¹ä¾¿ã€‚</li></ul><h4 id="æ­¥éª¤-2ï¼šå¯åŠ¨æœåŠ¡">æ­¥éª¤ 2ï¼šå¯åŠ¨æœåŠ¡</h4><p>åœ¨ <code>docker-compose.yml</code> æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ä¸­ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure><h4 id="æ­¥éª¤-3ï¼šç™»å½•å’Œæˆæƒ">æ­¥éª¤ 3ï¼šç™»å½•å’Œæˆæƒ</h4><p>è¿™ä¸€æ­¥å’Œ <code>docker run</code> æ–¹å¼å®Œå…¨ä¸€æ ·ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose <span class="built_in">exec</span> tailscaled tailscale up</span><br></pre></td></tr></table></figure><p>ç„¶åå¤åˆ¶è¾“å‡ºçš„ URL åˆ°æµè§ˆå™¨å®Œæˆæˆæƒã€‚</p><hr><h3 id="é«˜çº§åŠŸèƒ½ï¼šå¦‚ä½•ç”Ÿæˆå¤–é“¾å’Œè®¿é—®å†…ç½‘ï¼Ÿ">é«˜çº§åŠŸèƒ½ï¼šå¦‚ä½•ç”Ÿæˆå¤–é“¾å’Œè®¿é—®å†…ç½‘ï¼Ÿ</h3><p>éƒ¨ç½²æˆåŠŸåï¼Œä½ å¯ä»¥åˆ©ç”¨ Tailscale çš„é«˜çº§åŠŸèƒ½æ¥å®ç°æœ€åˆçš„ç›®æ ‡ã€‚</p><h4 id="1-å°†-NAS-ä½œä¸ºå­ç½‘è·¯ç”±-Subnet-Router">1. å°† NAS ä½œä¸ºå­ç½‘è·¯ç”± (Subnet Router)</h4><p><strong>åœºæ™¯</strong>ï¼šä½ æƒ³é€šè¿‡æ‰‹æœºï¼ˆå·²è¿æ¥ Tailscaleï¼‰è®¿é—®ä½ å®¶é‡Œçš„å…¶ä»–è®¾å¤‡ï¼Œæ¯”å¦‚æ‰“å°æœº (<code>192.168.1.100</code>)ã€‚</p><ol><li><p>ä¿®æ”¹å¯åŠ¨å‘½ä»¤ï¼Œä½¿å…¶â€œå®£å‘Šâ€å®ƒå¯ä»¥è·¯ç”±çš„å†…ç½‘ç½‘æ®µã€‚åœ¨æ‰§è¡Œ <code>tailscale up</code> æ—¶åŠ å…¥ <code>--advertise-routes</code> å‚æ•°ã€‚</p><ul><li>ä½ éœ€è¦å…ˆ <code>down</code> å† <code>up</code>ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> tailscaled tailscale down</span><br><span class="line">docker <span class="built_in">exec</span> tailscaled tailscale up --advertise-routes=192.168.1.0/24</span><br><span class="line"><span class="comment"># !!! å°† 192.168.1.0/24 æ›¿æ¢ä¸ºä½ è‡ªå·±çš„å±€åŸŸç½‘ç½‘æ®µ !!!</span></span><br><span class="line">docker <span class="built_in">exec</span> tailscaled tailscale up --advertise-routes=192.168.10.0/24 -accept-dns=<span class="literal">false</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>åœ¨ Tailscale Admin Console åå°ï¼Œæ‰¾åˆ°ä½ çš„ NAS è®¾å¤‡ï¼Œç‚¹å‡»å³ä¾§çš„ â€œâ€¦â€ï¼Œé€‰æ‹© â€œEdit route settingsâ€¦â€ã€‚</p></li><li><p>å‹¾é€‰å¹¶å¯ç”¨ä½ åˆšåˆšå®£å‘Šçš„å­ç½‘è·¯ç”±ã€‚</p></li></ol><p>ç°åœ¨ï¼Œä½ ä»»ä½•è¿æ¥äº† Tailscale çš„è®¾å¤‡ï¼Œéƒ½å¯ä»¥ç›´æ¥è®¿é—® <code>192.168.1.x</code> ç½‘æ®µçš„æ‰€æœ‰è®¾å¤‡äº†ï¼Œå°±åƒåœ¨å®¶ä¸€æ ·ã€‚</p><h4 id="2-ä½¿ç”¨-Tailscale-Funnel-ç”Ÿæˆå¤–é“¾">2. ä½¿ç”¨ Tailscale Funnel ç”Ÿæˆå¤–é“¾</h4><p><strong>åœºæ™¯</strong>ï¼šä½ æƒ³ä¸´æ—¶åˆ†äº« NAS ä¸Šçš„ä¸€ä¸ªæ–‡ä»¶ç»™æ²¡æœ‰å®‰è£… Tailscale çš„æœ‹å‹ã€‚</p><ol><li><p>ç¡®ä¿ä½ çš„ Docker å®¹å™¨å·²ç»é€šè¿‡ <code>tailscale up</code> æˆåŠŸè¿æ¥ã€‚</p></li><li><p>å‡è®¾ä½ æƒ³åˆ†äº«çš„æœåŠ¡åœ¨ä¸»æœºçš„ <code>8080</code> ç«¯å£ä¸Šï¼ˆæ¯”å¦‚ä¸€ä¸ªä¸´æ—¶çš„æ–‡ä»¶æœåŠ¡å™¨ï¼‰ã€‚</p><ul><li>ç”±äºæˆ‘ä»¬ä½¿ç”¨äº† <code>--network=host</code>ï¼Œå®¹å™¨å¯ä»¥ç›´æ¥è®¿é—®åˆ°ä¸»æœºçš„ <code>8080</code> ç«¯å£ã€‚</li></ul></li><li><p>æ‰§è¡Œ Funnel å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> tailscaled tailscale funnel 8080</span><br></pre></td></tr></table></figure></li><li><p>å‘½ä»¤ä¼šè¾“å‡ºä¸€ä¸ªå…¬ç½‘å¯è®¿é—®çš„ HTTPS é“¾æ¥ï¼Œå½¢å¦‚ <code>https://your-nas-hostname.ts.net</code>ã€‚å°†è¿™ä¸ªé“¾æ¥å‘ç»™ä½ çš„æœ‹å‹å³å¯ã€‚</p></li><li><p>åˆ†äº«å®Œæ¯•åï¼ŒæŒ‰ <code>Ctrl+C</code> åœæ­¢ Funnelï¼Œå¤–é“¾å³åˆ»å¤±æ•ˆï¼Œéå¸¸å®‰å…¨ã€‚å¦‚æœæƒ³åœ¨åå°è¿è¡Œï¼Œå¯ä»¥åŠ ä¸Š <code>--bg</code> å‚æ•°ã€‚</p></li></ol><h3 id="æ€»ç»“ï¼šå¦‚ä½•ä½¿ç”¨éƒ¨ç½²åçš„æœåŠ¡">æ€»ç»“ï¼šå¦‚ä½•ä½¿ç”¨éƒ¨ç½²åçš„æœåŠ¡</h3><table><thead><tr><th style="text-align:left">ä½ çš„éœ€æ±‚</th><th style="text-align:left">ä½¿ç”¨çš„åŠŸèƒ½</th><th style="text-align:left">å…·ä½“æ“ä½œ</th></tr></thead><tbody><tr><td style="text-align:left"><strong>åœ¨å¤–é¢ç”¨</strong></td><td style="text-align:left"><strong>Tailscale æ ¸å¿ƒè¿æ¥ + MagicDNS</strong></td><td style="text-align:left">åœ¨ä½ çš„ç”µè„‘/æ‰‹æœºä¸Šå®‰è£…å¹¶ç™»å½• Tailscaleï¼Œç„¶ååƒåœ¨å®¶é‡Œä¸€æ ·ï¼Œç”¨ <code>http://è®¾å¤‡å:ç«¯å£</code> çš„æ–¹å¼è®¿é—® NAS çš„å„é¡¹æœåŠ¡ã€‚</td></tr><tr><td style="text-align:left"><strong>æ˜ å°„ä¸ºç”µè„‘ç¡¬ç›˜</strong></td><td style="text-align:left"><strong>SMB/AFP over Tailscale</strong></td><td style="text-align:left">åœ¨ç”µè„‘çš„â€œæ˜ å°„ç½‘ç»œé©±åŠ¨å™¨â€æˆ–â€œè¿æ¥æœåŠ¡å™¨â€åŠŸèƒ½ä¸­ï¼Œä½¿ç”¨ <code>\\è®¾å¤‡å</code> æˆ– <code>smb://è®¾å¤‡å</code> ä½œä¸ºåœ°å€ã€‚</td></tr><tr><td style="text-align:left"><strong>åˆ†äº«æ–‡ä»¶ç»™åˆ«äºº</strong></td><td style="text-align:left"><strong>Tailscale Funnel</strong></td><td style="text-align:left">åœ¨ NAS ä¸Šç”¨ Python æˆ–å…¶ä»–æ–¹å¼å¯åŠ¨ä¸€ä¸ªä¸´æ—¶ Web æœåŠ¡å™¨ï¼Œç„¶åç”¨ <code>tailscale funnel &lt;ç«¯å£å·&gt;</code> å‘½ä»¤ç”Ÿæˆä¸€ä¸ªä¸´æ—¶çš„å…¬ç½‘ä¸‹è½½é“¾æ¥ã€‚</td></tr><tr><td style="text-align:left"><strong>è®¿é—®å®¶é‡Œå…¶ä»–è®¾å¤‡</strong></td><td style="text-align:left"><strong>å­ç½‘è·¯ç”± (Subnet Router)</strong></td><td style="text-align:left">åœ¨éƒ¨ç½² Tailscale æ—¶å®£å‘Šå†…ç½‘ç½‘æ®µï¼Œå¹¶åœ¨ç®¡ç†åå°å¯ç”¨ã€‚ä¹‹åå°±èƒ½ç›´æ¥é€šè¿‡å†…ç½‘ IP è®¿é—®å®¶é‡Œæ‰€æœ‰è®¾å¤‡ã€‚</td></tr></tbody></table>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NAS æ–‡ä»¶å€ŸåŠ© MinIO è½¬æ¢OSS</title>
      <link href="/2025/07/16/minio-nas-build/"/>
      <url>/2025/07/16/minio-nas-build/</url>
      
        <content type="html"><![CDATA[<h3 id="æ•´ä½“æ¶æ„">æ•´ä½“æ¶æ„</h3><p>è¿™ä¸ªæ¶æ„çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š<strong>MinIO ä½œä¸ºå¯¹è±¡å­˜å‚¨çš„â€œå‰ç«¯â€ï¼Œè€Œä½ çš„ NAS ä»ç„¶æ˜¯æ•°æ®çš„â€œåç«¯â€ç‰©ç†å­˜å‚¨ã€‚</strong> ç”¨æˆ·å’Œåº”ç”¨ç¨‹åºåªä¸ MinIO äº¤äº’ï¼Œå®Œå…¨ä¸éœ€è¦å…³å¿ƒæ–‡ä»¶å…·ä½“å­˜æ”¾åœ¨ NAS çš„å“ªä¸ªç‰©ç†è·¯å¾„ä¸‹ã€‚</p><h3 id="æ–¹æ¡ˆä¼˜ç‚¹">æ–¹æ¡ˆä¼˜ç‚¹</h3><ol><li><strong>åè®®ç°ä»£åŒ–</strong>ï¼šå°†ä¼ ç»Ÿçš„ã€åŸºäºæ–‡ä»¶ç³»ç»Ÿçš„è®¿é—®ï¼ˆå¦‚ NFS, SMBï¼‰å‡çº§ä¸ºç°ä»£çš„ã€åŸºäº HTTP çš„ S3 API è®¿é—®ã€‚</li><li><strong>æ— éœ€æ•°æ®è¿ç§»</strong>ï¼šæ•°æ®ä»ç„¶å­˜æ”¾åœ¨ NAS ä¸Šï¼Œä½ ä¸éœ€è¦èŠ±è´¹å¤§é‡æ—¶é—´å»æ‹·è´æˆ–è¿ç§» TB çº§çš„æµ·é‡æ•°æ®ã€‚MinIO ç›´æ¥åœ¨ NAS çš„æ–‡ä»¶ç³»ç»Ÿä¹‹ä¸Šè¿è¡Œã€‚</li><li><strong>ç»Ÿä¸€è®¿é—®å…¥å£</strong>ï¼šæ— è®ºä½ æœ‰å¤šå°‘ä¸ª NAS å·æˆ–ç›®å½•ï¼Œéƒ½å¯ä»¥é€šè¿‡ MinIO çš„ Bucketï¼ˆå­˜å‚¨æ¡¶ï¼‰æ¥ç»„ç»‡å’Œè®¿é—®ï¼Œå½¢æˆä¸€ä¸ªç»Ÿä¸€çš„è§†å›¾ã€‚</li><li><strong>ç”Ÿæ€å…¼å®¹æ€§</strong>ï¼šå‡ ä¹æ‰€æœ‰ç°ä»£äº‘åŸç”Ÿåº”ç”¨ã€å¤§æ•°æ®æ¡†æ¶ã€å¤‡ä»½å·¥å…·éƒ½åŸç”Ÿæ”¯æŒ S3 åè®®ï¼Œå¯ä»¥æ— ç¼å¯¹æ¥ã€‚</li><li><strong>é«˜æ€§èƒ½</strong>ï¼šMinIO æœ¬èº«æ˜¯ä¸ºé«˜æ€§èƒ½è€Œè®¾è®¡çš„ï¼Œå¯ä»¥ç›´æ¥åˆ©ç”¨ NAS çš„ç¡¬ä»¶æ€§èƒ½ã€‚</li></ol><hr><h3 id="ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡å·¥ä½œ">ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡å·¥ä½œ</h3><ol><li><strong>ä¸€å°æœåŠ¡å™¨/è™šæ‹Ÿæœº</strong>ï¼šä½ éœ€è¦ä¸€å° Linux æœåŠ¡å™¨æ¥è¿è¡Œ MinIOã€‚è¿™å°æœåŠ¡å™¨<strong>å¿…é¡»èƒ½å¤Ÿé«˜é€ŸæŒ‚è½½ï¼ˆmountï¼‰ä½ çš„ NAS ç›®å½•</strong>ã€‚è¿™å°æœåŠ¡å™¨çš„ CPU å’Œå†…å­˜èµ„æºä¼šå½±å“ MinIO çš„æ€§èƒ½ï¼Œä½†å¯¹äºä¸€èˆ¬çš„æ–‡ä»¶æœåŠ¡ï¼Œé…ç½®è¦æ±‚ä¸é«˜ï¼ˆä¾‹å¦‚ 2æ ¸4G å†…å­˜å³å¯èµ·æ­¥ï¼‰ã€‚æˆ‘ä»¬ç§°è¿™å°æœåŠ¡å™¨ä¸º â€œMinIO Serverâ€ã€‚</li><li><strong>ç½‘ç»œè¿æ¥</strong>ï¼šç¡®ä¿ MinIO Server å’Œ NAS ä¹‹é—´æœ‰é«˜é€Ÿã€ä½å»¶è¿Ÿçš„ç½‘ç»œè¿æ¥ï¼ˆä¾‹å¦‚ï¼Œåƒå…†æˆ–ä¸‡å…†ä»¥å¤ªç½‘ï¼‰ã€‚</li><li><strong>NAS ç›®å½•</strong>ï¼šç¡®å®šä½ è¦æä¾›ä¸ºå¯¹è±¡å­˜å‚¨çš„ NAS ä¸Šçš„ä¸€ä¸ªæˆ–å¤šä¸ªç›®å½•ã€‚ä¾‹å¦‚ï¼Œ<code>/volume1/data</code>ã€‚</li></ol><h3 id="ç¬¬äºŒæ­¥ï¼šåœ¨-MinIO-Server-ä¸ŠæŒ‚è½½-NAS-ç›®å½•">ç¬¬äºŒæ­¥ï¼šåœ¨ MinIO Server ä¸ŠæŒ‚è½½ NAS ç›®å½•</h3><p>è¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥ã€‚ä½ å¿…é¡»å°† NAS çš„å…±äº«ç›®å½•æŒ‚è½½åˆ° MinIO Server çš„æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸Šã€‚</p><p>å‡è®¾ä½ çš„ NAS IP æ˜¯ <code>192.168.1.100</code>ï¼Œå…±äº«çš„ç›®å½•æ˜¯ <code>shared_data</code>ï¼Œä½ å¸Œæœ›å°†å®ƒæŒ‚è½½åˆ° MinIO Server çš„ <code>/mnt/nas_data</code> ç›®å½•ã€‚</p><h4 id="ä½¿ç”¨-NFS-æŒ‚è½½ï¼ˆæ¨èï¼‰">ä½¿ç”¨ NFS æŒ‚è½½ï¼ˆæ¨èï¼‰</h4><ol><li><p><strong>åœ¨ NAS ä¸Š</strong>ï¼šç¡®ä¿ NFS æœåŠ¡å·²å¼€å¯ï¼Œå¹¶ä¸” <code>shared_data</code> ç›®å½•å·²ç»é€šè¿‡ NFS å…±äº«å‡ºå»ï¼ŒåŒæ—¶æˆæƒ MinIO Server çš„ IP (<code>192.168.1.50</code> å‡è®¾) æœ‰è¯»å†™æƒé™ã€‚</p></li><li><p><strong>åœ¨ MinIO Server ä¸Š</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. å®‰è£… NFS å®¢æˆ·ç«¯</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get update</span><br><span class="line"><span class="built_in">sudo</span> apt-get install -y nfs-common</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. åˆ›å»ºæœ¬åœ°æŒ‚è½½ç‚¹</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /mnt/nas_data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. æ‰‹åŠ¨æŒ‚è½½è¿›è¡Œæµ‹è¯•</span></span><br><span class="line"><span class="comment"># -o nfsvers=4 æŒ‡å®šç‰ˆæœ¬ï¼Œå¯æ ¹æ®ä½ çš„NASè°ƒæ•´</span></span><br><span class="line"><span class="built_in">sudo</span> mount -t nfs 192.168.1.100:/shared_data /mnt/nas_data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. éªŒè¯æŒ‚è½½æ˜¯å¦æˆåŠŸ</span></span><br><span class="line"><span class="built_in">df</span> -h</span><br><span class="line"><span class="comment"># ä½ åº”è¯¥èƒ½çœ‹åˆ°ç±»ä¼¼ä¸‹é¢çš„ä¸€è¡Œ</span></span><br><span class="line"><span class="comment"># 192.168.1.100:/shared_data   50T   10T   40T   20% /mnt/nas_data</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. (é‡è¦) è®¾ç½®å¼€æœºè‡ªåŠ¨æŒ‚è½½ï¼Œé˜²æ­¢æœåŠ¡å™¨é‡å¯åæœåŠ¡å¤±æ•ˆ</span></span><br><span class="line"><span class="comment"># ç¼–è¾‘ /etc/fstab æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">sudo</span> nano /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ä¸€è¡Œ (ä½¿ç”¨ nofail é€‰é¡¹é˜²æ­¢NASæ•…éšœå¯¼è‡´æœåŠ¡å™¨æ— æ³•å¯åŠ¨)</span></span><br><span class="line">192.168.1.100:/shared_data /mnt/nas_data nfs defaults,nofail 0 0</span><br></pre></td></tr></table></figure></li></ol><h3 id="ç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨-Docker-Compose-éƒ¨ç½²-MinIO">ç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨ Docker Compose éƒ¨ç½² MinIO</h3><p>ä½¿ç”¨ Docker Compose æ˜¯éƒ¨ç½²å’Œç®¡ç† MinIO æœ€ç®€å•ã€æœ€å¯é çš„æ–¹å¼ã€‚</p><ol><li><p><strong>åœ¨ MinIO Server ä¸Šå®‰è£… Docker å’Œ Docker Composeã€‚</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… Docker</span></span><br><span class="line">curl -fsSL https://get.docker.com -o get-docker.sh</span><br><span class="line"><span class="built_in">sudo</span> sh get-docker.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… Docker Compose</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install -y docker-compose</span><br></pre></td></tr></table></figure></li><li><p><strong>åˆ›å»ºä¸€ä¸ªå·¥ä½œç›®å½•å¹¶ç¼–å†™ <code>docker-compose.yml</code> æ–‡ä»¶ã€‚</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> minio-deployment</span><br><span class="line"><span class="built_in">cd</span> minio-deployment</span><br><span class="line">nano docker-compose.yml</span><br></pre></td></tr></table></figure></li><li><p><strong>å°†ä»¥ä¸‹å†…å®¹ç²˜è´´åˆ° <code>docker-compose.yml</code> æ–‡ä»¶ä¸­ï¼š</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.7&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">minio:</span></span><br><span class="line">    <span class="comment"># ä½¿ç”¨å®˜æ–¹ MinIO é•œåƒ</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">minio/minio:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">local-oss-server</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å®šä¹‰ç¯å¢ƒå˜é‡ (è¯·åŠ¡å¿…ä¿®æ”¹å¯†ç )</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="comment"># MinIO çš„ç™»å½• Access Key (ç”¨æˆ·å)</span></span><br><span class="line">      <span class="attr">MINIO_ROOT_USER:</span> <span class="string">minioadmin</span></span><br><span class="line">      <span class="comment"># MinIO çš„ç™»å½• Secret Key (å¯†ç , è‡³å°‘8ä½)</span></span><br><span class="line">      <span class="attr">MINIO_ROOT_PASSWORD:</span> <span class="string">VERY_SECRET_PASSWORD_CHANGE_ME</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># volumes å·æŒ‚è½½æ˜¯æ ¸å¿ƒ</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="comment"># å°†æˆ‘ä»¬åˆšåˆšæŒ‚è½½çš„ NAS ç›®å½•ï¼Œæ˜ å°„åˆ° MinIO å®¹å™¨å†…éƒ¨çš„ /data ç›®å½•</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mnt/nas_data:/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mnt/nas:/data2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ports ç«¯å£æ˜ å°„</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="comment"># 9000 ç«¯å£æ˜¯ S3 API çš„è®¿é—®ç«¯å£</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9000:9000&quot;</span></span><br><span class="line">      <span class="comment"># 9001 ç«¯å£æ˜¯ MinIO Web æ§åˆ¶å°çš„è®¿é—®ç«¯å£</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9001:9001&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># command å‘½ä»¤</span></span><br><span class="line">    <span class="comment"># å‘Šè¯‰ MinIO å¯åŠ¨ä¸€ä¸ªæœåŠ¡å™¨ï¼Œå¹¶ä½¿ç”¨å®¹å™¨å†…çš„ /data ç›®å½•ä½œä¸ºå­˜å‚¨æ ¹ç›®å½•</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">server</span> <span class="string">/data</span> <span class="string">/data2</span> <span class="string">--console-address</span> <span class="string">&quot;:9001&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¥åº·æ£€æŸ¥ï¼Œç¡®ä¿æœåŠ¡æ­£å¸¸è¿è¡Œ</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost:9000/minio/health/live&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">20s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure></li><li><p><strong>å¯åŠ¨ MinIO æœåŠ¡ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure></li></ol><h3 id="ç¬¬å››æ­¥ï¼šéªŒè¯å’Œä½¿ç”¨">ç¬¬å››æ­¥ï¼šéªŒè¯å’Œä½¿ç”¨</h3><p>ç°åœ¨ï¼Œä½ çš„æœ¬åœ° OSS æœåŠ¡å·²ç»æ­å»ºå®Œæˆå¹¶å¼€å§‹è¿è¡Œäº†ï¼</p><ol><li><p><strong>è®¿é—® Web æ§åˆ¶å°</strong>ï¼š</p><ul><li>åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ <code>http://&lt;MinIO_Server_IP&gt;:9001</code>ã€‚</li><li>ä½¿ç”¨ä½ åœ¨ <code>docker-compose.yml</code> ä¸­è®¾ç½®çš„ <code>MINIO_ROOT_USER</code> (minioadmin) å’Œ <code>MINIO_ROOT_PASSWORD</code> ç™»å½•ã€‚</li></ul></li><li><p><strong>æŸ¥çœ‹æ•°æ®</strong>ï¼š</p><ul><li>ç™»å½•åï¼Œä½ ä¼šçœ‹åˆ° MinIO çš„ç•Œé¢ã€‚ç‚¹å‡» â€œBucketsâ€ï¼ˆå­˜å‚¨æ¡¶ï¼‰ã€‚</li><li><strong>ä½ ä¼šæƒŠå–œåœ°å‘ç°ï¼Œä½ åœ¨ NAS ç›®å½• <code>/mnt/nas_data</code> ä¸‹çš„æ‰€æœ‰ä¸€çº§å­ç›®å½•ï¼Œéƒ½å·²ç»è‡ªåŠ¨å˜æˆäº† MinIO çš„ Bucketsï¼</strong></li><li>ä¾‹å¦‚ï¼Œå¦‚æœä½ çš„ NAS ç›®å½•ç»“æ„æ˜¯ï¼š<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/mnt/nas_data/</span><br><span class="line">â”œâ”€â”€ images/</span><br><span class="line">â”‚   â”œâ”€â”€ cat.jpg</span><br><span class="line">â”‚   â””â”€â”€ dog.png</span><br><span class="line">â””â”€â”€ videos/</span><br><span class="line">    â””â”€â”€ movie.mp4</span><br></pre></td></tr></table></figure></li><li>é‚£ä¹ˆåœ¨ MinIO æ§åˆ¶å°é‡Œï¼Œä½ å°±ä¼šçœ‹åˆ°ä¸¤ä¸ª bucketï¼š<code>images</code> å’Œ <code>videos</code>ã€‚ä½ å¯ä»¥ç›´æ¥ç‚¹å‡»è¿›å…¥å¹¶ç®¡ç†é‡Œé¢çš„æ–‡ä»¶ã€‚</li></ul></li><li><p><strong>ä½¿ç”¨ S3 API è®¿é—®</strong>ï¼š</p><ul><li><strong>Endpoint (æœåŠ¡åœ°å€)</strong>: <code>http://&lt;MinIO_Server_IP&gt;:9000</code></li><li><strong>Access Key</strong>: <code>minioadmin</code></li><li><strong>Secret Key</strong>: <code>VERY_SECRET_PASSWORD_CHANGE_ME</code></li><li>ä½ å¯ä»¥ä½¿ç”¨ä»»ä½•æ”¯æŒ S3 çš„å®¢æˆ·ç«¯å·¥å…·ï¼ˆå¦‚ <code>s3cmd</code>, <code>mc</code>, AWS SDKï¼‰æ¥è¿æ¥å’Œæ“ä½œä½ çš„æ•°æ®ã€‚</li></ul><p><strong>ä½¿ç”¨ MinIO Client (mc) çš„ç¤ºä¾‹ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. ä¸‹è½½ mc</span></span><br><span class="line">wget https://dl.min.io/client/mc/release/linux-amd64/mc</span><br><span class="line"><span class="built_in">chmod</span> +x mc</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mv</span> mc /usr/local/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. é…ç½®ä¸€ä¸ªåˆ«åï¼ŒæŒ‡å‘ä½ çš„æœ¬åœ° OSS</span></span><br><span class="line">mc <span class="built_in">alias</span> <span class="built_in">set</span> local-oss http://&lt;MinIO_Server_IP&gt;:9000 minioadmin VERY_SECRET_PASSWORD_CHANGE_ME</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. åˆ—å‡ºæ‰€æœ‰çš„ bucket (å³ NAS ä¸Šçš„ä¸€çº§ç›®å½•)</span></span><br><span class="line">mc <span class="built_in">ls</span> local-oss</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. åˆ—å‡º images bucket é‡Œçš„æ‰€æœ‰æ–‡ä»¶</span></span><br><span class="line">mc <span class="built_in">ls</span> local-oss/images</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. ä¸Šä¼ ä¸€ä¸ªæ–°æ–‡ä»¶åˆ° videos bucket</span></span><br><span class="line">mc <span class="built_in">cp</span> my_new_video.mp4 local-oss/videos</span><br><span class="line"><span class="comment"># æ‰§è¡Œåï¼Œä½ ä¼šåœ¨ NAS çš„ /mnt/nas_data/videos/ ç›®å½•ä¸‹çœ‹åˆ° my_new_video.mp4 æ–‡ä»¶</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="é—®é¢˜">é—®é¢˜</h3><ul><li>é‡å¯åæ®‹ç•™æ–‡ä»¶æ¸…ç†</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">rm</span> -rf .minio.sys</span><br><span class="line">docker-compose down &amp;&amp; docker-compose up -d</span><br></pre></td></tr></table></figure><h3 id="æ€»ç»“">æ€»ç»“</h3><p>é€šè¿‡ <strong>NAS æŒ‚è½½ + MinIO Docker éƒ¨ç½²</strong> è¿™ä¸ªç®€å•çš„ä¸¤æ­¥ç»„åˆï¼Œä½ æˆåŠŸåœ°å°†ä¼ ç»Ÿçš„ NAS æ–‡ä»¶å­˜å‚¨â€œåŒ…è£…â€æˆäº†ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ã€æ¥å£æ ‡å‡†ã€æ˜“äºæ‰©å±•çš„æœ¬åœ°å¯¹è±¡å­˜å‚¨æœåŠ¡ã€‚è¿™ä¸ªæ–¹æ¡ˆå…¼å…·äº† NAS çš„å¤§å®¹é‡å­˜å‚¨æˆæœ¬ä¼˜åŠ¿å’Œ OSS çš„ç°ä»£åŒ–æ¥å£ä¼˜åŠ¿ï¼Œæ˜¯ç›˜æ´»å­˜é‡æ•°æ®èµ„äº§çš„ç»ä½³å®è·µã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäº FFmpeg çš„è§†é¢‘åœºæ™¯ï¼ˆé•œå¤´è¾¹ç•Œï¼‰æ£€æµ‹</title>
      <link href="/2025/07/02/ffmpeg-detect-scene/"/>
      <url>/2025/07/02/ffmpeg-detect-scene/</url>
      
        <content type="html"><![CDATA[<blockquote><p>åœ¨è§†é¢‘å¤„ç†é¢†åŸŸï¼Œåœºæ™¯æ£€æµ‹ï¼ˆScene Detectionï¼‰æˆ–ç§°é•œå¤´åˆ†å‰²ï¼ˆShot Boundary Detectionï¼‰æ˜¯ä¸€é¡¹åŸºç¡€ä¸”å…³é”®çš„ä»»åŠ¡ï¼Œå¹¿æ³›åº”ç”¨äºè§†é¢‘ç´¢å¼•ã€è‡ªåŠ¨å‰ªè¾‘ã€å†…å®¹æ‘˜è¦ç­‰åœºæ™¯ã€‚</p></blockquote><h2 id="1-æŠ€æœ¯å¯è¡Œæ€§åˆ†æ-Feasibility-Analysis"><strong>1. æŠ€æœ¯å¯è¡Œæ€§åˆ†æ (Feasibility Analysis)</strong></h2><p>å°† FFmpeg ç”¨äºåœºæ™¯æ£€æµ‹ä¸ä»…å¯è¡Œï¼Œè€Œä¸”æ˜¯ä¸€ç§éå¸¸æˆç†Ÿå’Œé«˜æ•ˆçš„æ–¹æ¡ˆã€‚å…¶å¯è¡Œæ€§ä¸»è¦åŸºäºä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li><strong>å†…ç½®çš„ä¸“ä¸šæ»¤é•œ</strong>: FFmpeg å†…ç½®äº†ä¸“é—¨ä¸ºåª’ä½“åˆ†æè®¾è®¡çš„å¼ºå¤§æ»¤é•œï¼ˆfiltersï¼‰ï¼Œå¦‚ <code>scdet</code> å’Œ <code>select</code>ï¼Œå®ƒä»¬å¯ä»¥ç›´æ¥è®¿é—®è§†é¢‘å¸§çš„åº•å±‚æ•°æ®ï¼Œå¹¶è¿›è¡Œå¿«é€Ÿçš„æ•°å­¦è¿ç®—ã€‚</li><li><strong>åƒç´ çº§å·®å¼‚è®¡ç®—</strong>: åœºæ™¯æ£€æµ‹çš„æ ¸å¿ƒåŸç†æ˜¯è®¡ç®—è¿ç»­è§†é¢‘å¸§ä¹‹é—´çš„è§†è§‰å·®å¼‚ã€‚å½“å·®å¼‚è¶…è¿‡æŸä¸ªé˜ˆå€¼æ—¶ï¼Œå³è®¤ä¸ºå‘ç”Ÿäº†åœºæ™¯åˆ‡æ¢ã€‚FFmpeg çš„æ»¤é•œèƒ½å¤Ÿé«˜æ•ˆåœ°æ‰§è¡Œè¿™ç§åƒç´ çº§çš„ç›´æ–¹å›¾æˆ–å¸§å·®è®¡ç®—ï¼Œå¹¶å°†ç»“æœé‡åŒ–ä¸ºä¸€ä¸ªâ€œåœºæ™¯å˜åŒ–åˆ†æ•°â€ï¼ˆscene scoreï¼‰ã€‚</li><li><strong>è·¨å¹³å°ä¸æ ‡å‡†åŒ–</strong>: FFmpeg æ˜¯ä¸€ä¸ªè·¨å¹³å°çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œåœ¨ Windows, macOS, Linux ä¸Šè¡¨ç°ä¸€è‡´ï¼Œæ— éœ€ä¾èµ–å¤æ‚çš„å›¾å½¢ç•Œé¢æˆ–ç‰¹å®šæ“ä½œç³»ç»ŸAPIã€‚è¿™ä½¿å…¶æˆä¸ºè‡ªåŠ¨åŒ–ã€æœåŠ¡å™¨ç«¯å¤„ç†æµç¨‹çš„ç†æƒ³é€‰æ‹©ã€‚</li><li><strong>è½»é‡çº§ä¸é›¶ä¾èµ–</strong>: ä¸éœ€è¦å®‰è£…åºå¤§ä¾èµ–åº“çš„ä¸“ä¸šè½¯ä»¶æˆ–Pythonåº“ç›¸æ¯”ï¼ŒFFmpeg åªæœ‰ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œéƒ¨ç½²ç®€å•ï¼Œèµ„æºå ç”¨æä½ã€‚</li></ul><p><strong>ç»“è®º</strong>: FFmpeg æä¾›äº†å®ç°åœºæ™¯æ£€æµ‹æ‰€éœ€çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œå…¶æ€§èƒ½å’Œæ ‡å‡†åŒ–ç‰¹æ€§ä½¿å…¶æˆä¸ºä¸€ä¸ªé«˜åº¦å¯è¡Œçš„æŠ€æœ¯é€‰å‹ã€‚</p><h2 id="2-å®ç°æ–¹æ³•-Implementation"><strong>2. å®ç°æ–¹æ³• (Implementation)</strong></h2><p>å®ç° FFmpeg åœºæ™¯æ£€æµ‹çš„æœ€ä½³å®è·µæ˜¯ç»“åˆ <code>select</code> å’Œ <code>showinfo</code> ä¸¤ä¸ªæ»¤é•œã€‚è¿™ç§æ–¹æ³•æ¯”å•ç‹¬ä½¿ç”¨è€æ—§çš„ <code>scdet</code> æ»¤é•œè¾“å‡ºæ›´å¹²å‡€ã€æ›´å¯é ã€‚</p><p><strong>æ ¸å¿ƒå‘½ä»¤</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i <span class="string">&quot;input.mp4&quot;</span> -vf <span class="string">&quot;select=&#x27;gt(scene,THRESHOLD)&#x27;,showinfo&quot;</span> -f null -</span><br></pre></td></tr></table></figure><p><strong>å‘½ä»¤è§£æ</strong>:</p><ol><li><code>ffmpeg -i &quot;input.mp4&quot;</code>: æŒ‡å®šè¾“å…¥è§†é¢‘æ–‡ä»¶ã€‚</li><li><code>-vf &quot;...&quot;</code>: <code>-vf</code> æ˜¯ <code>-filter:v</code> çš„ç¼©å†™ï¼Œç”¨äºæŒ‡å®šè§†é¢‘æ»¤é•œé“¾ã€‚</li><li><code>select='gt(scene,THRESHOLD)'</code>: è¿™æ˜¯æ ¸å¿ƒçš„<strong>é€‰æ‹©æ»¤é•œ</strong>ã€‚<ul><li><code>scene</code>: FFmpeg å†…ç½®çš„ä¸€ä¸ªå˜é‡ï¼Œä»£è¡¨å½“å‰å¸§ä¸å‰ä¸€å¸§çš„åœºæ™¯å˜åŒ–åˆ†æ•°ï¼ˆèŒƒå›´ 0.0 åˆ° 1.0ï¼‰ã€‚</li><li><code>gt(a, b)</code>: â€œGreater Thanâ€ å‡½æ•°ï¼Œå½“ <code>a &gt; b</code> æ—¶è¿”å›çœŸã€‚</li><li><code>THRESHOLD</code>: è¿™æ˜¯ä¸€ä¸ª<strong>å¯è°ƒé˜ˆå€¼</strong>ï¼ˆä¾‹å¦‚ <code>0.4</code>ï¼‰ã€‚å€¼è¶Šä½ï¼Œæ£€æµ‹è¶Šçµæ•ã€‚è¯¥æ»¤é•œä¼šç­›é€‰å‡ºæ‰€æœ‰åœºæ™¯å˜åŒ–åˆ†æ•°å¤§äºé˜ˆå€¼çš„è§†é¢‘å¸§ã€‚</li></ul></li><li><code>,showinfo</code>: è¿™æ˜¯<strong>ä¿¡æ¯æ‰“å°æ»¤é•œ</strong>ã€‚å®ƒä¼šæ¥æ”¶ç”± <code>select</code> æ»¤é•œç­›é€‰å‡ºçš„å¸§ï¼Œå¹¶åœ¨æ ‡å‡†é”™è¯¯æµï¼ˆstderrï¼‰ä¸­æ‰“å°å‡ºè¿™äº›å¸§çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ ¼å¼é«˜åº¦ç»Ÿä¸€ã€‚</li><li><code>-f null -</code>: æŒ‡ç¤º FFmpeg ä¸ç”Ÿæˆä»»ä½•è¾“å‡ºæ–‡ä»¶ï¼Œä»…æ‰§è¡Œæ»¤é•œåˆ†æï¼Œå¹¶å°†ç»“æœè¾“å‡ºåˆ°æ ‡å‡†è¾“å‡º/é”™è¯¯æµã€‚</li></ol><p><strong>Python è„šæœ¬å®ç°</strong>:</p><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨ Python çš„ <code>subprocess</code> æ¨¡å—æ¥è°ƒç”¨æ­¤å‘½ä»¤å¹¶è§£æå…¶è¾“å‡ºã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detect_scenes_with_ffmpeg</span>(<span class="params">video_path, threshold=<span class="number">0.4</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä½¿ç”¨ FFmpeg æ£€æµ‹è§†é¢‘åœºæ™¯åˆ‡æ¢ç‚¹ã€‚&quot;&quot;&quot;</span></span><br><span class="line">    command = [</span><br><span class="line">        <span class="string">&quot;ffmpeg&quot;</span>,</span><br><span class="line">        <span class="string">&quot;-i&quot;</span>, video_path,</span><br><span class="line">        <span class="string">&quot;-vf&quot;</span>, <span class="string">f&quot;select=&#x27;gt(scene,<span class="subst">&#123;threshold&#125;</span>)&#x27;,showinfo&quot;</span>,</span><br><span class="line">        <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;null&quot;</span>,</span><br><span class="line">        <span class="string">&quot;-&quot;</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    process = subprocess.Popen(command, stderr=subprocess.PIPE, text=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    timestamps = []</span><br><span class="line">    <span class="comment"># æ­£åˆ™è¡¨è¾¾å¼ä¸“é—¨åŒ¹é… showinfo è¾“å‡ºçš„ pts_time</span></span><br><span class="line">    regex = <span class="string">r&quot;\[Parsed_showinfo.*\] .* pts_time:([0-9]+\.?[0-9]*)&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> process.stderr:</span><br><span class="line">        <span class="keyword">match</span> = re.search(regex, line)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">            timestamps.append(<span class="built_in">float</span>(<span class="keyword">match</span>.group(<span class="number">1</span>)))</span><br><span class="line">            </span><br><span class="line">    process.wait()</span><br><span class="line">    <span class="keyword">if</span> process.returncode != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;FFmpeg command failed.&quot;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> timestamps</span><br></pre></td></tr></table></figure><h2 id="3-æµ‹è¯•ä¸éªŒè¯æ–¹æ³•-Testing-Validation"><strong>3. æµ‹è¯•ä¸éªŒè¯æ–¹æ³• (Testing &amp; Validation)</strong></h2><p>è¦éªŒè¯ FFmpeg åœºæ™¯æ£€æµ‹çš„å‡†ç¡®æ€§ï¼Œéœ€è¦ç³»ç»Ÿæ€§çš„æµ‹è¯•æ–¹æ³•ã€‚</p><ol><li><p><strong>æ„å»ºæµ‹è¯•é›† (Test Dataset Construction)</strong>:</p><ul><li><strong>æ­£æ ·æœ¬</strong>: åŒ…å«å¤šç§ç±»å‹åœºæ™¯åˆ‡æ¢çš„è§†é¢‘ã€‚<ul><li><strong>ç¡¬åˆ‡ (Hard Cuts)</strong>: ç¬é—´åˆ‡æ¢ï¼ŒFFmpeg æ£€æµ‹æ•ˆæœæœ€å¥½ã€‚</li><li><strong>æ·¡å…¥æ·¡å‡º (Fades)</strong>: é€æ¸å˜é»‘æˆ–ä»é»‘å±å‡ºç°ã€‚</li><li><strong>å åŒ– (Dissolves)</strong>: ä¸¤ä¸ªåœºæ™¯å¹³æ»‘è¿‡æ¸¡ã€‚</li><li><strong>å¿«é€Ÿè¿åŠ¨/é—ªå…‰</strong>: å®¹æ˜“äº§ç”Ÿè¯¯æŠ¥çš„åœºæ™¯ï¼Œå¦‚çˆ†ç‚¸ã€ç›¸æœºå¿«é€Ÿæ‘‡æ™ƒã€é—ªå…‰ç¯ã€‚</li></ul></li><li><strong>è´Ÿæ ·æœ¬</strong>: é•¿é•œå¤´ã€æ— æ˜æ˜¾åˆ‡æ¢çš„è§†é¢‘ï¼Œç”¨äºæµ‹è¯•æ˜¯å¦ä¼šäº§ç”Ÿè¯¯æŠ¥ã€‚</li></ul></li><li><p><strong>äººå·¥æ ‡æ³¨ (Ground Truth Annotation)</strong>:</p><ul><li>ä½¿ç”¨è§†é¢‘ç¼–è¾‘è½¯ä»¶ï¼ˆå¦‚ Adobe Premiere, Final Cut Proï¼‰æ‰‹åŠ¨è®°å½•æµ‹è¯•é›†ä¸­æ‰€æœ‰åœºæ™¯åˆ‡æ¢çš„ç²¾ç¡®æ—¶é—´æˆ³ï¼Œä½œä¸ºâ€œé»„é‡‘æ ‡å‡†â€æˆ–â€œåŸºå‡†çœŸç›¸â€ï¼ˆGround Truthï¼‰ã€‚</li></ul></li><li><p><strong>é‡åŒ–è¯„ä¼°æŒ‡æ ‡ (Quantitative Metrics)</strong>:</p><ul><li>å°† FFmpeg æ£€æµ‹å‡ºçš„æ—¶é—´æˆ³ä¸äººå·¥æ ‡æ³¨çš„æ—¶é—´æˆ³è¿›è¡Œæ¯”å¯¹ï¼ˆå…è®¸ä¸€ä¸ªå°çš„å®¹å¿çª—å£ï¼Œå¦‚ Â±0.5ç§’ï¼‰ã€‚</li><li>è®¡ç®—ä»¥ä¸‹æŒ‡æ ‡ï¼š<ul><li><strong>ç²¾ç¡®ç‡ (Precision)</strong>: <code>TP / (TP + FP)</code>ï¼Œæ£€æµ‹å‡ºçš„è½¬åœºä¸­æœ‰å¤šå°‘æ˜¯æ­£ç¡®çš„ã€‚</li><li><strong>å¬å›ç‡ (Recall)</strong>: <code>TP / (TP + FN)</code>ï¼Œæ‰€æœ‰çœŸå®è½¬åœºä¸­ï¼Œæœ‰å¤šå°‘è¢«æˆåŠŸæ£€æµ‹å‡ºæ¥äº†ã€‚</li><li><strong>F1-Score</strong>: <code>2 * (Precision * Recall) / (Precision + Recall)</code>ï¼Œç²¾ç¡®ç‡å’Œå¬å›ç‡çš„è°ƒå’Œå¹³å‡å€¼ï¼Œæ˜¯ç»¼åˆè¯„ä¼°æ€§èƒ½çš„å¸¸ç”¨æŒ‡æ ‡ã€‚</li><li><code>TP</code> (True Positives): æ­£ç¡®æ£€æµ‹åˆ°çš„è½¬åœºã€‚</li><li><code>FP</code> (False Positives): è¯¯æŠ¥çš„è½¬åœºã€‚</li><li><code>FN</code> (False Negatives): æ¼æ‰çš„è½¬åœºã€‚</li></ul></li></ul></li><li><p><strong>é˜ˆå€¼è°ƒä¼˜</strong>:</p><ul><li>é€šè¿‡åœ¨æµ‹è¯•é›†ä¸Šè¿è¡Œä¸åŒé˜ˆå€¼ï¼ˆä¾‹å¦‚ä» 0.2 åˆ° 0.7ï¼‰ï¼Œç»˜åˆ¶ Precision-Recall æ›²çº¿ï¼Œæ‰¾åˆ°åœ¨ç‰¹å®šåº”ç”¨åœºæ™¯ä¸‹ F1-Score æœ€é«˜çš„æœ€ä½³é˜ˆå€¼ã€‚</li></ul></li></ol><h2 id="4-ä¼˜ç¼ºç‚¹åˆ†æ-Pros-and-Cons"><strong>4. ä¼˜ç¼ºç‚¹åˆ†æ (Pros and Cons)</strong></h2><p><strong>ä¼˜ç‚¹ (Pros)</strong>:</p><ul><li><strong>æ€§èƒ½å“è¶Š</strong>: ä½œä¸ºCè¯­è¨€ç¼–å†™çš„é«˜åº¦ä¼˜åŒ–çš„ç¨‹åºï¼ŒFFmpeg çš„å¤„ç†é€Ÿåº¦æå¿«ï¼Œè¿œè¶…è®¸å¤šé«˜çº§è¯­è¨€å®ç°çš„åº“ã€‚</li><li><strong>èµ„æºå ç”¨ä½</strong>: å†…å­˜å’ŒCPUå ç”¨éƒ½å¾ˆå°ï¼Œéå¸¸é€‚åˆåœ¨èµ„æºå—é™çš„ç¯å¢ƒæˆ–å¤§è§„æ¨¡æœåŠ¡å™¨é›†ç¾¤ä¸Šè¿è¡Œã€‚</li><li><strong>éƒ¨ç½²ç®€å•</strong>: æ— éœ€å¤æ‚çš„ä¾èµ–å®‰è£…ï¼Œä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶å³å¯æå®šã€‚</li><li><strong>é«˜åº¦å¯å®šåˆ¶ä¸é›†æˆ</strong>: å¯ä»¥é€šè¿‡è°ƒæ•´é˜ˆå€¼æ¥æ§åˆ¶çµæ•åº¦ï¼Œå¹¶ä¸”èƒ½ä¸ FFmpeg å…¶ä»–ä¸Šç™¾ç§æ»¤é•œå’ŒåŠŸèƒ½ï¼ˆå¦‚åˆ‡ç‰‡ã€è½¬ç ã€æˆªå›¾ï¼‰åœ¨åŒä¸€ä¸ªå‘½ä»¤ä¸­æ— ç¼é›†æˆï¼Œå½¢æˆå¼ºå¤§çš„å¤„ç†æµæ°´çº¿ã€‚</li><li><strong>å…è´¹ä¸å¼€æº</strong>: æ— ä»»ä½•å•†ä¸šæˆæœ¬ï¼Œç¤¾åŒºæ´»è·ƒï¼Œæ–‡æ¡£ä¸°å¯Œã€‚</li></ul><p><strong>ç¼ºç‚¹ (Cons)</strong>:</p><ul><li><strong>ä»…åŸºäºåƒç´ ï¼Œä¸ç†è§£å†…å®¹</strong>: è¿™æ˜¯å…¶æ ¸å¿ƒå±€é™ã€‚FFmpeg æ— æ³•ç†è§£è§†é¢‘çš„è¯­ä¹‰ã€‚<ul><li><strong>å¯¹æ¸å˜è½¬åœºä¸æ•æ„Ÿ</strong>: å¯¹äºæ·¡å…¥æ·¡å‡ºã€å åŒ–ç­‰ç¼“æ…¢å˜åŒ–çš„è½¬åœºï¼Œç”±äºè¿ç»­å¸§å·®å¼‚å°ï¼Œå¾ˆå®¹æ˜“è¢«æ¼æ£€ (False Negatives)ã€‚</li><li><strong>å¯¹å‰§çƒˆè¿åŠ¨æ•æ„Ÿ</strong>: å¿«é€Ÿçš„é•œå¤´ç§»åŠ¨ã€çˆ†ç‚¸ã€é—ªå…‰ç¯ç­‰éåœºæ™¯åˆ‡æ¢çš„å‰§çƒˆè§†è§‰å˜åŒ–ï¼Œå¾ˆå®¹æ˜“è¢«è¯¯æŠ¥ (False Positives)ã€‚</li><li><strong>æ— æ³•è¯†åˆ«è½¬åœºç±»å‹</strong>: å®ƒåªèƒ½å‘Šè¯‰ä½ â€œè¿™é‡Œå‘ç”Ÿäº†å˜åŒ–â€ï¼Œä½†æ— æ³•åŒºåˆ†æ˜¯ç¡¬åˆ‡è¿˜æ˜¯å…¶ä»–ç‰¹æ•ˆã€‚</li></ul></li><li><strong>é˜ˆå€¼ä¾èµ–æ€§å¼º</strong>: æ•ˆæœå¥½åä¸¥é‡ä¾èµ–äºé˜ˆå€¼çš„è®¾å®šï¼Œè€Œâ€œæœ€ä½³é˜ˆå€¼â€å¯¹äºä¸åŒç±»å‹ï¼ˆå¦‚åŠ¨ç”»ã€ç”µå½±ã€Vlogï¼‰çš„è§†é¢‘å¯èƒ½å®Œå…¨ä¸åŒï¼Œéœ€è¦ç»éªŒæˆ–å®éªŒæ¥ç¡®å®šã€‚</li><li><strong>éœ€è¦å¤–éƒ¨è°ƒç”¨ä¸è§£æ</strong>: å®ƒä¸æ˜¯ä¸€ä¸ªåŸç”Ÿåº“ï¼Œåœ¨ Python ç­‰è¯­è¨€ä¸­ä½¿ç”¨æ—¶ï¼Œå¿…é¡»é€šè¿‡å­è¿›ç¨‹è°ƒç”¨ï¼Œå¹¶ç¼–å†™æ­£åˆ™è¡¨è¾¾å¼ç­‰ä»£ç æ¥è§£æå…¶æ–‡æœ¬è¾“å‡ºï¼Œå¢åŠ äº†é›†æˆçš„å¤æ‚æ€§ã€‚</li></ul><h2 id="5-æ•ˆç‡è¯„ä¼°-Efficiency-Evaluation"><strong>5. æ•ˆç‡è¯„ä¼° (Efficiency Evaluation)</strong></h2><p>FFmpeg çš„æ•ˆç‡æ˜¯å…¶æœ€æ˜¾è‘—çš„ä¼˜åŠ¿ä¹‹ä¸€ã€‚</p><ul><li><strong>å¤„ç†é€Ÿåº¦</strong>: åœ¨ç°ä»£å¤šæ ¸ CPU ä¸Šï¼Œå¤„ç†ä¸€ä¸ª 1080p çš„è§†é¢‘æ–‡ä»¶ï¼Œå…¶é€Ÿåº¦é€šå¸¸å¯ä»¥è¾¾åˆ°å®æ—¶é€Ÿåº¦çš„æ•°å€ç”šè‡³æ•°åå€ï¼ˆä¾‹å¦‚ï¼Œå¤„ç†1å°æ—¶çš„è§†é¢‘å¯èƒ½åªéœ€è¦å‡ åˆ†é’Ÿï¼‰ã€‚ç”±äºå…¶ä¸»è¦è¿›è¡Œæ•°å­¦è®¡ç®—ï¼Œæ€§èƒ½ç“¶é¢ˆé€šå¸¸åœ¨äºç£ç›˜ I/O æˆ– CPU å•æ ¸æ€§èƒ½ã€‚</li><li><strong>ä¸ PySceneDetect çš„å¯¹æ¯”</strong>:<ul><li><code>PySceneDetect</code> (ä½¿ç”¨ OpenCV åç«¯) åŒæ ·é«˜æ•ˆï¼Œä½†é€šå¸¸ä¼šæ¯” FFmpeg ç¨æ…¢ï¼Œå› ä¸ºå®ƒæœ‰ Python å±‚çš„å¼€é”€ã€‚</li><li>å½“ <code>PySceneDetect</code> ä½¿ç”¨æ›´å¤æ‚çš„æ£€æµ‹å™¨ï¼ˆå¦‚ <code>ThresholdDetector</code>ï¼Œæ£€æµ‹é»‘åœº/ç™½åœºï¼‰æ—¶ï¼Œå…¶å¼€é”€ä¼šè¿›ä¸€æ­¥å¢åŠ ã€‚</li><li>FFmpeg çš„ä¼˜åŠ¿åœ¨äºå…¶çº¯ C å®ç°å’Œæç®€çš„è®¡ç®—é€»è¾‘ï¼Œä½¿å…¶åœ¨åŸå§‹é€Ÿåº¦ä¸Šé€šå¸¸ä¿æŒé¢†å…ˆã€‚</li></ul></li><li><strong>å†…å­˜ä½¿ç”¨</strong>: FFmpeg é‡‡ç”¨æµå¼å¤„ç†ï¼ˆstreamingï¼‰ï¼Œä¸€æ¬¡åªåœ¨å†…å­˜ä¸­ä¿ç•™å°‘é‡å¸§è¿›è¡Œè®¡ç®—ï¼Œå› æ­¤å†…å­˜å ç”¨éå¸¸ç¨³å®šä¸”ä½ä¸‹ï¼Œå³ä¾¿æ˜¯å¤„ç†æ•°å°æ—¶çš„é•¿è§†é¢‘ä¹Ÿä¸ä¼šè€—å°½å†…å­˜ã€‚</li></ul><p><strong>ä¼˜åŒ–å»ºè®®</strong>: è™½ç„¶ FFmpeg å·²ç»å¾ˆå¿«ï¼Œä½†å¯¹äºè¶…é«˜åˆ†è¾¨ç‡è§†é¢‘ï¼ˆå¦‚ 4K, 8Kï¼‰ï¼Œå¯ä»¥é€šè¿‡åœ¨æ»¤é•œé“¾ä¸­åŠ å…¥ <code>scale</code> æ»¤é•œè¿›è¡Œ<strong>é™é‡‡æ ·</strong>æ¥è¿›ä¸€æ­¥æé€Ÿï¼Œä¾‹å¦‚ <code>scale=640:-1</code>ï¼Œè¿™é€šå¸¸ä¸ä¼šå½±å“ç¡¬åˆ‡æ£€æµ‹çš„å‡†ç¡®æ€§ã€‚</p><h2 id="6-æ¡ˆä¾‹">6. æ¡ˆä¾‹</h2><ul><li>code</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span>, <span class="type">Any</span>, <span class="type">Tuple</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 1. Setup Logging ---</span></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setup_logging</span>(<span class="params">log_file: <span class="built_in">str</span> = <span class="string">&quot;analysis.log&quot;</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Configures logging to file and console.&quot;&quot;&quot;</span></span><br><span class="line">    logging.basicConfig(</span><br><span class="line">        level=logging.INFO,</span><br><span class="line">        <span class="built_in">format</span>=<span class="string">&quot;%(asctime)s [%(levelname)s] - %(message)s&quot;</span>,</span><br><span class="line">        handlers=[</span><br><span class="line">            logging.FileHandler(log_file, mode=<span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>),</span><br><span class="line">            logging.StreamHandler()  <span class="comment"># Also print to console</span></span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">analyze_video_transitions</span>(<span class="params"></span></span><br><span class="line"><span class="params">        video_path: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">        ffmpeg_path: <span class="built_in">str</span> = <span class="string">&quot;ffmpeg&quot;</span>,</span></span><br><span class="line"><span class="params">        threshold: <span class="built_in">float</span> = <span class="number">0.4</span></span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="type">Tuple</span>[<span class="type">List</span>[<span class="built_in">float</span>], <span class="built_in">str</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Analyzes a video file for scene transitions using ffmpeg.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    This function uses the &#x27;select&#x27; and &#x27;showinfo&#x27; filters in ffmpeg, which is a</span></span><br><span class="line"><span class="string">    more robust method than parsing the output of &#x27;scdet&#x27; alone. It identifies</span></span><br><span class="line"><span class="string">    frames where the scene change score exceeds a given threshold.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        video_path: The absolute or relative path to the video file.</span></span><br><span class="line"><span class="string">        ffmpeg_path: The path to the ffmpeg executable. Defaults to &#x27;ffmpeg&#x27;.</span></span><br><span class="line"><span class="string">        threshold: The sensitivity for scene detection, from 0.0 to 1.0.</span></span><br><span class="line"><span class="string">                   Lower values detect more transitions. A common default is 0.4.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        A tuple containing:</span></span><br><span class="line"><span class="string">        - A sorted list of timestamps (in seconds) where transitions were detected.</span></span><br><span class="line"><span class="string">        - The complete, raw stderr output from the ffmpeg command for debugging.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Raises:</span></span><br><span class="line"><span class="string">        FileNotFoundError: If the ffmpeg executable is not found at ffmpeg_path.</span></span><br><span class="line"><span class="string">        FFmpegError: If ffmpeg returns a non-zero exit code, indicating an error</span></span><br><span class="line"><span class="string">                     (e.g., invalid video file, incorrect parameters).</span></span><br><span class="line"><span class="string">        ValueError: If the provided video_path does not exist.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># It&#x27;s good practice to check for file existence early</span></span><br><span class="line">    <span class="keyword">import</span> os</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(video_path):</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Video file not found at: <span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># This command is more robust:</span></span><br><span class="line">    <span class="comment"># - `select=&#x27;gt(scene,&#123;threshold&#125;)&#x27;`: Selects frames where the scene change</span></span><br><span class="line">    <span class="comment">#   score is greater than the threshold.</span></span><br><span class="line">    <span class="comment"># - `showinfo`: Prints information about the selected frames to stderr.</span></span><br><span class="line">    <span class="comment"># The output is structured and easy to parse.</span></span><br><span class="line">    command = [</span><br><span class="line">        ffmpeg_path,</span><br><span class="line">        <span class="string">&quot;-i&quot;</span>, video_path,</span><br><span class="line">        <span class="string">&quot;-vf&quot;</span>, <span class="string">f&quot;select=&#x27;gt(scene,<span class="subst">&#123;threshold&#125;</span>)&#x27;,showinfo&quot;</span>,</span><br><span class="line">        <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;null&quot;</span>,</span><br><span class="line">        <span class="string">&quot;-&quot;</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        process = subprocess.Popen(</span><br><span class="line">            command,</span><br><span class="line">            stdout=subprocess.PIPE,</span><br><span class="line">            stderr=subprocess.PIPE,</span><br><span class="line">            text=<span class="literal">True</span>,</span><br><span class="line">            encoding=<span class="string">&#x27;utf-8&#x27;</span>,</span><br><span class="line">            errors=<span class="string">&#x27;replace&#x27;</span></span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        <span class="keyword">raise</span> FileNotFoundError(</span><br><span class="line">            <span class="string">f&quot;ffmpeg executable not found at &#x27;<span class="subst">&#123;ffmpeg_path&#125;</span>&#x27;. &quot;</span></span><br><span class="line">            <span class="string">&quot;Please install ffmpeg or provide the correct path.&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Process stderr line-by-line for memory efficiency</span></span><br><span class="line">    timestamps = []</span><br><span class="line">    <span class="comment"># The regex now specifically looks for &#x27;pts_time&#x27; from the showinfo filter</span></span><br><span class="line">    regex = <span class="string">r&quot;\[Parsed_showinfo.*\] .* pts_time:([0-9]+\.?[0-9]*)&quot;</span></span><br><span class="line"></span><br><span class="line">    stderr_lines = []</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> process.stderr:</span><br><span class="line">        stderr_lines.append(line)</span><br><span class="line">        <span class="keyword">match</span> = re.search(regex, line)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">            time_str = <span class="keyword">match</span>.group(<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> time_str:</span><br><span class="line">                timestamps.append(<span class="built_in">float</span>(time_str))</span><br><span class="line"></span><br><span class="line">    process.wait()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Check for ffmpeg errors after processing is complete</span></span><br><span class="line">    <span class="keyword">if</span> process.returncode != <span class="number">0</span>:</span><br><span class="line">        full_stderr = <span class="string">&quot;&quot;</span>.join(stderr_lines)</span><br><span class="line">        <span class="comment"># raise FFmpegError(</span></span><br><span class="line">        <span class="comment">#     f&quot;ffmpeg failed with exit code &#123;process.returncode&#125;.\n&quot;</span></span><br><span class="line">        <span class="comment">#     f&quot;Command: &#123;&#x27; &#x27;.join(command)&#125;\n&quot;</span></span><br><span class="line">        <span class="comment">#     f&quot;Stderr:\n&#123;full_stderr&#125;&quot;</span></span><br><span class="line">        <span class="comment"># )</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Timestamps from showinfo should already be in order, but sorting is safe</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sorted</span>(timestamps), <span class="string">&quot;&quot;</span>.join(stderr_lines)</span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Main function to run the analysis script.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- Configuration ---</span></span><br><span class="line">    <span class="comment"># 1. Setup logging first</span></span><br><span class="line">    log_file = <span class="string">&quot;./logs/transition_analysis.log&quot;</span></span><br><span class="line">    os.makedirs(log_file, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    setup_logging(log_file)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. Get user input for video directory</span></span><br><span class="line">    video_directory = <span class="string">&quot;/Volumes/share/æ–°å»ºæ–‡ä»¶å¤¹/7ï¼Œ1æ•°æ®&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. Output JSON file path</span></span><br><span class="line">    output_json_path = <span class="string">&quot;./data/transition_analysis_results.json&quot;</span></span><br><span class="line"></span><br><span class="line">    os.makedirs(<span class="string">&quot;./data&quot;</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4. (Optional) FFmpeg executable path</span></span><br><span class="line">    ffmpeg_executable = <span class="string">&quot;ffmpeg&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 5. Supported video file extensions</span></span><br><span class="line">    supported_extensions = &#123;<span class="string">&quot;.mp4&quot;</span>, <span class="string">&quot;.mkv&quot;</span>, <span class="string">&quot;.mov&quot;</span>, <span class="string">&quot;.avi&quot;</span>, <span class="string">&quot;.webm&quot;</span>, <span class="string">&quot;.flv&quot;</span>&#125;</span><br><span class="line">    <span class="comment"># --- End of Configuration ---</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(video_directory):</span><br><span class="line">        logging.error(<span class="string">f&quot;Directory not found at &#x27;<span class="subst">&#123;video_directory&#125;</span>&#x27;. Aborting.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    all_results: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    logging.info(<span class="string">&quot;Starting video transition analysis...&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 2. Find all video files first to set up the progress bar ---</span></span><br><span class="line">    video_files_to_process = []</span><br><span class="line">    <span class="keyword">for</span> filename <span class="keyword">in</span> os.listdir(video_directory):</span><br><span class="line">        file_path = os.path.join(video_directory, filename)</span><br><span class="line">        <span class="keyword">if</span> os.path.isfile(file_path) <span class="keyword">and</span> Path(filename).suffix.lower() <span class="keyword">in</span> supported_extensions:</span><br><span class="line">            video_files_to_process.append(file_path)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> video_files_to_process:</span><br><span class="line">        logging.warning(<span class="string">&quot;No video files found in the specified directory.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 3. Process files with a tqdm progress bar ---</span></span><br><span class="line">    <span class="keyword">with</span> tqdm(total=<span class="built_in">len</span>(video_files_to_process), desc=<span class="string">&quot;Analyzing Videos&quot;</span>) <span class="keyword">as</span> pbar:</span><br><span class="line">        <span class="keyword">for</span> video_path <span class="keyword">in</span> video_files_to_process:</span><br><span class="line">            filename = os.path.basename(video_path)</span><br><span class="line">            pbar.set_description(<span class="string">f&quot;Processing <span class="subst">&#123;filename[:<span class="number">20</span>]&#125;</span>...&quot;</span>)  <span class="comment"># Update progress bar description</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                transition_times, ffmpeg_log = analyze_video_transitions(video_path, ffmpeg_executable)</span><br><span class="line"></span><br><span class="line">                logging.info(<span class="string">f&quot;Successfully analyzed &#x27;<span class="subst">&#123;filename&#125;</span>&#x27;. Found <span class="subst">&#123;<span class="built_in">len</span>(transition_times)&#125;</span> transitions.&quot;</span>)</span><br><span class="line">                all_results[filename] = &#123;</span><br><span class="line">                    <span class="string">&quot;file_path&quot;</span>: video_path,</span><br><span class="line">                    <span class="string">&quot;transitions&quot;</span>: transition_times,</span><br><span class="line">                    <span class="string">&quot;transition_count&quot;</span>: <span class="built_in">len</span>(transition_times)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logging.error(<span class="string">f&quot;Failed to analyze &#x27;<span class="subst">&#123;filename&#125;</span>&#x27;: <span class="subst">&#123;e&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">                <span class="comment"># Also log the full ffmpeg output for debugging</span></span><br><span class="line">                logging.debug(<span class="string">f&quot;FFmpeg stderr for failed file &#x27;<span class="subst">&#123;filename&#125;</span>&#x27;:\n<span class="subst">&#123;ffmpeg_log&#125;</span>&quot;</span>)</span><br><span class="line">                all_results[filename] = &#123;</span><br><span class="line">                    <span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            pbar.update(<span class="number">1</span>)  <span class="comment"># Move progress bar forward by one step</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Save the results to a JSON file</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(output_json_path, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            json.dump(all_results, f, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        logging.info(<span class="string">f&quot;Analysis complete. Results saved to &#x27;<span class="subst">&#123;output_json_path&#125;</span>&#x27;&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;Error saving results to JSON file: <span class="subst">&#123;e&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><ul><li>output</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> </span><br><span class="line">    <span class="attr">&quot;6æœˆ27æ—¥ (1)-71.mp4&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;file_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/Volumes/share/æ–°å»ºæ–‡ä»¶å¤¹/7ï¼Œ1æ•°æ®/6æœˆ27æ—¥ (1)-71.mp4&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;transitions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">7.666667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">11.766667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">16.566667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">22.866667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">27.066667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">29.266667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">34.766667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">36.966667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">49.566667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">57.066667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">61.766667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">63.5</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">69.866667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">74.8</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">79.466667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">81.266667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">84.066667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">88.266667</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;transition_count&quot;</span><span class="punctuation">:</span> <span class="number">19</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>log</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2025-07-02 17:50:43,359 [INFO] - Successfully analyzed &#x27;._6æœˆ27æ—¥ (1)-36.mp4&#x27;. Found 0 transitions.</span><br><span class="line">2025-07-02 17:50:55,619 [INFO] - Successfully analyzed &#x27;6æœˆ27æ—¥ (1)-71.mp4&#x27;. Found 19 transitions.</span><br><span class="line">2025-07-02 17:50:55,620 [INFO] - Analysis complete. Results saved to &#x27;transition_analysis_results.json&#x27;</span><br></pre></td></tr></table></figure><h2 id="ç»“è®º"><strong>ç»“è®º</strong></h2><h3 id="æ£€å‡ºæ•ˆæœå¯¹æ¯”">æ£€å‡ºæ•ˆæœå¯¹æ¯”</h3><table><thead><tr><th style="text-align:left">å¯¹æ¯”é¡¹</th><th style="text-align:left"><strong>æ–¹æ³•ä¸€: PySceneDetect (pyscenedetect_analysis.py)</strong></th><th style="text-align:left"><strong>æ–¹æ³•äºŒ: FFmpeg (transition_analysis.py)</strong></th></tr></thead><tbody><tr><td style="text-align:left"><strong>æ ¸å¿ƒæŠ€æœ¯</strong></td><td style="text-align:left">ä½¿ç”¨ä¸“ä¸šçš„Pythonåœºæ™¯æ£€æµ‹åº“ <code>scenedetect</code>ã€‚é€šè¿‡ <code>ContentDetector</code> ç®—æ³•ï¼Œæ¯”è¾ƒè¿ç»­å¸§åœ¨äº®åº¦ï¼ˆlumaï¼‰å’Œè‰²åº¦ï¼ˆchromaï¼‰ä¸Šçš„å˜åŒ–æ¥è¯†åˆ«åœºæ™¯åˆ‡æ¢ã€‚</td><td style="text-align:left">è°ƒç”¨å¤–éƒ¨å‘½ä»¤è¡Œå·¥å…· FFmpegï¼Œå¹¶ä½¿ç”¨å…¶å†…ç½®çš„ <code>select</code> å’Œ <code>showinfo</code> æ»¤é•œç»„åˆã€‚è¯¥æ–¹æ³•åŸºäºä¸€ä¸ªç®€å•çš„â€œåœºæ™¯å˜åŒ–åˆ†æ•°â€ï¼ˆscene scoreï¼‰è¿›è¡Œé˜ˆå€¼åˆ¤æ–­ã€‚</td></tr><tr><td style="text-align:left"><strong>æ£€æµ‹çµæ•åº¦ä¸å‡†ç¡®æ€§</strong></td><td style="text-align:left"><strong>é«˜</strong>ã€‚æ­¤æ–¹æ³•éå¸¸çµæ•ï¼Œèƒ½ç¨³å®šåœ°è¯†åˆ«å‡ºå¤§é‡çš„æœ‰æ•ˆåœºæ™¯åˆ‡æ¢ç‚¹ã€‚å…¶ç®—æ³•å¯¹ç¡¬åˆ‡ï¼ˆHard Cutsï¼‰çš„è¯†åˆ«å‡†ç¡®ç‡å¾ˆé«˜ã€‚</td><td style="text-align:left"><strong>ä¾èµ–é˜ˆå€¼ï¼Œé»˜è®¤è¾ƒä½</strong>ã€‚åœ¨ <code>threshold=0.4</code> çš„è®¾ç½®ä¸‹ï¼Œçµæ•åº¦å¯èƒ½ä¸è¶³ï¼Œå¯¼è‡´å¤§é‡æ˜æ˜¾çš„é•œå¤´åˆ‡æ¢è¢«æ¼æ£€ã€‚éœ€è¦é’ˆå¯¹è§†é¢‘å†…å®¹è¿›è¡Œç»†è‡´çš„é˜ˆå€¼è°ƒä¼˜æ‰èƒ½è¾¾åˆ°ç†æƒ³æ•ˆæœã€‚</td></tr><tr><td style="text-align:left"><strong>ç»“æœå¯¹æ¯” (ç¤ºä¾‹)</strong></td><td style="text-align:left"><code>6æœˆ27æ—¥ (1)-47.mp4</code>: æ£€å‡º <strong>46</strong> ä¸ª<br><code>6æœˆ27æ—¥ (1)-49.mp4</code>: æ£€å‡º <strong>43</strong> ä¸ª<br><code>6.27(1)-64.mp4</code>: æ£€å‡º <strong>17</strong> ä¸ª</td><td style="text-align:left"><code>6æœˆ27æ—¥ (1)-47.mp4</code>: æ£€å‡º <strong>0</strong> ä¸ª<br><code>6æœˆ27æ—¥ (1)-49.mp4</code>: æ£€å‡º <strong>33</strong> ä¸ª<br><code>6.27(1)-64.mp4</code>: æ£€å‡º <strong>4</strong> ä¸ª</td></tr><tr><td style="text-align:left"><strong>æ–‡ä»¶å¤„ç†å¥å£®æ€§</strong></td><td style="text-align:left"><strong>é«˜</strong>ã€‚è„šæœ¬ä¸­åŠ å…¥äº†æ˜ç¡®çš„é€»è¾‘ï¼Œèƒ½è‡ªåŠ¨è¯†åˆ«å¹¶è·³è¿‡ macOS ç³»ç»Ÿäº§ç”Ÿçš„æ— æ•ˆå…ƒæ•°æ®æ–‡ä»¶ï¼ˆå¦‚ <code>._filename.mp4</code>ï¼‰ï¼Œé¿å…äº†å› å¤„ç†æ— æ•ˆæ–‡ä»¶è€Œå¯¼è‡´çš„ç¨‹åºå´©æºƒæˆ–é”™è¯¯ã€‚</td><td style="text-align:left"><strong>ä¸­ç­‰</strong>ã€‚è„šæœ¬ä¼šå°è¯•å¤„ç† <code>._</code> å¼€å¤´çš„æ— æ•ˆæ–‡ä»¶ã€‚è™½ç„¶ FFmpeg æœ¬èº«é€šå¸¸ä¸ä¼šå› æ­¤å´©æºƒï¼ˆä¼šæŠ¥å‘Šé”™è¯¯å¹¶é€€å‡ºï¼‰ï¼Œä½†è¿™æµªè´¹äº†å¤„ç†æ—¶é—´ï¼Œå¹¶åœ¨æ—¥å¿—å’Œç»“æœæ–‡ä»¶ä¸­ç•™ä¸‹äº†æ— æ•ˆæ¡ç›®ã€‚</td></tr><tr><td style="text-align:left"><strong>æ€§èƒ½ä¸æ•ˆç‡</strong></td><td style="text-align:left"><strong>ä¸­ç­‰</strong>ã€‚å•ä¸ªæ–‡ä»¶å¤„ç†é€Ÿåº¦ç›¸å¯¹è¾ƒæ…¢ï¼Œå› å…¶åœ¨Pythonå±‚æœ‰ä¸€å®šå¼€é”€ã€‚ä½†é€šè¿‡è‡ªåŠ¨é™é‡‡æ ·ï¼ˆdownscalingï¼‰é«˜åˆ†è¾¨ç‡è§†é¢‘ï¼Œæ€§èƒ½å·²å¾—åˆ°æ˜¾è‘—ä¼˜åŒ–ï¼Œæœ€ç»ˆä»¥å¯æ¥å—çš„é€Ÿåº¦æ¢å–é«˜è´¨é‡çš„æ£€æµ‹ç»“æœã€‚</td><td style="text-align:left"><strong>éå¸¸é«˜</strong>ã€‚ä½œä¸ºCè¯­è¨€ç¼–å†™çš„åº•å±‚å·¥å…·ï¼Œå•ä¸ªæ–‡ä»¶å¤„ç†é€Ÿåº¦æå¿«ã€‚ä½†è¿™ç§é€Ÿåº¦ä¼˜åŠ¿å»ºç«‹åœ¨ç®—æ³•ç›¸å¯¹ç®€å•çš„åŸºç¡€ä¸Šï¼Œç‰ºç‰²äº†éƒ¨åˆ†å‡†ç¡®æ€§å’Œå¯¹å¤æ‚è½¬åœºçš„è¯†åˆ«èƒ½åŠ›ã€‚</td></tr><tr><td style="text-align:left"><strong>æ˜“ç”¨æ€§ä¸é›†æˆ</strong></td><td style="text-align:left"><strong>é«˜</strong>ã€‚ä½œä¸ºåŸç”ŸPythonåº“ï¼Œé›†æˆæ–¹ä¾¿ï¼Œæ— éœ€å¤„ç†å¤–éƒ¨è¿›ç¨‹å’Œè§£ææ–‡æœ¬è¾“å‡ºã€‚APIå‹å¥½ï¼Œè¿”å›ç›´æ¥å¯ç”¨çš„Pythonæ•°æ®ç»“æ„ï¼ˆå¦‚åˆ—è¡¨ï¼‰ã€‚</td><td style="text-align:left"><strong>ä¸­ç­‰</strong>ã€‚éœ€è¦é€šè¿‡ <code>subprocess</code> æ¨¡å—è°ƒç”¨ï¼Œå¹¶ç¼–å†™æ­£åˆ™è¡¨è¾¾å¼æ¥è§£æ <code>stderr</code> è¾“å‡ºï¼Œé›†æˆç›¸å¯¹å¤æ‚ï¼Œä¸”å®¹æ˜“å› FFmpegç‰ˆæœ¬æ›´æ–°å¯¼è‡´è§£æé€»è¾‘å¤±æ•ˆã€‚</td></tr><tr><td style="text-align:left"><strong>ä¾èµ–ä¸éƒ¨ç½²</strong></td><td style="text-align:left"><strong>ä¸­ç­‰</strong>ã€‚éœ€è¦é€šè¿‡ <code>pip</code> å®‰è£… <code>scenedetect</code> åŠå…¶ä¾èµ–ï¼ˆå¦‚ <code>opencv-python</code>ï¼‰ï¼Œç¯å¢ƒé…ç½®ç›¸å¯¹å¤æ‚ã€‚</td><td style="text-align:left"><strong>ç®€å•</strong>ã€‚ä»…ä¾èµ–äºä¸€ä¸ªå•ä¸€çš„ FFmpeg å¯æ‰§è¡Œæ–‡ä»¶ï¼Œéƒ¨ç½²å’Œåˆ†å‘éå¸¸æ–¹ä¾¿ã€‚</td></tr><tr><td style="text-align:left"><strong>æ¨èåœºæ™¯</strong></td><td style="text-align:left">é€‚ç”¨äºå¯¹<strong>æ£€æµ‹å‡†ç¡®æ€§è¦æ±‚é«˜</strong>ã€éœ€è¦ç¨³å®šå¯é ç»“æœçš„åº”ç”¨ã€‚æ˜¯æ„å»ºä¸“ä¸šè§†é¢‘åˆ†æå·¥å…·å’ŒæœåŠ¡çš„é¦–é€‰ã€‚</td><td style="text-align:left">é€‚ç”¨äºå¯¹<strong>å¤„ç†é€Ÿåº¦è¦æ±‚æé«˜</strong>ã€èµ„æºå—é™ï¼Œä¸”ä¸»è¦ä»»åŠ¡æ˜¯æ£€æµ‹ç¡¬åˆ‡ï¼ˆHard Cutsï¼‰çš„æ‰¹é‡è‡ªåŠ¨åŒ–æµç¨‹ã€‚</td></tr></tbody></table><h3 id="æ£€å‡ºæ•°ç›®å¯¹æ¯”">æ£€å‡ºæ•°ç›®å¯¹æ¯”</h3><table><thead><tr><th style="text-align:left">æ£€æµ‹æ–¹æ³•</th><th style="text-align:left">åˆ†æçš„è§†é¢‘æ€»æ•°</th><th style="text-align:left">æˆåŠŸæ£€å‡ºè½¬åœºçš„è§†é¢‘æ•°</th><th style="text-align:left">æ£€å‡ºç‡</th></tr></thead><tbody><tr><td style="text-align:left">æ–¹æ³•ä¸€: PySceneDetect</td><td style="text-align:left">48</td><td style="text-align:left">37</td><td style="text-align:left">77.1%</td></tr><tr><td style="text-align:left">æ–¹æ³•äºŒ: FFmpeg</td><td style="text-align:left">48</td><td style="text-align:left">19</td><td style="text-align:left">39.6%</td></tr></tbody></table><h3 id="æ€»ç»“">æ€»ç»“</h3><ul><li><p>PySceneDetect æ•ˆæœè¿œèƒœ FFmpegï¼šPySceneDetect æˆåŠŸåœ¨ 37 ä¸ªè§†é¢‘ä¸­æ‰¾åˆ°äº†è½¬åœºï¼Œè€Œ FFmpeg åªåœ¨å…¶ä¸­çš„ 19 ä¸ªè§†é¢‘ä¸­æ‰¾åˆ°äº†è½¬åœºã€‚PySceneDetect çš„â€œå‘½ä¸­ç‡â€å‡ ä¹æ˜¯ FFmpeg çš„ä¸¤å€ã€‚</p></li><li><p>FFmpeg æ¼æ£€ä¸¥é‡ï¼šä»æ•°æ®å¯ä»¥çœ‹å‡ºï¼ŒFFmpeg çš„æ–¹æ³•æ¼æ‰äº†å¤§é‡æœ‰è½¬åœºçš„è§†é¢‘ã€‚ä¾‹å¦‚ï¼Œåœ¨ PySceneDetect æ£€å‡º 80 ä¸ªè½¬åœºçš„ 6æœˆ27æ—¥ (1)-7.mp4 è§†é¢‘ä¸­ï¼ŒFFmpeg çš„ç»“æœä¸º 0ã€‚è¿™ç§å·¨å¤§çš„å·®å¼‚è¡¨æ˜ FFmpeg çš„ scdet æ»¤é•œåœ¨å½“å‰å‚æ•°ä¸‹è¿‡äºè¿Ÿé’ï¼Œä¸é€‚åˆç”¨äºç²¾ç¡®çš„åœºæ™¯åˆ‡åˆ†ã€‚</p></li></ul><blockquote><p>FFmpeg æ˜¯ä¸€ç§ç”¨äºè§†é¢‘åœºæ™¯æ£€æµ‹çš„â€œå¿«ã€å‡†ï¼ˆå¯¹ç¡¬åˆ‡è€Œè¨€ï¼‰ã€ç‹ â€çš„å·¥å…·**ã€‚å®ƒéå¸¸é€‚åˆäºéœ€è¦<strong>å¤§è§„æ¨¡ã€è‡ªåŠ¨åŒ–ã€å¿«é€Ÿå¤„ç†</strong>è§†é¢‘ï¼Œä¸”ä¸»è¦ç›®æ ‡æ˜¯æ£€æµ‹<strong>ç¡¬åˆ‡</strong>çš„åœºæ™¯ã€‚å®ƒçš„é«˜æ€§èƒ½ã€ä½èµ„æºå ç”¨å’Œå¼ºå¤§çš„é›†æˆèƒ½åŠ›ä½¿å…¶åœ¨åç«¯æœåŠ¡å’Œæ•°æ®é¢„å¤„ç†æµç¨‹ä¸­å…·æœ‰ä¸å¯æ›¿ä»£çš„ä»·å€¼ã€‚</p></blockquote><h2 id="See">See</h2><ul><li><a href="https://ffmpeg.org/ffmpeg-bitstream-filters.html">https://ffmpeg.org/ffmpeg-bitstream-filters.html</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TransNetV2æ¨¡å‹ç”¨äºè§†é¢‘å¤æ‚è½¬åœºæ£€æµ‹</title>
      <link href="/2025/06/09/TransNetV2-model-use/"/>
      <url>/2025/06/09/TransNetV2-model-use/</url>
      
        <content type="html"><![CDATA[<h2 id="TransNet-V2-æ¨¡å‹ä»‹ç»">TransNet V2 æ¨¡å‹ä»‹ç»</h2><ol><li>ç›®æ ‡ï¼š<br>TransNet V2 çš„ç›®æ ‡æ˜¯åˆ›å»ºä¸€ä¸ªå¿«é€Ÿä¸”å‡†ç¡®çš„é•œå¤´è¾¹ç•Œæ£€æµ‹ï¼ˆShot Boundary Detection, SBDï¼‰æ¨¡å‹ã€‚å®ƒèƒ½å¤Ÿè¯†åˆ«è§†é¢‘ä¸­çš„ä¸¤ç§ä¸»è¦ç±»å‹çš„é•œå¤´åˆ‡æ¢ï¼š<ul><li>ç¡¬åˆ‡ (Hard Cuts): ä¸¤ä¸ªé•œå¤´ä¹‹é—´çš„çªå˜ã€‚</li><li>æ¸å˜è½¬åœº (Gradual Transitions): å¦‚æº¶è§£ (dissolves)ã€æ·¡å…¥æ·¡å‡º (fades)ã€åˆ’åƒ (wipes) ç­‰ï¼Œè¿™äº›è½¬åœºä¼šæŒç»­æ•°å¸§ã€‚</li></ul></li></ol><ul><li>æ¨¡å‹æ¶æ„</li></ul><p><img src="/2025/06/09/TransNetV2-model-use/transnetv2_struct.png" class="lazyload placeholder" data-srcset="/2025/06/09/TransNetV2-model-use/transnetv2_struct.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ol start="2"><li><p>æ ¸å¿ƒæ€æƒ³ï¼š<br>TransNet V2 æ˜¯ä¸€ä¸ªæ·±åº¦ç¥ç»ç½‘ç»œã€‚å®ƒç›´æ¥å¤„ç†ä¸€ç³»åˆ—è¿ç»­çš„ã€ä½åˆ†è¾¨ç‡çš„ RGB è§†é¢‘å¸§ï¼Œæ¥é¢„æµ‹æ¯ä¸€å¸§å‘ç”Ÿé•œå¤´è½¬æ¢çš„æ¦‚ç‡ï¼Œå¹¶èƒ½åŒºåˆ†è½¬åœºç±»å‹ã€‚</p></li><li><p>å…³é”®æ¶æ„ç‰¹ç‚¹ï¼š</p><ul><li>è¾“å…¥ (Input)ï¼š<ul><li>æ¨¡å‹æ¥æ”¶ <code>N</code> ä¸ªè¿ç»­çš„ã€ä½åˆ†è¾¨ç‡ RGB è§†é¢‘å¸§ä½œä¸ºè¾“å…¥ï¼ˆä¾‹å¦‚ï¼Œè®ºæ–‡ä¸­å¸¸ä½¿ç”¨ <code>N=100</code> å¸§ï¼Œæ¯å¸§åˆ†è¾¨ç‡ç¼©å°åˆ° <code>48x27</code> åƒç´ ï¼‰ã€‚</li><li>ç›´æ¥ä½¿ç”¨åŸå§‹çš„ã€é™é‡‡æ ·åçš„ RGB å¸§ï¼ˆè€Œä¸æ˜¯é¢„å…ˆè®¡ç®—çš„ç‰¹å¾ï¼Œå¦‚å¸§å·®æˆ–å…‰æµï¼‰ä½¿å¾—ç½‘ç»œå¯ä»¥ç«¯åˆ°ç«¯åœ°å­¦ä¹ æœ€ä¼˜çš„è§†è§‰ç‰¹å¾ã€‚</li></ul></li><li>å¸§ç¼–ç  (Frame Encoding)ï¼š<ul><li>è¾“å…¥çš„æ¯ä¸€å¸§é¦–å…ˆä¼šç»è¿‡ä¸¤ä¸ª 2D å·ç§¯å±‚å’Œæœ€å¤§æ± åŒ–å±‚ï¼Œç”¨äºæå–ç©ºé—´ç‰¹å¾ã€‚</li><li>è¿™äº›ç‰¹å¾å›¾éšåè¢«å±•å¹³ (flatten) å¹¶æŒ‰æ—¶é—´é¡ºåºå †å èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªç‰¹å¾åºåˆ—ã€‚</li></ul></li><li>æ—¶é—´å»ºæ¨¡ (Temporal Modeling) - æ ¸å¿ƒéƒ¨åˆ†ï¼š<ul><li>TransNet V2 çš„æ ¸å¿ƒæ˜¯ä¸€å †ä¸€ç»´æ‰©å¼ å·ç§¯ (1D Dilated Convolutions) å—ï¼Œå®ƒä»¬ä½œç”¨äºå¸§ç‰¹å¾åºåˆ—ã€‚</li><li>ä¸€ç»´å·ç§¯ï¼š éå¸¸é€‚åˆå¤„ç†åºåˆ—æ•°æ®ï¼Œè®¡ç®—æ•ˆç‡é«˜ã€‚</li><li>æ‰©å¼ å·ç§¯ (Dilated Convolutions)ï¼š å…è®¸ç½‘ç»œåœ¨ä¸æ˜¾è‘—å¢åŠ å‚æ•°æ•°é‡æˆ–è®¡ç®—æˆæœ¬ï¼ˆé€šè¿‡é¿å…è¿‡å¤šçš„æ± åŒ–å±‚ï¼‰çš„æƒ…å†µä¸‹ï¼Œæ‹¥æœ‰éå¸¸å¤§çš„æ„Ÿå—é‡ï¼ˆå³èƒ½çœ‹åˆ°å¾ˆé•¿çš„æ—¶é—´ä¸Šä¸‹æ–‡ï¼‰ã€‚è¿™å¯¹äºæ£€æµ‹è·¨è¶Šå¤šå¸§çš„æ¸å˜è½¬åœºè‡³å…³é‡è¦ã€‚æ¯ä¸ªæ‰©å¼ å·ç§¯å—é€šå¸¸åŒ…å«ä¸€ä¸ªæ‰©å¼ ä¸€ç»´å·ç§¯å±‚ã€æ‰¹é‡å½’ä¸€åŒ– (Batch Normalization)ã€ReLU æ¿€æ´»å‡½æ•°å’Œ Dropoutã€‚</li></ul></li><li>åŒé¢„æµ‹å¤´ (Dual Prediction Heads)ï¼š<br>ç½‘ç»œä»æœ€åä¸€ä¸ªæ‰©å¼ å·ç§¯å±‚çš„è¾“å‡ºç‰¹å¾ä¸­å¼•å‡ºä¸¤ä¸ªåˆ†æ”¯ï¼ˆé¢„æµ‹å¤´ï¼‰ï¼š<ol><li>è½¬åœºæ¦‚ç‡é¢„æµ‹ (Transition Probability Prediction)ï¼š ä¸€ä¸ªæ ¸å¤§å°ä¸º 1 çš„ä¸€ç»´å·ç§¯å±‚ï¼Œåæ¥ Sigmoid æ¿€æ´»å‡½æ•°ã€‚å¯¹è¾“å…¥åºåˆ—ä¸­çš„æ¯ä¸€å¸§è¾“å‡ºä¸€ä¸ªæ¦‚ç‡å€¼ï¼ˆ0 åˆ° 1ï¼‰ï¼Œè¡¨ç¤ºè¯¥å¸§æ˜¯é•œå¤´è¾¹ç•Œï¼ˆç¡¬åˆ‡æˆ–æ¸å˜è½¬åœºçš„ä¸­å¿ƒï¼‰çš„å¯èƒ½æ€§ã€‚ä½¿ç”¨äºŒå…ƒäº¤å‰ç†µ (BCE) æŸå¤±è¿›è¡Œè®­ç»ƒã€‚</li><li>è½¬åœºç±»å‹é¢„æµ‹ (Transition Type Prediction - One-Hot)ï¼š å¦ä¸€ä¸ªæ ¸å¤§å°ä¸º 1 çš„ä¸€ç»´å·ç§¯å±‚ï¼Œæœ‰ 3 ä¸ªè¾“å‡ºé€šé“ï¼Œæ¯ä¸ªé€šé“åæ¥ Sigmoidã€‚å®ƒä»¬åˆ†åˆ«é¢„æµ‹æ¯ä¸€å¸§å±äºä»¥ä¸‹ç±»åˆ«çš„æ¦‚ç‡ï¼š<ul><li>æ— é•œå¤´è½¬åœº</li><li>ç¡¬åˆ‡</li><li>æ¸å˜è½¬åœºçš„ä¸­å¿ƒ<br>è¿™è¢«è§†ä¸ºä¸‰ä¸ªç‹¬ç«‹çš„äºŒåˆ†ç±»é—®é¢˜ï¼ŒåŒæ ·ä½¿ç”¨ BCE æŸå¤±è®­ç»ƒã€‚è¿™ä¸ªè¾…åŠ©ä»»åŠ¡æœ‰åŠ©äºç½‘ç»œå­¦ä¹ æ›´ä¸°å¯Œçš„ç‰¹å¾ã€‚</li></ul></li></ol></li><li>ç»„åˆæŸå¤± (Combined Loss)ï¼š<br>æ€»æŸå¤±æ˜¯ä¸¤ä¸ªé¢„æµ‹å¤´ BCE æŸå¤±çš„åŠ æƒå’Œã€‚</li></ul></li><li><p>æ¨¡å‹ä¼˜åŠ¿ï¼š</p><ul><li>é«˜å‡†ç¡®æ€§ï¼š åœ¨å¤šä¸ªæ ‡å‡† SBD æ•°æ®é›†ï¼ˆå¦‚ ClipShots, TRECVID IACC.3, RAI, BBC Planet Earthï¼‰ä¸Šå–å¾—äº†ä¸šç•Œé¢†å…ˆ (SOTA) çš„ç»“æœã€‚</li><li>é«˜é€Ÿåº¦ï¼š ä¸ºæ•ˆç‡è€Œè®¾è®¡ï¼Œåœ¨ç°ä»£ GPU ä¸Šèƒ½å¤Ÿå®ç°è¿œè¶…å®æ—¶çš„å¤„ç†é€Ÿåº¦ï¼ˆä¾‹å¦‚ï¼Œåœ¨ NVIDIA V100 ä¸Šç½‘ç»œæ¨ç†éƒ¨åˆ†çº¦ 150 FPSï¼Œä¸åŒ…æ‹¬è§†é¢‘è§£ç ï¼‰ã€‚</li><li>é²æ£’æ€§å¼ºï¼š èƒ½å¤Ÿæœ‰æ•ˆå¤„ç†ç¡¬åˆ‡å’Œå„ç§å¤æ‚çš„æ¸å˜è½¬åœºã€‚</li><li>ç«¯åˆ°ç«¯å­¦ä¹ ï¼š ç›´æ¥ä»ä½åˆ†è¾¨ç‡ RGB å¸§ä¸­å­¦ä¹ ç‰¹å¾ï¼Œæ— éœ€å¤æ‚çš„æ‰‹åŠ¨ç‰¹å¾å·¥ç¨‹ã€‚</li></ul></li></ol><h2 id="TransNet-V2-ä½¿ç”¨æ–¹æ³•-æ¨ç†ä¸åå¤„ç†">TransNet V2 ä½¿ç”¨æ–¹æ³• (æ¨ç†ä¸åå¤„ç†)</h2><ol><li><p>è¾“å…¥è§†é¢‘å¤„ç†ï¼š</p><ul><li>å°†è§†é¢‘è§£ç æˆå•ç‹¬çš„å¸§ã€‚</li><li>å°†æ¯ä¸€å¸§çš„å¤§å°è°ƒæ•´åˆ°ç½‘ç»œæ‰€éœ€çš„è¾“å…¥åˆ†è¾¨ç‡ï¼ˆä¾‹å¦‚ <code>48x27</code> åƒç´ ï¼‰ã€‚</li></ul></li><li><p>æ»‘åŠ¨çª—å£æ¨ç†ï¼š</p><ul><li>è§†é¢‘ä»¥ <code>N</code> å¸§ï¼ˆå¦‚ 100 å¸§ï¼‰çš„é‡å çª—å£è¿›è¡Œå¤„ç†ã€‚</li><li>å¯¹äºæ¯ä¸ªçª—å£ï¼Œç½‘ç»œä»ä¸»è¦çš„è½¬åœºæ¦‚ç‡é¢„æµ‹å¤´è¾“å‡º <code>N</code> ä¸ªæ¦‚ç‡å€¼ï¼ˆå¯¹åº”çª—å£ä¸­çš„æ¯ä¸€å¸§ï¼‰ã€‚</li><li>ç”±äºçª—å£æ˜¯é‡å çš„ï¼Œè§†é¢‘ä¸­çš„åŒä¸€å¸§å¯èƒ½ä¼šè·å¾—å¤šä¸ªé¢„æµ‹ã€‚é€šå¸¸ä¼šå¯¹è¿™äº›é¢„æµ‹è¿›è¡Œå¹³å‡ï¼Œä»¥è·å¾—è¯¥å¸§æ›´ç¨³å®šçš„æ¦‚ç‡ã€‚</li></ul></li><li><p>é¢„æµ‹ç»“æœåå¤„ç†ï¼š</p><ul><li>é˜ˆå€¼åŒ– (Thresholding)ï¼š<ul><li>å°†ï¼ˆå¹³å‡åçš„ï¼‰é€å¸§æ¦‚ç‡ä¸ä¸€ä¸ªé¢„å®šä¹‰çš„é˜ˆå€¼ <code>P_thresh</code> è¿›è¡Œæ¯”è¾ƒã€‚æ¦‚ç‡è¶…è¿‡æ­¤é˜ˆå€¼çš„å¸§è¢«è®¤ä¸ºæ˜¯å€™é€‰çš„é•œå¤´è¾¹ç•Œã€‚</li><li>è®ºæ–‡å»ºè®® <code>P_thresh = 0.5</code> æ˜¯ä¸€ä¸ªä¸é”™çš„é»˜è®¤å€¼ï¼Œä½†å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ã€‚</li></ul></li><li>æœ€å°é•œå¤´é•¿åº¦ (Minimum Shot Length - <code>L_min</code>)ï¼š<ul><li>ä¸ºäº†é¿å…äº§ç”Ÿè®¸å¤šéå¸¸çŸ­çš„ã€å¯èƒ½æ˜¯è¯¯æŠ¥çš„é•œå¤´ï¼Œä¼šæ–½åŠ ä¸€ä¸ªçº¦æŸï¼šä»»ä½•ä¼šå¯¼è‡´é•œå¤´é•¿åº¦å°äº <code>L_min</code> å¸§çš„æ£€æµ‹è¾¹ç•Œéƒ½ä¼šè¢«ä¸¢å¼ƒã€‚</li><li>è¿™é€šå¸¸é€šè¿‡éå†å€™é€‰è¾¹ç•Œå¹¶ç¡®ä¿å…¶ä¸å‰ä¸€ä¸ªå·²æ¥å—è¾¹ç•Œçš„è·ç¦»è‡³å°‘ä¸º <code>L_min</code> æ¥å®ç°ã€‚</li><li>è®ºæ–‡ä¸­æåˆ°æ ¹æ®æ•°æ®é›†æˆ–æœŸæœ›çš„ç²’åº¦ä½¿ç”¨ <code>L_min</code> å€¼ï¼Œå¦‚ 10 å¸§æˆ– 25 å¸§ã€‚</li></ul></li></ul></li><li><p>è¾“å‡ºï¼š</p><ul><li>æœ€ç»ˆè¾“å‡ºæ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼ŒåŒ…å«æ£€æµ‹åˆ°çš„é•œå¤´è¾¹ç•Œæ‰€åœ¨çš„å¸§ç´¢å¼•å·ã€‚</li><li>å¯é€‰åœ°ï¼Œå¯ä»¥ä½¿ç”¨è½¬åœºç±»å‹é¢„æµ‹å¤´çš„è¾“å‡ºæ¥å¯¹æ£€æµ‹åˆ°çš„è¾¹ç•Œè¿›è¡Œåˆ†ç±»ï¼Œä½†é€šå¸¸ä¸»è¦å…³æ³¨çš„æ˜¯è¾¹ç•Œçš„æ£€æµ‹æœ¬<br>èº«ã€‚</li></ul></li></ol><ul><li>æ¨¡å‹æ£€æµ‹ç»“æœ</li></ul><p><img src="/2025/06/09/TransNetV2-model-use/detect_result.png" class="lazyload placeholder" data-srcset="/2025/06/09/TransNetV2-model-use/detect_result.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="ä½¿ç”¨">ä½¿ç”¨</h2><h3 id="æ¨¡å‹æ¨ç†">æ¨¡å‹æ¨ç†</h3><ul><li>æ¨ç†è„šæœ¬å¦‚ä¸‹ï¼š</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys  <span class="comment"># å¼•å…¥ sys ä»¥ä¾¿ä½¿ç”¨ sys.stderr</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TransNetV2</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model_dir=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="keyword">if</span> model_dir <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            model_dir = os.path.join(os.path.dirname(__file__), <span class="string">&quot;transnetv2-weights/&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(model_dir):</span><br><span class="line">                <span class="keyword">raise</span> FileNotFoundError(<span class="string">f&quot;[TransNetV2] ERROR: <span class="subst">&#123;model_dir&#125;</span> is not a directory.&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2] Using weights from <span class="subst">&#123;model_dir&#125;</span>.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>._input_size = (<span class="number">27</span>, <span class="number">48</span>, <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>._model = tf.saved_model.load(model_dir)</span><br><span class="line">        <span class="keyword">except</span> OSError <span class="keyword">as</span> exc:</span><br><span class="line">            <span class="keyword">raise</span> IOError(<span class="string">f&quot;[TransNetV2] It seems that files in <span class="subst">&#123;model_dir&#125;</span> are corrupted or missing. &quot;</span></span><br><span class="line">                          <span class="string">f&quot;Re-download them manually and retry. For more info, see: &quot;</span></span><br><span class="line">                          <span class="string">f&quot;https://github.com/soCzech/TransNetV2/issues/1#issuecomment-647357796&quot;</span>) <span class="keyword">from</span> exc</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">predict_raw</span>(<span class="params">self, frames: np.ndarray</span>):</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(frames.shape) == <span class="number">5</span> <span class="keyword">and</span> frames.shape[<span class="number">2</span>:] == <span class="variable language_">self</span>._input_size, \</span><br><span class="line">            <span class="string">&quot;[TransNetV2] Input shape must be [batch, frames, height, width, 3].&quot;</span></span><br><span class="line">        frames = tf.cast(frames, tf.float32)</span><br><span class="line"></span><br><span class="line">        logits, dict_ = <span class="variable language_">self</span>._model(frames)</span><br><span class="line">        single_frame_pred = tf.sigmoid(logits)</span><br><span class="line">        all_frames_pred = tf.sigmoid(dict_[<span class="string">&quot;many_hot&quot;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> single_frame_pred, all_frames_pred</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">predict_frames</span>(<span class="params">self, frames: np.ndarray</span>):</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(frames.shape) == <span class="number">4</span> <span class="keyword">and</span> frames.shape[<span class="number">1</span>:] == <span class="variable language_">self</span>._input_size, \</span><br><span class="line">            <span class="string">&quot;[TransNetV2] Input shape must be [frames, height, width, 3].&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">input_iterator</span>():</span><br><span class="line">            <span class="comment"># return windows of size 100 where the first/last 25 frames are from the previous/next batch</span></span><br><span class="line">            <span class="comment"># the first and last window must be padded by copies of the first and last frame of the video</span></span><br><span class="line">            no_padded_frames_start = <span class="number">25</span></span><br><span class="line">            no_padded_frames_end = <span class="number">25</span> + <span class="number">50</span> - (<span class="built_in">len</span>(frames) % <span class="number">50</span> <span class="keyword">if</span> <span class="built_in">len</span>(frames) % <span class="number">50</span> != <span class="number">0</span> <span class="keyword">else</span> <span class="number">50</span>)  <span class="comment"># 25 - 74</span></span><br><span class="line"></span><br><span class="line">            start_frame = np.expand_dims(frames[<span class="number">0</span>], <span class="number">0</span>)</span><br><span class="line">            end_frame = np.expand_dims(frames[-<span class="number">1</span>], <span class="number">0</span>)</span><br><span class="line">            padded_inputs = np.concatenate(</span><br><span class="line">                ([start_frame] * no_padded_frames_start) + [frames] + ([end_frame] * no_padded_frames_end), <span class="number">0</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            ptr = <span class="number">0</span></span><br><span class="line">            <span class="keyword">while</span> ptr + <span class="number">100</span> &lt;= <span class="built_in">len</span>(padded_inputs):</span><br><span class="line">                out = padded_inputs[ptr:ptr + <span class="number">100</span>]</span><br><span class="line">                ptr += <span class="number">50</span></span><br><span class="line">                <span class="keyword">yield</span> out[np.newaxis]</span><br><span class="line"></span><br><span class="line">        predictions = []</span><br><span class="line"></span><br><span class="line">        <span class="comment"># åœ¨å¾ªç¯å¤–éƒ¨åˆå§‹åŒ–å¤„ç†å¸§æ•°çš„è®¡æ•°å™¨</span></span><br><span class="line">        processed_frames_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> inp <span class="keyword">in</span> input_iterator():</span><br><span class="line">            single_frame_pred, all_frames_pred = <span class="variable language_">self</span>.predict_raw(inp)</span><br><span class="line">            predictions.append((single_frame_pred.numpy()[<span class="number">0</span>, <span class="number">25</span>:<span class="number">75</span>, <span class="number">0</span>],</span><br><span class="line">                                all_frames_pred.numpy()[<span class="number">0</span>, <span class="number">25</span>:<span class="number">75</span>, <span class="number">0</span>]))</span><br><span class="line"></span><br><span class="line">            processed_frames_count = <span class="built_in">min</span>(<span class="built_in">len</span>(predictions) * <span class="number">50</span>, <span class="built_in">len</span>(frames))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\r[TransNetV2] Processing video frames &#123;&#125;/&#123;&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">                processed_frames_count, <span class="built_in">len</span>(frames)</span><br><span class="line">            ), end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç¡®ä¿å³ä½¿è§†é¢‘å¸§æ•°å°‘äºä¸€ä¸ªæ‰¹æ¬¡ï¼Œä¹Ÿä¼šæ‰“å°æœ€ç»ˆçš„æ¢è¡Œç¬¦</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(frames) &gt; <span class="number">0</span>:  <span class="comment"># åªæœ‰åœ¨æœ‰å¸§çš„æƒ…å†µä¸‹æ‰æ‰“å°æ¢è¡Œï¼Œé¿å…ç©ºè§†é¢‘ä¹Ÿæ‰“å°</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">        single_frame_pred_list = [single_ <span class="keyword">for</span> single_, all_ <span class="keyword">in</span> predictions]</span><br><span class="line">        all_frames_pred_list = [all_ <span class="keyword">for</span> single_, all_ <span class="keyword">in</span> predictions]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> single_frame_pred_list:  <span class="comment"># å¦‚æœ predictions ä¸ºç©º (ä¾‹å¦‚ï¼Œè§†é¢‘å¸§æ•°éå¸¸å°‘)</span></span><br><span class="line">            <span class="comment"># æ ¹æ® frames çš„é•¿åº¦åˆ›å»ºä¸€ä¸ªå…¨é›¶çš„é¢„æµ‹æ•°ç»„</span></span><br><span class="line">            <span class="comment"># è¿™ç¡®ä¿äº†å³ä½¿æ²¡æœ‰é€šè¿‡è¿­ä»£å™¨å¤„ç†ä»»ä½•å†…å®¹ï¼Œä¹Ÿä¼šè¿”å›æ­£ç¡®å½¢çŠ¶çš„æ•°ç»„</span></span><br><span class="line">            <span class="comment"># ï¼ˆå°½ç®¡å¯¹äºéå¸¸çŸ­çš„è§†é¢‘ï¼Œè¿™å¯èƒ½ä»ç„¶ä¸æ˜¯ç†æƒ³çš„ï¼Œä½†è‡³å°‘é¿å…äº† concatenate ç©ºåˆ—è¡¨çš„é”™è¯¯ï¼‰</span></span><br><span class="line">            <span class="built_in">print</span>(</span><br><span class="line">                <span class="string">f&quot;[TransNetV2 WARNING] No predictions generated from input_iterator for a video of length <span class="subst">&#123;<span class="built_in">len</span>(frames)&#125;</span>. Returning zeros.&quot;</span>,</span><br><span class="line">                file=sys.stderr)</span><br><span class="line">            empty_preds_shape = (<span class="built_in">len</span>(frames),)  <span class="comment"># æˆ–è€… (0,) å¦‚æœ len(frames) æ˜¯ 0</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(frames) == <span class="number">0</span>:  <span class="comment"># å¤„ç†0å¸§è§†é¢‘çš„æç«¯æƒ…å†µ</span></span><br><span class="line">                <span class="keyword">return</span> np.array([]), np.array([])</span><br><span class="line">            <span class="keyword">return</span> np.zeros(empty_preds_shape, dtype=np.float32), np.zeros(empty_preds_shape, dtype=np.float32)</span><br><span class="line"></span><br><span class="line">        single_frame_pred_concatenated = np.concatenate(single_frame_pred_list)</span><br><span class="line">        all_frames_pred_concatenated = np.concatenate(all_frames_pred_list)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> single_frame_pred_concatenated[:<span class="built_in">len</span>(frames)], all_frames_pred_concatenated[</span><br><span class="line">                                                             :<span class="built_in">len</span>(frames)]  <span class="comment"># remove extra padded frames</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">predict_video</span>(<span class="params">self, video_fn: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">import</span> ffmpeg</span><br><span class="line">        <span class="keyword">except</span> ModuleNotFoundError:</span><br><span class="line">            <span class="keyword">raise</span> ModuleNotFoundError(<span class="string">&quot;For `predict_video` function `ffmpeg` needs to be installed in order to extract &quot;</span></span><br><span class="line">                                      <span class="string">&quot;individual frames from video file. Install `ffmpeg` command line tool and then &quot;</span></span><br><span class="line">                                      <span class="string">&quot;install python wrapper by `pip install ffmpeg-python`.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[TransNetV2] Extracting frames from &#123;&#125;&quot;</span>.<span class="built_in">format</span>(video_fn))</span><br><span class="line">        video_stream, err = <span class="literal">None</span>, <span class="literal">None</span>  <span class="comment"># Initialize</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            process = (</span><br><span class="line">                ffmpeg</span><br><span class="line">                .<span class="built_in">input</span>(video_fn)</span><br><span class="line">                .output(<span class="string">&quot;pipe:&quot;</span>, <span class="built_in">format</span>=<span class="string">&quot;rawvideo&quot;</span>, pix_fmt=<span class="string">&quot;rgb24&quot;</span>, s=<span class="string">&quot;48x27&quot;</span>)</span><br><span class="line">                .run_async(pipe_stdout=<span class="literal">True</span>, pipe_stderr=<span class="literal">True</span>)</span><br><span class="line">            )</span><br><span class="line">            video_stream, err = process.communicate()  <span class="comment"># Get output after process finishes</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> process.returncode != <span class="number">0</span>:</span><br><span class="line">                <span class="built_in">print</span>(</span><br><span class="line">                    <span class="string">f&quot;[TransNetV2 ERROR] ffmpeg process failed for <span class="subst">&#123;os.path.basename(video_fn)&#125;</span> with exit code <span class="subst">&#123;process.returncode&#125;</span>.&quot;</span>,</span><br><span class="line">                    file=sys.stderr)</span><br><span class="line">                <span class="keyword">if</span> err:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 ERROR] ffmpeg stderr:\n<span class="subst">&#123;err.decode(errors=<span class="string">&#x27;ignore&#x27;</span>)&#125;</span>&quot;</span>, file=sys.stderr)</span><br><span class="line">                <span class="keyword">return</span> np.array([]), np.array([]), np.array([])  <span class="comment"># Return empty arrays indicating failure</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> err:  <span class="comment"># Even if return code is 0, check stderr</span></span><br><span class="line">                <span class="comment"># Not all messages on stderr are errors, but log them as warnings</span></span><br><span class="line">                <span class="comment"># Filter out common non-error messages if necessary, or log all for debugging</span></span><br><span class="line">                decoded_err = err.decode(errors=<span class="string">&#x27;ignore&#x27;</span>).strip()</span><br><span class="line">                <span class="keyword">if</span> decoded_err:  <span class="comment"># Only print if there&#x27;s actual content</span></span><br><span class="line">                    <span class="built_in">print</span>(</span><br><span class="line">                        <span class="string">f&quot;[TransNetV2 WARNING] ffmpeg stderr for <span class="subst">&#123;os.path.basename(video_fn)&#125;</span> (exit code <span class="subst">&#123;process.returncode&#125;</span>):\n<span class="subst">&#123;decoded_err&#125;</span>&quot;</span>,</span><br><span class="line">                        file=sys.stderr)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> video_stream:</span><br><span class="line">                <span class="built_in">print</span>(</span><br><span class="line">                    <span class="string">f&quot;[TransNetV2 ERROR] ffmpeg produced no video stream for <span class="subst">&#123;os.path.basename(video_fn)&#125;</span>. Cannot proceed.&quot;</span>,</span><br><span class="line">                    file=sys.stderr)</span><br><span class="line">                <span class="keyword">return</span> np.array([]), np.array([]), np.array([])  <span class="comment"># Return empty</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> ffmpeg.Error <span class="keyword">as</span> e_ffmpeg:  <span class="comment"># Catch ffmpeg&#x27;s own errors</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 ERROR] ffmpeg.Error during frame extraction for <span class="subst">&#123;os.path.basename(video_fn)&#125;</span>:&quot;</span>,</span><br><span class="line">                  file=sys.stderr)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">hasattr</span>(e_ffmpeg, <span class="string">&#x27;stderr&#x27;</span>) <span class="keyword">and</span> e_ffmpeg.stderr:</span><br><span class="line">                <span class="built_in">print</span>(e_ffmpeg.stderr.decode(errors=<span class="string">&#x27;ignore&#x27;</span>), file=sys.stderr)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="built_in">str</span>(e_ffmpeg), file=sys.stderr)</span><br><span class="line">            <span class="keyword">return</span> np.array([]), np.array([]), np.array([])  <span class="comment"># Return empty</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e_generic_ffmpeg:  <span class="comment"># Catch other potential errors during ffmpeg processing</span></span><br><span class="line">            <span class="built_in">print</span>(</span><br><span class="line">                <span class="string">f&quot;[TransNetV2 ERROR] Generic exception during ffmpeg processing for <span class="subst">&#123;os.path.basename(video_fn)&#125;</span>: <span class="subst">&#123;e_generic_ffmpeg&#125;</span>&quot;</span>,</span><br><span class="line">                file=sys.stderr)</span><br><span class="line">            <span class="keyword">return</span> np.array([]), np.array([]), np.array([])  <span class="comment"># Return empty</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> video_stream <span class="keyword">is</span> <span class="literal">None</span>:  <span class="comment"># Should have been caught above, but as a safeguard</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 ERROR] video_stream is None after ffmpeg processing for <span class="subst">&#123;os.path.basename(video_fn)&#125;</span>.&quot;</span>,</span><br><span class="line">                  file=sys.stderr)</span><br><span class="line">            <span class="keyword">return</span> np.array([]), np.array([]), np.array([])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            video = np.frombuffer(video_stream, np.uint8).reshape([-<span class="number">1</span>, <span class="number">27</span>, <span class="number">48</span>, <span class="number">3</span>])</span><br><span class="line">        <span class="keyword">except</span> ValueError <span class="keyword">as</span> e_reshape:</span><br><span class="line">            <span class="built_in">print</span>(</span><br><span class="line">                <span class="string">f&quot;[TransNetV2 ERROR] Failed to reshape video_stream for <span class="subst">&#123;os.path.basename(video_fn)&#125;</span>. Stream length: <span class="subst">&#123;<span class="built_in">len</span>(video_stream)&#125;</span>. Error: <span class="subst">&#123;e_reshape&#125;</span>&quot;</span>,</span><br><span class="line">                file=sys.stderr)</span><br><span class="line">            <span class="keyword">return</span> np.array([]), np.array([]), np.array([])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> video.shape[<span class="number">0</span>] == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(</span><br><span class="line">                <span class="string">f&quot;[TransNetV2 ERROR] Extracted 0 frames from <span class="subst">&#123;os.path.basename(video_fn)&#125;</span> after ffmpeg. Cannot proceed.&quot;</span>,</span><br><span class="line">                file=sys.stderr)</span><br><span class="line">            <span class="keyword">return</span> np.array([]), np.array([]), np.array([])  <span class="comment"># Return empty</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (video, *<span class="variable language_">self</span>.predict_frames(video))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">predictions_to_scenes</span>(<span class="params">predictions: np.ndarray, threshold: <span class="built_in">float</span> = <span class="number">0.5</span></span>):</span><br><span class="line">        <span class="keyword">if</span> predictions <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> predictions.size == <span class="number">0</span>:  <span class="comment"># Handle empty or None predictions</span></span><br><span class="line">            <span class="built_in">print</span>(</span><br><span class="line">                <span class="string">&quot;[TransNetV2 DEBUG] predictions_to_scenes received empty or None predictions. Returning empty scenes.&quot;</span>,</span><br><span class="line">                file=sys.stderr)</span><br><span class="line">            <span class="keyword">return</span> np.array([], dtype=np.int32)  <span class="comment"># Return empty array of correct type</span></span><br><span class="line"></span><br><span class="line">        predictions = (predictions &gt; threshold).astype(np.uint8)</span><br><span class="line"></span><br><span class="line">        scenes = []</span><br><span class="line">        t, t_prev, start = -<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i, t_current_frame_pred <span class="keyword">in</span> <span class="built_in">enumerate</span>(predictions):  <span class="comment"># Renamed &#x27;t&#x27; to avoid conflict</span></span><br><span class="line">            <span class="keyword">if</span> t_prev == <span class="number">1</span> <span class="keyword">and</span> t_current_frame_pred == <span class="number">0</span>:</span><br><span class="line">                start = i</span><br><span class="line">            <span class="keyword">if</span> t_prev == <span class="number">0</span> <span class="keyword">and</span> t_current_frame_pred == <span class="number">1</span> <span class="keyword">and</span> i != <span class="number">0</span>:</span><br><span class="line">                scenes.append([start, i])</span><br><span class="line">            t_prev = t_current_frame_pred</span><br><span class="line"></span><br><span class="line">        <span class="comment"># After loop, check if the video ends in a shot (t_prev will be 0 if it ended with a transition, or 1 if it ended mid-shot)</span></span><br><span class="line">        <span class="comment"># The original logic for &#x27;if t == 0:&#x27; was based on the last prediction value.</span></span><br><span class="line">        <span class="comment"># If the last prediction was 0 (meaning it&#x27;s part of a shot that started earlier)</span></span><br><span class="line">        <span class="keyword">if</span> t_prev == <span class="number">0</span> <span class="keyword">and</span> <span class="built_in">len</span>(predictions) &gt; <span class="number">0</span>:  <span class="comment"># Ensure there was at least one prediction</span></span><br><span class="line">            <span class="comment"># If start is not the beginning of the video and a shot has started</span></span><br><span class="line">            <span class="keyword">if</span> start &lt; <span class="built_in">len</span>(predictions):  <span class="comment"># Make sure start is a valid index</span></span><br><span class="line">                scenes.append([start, <span class="built_in">len</span>(predictions) - <span class="number">1</span>])  <span class="comment"># Shot goes to the end</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># just fix if all predictions are 1 (no transitions found, so one scene from start to end)</span></span><br><span class="line">        <span class="comment"># or if all predictions are 0 (also one scene from start to end, after fixing start to 0)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> scenes <span class="keyword">and</span> <span class="built_in">len</span>(predictions) &gt; <span class="number">0</span>:  <span class="comment"># If no scenes were appended and there are predictions</span></span><br><span class="line">            <span class="built_in">print</span>(</span><br><span class="line">                <span class="string">&quot;[TransNetV2 DEBUG] No scenes detected by transition logic, assuming single scene for the entire video.&quot;</span>,</span><br><span class="line">                file=sys.stderr)</span><br><span class="line">            <span class="keyword">return</span> np.array([[<span class="number">0</span>, <span class="built_in">len</span>(predictions) - <span class="number">1</span>]], dtype=np.int32)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> scenes <span class="keyword">and</span> <span class="built_in">len</span>(predictions) == <span class="number">0</span>:  <span class="comment"># If no predictions at all</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[TransNetV2 DEBUG] No predictions, returning empty scenes array.&quot;</span>, file=sys.stderr)</span><br><span class="line">            <span class="keyword">return</span> np.array([], dtype=np.int32)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> np.array(scenes, dtype=np.int32)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">visualize_predictions</span>(<span class="params">frames: np.ndarray, predictions</span>):</span><br><span class="line">        <span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageDraw</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> frames <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> frames.size == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[TransNetV2 WARNING] visualize_predictions received no frames. Skipping visualization.&quot;</span>,</span><br><span class="line">                  file=sys.stderr)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span>  <span class="comment"># Or a placeholder image</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(predictions, np.ndarray):</span><br><span class="line">            predictions = [predictions]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Filter out None or empty prediction arrays</span></span><br><span class="line">        valid_predictions = []</span><br><span class="line">        <span class="keyword">for</span> p_arr <span class="keyword">in</span> predictions:</span><br><span class="line">            <span class="keyword">if</span> p_arr <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> p_arr.size &gt; <span class="number">0</span>:</span><br><span class="line">                valid_predictions.append(p_arr)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> valid_predictions:</span><br><span class="line">            <span class="built_in">print</span>(</span><br><span class="line">                <span class="string">&quot;[TransNetV2 WARNING] visualize_predictions received no valid prediction arrays. Skipping visualization.&quot;</span>,</span><br><span class="line">                file=sys.stderr)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span>  <span class="comment"># Or a placeholder image</span></span><br><span class="line">        predictions = valid_predictions</span><br><span class="line"></span><br><span class="line">        ih, iw, ic = frames.shape[<span class="number">1</span>:]</span><br><span class="line">        width = <span class="number">25</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># pad frames so that length of the video is divisible by width</span></span><br><span class="line">        <span class="comment"># pad frames also by len(predictions) pixels in width in order to show predictions</span></span><br><span class="line">        pad_with = width - <span class="built_in">len</span>(frames) % width <span class="keyword">if</span> <span class="built_in">len</span>(frames) % width != <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">        <span class="comment"># Ensure pad_with is not negative if len(frames) is 0</span></span><br><span class="line">        pad_with = <span class="built_in">max</span>(<span class="number">0</span>, pad_with)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Pad frames, ensuring frames is not empty</span></span><br><span class="line">        <span class="keyword">if</span> frames.size &gt; <span class="number">0</span>:</span><br><span class="line">            frames = np.pad(frames, [(<span class="number">0</span>, pad_with), (<span class="number">0</span>, <span class="number">1</span>), (<span class="number">0</span>, <span class="built_in">len</span>(predictions)), (<span class="number">0</span>, <span class="number">0</span>)])</span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># Should not happen if caught earlier, but as a safeguard</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        predictions = [np.pad(x, (<span class="number">0</span>, pad_with)) <span class="keyword">for</span> x <span class="keyword">in</span> predictions]</span><br><span class="line">        height = <span class="built_in">len</span>(frames) // width</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> height == <span class="number">0</span> <span class="keyword">or</span> width == <span class="number">0</span>:  <span class="comment"># Avoid division by zero or empty reshape</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[TransNetV2 WARNING] Cannot create visualization due to zero height or width after padding.&quot;</span>,</span><br><span class="line">                  file=sys.stderr)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        img = frames.reshape([height, width, ih + <span class="number">1</span>, iw + <span class="built_in">len</span>(predictions), ic])</span><br><span class="line">        img = np.concatenate(np.split(</span><br><span class="line">            np.concatenate(np.split(img, height, axis=<span class="number">0</span>), axis=<span class="number">2</span>)[<span class="number">0</span>], width, axis=<span class="number">1</span>  <span class="comment"># Corrected axis for split</span></span><br><span class="line">        ), axis=<span class="number">2</span>)[<span class="number">0</span>, :-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        img = Image.fromarray(img)</span><br><span class="line">        draw = ImageDraw.Draw(img)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># iterate over all frames</span></span><br><span class="line">        <span class="keyword">for</span> i, pred_tuple <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="built_in">zip</span>(*predictions)):  <span class="comment"># pred_tuple contains predictions for frame i</span></span><br><span class="line">            x_base, y_base = i % width, i // width  <span class="comment"># Top-left corner of the frame in the grid</span></span><br><span class="line">            x_offset, y_offset = x_base * (iw + <span class="built_in">len</span>(predictions)) + iw, y_base * (</span><br><span class="line">                    ih + <span class="number">1</span>) + ih - <span class="number">1</span>  <span class="comment"># Bottom-right of frame content, before prediction lines</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># we can visualize multiple predictions per single frame</span></span><br><span class="line">            <span class="keyword">for</span> j, p_value <span class="keyword">in</span> <span class="built_in">enumerate</span>(pred_tuple):  <span class="comment"># j is prediction type index, p_value is its value</span></span><br><span class="line">                color = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">                <span class="comment"># Cycle through R, G, B for different prediction types</span></span><br><span class="line">                color[j % <span class="number">3</span>] = <span class="number">255</span>  <span class="comment"># Use j for color to distinguish prediction types</span></span><br><span class="line"></span><br><span class="line">                value_scaled = <span class="built_in">round</span>(p_value * (ih - <span class="number">1</span>))  <span class="comment"># Scale prediction to frame height</span></span><br><span class="line">                <span class="keyword">if</span> value_scaled != <span class="number">0</span>:</span><br><span class="line">                    <span class="comment"># Draw line upwards from the bottom edge of the frame visualization area</span></span><br><span class="line">                    draw.line((x_offset + j, y_offset, x_offset + j, y_offset - value_scaled), fill=<span class="built_in">tuple</span>(color),</span><br><span class="line">                              width=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> img</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">import</span> argparse  <span class="comment"># Already imported sys</span></span><br><span class="line"></span><br><span class="line">    parser = argparse.ArgumentParser()</span><br><span class="line">    parser.add_argument(<span class="string">&quot;files&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, nargs=<span class="string">&quot;+&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;path to video files to process&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--weights&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="literal">None</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;path to TransNet V2 weights, tries to infer the location if not specified&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--visualize&#x27;</span>, action=<span class="string">&quot;store_true&quot;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;save a png file with prediction visualization for each extracted video&quot;</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        model = TransNetV2(args.weights)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e_model_load:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 CRITICAL] Failed to load TransNetV2 model: <span class="subst">&#123;e_model_load&#125;</span>&quot;</span>, file=sys.stderr)</span><br><span class="line">        sys.exit(<span class="number">1</span>)  <span class="comment"># Exit if model fails to load</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> args.files:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 INFO] Processing file: <span class="subst">&#123;file&#125;</span>&quot;</span>, file=sys.stderr)</span><br><span class="line">        <span class="comment"># This pre-check is fine, but the calling script test_and_cut_video.py now also does pre-cleanup</span></span><br><span class="line">        <span class="keyword">if</span> os.path.exists(file + <span class="string">&quot;.predictions.txt&quot;</span>) <span class="keyword">or</span> os.path.exists(file + <span class="string">&quot;.scenes.txt&quot;</span>):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2] <span class="subst">&#123;file&#125;</span>.predictions.txt or <span class="subst">&#123;file&#125;</span>.scenes.txt already exists. &quot;</span></span><br><span class="line">                  <span class="string">f&quot;Skipping video <span class="subst">&#123;file&#125;</span>.&quot;</span>, file=sys.stderr)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            video_frames, single_frame_predictions, all_frame_predictions = \</span><br><span class="line">                model.predict_video(file)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># --- Debugging: Check outputs of predict_video ---</span></span><br><span class="line">            <span class="keyword">if</span> video_frames <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> video_frames.size == <span class="number">0</span>:</span><br><span class="line">                <span class="built_in">print</span>(</span><br><span class="line">                    <span class="string">f&quot;[TransNetV2 ERROR] predict_video returned no frames for <span class="subst">&#123;os.path.basename(file)&#125;</span>. Cannot save outputs.&quot;</span>,</span><br><span class="line">                    file=sys.stderr)</span><br><span class="line">                <span class="keyword">continue</span>  <span class="comment"># Skip to next file</span></span><br><span class="line">            <span class="keyword">if</span> single_frame_predictions <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> single_frame_predictions.size == <span class="number">0</span>:</span><br><span class="line">                <span class="built_in">print</span>(</span><br><span class="line">                    <span class="string">f&quot;[TransNetV2 ERROR] predict_video returned no single_frame_predictions for <span class="subst">&#123;os.path.basename(file)&#125;</span>. Cannot save outputs.&quot;</span>,</span><br><span class="line">                    file=sys.stderr)</span><br><span class="line">                <span class="keyword">continue</span>  <span class="comment"># Skip to next file</span></span><br><span class="line">            <span class="comment"># all_frame_predictions can sometimes be legitimately empty if single_frame_predictions is also empty.</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 DEBUG] Returned from predict_video for <span class="subst">&#123;os.path.basename(file)&#125;</span>.&quot;</span>, file=sys.stderr)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 DEBUG]   video_frames shape: <span class="subst">&#123;video_frames.shape&#125;</span>&quot;</span>, file=sys.stderr)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 DEBUG]   single_frame_predictions shape: <span class="subst">&#123;single_frame_predictions.shape&#125;</span>&quot;</span>,</span><br><span class="line">                  file=sys.stderr)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 DEBUG]   all_frame_predictions shape: <span class="subst">&#123;all_frame_predictions.shape&#125;</span>&quot;</span>, file=sys.stderr)</span><br><span class="line">            <span class="comment"># --- End Debugging ---</span></span><br><span class="line"></span><br><span class="line">            predictions = np.stack([single_frame_predictions, all_frame_predictions], <span class="number">1</span>)</span><br><span class="line">            predictions_filepath = file + <span class="string">&quot;.predictions.txt&quot;</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                np.savetxt(predictions_filepath, predictions, fmt=<span class="string">&quot;%.6f&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 DEBUG] Attempted to save predictions to <span class="subst">&#123;predictions_filepath&#125;</span>&quot;</span>, file=sys.stderr)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(predictions_filepath):</span><br><span class="line">                    <span class="built_in">print</span>(</span><br><span class="line">                        <span class="string">f&quot;[TransNetV2 CRITICAL DEBUG] Saved predictions but file <span class="subst">&#123;predictions_filepath&#125;</span> does NOT exist!&quot;</span>,</span><br><span class="line">                        file=sys.stderr)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 DEBUG] File <span class="subst">&#123;predictions_filepath&#125;</span> successfully created.&quot;</span>, file=sys.stderr)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e_pred_save:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 ERROR] Exception saving predictions file <span class="subst">&#123;predictions_filepath&#125;</span>: <span class="subst">&#123;e_pred_save&#125;</span>&quot;</span>,</span><br><span class="line">                      file=sys.stderr)</span><br><span class="line">                <span class="keyword">continue</span>  <span class="comment"># Skip to next file if saving predictions fails</span></span><br><span class="line"></span><br><span class="line">            scenes = model.predictions_to_scenes(single_frame_predictions)</span><br><span class="line">            <span class="built_in">print</span>(</span><br><span class="line">                <span class="string">f&quot;[TransNetV2 DEBUG] Scenes array for <span class="subst">&#123;os.path.basename(file)&#125;</span> (shape: <span class="subst">&#123;scenes.shape <span class="keyword">if</span> scenes <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">else</span> <span class="string">&#x27;None&#x27;</span>&#125;</span>):\n<span class="subst">&#123;scenes&#125;</span>&quot;</span>,</span><br><span class="line">                file=sys.stderr)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> scenes <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> scenes.size == <span class="number">0</span>:  <span class="comment"># Check if scenes array is empty</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 WARNING] Scenes array is empty or None for <span class="subst">&#123;os.path.basename(file)&#125;</span>. &quot;</span></span><br><span class="line">                      <span class="string">f&quot;No .scenes.txt will be saved, or it might be empty.&quot;</span>, file=sys.stderr)</span><br><span class="line">                <span class="comment"># Depending on desired behavior, you might &#x27;continue&#x27; here or let np.savetxt handle an empty array.</span></span><br><span class="line">                <span class="comment"># np.savetxt with an empty array will create an empty file.</span></span><br><span class="line">                <span class="comment"># If an empty scenes file is problematic for the parent script, handle it here.</span></span><br><span class="line">                <span class="comment"># For now, let it try to save, which will result in an empty file if scenes is empty.</span></span><br><span class="line"></span><br><span class="line">            scenes_filepath = file + <span class="string">&quot;.scenes.txt&quot;</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                np.savetxt(scenes_filepath, scenes, fmt=<span class="string">&quot;%d&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 DEBUG] Attempted to save scenes to <span class="subst">&#123;scenes_filepath&#125;</span>&quot;</span>, file=sys.stderr)</span><br><span class="line">                <span class="keyword">if</span> os.path.exists(scenes_filepath):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 DEBUG] File <span class="subst">&#123;scenes_filepath&#125;</span> successfully created.&quot;</span>, file=sys.stderr)</span><br><span class="line">                    <span class="comment"># Optionally, check file size or content for empty scenes</span></span><br><span class="line">                    <span class="keyword">if</span> scenes <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> scenes.size == <span class="number">0</span> <span class="keyword">and</span> os.path.getsize(scenes_filepath) == <span class="number">0</span>:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 DEBUG] <span class="subst">&#123;scenes_filepath&#125;</span> is empty as expected for empty scenes array.&quot;</span>,</span><br><span class="line">                              file=sys.stderr)</span><br><span class="line">                    <span class="keyword">elif</span> scenes <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> scenes.size &gt; <span class="number">0</span> <span class="keyword">and</span> os.path.getsize(scenes_filepath) == <span class="number">0</span>:</span><br><span class="line">                        <span class="built_in">print</span>(</span><br><span class="line">                            <span class="string">f&quot;[TransNetV2 WARNING] <span class="subst">&#123;scenes_filepath&#125;</span> is unexpectedly empty despite non-empty scenes array.&quot;</span>,</span><br><span class="line">                            file=sys.stderr)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(</span><br><span class="line">                        <span class="string">f&quot;[TransNetV2 CRITICAL DEBUG] Saved scenes but file <span class="subst">&#123;scenes_filepath&#125;</span> does NOT exist afterwards!&quot;</span>,</span><br><span class="line">                        file=sys.stderr)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e_save:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 ERROR] Exception during np.savetxt for .scenes.txt (<span class="subst">&#123;scenes_filepath&#125;</span>): <span class="subst">&#123;e_save&#125;</span>&quot;</span>,</span><br><span class="line">                      file=sys.stderr)</span><br><span class="line">                <span class="keyword">continue</span>  <span class="comment"># Skip to next file if saving scenes fails</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> args.visualize:</span><br><span class="line">                vis_filepath = file + <span class="string">&quot;.vis.png&quot;</span></span><br><span class="line">                <span class="keyword">if</span> os.path.exists(vis_filepath):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2] <span class="subst">&#123;vis_filepath&#125;</span> already exists. &quot;</span></span><br><span class="line">                          <span class="string">f&quot;Skipping visualization of video <span class="subst">&#123;file&#125;</span>.&quot;</span>, file=sys.stderr)</span><br><span class="line">                    <span class="comment"># continue # This continue was inside the loop for &#x27;file in args.files&#x27;</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 DEBUG] Attempting to visualize predictions for <span class="subst">&#123;os.path.basename(file)&#125;</span>&quot;</span>,</span><br><span class="line">                          file=sys.stderr)</span><br><span class="line">                    pil_image = model.visualize_predictions(</span><br><span class="line">                        video_frames, predictions=(single_frame_predictions, all_frame_predictions))</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> pil_image:</span><br><span class="line">                        <span class="keyword">try</span>:</span><br><span class="line">                            pil_image.save(vis_filepath)</span><br><span class="line">                            <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 DEBUG] Saved visualization to <span class="subst">&#123;vis_filepath&#125;</span>&quot;</span>, file=sys.stderr)</span><br><span class="line">                        <span class="keyword">except</span> Exception <span class="keyword">as</span> e_vis_save:</span><br><span class="line">                            <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 ERROR] Exception saving visualization <span class="subst">&#123;vis_filepath&#125;</span>: <span class="subst">&#123;e_vis_save&#125;</span>&quot;</span>,</span><br><span class="line">                                  file=sys.stderr)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 WARNING] Visualization not generated for <span class="subst">&#123;os.path.basename(file)&#125;</span>.&quot;</span>,</span><br><span class="line">                              file=sys.stderr)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e_video_processing:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 ERROR] Unhandled exception during processing of video <span class="subst">&#123;file&#125;</span>: <span class="subst">&#123;e_video_processing&#125;</span>&quot;</span>,</span><br><span class="line">                  file=sys.stderr)</span><br><span class="line">            <span class="comment"># Optionally, re-raise or sys.exit(1) if this should halt the script</span></span><br><span class="line">            <span class="comment"># For now, it will just print the error and attempt the next file.</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[TransNetV2 INFO] Finished processing all files.&quot;</span>, file=sys.stderr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="è°ƒç”¨æ¨ç†è„šæœ¬å¤„ç†è§†é¢‘">è°ƒç”¨æ¨ç†è„šæœ¬å¤„ç†è§†é¢‘</h3><ul><li>benchmark</li></ul><p><img src="/2025/06/09/TransNetV2-model-use/model-benchmark.png" class="lazyload placeholder" data-srcset="/2025/06/09/TransNetV2-model-use/model-benchmark.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li>å¤„ç†è¾“å…¥è§†é¢‘ä¸ºå•ä¸€åœºæ™¯ æ£€æµ‹è§†é¢‘è½¬åœºå¹¶åˆ†å‰²</li></ul><blockquote><p>è‡ªåŠ¨è·³è¿‡åˆ‡å‰²åè§†é¢‘å‰å500ms å»é™¤è½¬åœºåŠ¨ç”»</p></blockquote> <figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Time:     2025/6/7 19:00  # ä¿®æ”¹ä¸ºå®é™…æ—¶é—´</span></span><br><span class="line"><span class="string">Author:   ZhaoQi Cao(Clara)</span></span><br><span class="line"><span class="string">Version:  V 1.4 # ç‰ˆæœ¬æ›´æ–°: ä¿®æ­£ parse_scenes_file å‡½æ•°ä»¥æ­£ç¡®è§£æåœºæ™¯æ–‡ä»¶æ ¼å¼</span></span><br><span class="line"><span class="string">File:     test_and_cut_video.py</span></span><br><span class="line"><span class="string">date:     2025/6/7 # ä¿®æ”¹ä¸ºå®é™…æ—¥æœŸ</span></span><br><span class="line"><span class="string">Describe: Write during the python at Tianjin</span></span><br><span class="line"><span class="string">GitHub link: https://github.com/caozhaoqi</span></span><br><span class="line"><span class="string">Blog link: https://caozhaoqi.github.io</span></span><br><span class="line"><span class="string">WeChat Official Account: ç é—´æ‹¾é—ï¼ˆCode Snippetsï¼‰</span></span><br><span class="line"><span class="string">Power by macOS on Mac mini m4(2024)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> cv2  <span class="comment"># For getting total frames</span></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path  <span class="comment"># ç”¨äºæ›´æ–¹ä¾¿åœ°å¤„ç†è·¯å¾„</span></span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm  <span class="comment"># ç”¨äºè¿›åº¦æ¡</span></span><br><span class="line"><span class="keyword">import</span> shutil  <span class="comment"># ç”¨äºç§»åŠ¨æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- é…ç½®æ—¥å¿— ---</span></span><br><span class="line">logging.basicConfig(level=logging.INFO,</span><br><span class="line">                    <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(levelname)s - %(filename)s:%(lineno)d - %(message)s&#x27;</span>,</span><br><span class="line">                    datefmt=<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>)</span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ”¯æŒçš„è§†é¢‘æ–‡ä»¶æ‰©å±•å</span></span><br><span class="line">SUPPORTED_VIDEO_EXTENSIONS = [<span class="string">&#x27;.mp4&#x27;</span>, <span class="string">&#x27;.avi&#x27;</span>, <span class="string">&#x27;.mov&#x27;</span>, <span class="string">&#x27;.mkv&#x27;</span>, <span class="string">&#x27;.flv&#x27;</span>, <span class="string">&#x27;.wmv&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_video_files</span>(<span class="params">input_dir, output_dir_to_skip=<span class="literal">None</span></span>):  <span class="comment"># å¢åŠ ä¸€ä¸ªå¯é€‰å‚æ•°</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Recursively finds all video files in the given directory,</span></span><br><span class="line"><span class="string">    optionally skipping a specified output directory.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    video_files = []</span><br><span class="line">    logger.info(<span class="string">f&quot;Searching for video files in: <span class="subst">&#123;input_dir&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment"># è§„èŒƒåŒ– output_dir_to_skip ä»¥è¿›è¡Œå¯é çš„è·¯å¾„æ¯”è¾ƒ</span></span><br><span class="line">    normalized_output_skip_path = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> output_dir_to_skip:</span><br><span class="line">        normalized_output_skip_path = os.path.normpath(os.path.abspath(output_dir_to_skip))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(input_dir):</span><br><span class="line">        current_root_abs = os.path.normpath(os.path.abspath(root))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å¦‚æœå½“å‰éå†çš„ç›®å½•æ˜¯è¾“å‡ºç›®å½•æˆ–å…¶å­ç›®å½•ï¼Œåˆ™è·³è¿‡</span></span><br><span class="line">        <span class="keyword">if</span> normalized_output_skip_path <span class="keyword">and</span> current_root_abs.startswith(normalized_output_skip_path):</span><br><span class="line">            logger.info(<span class="string">f&quot;Skipping scan of output directory: <span class="subst">&#123;root&#125;</span>&quot;</span>)</span><br><span class="line">            dirs[:] = []  <span class="comment"># æ¸…ç©º dirs åˆ—è¡¨ï¼Œé˜»æ­¢ os.walk è¿›å…¥æ­¤ç›®å½•çš„å­ç›®å½•</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">            <span class="comment"># è¿‡æ»¤æ‰ macOS çš„ ._* æ–‡ä»¶å’Œå…¶ä»–ä»¥ç‚¹å¼€å¤´çš„éšè—æ–‡ä»¶</span></span><br><span class="line">            <span class="keyword">if</span> file.startswith(<span class="string">&#x27;.&#x27;</span>):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">any</span>(file.lower().endswith(ext) <span class="keyword">for</span> ext <span class="keyword">in</span> SUPPORTED_VIDEO_EXTENSIONS):</span><br><span class="line">                video_files.append(os.path.join(root, file))</span><br><span class="line">    logger.info(<span class="string">f&quot;Found <span class="subst">&#123;<span class="built_in">len</span>(video_files)&#125;</span> video file(s).&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> video_files</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_transnet_inference</span>(<span class="params">video_path, transnet_script_path, model_dir, working_directory=<span class="string">&quot;.&quot;</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Runs TransNetV2 inference to get shot boundaries.</span></span><br><span class="line"><span class="string">    Returns the path to the &#x27;.scenes.txt&#x27; file located in the working_directory.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    logger.info(<span class="string">f&quot;Running TransNetV2 inference on: <span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line">    video_filename = os.path.basename(video_path)  <span class="comment"># e.g., &quot;myvideo.mp4&quot;</span></span><br><span class="line">    base_name = os.path.splitext(video_filename)[<span class="number">0</span>]  <span class="comment"># e.g., &quot;myvideo&quot; (for target filename in working_dir)</span></span><br><span class="line">    original_video_dir = os.path.dirname(video_path)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- Pre-cleanup: å°è¯•åˆ é™¤åŸå§‹è§†é¢‘ç›®å½•ä¸­ä¸è¯¥è§†é¢‘ç›¸å…³çš„æ—§è¾“å‡ºæ–‡ä»¶ ---</span></span><br><span class="line">    <span class="comment"># This should target the names transnetv2.py actually creates</span></span><br><span class="line">    files_to_pre_cleanup = [</span><br><span class="line">        video_path + <span class="string">&quot;.scenes.txt&quot;</span>,</span><br><span class="line">        video_path + <span class="string">&quot;.predictions.txt&quot;</span>,</span><br><span class="line">        video_path + <span class="string">&quot;.vis.png&quot;</span></span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">for</span> old_file_path <span class="keyword">in</span> files_to_pre_cleanup:</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(old_file_path):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                os.remove(old_file_path)</span><br><span class="line">                logger.info(<span class="string">f&quot;Pre-emptively removed old file: <span class="subst">&#123;old_file_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> OSError <span class="keyword">as</span> e:</span><br><span class="line">                logger.warning(<span class="string">f&quot;Could not pre-emptively remove old file <span class="subst">&#123;old_file_path&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment"># --- é¢„æ¸…ç†ç»“æŸ ---</span></span><br><span class="line"></span><br><span class="line">    command = [</span><br><span class="line">        <span class="string">&quot;python&quot;</span>, transnet_script_path,</span><br><span class="line">        video_path,</span><br><span class="line">        <span class="string">&quot;--weights&quot;</span>, model_dir</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        process = subprocess.Popen(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE, cwd=working_directory)</span><br><span class="line">        stdout_bytes, stderr_bytes = process.communicate(timeout=<span class="number">3600</span>)</span><br><span class="line"></span><br><span class="line">        process_stdout = stdout_bytes.decode(errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">        process_stderr = stderr_bytes.decode(errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> process.returncode != <span class="number">0</span>:</span><br><span class="line">            logger.error(<span class="string">f&quot;TransNetV2 inference failed for <span class="subst">&#123;video_filename&#125;</span>:&quot;</span>)</span><br><span class="line">            logger.error(<span class="string">f&quot;STDOUT: <span class="subst">&#123;process_stdout&#125;</span>&quot;</span>)</span><br><span class="line">            logger.error(<span class="string">f&quot;STDERR: <span class="subst">&#123;process_stderr&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">f&quot;TransNetV2 inference successful for <span class="subst">&#123;video_filename&#125;</span> (exit code 0).&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> process_stdout.strip():</span><br><span class="line">            logger.info(<span class="string">f&quot;TransNetV2 STDOUT for <span class="subst">&#123;video_filename&#125;</span>:\n<span class="subst">&#123;process_stdout.strip()&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> process_stderr.strip():</span><br><span class="line">            logger.warning(</span><br><span class="line">                <span class="string">f&quot;TransNetV2 STDERR for <span class="subst">&#123;video_filename&#125;</span> (though exit code was 0):\n<span class="subst">&#123;process_stderr.strip()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> subprocess.TimeoutExpired:</span><br><span class="line">        logger.error(<span class="string">f&quot;TransNetV2 inference timed out for <span class="subst">&#123;video_filename&#125;</span>.&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> process:</span><br><span class="line">            process.kill()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                stdout_bytes, stderr_bytes = process.communicate(timeout=<span class="number">5</span>)</span><br><span class="line">                process_stdout = stdout_bytes.decode(errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">                process_stderr = stderr_bytes.decode(errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">                <span class="keyword">if</span> process_stdout.strip():</span><br><span class="line">                    logger.error(<span class="string">f&quot;STDOUT (on timeout): <span class="subst">&#123;process_stdout.strip()&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> process_stderr.strip():</span><br><span class="line">                    logger.error(<span class="string">f&quot;STDERR (on timeout): <span class="subst">&#123;process_stderr.strip()&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e_comm:</span><br><span class="line">                logger.error(<span class="string">f&quot;Error getting output after timeout kill: <span class="subst">&#123;e_comm&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Exception during TransNetV2 inference for <span class="subst">&#123;video_filename&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- æ–‡ä»¶æŸ¥æ‰¾å’Œç§»åŠ¨é€»è¾‘ ---</span></span><br><span class="line">    target_scenes_file_in_working_dir = os.path.join(working_directory, <span class="string">f&quot;<span class="subst">&#123;base_name&#125;</span>.scenes.txt&quot;</span>)</span><br><span class="line">    target_predictions_file_in_working_dir = os.path.join(working_directory, <span class="string">f&quot;<span class="subst">&#123;base_name&#125;</span>.predictions.txt&quot;</span>)</span><br><span class="line"></span><br><span class="line">    expected_scenes_file_in_original_dir = video_path + <span class="string">&quot;.scenes.txt&quot;</span></span><br><span class="line">    expected_predictions_file_in_original_dir = video_path + <span class="string">&quot;.predictions.txt&quot;</span></span><br><span class="line"></span><br><span class="line">    scenes_file_found_path = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(target_scenes_file_in_working_dir):</span><br><span class="line">        logger.info(<span class="string">f&quot;Found scenes file directly in working directory: <span class="subst">&#123;target_scenes_file_in_working_dir&#125;</span>&quot;</span>)</span><br><span class="line">        scenes_file_found_path = target_scenes_file_in_working_dir</span><br><span class="line">    <span class="keyword">elif</span> os.path.exists(expected_scenes_file_in_original_dir):</span><br><span class="line">        logger.info(<span class="string">f&quot;Found scenes file in original video directory: <span class="subst">&#123;expected_scenes_file_in_original_dir&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            shutil.move(expected_scenes_file_in_original_dir, target_scenes_file_in_working_dir)</span><br><span class="line">            logger.info(<span class="string">f&quot;Moved scenes file to: <span class="subst">&#123;target_scenes_file_in_working_dir&#125;</span>&quot;</span>)</span><br><span class="line">            scenes_file_found_path = target_scenes_file_in_working_dir</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> os.path.exists(expected_predictions_file_in_original_dir):</span><br><span class="line">                shutil.move(expected_predictions_file_in_original_dir, target_predictions_file_in_working_dir)</span><br><span class="line">                logger.info(<span class="string">f&quot;Moved predictions file to: <span class="subst">&#123;target_predictions_file_in_working_dir&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(</span><br><span class="line">                <span class="string">f&quot;Failed to move scenes/predictions file from &#x27;<span class="subst">&#123;expected_scenes_file_in_original_dir&#125;</span>&#x27; to &#x27;<span class="subst">&#123;target_scenes_file_in_working_dir&#125;</span>&#x27;: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.error(<span class="string">f&quot;Scenes file not found in working directory (<span class="subst">&#123;target_scenes_file_in_working_dir&#125;</span>) &quot;</span></span><br><span class="line">                     <span class="string">f&quot;nor in original video directory (<span class="subst">&#123;expected_scenes_file_in_original_dir&#125;</span>).&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> scenes_file_found_path</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_total_frames</span>(<span class="params">video_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Gets the total number of frames in a video.&quot;&quot;&quot;</span></span><br><span class="line">    cap = cv2.VideoCapture(video_path)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cap.isOpened():</span><br><span class="line">        <span class="comment"># Log OpenCV error if available (requires newer OpenCV versions for good messages)</span></span><br><span class="line">        <span class="comment"># For older versions, this might not give much info.</span></span><br><span class="line">        <span class="comment"># cv_error = cv2.getErrorMsg() if hasattr(cv2, &#x27;getErrorMsg&#x27;) else &quot;OpenCV error&quot;</span></span><br><span class="line">        <span class="comment"># logger.error(f&quot;Could not open video: &#123;video_path&#125;. OpenCV: &#123;cv_error&#125;&quot;)</span></span><br><span class="line">        logger.error(<span class="string">f&quot;Could not open video: <span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    total_frames = <span class="built_in">int</span>(cap.get(cv2.CAP_PROP_FRAME_COUNT))</span><br><span class="line">    cap.release()</span><br><span class="line">    <span class="keyword">return</span> total_frames</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_scenes_file</span>(<span class="params">scenes_file_path, total_frames</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Parses the .scenes.txt file which contains start and end frames for each shot,</span></span><br><span class="line"><span class="string">    one shot per line, space-separated.</span></span><br><span class="line"><span class="string">    Returns a list of (start_frame, end_frame) tuples for each shot.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(scenes_file_path):</span><br><span class="line">        logger.error(<span class="string">f&quot;Scenes file not found for parsing: <span class="subst">&#123;scenes_file_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">    shots = []</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(scenes_file_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">for</span> line_number, line <span class="keyword">in</span> <span class="built_in">enumerate</span>(f, <span class="number">1</span>):</span><br><span class="line">                stripped_line = line.strip()</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> stripped_line:  <span class="comment"># Skip empty lines</span></span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                parts = stripped_line.split()</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(parts) == <span class="number">2</span> <span class="keyword">and</span> parts[<span class="number">0</span>].isdigit() <span class="keyword">and</span> parts[<span class="number">1</span>].isdigit():</span><br><span class="line">                    start_frame = <span class="built_in">int</span>(parts[<span class="number">0</span>])</span><br><span class="line">                    end_frame = <span class="built_in">int</span>(parts[<span class="number">1</span>])  <span class="comment"># This is the end frame of the shot (inclusive)</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment"># Validate frames against total_frames</span></span><br><span class="line">                    <span class="keyword">if</span> start_frame &lt; <span class="number">0</span>:</span><br><span class="line">                        logger.warning(</span><br><span class="line">                            <span class="string">f&quot;Invalid start_frame <span class="subst">&#123;start_frame&#125;</span> &lt; 0 in <span class="subst">&#123;scenes_file_path&#125;</span> line <span class="subst">&#123;line_number&#125;</span>. Clamping to 0.&quot;</span>)</span><br><span class="line">                        start_frame = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment"># end_frame from TransNetV2 is inclusive and 0-indexed.</span></span><br><span class="line">                    <span class="comment"># If total_frames is N, valid frames are 0 to N-1.</span></span><br><span class="line">                    <span class="keyword">if</span> end_frame &gt;= total_frames <span class="keyword">and</span> total_frames &gt; <span class="number">0</span>:</span><br><span class="line">                        logger.warning(</span><br><span class="line">                            <span class="string">f&quot;End_frame <span class="subst">&#123;end_frame&#125;</span> from scenes file is &gt;= total_frames <span class="subst">&#123;total_frames&#125;</span> in <span class="subst">&#123;scenes_file_path&#125;</span> line <span class="subst">&#123;line_number&#125;</span>. Clamping to <span class="subst">&#123;total_frames - <span class="number">1</span>&#125;</span>.&quot;</span>)</span><br><span class="line">                        end_frame = total_frames - <span class="number">1</span></span><br><span class="line">                    <span class="keyword">elif</span> total_frames == <span class="number">0</span> <span class="keyword">and</span> end_frame &gt; <span class="number">0</span>:</span><br><span class="line">                        logger.warning(</span><br><span class="line">                            <span class="string">f&quot;Invalid end_frame <span class="subst">&#123;end_frame&#125;</span> for video with 0 total_frames in <span class="subst">&#123;scenes_file_path&#125;</span> line <span class="subst">&#123;line_number&#125;</span>. Skipping shot.&quot;</span>)</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    <span class="keyword">elif</span> total_frames == <span class="number">0</span> <span class="keyword">and</span> end_frame == <span class="number">0</span> <span class="keyword">and</span> start_frame == <span class="number">0</span>:  <span class="comment"># Special case for 0-frame video if it somehow yields a (0,0) shot</span></span><br><span class="line">                        <span class="keyword">pass</span>  <span class="comment"># Allow (0,0) for a 0-frame video if that&#x27;s a possible output</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> start_frame &gt; end_frame:</span><br><span class="line">                        logger.warning(</span><br><span class="line">                            <span class="string">f&quot;Invalid shot (start_frame <span class="subst">&#123;start_frame&#125;</span> &gt; end_frame <span class="subst">&#123;end_frame&#125;</span>) in <span class="subst">&#123;scenes_file_path&#125;</span> line <span class="subst">&#123;line_number&#125;</span>. Skipping shot.&quot;</span>)</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                    shots.append((start_frame, end_frame))</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="comment"># This warning will catch lines that are not two integers.</span></span><br><span class="line">                    logger.warning(</span><br><span class="line">                        <span class="string">f&quot;Malformed line in scenes file &#x27;<span class="subst">&#123;scenes_file_path&#125;</span>&#x27; line <span class="subst">&#123;line_number&#125;</span>: &#x27;<span class="subst">&#123;stripped_line&#125;</span>&#x27;. Expected two integers separated by space.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Error reading or parsing scenes file <span class="subst">&#123;scenes_file_path&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> shots:</span><br><span class="line">        logger.warning(</span><br><span class="line">            <span class="string">f&quot;No valid shots derived from scenes file: <span class="subst">&#123;scenes_file_path&#125;</span>. Assuming single shot for the entire video.&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> total_frames &gt; <span class="number">0</span>:</span><br><span class="line">            shots.append((<span class="number">0</span>, total_frames - <span class="number">1</span>))</span><br><span class="line">        <span class="comment"># If total_frames is 0, shots will remain empty, which is correct.</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># Sort shots by start frame, just in case they are not ordered in the file</span></span><br><span class="line">        shots.sort(key=<span class="keyword">lambda</span> x: x[<span class="number">0</span>])</span><br><span class="line">        logger.info(</span><br><span class="line">            <span class="string">f&quot;Detected <span class="subst">&#123;<span class="built_in">len</span>(shots)&#125;</span> shots for <span class="subst">&#123;os.path.basename(scenes_file_path)&#125;</span> (start_frame, end_frame_inclusive): <span class="subst">&#123;shots&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> shots</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cut_video_into_shots</span>(<span class="params">video_path, shots, video_output_dir, padding_ms=<span class="number">500</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Cuts the video into shots using ffmpeg based on frame numbers.</span></span><br><span class="line"><span class="string">    The start and end of each shot are REDUCED by padding_ms.</span></span><br><span class="line"><span class="string">    (Note: The &#x27;padding_ms&#x27; parameter is used here as a reduction amount).</span></span><br><span class="line"><span class="string">    Saves shots into the video_specific output directory.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    video_basename = Path(video_path).stem</span><br><span class="line">    logger.info(<span class="string">f&quot;Starting to cut <span class="subst">&#123;<span class="built_in">len</span>(shots)&#125;</span> shots for video: <span class="subst">&#123;video_basename&#125;</span>, REDUCING each end by <span class="subst">&#123;padding_ms&#125;</span>ms.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Get video properties (FPS and total frames) once</span></span><br><span class="line">    cap = cv2.VideoCapture(video_path)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cap.isOpened():</span><br><span class="line">        logger.error(<span class="string">f&quot;Could not open video <span class="subst">&#123;video_path&#125;</span> for properties. Skipping cutting.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    fps = cap.get(cv2.CAP_PROP_FPS)</span><br><span class="line">    video_total_frames = <span class="built_in">int</span>(cap.get(cv2.CAP_PROP_FRAME_COUNT))</span><br><span class="line">    cap.release()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> fps &gt; <span class="number">0</span>:</span><br><span class="line">        logger.error(<span class="string">f&quot;Could not determine FPS for <span class="subst">&#123;video_path&#125;</span>. Skipping reduction cut.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> video_total_frames == <span class="number">0</span>:</span><br><span class="line">        logger.error(<span class="string">f&quot;Video <span class="subst">&#123;video_path&#125;</span> has 0 frames. Skipping cutting.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Convert the reduction amount from milliseconds to frames</span></span><br><span class="line">    reduction_frames = <span class="built_in">round</span>(padding_ms / <span class="number">1000</span> * fps)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, (start_frame, end_frame) <span class="keyword">in</span> <span class="built_in">enumerate</span>(tqdm(shots, desc=<span class="string">f&quot;Cutting shots for <span class="subst">&#123;video_basename&#125;</span>&quot;</span>, unit=<span class="string">&quot;shot&quot;</span>)):</span><br><span class="line">        start_frame = <span class="built_in">int</span>(start_frame)</span><br><span class="line">        end_frame = <span class="built_in">int</span>(end_frame)  <span class="comment"># Inclusive end frame from parse_scenes_file</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Calculate new target start and end frames after reduction</span></span><br><span class="line">        target_start_frame = start_frame + reduction_frames</span><br><span class="line">        target_end_frame = end_frame - reduction_frames  <span class="comment"># This will also be an inclusive frame index</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Check if the shot is too short for the reduction, making it invalid</span></span><br><span class="line">        <span class="keyword">if</span> target_end_frame &lt; target_start_frame:</span><br><span class="line">            logger.warning(</span><br><span class="line">                <span class="string">f&quot;Shot <span class="subst">&#123;i + <span class="number">1</span>&#125;</span> (original: <span class="subst">&#123;start_frame&#125;</span>-<span class="subst">&#123;end_frame&#125;</span>) is too short to apply <span class="subst">&#123;padding_ms&#125;</span>ms reduction &quot;</span></span><br><span class="line">                <span class="string">f&quot;from both ends (would result in invalid segment: <span class="subst">&#123;target_start_frame&#125;</span>-<span class="subst">&#123;target_end_frame&#125;</span>). &quot;</span></span><br><span class="line">                <span class="string">f&quot;Original duration: <span class="subst">&#123;(end_frame - start_frame + <span class="number">1</span>) / fps:<span class="number">.2</span>f&#125;</span>s. Skipping this shot.&quot;</span></span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Clamp the target frames to the video&#x27;s actual boundaries</span></span><br><span class="line">        <span class="comment"># (0 to video_total_frames - 1)</span></span><br><span class="line">        final_start_frame = <span class="built_in">max</span>(<span class="number">0</span>, target_start_frame)</span><br><span class="line">        final_start_frame = <span class="built_in">min</span>(final_start_frame, video_total_frames - <span class="number">1</span>)  <span class="comment"># Ensure start isn&#x27;t past video end</span></span><br><span class="line"></span><br><span class="line">        final_end_frame = <span class="built_in">min</span>(video_total_frames - <span class="number">1</span>, target_end_frame)</span><br><span class="line">        final_end_frame = <span class="built_in">max</span>(<span class="number">0</span>, final_end_frame)  <span class="comment"># Ensure end isn&#x27;t before video start</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Re-check validity after clamping.</span></span><br><span class="line">        <span class="comment"># This handles cases where clamping itself might make the segment invalid.</span></span><br><span class="line">        <span class="keyword">if</span> final_end_frame &lt; final_start_frame:</span><br><span class="line">            logger.warning(</span><br><span class="line">                <span class="string">f&quot;Shot <span class="subst">&#123;i + <span class="number">1</span>&#125;</span> (original: <span class="subst">&#123;start_frame&#125;</span>-<span class="subst">&#123;end_frame&#125;</span>) became invalid after reduction and clamping to video boundaries: &quot;</span></span><br><span class="line">                <span class="string">f&quot;intended reduced (<span class="subst">&#123;target_start_frame&#125;</span>-<span class="subst">&#123;target_end_frame&#125;</span>), &quot;</span></span><br><span class="line">                <span class="string">f&quot;clamped to (<span class="subst">&#123;final_start_frame&#125;</span>-<span class="subst">&#123;final_end_frame&#125;</span>). Skipping this shot.&quot;</span></span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        output_shot_filename = <span class="string">f&quot;<span class="subst">&#123;video_basename&#125;</span>_shot_<span class="subst">&#123;i + <span class="number">1</span>:03d&#125;</span>.mp4&quot;</span></span><br><span class="line">        output_shot_path = os.path.join(video_output_dir, output_shot_filename)</span><br><span class="line"></span><br><span class="line">        logger.debug(</span><br><span class="line">            <span class="string">f&quot;Preparing to cut shot <span class="subst">&#123;i + <span class="number">1</span>&#125;</span>: original (<span class="subst">&#123;start_frame&#125;</span>-<span class="subst">&#123;end_frame&#125;</span>), &quot;</span></span><br><span class="line">            <span class="string">f&quot;target reduced frames (<span class="subst">&#123;final_start_frame&#125;</span>-<span class="subst">&#123;final_end_frame&#125;</span>) -&gt; <span class="subst">&#123;output_shot_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        ffmpeg_command = [</span><br><span class="line">            <span class="string">&quot;ffmpeg&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-loglevel&quot;</span>, <span class="string">&quot;error&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-i&quot;</span>, video_path,</span><br><span class="line">            <span class="string">&quot;-vf&quot;</span>, <span class="string">f&quot;select=&#x27;between(n,<span class="subst">&#123;final_start_frame&#125;</span>,<span class="subst">&#123;final_end_frame&#125;</span>)&#x27;,setpts=PTS-STARTPTS&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-af&quot;</span>, <span class="string">f&quot;aselect=&#x27;between(n,<span class="subst">&#123;final_start_frame&#125;</span>,<span class="subst">&#123;final_end_frame&#125;</span>)&#x27;,asetpts=PTS-STARTPTS&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-c:v&quot;</span>, <span class="string">&quot;libx264&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-preset&quot;</span>, <span class="string">&quot;ultrafast&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-crf&quot;</span>, <span class="string">&quot;23&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-c:a&quot;</span>, <span class="string">&quot;aac&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-y&quot;</span>,  <span class="comment"># Overwrite output files without asking</span></span><br><span class="line">            output_shot_path</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            process = subprocess.Popen(ffmpeg_command, stdout=subprocess.PIPE, stderr=subprocess.PIPE)</span><br><span class="line">            stdout_bytes, stderr_bytes = process.communicate(timeout=<span class="number">300</span>)</span><br><span class="line"></span><br><span class="line">            stdout = stdout_bytes.decode(errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">            stderr = stderr_bytes.decode(errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> process.returncode != <span class="number">0</span>:</span><br><span class="line">                logger.error(<span class="string">f&quot;ffmpeg failed for shot <span class="subst">&#123;output_shot_filename&#125;</span>:&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> stderr.strip(): logger.error(<span class="string">f&quot;FFMPEG STDERR: <span class="subst">&#123;stderr.strip()&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> stdout.strip(): logger.error(<span class="string">f&quot;FFMPEG STDOUT: <span class="subst">&#123;stdout.strip()&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                logger.info(<span class="string">f&quot;Successfully created <span class="subst">&#123;output_shot_filename&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> subprocess.TimeoutExpired:</span><br><span class="line">            logger.error(<span class="string">f&quot;ffmpeg timed out for shot <span class="subst">&#123;output_shot_filename&#125;</span>.&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> process:</span><br><span class="line">                process.kill()</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    stdout_bytes, stderr_bytes = process.communicate(timeout=<span class="number">5</span>)</span><br><span class="line">                    stdout = stdout_bytes.decode(errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">                    stderr = stderr_bytes.decode(errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">                    <span class="keyword">if</span> stderr.strip(): logger.error(<span class="string">f&quot;FFMPEG STDERR (on timeout kill): <span class="subst">&#123;stderr.strip()&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="keyword">if</span> stdout.strip(): logger.error(<span class="string">f&quot;FFMPEG STDOUT (on timeout kill): <span class="subst">&#123;stdout.strip()&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e_comm_kill:</span><br><span class="line">                    logger.error(<span class="string">f&quot;Error getting output after ffmpeg timeout kill: <span class="subst">&#123;e_comm_kill&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Exception during ffmpeg processing for shot <span class="subst">&#123;output_shot_filename&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">f&quot;Finished cutting <span class="subst">&#123;<span class="built_in">len</span>(shots)&#125;</span> shots for video: <span class="subst">&#123;video_basename&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(</span><br><span class="line">        description=<span class="string">&quot;Process videos using TransNetV2 to detect shot boundaries and cut the videos into shots.&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;input_source&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;Path to a directory containing video files to process.&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--transnet_script&quot;</span>, required=<span class="literal">False</span>, default=<span class="string">&quot;inference/transnetv2.py&quot;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;Path to the transnetv2.py script.&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--model_dir&quot;</span>, required=<span class="literal">False</span>, default=<span class="string">&quot;inference/transnetv2-weights&quot;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;Path to the TransNetV2 model directory.&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--output_dir&quot;</span>, required=<span class="literal">False</span>, default=<span class="string">&quot;./r&quot;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;Base directory to output processed videos.  A subdirectory will be created for each video.&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--log_file&quot;</span>, required=<span class="literal">False</span>, default=<span class="string">&quot;my_processing_log.txt&quot;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;Path to the log file.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- æ—¥å¿—æ–‡ä»¶è®¾ç½® ---</span></span><br><span class="line">    log_file_path = args.log_file</span><br><span class="line">    log_dir = os.path.dirname(log_file_path)  <span class="comment"># è·å–æ—¥å¿—æ–‡ä»¶æ‰€åœ¨ç›®å½•</span></span><br><span class="line">    <span class="keyword">if</span> log_dir <span class="keyword">and</span> <span class="keyword">not</span> os.path.exists(log_dir):</span><br><span class="line">        os.makedirs(log_dir)  <span class="comment"># å¦‚æœæ—¥å¿—ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºå®ƒ</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ›å»ºä¸€ä¸ªfile handlerï¼Œå°†æ—¥å¿—å†™å…¥æ–‡ä»¶</span></span><br><span class="line">    file_handler = logging.FileHandler(log_file_path, encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    file_handler.setLevel(logging.INFO)  <span class="comment"># è®¾ç½®æ—¥å¿—çº§åˆ«ä¸ºINFO</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ›å»ºä¸€ä¸ªformatterå¹¶å°†å…¶æ·»åŠ åˆ°handler</span></span><br><span class="line">    formatter = logging.Formatter(<span class="string">&#x27;%(asctime)s - %(levelname)s - %(filename)s:%(lineno)d - %(message)s&#x27;</span>,</span><br><span class="line">                                  datefmt=<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>)</span><br><span class="line">    file_handler.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å°†handleræ·»åŠ åˆ°logger</span></span><br><span class="line">    logger.addHandler(file_handler)</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">&quot;Script started.&quot;</span>)</span><br><span class="line">    logger.info(<span class="string">f&quot;Arguments: <span class="subst">&#123;args&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    input_source = args.input_source</span><br><span class="line">    transnet_script = args.transnet_script</span><br><span class="line">    model_dir = args.model_dir</span><br><span class="line">    output_dir = args.output_dir</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(output_dir):</span><br><span class="line">        os.makedirs(output_dir)</span><br><span class="line">        logger.info(<span class="string">f&quot;Created base output directory: <span class="subst">&#123;output_dir&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.info(<span class="string">f&quot;Base output directory already exists: <span class="subst">&#123;output_dir&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    video_files = find_video_files(input_source, output_dir_to_skip=output_dir)  <span class="comment"># æ’é™¤ output_dir</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> video_files:</span><br><span class="line">        logger.warning(<span class="string">&quot;No video files found to process.&quot;</span>)</span><br><span class="line">        logger.info(<span class="string">&quot;All processing complete.&quot;</span>)</span><br><span class="line">        exit()</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">f&quot;Processing <span class="subst">&#123;<span class="built_in">len</span>(video_files)&#125;</span> video(s)...&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> video_path <span class="keyword">in</span> video_files:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># --- è§†é¢‘ç‰¹å®šå¤„ç†å¼€å§‹ ---</span></span><br><span class="line">            video_basename = Path(video_path).stem</span><br><span class="line">            logger.info(<span class="string">f&quot;--- Starting processing for video: <span class="subst">&#123;video_path&#125;</span> ---&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># ä¸ºå½“å‰è§†é¢‘åˆ›å»ºå¤„ç†ç›®å½•å’Œè¾“å‡ºç›®å½•</span></span><br><span class="line">            video_output_dir = os.path.join(output_dir, video_basename)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(video_output_dir):</span><br><span class="line">                os.makedirs(video_output_dir)</span><br><span class="line">                logger.info(<span class="string">f&quot;Created processing/output directory for this video: <span class="subst">&#123;video_output_dir&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                logger.info(<span class="string">f&quot;Processing/output directory already exists: <span class="subst">&#123;video_output_dir&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            total_frames = get_total_frames(video_path)</span><br><span class="line">            <span class="keyword">if</span> total_frames <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> total_frames == <span class="number">0</span>:</span><br><span class="line">                logger.error(</span><br><span class="line">                    <span class="string">f&quot;Cannot process video <span class="subst">&#123;video_path&#125;</span> as it has no frames or could not be read. Skipping.&quot;</span>)</span><br><span class="line">                <span class="keyword">continue</span>  <span class="comment"># Skip to the next video</span></span><br><span class="line">            logger.info(<span class="string">f&quot;Total frames in <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;total_frames&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># è¿è¡Œ TransNetV2 æ¨ç†</span></span><br><span class="line">            scenes_file = run_transnet_inference(video_path, transnet_script, model_dir,</span><br><span class="line">                                                 working_directory=video_output_dir)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> scenes_file <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                logger.error(<span class="string">f&quot;Failed to get scenes file for <span class="subst">&#123;video_path&#125;</span>. Skipping this video.&quot;</span>)</span><br><span class="line">                <span class="keyword">continue</span>  <span class="comment"># Skip to the next video</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># è§£æåœºæ™¯æ–‡ä»¶</span></span><br><span class="line">            shots = parse_scenes_file(scenes_file, total_frames)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># å°†è§†é¢‘å‰ªåˆ‡æˆé•œå¤´</span></span><br><span class="line">            cut_video_into_shots(video_path, shots, video_output_dir, padding_ms=<span class="number">500</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;An unexpected error occurred while processing <span class="subst">&#123;video_path&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">&quot;All processing complete.&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>æ£€æµ‹è¾“å‡ºç»“æœ</li></ul><p><img src="/2025/06/09/TransNetV2-model-use/test-result.png" class="lazyload placeholder" data-srcset="/2025/06/09/TransNetV2-model-use/test-result.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="See">See</h2><ul><li>1.<a href="https://arxiv.org/pdf/2008.04838">https://arxiv.org/pdf/2008.04838</a></li><li>2.<a href="https://github.com/soCzech/TransNetV2/tree/master">https://github.com/soCzech/TransNetV2/tree/master</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åœºæ™¯æ£€æµ‹æ€§èƒ½ä¼˜åŒ–æ–¹å‘ä¸æµ‹è¯•æ–¹æ³•</title>
      <link href="/2025/05/30/scene-detect-benchmark/"/>
      <url>/2025/05/30/scene-detect-benchmark/</url>
      
        <content type="html"><![CDATA[<h1>åœºæ™¯æ£€æµ‹æ€§èƒ½ä¼˜åŒ–æ–¹å‘ä¸æµ‹è¯•æ–¹æ³•</h1><h2 id="1-å¼•è¨€">1. å¼•è¨€</h2><p>æœ¬æŒ‡å—æ—¨åœ¨æä¾›ä¸€å¥—ç³»ç»ŸåŒ–çš„æ–¹æ³•ï¼Œç”¨äºéªŒè¯å’Œåˆ†æè§†é¢‘å¤„ç†é¡¹ç›®çš„æ•ˆç‡ï¼Œç‰¹åˆ«æ˜¯é’ˆå¯¹åœºæ™¯æ£€æµ‹æ¨¡å—çš„æ€§èƒ½ã€‚é€šè¿‡æ”¶é›†å…³é”®æ€§èƒ½æŒ‡æ ‡ (KPIs)<br>å’Œå‰–æä»£ç æ‰§è¡Œï¼Œæˆ‘ä»¬å¯ä»¥è¯†åˆ«æ€§èƒ½ç“¶é¢ˆï¼Œå¹¶ä¸ºåç»­çš„ä»£ç ä¼˜åŒ–æä¾›æ•°æ®æ”¯æŒã€‚</p><h2 id="2-å‡†å¤‡å·¥ä½œ">2. å‡†å¤‡å·¥ä½œ</h2><h3 id="2-1-å®šä¹‰å…³é”®æ€§èƒ½æŒ‡æ ‡-KPIs">2.1. å®šä¹‰å…³é”®æ€§èƒ½æŒ‡æ ‡ (KPIs)</h3><p>åœ¨å¼€å§‹æµ‹è¯•å‰ï¼Œæ˜ç¡®éœ€è¦è¡¡é‡çš„æ€§èƒ½æŒ‡æ ‡ï¼š</p><ul><li>æ€»å¤„ç†æ—¶é—´ (End-to-End Time)*è¡¡é‡å•ä¸ªè§†é¢‘ä»åœºæ™¯æ£€æµ‹å¼€å§‹åˆ°ç»“æŸçš„æ€»è€—æ—¶ã€‚</li><li>åœºæ™¯æ£€æµ‹å‡½æ•°è€—æ—¶<code>detect_scenes</code> å‡½æ•°çš„ç²¾ç¡®æ‰§è¡Œæ—¶é—´ã€‚</li><li>CPU ä½¿ç”¨ç‡åœºæ™¯æ£€æµ‹è¿‡ç¨‹ä¸­çš„å¹³å‡å’Œå³°å€¼ CPU ä½¿ç”¨ç‡ã€‚</li><li>å†…å­˜ä½¿ç”¨é‡ åœºæ™¯æ£€æµ‹è¿‡ç¨‹ä¸­çš„å³°å€¼å’Œå¹³å‡å†…å­˜æ¶ˆè€—ã€‚</li><li>GPU ä½¿ç”¨ç‡ (è‹¥å¯ç”¨)ï¼šGPU è®¡ç®—å•å…ƒå’Œæ˜¾å­˜çš„ä½¿ç”¨ç‡ã€‚</li><li>æ£€æµ‹åˆ°çš„åœºæ™¯æ•°ä½œä¸ºæ£€æµ‹ç»“æœçš„ä¸€ä¸ªåŸºæœ¬è¡¡é‡ã€‚</li><li>æ£€æµ‹æ—¶ä½¿ç”¨çš„å¸§ç‡è®°å½• <code>detect_scenes</code> å†…éƒ¨å®é™…ä½¿ç”¨çš„è§†é¢‘å¸§ç‡ã€‚</li></ul><h3 id="2-2-é€‰æ‹©æµ‹è¯•æ•°æ®é›†">2.2. é€‰æ‹©æµ‹è¯•æ•°æ®é›†</h3><ul><li>å¤šæ ·æ€§ å‡†å¤‡ä¸€ç»„åŒ…å«ä¸åŒç‰¹å¾çš„è§†é¢‘æ–‡ä»¶ï¼š<ul><li>ä¸åŒåˆ†è¾¨ç‡ (ä¾‹å¦‚ï¼š720p, 1080p, 4K)ã€‚</li><li>ä¸åŒç¼–ç æ ¼å¼ (ä¾‹å¦‚ï¼šH.264, HEVC)ã€‚</li><li>ä¸åŒæ—¶é•¿ (ä¾‹å¦‚ï¼šçŸ­è§†é¢‘ &lt; 1åˆ†é’Ÿï¼Œä¸­ç­‰è§†é¢‘ 5-10åˆ†é’Ÿï¼Œé•¿è§†é¢‘ &gt; 30åˆ†é’Ÿ)ã€‚</li><li>ä¸åŒåœºæ™¯å¤æ‚åº¦ (ä¾‹å¦‚ï¼šåœºæ™¯åˆ‡æ¢é¢‘ç¹çš„é¢„å‘Šç‰‡ï¼Œåœºæ™¯åˆ‡æ¢è¾ƒå°‘çš„è®²åº§è§†é¢‘)ã€‚</li></ul></li><li>ä»£è¡¨æ€§ æµ‹è¯•è§†é¢‘åº”èƒ½ä»£è¡¨é¡¹ç›®å®é™…åº”ç”¨ä¸­å¸¸è§çš„è§†é¢‘ç±»å‹ã€‚</li><li>å¯é‡å¤æ€§ ä½¿ç”¨å›ºå®šçš„è§†é¢‘é›†è¿›è¡Œæ‰€æœ‰æµ‹è¯•ï¼Œä»¥ä¾¿æ¯”è¾ƒä¸åŒä¼˜åŒ–ç‰ˆæœ¬çš„æ•ˆæœã€‚</li></ul><h3 id="2-3-æ­å»ºæµ‹è¯•ç¯å¢ƒ">2.3. æ­å»ºæµ‹è¯•ç¯å¢ƒ</h3><ul><li>ç¡¬ä»¶ä¸€è‡´æ€§ æ‰€æœ‰åŸºå‡†æµ‹è¯•åº”åœ¨åŒä¸€å°æœºå™¨ä¸Šè¿›è¡Œï¼Œä»¥æ¶ˆé™¤ç¡¬ä»¶å·®å¼‚ã€‚è®°å½•æµ‹è¯•æœºå™¨çš„ CPUã€å†…å­˜ã€GPUå‹å·ã€ç£ç›˜ç±»å‹ç­‰è§„æ ¼ã€‚</li><li>è½¯ä»¶ç¯å¢ƒä¸€è‡´æ€§ ç¡®ä¿ Python ç‰ˆæœ¬ã€æ“ä½œç³»ç»Ÿä»¥åŠæ‰€æœ‰ç›¸å…³ä¾èµ–åº“ (å¦‚ PySceneDetect, OpenCV, FFmpeg) çš„ç‰ˆæœ¬åœ¨æµ‹è¯•æœŸé—´ä¿æŒä¸å˜ã€‚å¯ä»¥ä»<br><code>requirements.txt</code> æ–‡ä»¶ä¸­è·å–ä¾èµ–åˆ—è¡¨ã€‚</li><li>ç¯å¢ƒéš”ç¦» æµ‹è¯•æ—¶ï¼Œå°½é‡å…³é—­å…¶ä»–ä¸å¿…è¦çš„åº”ç”¨ç¨‹åºï¼Œä»¥å‡å°‘å¯¹æµ‹è¯•ç»“æœçš„å¹²æ‰°ã€‚</li></ul><h3 id="2-4-é…ç½®æµ‹è¯•å‚æ•°">2.4. é…ç½®æµ‹è¯•å‚æ•°</h3><ul><li><code>config.ini</code> åŸºå‡†æµ‹è¯•è„šæœ¬ä¼šåŠ è½½æ­¤æ–‡ä»¶ã€‚ç¡®ä¿å…¶ä¸­çš„è·¯å¾„é…ç½® (å¦‚ <code>ffmpeg_path</code>, <code>ffprobe_path</code>) å’Œé»˜è®¤çš„æ£€æµ‹å™¨å‚æ•°æ˜¯ä½ æƒ³è¦æµ‹è¯•çš„åŸºç¡€é…ç½®ã€‚</li><li>æµ‹è¯•è„šæœ¬å†…é…ç½® <code>benchmark_scene_detector.py</code> è„šæœ¬å…è®¸å®šä¹‰å¤šç§æµ‹è¯•é…ç½® ( <code>configurations_to_test</code> åˆ—è¡¨)ï¼Œä¾‹å¦‚ï¼š<ul><li>CPU vs GPU è§£ç ã€‚</li><li>ä½¿ç”¨ä¸åŒçš„æ£€æµ‹å™¨ç»„åˆ (ä¾‹å¦‚ï¼Œä»… <code>ContentDetector</code> vs <code>MultiDetector</code> å…¨å¯ç”¨)ã€‚</li><li>ä¸åŒçš„æ£€æµ‹å™¨å‚æ•° (ä¾‹å¦‚ï¼Œä¸åŒçš„ <code>threshold</code> æˆ– <code>min_scene_len_frames</code>)ã€‚</li></ul></li></ul><h2 id="3-æµ‹è¯•æ‰§è¡Œ">3. æµ‹è¯•æ‰§è¡Œ</h2><h3 id="3-1-æµ‹è¯•è„šæœ¬ï¼šbenchmark-scene-detector-py">3.1. æµ‹è¯•è„šæœ¬ï¼š<code>benchmark_scene_detector.py</code></h3><ul><li>åŸºç¡€åº“å®‰è£…</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install memory-profiler psutil snakeviz # snakeviz ç”¨äºå¯è§†åŒ– cProfile ç»“æœ</span><br><span class="line">    </span><br></pre></td></tr></table></figure><ul><li>åŸºå‡†æµ‹è¯•è„šæœ¬è¿è¡Œ</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python src/video/benchmark_scene_detector.py</span><br></pre></td></tr></table></figure><ul><li>æ€§èƒ½åˆ†æ</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python -m pstats profiling_results/profile_your_test_video1_Config_Default_CPU.prof</span><br><span class="line">    </span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">snakeviz profiling_results/profile_your_test_video1_Config_Default_CPU.prof</span><br></pre></td></tr></table></figure><h3 id="3-2-æ€§èƒ½å‰–æ-Profiling">3.2. æ€§èƒ½å‰–æ (Profiling)</h3><ul><li>å½“æµ‹è¯•é…ç½®ä¸­ <code>&quot;profile&quot;: True</code> æ—¶ï¼Œè„šæœ¬ä¼šä¸ºè¯¥æ¬¡è¿è¡Œç”Ÿæˆä¸€ä¸ª <code>.prof</code> æ–‡ä»¶ï¼Œä¿å­˜åœ¨ <code>profiling_results</code> ç›®å½•ä¸‹ã€‚</li><li>è¿™äº›æ–‡ä»¶åŒ…å«äº†å‡½æ•°è°ƒç”¨æ¬¡æ•°ã€æ¯æ¬¡è°ƒç”¨çš„è€—æ—¶ã€ç´¯è®¡è€—æ—¶ç­‰è¯¦ç»†ä¿¡æ¯ã€‚</li></ul><h3 id="3-3-èµ„æºç›‘æ§">3.3. èµ„æºç›‘æ§</h3><ul><li>æ‰‹åŠ¨ç›‘æ§ åœ¨æµ‹è¯•è„šæœ¬è¿è¡Œæ—¶ï¼Œä½¿ç”¨æ“ä½œç³»ç»Ÿè‡ªå¸¦çš„å·¥å…·ï¼ˆå¦‚ Windows çš„ä»»åŠ¡ç®¡ç†å™¨ï¼ŒLinux çš„ <code>top</code>/<code>htop</code>ï¼ŒmacOS çš„æ´»åŠ¨ç›‘è§†å™¨ï¼‰è§‚å¯Ÿ<br>CPU å’Œå†…å­˜çš„å®æ—¶ä½¿ç”¨æƒ…å†µã€‚</li><li>GPU ç›‘æ§ å¦‚æœæµ‹è¯• GPU åŠ é€Ÿï¼Œä½¿ç”¨ç‰¹å®šäº GPU å‚å•†çš„å·¥å…·ï¼ˆå¦‚ NVIDIA çš„ <code>nvidia-smi</code>ï¼‰ç›‘æ§ GPU åˆ©ç”¨ç‡å’Œæ˜¾å­˜ä½¿ç”¨ã€‚</li><li>è„šæœ¬å†…ç›‘æ§ (å¯é€‰) å¯ä»¥ä¿®æ”¹ <code>benchmark_scene_detector.py</code>ï¼Œä½¿ç”¨ <code>psutil</code> åº“åœ¨è°ƒç”¨ <code>detect_scenes</code> å‰åè®°å½•è¿›ç¨‹çš„ CPU<br>å’Œå†…å­˜å¿«ç…§ï¼Œä»¥è·å¾—æ›´ç²¾ç¡®çš„æ•°æ®ã€‚</li></ul><h3 id="3-4-æ¯”è¾ƒè€—æ—¶ï¼š">3.4 æ¯”è¾ƒè€—æ—¶ï¼š</h3><ul><li>å¯¹æ¯” CPU å’Œ GPU é…ç½®ä¸‹çš„è€—æ—¶ï¼Œè¯„ä¼° GPU åŠ é€Ÿçš„å®é™…æ•ˆæœã€‚ä»ç¤ºä¾‹è¾“å‡ºæ¥çœ‹ï¼Œå¯¹äºâ€œå»ºç­‘å®¶å›­-02.mp4â€ï¼Œä½¿ç”¨ GPU (<br>Config_Default_GPU) å°†å¤„ç†æ—¶é—´ä»çº¦ 15.1 ç§’é™ä½åˆ°äº†çº¦ 8.6 ç§’ï¼Œæœ‰æ˜¾è‘—æå‡ã€‚</li><li>å¯¹æ¯”ä¸åŒæ£€æµ‹å™¨ç»„åˆæˆ–å‚æ•°ä¸‹çš„è€—æ—¶ã€‚ä¾‹å¦‚ï¼ŒConfig_ContentDetectorOnly_CPU (ä»…ä½¿ç”¨ ContentDetector) çš„è€—æ—¶çº¦ä¸º 5.4 ç§’ï¼Œè¿œå¿«äºä½¿ç”¨<br>MultiDetector çš„ Config_Default_CPU (15.1 ç§’)ï¼Œä½†æ£€æµ‹åˆ°çš„åœºæ™¯æ•°ä¹Ÿä» 12 ä¸ªå‡å°‘åˆ°äº† 9 ä¸ªã€‚è¿™éœ€è¦åœ¨é€Ÿåº¦å’Œæ£€æµ‹å…¨é¢æ€§ä¹‹é—´è¿›è¡Œæƒè¡¡ã€‚</li><li>è§‚å¯Ÿä¸åŒç‰¹æ€§è§†é¢‘ï¼ˆå¦‚æ—¶é•¿ã€åˆ†è¾¨ç‡ï¼‰å¯¹å¤„ç†æ—¶é—´çš„å½±å“ï¼ˆéœ€è¦æ›´å¤šæµ‹è¯•è§†é¢‘æ ·æœ¬æ¥åˆ†ææ­¤é¡¹ï¼‰ã€‚4.2. åˆ†ææ€§èƒ½å‰–æ (.prof) æ–‡ä»¶ä½¿ç”¨<br>Python çš„ pstats æ¨¡å—æˆ– snakeviz å·¥å…·æ¥åˆ†æ .prof æ–‡ä»¶ã€‚ä½¿ç”¨ pstats (å‘½ä»¤è¡Œ)ï¼š</li></ul><h2 id="4-ç»“æœåˆ†æ">4. ç»“æœåˆ†æ</h2><h3 id="4-1-åˆ†æåŸºå‡†æµ‹è¯•æ—¥å¿—">4.1. åˆ†æåŸºå‡†æµ‹è¯•æ—¥å¿—</h3><blockquote><p>è„šæœ¬æ‰§è¡Œå®Œæ¯•åï¼Œä¼šæ‰“å°ä¸€ä¸ªæ€»ç»“æŠ¥å‘Šï¼Œæ˜¾ç¤ºæ¯ä¸ªè§†é¢‘åœ¨ä¸åŒé…ç½®ä¸‹çš„å¤„ç†æ—¶é•¿å’Œæ£€æµ‹åˆ°çš„åœºæ™¯æ•°ã€‚</p></blockquote><h4 id="åœ¨-pstats-äº¤äº’å¼-shell-ä¸­ï¼Œå¸¸ç”¨å‘½ä»¤ï¼š">åœ¨ pstats äº¤äº’å¼ shell ä¸­ï¼Œå¸¸ç”¨å‘½ä»¤ï¼š</h4><ul><li>sort cumulative: æŒ‰ç´¯è®¡è€—æ—¶æ’åºã€‚</li><li>stats 20: æ˜¾ç¤ºè€—æ—¶æœ€å¤šçš„å‰ 20 ä¸ªå‡½æ•°ã€‚</li><li>callers function_name: æŸ¥çœ‹å“ªäº›å‡½æ•°è°ƒç”¨äº† function_nameã€‚</li><li>callees function_name: æŸ¥çœ‹ function_name è°ƒç”¨äº†å“ªäº›å‡½æ•°ã€‚</li></ul><h4 id="ä½¿ç”¨-snakeviz-Web-ç•Œé¢ï¼Œæ¨è-ï¼š">ä½¿ç”¨ snakeviz (Web ç•Œé¢ï¼Œæ¨è)ï¼š</h4><ul><li><p>æ¯”è¾ƒè€—æ—¶</p><ul><li>å¯¹æ¯” CPU å’Œ GPU é…ç½®ä¸‹çš„è€—æ—¶ï¼Œè¯„ä¼° GPU åŠ é€Ÿçš„å®é™…æ•ˆæœã€‚ä»ç¤ºä¾‹è¾“å‡ºæ¥çœ‹ï¼Œå¯¹äºâ€œå»ºç­‘å®¶å›­-02.mp4â€ï¼Œä½¿ç”¨ GPU (<br><code>Config_Default_GPU</code>) å°†å¤„ç†æ—¶é—´ä»çº¦ 15.1 ç§’é™ä½åˆ°äº†çº¦ 8.6 ç§’ï¼Œæœ‰æ˜¾è‘—æå‡ã€‚</li><li>å¯¹æ¯”ä¸åŒæ£€æµ‹å™¨ç»„åˆæˆ–å‚æ•°ä¸‹çš„è€—æ—¶ã€‚ä¾‹å¦‚ï¼Œ<code>Config_ContentDetectorOnly_CPU</code> (ä»…ä½¿ç”¨ ContentDetector) çš„è€—æ—¶çº¦ä¸º 5.4<br>ç§’ï¼Œè¿œå¿«äºä½¿ç”¨ <code>MultiDetector</code> çš„ <code>Config_Default_CPU</code> (15.1 ç§’)ï¼Œä½†æ£€æµ‹åˆ°çš„åœºæ™¯æ•°ä¹Ÿä» 12 ä¸ªå‡å°‘åˆ°äº† 9<br>ä¸ªã€‚è¿™éœ€è¦åœ¨é€Ÿåº¦å’Œæ£€æµ‹å…¨é¢æ€§ä¹‹é—´è¿›è¡Œæƒè¡¡ã€‚</li><li>è§‚å¯Ÿä¸åŒç‰¹æ€§è§†é¢‘ï¼ˆå¦‚æ—¶é•¿ã€åˆ†è¾¨ç‡ï¼‰å¯¹å¤„ç†æ—¶é—´çš„å½±å“ï¼ˆéœ€è¦æ›´å¤šæµ‹è¯•è§†é¢‘æ ·æœ¬æ¥åˆ†ææ­¤é¡¹ï¼‰ã€‚</li></ul></li><li><p>æ¯”è¾ƒè€—æ—¶ (Updated Interpretation based on new logs)</p><ul><li>å¯¹æ¯” CPU å’Œ GPU é…ç½®ä¸‹çš„è€—æ—¶ï¼Œè¯„ä¼° GPU åŠ é€Ÿçš„å®é™…æ•ˆæœã€‚ä»æœ€æ–°çš„ç¤ºä¾‹è¾“å‡ºæ¥çœ‹ï¼Œå¯¹äºâ€œå»ºç­‘å®¶å›­-02.mp4â€ (ä¸€ä¸ª60fpsçš„è§†é¢‘):<ul><li><code>Config_Default_CPU</code> (MultiDetector, CPU decode): 433.73 ç§’</li><li><code>Config_Default_GPU</code> (MultiDetector, GPU decode requested): 411.56 ç§’</li><li>è§‚å¯Ÿ: åœ¨è¿™ä¸ªç‰¹å®šçš„æµ‹è¯•ä¸­ (macOS, <code>VideoStreamCv2</code> è¢«ç”¨ä½œå›é€€)ï¼Œè¯·æ±‚ GPU è§£ç ç›¸æ¯”çº¯ CPU è§£ç ç•¥æœ‰æ€§èƒ½æå‡ (çº¦<br>22 ç§’ï¼Œæˆ– 5% çš„æå‡)ã€‚è¿™è¡¨æ˜åœ¨ macOS ä¸Šï¼Œå³ä½¿ PySceneDetect å›é€€åˆ° <code>VideoStreamCv2</code>ï¼Œåº•å±‚çš„ OpenCV å’Œ<br>AVFoundation/VideoToolbox å¯èƒ½ä»ç„¶åˆ©ç”¨äº†ä¸€äº›ç¡¬ä»¶åŠ é€Ÿã€‚ç„¶è€Œï¼Œè¿™ä¸ä¹‹å‰æ—¥å¿—ä¸­åœ¨é macOS ç¯å¢ƒä¸‹ä½¿ç”¨<br><code>VideoStreamCv2Cuda</code> å¯èƒ½å¸¦æ¥çš„æ›´æ˜¾è‘—æå‡æœ‰æ‰€ä¸åŒã€‚æ–‡æ¡£ä¸­åº”æŒ‡å‡ºï¼ŒGPU åŠ é€Ÿçš„æ•ˆæœé«˜åº¦ä¾èµ–äºæ“ä½œç³»ç»Ÿã€OpenCV<br>çš„ç¼–è¯‘é€‰é¡¹ã€PySceneDetect çš„åç«¯é€‰æ‹©ä»¥åŠå…·ä½“çš„ GPU ç¡¬ä»¶ã€‚</li></ul></li><li>å¯¹æ¯”ä¸åŒæ£€æµ‹å™¨ç»„åˆæˆ–å‚æ•°ä¸‹çš„è€—æ—¶ã€‚ä¾‹å¦‚:<ul><li><code>Config_ContentDetectorOnly_CPU</code> (ä»…ä½¿ç”¨ ContentDetector, CPU decode): 400.30 ç§’</li><li>è§‚å¯Ÿ: ä»…ä½¿ç”¨ <code>ContentDetector</code> ä»ç„¶æ˜¯æœ€å¿«çš„é…ç½®ï¼Œæ¯”ä½¿ç”¨ <code>MultiDetector</code> çš„ CPU é…ç½®å¿«äº†çº¦ 33 ç§’ã€‚ä½†æ£€æµ‹åˆ°çš„åœºæ™¯æ•°ä»<br>214 ä¸ªå‡å°‘åˆ°äº† 164 ä¸ªã€‚è¿™å†æ¬¡å¼ºè°ƒäº†åœ¨é€Ÿåº¦å’Œæ£€æµ‹å…¨é¢æ€§/å‡†ç¡®æ€§ä¹‹é—´çš„æƒè¡¡ã€‚</li></ul></li><li>é‡è¦æç¤º:<ul><li>æ—¥å¿—ä¸­å‡ºç° <code>Backend None not available. Trying another backend: opencv</code>ï¼Œå¹¶ä¸”åœ¨è¯·æ±‚ GPU è§£ç æ—¶ï¼Œæœ€ç»ˆä»ç„¶æ˜¯<br><code>opened with VideoStreamCv2</code>ã€‚è¿™è¡¨æ˜åœ¨å½“å‰çš„ macOS æµ‹è¯•ç¯å¢ƒä¸‹ï¼Œ<code>VideoStreamCv2Cuda</code> (å¦‚æœæœŸæœ›ä½¿ç”¨çš„è¯)<br>å¹¶æœªè¢«æˆåŠŸåŠ è½½æˆ–ä½¿ç”¨ï¼ŒPySceneDetect å›é€€åˆ°äº†æ ‡å‡†çš„ OpenCV åç«¯ (<code>VideoStreamCv2</code>)ã€‚æ–‡æ¡£åº”è¯¥æåŠè¿™ä¸€ç‚¹ï¼Œå¹¶å»ºè®®ç”¨æˆ·æ£€æŸ¥å…¶<br>PySceneDetect å’Œ OpenCV (åŒ…æ‹¬ CUDA æ”¯æŒ) çš„å®‰è£…ï¼Œå°¤å…¶æ˜¯åœ¨é macOS ç¯å¢ƒä¸‹æœŸæœ›ä½¿ç”¨ NVIDIA GPU åŠ é€Ÿæ—¶ã€‚</li><li>æ—¥å¿—ä¸­å‡ºç° <code>min_delta_hsv is deprecated, use min_content_val instead.</code> è¿™æ˜¯æ¥è‡ª <code>AdaptiveDetector</code><br>çš„ä¸€ä¸ªè­¦å‘Šã€‚è™½ç„¶ä¸å½±å“åŸºå‡†æµ‹è¯•çš„è€—æ—¶è®°å½•ï¼Œä½†åœ¨æ–‡æ¡£ä¸­æˆ–ä»£ç æ³¨é‡Šä¸­æåŠï¼Œå¹¶å»ºè®®æ›´æ–° <code>config.ini</code> æˆ–<br><code>AdaptiveDetector</code> çš„å‚æ•°ä»¥ä½¿ç”¨æ–°çš„ <code>min_content_val</code> æ˜¯ä¸€ä¸ªå¥½åšæ³•ï¼Œä»¥ä¿æŒä¸åº“æ›´æ–°çš„å…¼å®¹æ€§ã€‚</li></ul></li></ul></li></ul><p>macOSæ€§èƒ½æµ‹è¯•ç»“æœè§£é‡Š:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">/Users/zg/PycharmProjects/scene_detect_split/.venv/bin/python /Users/zg/PycharmProjects/scene_detect_split/src/tests/benchmark_scene_detector.py </span><br><span class="line">2025-05-30 10:46:40.555 | INFO     | config.config:initialize_settings:147 - Configuration successfully loaded from: /Users/zg/PycharmProjects/scene_detect_split/src/run/config.ini</span><br><span class="line">2025-05-30 10:46:40.556 | INFO     | __main__:&lt;module&gt;:118 - Configuration loaded from: /Users/zg/PycharmProjects/scene_detect_split/src/run/config.ini</span><br><span class="line">2025-05-30 10:46:40.556 | INFO     | __main__:&lt;module&gt;:210 - </span><br><span class="line">===== Processing Video: /Volumes/shared/æ ·ä¾‹/CGæ¸²æŸ“æ ·ä¾‹/å»ºç­‘å®¶å›­/å»ºç­‘å®¶å›­-02.mp4 =====</span><br><span class="line">2025-05-30 10:46:40.556 | INFO     | __main__:&lt;module&gt;:214 - --- Running with Configuration: Config_Default_CPU ---</span><br><span class="line">2025-05-30 10:46:40.556 | INFO     | __main__:run_detection_benchmark:50 - --- Benchmarking: å»ºç­‘å®¶å›­-02.mp4 ---</span><br><span class="line">2025-05-30 10:46:40.556 | INFO     | __main__:run_detection_benchmark:51 - Detector Setup: MultiDetector</span><br><span class="line">2025-05-30 10:46:40.556 | INFO     | __main__:run_detection_benchmark:52 - Using GPU for OpenCV decode: False</span><br><span class="line">2025-05-30 10:46:40.556 | INFO     | video.scene_detector:detect_scenes:69 - [MainThread] Starting detect_scenes for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;</span><br><span class="line">Backend None not available.</span><br><span class="line">Trying another backend: opencv</span><br><span class="line">2025-05-30 10:46:40.720 | INFO     | video.scene_detector:detect_scenes:99 - [MainThread] Video &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27; opened with VideoStreamCv2.</span><br><span class="line">2025-05-30 10:46:40.720 | INFO     | video.scene_detector:detect_scenes:126 - [MainThread] Configured detector type: MultiDetector for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 10:46:40.721 | INFO     | video.scene_detector:detect_scenes:133 - [MainThread] Effective global min_scene_len (frames) for detectors: 15 for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">min_delta_hsv is deprecated, use min_content_val instead.</span><br><span class="line">2025-05-30 10:53:54.141 | INFO     | video.scene_detector:detect_scenes:302 - [MainThread] SceneManager detected 214 scenes in &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 10:53:54.143 | INFO     | video.scene_detector:detect_scenes:334 - [MainThread] Final 214 scenes for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27; after adjustments.</span><br><span class="line">2025-05-30 10:53:54.296 | INFO     | __main__:run_detection_benchmark:76 - Profiling data saved to: profiling_results/profile_å»ºç­‘å®¶å›­_02_Config_Default_CPU.prof</span><br><span class="line">2025-05-30 10:53:54.297 | INFO     | __main__:run_detection_benchmark:83 - Video: å»ºç­‘å®¶å›­-02.mp4</span><br><span class="line">2025-05-30 10:53:54.297 | INFO     | __main__:run_detection_benchmark:85 - Detected Scenes: 214</span><br><span class="line">2025-05-30 10:53:54.298 | INFO     | __main__:run_detection_benchmark:86 - Detected Frame Rate: 60.00 fps</span><br><span class="line">2025-05-30 10:53:54.298 | INFO     | __main__:run_detection_benchmark:87 - Processing Time: 433.7327 seconds</span><br><span class="line">2025-05-30 10:53:54.298 | INFO     | __main__:run_detection_benchmark:90 - --- Benchmark End ---</span><br><span class="line">2025-05-30 10:53:54.298 | INFO     | __main__:&lt;module&gt;:214 - --- Running with Configuration: Config_Default_GPU ---</span><br><span class="line">2025-05-30 10:53:54.298 | INFO     | __main__:run_detection_benchmark:50 - --- Benchmarking: å»ºç­‘å®¶å›­-02.mp4 ---</span><br><span class="line">2025-05-30 10:53:54.298 | INFO     | __main__:run_detection_benchmark:51 - Detector Setup: MultiDetector</span><br><span class="line">2025-05-30 10:53:54.298 | INFO     | __main__:run_detection_benchmark:52 - Using GPU for OpenCV decode: True</span><br><span class="line">2025-05-30 10:53:54.298 | INFO     | video.scene_detector:detect_scenes:69 - [MainThread] Starting detect_scenes for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;</span><br><span class="line">2025-05-30 10:53:54.299 | INFO     | video.scene_detector:detect_scenes:95 - [MainThread] GPU decode (AVFoundation/VideoToolbox likely) on macOS for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">Backend None not available.</span><br><span class="line">Trying another backend: opencv</span><br><span class="line">2025-05-30 10:53:54.381 | INFO     | video.scene_detector:detect_scenes:99 - [MainThread] Video &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27; opened with VideoStreamCv2.</span><br><span class="line">2025-05-30 10:53:54.381 | INFO     | video.scene_detector:detect_scenes:126 - [MainThread] Configured detector type: MultiDetector for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 10:53:54.381 | INFO     | video.scene_detector:detect_scenes:133 - [MainThread] Effective global min_scene_len (frames) for detectors: 15 for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">min_delta_hsv is deprecated, use min_content_val instead.</span><br><span class="line">2025-05-30 11:00:45.457 | INFO     | video.scene_detector:detect_scenes:302 - [MainThread] SceneManager detected 214 scenes in &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 11:00:45.458 | INFO     | video.scene_detector:detect_scenes:334 - [MainThread] Final 214 scenes for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27; after adjustments.</span><br><span class="line">2025-05-30 11:00:45.865 | INFO     | __main__:run_detection_benchmark:76 - Profiling data saved to: profiling_results/profile_å»ºç­‘å®¶å›­_02_Config_Default_GPU.prof</span><br><span class="line">2025-05-30 11:00:45.865 | INFO     | __main__:run_detection_benchmark:83 - Video: å»ºç­‘å®¶å›­-02.mp4</span><br><span class="line">2025-05-30 11:00:45.865 | INFO     | __main__:run_detection_benchmark:85 - Detected Scenes: 214</span><br><span class="line">2025-05-30 11:00:45.865 | INFO     | __main__:run_detection_benchmark:86 - Detected Frame Rate: 60.00 fps</span><br><span class="line">2025-05-30 11:00:45.865 | INFO     | __main__:run_detection_benchmark:87 - Processing Time: 411.5587 seconds</span><br><span class="line">2025-05-30 11:00:45.865 | INFO     | __main__:run_detection_benchmark:90 - --- Benchmark End ---</span><br><span class="line">2025-05-30 11:00:45.865 | INFO     | __main__:&lt;module&gt;:214 - --- Running with Configuration: Config_ContentDetectorOnly_CPU ---</span><br><span class="line">2025-05-30 11:00:45.865 | INFO     | __main__:run_detection_benchmark:50 - --- Benchmarking: å»ºç­‘å®¶å›­-02.mp4 ---</span><br><span class="line">2025-05-30 11:00:45.865 | INFO     | __main__:run_detection_benchmark:51 - Detector Setup: ContentDetector</span><br><span class="line">2025-05-30 11:00:45.865 | INFO     | __main__:run_detection_benchmark:52 - Using GPU for OpenCV decode: False</span><br><span class="line">2025-05-30 11:00:45.865 | INFO     | video.scene_detector:detect_scenes:69 - [MainThread] Starting detect_scenes for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;</span><br><span class="line">Backend None not available.</span><br><span class="line">Trying another backend: opencv</span><br><span class="line">2025-05-30 11:00:45.939 | INFO     | video.scene_detector:detect_scenes:99 - [MainThread] Video &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27; opened with VideoStreamCv2.</span><br><span class="line">2025-05-30 11:00:45.939 | INFO     | video.scene_detector:detect_scenes:126 - [MainThread] Configured detector type: ContentDetector for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 11:00:45.939 | INFO     | video.scene_detector:detect_scenes:133 - [MainThread] Effective global min_scene_len (frames) for detectors: 15 for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 11:07:26.007 | INFO     | video.scene_detector:detect_scenes:302 - [MainThread] SceneManager detected 164 scenes in &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 11:07:26.011 | INFO     | video.scene_detector:detect_scenes:334 - [MainThread] Final 164 scenes for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27; after adjustments.</span><br><span class="line">2025-05-30 11:07:26.170 | INFO     | __main__:run_detection_benchmark:83 - Video: å»ºç­‘å®¶å›­-02.mp4</span><br><span class="line">2025-05-30 11:07:26.170 | INFO     | __main__:run_detection_benchmark:85 - Detected Scenes: 164</span><br><span class="line">2025-05-30 11:07:26.170 | INFO     | __main__:run_detection_benchmark:86 - Detected Frame Rate: 60.00 fps</span><br><span class="line">2025-05-30 11:07:26.170 | INFO     | __main__:run_detection_benchmark:87 - Processing Time: 400.2969 seconds</span><br><span class="line">2025-05-30 11:07:26.170 | INFO     | __main__:run_detection_benchmark:90 - --- Benchmark End ---</span><br><span class="line">2025-05-30 11:07:26.170 | INFO     | __main__:&lt;module&gt;:236 - </span><br><span class="line"></span><br><span class="line">===== Benchmark Summary =====</span><br><span class="line">2025-05-30 11:07:26.170 | INFO     | __main__:&lt;module&gt;:238 - </span><br><span class="line">Video: å»ºç­‘å®¶å›­-02.mp4</span><br><span class="line">2025-05-30 11:07:26.170 | INFO     | __main__:&lt;module&gt;:240 -   Config: Config_Default_CPU             | Duration: 433.7327s | Scenes: 214</span><br><span class="line">2025-05-30 11:07:26.170 | INFO     | __main__:&lt;module&gt;:240 -   Config: Config_Default_GPU             | Duration: 411.5587s | Scenes: 214</span><br><span class="line">2025-05-30 11:07:26.170 | INFO     | __main__:&lt;module&gt;:240 -   Config: Config_ContentDetectorOnly_CPU | Duration: 400.2969s | Scenes: 164</span><br><span class="line">2025-05-30 11:07:26.170 | INFO     | __main__:&lt;module&gt;:242 - </span><br><span class="line">To analyze .prof files, use a tool like &#x27;snakeviz&#x27; or Python&#x27;s pstats module.</span><br><span class="line">2025-05-30 11:07:26.170 | INFO     | __main__:&lt;module&gt;:243 - Example: python -m pstats profiling_results/your_profile_file.prof</span><br><span class="line">2025-05-30 11:07:26.170 | INFO     | __main__:&lt;module&gt;:244 - Then in pstats shell: sort cumulative, stats 20</span><br><span class="line"></span><br><span class="line">è¿›ç¨‹å·²ç»“æŸï¼Œé€€å‡ºä»£ç ä¸º 0</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>macOS ä¸Šçš„ GPU è§£ç :<ul><li>åœ¨ â€œGPU ç›‘æ§â€ æˆ– â€œæ¯”è¾ƒè€—æ—¶â€ éƒ¨åˆ†ï¼Œå¯ä»¥ç‰¹åˆ«è¯´æ˜åœ¨ macOS ä¸Šï¼Œå³ä½¿æ²¡æœ‰æ˜ç¡®çš„ <code>VideoStreamCv2Cuda</code>ï¼ŒPySceneDetect é€šè¿‡<br><code>VideoStreamCv2</code> ä¹Ÿå¯èƒ½é—´æ¥åˆ©ç”¨ VideoToolbox/AVFoundation è¿›è¡Œç¡¬ä»¶åŠ é€Ÿè§£ç ï¼Œä½†æ•ˆæœå¯èƒ½ä¸ä¸“ç”¨ CUDA åç«¯ä¸åŒã€‚</li></ul></li><li>PySceneDetect åç«¯å›é€€:<ul><li>åœ¨ â€œç»“æœåˆ†æâ€ æˆ– â€œæ•…éšœæ’æŸ¥â€ (å¦‚æœæ·»åŠ æ­¤ç« èŠ‚) éƒ¨åˆ†ï¼Œè§£é‡Š<br><code>Backend None not available. Trying another backend: opencv</code> æ—¥å¿—çš„å«ä¹‰ï¼Œå³ PySceneDetect<br>å°è¯•äº†é»˜è®¤åç«¯ï¼ˆå¯èƒ½æ˜¯ç”¨æˆ·æŒ‡å®šçš„æˆ–åº“çš„ä¼˜é€‰ï¼‰ä½†å¤±è´¥ï¼Œç„¶åå›é€€åˆ° OpenCVã€‚è¿™å¯¹äºç†è§£å®é™…ä½¿ç”¨çš„è§£ç è·¯å¾„å¾ˆé‡è¦ã€‚</li></ul></li><li>ä¾èµ–åº“ç‰ˆæœ¬çš„é‡è¦æ€§:<ul><li>å†æ¬¡å¼ºè°ƒåœ¨ â€œè½¯ä»¶ç¯å¢ƒä¸€è‡´æ€§â€ éƒ¨åˆ†ï¼ŒPySceneDetectã€OpenCV (åŠå…¶ CUDA/OpenCL æ”¯æŒçš„ç¼–è¯‘æ–¹å¼)ã€FFmpeg<br>çš„ç‰ˆæœ¬éƒ½ä¼šæ˜¾è‘—å½±å“æ€§èƒ½å’ŒåŠŸèƒ½ï¼ŒåŒ…æ‹¬ç¡¬ä»¶åŠ é€Ÿçš„å¯ç”¨æ€§ã€‚</li></ul></li><li><code>min_delta_hsv</code> åºŸå¼ƒè­¦å‘Š:<ul><li>åœ¨ â€œé…ç½®æµ‹è¯•å‚æ•°â€ æˆ– â€œç»“æœåˆ†æâ€ éƒ¨åˆ†ï¼Œæç¤ºç”¨æˆ·æ³¨æ„ PySceneDetect çš„åºŸå¼ƒè­¦å‘Šï¼Œå¹¶åŠæ—¶æ›´æ–°å…¶é…ç½®æ–‡ä»¶æˆ–ä»£ç ä»¥ä½¿ç”¨æ¨èçš„æ–°å‚æ•°ã€‚</li></ul></li></ul><p>é€šè¿‡è¿™äº›è¡¥å……ï¼Œ<code>benchmark_test.md</code> æ–‡æ¡£å°†æ›´å‡†ç¡®åœ°åæ˜ å®é™…çš„æµ‹è¯•æƒ…å†µï¼Œå¹¶ä¸ºç”¨æˆ·æä¾›æ›´æœ‰ä»·å€¼çš„æ€§èƒ½åˆ†ææŒ‡å¯¼ã€‚</p><h3 id="4-2-åˆ†ææ€§èƒ½å‰–æ-prof-æ–‡ä»¶">4.2. åˆ†ææ€§èƒ½å‰–æ (<code>.prof</code>) æ–‡ä»¶</h3><p>ä½¿ç”¨ Python çš„ <code>pstats</code> æ¨¡å—æˆ– <code>snakeviz</code> å·¥å…·æ¥åˆ†æ <code>.prof</code> æ–‡ä»¶ã€‚</p><ul><li>ä½¿ç”¨ <code>pstats</code> (å‘½ä»¤è¡Œ)</li><li>snakeviz ä¼šåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ä¸€ä¸ªäº¤äº’å¼çš„ç«ç„°å›¾æˆ–æ—­æ—¥å›¾ï¼Œç›´è§‚åœ°å±•ç¤ºå‡½æ•°è°ƒç”¨æ ˆå’Œå„éƒ¨åˆ†è€—æ—¶ã€‚</li><li>å…³æ³¨ç‚¹ï¼š</li><li>è€—æ—¶æœ€å¤šçš„å‡½æ•°ï¼šè¿™äº›æ˜¯é¦–è¦çš„ä¼˜åŒ–ç›®æ ‡ã€‚é€šå¸¸ä¼šæ˜¯ PySceneDetect åº“ä¸­ä¸è§†é¢‘è§£ç ã€å¸§å¤„ç†ä»¥åŠå„æ£€æµ‹å™¨æ ¸å¿ƒç®—æ³•ç›¸å…³çš„å‡½æ•°ã€‚</li><li>PySceneDetect å†…éƒ¨å‡½æ•°ï¼šå¦‚æœç“¶é¢ˆåœ¨ PySceneDetect åº“å†…éƒ¨ï¼ˆå¦‚ç‰¹å®šæ£€æµ‹å™¨çš„ process_frame<br>æ–¹æ³•ï¼Œè§†é¢‘è§£ç å‡½æ•°ï¼‰ï¼Œä¼˜åŒ–æ–¹å‘å¯èƒ½åŒ…æ‹¬è°ƒæ•´æ£€æµ‹å™¨å‚æ•°ã€é€‰æ‹©æ›´å¿«çš„æ£€æµ‹å™¨ã€æˆ–ä¼˜åŒ–è§†é¢‘è§£ç æ–¹å¼ï¼ˆå¦‚éªŒè¯ GPU è§£ç æ•ˆæœï¼Œå°è¯•å¸§é™é‡‡æ ·ï¼‰ã€‚</li><li>è‡ªå®šä¹‰é€»è¾‘ï¼šå¦‚æœ detect_scenes å‡½æ•°ä¸­è‡ªå®šä¹‰çš„é€»è¾‘éƒ¨åˆ†ï¼ˆä¾‹å¦‚ï¼Œåœ¨ scene_detector.py ä¸­æ·»åŠ æ£€æµ‹å™¨ã€è°ƒæ•´åœºæ™¯åˆ—è¡¨çš„å¾ªç¯ï¼‰è€—æ—¶è¾ƒé•¿ï¼Œéœ€è¦é’ˆå¯¹æ€§ä¼˜åŒ–ã€‚</li></ul><h3 id="4-3-åˆ†æèµ„æºç›‘æ§æ•°æ®">4.3. åˆ†æèµ„æºç›‘æ§æ•°æ®</h3><h4 id="CPU-ç“¶é¢ˆï¼š">CPU ç“¶é¢ˆï¼š</h4><ul><li>å¦‚æœ CPU å•æ ¸æˆ–å¤šæ ¸é•¿æ—¶é—´å¤„äºé«˜è´Ÿè½½çŠ¶æ€ï¼Œè¡¨æ˜è®¡ç®—æ˜¯ç“¶é¢ˆã€‚</li><li>æ£€æŸ¥æ˜¯å¦å­˜åœ¨æŸä¸ªæ ¸å¿ƒè¿œé«˜äºå…¶ä»–æ ¸å¿ƒçš„æƒ…å†µï¼ˆå¯èƒ½è¡¨ç¤ºå¹¶è¡Œåº¦ä¸è¶³æˆ–æŸäº›æ“ä½œæ— æ³•æœ‰æ•ˆå¹¶è¡Œï¼Œå°½ç®¡ detect_scenes æœ¬èº«æ˜¯å•çº¿ç¨‹çš„ï¼Œä½†å…¶è°ƒç”¨çš„<br>OpenCV æˆ– FFmpeg åç«¯å¯èƒ½åˆ©ç”¨å¤šæ ¸ï¼‰ã€‚</li></ul><h4 id="å†…å­˜ç“¶é¢ˆï¼š">å†…å­˜ç“¶é¢ˆï¼š</h4><ul><li>å¦‚æœå†…å­˜ä½¿ç”¨æŒç»­å¢é•¿æˆ–è¾¾åˆ°ç³»ç»Ÿä¸Šé™ï¼Œå¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼æˆ–å¤„ç†å¤§æ•°æ®æ—¶å†…å­˜ç®¡ç†ä¸å½“ã€‚</li><li>PySceneDetect é€šå¸¸æ˜¯æµå¼å¤„ç†ï¼Œä½†æŸäº›é…ç½®æˆ–é•¿è§†é¢‘ä»å¯èƒ½æ¶ˆè€—è¾ƒå¤šå†…å­˜ã€‚ç¡®ä¿ video_api_obj.reset() è¢«æ­£ç¡®è°ƒç”¨ã€‚</li></ul><h4 id="GPU-ç“¶é¢ˆï¼š">GPU ç“¶é¢ˆï¼š</h4><ul><li>å¦‚æœå¯ç”¨äº† GPU åŠ é€Ÿï¼Œä½† GPU åˆ©ç”¨ç‡ä½ï¼Œæ£€æŸ¥é©±åŠ¨ã€CUDA/OpenCV é…ç½®ï¼Œä»¥åŠæ•°æ®ä¼ è¾“åˆ° GPU çš„å¼€é”€ã€‚ç¤ºä¾‹è¾“å‡ºæ˜¾ç¤º GPU é…ç½® (<br>Config_Default_GPU) é€Ÿåº¦æ›´å¿«ï¼Œè¡¨æ˜ GPU åœ¨æ­¤åœºæ™¯ä¸‹å¯èƒ½å¾—åˆ°äº†æœ‰æ•ˆåˆ©ç”¨ã€‚</li><li>å¦‚æœ GPU åˆ©ç”¨ç‡é«˜ï¼Œä½†æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Œå¯èƒ½ç“¶é¢ˆåœ¨å…¶ä»–éƒ¨åˆ†ï¼ˆå¦‚ Python ä»£ç æœ¬èº«ã€ç£ç›˜ I/Oï¼‰ã€‚</li></ul><h2 id="5-æ ¹æ®åˆ†æç»“æœæ”¹è¿›ä»£ç -ä¼˜åŒ–æ–¹å‘ç¤ºä¾‹">5.æ ¹æ®åˆ†æç»“æœæ”¹è¿›ä»£ç  (ä¼˜åŒ–æ–¹å‘ç¤ºä¾‹)</h2><blockquote><p>åŸºäºä¸Šè¿°åˆ†æï¼Œå¯ä»¥é’ˆå¯¹æ€§åœ°å¯¹ scene_detector.py åŠç›¸å…³æ¨¡å—è¿›è¡Œä¼˜åŒ–ï¼š</p></blockquote><h4 id="åœºæ™¯æ£€æµ‹ç­–ç•¥ä¼˜åŒ–ï¼š">åœºæ™¯æ£€æµ‹ç­–ç•¥ä¼˜åŒ–ï¼š</h4><ul><li>è°ƒæ•´æ£€æµ‹å™¨ï¼šæ ¹æ®æ€§èƒ½å’Œå‡†ç¡®åº¦éœ€æ±‚ï¼Œåœ¨ config.ini ä¸­å¯ç”¨æˆ–ç¦ç”¨ç‰¹å®šçš„æ£€æµ‹å™¨ï¼Œæˆ–è°ƒæ•´å…¶å‚æ•°ï¼ˆå¦‚ threshold,<br>min_scene_len_framesï¼‰ã€‚ä»ç¤ºä¾‹è¾“å‡ºçœ‹ï¼Œä»…ä½¿ç”¨ ContentDetector é€Ÿåº¦æœ€å¿«ï¼Œä½†åœºæ™¯æ•°ç•¥å°‘ã€‚éœ€è¦æ ¹æ®ä¸šåŠ¡éœ€æ±‚å†³å®šæ˜¯å¦å€¼å¾—ç‰ºç‰²ä¸€äº›æ£€æµ‹åœºæ™¯æ¢å–é€Ÿåº¦ã€‚</li><li>å¸§é™é‡‡æ ·ï¼šå¯¹äºé•¿è§†é¢‘ï¼Œåœ¨ scene_detector.py ä¸­ä¸º SceneManager è®¾ç½® frame_skip æˆ–é€šè¿‡<br>video_api_obj.set_downscale_factor() æ¥å‡å°‘å¤„ç†çš„å¸§æ•°/åˆ†è¾¨ç‡ï¼Œä»¥å¤§å¹…æå‡é€Ÿåº¦ã€‚å°†å…¶ä½œä¸ºå¯é…ç½®é¡¹ã€‚è§†é¢‘è§£ç ä¼˜åŒ–ï¼š</li><li>åŸºäºæµ‹è¯•ç»“æœï¼Œç¡®å®š CPU è§£ç æˆ– GPU è§£ç  (VideoStreamCv2Cuda) åœ¨ä½•ç§æƒ…å†µä¸‹æ›´ä¼˜ï¼Œå¹¶ç›¸åº”è°ƒæ•´é…ç½®ã€‚ç¤ºä¾‹ä¸­ GPU è§£ç æ•ˆæœæ˜æ˜¾ã€‚</li></ul><h4 id="ä»£ç é€»è¾‘ä¼˜åŒ–ï¼š">ä»£ç é€»è¾‘ä¼˜åŒ–ï¼š</h4><ul><li>æ£€æŸ¥ detect_scenes å†…éƒ¨æ˜¯å¦æœ‰å¯ä¼˜åŒ–çš„å¾ªç¯æˆ–æ•°æ®å¤„ç†ã€‚ç¡®ä¿èµ„æºï¼ˆå¦‚ video_api_objï¼‰å¾—åˆ°æ­£ç¡®å’ŒåŠæ—¶çš„é‡Šæ”¾ã€‚</li></ul><h4 id="é•¿è§†é¢‘ç‰¹å®šä¼˜åŒ–ï¼š">é•¿è§†é¢‘ç‰¹å®šä¼˜åŒ–ï¼š</h4><ul><li>è€ƒè™‘æ›´ç»†ç²’åº¦çš„æ£€æŸ¥ç‚¹æœºåˆ¶ï¼ˆå¦‚æœ detect_scenes æœ¬èº«è€—æ—¶è¿‡é•¿ï¼‰ã€‚</li><li>æ¢ç´¢åˆ†å—å¤„ç†é•¿è§†é¢‘çš„ç­–ç•¥ã€‚</li></ul><h2 id="6-è¿­ä»£ä¸éªŒè¯">6. è¿­ä»£ä¸éªŒè¯</h2><blockquote><p>æ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªè¿­ä»£è¿‡ç¨‹ã€‚æ¯æ¬¡åº”ç”¨ä¼˜åŒ–åï¼Œéƒ½åº”é‡æ–°è¿è¡ŒåŸºå‡†æµ‹è¯•ï¼Œä»¥éªŒè¯ä¼˜åŒ–çš„æ•ˆæœï¼Œå¹¶ç¡®ä¿æ²¡æœ‰å¼•å…¥æ–°çš„æ€§èƒ½é—®é¢˜æˆ–åŠŸèƒ½æ€§ç¼ºé™·ã€‚</p></blockquote><blockquote><p>é€šè¿‡éµå¾ªæœ¬æŒ‡å—ï¼Œæ‚¨å¯ä»¥ç³»ç»Ÿåœ°è¯„ä¼°å’Œæå‡è§†é¢‘å¤„ç†é¡¹ç›®çš„æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†è®¡ç®—å¯†é›†çš„åœºæ™¯æ£€æµ‹ä»»åŠ¡æ—¶ã€‚</p></blockquote><h2 id="æ€»ç»“">æ€»ç»“</h2><h3 id="macOS-åœºæ™¯æ£€æµ‹æ€§èƒ½æµ‹è¯•æ€»ç»“">macOS åœºæ™¯æ£€æµ‹æ€§èƒ½æµ‹è¯•æ€»ç»“</h3><p>æµ‹è¯•è§†é¢‘: <code>å»ºç­‘å®¶å›­-02.mp4</code> (60fps)<br>æµ‹è¯•æ—¥æœŸ: 2025-05-30</p><h4 id="å…³é”®æµ‹è¯•æ•°æ®">å…³é”®æµ‹è¯•æ•°æ®</h4><table><thead><tr><th style="text-align:left">æµ‹è¯•é…ç½®</th><th style="text-align:left">è§£ç æ–¹å¼</th><th style="text-align:left">æ£€æµ‹å™¨ç»„åˆ</th><th style="text-align:left">å¤„ç†æ—¶é•¿ (ç§’)</th><th style="text-align:left">æ£€æµ‹åœºæ™¯æ•°</th><th style="text-align:left">å¸§ç‡ (fps)</th></tr></thead><tbody><tr><td style="text-align:left"><code>Config_Default_CPU</code></td><td style="text-align:left">CPU</td><td style="text-align:left">MultiDetector</td><td style="text-align:left">433.7327</td><td style="text-align:left">214</td><td style="text-align:left">60.00</td></tr><tr><td style="text-align:left"><code>Config_Default_GPU</code></td><td style="text-align:left">GPU (è¯·æ±‚)</td><td style="text-align:left">MultiDetector</td><td style="text-align:left">411.5587</td><td style="text-align:left">214</td><td style="text-align:left">60.00</td></tr><tr><td style="text-align:left"><code>Config_ContentDetectorOnly_CPU</code></td><td style="text-align:left">CPU</td><td style="text-align:left">ContentDetector</td><td style="text-align:left">400.2969</td><td style="text-align:left">164</td><td style="text-align:left">60.00</td></tr></tbody></table><h4 id="ä¸»è¦ç»“è®º">ä¸»è¦ç»“è®º</h4><ol><li><p>GPU åŠ é€Ÿåœ¨ macOS ä¸Šçš„è¡¨ç°:</p><ul><li>å½“è¯·æ±‚ GPU è§£ç æ—¶ (<code>Config_Default_GPU</code>)ï¼Œå³ä½¿ PySceneDetect æ—¥å¿—æ˜¾ç¤ºå›é€€åˆ°æ ‡å‡†çš„ <code>VideoStreamCv2</code> åç«¯ (è€Œé <code>VideoStreamCv2Cuda</code>)ï¼Œå¤„ç†é€Ÿåº¦ç›¸æ¯”çº¯ CPU è§£ç  (<code>Config_Default_CPU</code>) ä»æœ‰çº¦ 5% çš„æå‡ (ä» 433.73 ç§’é™è‡³ 411.56 ç§’)ã€‚</li><li>è¿™è¡¨æ˜åœ¨ macOS ä¸Šï¼Œ<code>VideoStreamCv2</code> å¯èƒ½é—´æ¥åˆ©ç”¨äº†ç³»ç»Ÿçº§çš„ç¡¬ä»¶åŠ é€Ÿæ¡†æ¶ (å¦‚ AVFoundation/VideoToolbox) è¿›è¡Œè§†é¢‘è§£ç ã€‚</li><li>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§æå‡å¹…åº¦å¯èƒ½ä¸å¦‚åœ¨å…·æœ‰ä¸“ç”¨ NVIDIA GPU å’Œæ­£ç¡®é…ç½® CUDA çš„ç¯å¢ƒä¸­ä½¿ç”¨ <code>VideoStreamCv2Cuda</code> æ—¶æ˜¾è‘—ã€‚</li></ul></li><li><p>æ£€æµ‹å™¨é€‰æ‹©å¯¹æ€§èƒ½å’Œç»“æœçš„æ˜¾è‘—å½±å“:</p><ul><li>ä»…ä½¿ç”¨ <code>ContentDetector</code> (<code>Config_ContentDetectorOnly_CPU</code>) çš„é…ç½®é€Ÿåº¦æœ€å¿«ï¼Œå¤„ç†æ—¶é•¿ä¸º 400.30 ç§’ã€‚</li><li>ä¸ä½¿ç”¨ <code>MultiDetector</code> çš„ CPU é…ç½® (<code>Config_Default_CPU</code>) ç›¸æ¯”ï¼Œé€Ÿåº¦æå‡äº†çº¦ 7.7% (å¿«äº†çº¦ 33 ç§’)ã€‚</li><li>ç„¶è€Œï¼Œä»…ä½¿ç”¨ <code>ContentDetector</code> æ—¶ï¼Œæ£€æµ‹åˆ°çš„åœºæ™¯æ•°ä» 214 ä¸ªå‡å°‘åˆ° 164 ä¸ªï¼Œè¡¨æ˜ç‰ºç‰²äº†ä¸€å®šçš„æ£€æµ‹å…¨é¢æ€§ã€‚è¿™éœ€è¦åœ¨å¤„ç†æ•ˆç‡å’Œæ£€æµ‹ç»“æœçš„å®Œæ•´æ€§ä¹‹é—´è¿›è¡Œæƒè¡¡ã€‚</li></ul></li><li><p>PySceneDetect åç«¯è¡Œä¸º:</p><ul><li>æµ‹è¯•æ—¥å¿—ä¸­å‡ºç° <code>Backend None not available. Trying another backend: opencv</code>ï¼Œè¡¨æ˜ PySceneDetect åœ¨å°è¯•ä½¿ç”¨ä¸€ä¸ªï¼ˆå¯èƒ½æ˜¯ç”¨æˆ·é…ç½®çš„æˆ–åº“ä¼˜é€‰çš„ï¼‰åç«¯å¤±è´¥åï¼ŒæˆåŠŸå›é€€åˆ°äº† OpenCV åç«¯ (<code>VideoStreamCv2</code>)ã€‚è¿™å¯¹äºç†è§£å®é™…çš„è§£ç è·¯å¾„å’Œæ’æŸ¥é…ç½®é—®é¢˜éå¸¸é‡è¦ã€‚</li></ul></li><li><p>åº“çš„å…¼å®¹æ€§æç¤º:</p><ul><li>æ—¥å¿—ä¸­ <code>AdaptiveDetector</code> ç›¸å…³çš„è­¦å‘Š <code>min_delta_hsv is deprecated, use min_content_val instead.</code> æç¤ºéœ€è¦æ›´æ–°é…ç½®æ–‡ä»¶ä¸­çš„å‚æ•°ï¼Œä»¥ç¡®ä¿ä¸ PySceneDetect åº“çš„æŒç»­å…¼å®¹æ€§å’Œæœ€ä½³å®è·µã€‚</li></ul></li></ol><h3 id="windows-æµ‹è¯•ç»“æœ">windows æµ‹è¯•ç»“æœ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">D:\pythonProject\venv1\Scripts\python.exe D:\pythonProject\scene-detect-split1\src\tests\benchmark_scene_detector.py </span><br><span class="line">2025-05-30 14:11:57.528 | INFO     | config.config:initialize_settings:147 - Configuration successfully loaded from: D:\pythonProject\scene-detect-split1\src\run\config.ini</span><br><span class="line">2025-05-30 14:11:57.529 | INFO     | __main__:&lt;module&gt;:118 - Configuration loaded from: D:\pythonProject\scene-detect-split1\src\run\config.ini</span><br><span class="line">2025-05-30 14:11:57.869 | INFO     | __main__:&lt;module&gt;:210 - </span><br><span class="line">===== Processing Video: Z:\æ ·ä¾‹\CGæ¸²æŸ“æ ·ä¾‹\å»ºç­‘å®¶å›­\å»ºç­‘å®¶å›­-02.mp4 =====</span><br><span class="line">2025-05-30 14:11:57.869 | INFO     | __main__:&lt;module&gt;:214 - --- Running with Configuration: Config_Default_CPU ---</span><br><span class="line">2025-05-30 14:11:57.869 | INFO     | __main__:run_detection_benchmark:50 - --- Benchmarking: å»ºç­‘å®¶å›­-02.mp4 ---</span><br><span class="line">2025-05-30 14:11:57.869 | INFO     | __main__:run_detection_benchmark:51 - Detector Setup: ContentDetector</span><br><span class="line">2025-05-30 14:11:57.869 | INFO     | __main__:run_detection_benchmark:52 - Using GPU for OpenCV decode: False</span><br><span class="line">2025-05-30 14:11:57.870 | INFO     | video.scene_detector:detect_scenes:69 - [MainThread] Starting detect_scenes for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;</span><br><span class="line">Backend None not available.</span><br><span class="line">Trying another backend: opencv</span><br><span class="line">2025-05-30 14:11:58.075 | INFO     | video.scene_detector:detect_scenes:99 - [MainThread] Video &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27; opened with VideoStreamCv2.</span><br><span class="line">2025-05-30 14:11:58.075 | INFO     | video.scene_detector:detect_scenes:126 - [MainThread] Configured detector type: ContentDetector for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 14:11:58.075 | INFO     | video.scene_detector:detect_scenes:133 - [MainThread] Effective global min_scene_len (frames) for detectors: 15 for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 14:16:45.990 | INFO     | video.scene_detector:detect_scenes:302 - [MainThread] SceneManager detected 159 scenes in &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 14:16:45.990 | INFO     | video.scene_detector:detect_scenes:334 - [MainThread] Final 159 scenes for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27; after adjustments.</span><br><span class="line">2025-05-30 14:16:46.113 | INFO     | __main__:run_detection_benchmark:76 - Profiling data saved to: profiling_results\profile_å»ºç­‘å®¶å›­_02_Config_Default_CPU.prof</span><br><span class="line">2025-05-30 14:16:46.113 | INFO     | __main__:run_detection_benchmark:83 - Video: å»ºç­‘å®¶å›­-02.mp4</span><br><span class="line">2025-05-30 14:16:46.113 | INFO     | __main__:run_detection_benchmark:85 - Detected Scenes: 159</span><br><span class="line">2025-05-30 14:16:46.113 | INFO     | __main__:run_detection_benchmark:86 - Detected Frame Rate: 60.00 fps</span><br><span class="line">2025-05-30 14:16:46.113 | INFO     | __main__:run_detection_benchmark:87 - Processing Time: 288.2435 seconds</span><br><span class="line">2025-05-30 14:16:46.113 | INFO     | __main__:run_detection_benchmark:90 - --- Benchmark End ---</span><br><span class="line">2025-05-30 14:16:46.113 | INFO     | __main__:&lt;module&gt;:214 - --- Running with Configuration: Config_Default_GPU ---</span><br><span class="line">2025-05-30 14:16:46.113 | INFO     | __main__:run_detection_benchmark:50 - --- Benchmarking: å»ºç­‘å®¶å›­-02.mp4 ---</span><br><span class="line">2025-05-30 14:16:46.113 | INFO     | __main__:run_detection_benchmark:51 - Detector Setup: ContentDetector</span><br><span class="line">2025-05-30 14:16:46.113 | INFO     | __main__:run_detection_benchmark:52 - Using GPU for OpenCV decode: True</span><br><span class="line">2025-05-30 14:16:46.113 | INFO     | video.scene_detector:detect_scenes:69 - [MainThread] Starting detect_scenes for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;</span><br><span class="line">2025-05-30 14:16:46.147 | WARNING  | video.scene_detector:detect_scenes:93 - [MainThread] VideoStreamCv2Cuda not available. Using CPU for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">Backend None not available.</span><br><span class="line">Trying another backend: opencv</span><br><span class="line">2025-05-30 14:16:46.242 | INFO     | video.scene_detector:detect_scenes:99 - [MainThread] Video &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27; opened with VideoStreamCv2.</span><br><span class="line">2025-05-30 14:16:46.243 | INFO     | video.scene_detector:detect_scenes:126 - [MainThread] Configured detector type: ContentDetector for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 14:16:46.243 | INFO     | video.scene_detector:detect_scenes:133 - [MainThread] Effective global min_scene_len (frames) for detectors: 15 for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 14:20:35.982 | INFO     | video.scene_detector:detect_scenes:302 - [MainThread] SceneManager detected 159 scenes in &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 14:20:35.982 | INFO     | video.scene_detector:detect_scenes:334 - [MainThread] Final 159 scenes for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27; after adjustments.</span><br><span class="line">2025-05-30 14:20:36.101 | INFO     | __main__:run_detection_benchmark:76 - Profiling data saved to: profiling_results\profile_å»ºç­‘å®¶å›­_02_Config_Default_GPU.prof</span><br><span class="line">2025-05-30 14:20:36.101 | INFO     | __main__:run_detection_benchmark:83 - Video: å»ºç­‘å®¶å›­-02.mp4</span><br><span class="line">2025-05-30 14:20:36.102 | INFO     | __main__:run_detection_benchmark:85 - Detected Scenes: 159</span><br><span class="line">2025-05-30 14:20:36.102 | INFO     | __main__:run_detection_benchmark:86 - Detected Frame Rate: 60.00 fps</span><br><span class="line">2025-05-30 14:20:36.102 | INFO     | __main__:run_detection_benchmark:87 - Processing Time: 229.9882 seconds</span><br><span class="line">2025-05-30 14:20:36.102 | INFO     | __main__:run_detection_benchmark:90 - --- Benchmark End ---</span><br><span class="line">2025-05-30 14:20:36.102 | INFO     | __main__:&lt;module&gt;:214 - --- Running with Configuration: Config_ContentDetectorOnly_CPU ---</span><br><span class="line">2025-05-30 14:20:36.102 | INFO     | __main__:run_detection_benchmark:50 - --- Benchmarking: å»ºç­‘å®¶å›­-02.mp4 ---</span><br><span class="line">2025-05-30 14:20:36.102 | INFO     | __main__:run_detection_benchmark:51 - Detector Setup: ContentDetector</span><br><span class="line">2025-05-30 14:20:36.102 | INFO     | __main__:run_detection_benchmark:52 - Using GPU for OpenCV decode: False</span><br><span class="line">2025-05-30 14:20:36.102 | INFO     | video.scene_detector:detect_scenes:69 - [MainThread] Starting detect_scenes for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;</span><br><span class="line">Backend None not available.</span><br><span class="line">Trying another backend: opencv</span><br><span class="line">2025-05-30 14:20:36.194 | INFO     | video.scene_detector:detect_scenes:99 - [MainThread] Video &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27; opened with VideoStreamCv2.</span><br><span class="line">2025-05-30 14:20:36.194 | INFO     | video.scene_detector:detect_scenes:126 - [MainThread] Configured detector type: ContentDetector for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 14:20:36.194 | INFO     | video.scene_detector:detect_scenes:133 - [MainThread] Effective global min_scene_len (frames) for detectors: 15 for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 14:24:23.153 | INFO     | video.scene_detector:detect_scenes:302 - [MainThread] SceneManager detected 159 scenes in &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 14:24:23.153 | INFO     | video.scene_detector:detect_scenes:334 - [MainThread] Final 159 scenes for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27; after adjustments.</span><br><span class="line">2025-05-30 14:24:23.278 | INFO     | __main__:run_detection_benchmark:83 - Video: å»ºç­‘å®¶å›­-02.mp4</span><br><span class="line">2025-05-30 14:24:23.278 | INFO     | __main__:run_detection_benchmark:85 - Detected Scenes: 159</span><br><span class="line">2025-05-30 14:24:23.278 | INFO     | __main__:run_detection_benchmark:86 - Detected Frame Rate: 60.00 fps</span><br><span class="line">2025-05-30 14:24:23.278 | INFO     | __main__:run_detection_benchmark:87 - Processing Time: 227.1770 seconds</span><br><span class="line">2025-05-30 14:24:23.278 | INFO     | __main__:run_detection_benchmark:90 - --- Benchmark End ---</span><br><span class="line">2025-05-30 14:24:23.278 | INFO     | __main__:&lt;module&gt;:236 - </span><br><span class="line"></span><br><span class="line">===== Benchmark Summary =====</span><br><span class="line">2025-05-30 14:24:23.280 | INFO     | __main__:&lt;module&gt;:238 - </span><br><span class="line">Video: å»ºç­‘å®¶å›­-02.mp4</span><br><span class="line">2025-05-30 14:24:23.280 | INFO     | __main__:&lt;module&gt;:240 -   Config: Config_Default_CPU             | Duration: 288.2435s | Scenes: 159</span><br><span class="line">2025-05-30 14:24:23.280 | INFO     | __main__:&lt;module&gt;:240 -   Config: Config_Default_GPU             | Duration: 229.9882s | Scenes: 159</span><br><span class="line">2025-05-30 14:24:23.280 | INFO     | __main__:&lt;module&gt;:240 -   Config: Config_ContentDetectorOnly_CPU | Duration: 227.1770s | Scenes: 159</span><br><span class="line">2025-05-30 14:24:23.280 | INFO     | __main__:&lt;module&gt;:242 - </span><br><span class="line">To analyze .prof files, use a tool like &#x27;snakeviz&#x27; or Python&#x27;s pstats module.</span><br><span class="line">2025-05-30 14:24:23.280 | INFO     | __main__:&lt;module&gt;:243 - Example: python -m pstats profiling_results/your_profile_file.prof</span><br><span class="line">2025-05-30 14:24:23.280 | INFO     | __main__:&lt;module&gt;:244 - Then in pstats shell: sort cumulative, stats 20</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Windows-å¹³å°åœºæ™¯æ£€æµ‹æ€§èƒ½æµ‹è¯•æ€»ç»“">Windows å¹³å°åœºæ™¯æ£€æµ‹æ€§èƒ½æµ‹è¯•æ€»ç»“</h4><p>æµ‹è¯•è§†é¢‘: <code>å»ºç­‘å®¶å›­-02.mp4</code> (60fps)<br>æµ‹è¯•æ—¥æœŸ: 2025-05-30<br>æµ‹è¯•å¹³å°: Windows</p><h5 id="å…³é”®æµ‹è¯•æ•°æ®-2">å…³é”®æµ‹è¯•æ•°æ®</h5><table><thead><tr><th style="text-align:left">æµ‹è¯•é…ç½®</th><th style="text-align:left">è§£ç æ–¹å¼</th><th style="text-align:left">æ£€æµ‹å™¨è®¾ç½®</th><th style="text-align:left">å¤„ç†æ—¶é•¿ (ç§’)</th><th style="text-align:left">æ£€æµ‹åœºæ™¯æ•°</th></tr></thead><tbody><tr><td style="text-align:left"><code>Config_Default_CPU</code></td><td style="text-align:left">CPU</td><td style="text-align:left">ContentDetector*</td><td style="text-align:left">288.2435</td><td style="text-align:left">159</td></tr><tr><td style="text-align:left"><code>Config_Default_GPU</code></td><td style="text-align:left">GPU (è¯·æ±‚)</td><td style="text-align:left">ContentDetector*</td><td style="text-align:left">229.9882</td><td style="text-align:left">159</td></tr><tr><td style="text-align:left"><code>Config_ContentDetectorOnly_CPU</code></td><td style="text-align:left">CPU</td><td style="text-align:left">ContentDetector</td><td style="text-align:left">227.1770</td><td style="text-align:left">159</td></tr></tbody></table><ul><li>é‡è¦: æ—¥å¿—æ˜¾ç¤ºæ‰€æœ‰é…ç½®ï¼ˆåŒ…æ‹¬ <code>Config_Default_CPU</code> å’Œ <code>Config_Default_GPU</code>ï¼‰çš„ <code>Detector Setup</code> å‡ä¸º <code>ContentDetector</code>ã€‚è¿™è¡¨æ˜ <code>benchmark_scene_detector.py</code> ä¸­çš„è¿™äº› â€œDefaultâ€ é…ç½®å¯èƒ½é”™è¯¯åœ°ä»…æŒ‡å®šäº† <code>ContentDetector</code>ï¼Œè€Œä¸æ˜¯ <code>config.ini</code> ä¸­å®šä¹‰çš„ <code>MultiDetector</code>ã€‚å› æ­¤ï¼Œä»¥ä¸‹åˆ†æåŸºäºæ‰€æœ‰æµ‹è¯•å®é™…ä¸Šéƒ½åªä½¿ç”¨äº† <code>ContentDetector</code>ã€‚</li></ul><h5 id="ä¸»è¦ç»“è®º-2">ä¸»è¦ç»“è®º</h5><ol><li><p>GPU åŠ é€Ÿè¯·æ±‚åœ¨ Windows ä¸Šçš„è¡¨ç° (å½“ CUDA åç«¯ä¸å¯ç”¨æ—¶):</p><ul><li>å½“è¯·æ±‚ GPU è§£ç æ—¶ (<code>Config_Default_GPU</code>)ï¼Œæ—¥å¿—æ˜ç¡®æŒ‡å‡º <code>VideoStreamCv2Cuda not available. Using CPU...</code>ã€‚æœ€ç»ˆè§†é¢‘æµé€šè¿‡æ ‡å‡†çš„ <code>VideoStreamCv2</code> åç«¯ç”± CPU å®Œæˆè§£ç ã€‚</li><li>å°½ç®¡å¦‚æ­¤ï¼Œ<code>Config_Default_GPU</code> (229.99 ç§’) ä»ç„¶æ¯” <code>Config_Default_CPU</code> (288.24 ç§’) å¿«äº†çº¦ 58.25 ç§’ï¼Œæ€§èƒ½æå‡çº¦ 20.2%ã€‚</li><li>è¿™å¯èƒ½å½’å› äº Windows å¹³å°ä¸Š OpenCV çš„ CPU è§£ç åç«¯ï¼ˆå¦‚ Media Foundation æˆ– DirectShowï¼‰åœ¨ç‰¹å®šè·¯å¾„æˆ–é’ˆå¯¹æŸäº›è§†é¢‘æ ¼å¼æ—¶ï¼Œç›¸æ¯”çº¯ç²¹çš„ CPU è·¯å¾„æœ‰æ›´ä¼˜åŒ–çš„è¡¨ç°ï¼Œæˆ–è€…ç³»ç»Ÿèµ„æºè°ƒåº¦å·®å¼‚ã€‚</li></ul></li><li><p><code>ContentDetectorOnly_CPU</code> ä½œä¸ºæœ€å¿«é…ç½®:</p><ul><li><code>Config_ContentDetectorOnly_CPU</code> (227.18 ç§’) æ˜¯æ‰€æœ‰é…ç½®ä¸­æœ€å¿«çš„ï¼Œç¬¦åˆé¢„æœŸã€‚</li><li>å®ƒä¸ <code>Config_Default_GPU</code> (å®é™…ä¹Ÿæ˜¯ ContentDetector + CPU è§£ç ) çš„æ€§èƒ½å·®å¼‚è¾ƒå° (çº¦ 2.8 ç§’)ï¼Œå¯èƒ½åœ¨æµ‹é‡è¯¯å·®èŒƒå›´å†…ã€‚</li></ul></li><li><p>PySceneDetect åç«¯å›é€€:</p><ul><li>æ—¥å¿—æ¸…æ™°å±•ç¤ºäº†å½“ä¼˜é€‰åç«¯ï¼ˆå¦‚ CUDAï¼‰ä¸å¯ç”¨æ—¶ï¼ŒPySceneDetect å›é€€åˆ°æ ‡å‡† OpenCV (<code>VideoStreamCv2</code>) çš„è¡Œä¸ºã€‚</li></ul></li><li><p>ä¸ macOS æµ‹è¯•çš„å¯¹æ¯” (é’ˆå¯¹åŒä¸€è§†é¢‘ï¼Œä½†æ£€æµ‹å™¨é…ç½®å¯èƒ½ä¸åŒ):</p><ul><li>åœ¨ Windows ä¸Šä»…ä½¿ç”¨ <code>ContentDetector</code> (CPU) å¤„ç†æ­¤è§†é¢‘ (çº¦ 227-288 ç§’) æ¯”ä¹‹å‰åœ¨ macOS ä¸Šä½¿ç”¨ <code>MultiDetector</code> (CPU) (çº¦ 433 ç§’) è¦å¿«ã€‚å¦‚æœ macOS ä¹Ÿä»…ç”¨ <code>ContentDetector</code> (çº¦ 400 ç§’)ï¼ŒWindows ä»ç„¶æ›´å¿«ã€‚è¿™å¯èƒ½åæ˜ äº†æ“ä½œç³»ç»Ÿåº•å±‚è§†é¢‘å¤„ç†æ¡†æ¶çš„æ•ˆç‡å·®å¼‚ã€‚</li><li>åœ¨â€œè¯·æ±‚GPUä½†å›é€€åˆ°CPUâ€çš„æƒ…å†µä¸‹ï¼ŒWindows å¹³å°æ˜¾ç¤ºå‡ºç›¸å¯¹æ›´å¤§çš„æ€§èƒ½æå‡ (çº¦ 20.2%)ï¼Œè€Œ macOS å¹³å° (é’ˆå¯¹ <code>MultiDetector</code>) çº¦ä¸º 5%ã€‚</li></ul></li></ol><h5 id="å…³é”®é—®é¢˜ç‚¹ä¸åç»­è¡ŒåŠ¨å»ºè®®">å…³é”®é—®é¢˜ç‚¹ä¸åç»­è¡ŒåŠ¨å»ºè®®</h5><ol><li><p>æ ¸å®å¹¶ä¿®æ­£ <code>benchmark_scene_detector.py</code> ä¸­çš„æµ‹è¯•é…ç½®:</p><ul><li>é¦–è¦ä»»åŠ¡: ç¡®ä¿ <code>Config_Default_CPU</code> å’Œ <code>Config_Default_GPU</code> é…ç½®æ­£ç¡®åœ°ä½¿ç”¨äº†æ‚¨æœŸæœ›çš„ <code>MultiDetector</code> è®¾ç½®ï¼ˆä» <code>config.ini</code> çš„ <code>[SceneDetectorSetup]</code> åŠ è½½ï¼‰ã€‚å¦‚æœå½“å‰å®ƒä»¬è¢«é”™è¯¯åœ°æŒ‡å‘äº†ä»… <code>ContentDetector</code>ï¼Œé‚£ä¹ˆå¯¹ <code>MultiDetector</code> çš„æ€§èƒ½è¯„ä¼°æ˜¯ä¸å‡†ç¡®çš„ã€‚</li></ul></li><li><p>å½»åº•æ’æŸ¥ <code>VideoStreamCv2Cuda not available</code> é—®é¢˜:</p><ul><li>æ£€æŸ¥ OpenCV-Python ç‰ˆæœ¬ (ç¡®ä¿æ˜¯ä¸º Windows ç¼–è¯‘çš„ã€åŒ…å« CUDA æ”¯æŒçš„ç‰ˆæœ¬)ã€‚</li><li>æ£€æŸ¥ CUDA Toolkit å’Œ cuDNN çš„å®‰è£…ä¸å…¼å®¹æ€§ã€‚</li><li>æ£€æŸ¥ ç³»ç»Ÿç¯å¢ƒå˜é‡ (å¦‚ <code>PATH</code>, <code>CUDA_PATH</code>)ã€‚</li><li>æ£€æŸ¥ NVIDIA é©±åŠ¨ç¨‹åºç‰ˆæœ¬ã€‚</li><li>è¿è¡Œé¡¹ç›®ä¸­çš„ <code>cuda_available_verify.py</code> è„šæœ¬è·å–ç›´æ¥åé¦ˆã€‚</li></ul></li><li><p>åœ¨ CUDA æˆåŠŸå¯ç”¨åé‡æ–°è¿›è¡ŒåŸºå‡†æµ‹è¯•:</p><ul><li>åªæœ‰å½“ <code>VideoStreamCv2Cuda</code> èƒ½å¤ŸæˆåŠŸåŠ è½½å’Œä½¿ç”¨æ—¶ï¼Œæ‰èƒ½çœŸæ­£è¯„ä¼° GPU å¯¹è§†é¢‘è§£ç çš„åŠ é€Ÿæ•ˆæœã€‚</li><li>å±Šæ—¶ï¼Œé‡ç‚¹å¯¹æ¯” <code>MultiDetector</code> é…ç½®ä¸‹ CPU ä¸ GPU (CUDA) çš„æ€§èƒ½ã€‚</li></ul></li><li><p>åˆ†æ <code>.prof</code> æ–‡ä»¶:</p><ul><li>å¯¹äºä¿®æ­£é…ç½®åçš„ <code>MultiDetector</code> æµ‹è¯•ï¼Œä½¿ç”¨ <code>snakeviz</code> åˆ†æ <code>.prof</code> æ–‡ä»¶ã€‚</li><li>å…³æ³¨è§†é¢‘ I/O (<code>cv2.VideoCapture</code> çš„ <code>retrieve</code> å’Œ <code>grab</code> æ–¹æ³•) å’Œå„ä¸ªå­æ£€æµ‹å™¨åœ¨ CPU ä¸ GPU é…ç½®ä¸‹çš„è€—æ—¶ã€‚</li></ul></li><li><p>ç»§ç»­æµ‹è¯•å¸§é™é‡‡æ ·:</p><ul><li>æ— è®º CUDA æ˜¯å¦æˆåŠŸå¯ç”¨ï¼Œå¦‚æœè§†é¢‘ I/O ä¾ç„¶æ˜¯ä¸»è¦ç“¶é¢ˆï¼Œå¸§é™é‡‡æ · (<code>frame_skip</code> å’Œ <code>downscale_factor</code>) éƒ½æ˜¯è‡³å…³é‡è¦çš„ä¼˜åŒ–ç­–ç•¥ã€‚</li></ul></li></ol><h2 id="åç»­åˆ†æå»ºè®®">åç»­åˆ†æå»ºè®®</h2><ul><li>æ·±å…¥å‰–æ <code>.prof</code> æ–‡ä»¶: ä½¿ç”¨ <code>snakeviz</code> æˆ– <code>pstats</code> åˆ†æ <code>MultiDetector</code> é…ç½®ä¸‹å„å…·ä½“æ£€æµ‹å™¨çš„è€—æ—¶ï¼Œä»¥ç²¾ç¡®å®šä½æ€§èƒ½ç“¶é¢ˆã€‚</li><li>æµ‹è¯•å¸§é™é‡‡æ ·: é‰´äºå½“å‰å¤„ç†æ—¶é—´è¾ƒé•¿ï¼Œå¼ºçƒˆå»ºè®®æµ‹è¯•å¸§é™é‡‡æ · (<code>frame_skip</code> æˆ– <code>downscale_factor</code>) å¯¹é•¿è§†é¢‘å¤„ç†æ•ˆç‡çš„å½±å“ã€‚</li><li>å‚æ•°è°ƒä¼˜: é’ˆå¯¹ <code>MultiDetector</code> ä¸­çš„å„ä¸ªæ£€æµ‹å™¨ï¼Œç»†è‡´è°ƒæ•´å…¶å‚æ•°ï¼Œå¯»æ‰¾æ€§èƒ½ä¸å‡†ç¡®åº¦çš„æœ€ä½³å¹³è¡¡ç‚¹ã€‚</li><li>å¤šæ ·åŒ–æµ‹è¯•: ä½¿ç”¨æ›´å¤šä¸åŒç±»å‹å’Œé•¿åº¦çš„è§†é¢‘è¿›è¡Œæµ‹è¯•ï¼Œä»¥éªŒè¯å½“å‰ç»“è®ºçš„æ™®é€‚æ€§ã€‚</li></ul><h4 id="æµ‹è¯•ç»“æœå¦‚å›¾">æµ‹è¯•ç»“æœå¦‚å›¾</h4><h5 id="macOSå¹³å°æµ‹è¯•ç»“æœå›¾ç¤º">macOSå¹³å°æµ‹è¯•ç»“æœå›¾ç¤º</h5><ul><li>cpu</li></ul><p><img src="/2025/05/30/scene-detect-benchmark/cpu_prof.png" class="lazyload placeholder" data-srcset="/2025/05/30/scene-detect-benchmark/cpu_prof.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><p><img src="/2025/05/30/scene-detect-benchmark/cpu_profile_1.png" class="lazyload placeholder" data-srcset="/2025/05/30/scene-detect-benchmark/cpu_profile_1.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li>gpu</li></ul><p><img src="/2025/05/30/scene-detect-benchmark/gpu_prof.png" class="lazyload placeholder" data-srcset="/2025/05/30/scene-detect-benchmark/gpu_prof.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><p><img src="/2025/05/30/scene-detect-benchmark/gpu_prof_1.png" class="lazyload placeholder" data-srcset="/2025/05/30/scene-detect-benchmark/gpu_prof_1.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h5 id="windowå¹³å°æµ‹è¯•ç»“æœå›¾ç¤º">windowå¹³å°æµ‹è¯•ç»“æœå›¾ç¤º</h5><ul><li>cpu</li></ul><p><img src="/2025/05/30/scene-detect-benchmark/cpu_win_pro.png" class="lazyload placeholder" data-srcset="/2025/05/30/scene-detect-benchmark/cpu_win_pro.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><p><img src="/2025/05/30/scene-detect-benchmark/cpu_win_pro_1.png" class="lazyload placeholder" data-srcset="/2025/05/30/scene-detect-benchmark/cpu_win_pro_1.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li>gpu</li></ul><p><img src="/2025/05/30/scene-detect-benchmark/gpu_win_pro.png" class="lazyload placeholder" data-srcset="/2025/05/30/scene-detect-benchmark/gpu_win_pro.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><p><img src="/2025/05/30/scene-detect-benchmark/gpu_win_pro_1.png" class="lazyload placeholder" data-srcset="/2025/05/30/scene-detect-benchmark/gpu_win_pro_1.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PySceneDetect ä¸­åœºæ™¯æ£€æµ‹å™¨</title>
      <link href="/2025/05/15/scene-detect-method/"/>
      <url>/2025/05/15/scene-detect-method/</url>
      
        <content type="html"><![CDATA[<h1>PySceneDetect ä¸­åœºæ™¯æ£€æµ‹å™¨</h1><blockquote><p>ä¸»è¦åŒ…æ‹¬ï¼š<code>ContentDetector</code>, <code>ThresholdDetector</code>, <code>AdaptiveDetector</code>çš„ç®—æ³•åŠå‚æ•°å«ä¹‰ã€ç®—æ³•æ€æƒ³ä»¥åŠå¦‚ä½•ç¡®å®šè¿™äº›å‚æ•°ã€‚</p></blockquote><h2 id="é€šç”¨æ¦‚å¿µ"><strong>é€šç”¨æ¦‚å¿µ</strong></h2><ul><li><strong>åœºæ™¯ (Scene):</strong> ä¸€ç³»åˆ—è¿ç»­çš„ã€åœ¨è§†è§‰ä¸Šæˆ–å™äº‹ä¸Šæ„æˆä¸€ä¸ªå•å…ƒçš„é•œå¤´ã€‚</li><li><strong>åˆ‡ç‚¹ (Cut/Scene Break):</strong> ä¸¤ä¸ªä¸åŒåœºæ™¯ä¹‹é—´çš„è¾¹ç•Œã€‚</li><li><strong>å¸§é—´å·®å¼‚ (Frame-to-Frame Difference):</strong> æ£€æµ‹å™¨é€šå¸¸é€šè¿‡æ¯”è¾ƒè¿ç»­ï¼ˆæˆ–é—´éš”çš„ï¼‰è§†é¢‘å¸§ä¹‹é—´çš„å·®å¼‚æ¥è¯†åˆ«æ½œåœ¨çš„åˆ‡ç‚¹ã€‚å·®å¼‚çš„è®¡ç®—æ–¹å¼å› æ£€æµ‹å™¨è€Œå¼‚ã€‚</li><li><strong>é˜ˆå€¼ (Threshold):</strong> ä¸€ä¸ªé¢„è®¾çš„æ•°å€¼ã€‚å½“è®¡ç®—å‡ºçš„å¸§é—´å·®å¼‚è¶…è¿‡è¿™ä¸ªé˜ˆå€¼æ—¶ï¼Œæ£€æµ‹å™¨å°±è®¤ä¸ºå¯èƒ½å‘ç”Ÿäº†ä¸€ä¸ªåœºæ™¯åˆ‡æ¢ã€‚</li><li><strong>æœ€å°åœºæ™¯é•¿åº¦ (Min Scene Length / <code>min_scene_len</code>):</strong> æ£€æµ‹åˆ°çš„åœºæ™¯å¿…é¡»è¾¾åˆ°çš„æœ€çŸ­æŒç»­æ—¶é—´ï¼ˆé€šå¸¸ä»¥å¸§æ•°æˆ–æ—¶é—´ç è¡¨ç¤ºï¼‰ã€‚å¦‚æœä¸¤ä¸ªæ£€æµ‹åˆ°çš„åŸå§‹åˆ‡ç‚¹ä¹‹é—´çš„è·ç¦»å°äºè¿™ä¸ªå€¼ï¼Œå®ƒä»¬å¯èƒ½ä¼šè¢«åˆå¹¶ï¼Œä»¥é¿å…äº§ç”Ÿè¿‡å¤šéå¸¸çŸ­çš„ã€æ— æ„ä¹‰çš„åœºæ™¯ç‰‡æ®µã€‚<strong>ä¸ºäº†åˆ†æå’Œæ‰¾åˆ°æœ€ä½³æ£€æµ‹å‚æ•°ï¼Œæˆ‘ä»¬é€šå¸¸å°†è¿™ä¸ªå€¼è®¾ä¸º1å¸§ï¼Œä»¥è§‚å¯Ÿæ£€æµ‹å™¨æœ€åŸå§‹çš„è¾“å‡ºã€‚</strong></li></ul><hr><h2 id="ç®—æ³•æ¦‚è¿°">ç®—æ³•æ¦‚è¿°</h2><p><strong>1. <code>ThresholdDetector</code> (é˜ˆå€¼æ£€æµ‹å™¨)</strong></p><blockquote><p>ä¸»è¦æ£€æµ‹æ·¡å…¥æ·¡å‡ºåˆ°é»‘å±æˆ–ç™½å±åœºæ™¯</p></blockquote><ul><li><p><strong>å‘½ä»¤:</strong> <code>detect-threshold</code></p></li><li><p><strong>æ ¸å¿ƒæ€æƒ³:</strong> ä¸»è¦é€šè¿‡ç›‘æµ‹è§†é¢‘å¸§çš„<strong>å¹³å‡äº®åº¦/å¼ºåº¦</strong>æ˜¯å¦è·¨è¶Šä¸€ä¸ªå›ºå®šçš„é˜ˆå€¼æ¥åˆ¤æ–­æ·¡å…¥/æ·¡å‡ºäº‹ä»¶ã€‚å®ƒå‡è®¾åœºæ™¯åˆ‡æ¢ï¼ˆç‰¹åˆ«æ˜¯æ·¡å…¥æ·¡å‡ºï¼‰ä¼šä¼´éšç€ç”»é¢æ•´ä½“å˜äº®æˆ–å˜æš—åˆ°æŸä¸ªç¨‹åº¦ã€‚</p></li><li><p><strong>ä¸»è¦å‚æ•°åŠå…¶å«ä¹‰ï¼š</strong></p><ul><li><p><strong><code>threshold</code> (æˆ– <code>-t VAL</code>)</strong>:</p><ul><li><strong>å«ä¹‰:</strong> ä¸€ä¸ª 0-255 ä¹‹é—´çš„æ•´æ•°ï¼ˆæˆ–æµ®ç‚¹æ•°ï¼‰ã€‚è¿™æ˜¯åˆ¤æ–­ç”»é¢æ˜¯å¦è¿›å…¥â€œæ·¡å‡ºâ€æˆ–â€œæ·¡å…¥â€çŠ¶æ€çš„äº®åº¦åŸºå‡†ã€‚</li><li><strong>ç®—æ³•äº¤äº’:</strong> ä¸ <code>method</code> å‚æ•°é…åˆä½¿ç”¨ã€‚</li><li><strong>å¦‚ä½•ç¡®å®š:</strong><ol><li><strong>ä½¿ç”¨äº®åº¦åˆ†æå·¥å…· (å¦‚æˆ‘ä»¬ä¹‹å‰ç¼–å†™çš„ <code>analyze_brightness.py</code>)</strong>ï¼šæŸ¥çœ‹ä½ çš„è§†é¢‘åœ¨å‘ç”Ÿæ·¡å…¥æ·¡å‡ºåˆ°â€œé»‘å±â€æˆ–â€œç™½å±â€æ—¶ï¼Œé‚£äº›â€œé»‘/ç™½â€å¸§çš„å®é™…å¹³å‡äº®åº¦å€¼ã€‚</li><li>å¦‚æœä½¿ç”¨ <code>method = FLOOR</code> (æ£€æµ‹æ·¡å‡ºåˆ°æš—/ä»æš—æ·¡å…¥)ï¼š<code>threshold</code> åº”ç•¥é«˜äºè§†é¢‘ä¸­â€œé»‘å±â€çŠ¶æ€çš„å¹³å‡äº®åº¦ã€‚ä¾‹å¦‚ï¼Œå¦‚æœé»‘å±äº®åº¦åœ¨ 2-5 ä¹‹é—´ï¼Œä½ å¯ä»¥å°è¯• <code>threshold = 5</code> æˆ– <code>8</code> æˆ– <code>10</code>ã€‚å¦‚æœé˜ˆå€¼è®¾å¾—å¤ªä½ï¼ˆæ¯”å¦‚1ï¼‰ï¼Œé‚£ä¹ˆåªæœ‰å‡ ä¹çº¯é»‘çš„å¸§æ‰ä¼šè¢«è¯†åˆ«ã€‚</li><li>å¦‚æœä½¿ç”¨ <code>method = CEILING</code> (æ£€æµ‹æ·¡å‡ºåˆ°äº®/ä»äº®æ·¡å…¥)ï¼š<code>threshold</code> åº”ç•¥ä½äºè§†é¢‘ä¸­â€œç™½å±â€çŠ¶æ€çš„å¹³å‡äº®åº¦ã€‚ä¾‹å¦‚ï¼Œå¦‚æœç™½å±äº®åº¦åœ¨ 250-253 ä¹‹é—´ï¼Œä½ å¯ä»¥å°è¯• <code>threshold = 250</code> æˆ– <code>245</code>ã€‚</li><li><strong>å®éªŒæ³•ï¼š</strong> ä»ä¸€ä¸ªç›¸å¯¹å®½æ¾çš„å€¼å¼€å§‹ï¼ˆä¾‹å¦‚ï¼Œå¯¹äº FLOOR æ–¹æ³•ï¼Œä» 15-20 å¼€å§‹ï¼›å¯¹äº CEILINGï¼Œä» 230-240 å¼€å§‹ï¼‰ï¼Œç„¶åé€æ¸å‘æ›´ä¸¥æ ¼çš„å€¼è°ƒæ•´ï¼ˆFLOOR å‘ä¸‹è°ƒï¼ŒCEILING å‘ä¸Šè°ƒï¼‰ï¼ŒåŒæ—¶è§‚å¯Ÿ <code>save-images</code> çš„ç»“æœã€‚</li></ol></li></ul></li><li><p><strong><code>fade_bias</code> (æˆ– <code>-f PERCENT</code>)</strong>:</p><ul><li><strong>å«ä¹‰:</strong> ä¸€ä¸ªç™¾åˆ†æ¯”å€¼ï¼ˆå‘½ä»¤è¡Œæ˜¯ -100 åˆ° 100ï¼ŒPython ç±»å†…éƒ¨æ˜¯ -1.0 åˆ° +1.0ï¼‰ã€‚å®ƒè°ƒæ•´æ£€æµ‹åˆ°çš„æ·¡å…¥æ·¡å‡ºåˆ‡ç‚¹çš„<strong>ç²¾ç¡®ä½ç½®</strong>ã€‚</li><li><strong>ç®—æ³•äº¤äº’:</strong> å½“æ£€æµ‹å™¨è¯†åˆ«åˆ°ä¸€æ¬¡äº®åº¦ä»é˜ˆå€¼ä¸€ä¾§è·¨è¶Šåˆ°å¦ä¸€ä¾§ï¼ˆä¾‹å¦‚ï¼Œä»é«˜äºé˜ˆå€¼å˜ä¸ºä½äºé˜ˆå€¼ï¼Œå†æ¢å¤åˆ°é«˜äºé˜ˆå€¼ï¼Œè¿™æ„æˆä¸€æ¬¡æ·¡å‡ºå†æ·¡å…¥ï¼‰ï¼Œ<code>fade_bias</code> å†³å®šåˆ‡ç‚¹æ”¾åœ¨è¿™ä¸ªè¿‡ç¨‹çš„å“ªä¸ªé˜¶æ®µã€‚<ul><li>å‘½ä»¤è¡Œ <code>-100</code> (Python <code>-1.0</code>): åˆ‡ç‚¹å°½å¯èƒ½é è¿‘å®Œå…¨æ·¡å‡ºåˆ°é»‘/ç™½çš„æ—¶åˆ»ï¼Œæˆ–è€…åˆšå¼€å§‹ä»é»‘/ç™½æ¢å¤çš„æ—¶åˆ»ï¼ˆå–å†³äºå…·ä½“å®ç°å’Œæ·¡å…¥/æ·¡å‡ºæ–¹å‘ï¼‰ã€‚</li><li>å‘½ä»¤è¡Œ <code>0</code> (Python <code>0.0</code>): åˆ‡ç‚¹æ”¾åœ¨æ·¡å‡ºå’Œæ·¡å…¥è¿‡ç¨‹çš„ä¸­é—´ã€‚</li><li>å‘½ä»¤è¡Œ <code>+100</code> (Python <code>+1.0</code>): åˆ‡ç‚¹å°½å¯èƒ½é è¿‘åˆšå¼€å§‹æ·¡å‡ºæˆ–å®Œå…¨æ·¡å…¥å®Œæˆçš„æ—¶åˆ»ã€‚</li></ul></li><li><strong>å¦‚ä½•ç¡®å®š:</strong><ol><li>é€šå¸¸å¯¹äºè§†é¢‘é—´çš„åˆ‡æ¢ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨ç”»é¢å®Œå…¨å˜é»‘/ç™½ä¹‹åï¼Œæˆ–è€…åˆšå¼€å§‹æœ‰æ–°ç”»é¢æ—¶è¿›è¡Œåˆ‡å‰²ã€‚æ‰€ä»¥ä¸€ä¸ªä¸­ç­‰åˆ°è¾ƒå¤§çš„è´Ÿåç½®ï¼ˆä¾‹å¦‚å‘½ä»¤è¡Œçš„ <code>30</code> åˆ° <code>70</code>ï¼Œå¯¹åº” Python çš„ <code>(PERCENT/50.0) - 1.0</code>ï¼‰å¯èƒ½æ˜¯åˆé€‚çš„ï¼Œè¿™ä¼šä½¿åˆ‡ç‚¹æ›´å€¾å‘äºâ€œé»‘åœºâ€çš„è¾¹ç¼˜ã€‚</li><li><strong>å®éªŒæ³•ï¼š</strong> è®¾ç½®ä¸€ä¸ªåŸºç¡€çš„ <code>threshold</code>ï¼Œç„¶åå°è¯•ä¸åŒçš„ <code>fade_bias</code> å€¼ï¼ˆä¾‹å¦‚ -80, -50, 0, 50, 80ï¼‰ï¼Œè§‚å¯Ÿ <code>save-images</code> ä¸­åˆ‡ç‚¹å›¾ç‰‡çš„ä½ç½®ï¼Œçœ‹å“ªä¸ªæœ€ç¬¦åˆä½ çš„æœŸæœ›ã€‚</li></ol></li></ul></li><li><p><strong><code>method</code> (Python ç±»å‚æ•°ï¼Œ<code>ThresholdDetector.Method.FLOOR</code> æˆ– <code>ThresholdDetector.Method.CEILING</code>)</strong>:</p><ul><li><strong>å«ä¹‰:</strong> å®šä¹‰äº†å¦‚ä½•å°†å¸§çš„å¹³å‡äº®åº¦ä¸ <code>threshold</code> è¿›è¡Œæ¯”è¾ƒæ¥è§¦å‘äº‹ä»¶ã€‚<ul><li><code>FLOOR</code>: å½“å¸§äº®åº¦<strong>ä½äº (falls below)</strong> <code>threshold</code> æ—¶ï¼Œè®¤ä¸ºæ˜¯æ·¡å‡ºï¼ˆåˆ°æš—ï¼‰ï¼›å½“ä»ä½äºçŠ¶æ€æ¢å¤åˆ°<strong>é«˜äºç­‰äº</strong> <code>threshold</code> æ—¶ï¼Œè®¤ä¸ºæ˜¯æ·¡å…¥ï¼ˆä»æš—ï¼‰ã€‚</li><li><code>CEILING</code>: å½“å¸§äº®åº¦<strong>é«˜äº (rises above)</strong> <code>threshold</code> æ—¶ï¼Œè®¤ä¸ºæ˜¯æ·¡å‡ºï¼ˆåˆ°äº®ï¼‰ï¼›å½“ä»é«˜äºçŠ¶æ€æ¢å¤åˆ°<strong>ä½äº</strong> <code>threshold</code> æ—¶ï¼Œè®¤ä¸ºæ˜¯æ·¡å…¥ï¼ˆä»äº®ï¼‰ã€‚</li></ul></li><li><strong>å¦‚ä½•ç¡®å®š:</strong><ol><li>å¦‚æœä½ çš„è§†é¢‘ä¸»è¦æ˜¯æ·¡å…¥æ·¡å‡ºåˆ°<strong>é»‘è‰²</strong>ï¼Œæˆ–è€…ä»é»‘è‰²æ·¡å…¥ï¼Œé€‰æ‹© <code>FLOOR</code>ã€‚</li><li>å¦‚æœä½ çš„è§†é¢‘ä¸»è¦æ˜¯æ·¡å…¥æ·¡å‡ºåˆ°<strong>ç™½è‰²</strong>ï¼Œæˆ–è€…ä»ç™½è‰²æ·¡å…¥ï¼Œé€‰æ‹© <code>CEILING</code> (å¹¶é…åˆéå¸¸é«˜çš„ <code>threshold</code>)ã€‚</li><li>ä½ çš„ <code>config.ini</code> ä¸­ <code>method = FLOOR</code> (å› ä¸º <code>FRAME_AVERAGE</code> ä¼šå›é€€åˆ° <code>FLOOR</code>)ï¼Œæ‰€ä»¥å½“å‰æ˜¯é’ˆå¯¹æš—åœºæ™¯çš„ã€‚</li></ol></li></ul></li><li><p><strong><code>min_scene_len</code> (æˆ– <code>-m TIMECODE</code>ï¼Œå‘½ä»¤è¡Œæ˜¯ <code>-m 1</code> è¡¨ç¤º1å¸§)</strong>:</p><ul><li><strong>å«ä¹‰:</strong> æœ€å°åœºæ™¯é•¿åº¦ã€‚</li><li><strong>å¦‚ä½•ç¡®å®š:</strong> ä¸ºäº†åˆ†ææ£€æµ‹å™¨çš„åŸå§‹æ€§èƒ½å’Œæ‰¾åˆ°æœ€ä½³çš„ <code>threshold</code> / <code>fade_bias</code>ï¼Œ<strong>å§‹ç»ˆå°†å…¶è®¾ç½®ä¸º <code>1</code> (æˆ– <code>1f</code>ï¼Œæ ¹æ®å…·ä½“å‘½ä»¤æ ¼å¼)</strong>ã€‚åœ¨ç¡®å®šäº†æœ€ä½³æ£€æµ‹å‚æ•°åï¼Œå¦‚æœéœ€è¦é¿å…è¿‡å¤šçŸ­ç‰‡æ®µï¼Œå†åœ¨æœ€ç»ˆå¤„ç†æ—¶è€ƒè™‘å¢å¤§è¿™ä¸ªå€¼ã€‚</li></ul></li></ul></li></ul><hr><p><strong>2. <code>ContentDetector</code> (å†…å®¹æ£€æµ‹å™¨)</strong></p><ul><li><p><strong>å‘½ä»¤:</strong> <code>detect-content</code></p></li><li><p><strong>æ ¸å¿ƒæ€æƒ³:</strong> é€šè¿‡æ¯”è¾ƒè¿ç»­å¸§ä¹‹é—´<strong>è§†è§‰å†…å®¹çš„æ•´ä½“å·®å¼‚</strong>æ¥æ£€æµ‹åœºæ™¯åˆ‡æ¢ã€‚å®ƒä¸ä»…ä»…çœ‹äº®åº¦ï¼Œè¿˜ä¼šè€ƒè™‘é¢œè‰²åˆ†å¸ƒï¼ˆè‰²è°ƒ Hue, é¥±å’Œåº¦ Saturationï¼‰å’Œå¯èƒ½çš„è¾¹ç¼˜ä¿¡æ¯ã€‚å¯¹äºå¹³å‡äº®åº¦å˜åŒ–ä¸å¤§ä½†å†…å®¹å‘ç”Ÿæ˜¾è‘—æ”¹å˜çš„åˆ‡æ¢ï¼ˆå¦‚äº¤å‰æ·¡åŒ–ã€æŸäº›å¿«é€Ÿå‰ªè¾‘ï¼‰é€šå¸¸æ›´æœ‰æ•ˆã€‚</p></li><li><p><strong>ä¸»è¦å‚æ•°åŠå…¶å«ä¹‰ï¼š</strong></p><ul><li><p><strong><code>threshold</code> (æˆ– <code>-t VAL</code>)</strong>:</p><ul><li><strong>å«ä¹‰:</strong> ä¸€ä¸ªæµ®ç‚¹æ•°ï¼Œè¡¨ç¤ºå¸§é—´å†…å®¹å·®å¼‚çš„é˜ˆå€¼ã€‚è¿™ä¸ªå·®å¼‚å€¼æ˜¯ç»¼åˆäº†è‰²è°ƒã€é¥±å’Œåº¦ã€äº®åº¦ï¼ˆä»¥åŠå¯èƒ½æœ‰çš„è¾¹ç¼˜ï¼‰é€šé“çš„å˜åŒ–è®¡ç®—å‡ºæ¥çš„ã€‚</li><li><strong>ç®—æ³•äº¤äº’:</strong> å½“è®¡ç®—å‡ºçš„å¸§é—´å†…å®¹ç»¼åˆå·®å¼‚å€¼<strong>è¶…è¿‡</strong>æ­¤é˜ˆå€¼æ—¶ï¼Œè§¦å‘åˆ‡ç‚¹ã€‚</li><li><strong>å¦‚ä½•ç¡®å®š:</strong><ol><li><code>ContentDetector</code> çš„é˜ˆå€¼èŒƒå›´å’Œæ•æ„Ÿåº¦ä¸ <code>ThresholdDetector</code> ä¸åŒã€‚é»˜è®¤å€¼é€šå¸¸åœ¨ 20-35 ä¹‹é—´ã€‚</li><li><strong>è¾ƒä½çš„é˜ˆå€¼æ„å‘³ç€æ›´æ•æ„Ÿã€‚</strong> å¯¹äºå¹³æ»‘çš„äº¤å‰æ·¡åŒ–æˆ–ç»†å¾®çš„å†…å®¹å˜åŒ–ï¼Œä½ å¯èƒ½éœ€è¦å°†é˜ˆå€¼é™ä½åˆ° 15-25ï¼Œç”šè‡³æ›´ä½ï¼ˆ5-15ï¼‰ã€‚</li><li><strong>å®éªŒæ³•æ˜¯å…³é”®ï¼š</strong><ul><li><strong>ä½¿ç”¨ <code>threshold_explorer.py</code> å·¥å…·ï¼ˆä»£ç è§åï¼‰</strong>ï¼šè¿™æ˜¯æœ€ç³»ç»Ÿçš„æ–¹æ³•ã€‚è®¾å®šä¸€ä¸ªé˜ˆå€¼èŒƒå›´ï¼ˆä¾‹å¦‚ï¼Œä» 5.0 åˆ° 30.0ï¼Œæ­¥é•¿ 1.0 æˆ– 2.0ï¼‰ï¼Œå¯¹æŠ½æ ·è§†é¢‘è¿è¡Œã€‚</li><li><strong>è§‚å¯Ÿå›¾è¡¨ï¼š</strong> æŸ¥çœ‹â€œå¹³å‡åœºæ™¯æ•° vs. é˜ˆå€¼â€å›¾ã€‚å¯»æ‰¾æ›²çº¿çš„â€œæ‹ç‚¹â€â€”â€”å³é˜ˆå€¼å†é™ä½ï¼Œåœºæ™¯æ•°å¼€å§‹æ€¥å‰§å¢åŠ ï¼ˆå¯èƒ½å¼•å…¥å™ªå£°ï¼‰ï¼›æˆ–è€…é˜ˆå€¼å†å‡é«˜ï¼Œåœºæ™¯æ•°æ€¥å‰§å‡å°‘ï¼ˆå¯èƒ½é—æ¼åˆ‡æ¢ï¼‰çš„é‚£ä¸ªä¸´ç•ŒåŒºåŸŸã€‚</li><li><strong>ç»“åˆ <code>save-images</code>ï¼š</strong> å¯¹äºä½ åœ¨å›¾è¡¨ä¸Šæ‰¾åˆ°çš„å‡ ä¸ªæœ‰å¸Œæœ›çš„é˜ˆå€¼ç‚¹ï¼Œä½¿ç”¨ <code>--save_images_for</code> é€‰é¡¹ï¼ˆåœ¨ <code>threshold_explorer.py</code> ä¸­ï¼‰æˆ–ç›´æ¥ç”¨ <code>scenedetect</code> å‘½ä»¤è¡Œå·¥å…·ï¼ˆé…åˆ <code>save-images</code>ï¼‰æ¥å®é™…æŸ¥çœ‹è¿™äº›é˜ˆå€¼ä¸‹çš„åˆ‡ç‚¹å›¾ç‰‡ã€‚äººå·¥åˆ¤æ–­è¿™äº›åˆ‡ç‚¹æ˜¯å¦ç¬¦åˆä½ å¯¹äº¤å‰æ·¡åŒ–æˆ–å…¶ä»–åœºæ™¯åˆ‡æ¢çš„å®šä¹‰ã€‚</li></ul></li><li><strong>ä»ä¸€ä¸ªç›¸å¯¹ä¿å®ˆçš„å€¼å¼€å§‹ï¼ˆä¾‹å¦‚ 25-30ï¼‰ï¼Œå¦‚æœæ£€æµ‹ä¸åˆ°è¶³å¤Ÿçš„åœºæ™¯ï¼Œé€æ¸é™ä½é˜ˆå€¼ï¼Œå¹¶è§‚å¯Ÿç»“æœã€‚</strong></li></ol></li></ul></li><li><p><strong><code>min_scene_len</code> (æˆ– <code>-m TIMECODE</code>ï¼Œå‘½ä»¤è¡Œé€šå¸¸æ˜¯ <code>-m 1</code> è¡¨ç¤º1å¸§)</strong>:</p><ul><li><strong>å«ä¹‰:</strong> æœ€å°åœºæ™¯é•¿åº¦ã€‚</li><li><strong>å¦‚ä½•ç¡®å®š:</strong> åŒ <code>ThresholdDetector</code>ï¼Œåœ¨å‚æ•°æ¢ç´¢é˜¶æ®µï¼Œ<strong>å§‹ç»ˆå°†å…¶è®¾ç½®ä¸º <code>1</code></strong>ã€‚</li></ul></li><li><p><strong><code>weights</code> (Hue, Saturation, Luma, Edges - Python ç±»å‚æ•°)</strong>:</p><ul><li><strong>å«ä¹‰:</strong> å®šä¹‰åœ¨è®¡ç®—å¸§é—´å†…å®¹å·®å¼‚æ—¶ï¼Œè‰²è°ƒã€é¥±å’Œåº¦ã€äº®åº¦ã€è¾¹ç¼˜è¿™å‡ ä¸ªåˆ†é‡å„è‡ªæ‰€å çš„æƒé‡ã€‚</li><li><strong>ç®—æ³•äº¤äº’:</strong> å½±å“æœ€ç»ˆçš„ç»¼åˆå·®å¼‚å€¼ã€‚</li><li><strong>å¦‚ä½•ç¡®å®š:</strong><ol><li><strong>é€šå¸¸ä»é»˜è®¤æƒé‡å¼€å§‹ã€‚</strong> PySceneDetect çš„é»˜è®¤æƒé‡æ˜¯ç»è¿‡ä¸€å®šè°ƒä¼˜çš„ã€‚</li><li>å¦‚æœé»˜è®¤æƒé‡æ•ˆæœä¸ä½³ï¼Œå¹¶ä¸”ä½ å¯¹è§†é¢‘å†…å®¹çš„ç‰¹æ€§æœ‰äº†è§£ï¼š<ul><li>å¦‚æœåœºæ™¯åˆ‡æ¢ä¸»è¦ä½“ç°åœ¨<strong>é¢œè‰²</strong>å˜åŒ–ä¸Šï¼ˆä¾‹å¦‚ï¼Œä»å†·è‰²è°ƒåœºæ™¯äº¤å‰æ·¡åŒ–åˆ°æš–è‰²è°ƒåœºæ™¯ï¼‰ï¼Œå¯ä»¥å°è¯•<strong>å¢åŠ  <code>weights_hue</code> å’Œ <code>weights_saturation</code></strong> çš„æƒé‡ï¼ŒåŒæ—¶<strong>å‡å°‘ <code>weights_luma</code></strong> çš„æƒé‡ã€‚</li><li>å¦‚æœåœºæ™¯åˆ‡æ¢ä¸»è¦ä½“ç°åœ¨<strong>ç»“æ„æˆ–ç‰©ä½“è½®å»“</strong>å˜åŒ–ä¸Šï¼Œç¡®ä¿è¾¹ç¼˜æ£€æµ‹è¢«å¯ç”¨å¹¶ä¸” <code>weights_edges</code> æœ‰åˆé€‚çš„æƒé‡ã€‚</li><li>è¿™éƒ¨åˆ†è°ƒæ•´é€šå¸¸éœ€è¦æ›´å¤šçš„å®éªŒå’Œå¯¹è§†é¢‘å†…å®¹çš„ç»†è‡´åˆ†æã€‚ä½ çš„ <code>config.ini</code> å’Œ <code>scene_detector.py</code> å…è®¸ä½ è®¾ç½®è¿™äº›æƒé‡ã€‚</li></ul></li></ol></li></ul></li><li><p><strong><code>luma_only</code> (å¸ƒå°”å€¼)</strong>:</p><ul><li><strong>å«ä¹‰:</strong> å¦‚æœä¸º <code>true</code>ï¼Œåˆ™åœ¨è®¡ç®—å†…å®¹å·®å¼‚æ—¶åªè€ƒè™‘äº®åº¦é€šé“ï¼Œå¿½ç•¥è‰²è°ƒå’Œé¥±å’Œåº¦ã€‚</li><li><strong>ç®—æ³•äº¤äº’:</strong> ç›¸å½“äºå°† <code>weights_hue</code> å’Œ <code>weights_saturation</code> è®¾ä¸º 0ã€‚</li><li><strong>å¦‚ä½•ç¡®å®š:</strong><ol><li>å¯¹äºé¢œè‰²ä¿¡æ¯ä¸°å¯Œä¸”å¯¹åœºæ™¯åŒºåˆ†å¾ˆé‡è¦çš„è§†é¢‘ï¼ˆå°¤å…¶æ˜¯äº¤å‰æ·¡åŒ–ï¼‰ï¼Œé€šå¸¸åº”å°†æ­¤è®¾ä¸º <code>false</code>ï¼ˆé»˜è®¤ï¼‰ã€‚</li><li>å¦‚æœè§†é¢‘æ˜¯é»‘ç™½çš„ï¼Œæˆ–è€…é¢œè‰²ä¿¡æ¯å¹²æ‰°æ€§å¼ºä¸”ä¸é‡è¦ï¼Œå¯ä»¥è®¾ä¸º <code>true</code>ã€‚</li></ol></li></ul></li></ul></li></ul><hr><p><strong>3. <code>AdaptiveDetector</code> (è‡ªé€‚åº”æ£€æµ‹å™¨)</strong></p><ul><li><p><strong>å‘½ä»¤:</strong> <code>detect-adaptive</code></p></li><li><p><strong>æ ¸å¿ƒæ€æƒ³:</strong> ä¸ <code>ContentDetector</code> ç±»ä¼¼ï¼Œå®ƒä¹Ÿè®¡ç®—å¸§é—´å†…å®¹çš„å·®å¼‚ã€‚ä½†ä¸åŒä¹‹å¤„åœ¨äºï¼Œå®ƒä¸æ˜¯ä½¿ç”¨ä¸€ä¸ªå›ºå®šçš„å…¨å±€é˜ˆå€¼ï¼Œè€Œæ˜¯æ ¹æ®æœ€è¿‘ä¸€æ®µè§†é¢‘çª—å£å†…çš„å¸§é—´å·®å¼‚åŠ¨æ€åœ°è®¡ç®—ä¸€ä¸ªè‡ªé€‚åº”é˜ˆå€¼ã€‚å½“æŸä¸€å¸§çš„å·®å¼‚æ˜¾è‘—é«˜äºè¿™ä¸ªåŠ¨æ€è®¡ç®—å‡ºçš„å±€éƒ¨å¹³å‡å·®å¼‚æ—¶ï¼Œè§¦å‘åˆ‡ç‚¹ã€‚</p></li><li><p><strong>é€‚ç”¨åœºæ™¯:</strong> å¯¹äºè§†é¢‘æ•´ä½“äº®åº¦æˆ–å†…å®¹å˜åŒ–å¹…åº¦ä¸ä¸€è‡´çš„æƒ…å†µå¯èƒ½æœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªè§†é¢‘å¯èƒ½æœ‰äº›éƒ¨åˆ†å˜åŒ–å‰§çƒˆï¼Œæœ‰äº›éƒ¨åˆ†å˜åŒ–å¹³ç¼“ã€‚å›ºå®šé˜ˆå€¼å¯èƒ½éš¾ä»¥åŒæ—¶é€‚åº”è¿™ä¸¤ç§æƒ…å†µã€‚</p></li><li><p><strong>ä¸»è¦å‚æ•°åŠå…¶å«ä¹‰ï¼š</strong></p><ul><li><p><strong><code>adaptive_threshold</code> (æˆ– <code>-t VAL</code>)</strong>:</p><ul><li><strong>å«ä¹‰:</strong> ä¸€ä¸ªä¹˜æ•°å› å­ï¼ˆé€šå¸¸æ˜¯è¾ƒå°çš„æµ®ç‚¹æ•°ï¼Œä¾‹å¦‚ 2.0-5.0ï¼Œé»˜è®¤å¯èƒ½æ˜¯ 3.0ï¼‰ã€‚</li><li><strong>ç®—æ³•äº¤äº’:</strong> æ£€æµ‹å™¨ä¼šè®¡ç®—ä¸€ä¸ªåŸºäºæ»‘åŠ¨çª—å£çš„å¸§é—´å·®å¼‚çš„ç»Ÿè®¡é‡ï¼ˆä¾‹å¦‚å¹³å‡å€¼æˆ–ç§»åŠ¨å¹³å‡å€¼ï¼‰ã€‚å¦‚æœå½“å‰å¸§çš„å·®å¼‚è¶…è¿‡äº†è¿™ä¸ªç»Ÿè®¡é‡ä¹˜ä»¥ <code>adaptive_threshold</code>ï¼Œåˆ™è®¤ä¸ºæ˜¯ä¸€ä¸ªåˆ‡ç‚¹ã€‚å€¼è¶Šå¤§ï¼Œæ£€æµ‹è¶Šä¸æ•æ„Ÿï¼ˆéœ€è¦æ›´å¤§çš„ç›¸å¯¹å˜åŒ–ï¼‰ã€‚</li><li><strong>å¦‚ä½•ç¡®å®š:</strong><ol><li><strong>å®éªŒæ³•ï¼š</strong> ä»é»˜è®¤å€¼ï¼ˆä¾‹å¦‚ 3.0ï¼‰å¼€å§‹ã€‚</li><li>å¦‚æœæ£€æµ‹åˆ°çš„åœºæ™¯å¤ªå°‘ï¼Œå°è¯•é™ä½æ­¤å€¼ï¼ˆä¾‹å¦‚ 2.5, 2.0ï¼‰ã€‚</li><li>å¦‚æœæ£€æµ‹åˆ°çš„åœºæ™¯å¤ªå¤šï¼ˆå™ªå£°ï¼‰ï¼Œå°è¯•å¢åŠ æ­¤å€¼ï¼ˆä¾‹å¦‚ 3.5, 4.0ï¼‰ã€‚</li><li>åŒæ ·ï¼Œç»“åˆ <code>save-images</code> è¿›è¡Œäººå·¥æ£€æŸ¥ã€‚</li></ol></li></ul></li><li><p><strong><code>min_scene_len</code> (æˆ– <code>-m TIMECODE</code>)</strong>:</p><ul><li><strong>å«ä¹‰:</strong> æœ€å°åœºæ™¯é•¿åº¦ã€‚</li><li><strong>å¦‚ä½•ç¡®å®š:</strong> åŒä¸Šï¼Œå‚æ•°æ¢ç´¢é˜¶æ®µè®¾ä¸º <code>1</code>ã€‚</li></ul></li><li><p><strong><code>window_width</code> (æˆ– <code>--window_width VAL</code>, å¸§æ•°)</strong>:</p><ul><li><strong>å«ä¹‰:</strong> ç”¨äºè®¡ç®—è‡ªé€‚åº”é˜ˆå€¼çš„æ»‘åŠ¨çª—å£çš„å®½åº¦ï¼ˆä»¥å¸§ä¸ºå•ä½ï¼‰ã€‚å¦‚æœä¸º 0ï¼Œæ£€æµ‹å™¨é€šå¸¸ä¼šæ ¹æ®è§†é¢‘å¸§ç‡è‡ªåŠ¨è®¾ç½®ä¸€ä¸ªåˆç†çš„çª—å£å¤§å°ã€‚</li><li><strong>ç®—æ³•äº¤äº’:</strong> çª—å£è¶Šå¤§ï¼Œè‡ªé€‚åº”é˜ˆå€¼å¯¹å±€éƒ¨å¿«é€Ÿå˜åŒ–çš„æ•æ„Ÿåº¦è¶Šä½ï¼Œå¯¹è¾ƒé•¿æ—¶é—´çš„å¹³å‡å˜åŒ–æ›´æ•æ„Ÿã€‚çª—å£è¶Šå°ï¼Œå¯¹å±€éƒ¨çªå˜è¶Šæ•æ„Ÿã€‚</li><li><strong>å¦‚ä½•ç¡®å®š:</strong><ol><li>é€šå¸¸å¯ä»¥ä»é»˜è®¤å€¼ (0ï¼Œå³è‡ªåŠ¨) å¼€å§‹ã€‚</li><li>å¦‚æœè‡ªåŠ¨è®¾ç½®æ•ˆæœä¸ä½³ï¼Œå¯ä»¥æ ¹æ®è§†é¢‘çš„å¹³å‡é•œå¤´é•¿åº¦æˆ–å˜åŒ–èŠ‚å¥æ¥æ‰‹åŠ¨è®¾ç½®ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå¿«é€Ÿå‰ªè¾‘å¤šï¼Œå¯ä»¥å°è¯•è¾ƒå°çš„çª—å£ï¼›å¦‚æœé•¿é•œå¤´å¤šï¼Œå¯ä»¥å°è¯•è¾ƒå¤§çš„çª—å£ã€‚</li></ol></li></ul></li><li><p><strong><code>min_delta_hsv</code> (æµ®ç‚¹æ•° 0-255)</strong>:</p><ul><li><strong>å«ä¹‰:</strong> æœ‰äº›ç‰ˆæœ¬çš„ <code>AdaptiveDetector</code> å¯èƒ½ä½¿ç”¨è¿™ä¸ªå‚æ•°ã€‚å®ƒè®¾å®šäº†ä¸€ä¸ªå¸§é—´ HSVï¼ˆè‰²è°ƒã€é¥±å’Œåº¦ã€äº®åº¦ï¼‰å·®å¼‚çš„æœ€å°ç»å¯¹å€¼ã€‚å³ä½¿ç›¸å¯¹å·®å¼‚ï¼ˆé€šè¿‡ <code>adaptive_threshold</code> åˆ¤æ–­ï¼‰å¾ˆå¤§ï¼Œä½†å¦‚æœç»å¯¹å·®å¼‚æœ¬èº«éå¸¸å°ï¼ˆä¾‹å¦‚ï¼Œåœ¨å‡ ä¹å…¨é»‘çš„åœºæ™¯ä¸­å¾®å°çš„å™ªå£°å˜åŒ–ï¼‰ï¼Œä¹Ÿå¯èƒ½ä¸è¢«è§†ä¸ºåˆ‡ç‚¹ã€‚è¿™æœ‰åŠ©äºè¿‡æ»¤æ‰åœ¨éå¸¸ä½å¯¹æ¯”åº¦åŒºåŸŸçš„å™ªå£°ã€‚</li><li><strong>å¦‚ä½•ç¡®å®š:</strong><ol><li>å¦‚æœä½ çš„è§†é¢‘ä¸­æœ‰éå¸¸æš—æˆ–å¯¹æ¯”åº¦éå¸¸ä½çš„åŒºåŸŸï¼Œå¹¶ä¸” <code>AdaptiveDetector</code> åœ¨è¿™äº›åŒºåŸŸäº§ç”Ÿäº†è¯¯æŠ¥ï¼Œå¯ä»¥å°è¯•å¢åŠ æ­¤å€¼ï¼ˆä¾‹å¦‚ä»é»˜è®¤çš„ 10-15 å¢åŠ åˆ° 20-25ï¼‰ã€‚</li></ol></li></ul></li></ul></li></ul><h2 id="é€šç”¨å‚æ•°ç¡®å®šæµç¨‹ï¼š"><strong>é€šç”¨å‚æ•°ç¡®å®šæµç¨‹ï¼š</strong></h2><ol><li><p><strong>é€‰æ‹©æ£€æµ‹å™¨ç±»å‹ï¼š</strong></p><ul><li><strong>æ·¡å…¥æ·¡å‡ºåˆ°é»‘/ç™½ï¼š</strong> ä¼˜å…ˆå°è¯• <code>ThresholdDetector</code>ã€‚</li><li><strong>äº¤å‰æ·¡åŒ–ã€å†…å®¹å˜åŒ–æ˜æ˜¾ä½†äº®åº¦å˜åŒ–ä¸å¤§ï¼š</strong> ä¼˜å…ˆå°è¯• <code>ContentDetector</code>ã€‚</li><li><strong>è§†é¢‘å†…å®¹å˜åŒ–ç‰¹å¾ä¸ä¸€è‡´ï¼Œéš¾ä»¥ç”¨å›ºå®šé˜ˆå€¼æŠŠæ¡ï¼š</strong> å¯ä»¥å°è¯• <code>AdaptiveDetector</code>ã€‚</li><li><strong>ä¸ç¡®å®šæˆ–æƒ³ç»„åˆä½¿ç”¨ï¼š</strong> å¯ä»¥ä½¿ç”¨ <code>MultiDetector</code>ï¼Œå¹¶åˆ†åˆ«é…ç½®ä¸Šè¿°æ£€æµ‹å™¨ï¼ˆåœ¨ä½ çš„ <code>config.ini</code> ä¸­å°† <code>[SceneDetectorSetup]</code> çš„ <code>detector_type</code> è®¾ä¸º <code>MultiDetector</code>ï¼Œç„¶ååœ¨å„ä¸ªæ£€æµ‹å™¨çš„é…ç½®èŠ‚ä¸­è®¾ç½® <code>enabled = true</code> å’Œç›¸åº”çš„å‚æ•°ï¼‰ã€‚</li></ul></li><li><p><strong>è®¾ç½® <code>min_scene_len = 1</code>ï¼š</strong> åœ¨å¯»æ‰¾æœ€ä½³æ£€æµ‹å‚æ•°çš„é˜¶æ®µï¼Œå§‹ç»ˆè¿™æ ·åšã€‚</p></li><li><p><strong>é€‰æ‹©ä¸€ä¸ªï¼ˆæˆ–å‡ ä¸ªï¼‰ä»£è¡¨æ€§çš„æŠ½æ ·è§†é¢‘ï¼š</strong> è¿™äº›è§†é¢‘åº”è¯¥åŒ…å«ä½ æœŸæœ›æ£€æµ‹åˆ°çš„å„ç§åœºæ™¯åˆ‡æ¢æ•ˆæœã€‚</p></li><li><p><strong>å¯¹äºé€‰å®šçš„æ£€æµ‹å™¨ï¼Œç³»ç»Ÿåœ°æ‰«æå…¶ä¸»è¦é˜ˆå€¼å‚æ•°ï¼š</strong></p><ul><li><strong><code>ThresholdDetector</code></strong>: æ‰«æ <code>threshold</code> å’Œ <code>fade_bias</code>ã€‚</li><li><strong><code>ContentDetector</code></strong>: ä¸»è¦æ‰«æ <code>threshold</code>ã€‚å¯ä»¥åç»­å†è°ƒæ•´ <code>weights</code>ã€‚</li><li><strong><code>AdaptiveDetector</code></strong>: ä¸»è¦æ‰«æ <code>adaptive_threshold</code>ã€‚å¯ä»¥åç»­å†è°ƒæ•´ <code>window_width</code>ã€‚</li><li><strong>ä½¿ç”¨ä½ çš„ <code>threshold_explorer.py</code> å·¥å…·</strong> (å¦‚æœå®ƒæ˜¯é’ˆå¯¹ <code>ContentDetector</code> çš„ï¼Œä½ éœ€è¦ä¸ºå…¶ä»–æ£€æµ‹å™¨åšç±»ä¼¼çš„å‚æ•°æ‰«æé€»è¾‘ï¼Œæˆ–è€…ä¿®æ”¹å®ƒä½¿å…¶æ›´é€šç”¨)ã€‚</li></ul></li><li><p><strong>å¯è§†åŒ–å’Œäººå·¥æ£€æŸ¥ï¼š</strong></p><ul><li>æŸ¥çœ‹åœºæ™¯æ•°é‡éšé˜ˆå€¼å˜åŒ–çš„å›¾è¡¨ã€‚</li><li>å¯¹äºå‡ ä¸ªæœ‰å¸Œæœ›çš„é˜ˆå€¼è®¾ç½®ï¼Œä½¿ç”¨ <code>save-images</code> ç”Ÿæˆçš„å›¾ç‰‡è¿›è¡Œäººå·¥æ£€æŸ¥ï¼Œçœ‹åˆ‡ç‚¹æ˜¯å¦å‡†ç¡®ã€æ˜¯å¦æœ‰æ¼æ£€æˆ–è¯¯æŠ¥ã€‚</li></ul></li><li><p><strong>è¿­ä»£å’Œå¾®è°ƒï¼š</strong> æ ¹æ®å¯è§†åŒ–å’Œäººå·¥æ£€æŸ¥çš„ç»“æœï¼Œè°ƒæ•´å‚æ•°èŒƒå›´ï¼Œè¿›è¡Œæ›´ç»†è‡´çš„æ‰«æï¼Œæˆ–è€…å°è¯•è°ƒæ•´æ¬¡è¦å‚æ•°ï¼ˆå¦‚æƒé‡ã€çª—å£å®½åº¦ç­‰ï¼‰ã€‚</p></li><li><p><strong>é€‰æ‹©â€œæœ€ä½³â€å‚æ•°ï¼š</strong> â€œæœ€ä½³â€é€šå¸¸æ˜¯åœ¨â€œå¬å›ç‡â€ï¼ˆæ‰¾åˆ°æ‰€æœ‰æƒ³æ‰¾çš„åˆ‡æ¢ï¼‰å’Œâ€œç²¾ç¡®ç‡â€ï¼ˆæ‰¾åˆ°çš„åˆ‡æ¢éƒ½æ˜¯æ­£ç¡®çš„ï¼‰ä¹‹é—´çš„ä¸€ä¸ªå¹³è¡¡ã€‚è¿™å–å†³äºä½ çš„å…·ä½“éœ€æ±‚ã€‚å¯èƒ½æ²¡æœ‰ä¸€ç»„å‚æ•°å¯¹æ‰€æœ‰è§†é¢‘éƒ½å®Œç¾ï¼Œä½ å¯èƒ½éœ€è¦æ ¹æ®è§†é¢‘ç±»å‹é€‰æ‹©ä¸åŒçš„å‚æ•°é›†ï¼Œæˆ–è€…æ¥å—ä¸€å®šçš„æŠ˜è¡·ã€‚</p></li></ol><h2 id="å¯è§†åŒ–ç¡®å®šå†…å®¹æ£€æµ‹é˜ˆå€¼æ–¹æ³•">å¯è§†åŒ–ç¡®å®šå†…å®¹æ£€æµ‹é˜ˆå€¼æ–¹æ³•</h2><h3 id="å†…å®¹æ£€æµ‹å™¨é˜ˆå€¼å‚è€ƒä»£ç ">å†…å®¹æ£€æµ‹å™¨é˜ˆå€¼å‚è€ƒä»£ç </h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Tuple</span>, <span class="type">Dict</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> scenedetect <span class="keyword">import</span> open_video, SceneManager, ContentDetector, FrameTimecode, VideoStreamCv2</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">    <span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">    MATPLOTLIB_AVAILABLE = <span class="literal">True</span></span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    MATPLOTLIB_AVAILABLE = <span class="literal">False</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;è­¦å‘Š: Matplotlib æˆ– Pandas æœªå®‰è£…ï¼Œå°†æ— æ³•ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨ã€‚&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;è¯·è¿è¡Œ: pip install matplotlib pandas&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- æ—¥å¿—è®¾ç½® ---</span></span><br><span class="line">logger = logging.getLogger(<span class="string">&quot;ThresholdExplorer&quot;</span>)</span><br><span class="line">logging.basicConfig(level=logging.INFO, <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_video_files</span>(<span class="params">input_path: Path, extensions: <span class="type">List</span>[<span class="built_in">str</span>], recursive: <span class="built_in">bool</span></span>) -&gt; <span class="type">List</span>[Path]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä»æŒ‡å®šè·¯å¾„æ”¶é›†è§†é¢‘æ–‡ä»¶åˆ—è¡¨ã€‚&quot;&quot;&quot;</span></span><br><span class="line">    video_files = []</span><br><span class="line">    logger.info(<span class="string">f&quot;æ­£åœ¨æ‰«æç›®å½•: <span class="subst">&#123;input_path&#125;</span> (é€’å½’: <span class="subst">&#123;recursive&#125;</span>)ï¼Œå¯»æ‰¾æ‰©å±•å: <span class="subst">&#123;extensions&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> ext <span class="keyword">in</span> extensions:</span><br><span class="line">        pattern = <span class="string">f&quot;**/*<span class="subst">&#123;ext&#125;</span>&quot;</span> <span class="keyword">if</span> recursive <span class="keyword">else</span> <span class="string">f&quot;*<span class="subst">&#123;ext&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">for</span> file_path <span class="keyword">in</span> input_path.glob(pattern):</span><br><span class="line">            <span class="keyword">if</span> file_path.is_file() <span class="keyword">and</span> <span class="keyword">not</span> file_path.name.startswith(<span class="string">&#x27;._&#x27;</span>):</span><br><span class="line">                video_files.append(file_path)</span><br><span class="line">    logger.info(<span class="string">f&quot;åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æ‰¾åˆ° <span class="subst">&#123;<span class="built_in">len</span>(video_files)&#125;</span> ä¸ªè§†é¢‘æ–‡ä»¶ã€‚&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> video_files</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_sampled_videos</span>(<span class="params">video_list: <span class="type">List</span>[Path], sample_ratio: <span class="built_in">float</span> = -<span class="number">1.0</span>, num_samples: <span class="built_in">int</span> = -<span class="number">1</span></span>) -&gt; <span class="type">List</span>[Path]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æ ¹æ®æ¯”ä¾‹æˆ–æ•°é‡å¯¹è§†é¢‘åˆ—è¡¨è¿›è¡ŒæŠ½æ ·ã€‚&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> video_list:</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> num_samples &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> num_samples &gt;= <span class="built_in">len</span>(video_list):</span><br><span class="line">            <span class="keyword">return</span> video_list</span><br><span class="line">        <span class="keyword">return</span> random.sample(video_list, num_samples)</span><br><span class="line">    <span class="keyword">elif</span> <span class="number">0.0</span> &lt; sample_ratio &lt;= <span class="number">1.0</span>:</span><br><span class="line">        k = <span class="built_in">int</span>(<span class="built_in">len</span>(video_list) * sample_ratio)</span><br><span class="line">        <span class="keyword">if</span> k == <span class="number">0</span> <span class="keyword">and</span> <span class="built_in">len</span>(video_list) &gt; <span class="number">0</span>: k = <span class="number">1</span>  <span class="comment"># è‡³å°‘æŠ½ä¸€ä¸ªæ ·æœ¬</span></span><br><span class="line">        <span class="keyword">return</span> random.sample(video_list, k)</span><br><span class="line">    <span class="keyword">else</span>:  <span class="comment"># é»˜è®¤ä¸æŠ½æ ·ï¼Œå¤„ç†æ‰€æœ‰</span></span><br><span class="line">        <span class="keyword">return</span> video_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_detection_for_threshold</span>(<span class="params"></span></span><br><span class="line"><span class="params">        video_path: Path,</span></span><br><span class="line"><span class="params">        threshold_value: <span class="built_in">float</span>,</span></span><br><span class="line"><span class="params">        min_len: <span class="built_in">int</span> = <span class="number">1</span>,  <span class="comment"># ä¿æŒä¸º1ä»¥è·å¾—åŸå§‹åˆ‡ç‚¹</span></span></span><br><span class="line"><span class="params">        save_images_output_dir: Path = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        save_images_for_this_run: <span class="built_in">bool</span> = <span class="literal">False</span>  <span class="comment"># æ˜¯å¦ä¸ºæœ¬æ¬¡ç‰¹å®šçš„é˜ˆå€¼è¿è¡Œä¿å­˜å›¾åƒ</span></span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¯¹å•ä¸ªè§†é¢‘å’Œå•ä¸ªé˜ˆå€¼è¿è¡Œ ContentDetectorã€‚&quot;&quot;&quot;</span></span><br><span class="line">    scene_manager = SceneManager()</span><br><span class="line">    <span class="comment"># æ³¨æ„ï¼šContentDetector çš„å…¶ä»–å‚æ•°ï¼ˆå¦‚ weights, luma_onlyï¼‰è¿™é‡Œä½¿ç”¨é»˜è®¤å€¼ã€‚</span></span><br><span class="line">    <span class="comment"># å¦‚æœéœ€è¦ï¼Œä¹Ÿå¯ä»¥å°†å®ƒä»¬ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚</span></span><br><span class="line">    detector = ContentDetector(threshold=threshold_value, min_scene_len=min_len)</span><br><span class="line">    scene_manager.add_detector(detector)</span><br><span class="line"></span><br><span class="line">    video = <span class="literal">None</span></span><br><span class="line">    num_scenes = <span class="number">0</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        video = open_video(<span class="built_in">str</span>(video_path))</span><br><span class="line">        <span class="comment"># video.set_downscale_factor(1) # å¯ä»¥è€ƒè™‘é™é‡‡æ ·ä»¥åŠ é€Ÿï¼Œä½†å¯èƒ½å½±å“æ£€æµ‹ç²¾åº¦</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># è·å–æœ‰é™çš„å¸§æ•°è¿›è¡Œåˆ†æï¼Œè€Œä¸æ˜¯æ•´ä¸ªè§†é¢‘ï¼Œä»¥åŠ å¿«é€Ÿåº¦</span></span><br><span class="line">        <span class="comment"># è¿™é‡Œæˆ‘ä»¬ä»ç„¶å¤„ç†æ•´ä¸ªï¼ˆæŠ½æ ·çš„ï¼‰è§†é¢‘ï¼Œå› ä¸ºäº¤å‰æ·¡åŒ–å¯èƒ½åœ¨ä»»ä½•åœ°æ–¹</span></span><br><span class="line">        <span class="comment"># å¦‚æœè§†é¢‘éå¸¸é•¿ï¼Œå¯ä»¥è€ƒè™‘åªåˆ†æè§†é¢‘çš„ä¸€éƒ¨åˆ†ï¼Œä½†è¿™ä¼šä½¿æŠ½æ ·æ›´å¤æ‚</span></span><br><span class="line">        scene_manager.detect_scenes(video=video, show_progress=<span class="literal">False</span>)</span><br><span class="line">        scene_list = scene_manager.get_scene_list()</span><br><span class="line">        num_scenes = <span class="built_in">len</span>(scene_list)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> save_images_for_this_run <span class="keyword">and</span> save_images_output_dir <span class="keyword">and</span> scene_list:</span><br><span class="line">            <span class="keyword">from</span> scenedetect.video_splitter <span class="keyword">import</span> save_images <span class="keyword">as</span> save_images_func</span><br><span class="line">            video_images_dir = save_images_output_dir / <span class="string">f&quot;<span class="subst">&#123;video_path.stem&#125;</span>_thresh_<span class="subst">&#123;threshold_value:<span class="number">.1</span>f&#125;</span>&quot;</span></span><br><span class="line">            video_images_dir.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">            logger.info(<span class="string">f&quot;ä¸ºè§†é¢‘ <span class="subst">&#123;video_path.name&#125;</span> (é˜ˆå€¼ <span class="subst">&#123;threshold_value:<span class="number">.1</span>f&#125;</span>) ä¿å­˜åœºæ™¯å›¾ç‰‡åˆ° <span class="subst">&#123;video_images_dir&#125;</span>&quot;</span>)</span><br><span class="line">            save_images_func(</span><br><span class="line">                scene_list=scene_list,</span><br><span class="line">                video_manager=video,  <span class="comment"># open_video è¿”å›çš„æ˜¯ VideoManager æˆ–å…¶åç«¯å®ä¾‹</span></span><br><span class="line">                num_images=<span class="number">2</span>,  <span class="comment"># æ¯ä¸ªåˆ‡ç‚¹å‰åå„ä¸€å¼ </span></span><br><span class="line">                output_dir=<span class="built_in">str</span>(video_images_dir),</span><br><span class="line">                image_name_template=<span class="string">&#x27;$VIDEO_NAME-Scene-$SCENE_NUMBER-$IMAGE_NUMBER&#x27;</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;å¤„ç†è§†é¢‘ <span class="subst">&#123;video_path.name&#125;</span> (é˜ˆå€¼ <span class="subst">&#123;threshold_value&#125;</span>) æ—¶å‡ºé”™: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        num_scenes = -<span class="number">1</span>  <span class="comment"># è¡¨ç¤ºé”™è¯¯</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">if</span> video:</span><br><span class="line">            <span class="comment"># å°è¯•é€šç”¨çš„ release æ–¹æ³• (é€‚ç”¨äº VideoManager)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">hasattr</span>(video, <span class="string">&#x27;release&#x27;</span>) <span class="keyword">and</span> <span class="built_in">callable</span>(<span class="built_in">getattr</span>(video, <span class="string">&#x27;release&#x27;</span>)):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    video.release()</span><br><span class="line">                    logger.debug(<span class="string">f&quot;Released video object for <span class="subst">&#123;video_path.name&#125;</span> via .release()&quot;</span>)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e_rel:</span><br><span class="line">                    logger.warning(<span class="string">f&quot;Error calling .release() on video object for <span class="subst">&#123;video_path.name&#125;</span>: <span class="subst">&#123;e_rel&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># é’ˆå¯¹ VideoStreamCv2 (ä»¥åŠç»§æ‰¿å®ƒçš„ VideoStreamCv2Cuda) çš„ç‰¹æ®Šå¤„ç†</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(video, VideoStreamCv2):  <span class="comment"># VideoStreamCv2 æ˜¯ä» scenedetect.backends.opencv å¯¼å…¥çš„</span></span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">hasattr</span>(video, <span class="string">&#x27;_cap&#x27;</span>) <span class="keyword">and</span> video._cap <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        <span class="keyword">if</span> video._cap.isOpened():</span><br><span class="line">                            video._cap.release()</span><br><span class="line">                            logger.debug(<span class="string">f&quot;Released VideoStreamCv2._cap for <span class="subst">&#123;video_path.name&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="keyword">except</span> Exception <span class="keyword">as</span> e_cap_rel:</span><br><span class="line">                        logger.warning(<span class="string">f&quot;Error releasing VideoStreamCv2._cap for <span class="subst">&#123;video_path.name&#125;</span>: <span class="subst">&#123;e_cap_rel&#125;</span>&quot;</span>)</span><br><span class="line">         <span class="keyword">else</span>:</span><br><span class="line">                logger.warning(</span><br><span class="line">                    <span class="string">f&quot;Video object for <span class="subst">&#123;video_path.name&#125;</span> (type: <span class="subst">&#123;<span class="built_in">type</span>(video).__name__&#125;</span>) &quot;</span></span><br><span class="line">                    <span class="string">&quot;does not have a public .release() method and is not a known direct backend &quot;</span></span><br><span class="line">                    <span class="string">&quot;with a specific release pattern. Relying on __del__ for cleanup.&quot;</span></span><br><span class="line">                )</span><br><span class="line">    <span class="keyword">return</span> num_scenes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">explore_thresholds</span>(<span class="params"></span></span><br><span class="line"><span class="params">        video_paths: <span class="type">List</span>[Path],</span></span><br><span class="line"><span class="params">        threshold_range: <span class="type">Tuple</span>[<span class="built_in">float</span>, <span class="built_in">float</span>, <span class="built_in">float</span>],  <span class="comment"># (start, end, step)</span></span></span><br><span class="line"><span class="params">        sample_ratio: <span class="built_in">float</span> = -<span class="number">1.0</span>,</span></span><br><span class="line"><span class="params">        num_sample_videos: <span class="built_in">int</span> = -<span class="number">1</span>,</span></span><br><span class="line"><span class="params">        min_scene_len: <span class="built_in">int</span> = <span class="number">1</span>,</span></span><br><span class="line"><span class="params">        output_dir_base: Path = Path(<span class="params"><span class="string">&quot;threshold_exploration_output&quot;</span></span>),</span></span><br><span class="line"><span class="params">        save_images_for_thresholds: <span class="type">List</span>[<span class="built_in">float</span>] = <span class="literal">None</span>  <span class="comment"># æŒ‡å®šå“ªäº›é˜ˆå€¼éœ€è¦ä¿å­˜å›¾åƒ</span></span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    å¯¹ä¸€æ‰¹è§†é¢‘ï¼Œåœ¨ä¸€ç³»åˆ—é˜ˆå€¼ä¸‹è¿è¡Œ ContentDetectorï¼Œå¹¶è®°å½•ç»“æœã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> video_paths:</span><br><span class="line">        logger.warning(<span class="string">&quot;æ²¡æœ‰æä¾›è§†é¢‘æ–‡ä»¶è¿›è¡Œåˆ†æã€‚&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    sampled_videos = get_sampled_videos(video_paths, sample_ratio, num_sample_videos)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> sampled_videos:</span><br><span class="line">        logger.warning(<span class="string">&quot;æŠ½æ ·åæ²¡æœ‰è§†é¢‘å¯ä¾›åˆ†æã€‚&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">f&quot;å°†å¯¹ä»¥ä¸‹ <span class="subst">&#123;<span class="built_in">len</span>(sampled_videos)&#125;</span> ä¸ªæŠ½æ ·è§†é¢‘è¿›è¡Œåˆ†æ:&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> vid_path <span class="keyword">in</span> sampled_videos:</span><br><span class="line">        logger.info(<span class="string">f&quot;  - <span class="subst">&#123;vid_path.name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    start_thresh, end_thresh, step_thresh = threshold_range</span><br><span class="line">    thresholds_to_test = np.arange(start_thresh, end_thresh + step_thresh / <span class="number">2</span>, step_thresh)  <span class="comment"># +step/2 ç¡®ä¿åŒ…å« end_thresh</span></span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">f&quot;å°†æµ‹è¯•ä»¥ä¸‹é˜ˆå€¼: <span class="subst">&#123;thresholds_to_test&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ›å»ºä¸»è¾“å‡ºç›®å½•</span></span><br><span class="line">    output_dir_base.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    images_base_dir = output_dir_base / <span class="string">&quot;saved_scene_images&quot;</span></span><br><span class="line">    <span class="keyword">if</span> save_images_for_thresholds:</span><br><span class="line">        images_base_dir.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    results = []  <span class="comment"># å­˜å‚¨ (video_name, threshold, num_scenes)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> video_path <span class="keyword">in</span> sampled_videos:</span><br><span class="line">        logger.info(<span class="string">f&quot;--- å¼€å§‹å¤„ç†è§†é¢‘: <span class="subst">&#123;video_path.name&#125;</span> ---&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> threshold <span class="keyword">in</span> thresholds_to_test:</span><br><span class="line">            logger.info(<span class="string">f&quot;  æµ‹è¯•é˜ˆå€¼: <span class="subst">&#123;threshold:<span class="number">.2</span>f&#125;</span> for <span class="subst">&#123;video_path.name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            save_images_this_run = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">if</span> save_images_for_thresholds <span class="keyword">and</span> <span class="built_in">any</span>(</span><br><span class="line">                    <span class="built_in">abs</span>(threshold - t_save) &lt; <span class="number">1e-5</span> <span class="keyword">for</span> t_save <span class="keyword">in</span> save_images_for_thresholds):</span><br><span class="line">                save_images_this_run = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">            num_scenes = run_detection_for_threshold(</span><br><span class="line">                video_path,</span><br><span class="line">                threshold,</span><br><span class="line">                min_len=min_scene_len,</span><br><span class="line">                save_images_output_dir=images_base_dir <span class="keyword">if</span> save_images_this_run <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">                save_images_for_this_run=save_images_this_run</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">if</span> num_scenes != -<span class="number">1</span>:  <span class="comment"># å¦‚æœæ²¡æœ‰å‘ç”Ÿé”™è¯¯</span></span><br><span class="line">                results.append(&#123;</span><br><span class="line">                    <span class="string">&quot;video_name&quot;</span>: video_path.name,</span><br><span class="line">                    <span class="string">&quot;threshold&quot;</span>: threshold,</span><br><span class="line">                    <span class="string">&quot;num_scenes&quot;</span>: num_scenes</span><br><span class="line">                &#125;)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                logger.warning(<span class="string">f&quot;è·³è¿‡è®°å½•è§†é¢‘ <span class="subst">&#123;video_path.name&#125;</span> åœ¨é˜ˆå€¼ <span class="subst">&#123;threshold:<span class="number">.2</span>f&#125;</span> çš„ç»“æœï¼Œå› ä¸ºæ£€æµ‹å‡ºé”™ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> results:</span><br><span class="line">        logger.warning(<span class="string">&quot;æ²¡æœ‰æ”¶é›†åˆ°ä»»ä½•æœ‰æ•ˆçš„æ£€æµ‹ç»“æœã€‚&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    results_df = pd.DataFrame(results) <span class="keyword">if</span> MATPLOTLIB_AVAILABLE <span class="keyword">and</span> pd <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¿å­˜åŸå§‹æ•°æ®åˆ° CSV</span></span><br><span class="line">    csv_output_path = output_dir_base / <span class="string">&quot;threshold_scan_results.csv&quot;</span></span><br><span class="line">    <span class="keyword">if</span> results_df <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            results_df.to_csv(csv_output_path, index=<span class="literal">False</span>)</span><br><span class="line">            logger.info(<span class="string">f&quot;è¯¦ç»†æ‰«æç»“æœå·²ä¿å­˜åˆ°: <span class="subst">&#123;csv_output_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;æ— æ³•ä¿å­˜æ‰«æç»“æœåˆ° CSV: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:  <span class="comment"># å¦‚æœ pandas ä¸å¯ç”¨ï¼Œå°è¯•æ‰‹åŠ¨ä¿å­˜</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(csv_output_path, <span class="string">&#x27;w&#x27;</span>, newline=<span class="string">&#x27;&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                writer = csv.writer(f)</span><br><span class="line">                writer.writerow([<span class="string">&#x27;video_name&#x27;</span>, <span class="string">&#x27;threshold&#x27;</span>, <span class="string">&#x27;num_scenes&#x27;</span>])</span><br><span class="line">                <span class="keyword">for</span> res_dict <span class="keyword">in</span> results:</span><br><span class="line">                    writer.writerow([res_dict[<span class="string">&#x27;video_name&#x27;</span>], res_dict[<span class="string">&#x27;threshold&#x27;</span>], res_dict[<span class="string">&#x27;num_scenes&#x27;</span>]])</span><br><span class="line">            logger.info(<span class="string">f&quot;è¯¦ç»†æ‰«æç»“æœå·²ä¿å­˜åˆ°: <span class="subst">&#123;csv_output_path&#125;</span> (æ‰‹åŠ¨ä¿å­˜)&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;æ— æ³•æ‰‹åŠ¨ä¿å­˜æ‰«æç»“æœåˆ° CSV: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¯è§†åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> MATPLOTLIB_AVAILABLE <span class="keyword">and</span> results_df <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># å›¾1: æ¯ä¸ªè§†é¢‘çš„åœºæ™¯æ•° vs é˜ˆå€¼</span></span><br><span class="line">            plt.figure(figsize=(<span class="number">12</span>, <span class="number">7</span>))</span><br><span class="line">            <span class="keyword">for</span> video_name, group <span class="keyword">in</span> results_df.groupby(<span class="string">&quot;video_name&quot;</span>):</span><br><span class="line">                plt.plot(group[<span class="string">&quot;threshold&quot;</span>], group[<span class="string">&quot;num_scenes&quot;</span>], marker=<span class="string">&#x27;o&#x27;</span>, linestyle=<span class="string">&#x27;-&#x27;</span>, label=video_name)</span><br><span class="line">            plt.xlabel(<span class="string">&quot;ContentDetector Threshold&quot;</span>)</span><br><span class="line">            plt.ylabel(<span class="string">&quot;Number of Detected Scenes&quot;</span>)</span><br><span class="line">            plt.title(<span class="string">&quot;Number of Scenes vs. Threshold (Per Video)&quot;</span>)</span><br><span class="line">            plt.legend(bbox_to_anchor=(<span class="number">1.05</span>, <span class="number">1</span>), loc=<span class="string">&#x27;upper left&#x27;</span>, borderaxespad=<span class="number">0.</span>)</span><br><span class="line">            plt.grid(<span class="literal">True</span>)</span><br><span class="line">            plt.tight_layout(rect=[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.85</span>, <span class="number">1</span>])  <span class="comment"># ç»™ legend ç•™ç©ºé—´</span></span><br><span class="line">            plot_path1 = output_dir_base / <span class="string">&quot;scenes_vs_threshold_per_video.png&quot;</span></span><br><span class="line">            plt.savefig(plot_path1)</span><br><span class="line">            logger.info(<span class="string">f&quot;æ¯ä¸ªè§†é¢‘çš„åœºæ™¯æ•°-é˜ˆå€¼å›¾å·²ä¿å­˜åˆ°: <span class="subst">&#123;plot_path1&#125;</span>&quot;</span>)</span><br><span class="line">            plt.close()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># å›¾2: å¹³å‡åœºæ™¯æ•° vs é˜ˆå€¼</span></span><br><span class="line">            avg_scenes_df = results_df.groupby(<span class="string">&quot;threshold&quot;</span>)[<span class="string">&quot;num_scenes&quot;</span>].mean().reset_index()</span><br><span class="line">            plt.figure(figsize=(<span class="number">10</span>, <span class="number">6</span>))</span><br><span class="line">            plt.plot(avg_scenes_df[<span class="string">&quot;threshold&quot;</span>], avg_scenes_df[<span class="string">&quot;num_scenes&quot;</span>], marker=<span class="string">&#x27;o&#x27;</span>, linestyle=<span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">            plt.xlabel(<span class="string">&quot;ContentDetector Threshold&quot;</span>)</span><br><span class="line">            plt.ylabel(<span class="string">&quot;Average Number of Detected Scenes&quot;</span>)</span><br><span class="line">            plt.title(<span class="string">&quot;Average Number of Scenes vs. Threshold (Across Sampled Videos)&quot;</span>)</span><br><span class="line">            plt.grid(<span class="literal">True</span>)</span><br><span class="line">            plot_path2 = output_dir_base / <span class="string">&quot;avg_scenes_vs_threshold.png&quot;</span></span><br><span class="line">            plt.savefig(plot_path2)</span><br><span class="line">            logger.info(<span class="string">f&quot;å¹³å‡åœºæ™¯æ•°-é˜ˆå€¼å›¾å·²ä¿å­˜åˆ°: <span class="subst">&#123;plot_path2&#125;</span>&quot;</span>)</span><br><span class="line">            plt.close()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;ç”Ÿæˆå›¾è¡¨æ—¶å‡ºé”™: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æå‡ºå»ºè®®ï¼ˆåŸºäºå¯å‘å¼ï¼Œç”¨æˆ·ä»éœ€åˆ¤æ–­ï¼‰</span></span><br><span class="line">    logger.info(<span class="string">&quot;--- é˜ˆå€¼é€‰æ‹©å»ºè®® ---&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> results_df <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># å¯å‘å¼ï¼šå¯»æ‰¾åœºæ™¯æ•°å¼€å§‹æ€¥å‰§ä¸‹é™ç„¶åè¶‹äºå¹³ç¼“çš„â€œæ‹ç‚¹â€</span></span><br><span class="line">        <span class="comment"># æˆ–è€…åœºæ™¯æ•°åœ¨ä¸€ä¸ªå°èŒƒå›´å†…æ³¢åŠ¨ä½†ç›¸å¯¹ç¨³å®šçš„åŒºåŸŸ</span></span><br><span class="line">        avg_scenes_series = results_df.groupby(<span class="string">&quot;threshold&quot;</span>)[<span class="string">&quot;num_scenes&quot;</span>].mean()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> avg_scenes_series.empty:</span><br><span class="line">            logger.info(<span class="string">&quot;è¯·æŸ¥çœ‹ &#x27;avg_scenes_vs_threshold.png&#x27; å›¾è¡¨ã€‚&quot;</span>)</span><br><span class="line">            logger.info(<span class="string">&quot;ç†æƒ³çš„é˜ˆå€¼é€šå¸¸ä½äºä»¥ä¸‹åŒºåŸŸï¼š&quot;</span>)</span><br><span class="line">            logger.info(<span class="string">&quot;  - åœºæ™¯æ•°é‡å¼€å§‹æ˜¾è‘—å‡å°‘ä¹‹å‰çš„ç‚¹ï¼ˆå¦‚æœä½ æƒ³æ•æ‰æ›´å¤šç»†èŠ‚ï¼‰ã€‚&quot;</span>)</span><br><span class="line">            logger.info(<span class="string">&quot;  - åœºæ™¯æ•°é‡è¶‹äºç¨³å®šï¼Œä¸å†éšé˜ˆå€¼å¢åŠ è€Œå¤§å¹…å‡å°‘çš„ç‚¹ï¼ˆå¦‚æœä½ æƒ³æ›´é²æ£’ï¼Œå‡å°‘è¯¯æŠ¥ï¼‰ã€‚&quot;</span>)</span><br><span class="line">            logger.info(<span class="string">&quot;  - é¿å…é˜ˆå€¼è¿‡ä½å¯¼è‡´åœºæ™¯æ•°è¿‡å¤šï¼ˆå¯èƒ½æ˜¯å™ªå£°æˆ–å¾®å°å˜åŒ–ï¼‰ã€‚&quot;</span>)</span><br><span class="line">            logger.info(<span class="string">&quot;  - é¿å…é˜ˆå€¼è¿‡é«˜å¯¼è‡´åœºæ™¯æ•°è¿‡å°‘ï¼ˆå¯èƒ½é—æ¼çœŸå®åˆ‡æ¢ï¼‰ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># å°è¯•æ‰¾åˆ°ä¸€ä¸ªâ€œæ‹ç‚¹â€çš„ç®€å•å¯å‘å¼</span></span><br><span class="line">            <span class="comment"># è®¡ç®—äºŒé˜¶å·®åˆ†ï¼Œå¯»æ‰¾å˜åŒ–æœ€å¤§çš„åœ°æ–¹ï¼Œä½†è¿™å¯èƒ½ä¸ç¨³å®š</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                diff1 = avg_scenes_series.diff().fillna(<span class="number">0</span>)</span><br><span class="line">                diff2 = diff1.diff().fillna(<span class="number">0</span>)</span><br><span class="line">                <span class="comment"># å¯»æ‰¾ diff2 ç»å¯¹å€¼æœ€å¤§çš„å‡ ä¸ªç‚¹ï¼Œæˆ–è€…ç¬¬ä¸€ä¸ªæ˜¾è‘—çš„æ­£å€¼ï¼ˆè¡¨ç¤ºä¸‹é™è¶‹åŠ¿å‡ç¼“ï¼‰</span></span><br><span class="line">                <span class="comment"># è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€åŒ–çš„æ–¹æ³•ï¼Œå®é™…æ•ˆæœå¯èƒ½æœ‰é™</span></span><br><span class="line">                potential_elbow_threshold = diff2.<span class="built_in">abs</span>().nlargest(<span class="number">3</span>).index.tolist()</span><br><span class="line">                <span class="keyword">if</span> potential_elbow_threshold:</span><br><span class="line">                    logger.info(</span><br><span class="line">                        <span class="string">f&quot;  æ ¹æ®ç®€å•çš„å˜åŒ–ç‡åˆ†æï¼Œå¯ä»¥å…³æ³¨ä»¥ä¸‹é˜ˆå€¼é™„è¿‘çš„è¡¨ç°ï¼š<span class="subst">&#123;<span class="built_in">sorted</span>(potential_elbow_threshold)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception:</span><br><span class="line">                <span class="keyword">pass</span>  <span class="comment"># å¯å‘å¼å¤±è´¥ï¼Œä¸å½±å“ä¸»è¦åŠŸèƒ½</span></span><br><span class="line"></span><br><span class="line">            logger.info(<span class="string">&quot;ç»“åˆ &#x27;saved_scene_images&#x27; (å¦‚æœç”Ÿæˆäº†) ä¸­çš„å®é™…åœºæ™¯å›¾ç‰‡è¿›è¡Œäººå·¥åˆ¤æ–­ã€‚&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logger.warning(<span class="string">&quot;æœªèƒ½è®¡ç®—å¹³å‡åœºæ™¯æ•°ï¼Œæ— æ³•æä¾›åŸºäºå›¾è¡¨çš„å»ºè®®ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">f&quot;è¯·æ£€æŸ¥è¾“å‡ºç›®å½• &#x27;<span class="subst">&#123;output_dir_base&#125;</span>&#x27; ä¸­çš„ç»“æœã€‚&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> results_df</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(</span><br><span class="line">        description=<span class="string">&quot;ä¸ºä¸€æ‰¹è§†é¢‘æ¢ç´¢ ContentDetector çš„æœ€ä½³é˜ˆå€¼ã€‚&quot;</span>,</span><br><span class="line">        formatter_class=argparse.ArgumentDefaultsHelpFormatter</span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(<span class="string">&quot;input_source&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;åŒ…å«è§†é¢‘æ–‡ä»¶çš„ç›®å½•è·¯å¾„ï¼Œæˆ–å•ä¸ªè§†é¢‘æ–‡ä»¶è·¯å¾„ã€‚&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-e&quot;</span>, <span class="string">&quot;--extensions&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&quot;.mp4,.mkv,.mov,.avi&quot;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;é€—å·åˆ†éš”çš„è§†é¢‘æ–‡ä»¶æ‰©å±•å (ä¾‹å¦‚: .mp4,.mov)ã€‚&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-r&quot;</span>, <span class="string">&quot;--recursive&quot;</span>, action=<span class="string">&quot;store_true&quot;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;å¦‚æœ input_source æ˜¯ç›®å½•ï¼Œåˆ™é€’å½’æ‰«æå­ç›®å½•ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æŠ½æ ·å‚æ•°</span></span><br><span class="line">    sample_group = parser.add_mutually_exclusive_group()</span><br><span class="line">    sample_group.add_argument(<span class="string">&quot;--sample_ratio&quot;</span>, <span class="built_in">type</span>=<span class="built_in">float</span>, default=-<span class="number">1.0</span>,</span><br><span class="line">                              <span class="built_in">help</span>=<span class="string">&quot;è¦å¤„ç†çš„è§†é¢‘å æ€»æ•°çš„æ¯”ä¾‹ (0.0 åˆ° 1.0)ã€‚ä¾‹å¦‚ 0.1 è¡¨ç¤º 10%%ã€‚é»˜è®¤ä¸º-1.0 (å¤„ç†æ‰€æœ‰)ã€‚&quot;</span>)</span><br><span class="line">    sample_group.add_argument(<span class="string">&quot;--num_sample_videos&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=-<span class="number">1</span>,</span><br><span class="line">                              <span class="built_in">help</span>=<span class="string">&quot;è¦éšæœºæŠ½å–çš„è§†é¢‘æ•°é‡ã€‚é»˜è®¤ä¸º-1 (å¤„ç†æ‰€æœ‰æˆ–æŒ‰æ¯”ä¾‹)ã€‚å¦‚æœæŒ‡å®šï¼Œåˆ™ä¼˜å…ˆäº sample_ratioã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ContentDetector å‚æ•°</span></span><br><span class="line">    parser.add_argument(<span class="string">&quot;--threshold_start&quot;</span>, <span class="built_in">type</span>=<span class="built_in">float</span>, default=<span class="number">15.0</span>, <span class="built_in">help</span>=<span class="string">&quot;æµ‹è¯•çš„ ContentDetector é˜ˆå€¼èµ·å§‹å€¼ã€‚&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--threshold_end&quot;</span>, <span class="built_in">type</span>=<span class="built_in">float</span>, default=<span class="number">35.0</span>, <span class="built_in">help</span>=<span class="string">&quot;æµ‹è¯•çš„ ContentDetector é˜ˆå€¼ç»“æŸå€¼ã€‚&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--threshold_step&quot;</span>, <span class="built_in">type</span>=<span class="built_in">float</span>, default=<span class="number">1.0</span>, <span class="built_in">help</span>=<span class="string">&quot;æµ‹è¯•çš„ ContentDetector é˜ˆå€¼æ­¥é•¿ã€‚&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--min_len&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">1</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;ä¼ é€’ç»™ ContentDetector çš„ min_scene_len å‚æ•° (å¸§æ•°)ã€‚å»ºè®®ä¿æŒä¸º1ä»¥åˆ†æåŸå§‹åˆ‡ç‚¹ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¾“å‡ºå’Œå¯è§†åŒ–</span></span><br><span class="line">    parser.add_argument(<span class="string">&quot;-o&quot;</span>, <span class="string">&quot;--output_dir&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&quot;threshold_exploration_output&quot;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;ä¿å­˜ç»“æœ (CSV, å›¾è¡¨, å›¾ç‰‡) çš„ä¸»è¾“å‡ºç›®å½•ã€‚&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--save_images_for&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="literal">None</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;é€—å·åˆ†éš”çš„é˜ˆå€¼åˆ—è¡¨ï¼Œå°†ä¸ºè¿™äº›é˜ˆå€¼ä¸‹çš„æ£€æµ‹ç»“æœä¿å­˜åœºæ™¯å›¾ç‰‡ã€‚ä¾‹å¦‚ &#x27;15.0,20.0,25.0&#x27;ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) == <span class="number">1</span>:</span><br><span class="line">        parser.print_help(sys.stderr)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    input_path_obj = Path(args.input_source)</span><br><span class="line">    video_files_to_scan = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> input_path_obj.is_dir():</span><br><span class="line">        ext_list = [e.strip().lower() <span class="keyword">for</span> e <span class="keyword">in</span> args.extensions.split(<span class="string">&#x27;,&#x27;</span>) <span class="keyword">if</span> e.strip()]</span><br><span class="line">        video_files_to_scan = get_video_files(input_path_obj, ext_list, args.recursive)</span><br><span class="line">    <span class="keyword">elif</span> input_path_obj.is_file():</span><br><span class="line">        video_files_to_scan.append(input_path_obj)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.error(<span class="string">f&quot;è¾“å…¥è·¯å¾„ &#x27;<span class="subst">&#123;args.input_source&#125;</span>&#x27; ä¸æ˜¯æœ‰æ•ˆçš„æ–‡ä»¶æˆ–ç›®å½•ã€‚&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> video_files_to_scan:</span><br><span class="line">        logger.info(<span class="string">&quot;åœ¨æŒ‡å®šè·¯å¾„ä¸‹æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è§†é¢‘æ–‡ä»¶ã€‚&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    threshold_r = (args.threshold_start, args.threshold_end, args.threshold_step)</span><br><span class="line">    output_dir_base_path = Path(args.output_dir)</span><br><span class="line"></span><br><span class="line">    save_thresholds_for_images = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> args.save_images_for:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            save_thresholds_for_images = [<span class="built_in">float</span>(t.strip()) <span class="keyword">for</span> t <span class="keyword">in</span> args.save_images_for.split(<span class="string">&#x27;,&#x27;</span>)]</span><br><span class="line">        <span class="keyword">except</span> ValueError:</span><br><span class="line">            logger.error(<span class="string">&quot;`--save_images_for` å‚æ•°ä¸­çš„é˜ˆå€¼åˆ—è¡¨æ ¼å¼é”™è¯¯ã€‚åº”ä¸ºé€—å·åˆ†éš”çš„æ•°å­—ã€‚&quot;</span>)</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    explore_thresholds(</span><br><span class="line">        video_files_to_scan,</span><br><span class="line">        threshold_r,</span><br><span class="line">        sample_ratio=args.sample_ratio,</span><br><span class="line">        num_sample_videos=args.num_sample_videos,</span><br><span class="line">        min_scene_len=args.min_len,</span><br><span class="line">        output_dir_base=output_dir_base_path,</span><br><span class="line">        save_images_for_thresholds=save_thresholds_for_images</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">&quot;é˜ˆå€¼æ¢ç´¢å®Œæˆã€‚&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="äº®åº¦å‚æ•°é€‰å®šæ–¹æ³•å‚è€ƒä»£ç ">äº®åº¦å‚æ•°é€‰å®šæ–¹æ³•å‚è€ƒä»£ç </h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_average_brightness</span>(<span class="params">frame_bgr</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è®¡ç®— BGR å¸§çš„å¹³å‡äº®åº¦ã€‚</span></span><br><span class="line"><span class="string">    ä¸€ç§å¸¸è§çš„æ–¹æ³•æ˜¯å…ˆè½¬æ¢ä¸ºç°åº¦å›¾ï¼Œç„¶åè®¡ç®—å¹³å‡åƒç´ å€¼ã€‚</span></span><br><span class="line"><span class="string">    å¦ä¸€ç§æ˜¯ç›´æ¥è®¡ç®— BGR å„é€šé“çš„å¹³å‡å€¼ï¼Œç„¶åå†å–å¹³å‡ï¼Œæˆ–è€…ä½¿ç”¨åŠ æƒå¹³å‡ï¼ˆå¦‚äº®åº¦å…¬å¼ Y = 0.299R + 0.587G + 0.114Bï¼‰ã€‚</span></span><br><span class="line"><span class="string">    è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨è½¬æ¢ä¸ºç°åº¦å›¾çš„æ–¹æ³•ï¼Œå› ä¸ºå®ƒç›´æ¥åæ˜ äº†äººçœ¼æ„ŸçŸ¥çš„äº®åº¦ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    gray_frame = cv2.cvtColor(frame_bgr, cv2.COLOR_BGR2GRAY)</span><br><span class="line">    average_brightness = np.mean(gray_frame)</span><br><span class="line">    <span class="keyword">return</span> average_brightness</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">analyze_video_brightness</span>(<span class="params">video_path: <span class="built_in">str</span>, output_csv_path: <span class="built_in">str</span> = <span class="literal">None</span>, frame_skip: <span class="built_in">int</span> = <span class="number">0</span>, max_frames: <span class="built_in">int</span> = <span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    é€å¸§åˆ†æè§†é¢‘çš„å¹³å‡äº®åº¦ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    å‚æ•°:</span></span><br><span class="line"><span class="string">        video_path (str): è§†é¢‘æ–‡ä»¶è·¯å¾„ã€‚</span></span><br><span class="line"><span class="string">        output_csv_path (str, optional): CSVæ–‡ä»¶è¾“å‡ºè·¯å¾„ã€‚å¦‚æœæä¾›ï¼Œåˆ™å°†ç»“æœä¿å­˜åˆ°æ­¤æ–‡ä»¶ã€‚</span></span><br><span class="line"><span class="string">        frame_skip (int, optional): æ¯éš”å¤šå°‘å¸§åˆ†æä¸€æ¬¡ï¼ˆ0 è¡¨ç¤ºé€å¸§åˆ†æï¼‰ã€‚</span></span><br><span class="line"><span class="string">        max_frames (int, optional): æœ€å¤šåˆ†æå¤šå°‘å¸§ã€‚å¦‚æœä¸º Noneï¼Œåˆ™åˆ†ææ•´ä¸ªè§†é¢‘ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> Path(video_path).exists():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;é”™è¯¯: è§†é¢‘æ–‡ä»¶æœªæ‰¾åˆ°: <span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    cap = cv2.VideoCapture(video_path)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cap.isOpened():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;é”™è¯¯: æ— æ³•æ‰“å¼€è§†é¢‘æ–‡ä»¶: <span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    total_frames_video = <span class="built_in">int</span>(cap.get(cv2.CAP_PROP_FRAME_COUNT))</span><br><span class="line">    fps = cap.get(cv2.CAP_PROP_FPS)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;è§†é¢‘ä¿¡æ¯: <span class="subst">&#123;Path(video_path).name&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  æ€»å¸§æ•°: <span class="subst">&#123;total_frames_video&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  FPS: <span class="subst">&#123;fps:<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;å¸§å·\tå¹³å‡äº®åº¦&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line">    csv_data = []</span><br><span class="line">    frame_count = <span class="number">0</span></span><br><span class="line">    processed_frame_num = <span class="number">0</span>  <span class="comment"># å®é™…å¤„ç†çš„å¸§çš„è®¡æ•°å™¨ï¼Œç”¨äº max_frames</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        ret, frame = cap.read()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ret:</span><br><span class="line">            <span class="keyword">break</span>  <span class="comment"># è§†é¢‘ç»“æŸæˆ–è¯»å–é”™è¯¯</span></span><br><span class="line"></span><br><span class="line">        current_frame_num_video = <span class="built_in">int</span>(</span><br><span class="line">            cap.get(cv2.CAP_PROP_POS_FRAMES))  <span class="comment"># è·å–å½“å‰å¸§åœ¨è§†é¢‘ä¸­çš„å®é™…ç¼–å· (1-based for some backends, 0-based for others)</span></span><br><span class="line">        <span class="comment"># æˆ–è€…ç›´æ¥ç”¨ frame_count ä½œä¸º0-basedçš„å¸§å·</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> frame_count % (frame_skip + <span class="number">1</span>) == <span class="number">0</span>:  <span class="comment"># frame_skip=0 è¡¨ç¤ºæ¯å¸§éƒ½å¤„ç†</span></span><br><span class="line">            avg_brightness = calculate_average_brightness(frame)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;frame_count&#125;</span>\t<span class="subst">&#123;avg_brightness:<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> output_csv_path:</span><br><span class="line">                csv_data.append([frame_count, avg_brightness])</span><br><span class="line"></span><br><span class="line">            processed_frame_num += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> max_frames <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> processed_frame_num &gt;= max_frames:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;\nå·²è¾¾åˆ°æœ€å¤§åˆ†æå¸§æ•°é™åˆ¶: <span class="subst">&#123;max_frames&#125;</span> å¸§ã€‚&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        frame_count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    cap.release()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;åˆ†æå®Œæˆã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> output_csv_path <span class="keyword">and</span> csv_data:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            output_file = Path(output_csv_path)</span><br><span class="line">            output_file.parent.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)  <span class="comment"># åˆ›å»ºè¾“å‡ºç›®å½•</span></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(output_file, <span class="string">&#x27;w&#x27;</span>, newline=<span class="string">&#x27;&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                <span class="keyword">import</span> csv</span><br><span class="line">                writer = csv.writer(f)</span><br><span class="line">                writer.writerow([<span class="string">&#x27;FrameNumber&#x27;</span>, <span class="string">&#x27;AverageBrightness&#x27;</span>])  <span class="comment"># å†™å…¥è¡¨å¤´</span></span><br><span class="line">                writer.writerows(csv_data)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;äº®åº¦æ•°æ®å·²ä¿å­˜åˆ°: <span class="subst">&#123;output_file&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;é”™è¯¯: æ— æ³•ä¿å­˜ CSV æ–‡ä»¶åˆ° <span class="subst">&#123;output_csv_path&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&quot;åˆ†æè§†é¢‘æ¯å¸§çš„å¹³å‡äº®åº¦ã€‚&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;video_path&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;è¦åˆ†æçš„è§†é¢‘æ–‡ä»¶è·¯å¾„ã€‚&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-o&quot;</span>, <span class="string">&quot;--output_csv&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="literal">None</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;å¯é€‰ï¼šå°†ç»“æœä¿å­˜åˆ°çš„ CSV æ–‡ä»¶è·¯å¾„ã€‚ä¾‹å¦‚ï¼šbrightness_data.csv&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-s&quot;</span>, <span class="string">&quot;--frame_skip&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">0</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;å¯é€‰ï¼šæ¯éš”å¤šå°‘å¸§åˆ†æä¸€æ¬¡ï¼ˆ0 è¡¨ç¤ºé€å¸§åˆ†æï¼Œ1 è¡¨ç¤ºéš”1å¸§åˆ†æ1å¸§ï¼Œå³å¤„ç†ç¬¬0,2,4...å¸§ï¼‰ã€‚é»˜è®¤ä¸º0ã€‚&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-m&quot;</span>, <span class="string">&quot;--max_frames&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="literal">None</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;å¯é€‰ï¼šæœ€å¤šåˆ†æçš„å¸§æ•°ã€‚ç”¨äºå¿«é€Ÿé¢„è§ˆé•¿è§†é¢‘ã€‚é»˜è®¤ä¸ºåˆ†ææ•´ä¸ªè§†é¢‘ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) == <span class="number">1</span>:  <span class="comment"># å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œæ‰“å°å¸®åŠ©ä¿¡æ¯å¹¶é€€å‡º</span></span><br><span class="line">        parser.print_help(sys.stderr)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    analyze_video_brightness(args.video_path, args.output_csv, args.frame_skip, args.max_frames)</span><br></pre></td></tr></table></figure><h2 id="é˜ˆå€¼é€‰æ‹©æ–¹æ³•">é˜ˆå€¼é€‰æ‹©æ–¹æ³•</h2><blockquote><p>æŸ¥çœ‹ avg_scenes_vs_threshold.png å›¾ã€‚é€šå¸¸ï¼Œä½ ä¼šå¯»æ‰¾ä¸€ä¸ªç‚¹ï¼Œåœ¨è¯¥ç‚¹ä¹‹åï¼Œè¿›ä¸€æ­¥é™ä½é˜ˆå€¼ä¼šå¯¼è‡´åœºæ™¯æ•°é‡æ€¥å‰§å¢åŠ ï¼ˆå¯èƒ½å¼•å…¥è¿‡å¤šå™ªå£°æˆ–éæœŸæœ›çš„åˆ‡ç‚¹ï¼‰ï¼Œæˆ–è€…åœ¨è¯¥ç‚¹ä¹‹å‰ï¼Œæé«˜é˜ˆå€¼ä¼šå¯¼è‡´åœºæ™¯æ•°é‡æ€¥å‰§å‡å°‘ï¼ˆå¯èƒ½é—æ¼çœŸå®åˆ‡ç‚¹ï¼‰ã€‚ä¸€ä¸ªâ€œå¹³ç¨³â€çš„åŒºåŸŸæˆ–è€…ä¸€ä¸ªæ˜æ˜¾çš„â€œæ‹ç‚¹â€å¯èƒ½æ˜¯å¥½çš„å€™é€‰èŒƒå›´ã€‚<br>å¯¹äºä½ åœ¨å›¾è¡¨ä¸Šé€‰å‡ºçš„å‡ ä¸ªå€™é€‰é˜ˆå€¼</p></blockquote><ul><li>å¯è§†åŒ–é˜ˆå€¼é€‰æ‹©å·¥å…·ä½¿ç”¨æ–¹æ³•</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">python threshold_explorer.py &quot;/Volumes/shared/czq/video/scene-detect/æ·¡å…¥æ·¡å‡º-result/æ— è½¬åœº-result/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº&quot; \</span><br><span class="line">   -e &quot;.mp4,.mkv&quot; \</span><br><span class="line">   -r \</span><br><span class="line">   --sample_ratio 0.2 \</span><br><span class="line">   --threshold_start 1.0 \</span><br><span class="line">   --threshold_end 30.0 \</span><br><span class="line">   --threshold_step 1.0 \</span><br><span class="line">   --min_len 1 \</span><br><span class="line">   --output_dir &quot;./content_detector_exploration&quot; \</span><br><span class="line">   --save_images_for &quot;8.0,12.0,15.0&quot;</span><br></pre></td></tr></table></figure><ul><li>äº®åº¦æ£€æµ‹å·¥å…·ä½¿ç”¨æ–¹æ³•</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python analyze_brightness.py &#x27;/Volumes/shared/czq/video/scene-detect/æ·¡å…¥æ·¡å‡º-result/æ— è½¬åœº-result/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº/3 (15).mp4&#x27;</span><br></pre></td></tr></table></figure><h3 id="ç»“æœæ˜¾ç¤º">ç»“æœæ˜¾ç¤º</h3><blockquote><p>å¦‚å›¾</p></blockquote><ul><li>å¹³å‡é˜ˆå€¼</li></ul><p><img src="/2025/05/15/scene-detect-method/avg_scenes_vs_threshold.png" class="lazyload placeholder" data-srcset="/2025/05/15/scene-detect-method/avg_scenes_vs_threshold.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li>æ£€æµ‹è§†é¢‘æ‰€æœ‰é˜ˆå€¼</li></ul><p><img src="/2025/05/15/scene-detect-method/scenes_vs_threshold_per_video.png" class="lazyload placeholder" data-srcset="/2025/05/15/scene-detect-method/scenes_vs_threshold_per_video.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">2025-05-14 19:17:47,588 - INFO - --- é˜ˆå€¼é€‰æ‹©å»ºè®® ---</span><br><span class="line">2025-05-14 19:17:47,589 - INFO - è¯·æŸ¥çœ‹ &#x27;avg_scenes_vs_threshold.png&#x27; å›¾è¡¨ã€‚</span><br><span class="line">2025-05-14 19:17:47,589 - INFO - ç†æƒ³çš„é˜ˆå€¼é€šå¸¸ä½äºä»¥ä¸‹åŒºåŸŸï¼š</span><br><span class="line">2025-05-14 19:17:47,589 - INFO -   - åœºæ™¯æ•°é‡å¼€å§‹æ˜¾è‘—å‡å°‘ä¹‹å‰çš„ç‚¹ï¼ˆå¦‚æœä½ æƒ³æ•æ‰æ›´å¤šç»†èŠ‚ï¼‰ã€‚</span><br><span class="line">2025-05-14 19:17:47,589 - INFO -   - åœºæ™¯æ•°é‡è¶‹äºç¨³å®šï¼Œä¸å†éšé˜ˆå€¼å¢åŠ è€Œå¤§å¹…å‡å°‘çš„ç‚¹ï¼ˆå¦‚æœä½ æƒ³æ›´é²æ£’ï¼Œå‡å°‘è¯¯æŠ¥ï¼‰ã€‚</span><br><span class="line">2025-05-14 19:17:47,589 - INFO -   - é¿å…é˜ˆå€¼è¿‡ä½å¯¼è‡´åœºæ™¯æ•°è¿‡å¤šï¼ˆå¯èƒ½æ˜¯å™ªå£°æˆ–å¾®å°å˜åŒ–ï¼‰ã€‚</span><br><span class="line">2025-05-14 19:17:47,589 - INFO -   - é¿å…é˜ˆå€¼è¿‡é«˜å¯¼è‡´åœºæ™¯æ•°è¿‡å°‘ï¼ˆå¯èƒ½é—æ¼çœŸå®åˆ‡æ¢ï¼‰ã€‚</span><br><span class="line">2025-05-14 19:17:47,590 - INFO -   æ ¹æ®ç®€å•çš„å˜åŒ–ç‡åˆ†æï¼Œå¯ä»¥å…³æ³¨ä»¥ä¸‹é˜ˆå€¼é™„è¿‘çš„è¡¨ç°ï¼š[2.0, 3.0, 9.0]</span><br><span class="line">2025-05-14 19:17:47,590 - INFO - ç»“åˆ &#x27;saved_scene_images&#x27; (å¦‚æœç”Ÿæˆäº†) ä¸­çš„å®é™…åœºæ™¯å›¾ç‰‡è¿›è¡Œäººå·¥åˆ¤æ–­ã€‚</span><br><span class="line">2025-05-14 19:17:47,590 - INFO - è¯·æ£€æŸ¥è¾“å‡ºç›®å½• &#x27;content_detector_exploration&#x27; ä¸­çš„ç»“æœã€‚</span><br><span class="line">2025-05-14 19:17:47,590 - INFO - é˜ˆå€¼æ¢ç´¢å®Œæˆã€‚</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ">å‚è€ƒ</h2><ul><li><ol><li><a href="https://www.scenedetect.com/docs/latest/cli.html#detect-threshold">https://www.scenedetect.com/docs/latest/cli.html#detect-threshold</a></li></ol></li><li><ol start="2"><li><a href="https://caozhaoqi.github.io/2025/04/03/video-secene-detect/">https://caozhaoqi.github.io/2025/04/03/video-secene-detect/</a></li></ol></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäºyolov8æ ¹æ®CVATæ ‡æ³¨ç»“æœè®­ç»ƒæ¨¡å‹</title>
      <link href="/2025/04/09/yolov8-train-model/"/>
      <url>/2025/04/09/yolov8-train-model/</url>
      
        <content type="html"><![CDATA[<h2 id="æ¨¡å‹ç®€ä»‹">æ¨¡å‹ç®€ä»‹</h2><blockquote><p>YOLO æ˜¯ä¸€ç§å®æ—¶ç›®æ ‡æ£€æµ‹ç®—æ³•å®¶æ—çš„åç§°ã€‚ä¸ä¼ ç»Ÿçš„éœ€è¦å…ˆè¿›è¡ŒåŒºåŸŸæè®®ï¼ˆRegion Proposalï¼‰å†è¿›è¡Œåˆ†ç±»çš„ä¸¤é˜¶æ®µæ£€æµ‹å™¨ï¼ˆå¦‚ Faster R-CNNï¼‰ä¸åŒï¼ŒYOLO å°†ç›®æ ‡æ£€æµ‹è§†ä¸ºä¸€ä¸ªå›å½’é—®é¢˜ï¼Œç›´æ¥ä»æ•´ä¸ªå›¾åƒä¸­é¢„æµ‹è¾¹ç•Œæ¡†çš„ä½ç½®å’Œç±»åˆ«æ¦‚ç‡ï¼Œå®ç°äº†ç«¯åˆ°ç«¯ï¼ˆend-to-endï¼‰çš„æ£€æµ‹ã€‚</p></blockquote><ul><li><strong>æ ¸å¿ƒæ€æƒ³:</strong><ol><li><strong>ç½‘æ ¼åˆ’åˆ†:</strong> å°†è¾“å…¥å›¾åƒåˆ’åˆ†ä¸º S x S çš„ç½‘æ ¼ (Grid Cells)ã€‚</li><li><strong>å•å…ƒæ ¼è´Ÿè´£åˆ¶:</strong> å¦‚æœä¸€ä¸ªç‰©ä½“çš„ä¸­å¿ƒè½å…¥æŸä¸ªç½‘æ ¼å•å…ƒï¼Œåˆ™è¯¥å•å…ƒè´Ÿè´£æ£€æµ‹è¯¥ç‰©ä½“ã€‚</li><li><strong>è¾¹ç•Œæ¡†é¢„æµ‹:</strong> æ¯ä¸ªç½‘æ ¼å•å…ƒé¢„æµ‹ B ä¸ªè¾¹ç•Œæ¡† (Bounding Boxes) ä»¥åŠè¿™äº›æ¡†çš„ç½®ä¿¡åº¦ (Confidence Scoreï¼Œè¡¨ç¤ºæ¡†å†…å«æœ‰ç‰©ä½“çš„æ¦‚ç‡åŠæ¡†çš„å‡†ç¡®åº¦)ã€‚æ¯ä¸ªè¾¹ç•Œæ¡†åŒ…å« 5 ä¸ªé¢„æµ‹å€¼ï¼š<code>x</code>, <code>y</code> (æ¡†ä¸­å¿ƒç›¸å¯¹å•å…ƒæ ¼çš„åæ ‡), <code>w</code>, <code>h</code> (æ¡†å®½é«˜ç›¸å¯¹æ•´å¼ å›¾åƒçš„æ¯”ä¾‹), å’Œ <code>confidence</code>ã€‚</li><li><strong>ç±»åˆ«æ¦‚ç‡é¢„æµ‹:</strong> æ¯ä¸ªç½‘æ ¼å•å…ƒè¿˜é¢„æµ‹ C ä¸ªæ¡ä»¶ç±»åˆ«æ¦‚ç‡ (Conditional Class Probabilities)ï¼Œå³åœ¨åŒ…å«ç‰©ä½“çš„å‰æä¸‹ï¼Œè¯¥ç‰©ä½“å±äºæ¯ä¸ªç±»åˆ«çš„æ¦‚ç‡ã€‚</li><li><strong>æœ€ç»ˆæ£€æµ‹:</strong> å°†æ¯ä¸ªè¾¹ç•Œæ¡†çš„ç½®ä¿¡åº¦ä¸å¯¹åº”å•å…ƒæ ¼çš„ç±»åˆ«æ¦‚ç‡ç›¸ä¹˜ï¼Œå¾—åˆ°æ¯ä¸ªæ¡†é’ˆå¯¹æ¯ä¸ªç±»åˆ«çš„å¾—åˆ†ã€‚é€šè¿‡è®¾ç½®é˜ˆå€¼è¿‡æ»¤ä½åˆ†æ¡†ï¼Œå¹¶ä½¿ç”¨éæå¤§å€¼æŠ‘åˆ¶ (Non-Maximum Suppression, NMS) æ¶ˆé™¤å†—ä½™çš„é‡å æ¡†ï¼Œå¾—åˆ°æœ€ç»ˆçš„æ£€æµ‹ç»“æœã€‚</li></ol></li></ul><h2 id="CVATç®€ä»‹">CVATç®€ä»‹</h2><blockquote><p>åŸºäº Web çš„ã€åŠŸèƒ½å¼ºå¤§çš„è®¡ç®—æœºè§†è§‰æ•°æ®æ ‡æ³¨å·¥å…·ã€‚å®ƒæ”¯æŒå¯¹å›¾åƒå’Œè§†é¢‘è¿›è¡Œå¤šç§ç±»å‹çš„æ ‡æ³¨ï¼Œæ˜¯è®¡ç®—æœºè§†è§‰é¡¹ç›®ï¼ˆå°¤å…¶æ˜¯ç›‘ç£å­¦ä¹ ï¼‰ä¸­æ•°æ®å‡†å¤‡é˜¶æ®µçš„é‡è¦å·¥å…·</p></blockquote><ul><li><strong>ä¸»è¦åŠŸèƒ½:</strong><ul><li><strong>å¤šç§æ ‡æ³¨ç±»å‹:</strong><ul><li><strong>è¾¹ç•Œæ¡† (Bounding Boxes):</strong> ç”¨äºç›®æ ‡æ£€æµ‹ä»»åŠ¡ï¼Œæ¡†å‡ºç‰©ä½“çš„ä½ç½®ã€‚</li><li><strong>å¤šè¾¹å½¢ (Polygons):</strong> ç”¨äºå®ä¾‹åˆ†å‰²ä»»åŠ¡ï¼Œç²¾ç¡®å‹¾å‹’ç‰©ä½“çš„è½®å»“ã€‚</li><li><strong>å…³é”®ç‚¹ (Points / Skeleton):</strong> ç”¨äºå§¿æ€ä¼°è®¡ã€äººè„¸å…³é”®ç‚¹æ£€æµ‹ç­‰ä»»åŠ¡ã€‚</li><li><strong>åˆ†å‰²æ©ç  (Segmentation Masks):</strong> ç”¨äºè¯­ä¹‰åˆ†å‰²ä»»åŠ¡ï¼Œä¸ºå›¾åƒä¸­çš„æ¯ä¸ªåƒç´ åˆ†é…ç±»åˆ«ã€‚</li><li><strong>æ ‡ç­¾ (Tags):</strong> ç”¨äºå›¾åƒåˆ†ç±»ä»»åŠ¡ï¼Œä¸ºæ•´ä¸ªå›¾åƒåˆ†é…ç±»åˆ«æ ‡ç­¾ã€‚</li><li><strong>è½¨è¿¹/ç«‹æ–¹ä½“ (Tracks/Cuboids):</strong> æ”¯æŒè§†é¢‘æ ‡æ³¨ï¼Œå¯ä»¥è·Ÿè¸ªç‰©ä½“æˆ–æ ‡æ³¨3Dè¾¹ç•Œæ¡†ã€‚</li></ul></li><li><strong>å›¾åƒå’Œè§†é¢‘æ”¯æŒ:</strong> å¯ä»¥ç›´æ¥å¯¹å•å¼ å›¾ç‰‡æˆ–æ•´ä¸ªè§†é¢‘åºåˆ—è¿›è¡Œæ ‡æ³¨ã€‚è§†é¢‘æ ‡æ³¨æ”¯æŒæ’å€¼ï¼ˆinterpolationï¼‰ï¼Œå¯ä»¥å‡å°‘æ‰‹åŠ¨æ ‡æ³¨çš„å·¥ä½œé‡ã€‚</li><li><strong>åŠè‡ªåŠ¨å’Œè‡ªåŠ¨æ ‡æ³¨:</strong> é›†æˆäº†å¤šç§ AI æ¨¡å‹ï¼ˆå¦‚ç›®æ ‡æ£€æµ‹ã€åˆ†å‰²æ¨¡å‹ï¼ŒåŒ…æ‹¬ YOLOã€SAM ç­‰ï¼‰ï¼Œå¯ä»¥é¢„æ ‡æ³¨æ•°æ®ï¼Œç„¶åç”±äººå·¥è¿›è¡Œä¿®æ­£ï¼Œæé«˜æ•ˆç‡ã€‚æ”¯æŒè¿æ¥å¤–éƒ¨ AI æ¨¡å‹ï¼ˆå¦‚é€šè¿‡ Nuclioï¼‰ã€‚</li><li><strong>åä½œ:</strong> æ”¯æŒå¤šç”¨æˆ·åä½œï¼Œå¯ä»¥åˆ†é…ä»»åŠ¡ã€è¿›è¡Œå®¡æ ¸ç­‰ã€‚</li><li><strong>æ•°æ®ç®¡ç†:</strong> æä¾›é¡¹ç›® (Project) å’Œä»»åŠ¡ (Task) ç®¡ç†åŠŸèƒ½ï¼Œæ–¹ä¾¿ç»„ç»‡æ•°æ®ã€‚</li><li><strong>å¤šç§å¯¼å‡ºæ ¼å¼:</strong> æ”¯æŒå¯¼å‡ºä¸ºå¤šç§å¸¸è§çš„æ•°æ®é›†æ ¼å¼ï¼Œå¦‚ COCO JSON, Pascal VOC XML, YOLO, MOT, Segmentation Mask ç­‰ï¼Œæ–¹ä¾¿ä¸å„ç§æ·±åº¦å­¦ä¹ æ¡†æ¶å¯¹æ¥ã€‚</li><li><strong>å¯æ‰©å±•æ€§:</strong> å¼€æºï¼Œå¯ä»¥é€šè¿‡æ’ä»¶æˆ–é›†æˆè‡ªå®šä¹‰å·¥å…·è¿›è¡Œæ‰©å±•ã€‚</li><li><strong>éƒ¨ç½²:</strong> å¯ä»¥é€šè¿‡ Docker åœ¨æœ¬åœ°ã€æœåŠ¡å™¨æˆ–äº‘ä¸Šéƒ¨ç½²ã€‚</li></ul></li></ul><p><img src="/2025/04/09/yolov8-train-model/train_model.png" class="lazyload placeholder" data-srcset="/2025/04/09/yolov8-train-model/train_model.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="CVATæ ‡æ³¨ç»“æœå¯¼å‡º">CVATæ ‡æ³¨ç»“æœå¯¼å‡º</h2><blockquote><p>ä½¿ç”¨ä» CVAT å¯¼å‡ºçš„ YOLO æ ¼å¼æ•°æ®ï¼Œå¹¶åœ¨ <strong>CPU</strong> ä¸Šè®­ç»ƒä¸€ä¸ªæ–°çš„ YOLOv8 æ¨¡å‹ï¼ˆä½¿ç”¨ Ultralytics æ¡†æ¶ï¼‰ï¼Œä»¥ä¸‹è¯¦ç»†æ­¥éª¤ã€‚</p></blockquote><p><strong>é‡è¦æç¤ºï¼š</strong> åœ¨ CPU ä¸Šè®­ç»ƒç›®æ ‡æ£€æµ‹æ¨¡å‹ï¼ˆå°¤å…¶æ˜¯åƒ YOLOv8 è¿™æ ·è¾ƒç°ä»£çš„æ¨¡å‹ï¼‰å°†ä¼š<strong>éå¸¸éå¸¸æ…¢</strong>ã€‚æ ¹æ®ä½ çš„æ•°æ®é›†å¤§å°ã€æ¨¡å‹å¤§å°å’Œ CPU æ€§èƒ½ï¼Œä¸€ä¸ª epoch å¯èƒ½éœ€è¦æ•°å°æ—¶ç”šè‡³æ›´é•¿æ—¶é—´ã€‚è¿™é€šå¸¸åªé€‚ç”¨äºéå¸¸å°çš„æ•°æ®é›†ã€å¿«é€ŸåŸå‹éªŒè¯æˆ–æ²¡æœ‰ GPU å¯ç”¨çš„æƒ…å†µã€‚è¯·æœ‰å¿ƒç†å‡†å¤‡ã€‚</p><p><strong>æ­¥éª¤ 1ï¼šä» CVAT å¯¼å‡º YOLO æ ¼å¼æ•°æ®</strong></p><ol><li><strong>ç™»å½• CVAT</strong> å¹¶å¯¼èˆªåˆ°ä½ å·²å®Œæˆæ ‡æ³¨çš„ä»»åŠ¡ (Task)ã€‚</li><li>ç‚¹å‡»ä»»åŠ¡å¡ç‰‡ä¸Šçš„ <strong>â€œActionsâ€</strong> (æˆ–ä»»åŠ¡é¡µé¢å†…çš„èœå•æŒ‰é’®)ã€‚</li><li>é€‰æ‹© <strong>â€œExport task datasetâ€</strong>ã€‚</li><li>åœ¨å¼¹å‡ºçš„çª—å£ä¸­ï¼š<ul><li><strong>é€‰æ‹©æ ¼å¼:</strong> <strong>åŠ¡å¿…é€‰æ‹© <code>YOLO</code> æˆ– <code>YOLO ZIP</code></strong>ã€‚</li><li><strong>å­é›†åˆ’åˆ† (å¯é€‰ä½†æ¨è):</strong> å¦‚æœä½ åœ¨ CVAT ä¸­å·²å°†æ•°æ®åˆ†é…åˆ° <code>Train</code>, <code>Validation</code>, <code>Test</code> å­é›†ï¼Œè¯·ç¡®ä¿å‹¾é€‰äº†ç›¸åº”çš„é€‰é¡¹æ¥å¯¼å‡ºè¿™äº›å­é›†ã€‚è¿™ä¼šçœå»ä½ æ‰‹åŠ¨åˆ’åˆ†çš„æ­¥éª¤ã€‚å¦‚æœæ²¡åˆ’åˆ†ï¼Œåˆ™å¯¼å‡ºæ•´ä¸ªæ•°æ®é›†ã€‚</li><li><strong>ä¿å­˜å›¾åƒ:</strong> ç¡®ä¿å‹¾é€‰äº† â€œSave imagesâ€ é€‰é¡¹ã€‚</li></ul></li><li>ç‚¹å‡» <strong>â€œOKâ€</strong> æˆ– <strong>â€œExportâ€</strong>ã€‚</li><li>ç­‰å¾…å¯¼å‡ºä»»åŠ¡å®Œæˆï¼Œç„¶åä¸‹è½½ç”Ÿæˆçš„ <strong>ZIP æ–‡ä»¶</strong>ã€‚</li></ol><p><strong>æ­¥éª¤ 2ï¼šå‡†å¤‡æ•°æ®é›†æ–‡ä»¶</strong></p><ol><li><strong>è§£å‹ ZIP æ–‡ä»¶:</strong> å°†ä¸‹è½½çš„ ZIP æ–‡ä»¶è§£å‹åˆ°ä½ ç”µè„‘ä¸Šä¸€ä¸ªæ–¹ä¾¿è®¿é—®çš„ä½ç½®ï¼Œä¾‹å¦‚ <code>~/datasets/my_yolo_dataset</code>ã€‚</li><li><strong>æ£€æŸ¥æ–‡ä»¶ç»“æ„:</strong> è§£å‹åï¼Œæ£€æŸ¥é‡Œé¢çš„å†…å®¹ã€‚ä¸€ä¸ªå…¸å‹çš„ YOLO å¯¼å‡ºï¼ˆç‰¹åˆ«æ˜¯åŒ…å«å­é›†åˆ’åˆ†çš„ï¼‰å¯èƒ½åŒ…å«ï¼š<ul><li><code>data.yaml</code> (æˆ– <code>obj.data</code> å’Œ <code>obj.names</code> æ–‡ä»¶)ï¼šè¿™æ˜¯é…ç½®æ–‡ä»¶ï¼Œéå¸¸é‡è¦ã€‚</li><li><code>train/</code> (æˆ–ç±»ä¼¼çš„åç§°)<ul><li><code>images/</code>: åŒ…å«è®­ç»ƒé›†çš„å›¾åƒæ–‡ä»¶ (<code>.jpg</code>, <code>.png</code> ç­‰)ã€‚</li><li><code>labels/</code>: åŒ…å«è®­ç»ƒé›†çš„æ ‡æ³¨æ–‡ä»¶ (<code>.txt</code>)ï¼Œæ¯ä¸ªå›¾åƒå¯¹åº”ä¸€ä¸ªã€‚</li></ul></li><li><code>valid/</code> (æˆ– <code>val/</code>)<ul><li><code>images/</code>: åŒ…å«éªŒè¯é›†çš„å›¾åƒæ–‡ä»¶ã€‚</li><li><code>labels/</code>: åŒ…å«éªŒè¯é›†çš„æ ‡æ³¨æ–‡ä»¶ã€‚</li></ul></li><li><code>test/</code> (å¯é€‰)<ul><li><code>images/</code>: åŒ…å«æµ‹è¯•é›†çš„å›¾åƒæ–‡ä»¶ã€‚</li><li><code>labels/</code>: åŒ…å«æµ‹è¯•é›†çš„æ ‡æ³¨æ–‡ä»¶ã€‚</li></ul></li><li><em>å¦‚æœå¯¼å‡ºæ—¶æ²¡æœ‰åˆ’åˆ†:</em> ä½ å¯èƒ½åªæœ‰ä¸€ä¸ª <code>images/</code> å’Œä¸€ä¸ª <code>labels/</code> æ–‡ä»¶å¤¹ï¼Œä»¥åŠé…ç½®æ–‡ä»¶ã€‚</li></ul></li><li><strong>éªŒè¯/ä¿®æ”¹ <code>data.yaml</code> (æˆ–åˆ›å»ºå®ƒ):</strong> è¿™æ˜¯å‘Šè¯‰ YOLOv8 æ¡†æ¶å¦‚ä½•æ‰¾åˆ°ä½ çš„æ•°æ®çš„å…³é”®æ–‡ä»¶ã€‚<ul><li><strong>å¦‚æœå·²æœ‰ <code>data.yaml</code>:</strong> ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€å®ƒã€‚å®ƒçœ‹èµ·æ¥ç±»ä¼¼è¿™æ ·ï¼š<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">path:</span> <span class="string">../datasets/my_yolo_dataset</span> <span class="comment"># ï¼ï¼å¯èƒ½éœ€è¦ä¿®æ”¹ï¼šæ•°æ®é›†æ ¹ç›®å½•çš„ç›¸å¯¹æˆ–ç»å¯¹è·¯å¾„</span></span><br><span class="line"><span class="attr">train:</span> <span class="string">train/images</span>             <span class="comment"># ï¼ï¼è®­ç»ƒé›†å›¾ç‰‡è·¯å¾„ (ç›¸å¯¹äº path)</span></span><br><span class="line"><span class="attr">val:</span> <span class="string">valid/images</span>               <span class="comment"># ï¼ï¼éªŒè¯é›†å›¾ç‰‡è·¯å¾„ (ç›¸å¯¹äº path)</span></span><br><span class="line"><span class="comment"># test: test/images             # å¯é€‰ï¼šæµ‹è¯•é›†å›¾ç‰‡è·¯å¾„</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Classes</span></span><br><span class="line"><span class="attr">nc:</span> <span class="number">9</span>                           <span class="comment"># ï¼ï¼ç±»åˆ«æ•°é‡ï¼Œå¿…é¡»å‡†ç¡®</span></span><br><span class="line"><span class="attr">names:</span> [<span class="string">&#x27;bus&#x27;</span>, <span class="string">&#x27;car&#x27;</span>, <span class="string">&#x27;clock&#x27;</span>, <span class="string">...</span>] <span class="comment"># ï¼ï¼ç±»åˆ«åç§°åˆ—è¡¨ï¼Œé¡ºåºå¿…é¡»ä¸ labels/*.txt ä¸­çš„ç±»åˆ«ID (0, 1, 2...) å®Œå…¨å¯¹åº”ï¼</span></span><br></pre></td></tr></table></figure><strong>ä½ éœ€è¦ä»”ç»†æ£€æŸ¥å¹¶å¯èƒ½ä¿®æ”¹ï¼š</strong><ul><li><code>path</code>: ç¡®ä¿å®ƒæ­£ç¡®æŒ‡å‘ä½ è§£å‹æ•°æ®é›†çš„<strong>æ ¹ç›®å½•</strong>ã€‚<strong>ç›¸å¯¹äºä½ å°†è¦è¿è¡Œè®­ç»ƒå‘½ä»¤çš„ä½ç½®</strong>ã€‚ä½¿ç”¨ç»å¯¹è·¯å¾„é€šå¸¸æ›´å®‰å…¨ã€‚ä¾‹å¦‚ï¼š<code>/home/your_user/datasets/my_yolo_dataset</code>ã€‚</li><li><code>train</code>, <code>val</code>, <code>test</code>: ç¡®ä¿å®ƒä»¬æ­£ç¡®æŒ‡å‘åŒ…å«å›¾åƒæ–‡ä»¶çš„æ–‡ä»¶å¤¹ï¼ˆç›¸å¯¹äº <code>path</code> å®šä¹‰çš„è·¯å¾„ï¼‰ã€‚</li><li><code>nc</code>: ç¡®ä¿ç±»åˆ«æ•°é‡æ­£ç¡®æ— è¯¯ã€‚</li><li><code>names</code>: <strong>æå…¶é‡è¦ï¼</strong> ç¡®ä¿è¿™ä¸ªåˆ—è¡¨ä¸­çš„ç±»åˆ«åç§°<strong>é¡ºåº</strong>ä¸ CVAT å¯¼å‡ºæ—¶ä½¿ç”¨çš„ç±»åˆ« IDï¼ˆä» 0 å¼€å§‹ï¼‰ä»¥åŠ <code>labels/</code> æ–‡ä»¶å¤¹ä¸‹ <code>.txt</code> æ–‡ä»¶ä¸­ä½¿ç”¨çš„æ•°å­— ID å®Œå…¨ä¸€è‡´ã€‚CVAT å¯¼å‡º YOLO æ ¼å¼æ—¶é€šå¸¸ä¼šä¿è¯è¿™ä¸€ç‚¹ï¼Œä½†åŠ¡å¿…æ£€æŸ¥ã€‚</li></ul></li><li><strong>å¦‚æœåªæœ‰ <code>obj.data</code> å’Œ <code>obj.names</code>:</strong> ä½ éœ€è¦<strong>æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ª <code>data.yaml</code> æ–‡ä»¶</strong>ã€‚<ul><li>æ‰“å¼€ <code>obj.names</code>ï¼Œå°†é‡Œé¢çš„ç±»åˆ«åç§°æŒ‰é¡ºåºåˆ—å…¥ <code>data.yaml</code> çš„ <code>names</code> å­—æ®µã€‚è®¡ç®—ç±»åˆ«æ•°é‡å¡«å…¥ <code>nc</code>ã€‚</li><li>æ‰“å¼€ <code>obj.data</code>ï¼Œå®ƒé€šå¸¸åŒ…å«ç±»åˆ«æ•°é‡ã€è®­ç»ƒé›†/éªŒè¯é›†å›¾åƒåˆ—è¡¨æ–‡ä»¶çš„è·¯å¾„ç­‰ä¿¡æ¯ã€‚ä½ éœ€è¦æ ¹æ®è¿™äº›ä¿¡æ¯å’Œä½ çš„å®é™…æ–‡ä»¶ç»“æ„æ¥å¡«å†™ <code>data.yaml</code> ä¸­çš„ <code>path</code>, <code>train</code>, <code>val</code> å­—æ®µã€‚ä½ å¯èƒ½éœ€è¦å°† <code>obj.data</code> ä¸­æŒ‡å‘çš„å›¾åƒåˆ—è¡¨æ–‡ä»¶ï¼ˆä¾‹å¦‚ <code>train.txt</code>, <code>valid.txt</code>ï¼‰ä¹Ÿæ”¾åˆ°ä½ çš„æ•°æ®é›†ç›®å½•ä¸­ï¼Œæˆ–è€…ç›´æ¥ä¿®æ”¹ <code>data.yaml</code> æŒ‡å‘åŒ…å«å›¾åƒçš„æ–‡ä»¶å¤¹ã€‚åˆ›å»º <code>data.yaml</code> é€šå¸¸æ›´ç¬¦åˆç°ä»£ YOLOv8 çš„ä¹ æƒ¯ã€‚</li></ul></li></ul></li><li><strong>æ‰‹åŠ¨åˆ’åˆ†æ•°æ®é›† (å¦‚æœå¯¼å‡ºæ—¶æœªåˆ’åˆ†):</strong><ul><li>å¦‚æœä½ åªæœ‰ä¸€ä¸ª <code>images/</code> å’Œ <code>labels/</code> æ–‡ä»¶å¤¹ï¼Œä½ éœ€è¦æ‰‹åŠ¨å°†å…¶åˆ’åˆ†ä¸ºè®­ç»ƒé›†å’ŒéªŒè¯é›†ã€‚</li><li>åˆ›å»ºå­ç›®å½•ï¼šåœ¨æ•°æ®é›†æ ¹ç›®å½•ä¸‹åˆ›å»º <code>train/images</code>, <code>train/labels</code>, <code>valid/images</code>, <code>valid/labels</code>ã€‚</li><li>ç¼–å†™è„šæœ¬æˆ–æ‰‹åŠ¨ç§»åŠ¨æ–‡ä»¶ï¼š<ul><li>ç¡®å®šåˆ’åˆ†æ¯”ä¾‹ï¼ˆä¾‹å¦‚ï¼Œ80% è®­ç»ƒï¼Œ20% éªŒè¯ï¼‰ã€‚</li><li>éå† <code>images/</code> æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰å›¾åƒæ–‡ä»¶ã€‚</li><li>å¯¹äºæ¯ä¸ªå›¾åƒæ–‡ä»¶ï¼ˆä¾‹å¦‚ <code>image1.jpg</code>ï¼‰ï¼Œæ‰¾åˆ°å…¶å¯¹åº”çš„æ ‡æ³¨æ–‡ä»¶ï¼ˆ<code>labels/image1.txt</code>ï¼‰ã€‚</li><li>æ ¹æ®éšæœºæŠ½æ ·æˆ–å›ºå®šè§„åˆ™ï¼Œå°†è¿™å¯¹æ–‡ä»¶ï¼ˆå›¾åƒå’Œæ ‡æ³¨ï¼‰ç§»åŠ¨åˆ° <code>train/</code> æˆ– <code>valid/</code> ä¸‹ç›¸åº”çš„ <code>images</code> å’Œ <code>labels</code> æ–‡ä»¶å¤¹ä¸­ã€‚</li><li>ç¡®ä¿å›¾åƒå’Œå®ƒçš„ <code>.txt</code> æ ‡æ³¨æ–‡ä»¶å§‹ç»ˆåœ¨åŒä¸€é›†åˆï¼ˆtrain æˆ– validï¼‰ä¸­ã€‚</li></ul></li><li>æ›´æ–° <code>data.yaml</code> ä¸­çš„ <code>train</code> å’Œ <code>val</code> è·¯å¾„æŒ‡å‘ä½ æ–°åˆ›å»ºçš„ <code>train/images</code> å’Œ <code>valid/images</code> æ–‡ä»¶å¤¹ã€‚</li></ul></li></ol><p><strong>æ­¥éª¤ 3ï¼šè®¾ç½® Python å’Œ Ultralytics ç¯å¢ƒ</strong></p><ol><li><strong>å®‰è£… Python:</strong> ç¡®ä¿ä½ å®‰è£…äº†è¾ƒæ–°ç‰ˆæœ¬çš„ Pythonï¼ˆæ¨è 3.8 - 3.11ï¼‰ã€‚</li><li><strong>åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ (å¼ºçƒˆæ¨è):</strong> è¿™å¯ä»¥é¿å…åº“ç‰ˆæœ¬å†²çªã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ venv (Python å†…ç½®)</span></span><br><span class="line">python -m venv yolo_cpu_env</span><br><span class="line"><span class="built_in">source</span> yolo_cpu_env/bin/activate  <span class="comment"># Linux/macOS</span></span><br><span class="line"><span class="comment"># yolo_cpu_env\Scripts\activate  # Windows</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ–è€…ä½¿ç”¨ Conda</span></span><br><span class="line"><span class="comment"># conda create -n yolo_cpu_env python=3.9</span></span><br><span class="line"><span class="comment"># conda activate yolo_cpu_env</span></span><br></pre></td></tr></table></figure></li><li><strong>å®‰è£… Ultralytics YOLOv8:</strong> åœ¨æ¿€æ´»çš„è™šæ‹Ÿç¯å¢ƒä¸­è¿è¡Œï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install ultralytics</span><br></pre></td></tr></table></figure>è¿™ä¼šè‡ªåŠ¨å®‰è£… PyTorch çš„ CPU ç‰ˆæœ¬ï¼ˆå› ä¸ºå®ƒæ£€æµ‹ä¸åˆ°å…¼å®¹çš„ GPU/CUDAï¼‰ä»¥åŠå…¶ä»–å¿…è¦çš„ä¾èµ–åº“ã€‚</li></ol><p><strong>æ­¥éª¤ 4ï¼šé…ç½®è®­ç»ƒå‚æ•°</strong></p><ol><li><strong>é€‰æ‹©é¢„è®­ç»ƒæ¨¡å‹:</strong> ä¸ºäº†åˆ©ç”¨è¿ç§»å­¦ä¹ å¹¶åŠ å¿«ï¼ˆç›¸å¯¹è€Œè¨€ï¼‰æ”¶æ•›é€Ÿåº¦ï¼Œä½ éœ€è¦ä»ä¸€ä¸ªé¢„è®­ç»ƒæ¨¡å‹å¼€å§‹ã€‚å¯¹äº CPU è®­ç»ƒï¼Œ<strong>å¼ºçƒˆå»ºè®®ä»å°æ¨¡å‹å¼€å§‹</strong>ï¼š<ul><li><code>yolov8n.pt</code> (Nano): æœ€å¿«ï¼Œå ç”¨èµ„æºæœ€å°‘ï¼Œä½†ç²¾åº¦ç›¸å¯¹è¾ƒä½ã€‚<strong>CPU è®­ç»ƒçš„é¦–é€‰èµ·ç‚¹ã€‚</strong></li><li><code>yolov8s.pt</code> (Small): ç¨å¤§ï¼Œç¨æ…¢ï¼Œç²¾åº¦ç¨é«˜ã€‚å¦‚æœ <code>yolov8n</code> æ•ˆæœä¸ä½³ä¸”ä½ çš„ CPU å°šå¯æ‰¿å—ï¼Œå¯ä»¥å°è¯•ã€‚</li><li>æ›´å¤§çš„æ¨¡å‹ (<code>m</code>, <code>l</code>, <code>x</code>) åœ¨ CPU ä¸Šè®­ç»ƒå‡ ä¹ä¸å¯è¡Œã€‚</li><li>Ultralytics ä¼šåœ¨ä½ ç¬¬ä¸€æ¬¡ä½¿ç”¨æ¨¡å‹æ—¶è‡ªåŠ¨ä¸‹è½½ <code>.pt</code> æ–‡ä»¶ã€‚</li></ul></li><li><strong>ç¡®å®šè®­ç»ƒå‚æ•°:</strong><ul><li><strong><code>model</code>:</strong> ä½ é€‰æ‹©çš„é¢„è®­ç»ƒæ¨¡å‹ï¼Œä¾‹å¦‚ <code>yolov8n.pt</code>ã€‚</li><li><strong><code>data</code>:</strong> æŒ‡å‘ä½ å‡†å¤‡å¥½çš„ <code>data.yaml</code> æ–‡ä»¶çš„è·¯å¾„ã€‚</li><li><strong><code>epochs</code>:</strong> è®­ç»ƒçš„æ€»è½®æ•°ã€‚å¯¹äº CPUï¼Œå¯ä»¥å…ˆè®¾ç½®ä¸€ä¸ªè¾ƒå°çš„å€¼ï¼ˆä¾‹å¦‚ 10-50ï¼‰æ¥æµ‹è¯•æµç¨‹å’Œè§‚å¯Ÿåˆæ­¥ç»“æœï¼Œåç»­å†å¢åŠ ã€‚å®Œæ•´è®­ç»ƒå¯èƒ½éœ€è¦ 100-300 è½®ç”šè‡³æ›´å¤šï¼Œä½†è¿™åœ¨ CPU ä¸Šä¼šè€—è´¹æé•¿æ—¶é—´ã€‚</li><li><strong><code>batch</code>:</strong> æ‰¹å¤„ç†å¤§å°ã€‚<strong>CPU è®­ç»ƒçš„å…³é”®å‚æ•°</strong>ã€‚ç”±äº CPU è®¡ç®—èƒ½åŠ›å’Œå†…å­˜å¸¦å®½é™åˆ¶ï¼Œä½ éœ€è¦è®¾ç½®ä¸€ä¸ª<strong>éå¸¸å°</strong>çš„å€¼ï¼Œä¾‹å¦‚ <code>2</code>, <code>4</code>, <code>8</code>ã€‚å¯ä»¥ä» 4 æˆ– 8 å¼€å§‹å°è¯•ï¼Œå¦‚æœå†…å­˜ä¸è¶³ (OOM) æˆ– CPU å ç”¨è¿‡é«˜å¯¼è‡´ç³»ç»Ÿå¡é¡¿ï¼Œåˆ™éœ€è¦å‡å°ã€‚</li><li><strong><code>imgsz</code>:</strong> è¾“å…¥å›¾åƒçš„å°ºå¯¸ã€‚é€šå¸¸è®¾ç½®ä¸º 640ã€‚æ›´å¤§çš„å°ºå¯¸ä¼šæ˜¾è‘—å¢åŠ  CPU è®¡ç®—è´Ÿæ‹…å’Œå†…å­˜å ç”¨ã€‚CPU è®­ç»ƒå»ºè®®ä¿æŒ 640 æˆ–æ›´å°ã€‚</li><li><strong><code>device</code>:</strong> <strong>å¿…é¡»è®¾ç½®ä¸º <code>cpu</code></strong>ã€‚<code>device=cpu</code>ã€‚</li><li><strong><code>workers</code>:</strong> æ•°æ®åŠ è½½æ—¶ä½¿ç”¨çš„ CPU æ ¸å¿ƒæ•°ã€‚å¯ä»¥è®¾ç½®ä¸ºä½  CPU æ ¸å¿ƒæ•°çš„ä¸€éƒ¨åˆ†ï¼Œä¾‹å¦‚ <code>2</code>, <code>4</code>ã€‚ä¸ä¸€å®šè¶Šå¤šè¶Šå¥½ï¼Œè¿‡é«˜å¯èƒ½å¯¼è‡´ CPU äº‰ç”¨ã€‚</li></ul></li></ol><p><strong>æ­¥éª¤ 5ï¼šæ‰§è¡Œè®­ç»ƒ</strong></p><ol><li><p><strong>æ‰“å¼€ç»ˆç«¯æˆ–å‘½ä»¤è¡Œã€‚</strong></p></li><li><p><strong>æ¿€æ´»ä½ çš„è™šæ‹Ÿç¯å¢ƒ</strong> (å¦‚ <code>source yolo_cpu_env/bin/activate</code>)ã€‚</p></li><li><p><strong>å¯¼èˆªåˆ°ä½ çš„é¡¹ç›®ç›®å½•</strong> (é€šå¸¸æ˜¯ä½ å­˜æ”¾ <code>data.yaml</code> æˆ–æ‰“ç®—è¿è¡Œè„šæœ¬çš„åœ°æ–¹ï¼Œç¡®ä¿ <code>data.yaml</code> ä¸­çš„è·¯å¾„ç›¸å¯¹äºæ­¤ä½ç½®æ˜¯æ­£ç¡®çš„)ã€‚</p></li><li><p><strong>è¿è¡Œè®­ç»ƒå‘½ä»¤:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yolo train model=yolov8n.pt data=/path/to/your/data.yaml epochs=50 batch=4 imgsz=640 device=cpu workers=4</span><br></pre></td></tr></table></figure><ul><li><strong>è¯·å°† <code>/path/to/your/data.yaml</code> æ›¿æ¢ä¸ºä½ çš„ <code>data.yaml</code> æ–‡ä»¶çš„å®é™…è·¯å¾„ã€‚</strong></li><li><strong>æ ¹æ®éœ€è¦è°ƒæ•´ <code>epochs</code>, <code>batch</code>, <code>workers</code> çš„å€¼ã€‚</strong></li><li><strong>å†æ¬¡å¼ºè°ƒï¼šè¯·æœ‰è€å¿ƒï¼</strong> ä½ ä¼šçœ‹åˆ°è®­ç»ƒå¼€å§‹ï¼Œå¹¶æ˜¾ç¤ºæ¯ä¸ª epoch çš„è¿›åº¦ã€æŸå¤±å€¼ç­‰ï¼Œä½†è¿™ä¼šéå¸¸æ…¢ã€‚</li></ul></li><li><p><strong>æˆ–è€…ä½¿ç”¨ Python è„šæœ¬è¿›è¡Œè®­ç»ƒ:</strong> åˆ›å»ºä¸€ä¸ª Python æ–‡ä»¶ï¼ˆä¾‹å¦‚ <code>train_cpu.py</code>ï¼‰:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> YOLO</span><br><span class="line"><span class="keyword">import</span> torch <span class="comment"># å¯¼å…¥ torch ä»¥ä¾¿æ£€æŸ¥</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># æ£€æŸ¥ PyTorch æ˜¯å¦ç¡®å®åœ¨ä½¿ç”¨ CPU</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;PyTorch device: <span class="subst">&#123;torch.cuda.is_available() <span class="keyword">and</span> torch.device(<span class="string">&#x27;cuda&#x27;</span>) <span class="keyword">or</span> torch.device(<span class="string">&#x27;cpu&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åŠ è½½ä¸€ä¸ªé¢„è®­ç»ƒæ¨¡å‹ (ä¾‹å¦‚ yolov8n.pt)</span></span><br><span class="line">    <span class="comment"># æ¨¡å‹æ–‡ä»¶å¦‚æœæœ¬åœ°æ²¡æœ‰ï¼Œé¦–æ¬¡è¿è¡Œæ—¶ä¼šè‡ªåŠ¨ä¸‹è½½</span></span><br><span class="line">    model = YOLO(<span class="string">&#x27;yolov8n.pt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¼€å§‹è®­ç»ƒ</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        results = model.train(</span><br><span class="line">            data=<span class="string">&#x27;/path/to/your/data.yaml&#x27;</span>,  <span class="comment"># ï¼ï¼æ›¿æ¢ä¸ºä½ çš„ data.yaml è·¯å¾„</span></span><br><span class="line">            epochs=<span class="number">50</span>,                      <span class="comment"># è®­ç»ƒè½®æ•°</span></span><br><span class="line">            batch=<span class="number">4</span>,                        <span class="comment"># æ‰¹å¤§å° (æ ¹æ®CPUå’Œå†…å­˜è°ƒæ•´)</span></span><br><span class="line">            imgsz=<span class="number">640</span>,                      <span class="comment"># å›¾åƒå°ºå¯¸</span></span><br><span class="line">            device=<span class="string">&#x27;cpu&#x27;</span>,                   <span class="comment"># ï¼ï¼æŒ‡å®šä½¿ç”¨ CPU</span></span><br><span class="line">            workers=<span class="number">4</span>,                      <span class="comment"># æ•°æ®åŠ è½½è¿›ç¨‹æ•° (æ ¹æ®CPUæ ¸å¿ƒæ•°è°ƒæ•´)</span></span><br><span class="line">            <span class="comment"># å…¶ä»–å¯é€‰å‚æ•°:</span></span><br><span class="line">            <span class="comment"># project=&#x27;runs/train_cpu&#x27;,     # è‡ªå®šä¹‰ä¿å­˜ç»“æœçš„é¡¹ç›®å</span></span><br><span class="line">            <span class="comment"># name=&#x27;exp_cpu_run1&#x27;,          # è‡ªå®šä¹‰æœ¬æ¬¡è¿è¡Œçš„åç§°</span></span><br><span class="line">            <span class="comment"># patience=20,                  # æ—©åœè½®æ•° (å¦‚æœéªŒè¯é›†æŒ‡æ ‡åœ¨20è½®å†…æ²¡æœ‰æå‡åˆ™åœæ­¢)</span></span><br><span class="line">            <span class="comment"># lr0=0.01,                     # åˆå§‹å­¦ä¹ ç‡ (é€šå¸¸ç”¨é»˜è®¤å€¼)</span></span><br><span class="line">        )</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;è®­ç»ƒå®Œæˆï¼&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;ç»“æœä¿å­˜åœ¨: <span class="subst">&#123;results.save_dir&#125;</span>&quot;</span>) <span class="comment"># results å¯¹è±¡åœ¨ v8 ä¸­ä¸ç›´æ¥åŒ…å« save_dirï¼Œéœ€è¦ä» model æˆ– trainer è·å–ï¼Œæˆ–è€…ç›´æ¥æŸ¥æ‰¾ runs/train ç›®å½•</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;è®­ç»ƒè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç„¶åè¿è¡Œè„šæœ¬ï¼š<code>python train_cpu.py</code></p></li></ol><ul><li>GPUç‰ˆæœ¬</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">pip install ultralytics</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> torch <span class="comment"># Import torch to check CUDA availability first</span></span><br><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> YOLO</span><br><span class="line"><span class="keyword">import</span> os <span class="comment"># Import os for path joining if needed</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># --- Verify CUDA Availability ---</span></span><br><span class="line">    <span class="keyword">if</span> torch.cuda.is_available():</span><br><span class="line">        device_to_use = <span class="number">0</span> <span class="comment"># Use the first available GPU (index 0)</span></span><br><span class="line">        <span class="comment"># device_to_use = &#x27;cuda&#x27; # Alternative way to specify default GPU</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;CUDA is available! Training on GPU device: <span class="subst">&#123;torch.cuda.get_device_name(device_to_use)&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;é”™è¯¯ï¼šæœªæ£€æµ‹åˆ°å…¼å®¹çš„ NVIDIA GPU æˆ– CUDA é…ç½®ä¸æ­£ç¡®ã€‚&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;è¯·æ£€æŸ¥é©±åŠ¨ã€CUDA Toolkitã€cuDNN å’Œ GPU ç‰ˆæœ¬çš„ PyTorch æ˜¯å¦å·²æ­£ç¡®å®‰è£…ã€‚&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;å°†å°è¯•åœ¨ CPU ä¸Šè¿è¡Œï¼Œä½†è¿™ä¼šéå¸¸æ…¢...&quot;</span>)</span><br><span class="line">        device_to_use = <span class="string">&#x27;cpu&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- Configuration ---</span></span><br><span class="line">    <span class="comment"># ï¼ï¼ç¡®ä¿ data.yaml è·¯å¾„æ­£ç¡®ï¼ï¼ (ä½¿ç”¨ os.path.join æˆ– pathlib æ›´ä½³)</span></span><br><span class="line">    data_yaml_path = <span class="string">r&#x27;C:\Users\DELL\Desktop\test_data\test_data\data.yaml&#x27;</span></span><br><span class="line">    model_to_load = <span class="string">&#x27;yolov8x.pt&#x27;</span> <span class="comment"># Using the extra-large model</span></span><br><span class="line">    num_epochs = <span class="number">50</span>            <span class="comment"># Number of training epochs</span></span><br><span class="line">    batch_size = <span class="number">16</span>            <span class="comment"># !! Batch size for GPU (Adjust based on VRAM: 8, 16, 32, etc.)</span></span><br><span class="line">    image_size = <span class="number">640</span>           <span class="comment"># Input image size</span></span><br><span class="line">    num_workers = <span class="number">4</span>            <span class="comment"># Data loading workers (Adjust based on CPU cores)</span></span><br><span class="line">    project_name = <span class="string">&#x27;runs/train_gpu&#x27;</span> <span class="comment"># Directory to save results</span></span><br><span class="line">    run_name = <span class="string">&#x27;exp_gpu_yolov8x&#x27;</span>    <span class="comment"># Specific name for this run</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- Load Model ---</span></span><br><span class="line">    <span class="comment"># Model file will be downloaded automatically if not present locally</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Loading model: <span class="subst">&#123;model_to_load&#125;</span>&quot;</span>)</span><br><span class="line">    model = YOLO(model_to_load)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- Start Training ---</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;å¼€å§‹è®­ç»ƒ...&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  Data YAML: <span class="subst">&#123;data_yaml_path&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  Epochs: <span class="subst">&#123;num_epochs&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  Batch Size: <span class="subst">&#123;batch_size&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  Image Size: <span class="subst">&#123;image_size&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  Device: <span class="subst">&#123;device_to_use&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  Workers: <span class="subst">&#123;num_workers&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        results = model.train(</span><br><span class="line">            data=data_yaml_path,</span><br><span class="line">            epochs=num_epochs,</span><br><span class="line">            batch=batch_size,</span><br><span class="line">            imgsz=image_size,</span><br><span class="line">            device=device_to_use,   <span class="comment"># !! Use the determined device (e.g., 0 or &#x27;cpu&#x27;)</span></span><br><span class="line">            workers=num_workers,</span><br><span class="line">            project=project_name,   <span class="comment"># Specify project directory</span></span><br><span class="line">            name=run_name,          <span class="comment"># Specify run name</span></span><br><span class="line">            <span class="comment"># Other potentially useful optional parameters for GPU:</span></span><br><span class="line">            <span class="comment"># cache=True,           # Cache images in RAM/disk for faster loading (if RAM/disk allows)</span></span><br><span class="line">            <span class="comment"># patience=20,          # Early stopping patience</span></span><br><span class="line">            <span class="comment"># lr0=0.01,             # Initial learning rate</span></span><br><span class="line">            <span class="comment"># optimizer=&#x27;AdamW&#x27;,    # Optimizer (e.g., &#x27;AdamW&#x27;, &#x27;SGD&#x27;)</span></span><br><span class="line">            <span class="comment"># amp=True,             # Use Automatic Mixed Precision (can speed up training, reduce memory, requires compatible GPU)</span></span><br><span class="line">        )</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;è®­ç»ƒå®Œæˆï¼&quot;</span>)</span><br><span class="line">        <span class="comment"># Note: The &#x27;results&#x27; object itself might not directly contain the save path in all versions/contexts.</span></span><br><span class="line">        <span class="comment"># The results are reliably saved in the project/name directory.</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;è®­ç»ƒç»“æœå’Œæ¨¡å‹æƒé‡ä¿å­˜åœ¨: <span class="subst">&#123;os.path.join(project_name, run_name)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> torch.cuda.OutOfMemoryError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;é”™è¯¯ï¼šGPU æ˜¾å­˜ä¸è¶³ (Out of Memory)ï¼&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;å°è¯•å‡å°æ‰¹å¤„ç†å¤§å° (batch=<span class="subst">&#123;batch_size&#125;</span>)ã€‚ä¾‹å¦‚ï¼Œå°è¯• batch=8 æˆ– batch=4ã€‚&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;å¦‚æœæ˜¾å­˜ä»ç„¶ä¸è¶³ï¼Œå¯ä»¥è€ƒè™‘å‡å°å›¾åƒå°ºå¯¸ (imgsz) æˆ–ä½¿ç”¨æ›´å°çš„æ¨¡å‹ (å¦‚ yolov8l.pt, yolov8m.pt)ã€‚&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;é”™è¯¯ï¼šæ‰¾ä¸åˆ°æ–‡ä»¶æˆ–ç›®å½•: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;è¯·ä»”ç»†æ£€æŸ¥ data.yaml æ–‡ä»¶ä¸­çš„è·¯å¾„é…ç½®æ˜¯å¦æ­£ç¡®ï¼Œç‰¹åˆ«æ˜¯ &#x27;path&#x27;, &#x27;train&#x27;, &#x27;val&#x27; å­—æ®µã€‚&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;ç¡®ä¿ data.yaml æ–‡ä»¶æœ¬èº«ä½äº: <span class="subst">&#123;data_yaml_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;è®­ç»ƒè¿‡ç¨‹ä¸­å‘ç”Ÿæ„å¤–é”™è¯¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">import</span> traceback</span><br><span class="line">        traceback.print_exc() <span class="comment"># Print detailed traceback for debugging</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/2025/04/09/yolov8-train-model/train_model_cycle.png" class="lazyload placeholder" data-srcset="/2025/04/09/yolov8-train-model/train_model_cycle.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><p><strong>æ­¥éª¤ 6ï¼šç›‘æ§è®­ç»ƒå’Œè¯„ä¼°ç»“æœ</strong></p><ol><li><strong>è§‚å¯Ÿç»ˆç«¯è¾“å‡º:</strong> æŸ¥çœ‹æ¯ä¸ª epoch çš„è¿›åº¦ã€æŸå¤±å‡½æ•°å€¼ï¼ˆbox_loss, cls_loss, dfl_lossï¼‰æ˜¯å¦åœ¨ä¸‹é™ï¼Œä»¥åŠåœ¨éªŒè¯é›†ä¸Šçš„æŒ‡æ ‡ï¼ˆå¦‚ P, R, mAP50, mAP50-95ï¼‰æ˜¯å¦åœ¨æå‡ã€‚</li><li><strong>æŸ¥æ‰¾ç»“æœ:</strong> è®­ç»ƒè¿‡ç¨‹å’Œç»“æœé»˜è®¤ä¼šä¿å­˜åœ¨ <code>runs/train/exp&lt;N&gt;</code> ç›®å½•ä¸‹ï¼ˆä¾‹å¦‚ <code>runs/train/exp</code>, <code>runs/train/exp2</code> ç­‰ï¼‰ã€‚é‡Œé¢åŒ…å«ï¼š<ul><li><code>weights/</code>: ä¿å­˜çš„æ¨¡å‹æƒé‡æ–‡ä»¶ã€‚<code>best.pt</code> æ˜¯åŸºäºéªŒè¯é›†æŒ‡æ ‡æœ€ä½³çš„æ¨¡å‹ï¼Œ<code>last.pt</code> æ˜¯æœ€åä¸€ä¸ª epoch çš„æ¨¡å‹ã€‚<strong><code>best.pt</code> é€šå¸¸æ˜¯ä½ éœ€è¦çš„æ¨¡å‹ã€‚</strong></li><li>æ—¥å¿—æ–‡ä»¶ (TensorBoard logs)ã€‚</li><li>é…ç½®æ–‡ä»¶å‰¯æœ¬ã€‚</li><li>éªŒè¯ç»“æœå›¾è¡¨å’Œå›¾ç‰‡ï¼ˆä¾‹å¦‚ <code>confusion_matrix.png</code>, <code>results.png</code>, <code>val_batch0_pred.jpg</code> ç­‰ï¼‰ã€‚</li></ul></li><li><strong>éªŒè¯æ¨¡å‹:</strong> è®­ç»ƒå®Œæˆåï¼ˆæˆ–ä¸­é€”ï¼‰ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>best.pt</code> åœ¨éªŒè¯é›†ä¸Šè¿›è¡Œè¯„ä¼°ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yolo val model=runs/train/exp&lt;N&gt;/weights/best.pt data=/path/to/your/data.yaml device=cpu</span><br></pre></td></tr></table></figure></li></ol><p><strong>æ­¥éª¤ 7ï¼šä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹</strong></p><p>è®­ç»ƒå®Œæˆåï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>best.pt</code> æ–‡ä»¶è¿›è¡Œæ¨ç†ï¼ˆç›®æ ‡æ£€æµ‹ï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yolo predict model=runs/train/exp&lt;N&gt;/weights/best.pt <span class="built_in">source</span>=/path/to/image.jpg device=cpu</span><br><span class="line"><span class="comment"># æˆ–è€…å¯¹è§†é¢‘è¿›è¡Œæ¨ç† (CPUä¸Šä¼šå¾ˆæ…¢)</span></span><br><span class="line"><span class="comment"># yolo predict model=runs/train/exp&lt;N&gt;/weights/best.pt source=/path/to/video.mp4 device=cpu</span></span><br></pre></td></tr></table></figure><p>æˆ–è€…åœ¨ Python è„šæœ¬ä¸­ä½¿ç”¨ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> YOLO</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½ä½ è®­ç»ƒå¥½çš„æ¨¡å‹</span></span><br><span class="line">model = YOLO(<span class="string">&#x27;runs/train/exp&lt;N&gt;/weights/best.pt&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›è¡Œé¢„æµ‹</span></span><br><span class="line">results = model.predict(source=<span class="string">&#x27;/path/to/image.jpg&#x27;</span>, device=<span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤„ç†ç»“æœ (ä¾‹å¦‚ï¼Œç»˜åˆ¶è¾¹ç•Œæ¡†)</span></span><br><span class="line"><span class="keyword">for</span> r <span class="keyword">in</span> results:</span><br><span class="line">    boxes = r.boxes  <span class="comment"># Boxes object for bounding box outputs</span></span><br><span class="line">    masks = r.masks  <span class="comment"># Masks object for segmentation masks outputs</span></span><br><span class="line">    keypoints = r.keypoints  <span class="comment"># Keypoints object for pose outputs</span></span><br><span class="line">    probs = r.probs  <span class="comment"># Probs object for classification outputs</span></span><br><span class="line">    <span class="comment"># r.show()  # display to screen</span></span><br><span class="line">    r.save(filename=<span class="string">&#x27;result.jpg&#x27;</span>) <span class="comment"># save to disk</span></span><br></pre></td></tr></table></figure><p><strong>CPUè®­ç»ƒçš„å±€é™æ€§:</strong></p><ul><li><strong>é€Ÿåº¦ææ…¢:</strong></li><li><strong>å†…å­˜é™åˆ¶:</strong> å°å¿ƒ RAM è€—å°½ï¼Œç‰¹åˆ«æ˜¯ä½¿ç”¨è¾ƒå¤§çš„ <code>batch</code> æˆ– <code>imgsz</code> æ—¶ã€‚</li><li><strong>å¯è¡Œæ€§:</strong> å¯¹äºéå¸¸å¤§çš„æ•°æ®é›†æˆ–éœ€è¦é«˜ç²¾åº¦ï¼ˆéœ€è¦è®­ç»ƒæ›´é•¿æ—¶é—´æˆ–æ›´å¤§æ¨¡å‹ï¼‰çš„ä»»åŠ¡ï¼ŒCPU è®­ç»ƒå¯èƒ½å®é™…ä¸Šä¸å¯è¡Œã€‚è€ƒè™‘ä½¿ç”¨ Google Colabï¼ˆæä¾›å…è´¹ GPUï¼‰ã€Kaggle Kernels æˆ–å…¶ä»–äº‘ GPU æœåŠ¡å¯èƒ½æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚</li></ul><h2 id="éªŒè¯æ•°æ®é›†è·å–">éªŒè¯æ•°æ®é›†è·å–</h2><blockquote><p>è·å–éªŒè¯æ•°æ®é›†ï¼ˆValidation Setï¼‰æ˜¯è®­ç»ƒè¿‡ç¨‹ä¸­éå¸¸é‡è¦çš„ä¸€æ­¥ï¼Œç”¨äºè¯„ä¼°æ¨¡å‹åœ¨æœªè§è¿‡æ•°æ®ä¸Šçš„è¡¨ç°å¹¶è°ƒæ•´è¶…å‚æ•°ã€‚å½“ä½ çš„æ•°æ®æ¥è‡ª CVAT å¹¶å¯¼å‡ºäº† YOLO æ ¼å¼æ—¶ï¼Œæœ‰ä»¥ä¸‹å‡ ç§ä¸»è¦æ–¹æ³•æ¥è·å–æˆ–æŒ‡å®šéªŒè¯æ•°æ®é›†ï¼š</p></blockquote><p><strong>æ–¹æ³•ä¸€ï¼šåœ¨ CVAT ä¸­åˆ’åˆ†å¹¶å¯¼å‡º (æ¨è)</strong></p><p>è¿™æ˜¯æœ€æ–¹ä¾¿ã€æœ€ä¸å®¹æ˜“å‡ºé”™çš„æ–¹æ³•ï¼Œæ¨èä¼˜å…ˆè€ƒè™‘ã€‚</p><ol><li><strong>åœ¨ CVAT ä¸­åˆ†é…å­é›† (Subset):</strong><ul><li>åœ¨ä½  CVAT çš„ä»»åŠ¡ (Task) ä¸­ï¼Œä½ å¯ä»¥å°†æ ‡æ³¨å¥½çš„æ•°æ®å¸§æˆ–å›¾ç‰‡åˆ†é…åˆ°ä¸åŒçš„å­é›†ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰æ•°æ®éƒ½åœ¨ <code>Default</code> æˆ– <code>Train</code> å­é›†ä¸­ã€‚</li><li>è¿›å…¥ä½ çš„ä»»åŠ¡ï¼Œé€‰æ‹©ä¸€äº›å¸§æˆ–å›¾ç‰‡ï¼ˆä¾‹å¦‚ï¼Œéšæœºé€‰æ‹©æ€»æ•°æ®çš„ 10-20%ï¼‰ã€‚</li><li>ç‚¹å‡» â€œActionsâ€ -&gt; â€œChange subsetâ€ã€‚</li><li>åœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­ï¼Œé€‰æ‹© <code>Validation</code> ä½œä¸ºç›®æ ‡å­é›†ï¼Œç„¶åç¡®è®¤ã€‚</li><li>è¿™æ ·ä½ å°±å‘Šè¯‰ CVATï¼Œè¿™äº›é€‰ä¸­çš„æ•°æ®å±äºéªŒè¯é›†ã€‚ä½ ä¹Ÿå¯ä»¥åŒæ ·åœ°åˆ†é… <code>Test</code> å­é›†ï¼ˆå¦‚æœéœ€è¦ï¼‰ã€‚</li></ul></li><li><strong>å¯¼å‡ºæ—¶åŒ…å«å­é›†:</strong><ul><li>åœ¨ä½ å¯¼å‡ºä»»åŠ¡æ•°æ®é›†æ—¶ï¼Œé€‰æ‹© <code>YOLO</code> æˆ– <code>YOLO ZIP</code> æ ¼å¼ã€‚</li><li><strong>å…³é”®:</strong> åœ¨å¯¼å‡ºé€‰é¡¹ä¸­ï¼Œç¡®ä¿ä½ é€‰æ‹©äº†å¯¼å‡ºæ‰€æœ‰å­é›†ï¼Œæˆ–è€…è¯¥æ ¼å¼é»˜è®¤å°±ä¼šå°†ä¸åŒçš„å­é›†åˆ†å¼€å¯¼å‡ºã€‚ä¾‹å¦‚ï¼Œ<code>YOLO ZIP</code> æ ¼å¼é€šå¸¸ä¼šè‡ªåŠ¨åˆ›å»º <code>train/</code>, <code>valid/</code>, <code>test/</code> è¿™æ ·çš„å­ç›®å½•ç»“æ„ã€‚</li></ul></li><li><strong>æ£€æŸ¥å¯¼å‡ºçš„æ–‡ä»¶:</strong><ul><li>è§£å‹ä¸‹è½½çš„ ZIP æ–‡ä»¶ã€‚</li><li>æ£€æŸ¥é‡Œé¢æ˜¯å¦å·²ç»åŒ…å«äº†ç±»ä¼¼ <code>train/</code> å’Œ <code>valid/</code> (æˆ– <code>val/</code>) çš„æ–‡ä»¶å¤¹ï¼Œæ¯ä¸ªæ–‡ä»¶å¤¹ä¸‹åˆåˆ†åˆ«æœ‰ <code>images/</code> å’Œ <code>labels/</code> å­ç›®å½•ã€‚</li><li>åŒæ—¶æ£€æŸ¥ <code>data.yaml</code> æ–‡ä»¶ï¼Œå®ƒåº”è¯¥å·²ç»è‡ªåŠ¨é…ç½®å¥½äº† <code>train:</code> å’Œ <code>val:</code> æŒ‡å‘è¿™äº›å¯¹åº”çš„æ–‡ä»¶å¤¹ï¼ˆä¾‹å¦‚ <code>train: train/images</code>, <code>val: valid/images</code>ï¼‰ã€‚</li><li>å¦‚æœå¯¼å‡ºæ–‡ä»¶å·²ç»æ˜¯è¿™ç§ç»“æ„ï¼Œé‚£ä¹ˆä½ <strong>ä¸éœ€è¦</strong>å†åšä»»ä½•äº‹æƒ…ï¼Œç›´æ¥ä½¿ç”¨è¿™ä¸ª <code>data.yaml</code> æ–‡ä»¶è¿›è¡Œè®­ç»ƒå³å¯ã€‚</li></ul></li></ol><p><strong>æ–¹æ³•äºŒï¼šæ‰‹åŠ¨åˆ’åˆ†å·²å¯¼å‡ºçš„æ•°æ®é›†</strong></p><p>å¦‚æœä½ ä» CVAT å¯¼å‡ºæ—¶æ²¡æœ‰åˆ’åˆ†å°å­é›†ï¼Œæˆ–è€…å¯¼å‡ºçš„æ ¼å¼æ²¡æœ‰è‡ªåŠ¨åŒºåˆ†ï¼Œé‚£ä¹ˆä½ åªæœ‰ä¸€ä¸ªåŒ…å«æ‰€æœ‰å›¾åƒå’Œæ ‡ç­¾çš„é›†åˆã€‚ä½ éœ€è¦æ‰‹åŠ¨å°†å…¶åˆ’åˆ†ä¸ºè®­ç»ƒé›†å’ŒéªŒè¯é›†ã€‚</p><ol><li><strong>ç¡®å®šåˆ’åˆ†æ¯”ä¾‹:</strong> æ ¹æ®ä½ çš„æ€»æ•°æ®é‡ï¼Œå†³å®šä¸€ä¸ªåˆé€‚çš„åˆ’åˆ†æ¯”ä¾‹ã€‚å¸¸è§çš„æ¯”ä¾‹æ˜¯ 80% è®­ç»ƒ / 20% éªŒè¯ï¼Œæˆ–è€… 70% / 30%ã€‚å¦‚æœæ•°æ®é‡å¾ˆå¤§ï¼ŒéªŒè¯é›†æ¯”ä¾‹å¯ä»¥é€‚å½“é™ä½ã€‚</li><li><strong>åˆ›å»ºç›®å½•ç»“æ„:</strong> åœ¨ä½ çš„æ•°æ®é›†æ ¹ç›®å½•ä¸‹ï¼ˆä¾‹å¦‚ <code>/home/user/my_dataset</code>ï¼‰ï¼Œåˆ›å»ºå¦‚ä¸‹ç»“æ„ï¼š<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">my_dataset/</span><br><span class="line">â”œâ”€â”€ train/</span><br><span class="line">â”‚   â”œâ”€â”€ images/</span><br><span class="line">â”‚   â””â”€â”€ labels/</span><br><span class="line">â”œâ”€â”€ valid/</span><br><span class="line">â”‚   â”œâ”€â”€ images/</span><br><span class="line">â”‚   â””â”€â”€ labels/</span><br><span class="line">â””â”€â”€ data.yaml  # ä½ éœ€è¦åˆ›å»ºæˆ–ä¿®æ”¹çš„æ–‡ä»¶</span><br></pre></td></tr></table></figure>ï¼ˆå¯èƒ½è¿˜éœ€è¦ä¿ç•™åŸå§‹çš„ <code>images/</code> å’Œ <code>labels/</code> æ–‡ä»¶å¤¹ï¼Œæˆ–è€…ç›´æ¥ä»é‚£é‡Œç§»åŠ¨æ–‡ä»¶ï¼‰ã€‚</li><li><strong>ç¼–å†™è„šæœ¬æˆ–æ‰‹åŠ¨ç§»åŠ¨æ–‡ä»¶ (æ¨èè„šæœ¬):</strong><ul><li><strong>æ ¸å¿ƒåŸåˆ™:</strong> å¿…é¡»ä¿è¯<strong>åŒä¸€å¼ å›¾ç‰‡</strong> (<code>.jpg</code>, <code>.png</code> ç­‰) å’Œå…¶<strong>å¯¹åº”çš„æ ‡æ³¨æ–‡ä»¶</strong> (<code>.txt</code>) <strong>å§‹ç»ˆè¢«åˆ’åˆ†åˆ°åŒä¸€ä¸ªé›†åˆ</strong> (è¦ä¹ˆéƒ½åœ¨ <code>train</code>ï¼Œè¦ä¹ˆéƒ½åœ¨ <code>valid</code>)ã€‚æ–‡ä»¶åé€šå¸¸æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼ˆé™¤äº†æ‰©å±•åï¼‰ã€‚</li><li><strong>è„šæœ¬æ–¹æ³• (Python ç¤ºä¾‹):</strong></li></ul></li></ol><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">import</span> yaml  <span class="comment"># éœ€è¦å®‰è£… PyYAML: pip install pyyaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- é…ç½® ---</span></span><br><span class="line"><span class="comment"># ï¼ï¼ä¿®æ”¹è¿™é‡Œä¸ºä½ è§£å‹åçš„ CVAT å¯¼å‡ºæ•°æ®é›†çš„æ ¹ç›®å½•ï¼ï¼</span></span><br><span class="line"><span class="comment"># ä½¿ç”¨ Path å¯¹è±¡å¤„ç†è·¯å¾„</span></span><br><span class="line">dataset_root = Path(<span class="string">r&#x27;/Users/zg/Downloads/task_13&#x27;</span>).resolve() <span class="comment"># &lt;&lt;--- ä¿®æ”¹è¿™é‡Œï¼Œå¹¶ç¡®ä¿æ˜¯ç»å¯¹è·¯å¾„</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ï¼ï¼æŒ‡å®šä½ æƒ³è¦åˆ›å»ºçš„æ–°æ•°æ®é›†æ ¹ç›®å½•ï¼ˆå¦‚æœæƒ³åˆ†å¼€å­˜æ”¾ï¼‰ï¼ï¼</span></span><br><span class="line"><span class="comment"># å¦‚æœè®¾ä¸º Noneï¼Œåˆ™åœ¨åŸ dataset_root ä¸‹åˆ›å»º train/valid ç›®å½•</span></span><br><span class="line"><span class="comment"># ä½¿ç”¨ Path å¯¹è±¡å¤„ç†è·¯å¾„</span></span><br><span class="line">output_root = dataset_root <span class="comment"># &lt;&lt;--- å¯ä»¥ä¿®æ”¹ä¸ºæ–°çš„è·¯å¾„ï¼Œä¾‹å¦‚ Path(&#x27;./yolov8_dataset&#x27;).resolve()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ Path å¯¹è±¡å®šä¹‰æºè·¯å¾„</span></span><br><span class="line">source_data_dir = dataset_root / <span class="string">&#x27;obj_train_data&#x27;</span> <span class="comment"># åŒ…å«å›¾åƒå’Œæ ‡ç­¾çš„æºæ–‡ä»¶å¤¹</span></span><br><span class="line">obj_names_file = dataset_root / <span class="string">&#x27;obj.names&#x27;</span>       <span class="comment"># ç±»åˆ«åç§°æ–‡ä»¶</span></span><br><span class="line">train_txt_file = dataset_root / <span class="string">&#x27;train.txt&#x27;</span>       <span class="comment"># åŸå§‹å›¾åƒåˆ—è¡¨æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line">train_ratio = <span class="number">0.8</span>  <span class="comment"># è®­ç»ƒé›†æ¯”ä¾‹ (ä¾‹å¦‚ 0.8 è¡¨ç¤º 80%)</span></span><br><span class="line">random_seed = <span class="number">42</span>   <span class="comment"># è®¾ç½®éšæœºç§å­ä»¥ä¿è¯æ¯æ¬¡åˆ’åˆ†ç»“æœä¸€è‡´ (å¯é€‰)</span></span><br><span class="line"><span class="comment"># ------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®éšæœºç§å­</span></span><br><span class="line"><span class="keyword">if</span> random_seed:</span><br><span class="line">    random.seed(random_seed)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- æ£€æŸ¥è¾“å…¥æ–‡ä»¶/ç›®å½•æ˜¯å¦å­˜åœ¨ ---</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> dataset_root.is_dir():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;é”™è¯¯ï¼šæ•°æ®é›†æ ¹ç›®å½•ä¸å­˜åœ¨: <span class="subst">&#123;dataset_root&#125;</span>&quot;</span>)</span><br><span class="line">    exit()</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> source_data_dir.is_dir():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;é”™è¯¯ï¼šæºæ•°æ®ç›®å½•ä¸å­˜åœ¨: <span class="subst">&#123;source_data_dir&#125;</span>&quot;</span>)</span><br><span class="line">    exit()</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> obj_names_file.is_file():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;é”™è¯¯ï¼šç±»åˆ«æ–‡ä»¶ä¸å­˜åœ¨: <span class="subst">&#123;obj_names_file&#125;</span>&quot;</span>)</span><br><span class="line">    exit()</span><br><span class="line"></span><br><span class="line">image_paths_from_txt = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> train_txt_file.is_file():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;è­¦å‘Šï¼šåŸå§‹ train.txt æ–‡ä»¶ä¸å­˜åœ¨: <span class="subst">&#123;train_txt_file&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;å°†å°è¯•ç›´æ¥æ‰«ææºæ•°æ®ç›®å½•ä¸­çš„å›¾åƒæ–‡ä»¶...&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># --- ä» train.txt è¯»å–å›¾åƒè·¯å¾„ ---</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;æ­£åœ¨ä» <span class="subst">&#123;train_txt_file&#125;</span> è¯»å–å›¾åƒè·¯å¾„...&quot;</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(train_txt_file, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="comment"># è¯»å–åŸå§‹è·¯å¾„è¡Œ</span></span><br><span class="line">            raw_paths = [line.strip() <span class="keyword">for</span> line <span class="keyword">in</span> f <span class="keyword">if</span> line.strip()]</span><br><span class="line"></span><br><span class="line">        image_paths_from_txt = []</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;æ­£åœ¨éªŒè¯ train.txt ä¸­çš„å›¾åƒè·¯å¾„...&quot;</span>)</span><br><span class="line">        processed_raw_paths_count = <span class="number">0</span> <span class="comment"># è®¡æ•°å™¨</span></span><br><span class="line">        <span class="keyword">for</span> raw_path <span class="keyword">in</span> raw_paths:</span><br><span class="line">            processed_raw_paths_count += <span class="number">1</span></span><br><span class="line">            <span class="comment"># --- ä¿®å¤é€»è¾‘å¼€å§‹ ---</span></span><br><span class="line">            <span class="comment"># 1. æå–æ–‡ä»¶å (ä¾‹å¦‚ &#x27;frame_000000.png&#x27;)</span></span><br><span class="line">            filename = Path(raw_path).name</span><br><span class="line">            <span class="comment"># 2. æ„å»ºé¢„æœŸåº”è¯¥å­˜åœ¨çš„è·¯å¾„ (åœ¨å·²çŸ¥çš„ source_data_dir ä¸‹)</span></span><br><span class="line">            <span class="comment">#    ä½¿ç”¨ resolve() ç¡®ä¿æ˜¯ç»å¯¹è·¯å¾„</span></span><br><span class="line">            expected_path = (source_data_dir / filename).resolve()</span><br><span class="line">            <span class="comment"># --- ä¿®å¤é€»è¾‘ç»“æŸ ---</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 3. éªŒè¯è¿™ä¸ªæ„å»ºå‡ºçš„é¢„æœŸè·¯å¾„æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">            <span class="keyword">if</span> expected_path.is_file():</span><br><span class="line">                image_paths_from_txt.append(expected_path) <span class="comment"># æ·»åŠ  *æ­£ç¡®ä¸”å­˜åœ¨çš„* è·¯å¾„</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># æ‰“å°æ›´å…·ä½“çš„è­¦å‘Šï¼Œæ˜¾ç¤ºåŸå§‹è¡Œå’Œå°è¯•æŸ¥æ‰¾çš„ä½ç½®</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;è­¦å‘Šï¼šåœ¨ <span class="subst">&#123;source_data_dir&#125;</span> ä¸­æ‰¾ä¸åˆ° train.txt è¡Œ &#x27;<span class="subst">&#123;raw_path&#125;</span>&#x27; å¯¹åº”çš„æ–‡ä»¶ &#x27;<span class="subst">&#123;filename&#125;</span>&#x27; (é¢„æœŸè·¯å¾„: <span class="subst">&#123;expected_path&#125;</span>)ï¼Œå°†è·³è¿‡ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;ä» <span class="subst">&#123;train_txt_file&#125;</span> åŸå§‹è¯»å– <span class="subst">&#123;<span class="built_in">len</span>(raw_paths)&#125;</span> è¡Œã€‚&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> image_paths_from_txt:</span><br><span class="line">             <span class="comment"># å¦‚æœä¿®æ­£åä»ç„¶æ²¡æœ‰æœ‰æ•ˆè·¯å¾„ï¼Œåˆ™è§¦å‘åå¤‡æ‰«æ</span></span><br><span class="line">             <span class="keyword">raise</span> ValueError(<span class="string">&quot;train.txt æ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœ‰æ•ˆä¸”å­˜åœ¨çš„å›¾åƒæ–‡ä»¶ã€‚&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;éªŒè¯åï¼Œæœ‰æ•ˆå›¾åƒè·¯å¾„æ•°é‡: <span class="subst">&#123;<span class="built_in">len</span>(image_paths_from_txt)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;å¤„ç† train.txt æ—¶å‡ºé”™: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;å°†å°è¯•ç›´æ¥æ‰«ææºæ•°æ®ç›®å½•ä¸­çš„å›¾åƒæ–‡ä»¶...&quot;</span>)</span><br><span class="line">        image_paths_from_txt = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- å¦‚æœæ— æ³•ä» train.txt è¯»å–æˆ–éªŒè¯å¤±è´¥ï¼Œåˆ™æ‰«æç›®å½• ---</span></span><br><span class="line"><span class="keyword">if</span> image_paths_from_txt <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;æ­£åœ¨æ‰«æç›®å½• <span class="subst">&#123;source_data_dir&#125;</span> ä¸­çš„å›¾åƒæ–‡ä»¶...&quot;</span>)</span><br><span class="line">    <span class="comment"># ç›´æ¥ä½¿ç”¨ source_data_dir (å·²ç»æ˜¯ Path å¯¹è±¡)</span></span><br><span class="line">    image_paths_from_dir = <span class="built_in">list</span>(source_data_dir.glob(<span class="string">&#x27;*.jpg&#x27;</span>)) + \</span><br><span class="line">                           <span class="built_in">list</span>(source_data_dir.glob(<span class="string">&#x27;*.png&#x27;</span>)) + \</span><br><span class="line">                           <span class="built_in">list</span>(source_data_dir.glob(<span class="string">&#x27;*.jpeg&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> image_paths_from_dir:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;é”™è¯¯ï¼šåœ¨ <span class="subst">&#123;source_data_dir&#125;</span> ä¸­æœªæ‰¾åˆ°ä»»ä½•å›¾åƒæ–‡ä»¶ã€‚&quot;</span>)</span><br><span class="line">        exit()</span><br><span class="line">    <span class="comment"># ç¡®ä¿è·¯å¾„æ˜¯ç»å¯¹è·¯å¾„</span></span><br><span class="line">    image_paths = [p.resolve() <span class="keyword">for</span> p <span class="keyword">in</span> image_paths_from_dir]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;åœ¨ç›®å½•ä¸­æ‰¾åˆ° <span class="subst">&#123;<span class="built_in">len</span>(image_paths)&#125;</span> ä¸ªå›¾åƒæ–‡ä»¶ã€‚&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># å¦‚æœä» train.txt æˆåŠŸè¯»å–å¹¶éªŒè¯äº†è·¯å¾„ï¼Œåˆ™ä½¿ç”¨è¿™ä¸ªåˆ—è¡¨</span></span><br><span class="line">    image_paths = image_paths_from_txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨ç»§ç»­ä¹‹å‰ï¼Œæœ€ç»ˆæ£€æŸ¥ image_paths æ˜¯å¦ä¸ºç©º</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> image_paths:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;é”™è¯¯ï¼šæœªèƒ½æ”¶é›†åˆ°ä»»ä½•æœ‰æ•ˆçš„å›¾åƒè·¯å¾„æ¥ç»§ç»­å¤„ç†ã€‚&quot;</span>)</span><br><span class="line">    exit()</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- è¯»å–ç±»åˆ«åç§° ---</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(obj_names_file, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        class_names = [line.strip() <span class="keyword">for</span> line <span class="keyword">in</span> f <span class="keyword">if</span> line.strip()]</span><br><span class="line">    num_classes = <span class="built_in">len</span>(class_names)</span><br><span class="line">    <span class="keyword">if</span> num_classes == <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;é”™è¯¯ï¼šç±»åˆ«æ–‡ä»¶ <span class="subst">&#123;obj_names_file&#125;</span> ä¸ºç©ºã€‚&quot;</span>)</span><br><span class="line">        exit()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;è¯»å–åˆ° <span class="subst">&#123;num_classes&#125;</span> ä¸ªç±»åˆ«: <span class="subst">&#123;class_names&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;è¯»å–ç±»åˆ«æ–‡ä»¶ <span class="subst">&#123;obj_names_file&#125;</span> æ—¶å‡ºé”™: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    exit()</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- åˆ›å»ºè¾“å‡ºç›®å½• ---</span></span><br><span class="line"><span class="comment"># ç¡®ä¿ output_root æ˜¯ Path å¯¹è±¡</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(output_root, Path):</span><br><span class="line">    output_root = Path(output_root).resolve()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ Path å¯¹è±¡å®šä¹‰ç›®æ ‡ç›®å½•</span></span><br><span class="line">train_img_dir = output_root / <span class="string">&#x27;train&#x27;</span> / <span class="string">&#x27;images&#x27;</span></span><br><span class="line">train_lbl_dir = output_root / <span class="string">&#x27;train&#x27;</span> / <span class="string">&#x27;labels&#x27;</span></span><br><span class="line">valid_img_dir = output_root / <span class="string">&#x27;valid&#x27;</span> / <span class="string">&#x27;images&#x27;</span></span><br><span class="line">valid_lbl_dir = output_root / <span class="string">&#x27;valid&#x27;</span> / <span class="string">&#x27;labels&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># exist_ok=True é¿å…ç›®å½•å·²å­˜åœ¨æ—¶æŠ¥é”™</span></span><br><span class="line">train_img_dir.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">train_lbl_dir.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">valid_img_dir.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">valid_lbl_dir.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- åˆ’åˆ†æ•°æ®é›† ---</span></span><br><span class="line"><span class="comment"># æ‰“ä¹±å›¾åƒè·¯å¾„åˆ—è¡¨ (Path å¯¹è±¡åˆ—è¡¨)</span></span><br><span class="line">random.shuffle(image_paths)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¡ç®—è®­ç»ƒé›†å’ŒéªŒè¯é›†çš„åˆ†å‰²ç‚¹</span></span><br><span class="line">split_index = <span class="built_in">int</span>(<span class="built_in">len</span>(image_paths) * train_ratio)</span><br><span class="line">train_image_paths = image_paths[:split_index]</span><br><span class="line">valid_image_paths = image_paths[split_index:]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;æ€»æœ‰æ•ˆå›¾åƒæ•°: <span class="subst">&#123;<span class="built_in">len</span>(image_paths)&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;åˆ’åˆ†åè®­ç»ƒé›†å›¾åƒæ•°: <span class="subst">&#123;<span class="built_in">len</span>(train_image_paths)&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;åˆ’åˆ†åéªŒè¯é›†å›¾åƒæ•°: <span class="subst">&#123;<span class="built_in">len</span>(valid_image_paths)&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- å¤åˆ¶æˆ–ç§»åŠ¨æ–‡ä»¶å‡½æ•° ---</span></span><br><span class="line"><span class="comment"># copy_mode=True å¤åˆ¶æ–‡ä»¶, copy_mode=False ç§»åŠ¨æ–‡ä»¶</span></span><br><span class="line">copy_mode = <span class="literal">True</span> <span class="comment"># å»ºè®®ä½¿ç”¨å¤åˆ¶ä»¥ä¿ç•™åŸå§‹æ•°æ®</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_files</span>(<span class="params">source_img_paths, target_img_dir, target_lbl_dir, copy=<span class="literal">True</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å°†æºå›¾åƒå’Œå¯¹åº”çš„æ ‡ç­¾æ–‡ä»¶å¤åˆ¶æˆ–ç§»åŠ¨åˆ°ç›®æ ‡ç›®å½•&quot;&quot;&quot;</span></span><br><span class="line">    processed_count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> img_path <span class="keyword">in</span> source_img_paths: <span class="comment"># img_path æ˜¯ Path å¯¹è±¡</span></span><br><span class="line">        <span class="comment"># æ„å»ºå¯¹åº”çš„æ ‡ç­¾æ–‡ä»¶è·¯å¾„ (.txt)ï¼Œæ ‡ç­¾æ–‡ä»¶åœ¨æºç›®å½• source_data_dir ä¸‹</span></span><br><span class="line">        <span class="comment"># ä½¿ç”¨ img_path.stem è·å–ä¸å¸¦æ‰©å±•åçš„æ–‡ä»¶å</span></span><br><span class="line">        lbl_path = source_data_dir / (img_path.stem + <span class="string">&#x27;.txt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ£€æŸ¥å›¾åƒå’Œæ ‡ç­¾æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="comment"># å›¾åƒè·¯å¾„ img_path å·²ç»éªŒè¯è¿‡å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> lbl_path.is_file():</span><br><span class="line">            <span class="comment"># ç›®æ ‡è·¯å¾„</span></span><br><span class="line">            target_img_path = target_img_dir / img_path.name</span><br><span class="line">            target_lbl_path = target_lbl_dir / lbl_path.name</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> copy:</span><br><span class="line">                    shutil.copy2(<span class="built_in">str</span>(img_path), <span class="built_in">str</span>(target_img_path)) <span class="comment"># copy2 æ¥æ”¶å­—ç¬¦ä¸²è·¯å¾„</span></span><br><span class="line">                    shutil.copy2(<span class="built_in">str</span>(lbl_path), <span class="built_in">str</span>(target_lbl_path))</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    shutil.move(<span class="built_in">str</span>(img_path), <span class="built_in">str</span>(target_img_path)) <span class="comment"># move æ¥æ”¶å­—ç¬¦ä¸²è·¯å¾„</span></span><br><span class="line">                    shutil.move(<span class="built_in">str</span>(lbl_path), <span class="built_in">str</span>(target_lbl_path))</span><br><span class="line">                processed_count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;å¤„ç†æ–‡ä»¶ <span class="subst">&#123;img_path.name&#125;</span> æ—¶å‡ºé”™: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># å›¾åƒæ–‡ä»¶åº”è¯¥å­˜åœ¨ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯ä»éªŒè¯è¿‡çš„åˆ—è¡¨å¤„ç†çš„</span></span><br><span class="line">            <span class="comment"># if not img_path.is_file():</span></span><br><span class="line">            <span class="comment">#      print(f&quot;è­¦å‘Šï¼šæ‰¾ä¸åˆ°å›¾åƒæ–‡ä»¶ &#123;img_path&#125;ï¼Œè·³è¿‡ã€‚&quot;)</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;è­¦å‘Šï¼šæ‰¾ä¸åˆ°å¯¹åº”çš„æ ‡ç­¾æ–‡ä»¶ <span class="subst">&#123;lbl_path&#125;</span>ï¼Œè·³è¿‡å›¾åƒ <span class="subst">&#123;img_path.name&#125;</span>ã€‚&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> processed_count</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- æ‰§è¡Œæ–‡ä»¶å¤„ç† ---</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;æ­£åœ¨<span class="subst">&#123;<span class="string">&#x27;å¤åˆ¶&#x27;</span> <span class="keyword">if</span> copy_mode <span class="keyword">else</span> <span class="string">&#x27;ç§»åŠ¨&#x27;</span>&#125;</span>è®­ç»ƒé›†æ–‡ä»¶...&quot;</span>)</span><br><span class="line">train_processed = process_files(train_image_paths, train_img_dir, train_lbl_dir, copy=copy_mode)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;æˆåŠŸå¤„ç† <span class="subst">&#123;train_processed&#125;</span> ä¸ªè®­ç»ƒé›†æ–‡ä»¶å¯¹ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;æ­£åœ¨<span class="subst">&#123;<span class="string">&#x27;å¤åˆ¶&#x27;</span> <span class="keyword">if</span> copy_mode <span class="keyword">else</span> <span class="string">&#x27;ç§»åŠ¨&#x27;</span>&#125;</span>éªŒè¯é›†æ–‡ä»¶...&quot;</span>)</span><br><span class="line">valid_processed = process_files(valid_image_paths, valid_img_dir, valid_lbl_dir, copy=copy_mode)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;æˆåŠŸå¤„ç† <span class="subst">&#123;valid_processed&#125;</span> ä¸ªéªŒè¯é›†æ–‡ä»¶å¯¹ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- ç”Ÿæˆ data.yaml æ–‡ä»¶ ---</span></span><br><span class="line">yaml_path = output_root / <span class="string">&#x27;data.yaml&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç›¸å¯¹äº output_root çš„è·¯å¾„</span></span><br><span class="line">yaml_data = &#123;</span><br><span class="line">    <span class="comment"># ä½¿ç”¨ resolve() è·å–ç»å¯¹è·¯å¾„å­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="string">&#x27;path&#x27;</span>: <span class="built_in">str</span>(output_root.resolve()),</span><br><span class="line">    <span class="comment"># ç›¸å¯¹è·¯å¾„æŒ‡å‘æ–°åˆ›å»ºçš„ç›®å½•</span></span><br><span class="line">    <span class="string">&#x27;train&#x27;</span>: <span class="string">&#x27;train/images&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;val&#x27;</span>: <span class="string">&#x27;valid/images&#x27;</span>,</span><br><span class="line">    <span class="comment"># &#x27;test&#x27;: &#x27;test/images&#x27;, # å¦‚æœæœ‰æµ‹è¯•é›†</span></span><br><span class="line">    <span class="string">&#x27;nc&#x27;</span>: num_classes,</span><br><span class="line">    <span class="string">&#x27;names&#x27;</span>: class_names</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(yaml_path, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        yaml.dump(yaml_data, f, sort_keys=<span class="literal">False</span>, default_flow_style=<span class="literal">False</span>) <span class="comment"># default_flow_style=False æ›´å¥½çœ‹</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;data.yaml æ–‡ä»¶å·²ç”Ÿæˆ: <span class="subst">&#123;yaml_path&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;å†…å®¹:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(yaml.dump(yaml_data, sort_keys=<span class="literal">False</span>, default_flow_style=<span class="literal">False</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;æ•°æ®é›†åˆ’åˆ†å®Œæˆï¼&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;ç”Ÿæˆ data.yaml æ–‡ä»¶æ—¶å‡ºé”™: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br></pre></td></tr></table></figure><ul><li><p>ä½ éœ€è¦æ ¹æ®ä½ çš„å®é™…æƒ…å†µä¿®æ”¹ <code>dataset_root</code>, <code>source_images_dir</code>, <code>source_labels_dir</code> å’Œ <code>train_ratio</code>ã€‚</p></li><li><p>è¿™ä¸ªè„šæœ¬ä¼šå°†æ–‡ä»¶<strong>ç§»åŠ¨</strong>åˆ°æ–°ç›®å½•ã€‚å¦‚æœä½ æƒ³ä¿ç•™åŸå§‹æ–‡ä»¶ï¼Œå¯ä»¥å°† <code>shutil.move</code> æ”¹ä¸º <code>shutil.copy</code>ã€‚</p></li><li><p><strong>æ‰‹åŠ¨æ–¹æ³• (ä»…é€‚ç”¨äºå°‘é‡æ•°æ®):</strong> åˆ›å»º <code>train</code> å’Œ <code>valid</code> å­ç›®å½•ï¼Œç„¶åæ‰‹åŠ¨å°†å›¾åƒå’Œå¯¹åº”çš„ <code>.txt</code> æ–‡ä»¶æ‹–æ‹½åˆ°ç›¸åº”çš„ <code>images</code> å’Œ <code>labels</code> æ–‡ä»¶å¤¹ä¸­ï¼Œç¡®ä¿æ¯”ä¾‹å¤§è‡´æ­£ç¡®ä¸”é…å¯¹æ— è¯¯ã€‚éå¸¸å®¹æ˜“å‡ºé”™ã€‚</p></li></ul><ol start="4"><li><strong>ä¿®æ”¹/åˆ›å»º <code>data.yaml</code> æ–‡ä»¶:</strong><ul><li>åœ¨ä½ æ‰‹åŠ¨åˆ›å»ºäº† <code>train/</code> å’Œ <code>valid/</code> ç›®å½•ç»“æ„åï¼Œä½ éœ€è¦åƒä¸‹é¢è¿™æ ·é…ç½® <code>data.yaml</code>ï¼š<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">path:</span> <span class="string">/home/user/my_dataset</span>   <span class="comment"># æ•°æ®é›†æ ¹ç›®å½•</span></span><br><span class="line"><span class="attr">train:</span> <span class="string">train/images</span>          <span class="comment"># æŒ‡å‘è®­ç»ƒå›¾åƒæ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="attr">val:</span> <span class="string">valid/images</span>            <span class="comment"># æŒ‡å‘éªŒè¯å›¾åƒæ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="comment"># test: test/images          # å¦‚æœæœ‰æµ‹è¯•é›†</span></span><br><span class="line"></span><br><span class="line"><span class="attr">nc:</span> <span class="number">3</span>                        <span class="comment"># ä½ çš„ç±»åˆ«æ•°é‡</span></span><br><span class="line"><span class="attr">names:</span> [<span class="string">&#x27;car&#x27;</span>, <span class="string">&#x27;person&#x27;</span>, <span class="string">&#x27;truck&#x27;</span>] <span class="comment"># ä½ çš„ç±»åˆ«åç§°åˆ—è¡¨</span></span><br></pre></td></tr></table></figure></li></ul></li></ol><p><strong>æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ <code>.txt</code> æ–‡ä»¶åˆ—è¡¨ (å¦‚æœä½ é€‰æ‹©äº†æ–¹æ¡ˆAæ¥åˆ›å»º<code>data.yaml</code>)</strong></p><p>å¦‚æœä½ æ˜¯æ ¹æ® <code>obj.data</code> æ–‡ä»¶ä¸­çš„ <code>train = .../train.txt</code> å’Œ <code>valid = .../valid.txt</code> æ¥é…ç½® <code>data.yaml</code> çš„ï¼Œé‚£ä¹ˆä½ éœ€è¦ç¡®ä¿ï¼š</p><ol><li><code>train.txt</code> æ–‡ä»¶ç¡®å®å­˜åœ¨ï¼Œå¹¶ä¸”é‡Œé¢åˆ—å‡ºäº†æ‰€æœ‰<strong>è®­ç»ƒé›†</strong>å›¾åƒçš„<strong>æ­£ç¡®è·¯å¾„</strong>ï¼ˆç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹äº <code>data.yaml</code> ä¸­ <code>path</code> çš„è·¯å¾„ï¼‰ã€‚</li><li>ä½ æœ‰ä¸€ä¸ªç±»ä¼¼çš„ <code>valid.txt</code> æ–‡ä»¶ï¼Œé‡Œé¢åˆ—å‡ºäº†æ‰€æœ‰<strong>éªŒè¯é›†</strong>å›¾åƒçš„<strong>æ­£ç¡®è·¯å¾„</strong>ã€‚</li><li><code>data.yaml</code> æ–‡ä»¶ä¸­çš„ <code>train:</code> å’Œ <code>val:</code> å­—æ®µæ­£ç¡®æŒ‡å‘äº†è¿™ä¸¤ä¸ª <code>.txt</code> æ–‡ä»¶ã€‚</li></ol><p>å¦‚æœä½ åªæœ‰ä¸€ä¸ªåŒ…å«æ‰€æœ‰å›¾åƒè·¯å¾„çš„ <code>.txt</code> æ–‡ä»¶ï¼Œä½ éœ€è¦åƒæ–¹æ³•äºŒä¸­åˆ’åˆ†æ–‡ä»¶ä¸€æ ·ï¼Œå°†è¿™ä¸ª <code>.txt</code> æ–‡ä»¶ä¹Ÿ<strong>åˆ’åˆ†æˆä¸¤ä¸ªæ–‡ä»¶</strong>ï¼š<code>train.txt</code> å’Œ <code>valid.txt</code>ï¼Œç¡®ä¿åˆ’åˆ†æ¯”ä¾‹åˆé€‚ã€‚</p><p><strong>æ€»ç»“:</strong></p><ul><li><strong>æœ€ä½³æ–¹å¼:</strong> åœ¨ CVAT ä¸­å°±ä½¿ç”¨ â€œSubsetâ€ åŠŸèƒ½åŒºåˆ†å¥½è®­ç»ƒé›†å’ŒéªŒè¯é›†ï¼Œç„¶åå¯¼å‡º <code>YOLO ZIP</code> æ ¼å¼ï¼Œé€šå¸¸ <code>data.yaml</code> å°±é…ç½®å¥½äº†ã€‚</li><li><strong>æ¬¡ä½³æ–¹å¼:</strong> å¦‚æœå¯¼å‡ºçš„æ•°æ®æœªåˆ’åˆ†ï¼Œä½¿ç”¨è„šæœ¬ï¼ˆå¦‚ä¸Šä¾‹ï¼‰å°†å…¶è‡ªåŠ¨åˆ’åˆ†ä¸º <code>train/</code> å’Œ <code>valid/</code> ç›®å½•ç»“æ„ï¼Œç„¶åç›¸åº”åœ°é…ç½® <code>data.yaml</code> æŒ‡å‘è¿™äº›ç›®å½•ã€‚</li><li><strong>å¦‚æœä¾èµ– <code>.txt</code> åˆ—è¡¨:</strong> ç¡®ä¿ä½ æœ‰åˆ†åˆ«åˆ—å‡ºè®­ç»ƒå›¾åƒå’ŒéªŒè¯å›¾åƒè·¯å¾„çš„ <code>train.txt</code> å’Œ <code>valid.txt</code> æ–‡ä»¶ï¼Œå¹¶åœ¨ <code>data.yaml</code> ä¸­æ­£ç¡®å¼•ç”¨å®ƒä»¬ã€‚</li></ul><p>æ— è®ºå“ªç§æ–¹æ³•ï¼Œæœ€ç»ˆç›®æ ‡éƒ½æ˜¯è¦æœ‰ä¸€ä¸ªæ˜ç¡®åŒºåˆ†çš„è®­ç»ƒæ•°æ®é›†å’Œä¸€ä¸ªéªŒè¯æ•°æ®é›†ï¼Œå¹¶ä¸” <code>data.yaml</code> æ–‡ä»¶èƒ½å¤Ÿå‡†ç¡®åœ°å‘Šè¯‰ YOLOv8 æ¡†æ¶å»å“ªé‡Œæ‰¾åˆ°å®ƒä»¬ã€‚</p><h3 id="è®­ç»ƒç»“æœ">è®­ç»ƒç»“æœ</h3><p><img src="/2025/04/09/yolov8-train-model/gpu_train_model.png" class="lazyload placeholder" data-srcset="/2025/04/09/yolov8-train-model/gpu_train_model.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">python train_model.py </span><br><span class="line">PyTorch device: cpu</span><br><span class="line">Ultralytics 8.3.105 ğŸš€ Python-3.12.3 torch-2.6.0+cu124 CPU (Intel Xeon E5-2690 v3 2.60GHz)</span><br><span class="line">engine/trainer: task=detect, mode=train, model=yolov8n.pt, data=/home/czq2/test_data/data.yaml, epochs=50, time=None, patience=100, batch=4, imgsz=640, save=True, save_period=-1, cache=False, device=cpu, workers=4, project=None, name=train2, exist_ok=False, pretrained=True, optimizer=auto, verbose=True, seed=0, deterministic=True, single_cls=False, rect=False, cos_lr=False, close_mosaic=10, resume=False, amp=True, fraction=1.0, profile=False, freeze=None, multi_scale=False, overlap_mask=True, mask_ratio=4, dropout=0.0, val=True, split=val, save_json=False, conf=None, iou=0.7, max_det=300, half=False, dnn=False, plots=True, source=None, vid_stride=1, stream_buffer=False, visualize=False, augment=False, agnostic_nms=False, classes=None, retina_masks=False, embed=None, show=False, save_frames=False, save_txt=False, save_conf=False, save_crop=False, show_labels=True, show_conf=True, show_boxes=True, line_width=None, format=torchscript, keras=False, optimize=False, int8=False, dynamic=False, simplify=True, opset=None, workspace=None, nms=False, lr0=0.01, lrf=0.01, momentum=0.937, weight_decay=0.0005, warmup_epochs=3.0, warmup_momentum=0.8, warmup_bias_lr=0.1, box=7.5, cls=0.5, dfl=1.5, pose=12.0, kobj=1.0, nbs=64, hsv_h=0.015, hsv_s=0.7, hsv_v=0.4, degrees=0.0, translate=0.1, scale=0.5, shear=0.0, perspective=0.0, flipud=0.0, fliplr=0.5, bgr=0.0, mosaic=1.0, mixup=0.0, copy_paste=0.0, copy_paste_mode=flip, auto_augment=randaugment, erasing=0.4, crop_fraction=1.0, cfg=None, tracker=botsort.yaml, save_dir=runs/detect/train2</span><br><span class="line">Downloading https://ultralytics.com/assets/Arial.Unicode.ttf to &#x27;/home/czq2/.config/Ultralytics/Arial.Unicode.ttf&#x27;...</span><br><span class="line"><span class="meta prompt_">100%</span><span class="language-bash">|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 22.2M/22.2M [00:01&lt;00:00, 21.2MB/s]</span></span><br><span class="line">Overriding model.yaml nc=80 with nc=4</span><br><span class="line"></span><br><span class="line">                   from  n    params  module                                       arguments                     </span><br><span class="line">  0                  -1  1       464  ultralytics.nn.modules.conv.Conv             [3, 16, 3, 2]                 </span><br><span class="line">  1                  -1  1      4672  ultralytics.nn.modules.conv.Conv             [16, 32, 3, 2]                </span><br><span class="line">  2                  -1  1      7360  ultralytics.nn.modules.block.C2f             [32, 32, 1, True]             </span><br><span class="line">  3                  -1  1     18560  ultralytics.nn.modules.conv.Conv             [32, 64, 3, 2]                </span><br><span class="line">  4                  -1  2     49664  ultralytics.nn.modules.block.C2f             [64, 64, 2, True]             </span><br><span class="line">  5                  -1  1     73984  ultralytics.nn.modules.conv.Conv             [64, 128, 3, 2]               </span><br><span class="line">  6                  -1  2    197632  ultralytics.nn.modules.block.C2f             [128, 128, 2, True]           </span><br><span class="line">  7                  -1  1    295424  ultralytics.nn.modules.conv.Conv             [128, 256, 3, 2]              </span><br><span class="line">  8                  -1  1    460288  ultralytics.nn.modules.block.C2f             [256, 256, 1, True]           </span><br><span class="line">  9                  -1  1    164608  ultralytics.nn.modules.block.SPPF            [256, 256, 5]                 </span><br><span class="line"> 10                  -1  1         0  torch.nn.modules.upsampling.Upsample         [None, 2, &#x27;nearest&#x27;]          </span><br><span class="line"> 11             [-1, 6]  1         0  ultralytics.nn.modules.conv.Concat           [1]                           </span><br><span class="line"> 12                  -1  1    148224  ultralytics.nn.modules.block.C2f             [384, 128, 1]                 </span><br><span class="line"> 13                  -1  1         0  torch.nn.modules.upsampling.Upsample         [None, 2, &#x27;nearest&#x27;]          </span><br><span class="line"> 14             [-1, 4]  1         0  ultralytics.nn.modules.conv.Concat           [1]                           </span><br><span class="line"> 15                  -1  1     37248  ultralytics.nn.modules.block.C2f             [192, 64, 1]                  </span><br><span class="line"> 16                  -1  1     36992  ultralytics.nn.modules.conv.Conv             [64, 64, 3, 2]                </span><br><span class="line"> 17            [-1, 12]  1         0  ultralytics.nn.modules.conv.Concat           [1]                           </span><br><span class="line"> 18                  -1  1    123648  ultralytics.nn.modules.block.C2f             [192, 128, 1]                 </span><br><span class="line"> 19                  -1  1    147712  ultralytics.nn.modules.conv.Conv             [128, 128, 3, 2]              </span><br><span class="line"> 20             [-1, 9]  1         0  ultralytics.nn.modules.conv.Concat           [1]                           </span><br><span class="line"> 21                  -1  1    493056  ultralytics.nn.modules.block.C2f             [384, 256, 1]                 </span><br><span class="line"> 22        [15, 18, 21]  1    752092  ultralytics.nn.modules.head.Detect           [4, [64, 128, 256]]           </span><br><span class="line">Model summary: 129 layers, 3,011,628 parameters, 3,011,612 gradients, 8.2 GFLOPs</span><br><span class="line"></span><br><span class="line">Transferred 319/355 items from pretrained weights</span><br><span class="line">Freezing layer &#x27;model.22.dfl.conv.weight&#x27;</span><br><span class="line">train: Scanning /home/czq2/test_data/train/labels... 495 images, 201 backgrounds, 0 corrupt: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 495/495 [00:14&lt;00:00, 34.44it/s]</span><br><span class="line">train: New cache created: /home/czq2/test_data/train/labels.cache</span><br><span class="line">val: Scanning /home/czq2/test_data/valid/labels... 124 images, 47 backgrounds, 0 corrupt: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 124/124 [00:03&lt;00:00, 37.91it/s]</span><br><span class="line">val: New cache created: /home/czq2/test_data/valid/labels.cache</span><br><span class="line">Plotting labels to runs/detect/train2/labels.jpg... </span><br><span class="line">/home/czq2/yolo_cpu_env/lib/python3.12/site-packages/ultralytics/utils/plotting.py:587: UserWarning: Glyph 35270 (\N&#123;CJK UNIFIED IDEOGRAPH-89C6&#125;) missing from font(s) DejaVu Sans.</span><br><span class="line">  plt.savefig(fname, dpi=200)</span><br><span class="line">/home/czq2/yolo_cpu_env/lib/python3.12/site-packages/ultralytics/utils/plotting.py:587: UserWarning: Glyph 39057 (\N&#123;CJK UNIFIED IDEOGRAPH-9891&#125;) missing from font(s) DejaVu Sans.</span><br><span class="line">optimizer: &#x27;optimizer=auto&#x27; found, ignoring &#x27;lr0=0.01&#x27; and &#x27;momentum=0.937&#x27; and determining best &#x27;optimizer&#x27;, &#x27;lr0&#x27; and &#x27;momentum&#x27; automatically... </span><br><span class="line">optimizer: AdamW(lr=0.00125, momentum=0.9) with parameter groups 57 weight(decay=0.0), 64 weight(decay=0.0005), 63 bias(decay=0.0)</span><br><span class="line">Image sizes 640 train, 640 val</span><br><span class="line">Using 0 dataloader workers</span><br><span class="line">Logging results to runs/detect/train2</span><br><span class="line">Starting training for 50 epochs...</span><br><span class="line"></span><br><span class="line">      Epoch    GPU_mem   box_loss   cls_loss   dfl_loss  Instances       Size</span><br><span class="line">       1/50         0G     0.6873      4.307      1.265          5        640:   2%|â–         | 2/124 [00:02&lt;02:20,  1.15s/it]Downloading https://ultralytics.com/assets/Arial.ttf to &#x27;/home/czq2/.config/Ultralytics/Arial.ttf&#x27;...</span><br><span class="line"><span class="meta prompt_">100%</span><span class="language-bash">|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 755k/755k [00:00&lt;00:00, 2.17MB/s]</span></span><br><span class="line">       1/50         0G      1.137      2.561      1.378          7        640: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 124/124 [02:08&lt;00:00,  1.03s/it]                   | 512k/755k [00:00&lt;00:00, 1.86MB/s]</span><br><span class="line">                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 16/16 [00:19&lt;00:00,  1.24s/it]</span><br><span class="line">                   all        124         77        0.7      0.948      0.802      0.538</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li><p>å‚æ•°å®šä¹‰</p></li><li><p>æˆ‘ä»¬æ¥è¯¦ç»†è§£é‡Šä¸€ä¸‹ YOLOv8 è®­ç»ƒè¿‡ç¨‹ä¸­è¿™ä¸€è¡Œè¾“å‡ºçš„å«ä¹‰ï¼š</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Epoch    GPU_mem   box_loss   cls_loss   dfl_loss  Instances       Size</span><br><span class="line">12/50         0G     0.8517     0.8027      1.157          4        640: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 124/124 [02:08&lt;00:00,  1.04s/it]</span><br></pre></td></tr></table></figure><p>å’Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class     Images  Instances      Box(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 16/16 [00:19&lt;00:00,  1.23s/it]</span><br><span class="line">  all        124         77          1      0.999      0.995      0.853</span><br></pre></td></tr></table></figure><p><strong>ç¬¬ä¸€éƒ¨åˆ†ï¼šè®­ç»ƒè¿›åº¦å’ŒæŸå¤± (Training Progress and Loss)</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Epoch    GPU_mem   box_loss   cls_loss   dfl_loss  Instances       Size</span><br><span class="line">12/50         0G     0.8517     0.8027      1.157          4        640: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 124/124 [02:08&lt;00:00,  1.04s/it]</span><br></pre></td></tr></table></figure><ul><li><strong><code>Epoch</code></strong>: <code>12/50</code><ul><li>è¡¨ç¤ºå½“å‰è®­ç»ƒæ­£åœ¨è¿›è¡Œç¬¬ <strong>12</strong> è½® (epoch)ï¼Œæ€»å…±è®¡åˆ’è®­ç»ƒ <strong>50</strong> è½®ã€‚ä¸€ä¸ª epoch æŒ‡çš„æ˜¯æ¨¡å‹å®Œæ•´åœ°çœ‹è¿‡ä¸€éæ‰€æœ‰çš„è®­ç»ƒæ•°æ®ã€‚</li></ul></li><li><strong><code>GPU_mem</code></strong>: <code>0G</code><ul><li>æ˜¾ç¤ºå½“å‰ <strong>GPU æ˜¾å­˜ (VRAM) çš„ä½¿ç”¨é‡</strong>ã€‚è¿™é‡Œæ˜¾ç¤º <code>0G</code> <strong>éå¸¸å¥‡æ€ª</strong>ï¼Œå°¤å…¶æ˜¯å¦‚æœä½ æŒ‡å®šäº†ä½¿ç”¨ GPU è¿›è¡Œè®­ç»ƒã€‚<ul><li><strong>å¯èƒ½çš„åŸå›  1 (æœ€å¯èƒ½):</strong> è®­ç»ƒå®é™…ä¸Šæ˜¯åœ¨ <strong>CPU</strong> ä¸Šè¿è¡Œçš„ï¼Œå³ä½¿ä½ å¯èƒ½æŒ‡å®šäº† <code>device=0</code> æˆ– <code>device='cuda'</code>ã€‚è¿™é€šå¸¸å‘ç”Ÿåœ¨ PyTorch æ— æ³•æ­£ç¡®æ£€æµ‹æˆ–ä½¿ç”¨ä½ çš„ GPU æ—¶ï¼ˆé©±åŠ¨ã€CUDAã€cuDNN æˆ– PyTorch ç‰ˆæœ¬é—®é¢˜ï¼‰ã€‚<strong>ä½ éœ€è¦å›è¿‡å¤´å»éªŒè¯ä½ çš„ GPU ç¯å¢ƒæ˜¯å¦é…ç½®æ­£ç¡®ï¼Œä»¥åŠ PyTorch æ˜¯å¦èƒ½çœŸæ­£ä½¿ç”¨ GPU (<code>torch.cuda.is_available()</code> å¿…é¡»ä¸º <code>True</code>)ã€‚</strong></li><li><strong>å¯èƒ½çš„åŸå›  2 (ä¸å¤ªå¯èƒ½):</strong> ä½ çš„æ¨¡å‹å’Œæ‰¹æ¬¡å¤§å°éå¸¸å°ï¼Œä»¥è‡³äºæ˜¾å­˜å ç”¨å¯ä»¥å¿½ç•¥ä¸è®¡ï¼ˆå¯¹äº YOLOv8 å°¤å…¶æ˜¯ <code>x</code> æ¨¡å‹å’Œ <code>batch=4</code> æ¥è¯´å‡ ä¹ä¸å¯èƒ½ï¼‰ã€‚</li><li><strong>å¯èƒ½çš„åŸå›  3 (æå°‘):</strong> ç›‘æ§æ˜¾å­˜çš„å·¥å…·æˆ–æ¥å£æš‚æ—¶å¤±æ•ˆã€‚</li></ul></li><li><strong>æ­£å¸¸çš„ GPU è®­ç»ƒ</strong> åº”è¯¥ä¼šæ˜¾ç¤ºä¸€ä¸ªéé›¶çš„æ˜¾å­˜ä½¿ç”¨å€¼ï¼Œä¾‹å¦‚ <code>5.8G</code>, <code>10.2G</code> ç­‰ï¼Œå…·ä½“å–å†³äºæ¨¡å‹å¤§å°ã€æ‰¹å¤§å°å’Œå›¾åƒå°ºå¯¸ã€‚</li></ul></li><li><strong><code>box_loss</code></strong>: <code>0.8517</code><ul><li><strong>è¾¹ç•Œæ¡†æŸå¤± (Bounding Box Loss)</strong>ã€‚è¿™ä¸ªå€¼è¡¡é‡çš„æ˜¯æ¨¡å‹é¢„æµ‹çš„è¾¹ç•Œæ¡†ä½ç½®/å¤§å°ä¸çœŸå®è¾¹ç•Œæ¡†ä¹‹é—´çš„å·®å¼‚ã€‚å€¼è¶Šä½è¶Šå¥½ã€‚</li></ul></li><li><strong><code>cls_loss</code></strong>: <code>0.8027</code><ul><li><strong>åˆ†ç±»æŸå¤± (Classification Loss)</strong>ã€‚è¿™ä¸ªå€¼è¡¡é‡çš„æ˜¯æ¨¡å‹é¢„æµ‹çš„ç‰©ä½“ç±»åˆ«ä¸çœŸå®ç±»åˆ«ä¹‹é—´çš„å·®å¼‚ã€‚å€¼è¶Šä½è¶Šå¥½ã€‚</li></ul></li><li><strong><code>dfl_loss</code></strong>: <code>1.157</code><ul><li><strong>åˆ†å¸ƒç„¦ç‚¹æŸå¤± (Distribution Focal Loss)</strong>ã€‚è¿™æ˜¯ YOLOv8ï¼ˆå°¤å…¶æ˜¯ v8 åŠæ›´æ–°ç‰ˆæœ¬ï¼‰å¼•å…¥çš„ä¸€ç§ç”¨äºè¾¹ç•Œæ¡†å›å½’çš„æŸå¤±ï¼Œå®ƒå°†è¾¹ç•Œæ¡†çš„è¿ç»­åæ ‡å›å½’é—®é¢˜è½¬åŒ–ä¸ºç¦»æ•£çš„æ¦‚ç‡åˆ†å¸ƒé¢„æµ‹é—®é¢˜ï¼Œæœ‰åŠ©äºæé«˜å®šä½ç²¾åº¦ã€‚å€¼è¶Šä½è¶Šå¥½ã€‚</li></ul></li><li><strong><code>Instances</code></strong>: <code>4</code><ul><li>å½“å‰æ­£åœ¨å¤„ç†çš„è¿™ä¸ªæ‰¹æ¬¡ (batch) ä¸­åŒ…å«çš„<strong>ç›®æ ‡å®ä¾‹ (objects) çš„æ•°é‡</strong>ã€‚è¿™é‡Œæ˜¯ 4 ä¸ªã€‚æ³¨æ„è¿™ä¸æ˜¯æ‰¹å¤§å°ï¼ˆbatch sizeï¼Œå³å›¾åƒæ•°é‡ï¼‰ã€‚</li></ul></li><li><strong><code>Size</code></strong>: <code>640</code><ul><li>è®­ç»ƒæ—¶è¾“å…¥æ¨¡å‹çš„<strong>å›¾åƒå°ºå¯¸</strong> (é€šå¸¸æ˜¯ height å’Œ width éƒ½è®¾ä¸ºè¿™ä¸ªå€¼ï¼Œå³ 640x640)ã€‚</li></ul></li><li><strong><code>100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 124/124 [02:08&lt;00:00, 1.04s/it]</code></strong>:<ul><li>è¿™æ˜¯ä¸€ä¸ª<strong>è¿›åº¦æ¡</strong>ï¼Œæ˜¾ç¤ºå½“å‰ epoch å†…è®­ç»ƒæ•°æ®çš„å¤„ç†è¿›åº¦ã€‚</li><li><code>100%</code>: è¡¨ç¤ºå½“å‰ epoch çš„è®­ç»ƒæ•°æ®å·²å…¨éƒ¨å¤„ç†å®Œæ¯•ã€‚</li><li><code>124/124</code>: è¡¨ç¤ºå½“å‰ epoch å…±å¤„ç†äº† 124 ä¸ªæ‰¹æ¬¡ (batches)ï¼Œç°åœ¨å·²ç»å®Œæˆäº†ç¬¬ 124 ä¸ªæ‰¹æ¬¡ã€‚ (æ€»æ‰¹æ¬¡æ•° = æ€»è®­ç»ƒå›¾åƒæ•° / batch_size)</li><li><code>[02:08&lt;00:00</code>]: å½“å‰ epoch å·²ç”¨æ—¶ 2 åˆ† 8 ç§’ï¼Œé¢„è®¡å‰©ä½™æ—¶é—´ 0 ç§’ã€‚</li><li><code>1.04s/it]</code>: å¤„ç†ä¸€ä¸ªæ‰¹æ¬¡ (iteration) å¹³å‡éœ€è¦ 1.04 ç§’ã€‚è¿™ä¸ªé€Ÿåº¦<strong>å¯¹äº GPU æ¥è¯´ç›¸å½“æ…¢</strong>ï¼Œè¿›ä¸€æ­¥å°è¯äº†å¯èƒ½æ˜¯åœ¨ CPU ä¸Šè¿è¡Œã€‚GPU è®­ç»ƒé€šå¸¸æ˜¯ <code>ms/it</code> (æ¯«ç§’æ¯è¿­ä»£)ã€‚</li></ul></li></ul><p><strong>ç¬¬äºŒéƒ¨åˆ†ï¼šéªŒè¯ç»“æœè¯„ä¼° (Validation Results Evaluation)</strong></p><p>è¿™éƒ¨åˆ†é€šå¸¸åœ¨æ¯ä¸ª epoch çš„è®­ç»ƒç»“æŸåï¼ˆæˆ–è€…æ ¹æ®è®¾ç½®çš„é¢‘ç‡ï¼‰è¿è¡Œï¼Œä½¿ç”¨éªŒè¯é›† (Validation Set) æ¥è¯„ä¼°å½“å‰æ¨¡å‹çš„æ€§èƒ½ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class     Images  Instances      Box(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 16/16 [00:19&lt;00:00,  1.23s/it]</span><br><span class="line">  all        124         77          1      0.999      0.995      0.853</span><br></pre></td></tr></table></figure><ul><li><strong><code>Class</code></strong>: <code>all</code><ul><li>è¡¨ç¤ºè¿™ä¸€è¡Œæ˜¾ç¤ºçš„æ˜¯<strong>æ‰€æœ‰ç±»åˆ«</strong>çš„å¹³å‡æ€§èƒ½æŒ‡æ ‡ã€‚å¦‚æœä½ çš„æ•°æ®é›†æœ‰å¤šä¸ªç±»åˆ«ï¼Œé€šå¸¸è¿˜ä¼šåœ¨è¿™é‡Œæˆ–ä¸‹é¢å‡ è¡Œåˆ—å‡ºæ¯ä¸ªå•ç‹¬ç±»åˆ«çš„æŒ‡æ ‡ã€‚</li></ul></li><li><strong><code>Images</code></strong>: <code>124</code><ul><li>ä½ çš„<strong>éªŒè¯é›†</strong>ä¸­åŒ…å« <strong>124</strong> å¼ å›¾åƒã€‚</li></ul></li><li><strong><code>Instances</code></strong>: <code>77</code><ul><li>ä½ çš„<strong>éªŒè¯é›†</strong>ä¸­æ‰€æœ‰å›¾åƒæ€»å…±åŒ…å« <strong>77</strong> ä¸ªå·²æ ‡æ³¨çš„ç›®æ ‡å®ä¾‹ã€‚</li></ul></li><li><strong><code>Box(P R mAP50 mAP50-95)</code></strong>: è¿™æ˜¯ç›®æ ‡æ£€æµ‹ä»»åŠ¡æœ€æ ¸å¿ƒçš„è¯„ä¼°æŒ‡æ ‡ï¼š<ul><li><strong><code>P</code> (Precision / ç²¾ç¡®ç‡):</strong> <code>1</code><ul><li>æŒ‡æ¨¡å‹é¢„æµ‹ä¸ºæ­£ä¾‹ï¼ˆæ£€æµ‹åˆ°ç‰©ä½“ï¼‰çš„æ ·æœ¬ä¸­ï¼Œ<strong>çœŸæ­£æ˜¯æ­£ä¾‹</strong>çš„æ¯”ä¾‹ã€‚è®¡ç®—å…¬å¼ï¼š<code>TP / (TP + FP)</code> (çœŸé˜³æ€§ / (çœŸé˜³æ€§ + å‡é˜³æ€§))ã€‚</li><li>å€¼ä¸º <code>1</code> æ„å‘³ç€æ‰€æœ‰æ¨¡å‹æ£€æµ‹åˆ°çš„ç‰©ä½“éƒ½æ˜¯æ­£ç¡®çš„ï¼ˆæ²¡æœ‰è¯¯æŠ¥ï¼‰ã€‚è¿™ä¸ªå€¼é€šå¸¸åœ¨ IoU (Intersection over Union) é˜ˆå€¼ä¸º 0.5 æ—¶è®¡ç®—ï¼Œå¹¶ä¸”å¯èƒ½æ˜¯é’ˆå¯¹æŸä¸ªæœ€ä¼˜ç½®ä¿¡åº¦é˜ˆå€¼å¾—å‡ºçš„ã€‚</li></ul></li><li><strong><code>R</code> (Recall / å¬å›ç‡):</strong> <code>0.999</code><ul><li>æŒ‡æ‰€æœ‰<strong>çœŸå®çš„</strong>æ­£ä¾‹ï¼ˆæ‰€æœ‰å®é™…å­˜åœ¨çš„ç‰©ä½“ï¼‰ä¸­ï¼Œè¢«æ¨¡å‹<strong>æˆåŠŸé¢„æµ‹å‡ºæ¥</strong>çš„æ¯”ä¾‹ã€‚è®¡ç®—å…¬å¼ï¼š<code>TP / (TP + FN)</code> (çœŸé˜³æ€§ / (çœŸé˜³æ€§ + å‡é˜´æ€§))ã€‚</li><li>å€¼ <code>0.999</code> æ„å‘³ç€æ¨¡å‹æ‰¾å›äº†éªŒè¯é›†ä¸­å‡ ä¹æ‰€æœ‰ï¼ˆ99.9%ï¼‰çš„çœŸå®ç‰©ä½“ï¼ˆæ¼æŠ¥éå¸¸å°‘ï¼‰ã€‚è¿™ä¸ªå€¼é€šå¸¸ä¹Ÿæ˜¯åœ¨ IoU é˜ˆå€¼ä¸º 0.5 æ—¶è®¡ç®—ï¼Œå¹¶ä¸”å¯èƒ½æ˜¯é’ˆå¯¹æŸä¸ªæœ€ä¼˜ç½®ä¿¡åº¦é˜ˆå€¼å¾—å‡ºçš„ã€‚</li></ul></li><li><strong><code>mAP50</code> (mean Average Precision @ IoU=0.5):</strong> <code>0.995</code><ul><li>IoU (äº¤å¹¶æ¯”) é˜ˆå€¼è®¾ç½®ä¸º 0.5 æ—¶ï¼Œè®¡ç®—æ‰€æœ‰ç±»åˆ«çš„å¹³å‡ç²¾åº¦ (Average Precision, AP)ï¼Œç„¶åå¯¹æ‰€æœ‰ç±»åˆ«æ±‚å¹³å‡å€¼ (mean AP)ã€‚AP æ˜¯ç»¼åˆäº†ç²¾ç¡®ç‡å’Œå¬å›ç‡çš„æŒ‡æ ‡ï¼Œå®ƒè¡¡é‡çš„æ˜¯ PR æ›²çº¿ä¸‹çš„é¢ç§¯ã€‚</li><li><code>0.995</code> æ˜¯ä¸€ä¸ªéå¸¸é«˜çš„å€¼ï¼Œè¡¨ç¤ºåœ¨ IoU=0.5 çš„æ ‡å‡†ä¸‹ï¼Œæ¨¡å‹æ€§èƒ½éå¸¸å¥½ã€‚</li></ul></li><li><strong><code>mAP50-95</code> (mean Average Precision @ IoU=0.5:0.95):</strong> <code>0.853</code><ul><li>è¿™æ˜¯æ›´ä¸¥æ ¼ã€ä¹Ÿæ˜¯ COCO æ•°æ®é›†ç«èµ›ç­‰åœºæ™¯ä¸­æ›´å¸¸ç”¨çš„æ ‡å‡†ã€‚å®ƒè®¡ç®—äº† IoU é˜ˆå€¼ä» 0.5 åˆ° 0.95ã€æ­¥é•¿ä¸º 0.05 çš„ä¸€ç³»åˆ— IoU å€¼ä¸‹çš„ mAPï¼Œç„¶åå¯¹è¿™äº› mAP æ±‚å¹³å‡ã€‚</li><li>è¿™ä¸ªæŒ‡æ ‡å¯¹æ£€æµ‹æ¡†çš„å®šä½ç²¾åº¦è¦æ±‚æ›´é«˜ã€‚<code>0.853</code> (å³ 85.3%) æ˜¯ä¸€ä¸ªç›¸å½“ä¸é”™çš„æ€§èƒ½ï¼Œè¡¨æ˜æ¨¡å‹ä¸ä»…èƒ½æ£€æµ‹åˆ°ç‰©ä½“ï¼Œè€Œä¸”å®šä½ä¹Ÿæ¯”è¾ƒå‡†ç¡®ã€‚</li></ul></li></ul></li><li><strong><code>100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 16/16 [00:19&lt;00:00, 1.23s/it]</code></strong>:<ul><li>è¿™æ˜¯<strong>éªŒè¯è¿‡ç¨‹</strong>çš„è¿›åº¦æ¡ã€‚</li><li><code>16/16</code>: è¡¨ç¤ºéªŒè¯é›†è¢«åˆ†æˆäº† 16 ä¸ªæ‰¹æ¬¡è¿›è¡Œå¤„ç†ï¼Œç°åœ¨å·²ç»å¤„ç†å®Œäº†ã€‚ (éªŒè¯æ‰¹æ¬¡æ•° = æ€»éªŒè¯å›¾åƒæ•° / éªŒè¯æ‰¹å¤§å°ï¼ŒéªŒè¯æ‰¹å¤§å°å¯èƒ½ä¸è®­ç»ƒæ‰¹å¤§å°ä¸åŒ)ã€‚</li><li><code>[00:19&lt;00:00</code>]: æ•´ä¸ªéªŒè¯è¿‡ç¨‹ç”¨æ—¶ 19 ç§’ã€‚</li><li><code>1.23s/it]</code>: å¤„ç†ä¸€ä¸ªéªŒè¯æ‰¹æ¬¡å¹³å‡éœ€è¦ 1.23 ç§’ã€‚è¿™ä¸ªé€Ÿåº¦åŒæ ·è¯´æ˜å¾ˆå¯èƒ½æ˜¯åœ¨ CPU ä¸Šè¿è¡Œã€‚</li></ul></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nuclioä¸CVATä½¿ç”¨yolov8ç›®æ ‡æ£€æµ‹æ¨¡å‹å®ç°åŠè‡ªåŠ¨åŒ–æ ‡æ³¨</title>
      <link href="/2025/04/07/nuclio-build-use/"/>
      <url>/2025/04/07/nuclio-build-use/</url>
      
        <content type="html"><![CDATA[<blockquote><p>Nuclio Dashboard æ˜¯ Nuclio Serverless å¹³å°çš„ä¸€ä¸ªåŸºäº Web çš„å›¾å½¢ç”¨æˆ·ç•Œé¢ï¼ˆGUIï¼‰ï¼Œå®ƒå…è®¸ç”¨æˆ·æ–¹ä¾¿åœ°ç®¡ç†ï¼ˆåˆ›å»ºã€æŸ¥çœ‹ã€ç¼–è¾‘ã€åˆ é™¤ã€éƒ¨ç½²ï¼‰Nuclio å‡½æ•°ã€é¡¹ç›®ã€äº‹ä»¶æºï¼ˆTriggersï¼‰ç­‰èµ„æºã€‚</p></blockquote><p><strong>æ ¸å¿ƒæ¦‚å¿µï¼š</strong></p><ol><li><p><strong>éƒ¨ç½² (Deployment) vs æ„å»º (Building from Source):</strong></p><ul><li><strong>éƒ¨ç½²:</strong> å¯¹äºå¤§å¤šæ•°ç”¨æˆ·æ¥è¯´ï¼Œâ€œæ„å»ºâ€ Nuclio Dashboard æ„å‘³ç€<strong>éƒ¨ç½²</strong>é¢„å…ˆæ„å»ºå¥½çš„ Docker é•œåƒã€‚è¿™æ˜¯æœ€å¸¸è§å’Œæ¨èçš„æ–¹å¼ã€‚ä½ ä¸éœ€è¦ä»æºä»£ç ç¼–è¯‘å®ƒã€‚</li><li><strong>ä»æºç æ„å»º:</strong> è¿™æ˜¯æŒ‡è·å– Nuclio Dashboard çš„æºä»£ç å¹¶è‡ªè¡Œç¼–è¯‘ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶æˆ– Docker é•œåƒã€‚è¿™é€šå¸¸åªåœ¨å¼€å‘ Nuclio æœ¬èº«æˆ–éœ€è¦ç‰¹æ®Šå®šåˆ¶æ—¶æ‰éœ€è¦ï¼Œå¯¹äºæ™®é€šç”¨æˆ·ä¸æ¨èã€‚</li></ul></li><li><p><strong>è¿è¡Œç¯å¢ƒ:</strong> Nuclioï¼ˆåŠå…¶ Dashboardï¼‰å¯ä»¥åœ¨å¤šç§ç¯å¢ƒä¸­è¿è¡Œï¼Œæœ€å¸¸è§çš„æ˜¯ï¼š</p><ul><li><strong>Standalone Docker:</strong> åœ¨å•ä¸ª Docker ä¸»æœºä¸Šè¿è¡Œã€‚</li><li><strong>Kubernetes:</strong> åœ¨ Kubernetes é›†ç¾¤ä¸­è¿è¡Œï¼Œè¿™æ˜¯ç”Ÿäº§ç¯å¢ƒä¸­æœ€å¸¸è§çš„æ–¹å¼ã€‚</li></ul></li></ol><p><strong>éƒ¨ç½²</strong> Nuclio Dashboard çš„æ–¹æ³•ä»¥åŠå¦‚ä½•<strong>ä½¿ç”¨</strong>å®ƒã€‚</p><hr><h3 id="ä¸€ã€éƒ¨ç½²-Nuclio-Dashboard">ä¸€ã€éƒ¨ç½² Nuclio Dashboard</h3><p>Nuclio Dashboard é€šå¸¸ä¸ Nuclio Controller ä¸€èµ·éƒ¨ç½²ã€‚Controller æ˜¯ Nuclio çš„æ ¸å¿ƒæ§åˆ¶å¹³é¢ï¼Œè€Œ Dashboard æ˜¯å…¶ UIã€‚</p><p><strong>æ–¹æ³•ä¸€ï¼šåœ¨ Standalone Docker ç¯å¢ƒä¸­éƒ¨ç½²</strong></p><p>è¿™æ˜¯æœ€ç®€å•çš„æ–¹æ³•ï¼Œé€‚åˆæœ¬åœ°æµ‹è¯•å’Œå¼€å‘ã€‚é€šå¸¸ï¼Œå½“ä½ è¿è¡Œ Nuclio Controller å®¹å™¨æ—¶ï¼Œå®ƒå·²ç»åŒ…å«äº† Dashboardã€‚</p><ol><li><p><strong>æ‹‰å–å¹¶è¿è¡Œ Nuclio Controller é•œåƒ:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8070:8070 -v /var/run/docker.sock:/var/run/docker.sock --name nuclio-dashboard quay.io/nuclio/dashboard:stable-amd64</span><br></pre></td></tr></table></figure><ul><li><code>-d</code>: åå°è¿è¡Œå®¹å™¨ã€‚</li><li><code>-p 8070:8070</code>: å°†ä¸»æœºçš„ 8070 ç«¯å£æ˜ å°„åˆ°å®¹å™¨çš„ 8070 ç«¯å£ï¼ˆNuclio Dashboard é»˜è®¤ç›‘å¬æ­¤ç«¯å£ï¼‰ã€‚</li><li><code>-v /var/run/docker.sock:/var/run/docker.sock</code>: å…è®¸ Nuclio Controller ä¸å®¿ä¸»æœºçš„ Dockerå®ˆæŠ¤è¿›ç¨‹é€šä¿¡ï¼Œä»¥ä¾¿æ„å»ºå’Œè¿è¡Œå‡½æ•°å®¹å™¨ã€‚<strong>ï¼ˆæ³¨æ„å®‰å…¨é£é™©ï¼‰</strong></li><li><code>-v /tmp:/tmp</code>: æä¾›ä¸´æ—¶æ–‡ä»¶å­˜å‚¨ã€‚</li><li><code>--name nuclio-controller</code>: ç»™å®¹å™¨å‘½åã€‚</li><li><code>nuclio/controller:stable</code>: ä½¿ç”¨çš„é•œåƒã€‚</li><li><code>--platform-kind &quot;local&quot;</code> æˆ– <code>&quot;docker&quot;</code>: æŒ‡å®šå¹³å°ç±»å‹ä¸ºæœ¬åœ° Docker ç¯å¢ƒã€‚</li></ul></li><li><p><strong>è®¿é—® Dashboard:</strong><br>éƒ¨ç½²æˆåŠŸåï¼Œåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ <code>http://&lt;ä½ çš„ä¸»æœºIP&gt;:8070</code> æˆ– <code>http://localhost:8070</code> å³å¯è®¿é—® Nuclio Dashboardã€‚</p></li></ol><p><strong>æ–¹æ³•äºŒï¼šåœ¨ Kubernetes ç¯å¢ƒä¸­éƒ¨ç½²</strong></p><p>è¿™æ˜¯åœ¨ç”Ÿäº§æˆ–é›†ç¾¤ç¯å¢ƒä¸­æœ€å¸¸ç”¨çš„æ–¹æ³•ã€‚æ¨èä½¿ç”¨ Helm Chart æ¥éƒ¨ç½² Nuclioã€‚</p><ol><li><p><strong>æ·»åŠ  Nuclio Helm ä»“åº“ (å¦‚æœå°šæœªæ·»åŠ ):</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm repo add nuclio https://nuclio.github.io/nuclio/charts</span><br><span class="line">helm repo update</span><br></pre></td></tr></table></figure></li><li><p><strong>å®‰è£… Nuclio Chart:</strong><br>è¿™å°†åŒæ—¶éƒ¨ç½² Nuclio Controllerï¼ˆåŒ…å« Dashboardï¼‰å’Œå…¶ä»–å¿…è¦çš„ç»„ä»¶ï¼ˆå¦‚ CRDsï¼‰ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ª namespace (æ¨è)</span></span><br><span class="line">kubectl create namespace nuclio</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ Helm å®‰è£…</span></span><br><span class="line">helm install nuclio nuclio/nuclio --namespace nuclio</span><br></pre></td></tr></table></figure><ul><li>ä½ å¯ä»¥é€šè¿‡åˆ›å»º <code>values.yaml</code> æ–‡ä»¶æˆ–ä½¿ç”¨ <code>--set</code> å‚æ•°æ¥è‡ªå®šä¹‰å®‰è£…é€‰é¡¹ï¼ˆä¾‹å¦‚ï¼ŒæŒ‡å®š Service ç±»å‹ã€èµ„æºé™åˆ¶ç­‰ï¼‰ã€‚</li></ul></li><li><p><strong>è®¿é—® Dashboard:</strong><br>éƒ¨ç½²åï¼Œéœ€è¦ä¸€ç§æ–¹å¼ä»é›†ç¾¤å¤–éƒ¨è®¿é—® Dashboard Serviceã€‚å¸¸ç”¨æ–¹æ³•æœ‰ï¼š</p><ul><li><strong>Port Forwarding (ç”¨äºä¸´æ—¶è®¿é—®/è°ƒè¯•):</strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰¾åˆ° Nuclio Dashboard Pod çš„åç§° (é€šå¸¸åŒ…å« &#x27;controller&#x27;)</span></span><br><span class="line">kubectl get pods -n nuclio</span><br><span class="line"><span class="comment"># å‡è®¾ pod åç§°ä¸º nuclio-controller-xxxxxxxxxx-yyyyy</span></span><br><span class="line">kubectl port-forward -n nuclio &lt;nuclio-controller-pod-name&gt; 8070:8070</span><br></pre></td></tr></table></figure>ç„¶ååœ¨æµè§ˆå™¨ä¸­è®¿é—® <code>http://localhost:8070</code>ã€‚</li><li><strong>LoadBalancer Service:</strong> å¦‚æœä½ çš„ Kubernetes é›†ç¾¤æ”¯æŒ LoadBalancer ç±»å‹çš„ Serviceï¼Œå¹¶ä¸”ä½ åœ¨ Helm å®‰è£…æ—¶é…ç½®äº† Dashboard Service ä¸º LoadBalancer ç±»å‹ï¼Œä½ å¯ä»¥è·å–å…¶å¤–éƒ¨ IP åœ°å€æ¥è®¿é—®ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc -n nuclio <span class="comment"># æŸ¥æ‰¾ dashboard service çš„ EXTERNAL-IP</span></span><br></pre></td></tr></table></figure>ç„¶ååœ¨æµè§ˆå™¨ä¸­è®¿é—® <code>http://&lt;EXTERNAL-IP&gt;:8070</code>ã€‚</li><li><strong>NodePort Service:</strong> å¦‚æœé…ç½®ä¸º NodePortï¼Œä½ å¯ä»¥é€šè¿‡ <code>http://&lt;ä»»æ„èŠ‚ç‚¹IP&gt;:&lt;NodePortç«¯å£&gt;</code> è®¿é—®ã€‚</li><li><strong>Ingress:</strong> é…ç½® Ingress èµ„æºï¼Œé€šè¿‡ Ingress Controller æä¾›çš„åŸŸåæˆ–è·¯å¾„æ¥è®¿é—® Dashboardã€‚è¿™æ˜¯ç”Ÿäº§ç¯å¢ƒä¸­æœ€æ¨èçš„æ–¹å¼ã€‚</li></ul></li></ol><p><img src="/2025/04/07/nuclio-build-use/nuclio_ui.png" class="lazyload placeholder" data-srcset="/2025/04/07/nuclio-build-use/nuclio_ui.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h3 id="äºŒã€ä½¿ç”¨-Nuclio-Dashboard">äºŒã€ä½¿ç”¨ Nuclio Dashboard</h3><p>å½“ä½ æˆåŠŸè®¿é—® Nuclio Dashboard åï¼Œä½ ä¼šçœ‹åˆ°ä¸€ä¸ªç”¨æˆ·å‹å¥½çš„ç•Œé¢ã€‚ä»¥ä¸‹æ˜¯ä¸»è¦åŠŸèƒ½åŒºåŸŸå’Œå¸¸è§æ“ä½œï¼š</p><ol><li><p><strong>æ¦‚è§ˆ (Overview / Dashboard):</strong></p><ul><li>é€šå¸¸æ˜¯è¿›å…¥åçš„é¦–é¡µï¼Œæ˜¾ç¤ºé¡¹ç›®å’Œå‡½æ•°çš„æ‘˜è¦ä¿¡æ¯ï¼Œä¾‹å¦‚æ€»æ•°ã€è¿è¡ŒçŠ¶æ€ç­‰ã€‚</li></ul></li><li><p><strong>é¡¹ç›® (Projects):</strong></p><ul><li>Nuclio ä½¿ç”¨é¡¹ç›®æ¥ç»„ç»‡å‡½æ•°ã€‚ä¸€ä¸ªé¡¹ç›®å¯ä»¥åŒ…å«å¤šä¸ªå‡½æ•°ã€‚</li><li><strong>åˆ›å»ºé¡¹ç›®:</strong> ç‚¹å‡» â€œNew Projectâ€ æˆ–ç±»ä¼¼æŒ‰é’®ï¼Œè¾“å…¥é¡¹ç›®åç§°å’Œå¯é€‰çš„æè¿°ã€æ ‡ç­¾ã€‚</li><li><strong>æŸ¥çœ‹é¡¹ç›®:</strong> ç‚¹å‡»é¡¹ç›®åç§°è¿›å…¥é¡¹ç›®è¯¦æƒ…é¡µï¼Œå¯ä»¥çœ‹åˆ°è¯¥é¡¹ç›®ä¸‹çš„æ‰€æœ‰å‡½æ•°ã€‚</li><li><strong>ç¼–è¾‘/åˆ é™¤é¡¹ç›®:</strong> åœ¨é¡¹ç›®åˆ—è¡¨æˆ–è¯¦æƒ…é¡µé€šå¸¸æœ‰ç¼–è¾‘å’Œåˆ é™¤çš„æ“ä½œæŒ‰é’®ã€‚</li></ul></li><li><p><strong>å‡½æ•° (Functions):</strong></p><ul><li>è¿™æ˜¯ Nuclio çš„æ ¸å¿ƒã€‚ä½ å¯ä»¥åœ¨é¡¹ç›®å†…éƒ¨åˆ›å»ºå’Œç®¡ç†å‡½æ•°ã€‚</li><li><strong>åˆ›å»ºå‡½æ•°:</strong><ul><li>è¿›å…¥ä¸€ä¸ªé¡¹ç›®ï¼Œç‚¹å‡» â€œNew Functionâ€ æˆ– â€œCreate Functionâ€ã€‚</li><li><strong>æ¨¡æ¿é€‰æ‹©:</strong> ä½ å¯ä»¥é€‰æ‹©ä¸€ä¸ªé¢„å®šä¹‰çš„æ¨¡æ¿ï¼ˆä¾‹å¦‚ï¼ŒGo çš„ HTTP å¤„ç†ã€Python çš„äº‹ä»¶å¤„ç†ç­‰ï¼‰ï¼Œæˆ–è€…ä»å¤´å¼€å§‹ã€‚</li><li><strong>é…ç½®:</strong><ul><li><strong>Function Name:</strong> å‡½æ•°çš„å”¯ä¸€åç§°ã€‚</li><li><strong>Description/Labels:</strong> å¯é€‰çš„æè¿°å’Œæ ‡ç­¾ã€‚</li><li><strong>Runtime:</strong> é€‰æ‹©å‡½æ•°çš„è¿è¡Œæ—¶è¯­è¨€ï¼ˆGo, Python, Node.js, Java, .NET Core, Shell, Binaryï¼‰ã€‚</li><li><strong>Source Code:</strong><ul><li><strong>Inline Editor:</strong> ç›´æ¥åœ¨ Web ç¼–è¾‘å™¨ä¸­ç¼–å†™ä»£ç ã€‚</li><li><strong>Upload:</strong> ä¸Šä¼ ä»£ç æ–‡ä»¶æˆ–å‹ç¼©åŒ… (zip, jar)ã€‚</li><li><strong>Git Repository:</strong> ä» Git ä»“åº“æ‹‰å–ä»£ç ï¼ˆéœ€è¦é…ç½®ï¼‰ã€‚</li><li><strong>Image:</strong> ä½¿ç”¨ä¸€ä¸ªå·²ç»åŒ…å«å‡½æ•°ä»£ç å’Œä¾èµ–çš„ Docker é•œåƒã€‚</li></ul></li><li><strong>Handler:</strong> æŒ‡å®šå‡½æ•°å…¥å£ç‚¹ï¼ˆä¾‹å¦‚ï¼ŒPython æ–‡ä»¶å:å‡½æ•°åï¼Œ<code>main:handler</code>ï¼‰ã€‚</li><li><strong>Dependencies:</strong> å¦‚æœä»£ç æœ‰å¤–éƒ¨ä¾èµ–ï¼Œéœ€è¦åœ¨è¿™é‡ŒæŒ‡å®šï¼ˆä¾‹å¦‚ï¼ŒPython çš„ <code>requirements.txt</code> å†…å®¹ï¼ŒGo çš„ <code>go.mod</code> ç­‰ï¼‰ã€‚Nuclio ä¼šåœ¨æ„å»ºè¿‡ç¨‹ä¸­å®‰è£…å®ƒä»¬ã€‚</li><li><strong>Triggers:</strong> é…ç½®è§¦å‘å‡½æ•°çš„æ–¹å¼ã€‚æœ€å¸¸è§çš„æ˜¯ <code>http</code>ï¼ˆé€šè¿‡ HTTP è¯·æ±‚è§¦å‘ï¼‰ï¼Œä½†ä¹Ÿæ”¯æŒ Kafka, Kinesis, RabbitMQ, Cron (å®šæ—¶ä»»åŠ¡) ç­‰å¤šç§äº‹ä»¶æºã€‚éœ€è¦é…ç½®è§¦å‘å™¨çš„è¯¦ç»†ä¿¡æ¯ï¼ˆå¦‚ HTTP è·¯å¾„ã€æ–¹æ³•ï¼ŒKafka ä¸»é¢˜ç­‰ï¼‰ã€‚</li><li><strong>Environment Variables:</strong> è®¾ç½®å‡½æ•°è¿è¡Œæ—¶å¯ä»¥è®¿é—®çš„ç¯å¢ƒå˜é‡ã€‚</li><li><strong>Volumes:</strong> (Kubernetes ç¯å¢ƒ) æŒ‚è½½å­˜å‚¨å·åˆ°å‡½æ•° Podã€‚</li><li><strong>Resources:</strong> é…ç½®å‡½æ•°çš„èµ„æºè¯·æ±‚å’Œé™åˆ¶ï¼ˆCPU, Memoryï¼‰ã€‚</li><li><strong>Scaling:</strong> é…ç½®è‡ªåŠ¨ä¼¸ç¼©å‚æ•°ï¼ˆæœ€å°/æœ€å¤§å‰¯æœ¬æ•°ï¼Œç›®æ ‡ CPU ä½¿ç”¨ç‡ç­‰ï¼‰ã€‚</li><li><strong>Build Settings:</strong> é…ç½®æ„å»ºè¿‡ç¨‹çš„å‚æ•°ï¼Œä¾‹å¦‚åŸºç¡€é•œåƒã€æ„å»ºå‘½ä»¤ç­‰ã€‚</li></ul></li></ul></li><li><strong>éƒ¨ç½²å‡½æ•°:</strong> é…ç½®å®Œæˆåï¼Œç‚¹å‡» â€œDeployâ€ æˆ– â€œCreateâ€ã€‚Nuclio Controller ä¼šå¼€å§‹æ„å»ºå‡½æ•°é•œåƒï¼ˆå¦‚æœéœ€è¦ï¼‰å¹¶å°†å…¶å®ä¾‹åŒ–ï¼ˆåœ¨ Docker ä¸­æ˜¯å¯åŠ¨å®¹å™¨ï¼Œåœ¨ Kubernetes ä¸­æ˜¯åˆ›å»º Deployment/Podï¼‰ã€‚éƒ¨ç½²çŠ¶æ€ä¼šæ˜¾ç¤ºåœ¨å‡½æ•°åˆ—è¡¨ä¸­ï¼ˆä¾‹å¦‚ï¼šBuilding, Ready, Errorï¼‰ã€‚</li><li><strong>æŸ¥çœ‹å‡½æ•°è¯¦æƒ…:</strong> ç‚¹å‡»å‡½æ•°åç§°è¿›å…¥è¯¦æƒ…é¡µã€‚<ul><li><strong>Code &amp; Configuration:</strong> æŸ¥çœ‹æˆ–ç¼–è¾‘å‡½æ•°çš„ä»£ç å’Œé…ç½®ã€‚</li><li><strong>Triggers:</strong> æŸ¥çœ‹è§¦å‘å™¨ä¿¡æ¯ï¼Œç‰¹åˆ«æ˜¯ HTTP è§¦å‘å™¨çš„è°ƒç”¨ URLã€‚</li><li><strong>Logs:</strong> æŸ¥çœ‹å‡½æ•°çš„å®æ—¶æˆ–å†å²æ—¥å¿—è¾“å‡ºã€‚</li><li><strong>Monitoring:</strong> æŸ¥çœ‹å‡½æ•°çš„è°ƒç”¨æ¬¡æ•°ã€å»¶è¿Ÿã€æˆåŠŸ/å¤±è´¥ç‡ç­‰æŒ‡æ ‡ï¼ˆå¯èƒ½éœ€è¦é›†æˆç›‘æ§ç³»ç»Ÿï¼‰ã€‚</li><li><strong>Versions:</strong> æŸ¥çœ‹å‡½æ•°çš„éƒ¨ç½²å†å²ç‰ˆæœ¬ã€‚</li></ul></li><li><strong>è°ƒç”¨/æµ‹è¯•å‡½æ•°:</strong> å¯¹äº HTTP è§¦å‘å™¨ï¼Œå¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨æˆ–ä½¿ç”¨ <code>curl</code> ç­‰å·¥å…·è®¿é—®å…¶ URL æ¥è°ƒç”¨å‡½æ•°ã€‚Dashboard æœ‰æ—¶ä¹Ÿæä¾›ç®€å•çš„è°ƒç”¨æµ‹è¯•ç•Œé¢ã€‚</li><li><strong>ç¼–è¾‘/åˆ é™¤å‡½æ•°:</strong> åœ¨å‡½æ•°åˆ—è¡¨æˆ–è¯¦æƒ…é¡µè¿›è¡Œæ“ä½œã€‚ç¼–è¾‘åéœ€è¦é‡æ–°éƒ¨ç½²æ‰èƒ½ç”Ÿæ•ˆã€‚</li></ul></li><li><p><strong>API Gateways:</strong> (å¦‚æœä½¿ç”¨äº† Nuclio çš„ API Gateway åŠŸèƒ½)</p><ul><li>ç”¨äºåˆ›å»ºå’Œç®¡ç† API ç½‘å…³ï¼Œå°†å¤–éƒ¨è¯·æ±‚è·¯ç”±åˆ°ä¸åŒçš„ Nuclio å‡½æ•°ã€‚</li><li>å¯ä»¥é…ç½®è·¯å¾„ã€æ–¹æ³•ã€è®¤è¯ã€é™æµç­‰ã€‚</li></ul></li><li><p><strong>è®¾ç½®/å¹³å°é…ç½® (Settings / Platform Configuration):</strong> (å¯èƒ½åœ¨æŸäº›ç‰ˆæœ¬æˆ–æ¨¡å¼ä¸‹å¯è§)</p><ul><li>æŸ¥çœ‹ Nuclio å¹³å°çš„é…ç½®ä¿¡æ¯ã€‚</li></ul></li></ol><h2 id="åŸºäºyolov8æ¨¡å‹éƒ¨ç½²å‡½æ•°è®¡ç®—åˆ°nuclio">åŸºäºyolov8æ¨¡å‹éƒ¨ç½²å‡½æ•°è®¡ç®—åˆ°nuclio</h2><h3 id="yml">yml</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">nuclio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Function</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yolov8-detector</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nuclio</span> <span class="comment"># Or your preferred namespace</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nuclio.io/project-name:</span> <span class="comment"># Add your project name if using Nuclio projects</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">description:</span> <span class="string">&quot;YOLOv8 Object Detection Function using model copied during build&quot;</span></span><br><span class="line">  <span class="attr">runtime:</span> <span class="string">python:3.9</span> <span class="comment"># Ensure this matches the Python version you need</span></span><br><span class="line">  <span class="attr">handler:</span> <span class="string">main:handler</span> <span class="comment"># Points to main.py -&gt; handler function</span></span><br><span class="line">  <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HTTP_PROXY</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">http://192.168.10.123:7890</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HTTPS_PROXY</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">http://192.168.10.123:7890</span> <span class="comment"># æˆ–è€… https://... å¦‚æœä»£ç†æœ¬èº«ç”¨https</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NO_PROXY</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">localhost,127.0.0.1,kubernetes.default.svc</span> <span class="comment"># æ·»åŠ å…¶ä»–å†…éƒ¨åœ°å€</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">.</span> <span class="comment"># Build context is still copied somewhere by Nuclio, just maybe not where expected.</span></span><br><span class="line">    <span class="attr">commands:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;apt-get update &amp;&amp; apt-get install -y --no-install-recommends libgl1-mesa-glx libglib2.0-0&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;pip install --default-timeout=600 --no-cache-dir torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;pip install -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple --default-timeout=600 --no-cache-dir ultralytics Pillow nuclio-sdk numpy&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ---- Runtime Configuration ----</span></span><br><span class="line">  <span class="comment"># (Optional but Recommended) Set resource limits, especially memory for large models</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">limits:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&quot;4Gi&quot;</span>   <span class="comment"># Adjust memory limit based on yolov8x needs (e.g., 4Gi, 6Gi, 8Gi)</span></span><br></pre></td></tr></table></figure><h3 id="python-code">python code</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> nuclio_sdk</span><br><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> YOLO</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init_context</span>(<span class="params">context: nuclio_sdk.Context</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åˆå§‹åŒ–å‡½æ•°ä¸Šä¸‹æ–‡ï¼ŒåŠ è½½æ¨¡å‹&quot;&quot;&quot;</span></span><br><span class="line">    context.logger.info(<span class="string">&quot;Initializing YOLOv8 model...&quot;</span>)</span><br><span class="line">    <span class="comment"># ä»å‡½æ•°å·¥ä½œç›®å½•åŠ è½½æ¨¡å‹æ–‡ä»¶ (å‡è®¾ .pt æ–‡ä»¶å’Œ main.py åœ¨åŒä¸€ç›®å½•)</span></span><br><span class="line">    <span class="comment"># æˆ–è€…æä¾›æ¨¡å‹çš„ç»å¯¹è·¯å¾„ï¼ˆå¦‚æœåœ¨ function.yaml ä¸­æŒ‚è½½äº†ï¼‰</span></span><br><span class="line">    model_path = <span class="string">&quot;/detect/yolov8/yolov8x.pt&quot;</span></span><br><span class="line">    model = YOLO(model_path)</span><br><span class="line">    context.user_data.model = model</span><br><span class="line">    context.logger.info(<span class="string">&quot;Model loaded successfully.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handler</span>(<span class="params">context: nuclio_sdk.Context, event: nuclio_sdk.Event</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¤„ç†è¾“å…¥çš„ HTTP è¯·æ±‚&quot;&quot;&quot;</span></span><br><span class="line">    context.logger.info(<span class="string">&quot;Received event.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ£€æŸ¥è¯·æ±‚ä½“ç±»å‹</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(event.body, <span class="built_in">bytes</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = json.loads(event.body.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            context.logger.error(<span class="string">f&quot;Failed to decode JSON body: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> context.Response(body=<span class="string">f&quot;Bad request: <span class="subst">&#123;e&#125;</span>&quot;</span>, status_code=<span class="number">400</span>)</span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">isinstance</span>(event.body, <span class="built_in">dict</span>):</span><br><span class="line">        data = event.body</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> context.Response(body=<span class="string">&quot;Unsupported event body type&quot;</span>, status_code=<span class="number">400</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä»è¯·æ±‚ä¸­è·å– base64 ç¼–ç çš„å›¾åƒæ•°æ®</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;image&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">        <span class="keyword">return</span> context.Response(body=<span class="string">&quot;Missing &#x27;image&#x27; field in request body&quot;</span>, status_code=<span class="number">400</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        image_b64 = data[<span class="string">&#x27;image&#x27;</span>]</span><br><span class="line">        image_bytes = base64.b64decode(image_b64)</span><br><span class="line">        image = Image.<span class="built_in">open</span>(io.BytesIO(image_bytes)).convert(<span class="string">&#x27;RGB&#x27;</span>) <span class="comment"># ç¡®ä¿æ˜¯ RGB</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        context.logger.error(<span class="string">f&quot;Failed to decode base64 image: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> context.Response(body=<span class="string">f&quot;Invalid image data: <span class="subst">&#123;e&#125;</span>&quot;</span>, status_code=<span class="number">400</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä½¿ç”¨åŠ è½½çš„æ¨¡å‹è¿›è¡Œé¢„æµ‹</span></span><br><span class="line">    context.logger.info(<span class="string">&quot;Performing inference...&quot;</span>)</span><br><span class="line">    model = context.user_data.model</span><br><span class="line">    results = model(image) <span class="comment"># results æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œé€šå¸¸åŒ…å«ä¸€ä¸ª Results å¯¹è±¡</span></span><br><span class="line">    context.logger.info(<span class="string">&quot;Inference complete.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¤„ç†é¢„æµ‹ç»“æœ</span></span><br><span class="line">    detections = []</span><br><span class="line">    <span class="keyword">if</span> results <span class="keyword">and</span> results[<span class="number">0</span>]:</span><br><span class="line">        result = results[<span class="number">0</span>] <span class="comment"># è·å–ç¬¬ä¸€ä¸ªå›¾åƒçš„ç»“æœ</span></span><br><span class="line">        boxes = result.boxes  <span class="comment"># Boxes object</span></span><br><span class="line">        names = result.names  <span class="comment"># Class names dict &#123;id: name&#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(boxes)):</span><br><span class="line">            box = boxes[i]</span><br><span class="line">            xyxy = box.xyxy.cpu().numpy().flatten().tolist() <span class="comment"># [x1, y1, x2, y2]</span></span><br><span class="line">            conf = <span class="built_in">float</span>(box.conf.cpu().numpy()) <span class="comment"># ç½®ä¿¡åº¦</span></span><br><span class="line">            cls_id = <span class="built_in">int</span>(box.cls.cpu().numpy())   <span class="comment"># ç±»åˆ« ID</span></span><br><span class="line">            label = names[cls_id]                 <span class="comment"># ç±»åˆ«åç§°</span></span><br><span class="line"></span><br><span class="line">            detections.append(&#123;</span><br><span class="line">                <span class="string">&quot;label&quot;</span>: label,</span><br><span class="line">                <span class="string">&quot;confidence&quot;</span>: conf,</span><br><span class="line">                <span class="comment"># CVAT é€šå¸¸éœ€è¦ [xtl, ytl, xbr, ybr] æ ¼å¼çš„æ•´æ•°åæ ‡</span></span><br><span class="line">                <span class="string">&quot;points&quot;</span>: [<span class="built_in">int</span>(xyxy[<span class="number">0</span>]), <span class="built_in">int</span>(xyxy[<span class="number">1</span>]), <span class="built_in">int</span>(xyxy[<span class="number">2</span>]), <span class="built_in">int</span>(xyxy[<span class="number">3</span>])]</span><br><span class="line">                <span class="comment"># æˆ–è€…æ ¹æ®éœ€è¦è¿”å›å½’ä¸€åŒ–åæ ‡æˆ–å…¶ä»–æ ¼å¼</span></span><br><span class="line">                <span class="comment"># &quot;xtl&quot;: xyxy[0], &quot;ytl&quot;: xyxy[1], &quot;xbr&quot;: xyxy[2], &quot;ybr&quot;: xyxy[3]</span></span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">    context.logger.info(<span class="string">f&quot;Detected <span class="subst">&#123;<span class="built_in">len</span>(detections)&#125;</span> objects.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¿”å› JSON æ ¼å¼çš„æ£€æµ‹ç»“æœ</span></span><br><span class="line">    <span class="keyword">return</span> context.Response(body=json.dumps(detections),</span><br><span class="line">                            content_type=<span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">                            status_code=<span class="number">200</span>)</span><br></pre></td></tr></table></figure><h2 id="web-http-è°ƒç”¨-yolov8æ¨¡å‹">web http è°ƒç”¨ yolov8æ¨¡å‹</h2><blockquote><p>å¯è¾“å‡º cvat v1.1æ ¼å¼çš„æ ‡æ³¨åxmlæ–‡ä»¶ï¼Œæ ¹æ®è¾“å…¥è§†é¢‘è¾“å‡ºç›®æ ‡æ£€æµ‹æ ‡æ³¨ç»“æœç”Ÿæˆä»£ç  è·å¾—æ ‡æ³¨ç»“æœå å‹ç¼©æ ‡æ³¨ç»“æœæ–‡ä»¶ å¯¼å…¥cvatå¯¹åº”é¡¹ç›®å¯¹åº”task</p></blockquote><ul><li>ä»£ç å¦‚ä¸‹ï¼š</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -</span></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta</span><br><span class="line"><span class="keyword">import</span> xml.etree.ElementTree <span class="keyword">as</span> ET</span><br><span class="line"><span class="keyword">from</span> xml.dom <span class="keyword">import</span> minidom <span class="comment"># ç”¨äºç¾åŒ–æ‰“å°XML</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- é…ç½®åŒº ---</span></span><br><span class="line">VIDEO_PATH = <span class="string">&quot;/Users/zg/PycharmProjects/CVAT_model_nuclio/src/run/data/1.mp4&quot;</span>  <span class="comment"># &lt;&lt;&lt;--- ä¿®æ”¹è¿™é‡Œ: ä½ çš„è§†é¢‘æ–‡ä»¶çš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">NUCLIO_FUNCTION_URL = <span class="string">&quot;http://192.168.10.158:32774&quot;</span> <span class="comment"># YOLOv8æ£€æµ‹å™¨çš„ç«¯å£</span></span><br><span class="line">OUTPUT_DIR = <span class="string">&quot;./data/&quot;</span>  <span class="comment"># è¾“å‡ºXMLæ–‡ä»¶çš„ç›®å½•</span></span><br><span class="line">LOG_FILE = <span class="string">&quot;./logs/video_processing_cvat_images_cn.log&quot;</span>  <span class="comment"># æ—¥å¿—æ–‡ä»¶å</span></span><br><span class="line">FRAME_SKIP = <span class="number">5</span>  <span class="comment"># å¤„ç†æ¯ N å¸§ (1 = å¤„ç†æ‰€æœ‰å¸§, 5 = æ¯5å¸§å¤„ç†1å¸§)</span></span><br><span class="line">REQUEST_TIMEOUT = <span class="number">30</span>  <span class="comment"># ç­‰å¾…Nuclioå“åº”çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæ—¥å¿—å’Œæ•°æ®ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰</span></span><br><span class="line">os.makedirs(<span class="string">&#x27;./logs/&#x27;</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">os.makedirs(OUTPUT_DIR, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- è®¾ç½®æ—¥å¿—è®°å½• ---</span></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    level=logging.INFO, <span class="comment"># æ—¥å¿—çº§åˆ«</span></span><br><span class="line">    <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(levelname)s - %(message)s&#x27;</span>, <span class="comment"># æ—¥å¿—æ ¼å¼</span></span><br><span class="line">    handlers=[</span><br><span class="line">        logging.FileHandler(LOG_FILE, encoding=<span class="string">&#x27;utf-8&#x27;</span>),  <span class="comment"># è¾“å‡ºæ—¥å¿—åˆ°æ–‡ä»¶ï¼Œä½¿ç”¨utf-8ç¼–ç </span></span><br><span class="line">        logging.StreamHandler()  <span class="comment"># åŒæ—¶è¾“å‡ºæ—¥å¿—åˆ°æ§åˆ¶å°</span></span><br><span class="line">    ]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- è¾…åŠ©å‡½æ•° ---</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode_frame_to_base64</span>(<span class="params">frame</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å°†OpenCVè¯»å–çš„å¸§(NumPyæ•°ç»„)ç¼–ç ä¸ºBase64å­—ç¬¦ä¸²ã€‚&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># å°†å¸§ç¼–ç ä¸ºå†…å­˜ä¸­çš„JPEGæ ¼å¼</span></span><br><span class="line">        is_success, buffer = cv2.imencode(<span class="string">&quot;.jpg&quot;</span>, frame)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> is_success:</span><br><span class="line">            logging.error(<span class="string">&quot;æ— æ³•å°†å¸§ç¼–ç ä¸ºJPEGã€‚&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="comment"># å°†å­—èŠ‚ç¼“å†²åŒºç¼–ç ä¸ºBase64å­—ç¬¦ä¸²</span></span><br><span class="line">        b64_string = base64.b64encode(buffer).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> b64_string</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;å¸§ç¼–ç è¿‡ç¨‹ä¸­å‡ºé”™: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">call_nuclio_detector</span>(<span class="params">base64_image_string, frame_number</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å°†Base64ç¼–ç çš„å›¾åƒå‘é€ç»™Nuclioå‡½æ•°å¹¶è¿”å›æ£€æµ‹ç»“æœã€‚&quot;&quot;&quot;</span></span><br><span class="line">    payload = json.dumps(&#123;<span class="string">&quot;image&quot;</span>: base64_image_string&#125;)</span><br><span class="line">    headers = &#123;<span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        start_time = time.time()</span><br><span class="line">        <span class="comment"># å‘é€POSTè¯·æ±‚</span></span><br><span class="line">        response = requests.post(NUCLIO_FUNCTION_URL, headers=headers, data=payload, timeout=REQUEST_TIMEOUT)</span><br><span class="line">        end_time = time.time()</span><br><span class="line">        logging.info(<span class="string">f&quot;å¸§ <span class="subst">&#123;frame_number&#125;</span>: Nuclioè¯·æ±‚è€—æ—¶ <span class="subst">&#123;end_time - start_time:<span class="number">.2</span>f&#125;</span> ç§’ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ£€æŸ¥å“åº”çŠ¶æ€ç </span></span><br><span class="line">        <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                detections = response.json()</span><br><span class="line">                <span class="comment"># éªŒè¯æ£€æµ‹ç»“æœçš„åŸºæœ¬ç»“æ„</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(detections, <span class="built_in">list</span>):</span><br><span class="line">                     logging.error(<span class="string">f&quot;å¸§ <span class="subst">&#123;frame_number&#125;</span>: Nuclioå“åº”ä¸æ˜¯åˆ—è¡¨ã€‚æ”¶åˆ°ç±»å‹: <span class="subst">&#123;<span class="built_in">type</span>(detections)&#125;</span>&quot;</span>)</span><br><span class="line">                     <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">                valid_detections = []</span><br><span class="line">                <span class="keyword">for</span> det <span class="keyword">in</span> detections:</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">isinstance</span>(det, <span class="built_in">dict</span>) <span class="keyword">and</span> <span class="string">&#x27;label&#x27;</span> <span class="keyword">in</span> det <span class="keyword">and</span> <span class="string">&#x27;points&#x27;</span> <span class="keyword">in</span> det <span class="keyword">and</span> <span class="string">&#x27;confidence&#x27;</span> <span class="keyword">in</span> det:</span><br><span class="line">                         <span class="keyword">if</span> <span class="built_in">isinstance</span>(det[<span class="string">&#x27;points&#x27;</span>], <span class="built_in">list</span>) <span class="keyword">and</span> <span class="built_in">len</span>(det[<span class="string">&#x27;points&#x27;</span>]) == <span class="number">4</span>:</span><br><span class="line">                              valid_detections.append(det)</span><br><span class="line">                         <span class="keyword">else</span>:</span><br><span class="line">                              logging.warning(<span class="string">f&quot;å¸§ <span class="subst">&#123;frame_number&#125;</span>: è·³è¿‡æ— æ•ˆ&#x27;points&#x27;çš„æ£€æµ‹ç»“æœ: <span class="subst">&#123;det.get(<span class="string">&#x27;points&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                         logging.warning(<span class="string">f&quot;å¸§ <span class="subst">&#123;frame_number&#125;</span>: è·³è¿‡ç¼ºå°‘é”®æˆ–ç±»å‹é”™è¯¯çš„æ£€æµ‹ç»“æœ: <span class="subst">&#123;det&#125;</span>&quot;</span>)</span><br><span class="line">                logging.info(<span class="string">f&quot;å¸§ <span class="subst">&#123;frame_number&#125;</span>: æ”¶åˆ° <span class="subst">&#123;<span class="built_in">len</span>(valid_detections)&#125;</span> ä¸ªæœ‰æ•ˆæ£€æµ‹ç»“æœã€‚&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> valid_detections</span><br><span class="line">            <span class="keyword">except</span> json.JSONDecodeError:</span><br><span class="line">                logging.error(<span class="string">f&quot;å¸§ <span class="subst">&#123;frame_number&#125;</span>: è§£æNuclioçš„JSONå“åº”å¤±è´¥ã€‚çŠ¶æ€ç : <span class="subst">&#123;response.status_code&#125;</span>, å“åº”ä½“(å‰200å­—ç¬¦): <span class="subst">&#123;response.text[:<span class="number">200</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e_val:</span><br><span class="line">                 logging.error(<span class="string">f&quot;å¸§ <span class="subst">&#123;frame_number&#125;</span>: éªŒè¯Nuclioå“åº”ç»“æ„æ—¶å‡ºé”™: <span class="subst">&#123;e_val&#125;</span>&quot;</span>)</span><br><span class="line">                 <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logging.error(<span class="string">f&quot;å¸§ <span class="subst">&#123;frame_number&#125;</span>: Nuclioå‡½æ•°è¿”å›é”™è¯¯ã€‚çŠ¶æ€ç : <span class="subst">&#123;response.status_code&#125;</span>, å“åº”ä½“(å‰200å­—ç¬¦): <span class="subst">&#123;response.text[:<span class="number">200</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.Timeout:</span><br><span class="line">        logging.error(<span class="string">f&quot;å¸§ <span class="subst">&#123;frame_number&#125;</span>: è¯·æ±‚Nuclioå‡½æ•°è¶…æ—¶ (<span class="subst">&#123;REQUEST_TIMEOUT&#125;</span>ç§’)ã€‚&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.RequestException <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;å¸§ <span class="subst">&#123;frame_number&#125;</span>: è¯·æ±‚Nuclioå‡½æ•°å¤±è´¥: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;å¸§ <span class="subst">&#123;frame_number&#125;</span>: è°ƒç”¨Nuclioæ—¶å‘ç”Ÿæ„å¤–é”™è¯¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- XML ç”Ÿæˆ ---</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pretty_print_xml</span>(<span class="params">elem</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è¿”å›åŒ…å«å£°æ˜ä¸”æ ¼å¼åŒ–ï¼ˆç¾åŒ–ï¼‰çš„XMLå­—ç¬¦ä¸²ã€‚&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># å°†ElementTreeå…ƒç´ è½¬æ¢ä¸ºutf-8å­—èŠ‚å­—ç¬¦ä¸²</span></span><br><span class="line">        rough_string = ET.tostring(elem, <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="comment"># ä½¿ç”¨minidomè§£æå­—èŠ‚å­—ç¬¦ä¸²</span></span><br><span class="line">        reparsed = minidom.parseString(rough_string)</span><br><span class="line">        <span class="comment"># ä½¿ç”¨toprettyxmlè¿›è¡Œæ ¼å¼åŒ–ï¼ŒåŒ…å«ç¼©è¿›å’ŒXMLå£°æ˜</span></span><br><span class="line">        <span class="comment"># ç¡®ä¿å®ƒè¿”å›utf-8ç¼–ç çš„å­—èŠ‚å­—ç¬¦ä¸²ï¼Œç„¶åè§£ç ä¸ºpythonå­—ç¬¦ä¸²</span></span><br><span class="line">        xml_str = reparsed.toprettyxml(indent=<span class="string">&quot;  &quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> xml_str</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;XMLç¾åŒ–æ‰“å°è¿‡ç¨‹ä¸­å‡ºé”™: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># è¿”å›Noneï¼Œè¡¨ç¤ºéœ€è¦è°ƒç”¨å‡½æ•°ä¸­çš„åå¤‡æ–¹æ¡ˆ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_results_to_cvat_image_xml</span>(<span class="params">all_results, xml_output_path, video_filename, frame_width, frame_height, total_processed_frames, original_total_frames</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å°†æ£€æµ‹ç»“æœä¿å­˜ä¸º CVAT XML 1.1 for Images æ ¼å¼ã€‚&quot;&quot;&quot;</span></span><br><span class="line">    logging.info(<span class="string">f&quot;æ­£åœ¨ä¸º <span class="subst">&#123;<span class="built_in">len</span>(all_results)&#125;</span> ä¸ªå¤„ç†è¿‡çš„å¸§æ„å»ºCVATå›¾åƒXMLè¾“å‡º...&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- æ„å»ºXMLç»“æ„ ---</span></span><br><span class="line">    root = ET.Element(<span class="string">&quot;annotations&quot;</span>)</span><br><span class="line">    ET.SubElement(root, <span class="string">&quot;version&quot;</span>).text = <span class="string">&quot;1.1&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Metaå…ƒä¿¡æ¯</span></span><br><span class="line">    meta = ET.SubElement(root, <span class="string">&quot;meta&quot;</span>)</span><br><span class="line">    task = ET.SubElement(meta, <span class="string">&quot;task&quot;</span>)</span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;id&quot;</span>).text = <span class="string">&quot;N/A&quot;</span> <span class="comment"># å ä½ç¬¦</span></span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;name&quot;</span>).text = video_filename <span class="comment"># ä½¿ç”¨è§†é¢‘åä½œä¸ºä»»åŠ¡å</span></span><br><span class="line">    <span class="comment"># æ³¨æ„: sizeåœ¨è¿™é‡Œè¡¨ç¤ºæ ‡æ³¨çš„å›¾åƒæ•°é‡ (å³å¤„ç†è¿‡çš„å¸§æ•°)</span></span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;size&quot;</span>).text = <span class="built_in">str</span>(total_processed_frames)</span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;mode&quot;</span>).text = <span class="string">&quot;annotation&quot;</span> <span class="comment"># æ¨¡å¼æ”¹ä¸º annotation (å›¾åƒæ¨¡å¼)</span></span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;overlap&quot;</span>).text = <span class="string">&quot;0&quot;</span></span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;bugtracker&quot;</span>).text = <span class="string">&quot;&quot;</span></span><br><span class="line">    current_time_utc = time.strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S.%f&quot;</span>)[:-<span class="number">3</span>] + <span class="string">&quot;+00:00&quot;</span> <span class="comment"># å½“å‰UTCæ—¶é—´</span></span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;created&quot;</span>).text = current_time_utc</span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;updated&quot;</span>).text = current_time_utc</span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;start_frame&quot;</span>).text = <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="comment"># stop_frameå¯¹åº”æœ€åä¸€å¸§çš„ç´¢å¼•(0-based)</span></span><br><span class="line">    <span class="comment"># æˆ‘ä»¬åŸºäºå¤„ç†è¿‡çš„å¸§æ¥è®¡ç®—ï¼Œæ‰¾åˆ°æœ€å¤§çš„å¸§å·</span></span><br><span class="line">    last_processed_frame_num = <span class="built_in">max</span>(all_results.keys()) <span class="keyword">if</span> all_results <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;stop_frame&quot;</span>).text = <span class="built_in">str</span>(last_processed_frame_num - <span class="number">1</span> <span class="keyword">if</span> last_processed_frame_num &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;frame_filter&quot;</span>).text = <span class="string">&quot;&quot;</span> <span class="comment"># å¦‚æœæœ‰è·³å¸§ï¼Œå¯ä»¥å†™åœ¨è¿™é‡Œï¼Œä½†é€šå¸¸å¯¼å…¥æ—¶ä¸éœ€è¦</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æå–å¹¶æ·»åŠ æ ‡ç­¾ä¿¡æ¯</span></span><br><span class="line">    labels = <span class="built_in">set</span>()</span><br><span class="line">    <span class="keyword">if</span> all_results:</span><br><span class="line">        <span class="keyword">for</span> frame_dets <span class="keyword">in</span> all_results.values():</span><br><span class="line">            <span class="keyword">if</span> frame_dets:</span><br><span class="line">                <span class="keyword">for</span> det <span class="keyword">in</span> frame_dets:</span><br><span class="line">                    labels.add(<span class="built_in">str</span>(det.get(<span class="string">&#x27;label&#x27;</span>, <span class="string">&#x27;unknown&#x27;</span>)))</span><br><span class="line"></span><br><span class="line">    labels_elem = ET.SubElement(task, <span class="string">&quot;labels&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> labels: <span class="comment"># å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°ä»»ä½•æ ‡ç­¾ï¼Œæ·»åŠ ä¸€ä¸ªé»˜è®¤æ ‡ç­¾</span></span><br><span class="line">        logging.warning(<span class="string">&quot;åœ¨æ£€æµ‹ç»“æœä¸­æœªæ‰¾åˆ°æ ‡ç­¾ï¼Œæ·»åŠ é»˜è®¤&#x27;unknown&#x27;æ ‡ç­¾ã€‚&quot;</span>)</span><br><span class="line">        labels.add(<span class="string">&#x27;unknown&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> label_name <span class="keyword">in</span> <span class="built_in">sorted</span>(<span class="built_in">list</span>(labels)):</span><br><span class="line">         label_elem = ET.SubElement(labels_elem, <span class="string">&quot;label&quot;</span>)</span><br><span class="line">         ET.SubElement(label_elem, <span class="string">&quot;name&quot;</span>).text = label_name</span><br><span class="line">         ET.SubElement(label_elem, <span class="string">&quot;color&quot;</span>).text = <span class="string">&quot;&quot;</span> <span class="comment"># CVATä¼šè‡ªåŠ¨åˆ†é…é¢œè‰²</span></span><br><span class="line">         ET.SubElement(label_elem, <span class="string">&quot;type&quot;</span>).text = <span class="string">&quot;rectangle&quot;</span> <span class="comment"># å‡è®¾éƒ½æ˜¯çŸ©å½¢æ¡†</span></span><br><span class="line">         ET.SubElement(label_elem, <span class="string">&quot;attributes&quot;</span>) <span class="comment"># è¿™é‡Œä¸å®šä¹‰å±æ€§</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ·»åŠ æœ€å°åŒ–çš„ segments ä¿¡æ¯ (CVATæ ¼å¼è¦æ±‚)</span></span><br><span class="line">    segments = ET.SubElement(task, <span class="string">&quot;segments&quot;</span>)</span><br><span class="line">    segment = ET.SubElement(segments, <span class="string">&quot;segment&quot;</span>)</span><br><span class="line">    ET.SubElement(segment, <span class="string">&quot;id&quot;</span>).text = <span class="string">&quot;0&quot;</span></span><br><span class="line">    ET.SubElement(segment, <span class="string">&quot;start&quot;</span>).text = <span class="string">&quot;0&quot;</span></span><br><span class="line">    ET.SubElement(segment, <span class="string">&quot;stop&quot;</span>).text = <span class="built_in">str</span>(original_total_frames - <span class="number">1</span>) <span class="comment"># ä½¿ç”¨åŸå§‹è§†é¢‘çš„æ€»å¸§æ•°</span></span><br><span class="line">    ET.SubElement(segment, <span class="string">&quot;url&quot;</span>).text = <span class="string">&quot;N/A&quot;</span> <span class="comment"># å ä½ç¬¦</span></span><br><span class="line"></span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;owner&quot;</span>) <span class="comment"># ç©ºçš„ owner</span></span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;assignee&quot;</span>) <span class="comment"># ç©ºçš„ assignee</span></span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;subset&quot;</span>).text = <span class="string">&quot;Default&quot;</span> <span class="comment"># é»˜è®¤å­é›†</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åŸå§‹å°ºå¯¸ä¿¡æ¯ (éœ€è¦)</span></span><br><span class="line">    original_size = ET.SubElement(meta, <span class="string">&quot;original_size&quot;</span>)</span><br><span class="line">    ET.SubElement(original_size, <span class="string">&quot;width&quot;</span>).text = <span class="built_in">str</span>(frame_width)</span><br><span class="line">    ET.SubElement(original_size, <span class="string">&quot;height&quot;</span>).text = <span class="built_in">str</span>(frame_height)</span><br><span class="line"></span><br><span class="line">    ET.SubElement(meta, <span class="string">&quot;dumped&quot;</span>).text = current_time_utc <span class="comment"># å¯¼å‡ºæ—¶é—´</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¸ºæ¯ä¸ªå¤„ç†è¿‡çš„å¸§æ·»åŠ  &lt;image&gt; æ ‡æ³¨</span></span><br><span class="line">    <span class="keyword">if</span> all_results:</span><br><span class="line">        <span class="keyword">for</span> frame_number <span class="keyword">in</span> <span class="built_in">sorted</span>(all_results.keys()): <span class="comment"># æŒ‰å¸§å·æ’åº</span></span><br><span class="line">            detections = all_results[frame_number]</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> detections: <span class="comment"># å¦‚æœè¯¥å¸§æ²¡æœ‰æ£€æµ‹ç»“æœï¼Œè·³è¿‡ï¼ˆç†è®ºä¸Šä¸åº”å‘ç”Ÿï¼Œå› ä¸ºæˆ‘ä»¬åªå­˜å‚¨æœ‰ç»“æœçš„å¸§ï¼‰</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># åˆ›å»º &lt;image&gt; å…ƒç´ </span></span><br><span class="line">            image_elem = ET.SubElement(root, <span class="string">&quot;image&quot;</span>)</span><br><span class="line">            <span class="comment"># CVAT ä½¿ç”¨ 0-based ç´¢å¼•ä½œä¸º id</span></span><br><span class="line">            image_elem.<span class="built_in">set</span>(<span class="string">&quot;id&quot;</span>, <span class="built_in">str</span>(frame_number - <span class="number">1</span>))</span><br><span class="line">            <span class="comment"># ç”Ÿæˆä¸€ä¸ªè§„èŒƒçš„å¸§å (å¯é€‰ï¼Œä½†æ¨è)</span></span><br><span class="line">            image_elem.<span class="built_in">set</span>(<span class="string">&quot;name&quot;</span>, <span class="string">f&quot;frame_<span class="subst">&#123;frame_number:06d&#125;</span>&quot;</span>) <span class="comment"># æ ¼å¼åŒ–å¸§å·ï¼Œå¦‚ frame_000123</span></span><br><span class="line">            image_elem.<span class="built_in">set</span>(<span class="string">&quot;width&quot;</span>, <span class="built_in">str</span>(frame_width))</span><br><span class="line">            image_elem.<span class="built_in">set</span>(<span class="string">&quot;height&quot;</span>, <span class="built_in">str</span>(frame_height))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># åœ¨ &lt;image&gt; å…ƒç´ å†…éƒ¨æ·»åŠ  &lt;box&gt; å…ƒç´ </span></span><br><span class="line">            <span class="keyword">for</span> det <span class="keyword">in</span> detections:</span><br><span class="line">                box_elem = ET.SubElement(image_elem, <span class="string">&quot;box&quot;</span>)</span><br><span class="line">                box_elem.<span class="built_in">set</span>(<span class="string">&quot;label&quot;</span>, <span class="built_in">str</span>(det.get(<span class="string">&#x27;label&#x27;</span>, <span class="string">&#x27;unknown&#x27;</span>)))</span><br><span class="line"></span><br><span class="line">                points = det.get(<span class="string">&#x27;points&#x27;</span>, [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>])</span><br><span class="line">                <span class="comment"># åæ ‡ä½¿ç”¨ä¸¤ä½å°æ•°çš„æµ®ç‚¹æ•°æ ¼å¼</span></span><br><span class="line">                box_elem.<span class="built_in">set</span>(<span class="string">&quot;xtl&quot;</span>, <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">float</span>(points[<span class="number">0</span>]):<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">                box_elem.<span class="built_in">set</span>(<span class="string">&quot;ytl&quot;</span>, <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">float</span>(points[<span class="number">1</span>]):<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">                box_elem.<span class="built_in">set</span>(<span class="string">&quot;xbr&quot;</span>, <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">float</span>(points[<span class="number">2</span>]):<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">                box_elem.<span class="built_in">set</span>(<span class="string">&quot;ybr&quot;</span>, <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">float</span>(points[<span class="number">3</span>]):<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># å¯¹äºå›¾åƒæ ¼å¼ï¼Œé€šå¸¸ä¸éœ€è¦ outsideï¼Œä½† occluded å¯ä»¥ä¿ç•™</span></span><br><span class="line">                box_elem.<span class="built_in">set</span>(<span class="string">&quot;occluded&quot;</span>, <span class="string">&quot;0&quot;</span>) <span class="comment"># 0 è¡¨ç¤ºæœªé®æŒ¡ (å‡è®¾)</span></span><br><span class="line">                <span class="comment"># åœ¨ CVAT for Images æ ¼å¼ä¸­ï¼Œä¸éœ€è¦ keyframe å’Œ outside</span></span><br><span class="line">                <span class="comment"># box_elem.set(&quot;outside&quot;, &quot;0&quot;) # é€šå¸¸ä¸éœ€è¦ä¸ºå›¾åƒè®¾ç½®outside</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># å°†ç½®ä¿¡åº¦æ·»åŠ ä¸ºå±æ€§</span></span><br><span class="line">                attr_conf = ET.SubElement(box_elem, <span class="string">&quot;attribute&quot;</span>, name=<span class="string">&quot;confidence&quot;</span>)</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    confidence_val = <span class="built_in">float</span>(det.get(<span class="string">&#x27;confidence&#x27;</span>, <span class="number">0.0</span>))</span><br><span class="line">                <span class="keyword">except</span> (ValueError, TypeError):</span><br><span class="line">                    confidence_val = <span class="number">0.0</span></span><br><span class="line">                attr_conf.text = <span class="string">f&quot;<span class="subst">&#123;confidence_val:<span class="number">.4</span>f&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- ç»“æŸæ„å»ºXMLç»“æ„ ---</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- å†™å…¥ XML æ–‡ä»¶ ---</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># è·å–åŒ…å«å£°æ˜ä¸”æ ¼å¼åŒ–çš„å®Œæ•´XMLå­—ç¬¦ä¸²</span></span><br><span class="line">        full_xml_string = pretty_print_xml(root)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> full_xml_string:</span><br><span class="line">            <span class="comment"># åœ¨å†™å…¥å‰ç¡®ä¿å­—ç¬¦ä¸²ä»¥ &lt;?xml å¼€å¤´</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> full_xml_string.strip().startswith(<span class="string">&quot;&lt;?xml&quot;</span>):</span><br><span class="line">                 logging.error(<span class="string">&quot;ç¾åŒ–æ‰“å°æœªèƒ½ç”Ÿæˆæœ‰æ•ˆçš„XMLå¼€å¤´ã€‚&quot;</span>)</span><br><span class="line">                 <span class="keyword">raise</span> ValueError(<span class="string">&quot;ç¾åŒ–æ‰“å°å¤±è´¥ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(xml_output_path, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                <span class="comment"># ç›´æ¥å†™å…¥å®Œæ•´çš„å­—ç¬¦ä¸²</span></span><br><span class="line">                f.write(full_xml_string)</span><br><span class="line">            logging.info(<span class="string">f&quot;æ£€æµ‹ç»“æœå·²ä¿å­˜è‡³ CVAT å›¾åƒ XML: <span class="subst">&#123;xml_output_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># å¦‚æœ pretty_print_xml è¿”å› Noneï¼Œä½¿ç”¨åå¤‡æ–¹æ¡ˆ</span></span><br><span class="line">            logging.warning(<span class="string">&quot;ç¾åŒ–æ‰“å°å¤±è´¥ï¼Œå›é€€åˆ°åŸºç¡€XMLå†™å…¥å™¨ã€‚&quot;</span>)</span><br><span class="line">            tree = ET.ElementTree(root)</span><br><span class="line">            <span class="comment"># å¦‚æœ Python &gt;= 3.9, å¯ä»¥ä½¿ç”¨ ET.indent æ·»åŠ åŸºæœ¬ç¼©è¿›</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">hasattr</span>(ET, <span class="string">&#x27;indent&#x27;</span>):</span><br><span class="line">                 ET.indent(tree, space=<span class="string">&quot;  &quot;</span>, level=<span class="number">0</span>)</span><br><span class="line">            <span class="comment"># ä½¿ç”¨ ElementTree å†™å…¥ï¼Œå¹¶è¯·æ±‚ XML å£°æ˜</span></span><br><span class="line">            tree.write(xml_output_path, encoding=<span class="string">&#x27;utf-8&#x27;</span>, xml_declaration=<span class="literal">True</span>)</span><br><span class="line">            logging.info(<span class="string">f&quot;æ£€æµ‹ç»“æœå·²ä¿å­˜è‡³åŸºç¡€ CVAT XML (åå¤‡æ–¹æ¡ˆ): <span class="subst">&#123;xml_output_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;ä¿å­˜ç»“æœåˆ° CVAT XML æ–‡ä»¶å¤±è´¥: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- ä¸»å¤„ç†é€»è¾‘ ---</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    logging.info(<span class="string">f&quot;å¼€å§‹å¤„ç†è§†é¢‘: <span class="subst">&#123;VIDEO_PATH&#125;</span>&quot;</span>)</span><br><span class="line">    logging.info(<span class="string">f&quot;Nuclio å‡½æ•° URL: <span class="subst">&#123;NUCLIO_FUNCTION_URL&#125;</span>&quot;</span>)</span><br><span class="line">    logging.info(<span class="string">f&quot;å¤„ç†å¸§é—´éš”: æ¯ <span class="subst">&#123;FRAME_SKIP&#125;</span> å¸§&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(VIDEO_PATH):</span><br><span class="line">        logging.error(<span class="string">f&quot;è§†é¢‘æ–‡ä»¶æœªæ‰¾åˆ°: <span class="subst">&#123;VIDEO_PATH&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    cap = cv2.VideoCapture(VIDEO_PATH)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cap.isOpened():</span><br><span class="line">        logging.error(<span class="string">f&quot;æ‰“å¼€è§†é¢‘æ–‡ä»¶é”™è¯¯: <span class="subst">&#123;VIDEO_PATH&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å–è§†é¢‘å…ƒæ•°æ®</span></span><br><span class="line">    original_total_frames = <span class="built_in">int</span>(cap.get(cv2.CAP_PROP_FRAME_COUNT))</span><br><span class="line">    fps = cap.get(cv2.CAP_PROP_FPS)</span><br><span class="line">    frame_width = <span class="built_in">int</span>(cap.get(cv2.CAP_PROP_FRAME_WIDTH))</span><br><span class="line">    frame_height = <span class="built_in">int</span>(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))</span><br><span class="line">    <span class="keyword">if</span> original_total_frames &lt;= <span class="number">0</span>:</span><br><span class="line">        logging.error(<span class="string">f&quot;è§†é¢‘æ–‡ä»¶ä¼¼ä¹ä¸ºç©ºæˆ–å…ƒæ•°æ®é”™è¯¯ (æ€»å¸§æ•°: <span class="subst">&#123;original_total_frames&#125;</span>)ã€‚&quot;</span>)</span><br><span class="line">        cap.release()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    logging.info(<span class="string">f&quot;è§†é¢‘ä¿¡æ¯: æ€»å¸§æ•°: <span class="subst">&#123;original_total_frames&#125;</span>, FPS: <span class="subst">&#123;fps:<span class="number">.2</span>f&#125;</span>, å°ºå¯¸: <span class="subst">&#123;frame_width&#125;</span>x<span class="subst">&#123;frame_height&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    frame_count = <span class="number">0</span> <span class="comment"># å·²è¯»å–çš„å¸§è®¡æ•° (1-based for logging)</span></span><br><span class="line">    processed_frame_count = <span class="number">0</span> <span class="comment"># å®é™…å¤„ç†çš„å¸§è®¡æ•°</span></span><br><span class="line">    all_results = &#123;&#125; <span class="comment"># å­˜å‚¨ç»“æœ: &#123;å¸§å· (1-based): [æ£€æµ‹åˆ—è¡¨]&#125;</span></span><br><span class="line">    start_process_time = time.time() <span class="comment"># å¼€å§‹è®¡æ—¶</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment"># è¯»å–ä¸€å¸§</span></span><br><span class="line">        ret, frame = cap.read()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ£€æŸ¥æ˜¯å¦æˆåŠŸè¯»å–</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ret:</span><br><span class="line">            <span class="keyword">if</span> frame_count &lt; original_total_frames:</span><br><span class="line">                logging.warning(<span class="string">f&quot;æ— æ³•è¯»å–å¸§ <span class="subst">&#123;frame_count + <span class="number">1</span>&#125;</span> (æ€»å¸§æ•° <span class="subst">&#123;original_total_frames&#125;</span>)ï¼Œå‡å®šè§†é¢‘ç»“æŸã€‚&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                 logging.info(<span class="string">&quot;è§†é¢‘å¤„ç†åˆ°è¾¾ç»“å°¾ã€‚&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span> <span class="comment"># é€€å‡ºå¾ªç¯</span></span><br><span class="line"></span><br><span class="line">        frame_count += <span class="number">1</span> <span class="comment"># æ›´æ–°å·²è¯»å–å¸§è®¡æ•°</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- è·³å¸§é€»è¾‘ ---</span></span><br><span class="line">        <span class="keyword">if</span> FRAME_SKIP &gt; <span class="number">1</span> <span class="keyword">and</span> frame_count % FRAME_SKIP != <span class="number">0</span> :</span><br><span class="line">            <span class="keyword">continue</span> <span class="comment"># è·³è¿‡å½“å‰å¸§</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- å¤„ç†å½“å‰å¸§ ---</span></span><br><span class="line">        processed_frame_count += <span class="number">1</span> <span class="comment"># æ›´æ–°å·²å¤„ç†å¸§è®¡æ•°</span></span><br><span class="line">        logging.info(<span class="string">f&quot;æ­£åœ¨å¤„ç†å¸§ <span class="subst">&#123;frame_count&#125;</span>/<span class="subst">&#123;original_total_frames&#125;</span>...&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç¼–ç å¸§</span></span><br><span class="line">        b64_string = encode_frame_to_base64(frame)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> b64_string:</span><br><span class="line">            logging.warning(<span class="string">f&quot;å› ç¼–ç é”™è¯¯è·³è¿‡å¸§ <span class="subst">&#123;frame_count&#125;</span>ã€‚&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># è°ƒç”¨ Nuclio æ£€æµ‹å™¨</span></span><br><span class="line">        detections = call_nuclio_detector(b64_string, frame_count)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å­˜å‚¨æ£€æµ‹ç»“æœ (ä»…å½“æ£€æµ‹ç»“æœéç©ºæ—¶å­˜å‚¨)</span></span><br><span class="line">        <span class="keyword">if</span> detections:</span><br><span class="line">            all_results[frame_count] = detections <span class="comment"># ä½¿ç”¨ 1-based å¸§å·ä½œä¸ºé”®</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- è¿›åº¦ä¼°è®¡ (å¯é€‰) ---</span></span><br><span class="line">        <span class="keyword">if</span> processed_frame_count &gt; <span class="number">0</span> <span class="keyword">and</span> processed_frame_count % <span class="number">10</span> == <span class="number">0</span>: <span class="comment"># æ¯å¤„ç†10å¸§æ›´æ–°ä¸€æ¬¡è¿›åº¦</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                elapsed_time = time.time() - start_process_time</span><br><span class="line">                <span class="comment"># ä¼°è®¡æ€»å…±éœ€è¦å¤„ç†çš„å¸§æ•°</span></span><br><span class="line">                estimated_total_to_process = (original_total_frames // FRAME_SKIP) <span class="keyword">if</span> FRAME_SKIP &gt; <span class="number">1</span> <span class="keyword">else</span> original_total_frames</span><br><span class="line">                <span class="keyword">if</span> estimated_total_to_process &gt; <span class="number">0</span>:</span><br><span class="line">                    fraction_done = processed_frame_count / estimated_total_to_process</span><br><span class="line">                    <span class="comment"># é¿å…é™¤é›¶é”™è¯¯å’Œè¿›åº¦è¶…è¿‡100%çš„æƒ…å†µ</span></span><br><span class="line">                    <span class="keyword">if</span> fraction_done &gt; <span class="number">0</span> <span class="keyword">and</span> fraction_done &lt;= <span class="number">1</span>:</span><br><span class="line">                        total_estimated_time = elapsed_time / fraction_done</span><br><span class="line">                        estimated_remaining_time = <span class="built_in">max</span>(<span class="number">0</span>, total_estimated_time - elapsed_time) <span class="comment"># ç¡®ä¿ä¸ä¸ºè´Ÿ</span></span><br><span class="line">                        logging.info(</span><br><span class="line">                            <span class="string">f&quot;è¿›åº¦: å¸§ <span class="subst">&#123;frame_count&#125;</span>/<span class="subst">&#123;original_total_frames&#125;</span>ã€‚å·²å¤„ç† <span class="subst">&#123;processed_frame_count&#125;</span> å¸§ã€‚é¢„è®¡å‰©ä½™æ—¶é—´: <span class="subst">&#123;timedelta(seconds=<span class="built_in">int</span>(estimated_remaining_time))&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> ZeroDivisionError:</span><br><span class="line">                logging.warning(<span class="string">&quot;æ— æ³•ä¼°è®¡å‰©ä½™æ—¶é—´ (é™¤é›¶é”™è¯¯)ã€‚&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e_est:</span><br><span class="line">                logging.warning(<span class="string">f&quot;æ— æ³•ä¼°è®¡å‰©ä½™æ—¶é—´: <span class="subst">&#123;e_est&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- æ¸…ç†ä¸ä¿å­˜ ---</span></span><br><span class="line">    cap.release() <span class="comment"># é‡Šæ”¾è§†é¢‘æ•è·å¯¹è±¡</span></span><br><span class="line">    logging.info(<span class="string">&quot;è§†é¢‘æ•è·å·²é‡Šæ”¾ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç¡®å®šè¾“å‡ºXMLæ–‡ä»¶å</span></span><br><span class="line">    video_basename = os.path.basename(VIDEO_PATH)</span><br><span class="line">    video_name_no_ext, _ = os.path.splitext(video_basename)</span><br><span class="line">    <span class="comment"># æ–‡ä»¶åè¡¨æ˜æ˜¯CVATå›¾åƒæ ¼å¼</span></span><br><span class="line">    xml_output_filename = <span class="string">f&quot;<span class="subst">&#123;video_name_no_ext&#125;</span>_cvat_images.xml&quot;</span></span><br><span class="line">    xml_output_path = os.path.join(OUTPUT_DIR, xml_output_filename)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¿å­˜ä¸º CVAT å›¾åƒ XML</span></span><br><span class="line">    <span class="keyword">if</span> all_results:</span><br><span class="line">         <span class="comment"># ä¼ é€’å¤„ç†è¿‡çš„å¸§æ•°ç»™sizeå­—æ®µ</span></span><br><span class="line">         save_results_to_cvat_image_xml(</span><br><span class="line">             all_results,</span><br><span class="line">             xml_output_path,</span><br><span class="line">             video_basename,</span><br><span class="line">             frame_width,</span><br><span class="line">             frame_height,</span><br><span class="line">             processed_frame_count, <span class="comment"># ä¼ é€’å¤„ç†è¿‡çš„å¸§æ•°</span></span><br><span class="line">             original_total_frames <span class="comment"># ä¼ é€’åŸå§‹æ€»å¸§æ•°</span></span><br><span class="line">         )</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">         logging.warning(<span class="string">&quot;æ²¡æœ‰è®°å½•åˆ°ä»»ä½•æ£€æµ‹ç»“æœï¼Œå°†ä¸ä¼šåˆ›å»ºCVAT XMLæ–‡ä»¶ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- ç»“æŸå¤„ç† ---</span></span><br><span class="line">    end_process_time = time.time()</span><br><span class="line">    total_time = <span class="built_in">max</span>(<span class="number">0</span>, end_process_time - start_process_time) <span class="comment"># ç¡®ä¿æ€»æ—¶é—´éè´Ÿ</span></span><br><span class="line">    logging.info(<span class="string">f&quot;è§†é¢‘å¤„ç†å®Œæˆã€‚æ€»è€—æ—¶: <span class="subst">&#123;timedelta(seconds=<span class="built_in">int</span>(total_time))&#125;</span>&quot;</span>)</span><br><span class="line">    logging.info(<span class="string">f&quot;æ€»å…±è¯»å–å¸§æ•°: <span class="subst">&#123;frame_count&#125;</span>ã€‚å®é™…å¤„ç†å¸§æ•°: <span class="subst">&#123;processed_frame_count&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- ç¨‹åºå…¥å£ ---</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="see">see</h2><ul><li>1.<a href="https://github.com/nuclio/nuclio?tab=readme-ov-file#quick-start-steps">https://github.com/nuclio/nuclio?tab=readme-ov-file#quick-start-steps</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ffmpegåˆ†å‰²è§†é¢‘ä¸éŸ³é¢‘ä¸­çš„å¤„ç†é—®é¢˜åˆ†æ</title>
      <link href="/2025/04/07/ffmpeg-problem-video/"/>
      <url>/2025/04/07/ffmpeg-problem-video/</url>
      
        <content type="html"><![CDATA[<h2 id="èƒŒæ™¯">èƒŒæ™¯</h2><blockquote><p>ffmpeg is a universal media converter. It can read a wide variety of inputs - including live grabbing/recording devices - filter, and transcode them into a plethora of output formats.</p></blockquote><blockquote><p>ffmpgåŒ…å«äº†ä¸€æ•´å¥—ç”¨äºå¤„ç†éŸ³é¢‘ã€è§†é¢‘ã€å­—å¹•ä»¥åŠå…¶ä»–å¤šmÃ©diaæ•°æ®æµçš„åº“ï¼ˆlibrariesï¼‰å’Œç¨‹åºï¼ˆprogramsï¼‰ã€‚</p></blockquote><h2 id="è§†é¢‘å¤„ç†">è§†é¢‘å¤„ç†</h2><h3 id="è§†é¢‘å¸§">è§†é¢‘å¸§</h3><blockquote><p>å¦‚å›¾</p></blockquote><p><img src="/2025/04/07/ffmpeg-problem-video/kf.png" class="lazyload placeholder" data-srcset="/2025/04/07/ffmpeg-problem-video/kf.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li><strong>I å¸§ (å…³é”®å¸§)</strong>: å®Œæ•´çš„å›¾åƒï¼Œç‹¬ç«‹è§£ç ï¼Œæ˜¯è§£ç èµ·ç‚¹å’Œå‚è€ƒåŸºå‡†ï¼Œå‹ç¼©ç‡æœ€ä½ï¼Œæ•°æ®é‡æœ€å¤§ã€‚</li><li><strong>P å¸§</strong>: å­˜å‚¨ä¸å‰ä¸€å¸§çš„å·®å¼‚ï¼Œä¾èµ–å‰ä¸€å¸§è§£ç ï¼Œå‹ç¼©ç‡è¾ƒé«˜ï¼Œæ•°æ®é‡ä¸­ç­‰ã€‚</li><li><strong>B å¸§</strong>: å­˜å‚¨ä¸å‰ã€åå¸§çš„å·®å¼‚ï¼Œä¾èµ–å‰åå¸§è§£ç ï¼Œå‹ç¼©ç‡æœ€é«˜ï¼Œæ•°æ®é‡æœ€å°ã€‚</li><li><strong>GOP</strong>: ç”±ä¸€ä¸ª I å¸§å’Œè‹¥å¹² P/B å¸§ç»„æˆçš„åºåˆ—ï¼Œå…¶é•¿åº¦å½±å“å‹ç¼©ç‡å’Œéšæœºè®¿é—®æ€§èƒ½ã€‚</li></ul><h3 id="å¸§æ„æˆ">å¸§æ„æˆ</h3><blockquote><p>å¦‚å›¾</p></blockquote><p><img src="/2025/04/07/ffmpeg-problem-video/gop.png" class="lazyload placeholder" data-srcset="/2025/04/07/ffmpeg-problem-video/gop.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li><p><strong>I å¸§ (Intra-coded Picture / Keyframe / å…³é”®å¸§)</strong></p></li><li><p><strong>æ„æˆ</strong>: I å¸§æ˜¯ä¸€å¸§<strong>å®Œæ•´</strong>çš„å›¾åƒã€‚å®ƒä¸ä¾èµ–äºä»»ä½•å…¶ä»–å¸§æ¥è¿›è¡Œè§£ç ã€‚å®ƒæœ¬èº«åŒ…å«äº†åœ¨è¯¥æ—¶é—´ç‚¹æ˜¾ç¤ºå®Œæ•´ç”»é¢æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ã€‚</p></li><li><p><strong>ç¼–ç æ–¹å¼</strong>: å®ƒåªåˆ©ç”¨äº†<strong>ç©ºé—´å†—ä½™</strong>è¿›è¡Œå‹ç¼©ï¼Œå…¶ç¼–ç æ–¹å¼ç±»ä¼¼äºé™æ€å›¾åƒå‹ç¼©ï¼ˆå¦‚ JPEGï¼‰ã€‚å®ƒä¸å¯¹å‰åå¸§è¿›è¡Œå‚è€ƒã€‚</p></li><li><p><strong>ä½œç”¨</strong>:</p></li><li><p><strong>è§£ç èµ·ç‚¹</strong>: æ’­æ”¾å™¨å¯ä»¥ä»ä»»ä½•ä¸€ä¸ª I å¸§å¼€å§‹è§£ç å¹¶æ­£ç¡®æ˜¾ç¤ºè§†é¢‘ï¼Œå› æ­¤ I å¸§æ˜¯è§†é¢‘éšæœºè®¿é—®ï¼ˆå¿«è¿›ã€å¿«é€€ã€å®šä½æ’­æ”¾ï¼‰çš„åŸºç¡€ã€‚</p></li><li><p><strong>å‚è€ƒåŸºå‡†</strong>: å®ƒä½œä¸ºåç»­ P å¸§å’Œ B å¸§è¿›è¡Œé¢„æµ‹å’Œå‚è€ƒçš„â€œåŸºå‡†å¸§â€ã€‚</p></li><li><p><strong>é”™è¯¯éš”ç¦»</strong>: å¦‚æœä¼ è¾“æˆ–å­˜å‚¨ä¸­å‡ºç°é”™è¯¯ï¼Œé”™è¯¯çš„å½±å“é€šå¸¸åªæŒç»­åˆ°ä¸‹ä¸€ä¸ª I å¸§ï¼ŒI å¸§å¯ä»¥é˜»æ­¢é”™è¯¯çš„è¿›ä¸€æ­¥ä¼ æ’­ã€‚</p></li><li><p><strong>ç‰¹ç‚¹</strong>: æ•°æ®é‡æœ€å¤§ï¼Œå‹ç¼©ç‡æœ€ä½ï¼ˆç›¸æ¯” P/B å¸§ï¼‰ã€‚</p></li><li><p><strong>P å¸§ (Predicted Picture / å‰å‘é¢„æµ‹å¸§)</strong></p></li><li><p><strong>æ„æˆ</strong>: P å¸§ä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„å›¾åƒã€‚å®ƒå­˜å‚¨çš„æ˜¯å½“å‰ç”»é¢ä¸<strong>ä¹‹å‰</strong>çš„æŸä¸ª I å¸§æˆ– P å¸§ä¹‹é—´çš„<strong>å·®å¼‚ä¿¡æ¯</strong>ã€‚</p></li><li><p><strong>ç¼–ç æ–¹å¼</strong>: å®ƒåˆ©ç”¨äº†<strong>æ—¶é—´å†—ä½™</strong>ã€‚ç¼–ç å™¨ä¼šåˆ†æå½“å‰ P å¸§ä¸å®ƒå‚è€ƒçš„å‰ä¸€å¸§ï¼ˆI æˆ– Pï¼‰ä¹‹é—´çš„åŒºåˆ«ï¼Œä¸»è¦æ˜¯ç‰©ä½“çš„è¿åŠ¨ï¼ˆé€šè¿‡<strong>è¿åŠ¨çŸ¢é‡ (Motion Vectors</strong> æè¿°ç‰©ä½“ç§»åŠ¨çš„æ–¹å‘å’Œè·ç¦»ï¼‰ä»¥åŠè¿åŠ¨è¡¥å¿åçš„æ®‹å·®ä¿¡æ¯ï¼ˆé¢„æµ‹ä¸å®Œå…¨å‡†ç¡®çš„éƒ¨åˆ†ï¼‰ã€‚</p></li><li><p><strong>ä½œç”¨</strong>: å¤§å¤§æé«˜å‹ç¼©ç‡ï¼Œå› ä¸ºåªå­˜å‚¨å˜åŒ–çš„éƒ¨åˆ†ï¼Œæ•°æ®é‡è¿œå°äº I å¸§ã€‚</p></li><li><p><strong>ä¾èµ–æ€§</strong>: è§£ç  P å¸§<strong>å¿…é¡»</strong>å…ˆè§£ç å®ƒæ‰€å‚è€ƒçš„é‚£ä¸ªå‰é¢çš„ I å¸§æˆ– P å¸§ã€‚</p></li><li><p><strong>ç‰¹ç‚¹</strong>: æ•°æ®é‡ä»‹äº I å¸§å’Œ B å¸§ä¹‹é—´ï¼Œå‹ç¼©ç‡è¾ƒé«˜ã€‚</p></li><li><p><strong>B å¸§ (Bi-directionally Predicted Picture / åŒå‘é¢„æµ‹å¸§)</strong></p></li><li><p><strong>æ„æˆ</strong>: B å¸§ä¹Ÿä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„å›¾åƒã€‚å®ƒå­˜å‚¨çš„æ˜¯å½“å‰ç”»é¢ä¸å®ƒ<strong>å‰é¢</strong>çš„ä¸€ä¸ªå‚è€ƒå¸§ï¼ˆI æˆ– Pï¼‰ä»¥åŠ<strong>åé¢</strong>çš„ä¸€ä¸ªå‚è€ƒå¸§ï¼ˆI æˆ– Pï¼‰ä¹‹é—´çš„å·®å¼‚ä¿¡æ¯ã€‚</p></li><li><p><strong>ç¼–ç æ–¹å¼</strong>: å®ƒåˆ©ç”¨äº†æ›´å……åˆ†çš„<strong>æ—¶é—´å†—ä½™</strong>ã€‚ç¼–ç å™¨å¯ä»¥åŒæ—¶å‚è€ƒè¿‡å»å’Œæœªæ¥çš„å¸§æ¥é¢„æµ‹å½“å‰ B å¸§çš„å†…å®¹ï¼Œé€šå¸¸èƒ½æ‰¾åˆ°æ›´ç›¸ä¼¼çš„å—ï¼Œä»è€Œæ›´æœ‰æ•ˆåœ°æè¿°å·®å¼‚ï¼ˆè¿åŠ¨çŸ¢é‡å’Œæ®‹å·®ï¼‰ã€‚</p></li><li><p><strong>ä½œç”¨</strong>: æä¾›æœ€é«˜çš„å‹ç¼©ç‡ï¼Œæ•°æ®é‡é€šå¸¸æ˜¯æœ€å°çš„ã€‚</p></li><li><p><strong>ä¾èµ–æ€§</strong>: è§£ç  B å¸§<strong>å¿…é¡»</strong>å…ˆè§£ç å®ƒæ‰€å‚è€ƒçš„å‰ã€åä¸¤ä¸ªå‚è€ƒå¸§ã€‚è¿™æ„å‘³ç€è§£ç å™¨éœ€è¦å…ˆè§£ç æœªæ¥çš„å‚è€ƒå¸§ï¼Œæ‰èƒ½å›å¤´è§£ç å½“å‰çš„ B å¸§ï¼Œè¿™ä¼šå¼•å…¥ä¸€å®šçš„è§£ç å»¶è¿Ÿã€‚</p></li><li><p><strong>ç‰¹ç‚¹</strong>: æ•°æ®é‡æœ€å°ï¼Œå‹ç¼©ç‡æœ€é«˜ã€‚</p></li></ul><h3 id="å›¾åƒåºåˆ—">å›¾åƒåºåˆ—</h3><ul><li><strong>GOP (Group of Pictures / å›¾åƒç»„)</strong></li></ul><blockquote><p>è¿™äº› Iã€Pã€B å¸§é€šå¸¸è¢«ç»„ç»‡æˆä¸€ä¸ªç§°ä¸º GOP çš„åºåˆ—ã€‚ä¸€ä¸ª GOP ä»¥ä¸€ä¸ª I å¸§å¼€å§‹ï¼Œåé¢è·Ÿç€ä¸€ç³»åˆ— P å¸§å’Œ B å¸§ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ª I å¸§ã€‚</p></blockquote><ul><li><strong>ç»“æ„ç¤ºä¾‹</strong>: ä¸€ä¸ªå¸¸è§çš„ GOP ç»“æ„å¯èƒ½æ˜¯ <code>I B B P B B P B B I</code>ã€‚è¿™ä¸ªåºåˆ—ä¼šé‡å¤å‡ºç°ã€‚</li><li><strong>GOP é•¿åº¦</strong>: æŒ‡ä¸¤ä¸ªè¿ç»­ I å¸§ä¹‹é—´çš„è·ç¦»ï¼ˆä»¥å¸§æ•°æˆ–æ—¶é—´è¡¡é‡ï¼‰ã€‚</li><li><strong>é•¿ GOP</strong>: åŒ…å«æ›´å¤šçš„ P å’Œ B å¸§ï¼Œå‹ç¼©ç‡æ›´é«˜ï¼Œä½†éšæœºè®¿é—®æ€§èƒ½å·®ï¼ˆå®šä½æ’­æ”¾æ—¶éœ€è¦æ‰¾åˆ°æ›´ä¹…ä¹‹å‰çš„ I å¸§ï¼‰ï¼Œé”™è¯¯æ¢å¤æ…¢ã€‚</li><li><strong>çŸ­ GOP</strong>: I å¸§æ›´é¢‘ç¹ï¼Œå‹ç¼©ç‡è¾ƒä½ï¼Œä½†éšæœºè®¿é—®å¿«ï¼Œé”™è¯¯æ¢å¤å¿«ã€‚ç›´æ’­æˆ–éœ€è¦é¢‘ç¹ç¼–è¾‘çš„åœºæ™¯é€šå¸¸ä½¿ç”¨è¾ƒçŸ­çš„ GOPã€‚</li></ul><blockquote><p>ç”±äº B å¸§éœ€è¦å‚è€ƒåé¢çš„å¸§ï¼Œæ‰€ä»¥è§£ç å™¨å¤„ç†å¸§çš„é¡ºåºï¼ˆè§£ç é¡ºåºï¼‰å¯èƒ½ä¸æœ€ç»ˆå±å¹•ä¸Šæ’­æ”¾çš„é¡ºåºï¼ˆæ˜¾ç¤ºé¡ºåºï¼‰ä¸åŒã€‚è§£ç å™¨éœ€è¦å…ˆè§£ç  B å¸§æ‰€ä¾èµ–çš„åé¢çš„å‚è€ƒå¸§ï¼Œç„¶åæ‰èƒ½è§£ç  B å¸§æœ¬èº«ï¼Œä¸Šè¿°è§†é¢‘å¸§åœ¨è§£ç ä¸æ˜¾ç¤ºè§†é¢‘æ—¶å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p></blockquote><p><img src="/2025/04/07/ffmpeg-problem-video/keyframe.png" class="lazyload placeholder" data-srcset="/2025/04/07/ffmpeg-problem-video/keyframe.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="ä¸»è¦åŠŸèƒ½åŠæ„æˆ">ä¸»è¦åŠŸèƒ½åŠæ„æˆ</h2><h3 id="åŠŸèƒ½">åŠŸèƒ½</h3><ol><li><strong>æ ¼å¼è½¬æ¢ (Transcoding / Format Conversion):</strong> FFmpeg æœ€å¸¸ç”¨çš„åŠŸèƒ½ä¹‹ä¸€ã€‚å®ƒå¯ä»¥è½»æ¾åœ°å°†è§†é¢‘æˆ–éŸ³é¢‘æ–‡ä»¶ä»ä¸€ç§æ ¼å¼è½¬æ¢ä¸ºå¦ä¸€ç§æ ¼å¼ï¼ˆä¾‹å¦‚ï¼ŒMP4 è½¬ AVIï¼ŒWAV è½¬ MP3ï¼‰ã€‚</li><li><strong>ç¼–ç ä¸è§£ç  (Encoding / Decoding):</strong> æ”¯æŒå‡ ä¹æ‰€æœ‰å·²çŸ¥çš„éŸ³é¢‘å’Œè§†é¢‘ç¼–è§£ç å™¨ï¼ˆCodecsï¼‰ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥å‹ç¼©åª’ä½“æ–‡ä»¶ï¼ˆç¼–ç ï¼‰æˆ–æ’­æ”¾/å¤„ç†å®ƒä»¬ï¼ˆè§£ç ï¼‰ã€‚</li><li><strong>å°è£…ä¸è§£å°è£… (Muxing / Demuxing):</strong> å¯ä»¥å°†å•ç‹¬çš„éŸ³é¢‘æµå’Œè§†é¢‘æµåˆå¹¶åˆ°ä¸€ä¸ªå®¹å™¨æ–‡ä»¶ï¼ˆå¦‚ MP4, MKVï¼‰ä¸­ï¼ˆå°è£…ï¼‰ï¼Œæˆ–è€…ä»ä¸€ä¸ªå®¹å™¨æ–‡ä»¶ä¸­æå–å‡ºå•ç‹¬çš„éŸ³é¢‘ã€è§†é¢‘æˆ–å­—å¹•æµï¼ˆè§£å°è£…ï¼‰ã€‚</li><li><strong>æµåª’ä½“å¤„ç† (Streaming):</strong> FFmpeg å¯ä»¥æ•æ‰ã€ç¼–ç å¹¶å°†éŸ³è§†é¢‘æµå®æ—¶æ¨é€åˆ°æµåª’ä½“æœåŠ¡å™¨ï¼ˆå¦‚ RTMP, HLSï¼‰ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºå®¢æˆ·ç«¯æ¥æ”¶å’Œå¤„ç†æµã€‚</li><li><strong>ç¼–è¾‘ä¸å¤„ç† (Editing &amp; Filtering):</strong><ul><li><strong>è£å‰ª (Cropping):</strong> æˆªå–è§†é¢‘ç”»é¢çš„ç‰¹å®šåŒºåŸŸã€‚</li><li><strong>ç¼©æ”¾ (Scaling):</strong> æ”¹å˜è§†é¢‘åˆ†è¾¨ç‡ã€‚</li><li><strong>æ—‹è½¬/ç¿»è½¬ (Rotating/Flipping):</strong> è°ƒæ•´è§†é¢‘æ–¹å‘ã€‚</li><li><strong>åˆå¹¶/åˆ†å‰² (Concatenating/Splitting):</strong> è¿æ¥æˆ–åˆ‡åˆ†åª’ä½“æ–‡ä»¶ã€‚</li><li><strong>æ·»åŠ æ°´å°/å­—å¹• (Watermarking/Subtitles):</strong> åœ¨è§†é¢‘ä¸Šå åŠ å›¾ç‰‡æˆ–æ–‡å­—ã€‚</li><li><strong>è°ƒæ•´é€Ÿåº¦ (Speed Adjustment):</strong> å¿«æ”¾æˆ–æ…¢æ”¾ã€‚</li><li><strong>åº”ç”¨æ»¤é•œ (Applying Filters):</strong> è°ƒæ•´äº®åº¦ã€å¯¹æ¯”åº¦ã€é¥±å’Œåº¦ï¼Œæ·»åŠ æ¨¡ç³Šã€é”åŒ–ç­‰å„ç§è§†è§‰æ•ˆæœï¼Œä»¥åŠéŸ³é¢‘æ•ˆæœå¦‚éŸ³é‡è°ƒæ•´ã€é™å™ªç­‰ã€‚</li></ul></li><li><strong>å±å¹•å½•åˆ¶ä¸è®¾å¤‡æ•æ‰ (Screen Recording &amp; Device Capture):</strong> å¯ä»¥å½•åˆ¶æ¡Œé¢å±å¹•ã€æ‘„åƒå¤´è¾“å…¥æˆ–éº¦å…‹é£éŸ³é¢‘ã€‚</li><li><strong>åª’ä½“ä¿¡æ¯åˆ†æ (Media Information Analysis):</strong> é€šè¿‡ <code>ffprobe</code> å·¥å…·ï¼Œå¯ä»¥è¯¦ç»†åˆ†æåª’ä½“æ–‡ä»¶çš„å„ç§å‚æ•°ï¼Œå¦‚ç¼–ç æ ¼å¼ã€åˆ†è¾¨ç‡ã€æ¯”ç‰¹ç‡ã€å¸§ç‡ã€æ—¶é•¿ç­‰ã€‚</li></ol><h3 id="å…³é”®æµç¨‹è§£è¯»">å…³é”®æµç¨‹è§£è¯»</h3><ul><li>FFmpeg çš„åŸºæœ¬å·¥ä½œæµç¨‹å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå¤„ç†ç®¡çº¿ï¼š</li></ul><blockquote><p>è§£å¤ç”¨ (Demuxing): ffmpeg è¯»å–è¾“å…¥æ–‡ä»¶ (-i input.mkv)ã€‚è§£å¤ç”¨å™¨ (Demuxer) è´Ÿè´£è§£æå®¹å™¨æ ¼å¼ (å¦‚ MKV, MP4, AVI)ï¼Œå¹¶å°†å…¶ä¸­åŒ…å«çš„å„ä¸ªåŸºæœ¬æµ (Elementary Streams, ES) åˆ†ç¦»å‡ºæ¥ï¼Œè¿™äº›æµæ˜¯ç¼–ç è¿‡çš„æ•°æ®åŒ… (Packets)ã€‚</p></blockquote><blockquote><p>è§£ç  (Decoding): å¯¹äºéœ€è¦å¤„ç†æˆ–é‡æ–°ç¼–ç çš„æµï¼Œå…¶æ•°æ®åŒ…ä¼šè¢«é€å…¥ç›¸åº”çš„è§£ç å™¨ (Decoder)ã€‚è§£ç å™¨å°†å‹ç¼©çš„ç¼–ç æ•°æ®è¿˜åŸæˆåŸå§‹çš„ã€æœªå‹ç¼©çš„å¸§ (Frames) - è§†é¢‘å¸§æˆ–éŸ³é¢‘é‡‡æ ·ã€‚å¦‚æœä½¿ç”¨äº† -c copy (æµå¤åˆ¶)ï¼Œåˆ™è·³è¿‡æ­¤æ­¥éª¤ã€‚</p></blockquote><blockquote><p>æ»¤é•œ (Filtering): è§£ç åçš„åŸå§‹å¸§å¯ä»¥è¢«é€å…¥æ»¤é•œå›¾ (Filtergraph) (-vf, -af, -filter_complex) è¿›è¡Œå¤„ç†ã€‚æ»¤é•œå¯ä»¥ä¿®æ”¹å¸§çš„å†…å®¹ï¼Œä¾‹å¦‚ï¼š<br>è§†é¢‘æ»¤é•œï¼šç¼©æ”¾ã€è£å‰ªã€æ—‹è½¬ã€å åŠ æ°´å°ã€è°ƒè‰²ã€å»éš”è¡Œç­‰ã€‚<br>éŸ³é¢‘æ»¤é•œï¼šé‡é‡‡æ ·ã€æ”¹å˜éŸ³é‡ã€æ··éŸ³ã€é™å™ªç­‰ã€‚<br>å¦‚æœæœªä½¿ç”¨æ»¤é•œï¼Œåˆ™è·³è¿‡æ­¤æ­¥éª¤ã€‚</p></blockquote><blockquote><p>ç¼–ç  (Encoding): ç»è¿‡æ»¤é•œå¤„ç†ï¼ˆæˆ–ç›´æ¥æ¥è‡ªè§£ç å™¨ï¼‰çš„åŸå§‹å¸§è¢«é€å…¥æŒ‡å®šçš„ç¼–ç å™¨ (Encoder) (-c:v libx264, -c:a aac ç­‰)ã€‚ç¼–ç å™¨å°†åŸå§‹å¸§å‹ç¼©æˆç¼–ç åçš„æ•°æ®åŒ… (Packets)ã€‚å¦‚æœä½¿ç”¨äº† -c copy (æµå¤åˆ¶)ï¼Œåˆ™è·³è¿‡æ­¤æ­¥éª¤ã€‚</p></blockquote><blockquote><p>å¤ç”¨ (Muxing): ç¼–ç åçš„æ•°æ®åŒ…ï¼ˆæˆ–è€…ä»æµå¤åˆ¶ç›´æ¥è¿‡æ¥çš„æ•°æ®åŒ…ï¼‰è¢«é€å…¥å¤ç”¨å™¨ (Muxer) (-f mp4 ç­‰æŒ‡å®šæ ¼å¼)ã€‚å¤ç”¨å™¨è´Ÿè´£å°†æ¥è‡ªä¸åŒæµçš„æ•°æ®åŒ…æŒ‰ç…§ç›®æ ‡å®¹å™¨æ ¼å¼ (å¦‚ MP4, MKV, FLV) çš„è§„èŒƒï¼Œäº¤ç»‡å†™å…¥åˆ°è¾“å‡ºæ–‡ä»¶ä¸­ (output.mp4)ã€‚</p></blockquote><h3 id="æ„æˆ">æ„æˆ</h3><ul><li><strong><code>ffmpeg</code>:</strong> æ ¸å¿ƒçš„å‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºæ‰§è¡Œä¸Šè¿°å¤§éƒ¨åˆ†çš„è½¬æ¢ã€å¤„ç†ä»»åŠ¡ã€‚</li><li><strong><code>ffplay</code>:</strong> ä¸€ä¸ªåŸºäº SDL å’Œ FFmpeg åº“çš„ç®€å•åª’ä½“æ’­æ”¾å™¨ã€‚</li><li><strong><code>ffprobe</code>:</strong> ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºåˆ†æåª’ä½“æ–‡ä»¶å¹¶ä»¥æ–‡æœ¬ã€JSONã€XML ç­‰å¤šç§æ ¼å¼è¾“å‡ºè¯¦ç»†ä¿¡æ¯ã€‚</li><li><strong><code>libavcodec</code>:</strong> åŒ…å«äº†æ‰€æœ‰éŸ³é¢‘/è§†é¢‘ç¼–ç å™¨å’Œè§£ç å™¨çš„åº“ã€‚</li><li><strong><code>libavformat</code>:</strong> åŒ…å«äº†å¤„ç†å„ç§åª’ä½“å®¹å™¨æ ¼å¼ï¼ˆå°è£…/è§£å°è£…ï¼‰çš„åº“ã€‚</li><li><strong><code>libavfilter</code>:</strong> åŒ…å«äº†å„ç§éŸ³é¢‘å’Œè§†é¢‘æ»¤é•œçš„åº“ã€‚</li><li><strong><code>libswscale</code>:</strong> ç”¨äºå›¾åƒç¼©æ”¾å’Œé¢œè‰²ç©ºé—´/åƒç´ æ ¼å¼è½¬æ¢çš„åº“ã€‚</li><li><strong><code>libswresample</code>:</strong> ç”¨äºéŸ³é¢‘é‡é‡‡æ ·ã€æ ¼å¼è½¬æ¢å’Œé€šé“å¸ƒå±€ç®¡ç†çš„åº“ã€‚</li><li><strong><code>libavutil</code>:</strong> åŒ…å«å„ç§è¾…åŠ©å·¥å…·å‡½æ•°çš„åŸºç¡€åº“ã€‚</li></ul><h2 id="é€‰é¡¹æŒ‡å®š">é€‰é¡¹æŒ‡å®š</h2><ul><li><strong><code>-i url</code></strong>: æŒ‡å®šè¾“å…¥æ–‡ä»¶æˆ–æ¥æºã€‚å¯ä»¥æœ‰å¤šä¸ª <code>-i</code>ã€‚</li><li><strong><code>-f fmt</code></strong>: å¼ºåˆ¶æŒ‡å®šè¾“å‡ºæ–‡ä»¶æ ¼å¼ (å¦‚ <code>-f mp4</code>, <code>-f flv</code>)ã€‚é€šå¸¸ FFmpeg èƒ½æ ¹æ®æ‰©å±•åè‡ªåŠ¨åˆ¤æ–­ï¼Œä½†æœ‰æ—¶éœ€è¦å¼ºåˆ¶æŒ‡å®šã€‚</li><li><strong><code>-map [-]input_file_id[:stream_specifier][?]</code></strong>: <strong>æå…¶é‡è¦</strong>ã€‚ç”¨äºæ‰‹åŠ¨æ§åˆ¶å“ªäº›è¾“å…¥æµè¢«åŒ…å«åˆ°å“ªä¸ªè¾“å‡ºæ–‡ä»¶ä¸­ã€‚<ul><li><code>0:v</code> é€‰æ‹©ç¬¬ä¸€ä¸ªè¾“å…¥æ–‡ä»¶çš„æ‰€æœ‰è§†é¢‘æµã€‚</li><li><code>0:a:1</code> é€‰æ‹©ç¬¬ä¸€ä¸ªè¾“å…¥æ–‡ä»¶çš„ç¬¬äºŒä¸ªéŸ³é¢‘æµ (ç´¢å¼•ä»0å¼€å§‹)ã€‚</li><li><code>1:s?</code> é€‰æ‹©ç¬¬äºŒä¸ªè¾“å…¥æ–‡ä»¶çš„ç¬¬ä¸€ä¸ªå­—å¹•æµï¼ˆå¦‚æœå­˜åœ¨ï¼‰ã€‚</li><li><code>-map 0</code> é€‰æ‹©ç¬¬ä¸€ä¸ªè¾“å…¥æ–‡ä»¶çš„æ‰€æœ‰æµã€‚</li><li><code>-map -0:a</code> ä»è‡ªåŠ¨é€‰æ‹©ä¸­æ’é™¤ç¬¬ä¸€ä¸ªè¾“å…¥æ–‡ä»¶çš„æ‰€æœ‰éŸ³é¢‘æµã€‚</li></ul></li><li><strong><code>-c[:stream_specifier] codec</code></strong>: <strong>æå…¶é‡è¦</strong>ã€‚é€‰æ‹©ç¼–ç å™¨ã€‚<ul><li><code>-c copy</code>: è¿›è¡Œæµå¤åˆ¶ (Stream Copy)ï¼Œä¸é‡æ–°ç¼–ç ã€‚</li><li><code>-c:v libx264</code>: ä¸ºè§†é¢‘æµé€‰æ‹© H.264 (libx264) ç¼–ç å™¨ã€‚</li><li><code>-c:a aac</code>: ä¸ºéŸ³é¢‘æµé€‰æ‹© AAC ç¼–ç å™¨ã€‚</li><li><code>-c:s mov_text</code>: ä¸ºå­—å¹•æµé€‰æ‹© mov_text ç¼–ç å™¨ã€‚</li><li><code>-vn</code>, <code>-an</code>, <code>-sn</code>: åˆ†åˆ«æ˜¯ <code>-c:v copy -an -sn</code>ã€<code>-c:a copy -vn -sn</code>ã€<code>-c:s copy -vn -an</code> çš„ç®€å†™ï¼Œä½†æ›´å¸¸ç”¨çš„å«ä¹‰æ˜¯å®Œå…¨<strong>ç¦ç”¨</strong>è§†é¢‘/éŸ³é¢‘/å­—å¹•çš„å½•åˆ¶/è¾“å‡º (ç›¸å½“äºæ˜ å°„åˆ° /dev/null)ã€‚</li></ul></li><li><strong><code>-t duration</code></strong>: æŒ‡å®šè¾“å‡ºæ–‡ä»¶çš„æ—¶é•¿ã€‚</li><li><strong><code>-to position</code></strong>: æŒ‡å®šè¾“å‡ºæ–‡ä»¶çš„ç»“æŸæ—¶é—´ç‚¹ã€‚</li><li><strong><code>-ss position</code></strong>: æŒ‡å®šè¾“å‡ºæ–‡ä»¶çš„<strong>å¼€å§‹æ—¶é—´ç‚¹</strong> (å¦‚æœæ”¾åœ¨è¾“å‡ºé€‰é¡¹ä½ç½®ï¼Œé€šå¸¸ä¼šè¿›è¡Œç²¾ç¡®æŸ¥æ‰¾ï¼Œä½†å¯èƒ½è¾ƒæ…¢ï¼›æ”¾åœ¨è¾“å…¥é€‰é¡¹ <code>-i</code> ä¹‹å‰åˆ™æŸ¥æ‰¾æ›´å¿«ä½†ä¸ç²¾ç¡®)ã€‚</li><li><strong><code>-vf filtergraph</code></strong>: è®¾ç½®è§†é¢‘æ»¤é•œé“¾ (ç®€å•æ»¤é•œå›¾)ã€‚</li><li><strong><code>-af filtergraph</code></strong>: è®¾ç½®éŸ³é¢‘æ»¤é•œé“¾ (ç®€å•æ»¤é•œå›¾)ã€‚</li><li><strong><code>-filter_complex filtergraph</code></strong>: è®¾ç½®å¤æ‚æ»¤é•œå›¾ï¼Œç”¨äºå¤„ç†å¤šä¸ªè¾“å…¥/è¾“å‡ºæµæˆ–éœ€è¦å¤æ‚è¿æ¥çš„æ»¤é•œã€‚</li><li><strong>æ¯”ç‰¹ç‡/è´¨é‡æ§åˆ¶</strong>:<ul><li><code>-b:v bitrate</code>: è®¾ç½®è§†é¢‘ç›®æ ‡æ¯”ç‰¹ç‡ (å¦‚ <code>-b:v 1M</code> è¡¨ç¤º 1 Mbps)ã€‚</li><li><code>-b:a bitrate</code>: è®¾ç½®éŸ³é¢‘ç›®æ ‡æ¯”ç‰¹ç‡ (å¦‚ <code>-b:a 128k</code> è¡¨ç¤º 128 kbps)ã€‚</li><li><code>-crf value</code> (Constant Rate Factor): æ’å®šè´¨é‡å› å­ï¼Œæ˜¯ x264/x265 ç­‰ç¼–ç å™¨å¸¸ç”¨çš„è´¨é‡æ§åˆ¶æ¨¡å¼ï¼Œæ•°å€¼è¶Šä½è´¨é‡è¶Šå¥½ï¼Œæ–‡ä»¶è¶Šå¤§ã€‚</li><li><code>-q:v value</code> / <code>-qscale:v value</code>: æ§åˆ¶è§†é¢‘è´¨é‡ï¼ˆæŸäº›ç¼–ç å™¨ï¼‰ã€‚</li></ul></li><li><strong>è§†é¢‘é€‰é¡¹</strong>:<ul><li><code>-r fps</code>: è®¾ç½®å¸§ç‡ (å¦‚ <code>-r 25</code>)ã€‚</li><li><code>-s WxH</code>: è®¾ç½®è§†é¢‘åˆ†è¾¨ç‡ (å¦‚ <code>-s 1280x720</code>)ã€‚</li><li><code>-aspect ratio</code>: è®¾ç½®ç”»é¢å®½é«˜æ¯” (å¦‚ <code>-aspect 16:9</code>)ã€‚</li><li><code>-pix_fmt format</code>: è®¾ç½®åƒç´ æ ¼å¼ã€‚</li></ul></li><li><strong>éŸ³é¢‘é€‰é¡¹</strong>:<ul><li><code>-ar freq</code>: è®¾ç½®éŸ³é¢‘é‡‡æ ·ç‡ (å¦‚ <code>-ar 44100</code>)ã€‚</li><li><code>-ac channels</code>: è®¾ç½®éŸ³é¢‘é€šé“æ•° (å¦‚ <code>-ac 2</code> è¡¨ç¤ºç«‹ä½“å£°)ã€‚</li><li><code>-vol volume</code>: è°ƒæ•´éŸ³é‡ (å¦‚ <code>-vol 512</code> è¡¨ç¤º 2 å€éŸ³é‡)ã€‚</li></ul></li></ul><p><strong>æµæŒ‡å®šç¬¦ (Stream Specifiers):</strong></p><p>è¿™æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æœºåˆ¶ï¼Œå…è®¸ä½ å°†é€‰é¡¹ç²¾ç¡®åœ°åº”ç”¨åˆ°ç‰¹å®šçš„æµä¸Šã€‚æ ¼å¼é€šå¸¸æ˜¯ <code>é€‰é¡¹å:æµç±»å‹[:æµç´¢å¼•]</code>ã€‚</p><ul><li><code>-c:v libx264</code>: å°†ç¼–ç å™¨ <code>libx264</code> åº”ç”¨äºæ‰€æœ‰è§†é¢‘æµã€‚</li><li><code>-b:a:1 192k</code>: å°†æ¯”ç‰¹ç‡ <code>192k</code> åº”ç”¨äºç¬¬äºŒä¸ªéŸ³é¢‘æµã€‚</li><li><code>-disposition:s:0 default</code>: å°†ç¬¬ä¸€ä¸ªå­—å¹•æµçš„ disposition è®¾ç½®ä¸º defaultã€‚</li><li><code>-map 0:v -map 0:a:0</code>: é€‰æ‹©ç¬¬ä¸€ä¸ªè¾“å…¥æ–‡ä»¶çš„æ‰€æœ‰è§†é¢‘æµå’Œç¬¬ä¸€ä¸ªéŸ³é¢‘æµã€‚</li></ul><h2 id="é—®é¢˜">é—®é¢˜</h2><h3 id="è§†é¢‘åˆ‡å‰²ä¸­å­˜åœ¨çš„é—®é¢˜">è§†é¢‘åˆ‡å‰²ä¸­å­˜åœ¨çš„é—®é¢˜</h3><ul><li>åˆ‡å‰²è§†é¢‘åå­˜åœ¨å¼€å§‹å‰å‡ ç§’ä¸ºé»‘å±</li></ul><blockquote><p>é—®é¢˜åˆ†æ</p></blockquote><blockquote><p>å¸¸è§çš„åŸå› æ˜¯å‰ªè¾‘çš„èµ·å§‹ç‚¹ (-ss) æ²¡æœ‰è½åœ¨å…³é”®å¸§ (Keyframe / I-frame) ä¸Šã€‚</p></blockquote><blockquote><p>æµæ‹·è´æ¨¡å¼ç›´æ¥å¤åˆ¶è§†é¢‘æ•°æ®åŒ…ï¼Œè€Œä¸è¿›è¡Œè§£ç å’Œé‡æ–°ç¼–ç ã€‚è§†é¢‘æ’­æ”¾å™¨é€šå¸¸éœ€è¦ä»ä¸€ä¸ªå…³é”®å¸§å¼€å§‹è§£ç ï¼Œå¦‚æœå‰ªè¾‘åçš„è§†é¢‘ç‰‡æ®µå¼€å¤´ä¸æ˜¯å…³é”®å¸§ï¼Œè€Œæ˜¯ P å¸§æˆ– B å¸§ï¼ˆå®ƒä»¬ä¾èµ–äºä¹‹å‰çš„å¸§è¿›è¡Œè§£ç ï¼‰ï¼Œæ’­æ”¾å™¨å°±æ— æ³•æ­£ç¡®æ˜¾ç¤ºç”»é¢ï¼Œå¯¼è‡´é»‘å±æˆ–èŠ±å±ï¼Œç›´åˆ°é‡åˆ°ç¬¬ä¸€ä¸ªå…³é”®å¸§ä¸ºæ­¢ï¼›é‡æ–°ç¼–ç å¯è§£å†³æ­¤é—®é¢˜ã€‚</p></blockquote><ul><li>æŒ‰ç…§nç§’åˆ‡å‰²ï¼Œå¤§æ‰¹é‡åˆ‡å‰²æ—¶å­˜åœ¨ï¼šn-1æˆ–n+1ç§’è§†é¢‘å­˜åœ¨</li></ul><blockquote><p>é—®é¢˜åˆ†æ</p></blockquote><ol><li><strong>æµæ‹·è´ (<code>-c copy</code>)</strong>: æ­¤æ¨¡å¼ä¸è§£ç å’Œé‡æ–°ç¼–ç è§†é¢‘ã€‚å®ƒç›´æ¥å¤åˆ¶åŸå§‹è§†é¢‘æµçš„æ•°æ®åŒ…ã€‚</li><li><strong>å…³é”®å¸§ (Keyframes)</strong>: è§†é¢‘å‹ç¼©ï¼ˆå¦‚ H.264, H.265ï¼‰ä¾èµ–äºå…³é”®å¸§ã€‚åªæœ‰å…³é”®å¸§å¯ä»¥ç‹¬ç«‹è§£ç ï¼Œåç»­çš„ P å¸§å’Œ B å¸§éœ€è¦ä¾èµ–å…³é”®å¸§æˆ–å…¶ä»–å¸§æ‰èƒ½è§£ç ã€‚å› æ­¤ï¼Œä¸€ä¸ªç‹¬ç«‹çš„ã€å¯æ’­æ”¾çš„è§†é¢‘ç‰‡æ®µ<strong>å¿…é¡»</strong>ä»¥å…³é”®å¸§å¼€å§‹ã€‚</li><li><strong>åˆ†å‰²ç‚¹</strong>: å½“æŒ‡å®šæŒ‰ <code>n</code> ç§’åˆ†å‰²æ—¶ï¼Œ<code>ffmpeg</code>ï¼ˆç‰¹åˆ«æ˜¯ä½¿ç”¨ <code>segment</code> muxer æˆ–ç±»ä¼¼çš„åˆ‡å‰²é€»è¾‘é…åˆ <code>-c copy</code> æ—¶ï¼‰ä¼šå¯»æ‰¾æ—¶é—´æˆ³æ¥è¿‘ <code>n</code>, <code>2n</code>, <code>3n</code>â€¦ çš„ä½ç½®ã€‚ä½†æ˜¯ï¼Œä¸ºäº†ç¡®ä¿è¾“å‡ºçš„æ¯ä¸ªç‰‡æ®µéƒ½èƒ½ç‹¬ç«‹æ’­æ”¾ï¼Œå®ƒ<strong>ä¸èƒ½</strong>åœ¨ä»»æ„å¸§ï¼ˆå¦‚ P å¸§æˆ– B å¸§ï¼‰å¤„åˆ‡å‰²ï¼Œè€Œå¿…é¡»åœ¨åˆ†å‰²ç‚¹<strong>ä¹‹å‰æˆ–ä¹‹åæœ€è¿‘çš„å…³é”®å¸§</strong>å¤„è¿›è¡Œå®é™…åˆ‡å‰²ã€‚</li><li><strong>æ—¶é•¿åå·®</strong>:<ul><li>å¦‚æœ <code>n</code> ç§’å¤„æ°å¥½æ˜¯å…³é”®å¸§ï¼Œé‚£ä¹ˆåˆ†å‰²å¯èƒ½æ¯”è¾ƒå‡†ç¡®ã€‚</li><li>å¦‚æœ <code>n</code> ç§’å¤„ä¸æ˜¯å…³é”®å¸§ï¼Œ<code>ffmpeg</code> é€šå¸¸ä¼šå›æº¯åˆ°<strong>ä¹‹å‰</strong>çš„é‚£ä¸ªå…³é”®å¸§ä½œä¸ºä¸Šä¸€ä¸ªç‰‡æ®µçš„ç»“æŸç‚¹ï¼Œå¹¶ä»è¿™ä¸ªå…³é”®å¸§å¼€å§‹æ–°çš„ç‰‡æ®µã€‚</li><li>è¿™å°±å¯¼è‡´äº†å®é™…åˆ†å‰²ç‚¹ä¸ç†è®ºä¸Šçš„ <code>n</code> ç§’ç‚¹æœ‰åå·®ã€‚è¿™ä¸ªåå·®å–å†³äºå…³é”®å¸§ä¹‹é—´çš„è·ç¦»ï¼ˆGOP sizeï¼‰ã€‚å¦‚æœå…³é”®å¸§é—´éš”å¾ˆå¤§ï¼ˆæ¯”å¦‚ 10 ç§’ï¼‰ï¼Œåå·®å¯èƒ½ä¼šå¾ˆæ˜æ˜¾ã€‚å¦‚æœå…³é”®å¸§é—´éš”å°ï¼ˆæ¯”å¦‚ 1 ç§’ï¼‰ï¼Œåå·®é€šå¸¸è¾ƒå°ï¼Œä½†ä»å¯èƒ½å¯¼è‡´ <code>n-1</code> æˆ– <code>n+1</code> ç§’çš„æƒ…å†µã€‚</li></ul></li></ol><ul><li>command å¦‚ä¸‹ï¼š</li></ul> <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">command</span> = [</span><br><span class="line">    <span class="string">&#x27;ffmpeg&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-i&#x27;</span>, str(input_path),         <span class="comment"># Input file</span></span><br><span class="line">    <span class="string">&#x27;-ss&#x27;</span>, start_timecode_str,     <span class="comment"># Start time</span></span><br><span class="line">    <span class="string">&#x27;-to&#x27;</span>, end_timecode_str,       <span class="comment"># End time</span></span><br><span class="line">    <span class="string">&#x27;-copyts&#x27;</span>,                     <span class="comment"># Copy timestamps</span></span><br><span class="line">    <span class="string">&#x27;-avoid_negative_ts&#x27;</span>, <span class="string">&#x27;make_zero&#x27;</span>, <span class="comment"># Handle timestamp issues</span></span><br><span class="line">    <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;copy&#x27;</span>,                  <span class="comment"># Copy codecs (no re-encoding)</span></span><br><span class="line">    <span class="string">&#x27;-y&#x27;</span>,                          <span class="comment"># Overwrite output file if it exists</span></span><br><span class="line">    str(output_path)               <span class="comment"># Output file</span></span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>ä½¿ç”¨ä¸Šè¿°commandåˆ‡å‰²è§†é¢‘åå­˜åœ¨é»‘å±ã€åˆ†æ®µè§†é¢‘æ—¶é•¿å°äºç›®æ ‡æ—¶é•¿é—®é¢˜ commandé‡‡ç”¨copyè§†é¢‘æµ</p></blockquote><ul><li>æ›´æ¢ä»¥ä¸‹command é‡æ–°ç¼–ç è§†é¢‘æµ</li></ul> <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">command</span> = [</span><br><span class="line">    ffmpeg_path,</span><br><span class="line">    <span class="string">&#x27;-y&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-ss&#x27;</span>, str(start_segment_time),</span><br><span class="line">    <span class="string">&#x27;-i&#x27;</span>, video_file,</span><br><span class="line">    <span class="string">&#x27;-t&#x27;</span>, str(end_segment_time - start_segment_time),</span><br><span class="line">    <span class="string">&#x27;-c:v&#x27;</span>, <span class="string">&#x27;h264_nvenc&#x27;</span> <span class="keyword">if</span> gpu_available <span class="keyword">else</span> <span class="string">&#x27;libx264&#x27;</span>, <span class="comment"># ä½¿ç”¨NVIDIA GPUåŠ é€Ÿçš„ç¼–ç å™¨, å¦‚æœæ²¡æœ‰GPUï¼Œåˆ™ä½¿ç”¨CPU</span></span><br><span class="line">    <span class="string">&#x27;-preset&#x27;</span>, preset,</span><br><span class="line">    <span class="string">&#x27;-crf&#x27;</span>, str(crf),  <span class="comment"># æŒ‡å®šè§†è§‰è´¨é‡</span></span><br><span class="line">    <span class="string">&#x27;-pix_fmt&#x27;</span>, <span class="string">&#x27;yuv420p&#x27;</span>,  <span class="comment"># æŒ‡å®šåƒç´ æ ¼å¼</span></span><br><span class="line">    <span class="string">&#x27;-c:a&#x27;</span>, <span class="string">&#x27;copy&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-avoid_negative_ts&#x27;</span>, <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    output_file</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h2 id="ffmpeg-è½¬ç ">ffmpeg è½¬ç </h2><ul><li>è½¬ç è¿‡ç¨‹å¦‚ä¸‹</li></ul><blockquote><p>è½¬ç æ˜¯æŒ‡å…ˆè§£ç  (decode) ä¸€ä¸ªæµå¾—åˆ°åŸå§‹æ•°æ®ï¼ˆå¦‚è§†é¢‘å¸§æˆ–éŸ³é¢‘æ ·æœ¬ï¼‰ï¼Œç„¶åå†ç”¨æŒ‡å®šçš„ç¼–ç å™¨é‡æ–°ç¼–ç  (encode) è¿™äº›æ•°æ®çš„è¿‡ç¨‹</p></blockquote><p><img src="/2025/04/07/ffmpeg-problem-video/decode.png" class="lazyload placeholder" data-srcset="/2025/04/07/ffmpeg-problem-video/decode.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li>å¤åˆ¶æ•°æ®æµï¼ˆæµå¤åˆ¶ï¼‰</li></ul><blockquote><p>æµå¤åˆ¶æ˜¯æŒ‡ç›´æ¥ä»è¾“å…¥æ–‡ä»¶ä¸­â€œæå–â€åª’ä½“æµï¼ˆå¦‚è§†é¢‘æµã€éŸ³é¢‘æµï¼‰çš„æ•°æ®åŒ… (packets)ï¼Œç„¶ååŸå°ä¸åŠ¨åœ°å°†è¿™äº›æ•°æ®åŒ…â€œæ”¾å…¥â€è¾“å‡ºæ–‡ä»¶ä¸­ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸ç»è¿‡è§£ç å’Œé‡æ–°ç¼–ç ã€‚</p></blockquote><blockquote><p>å›¾ä¸­ç”¨æµå¤åˆ¶åˆå¹¶è§†é¢‘ä¸éŸ³é¢‘æµ æµå¤åˆ¶å¯ç”¨äºåˆå¹¶ã€åˆ†å‰²ã€æå–æ•°æ®æµ</p></blockquote><p><img src="/2025/04/07/ffmpeg-problem-video/encode.png" class="lazyload placeholder" data-srcset="/2025/04/07/ffmpeg-problem-video/encode.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li>æµå¤åˆ¶ç”¨äºè§†é¢‘åˆ†å‰²è¿‡ç¨‹</li></ul><blockquote><p>demuxer åˆ†ç¦»å‡ºä¸¤ä¸ªæµï¼Œæµ 0 è¢«é€åˆ° muxer 0 ç”Ÿæˆ OUTPUT0.mp4ï¼Œæµ 1 è¢«é€åˆ° muxer 1 ç”Ÿæˆ OUTPUT1.mp4</p></blockquote><p><img src="/2025/04/07/ffmpeg-problem-video/encode_split.png" class="lazyload placeholder" data-srcset="/2025/04/07/ffmpeg-problem-video/encode_split.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="å‚è€ƒ">å‚è€ƒ</h2><ul><li>1.<a href="https://www.ffmpeg.org/ffmpeg.html">https://www.ffmpeg.org/ffmpeg.html</a></li><li>2.<a href="https://www.ffmpeg.org/ffprobe.html">https://www.ffmpeg.org/ffprobe.html</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è§†é¢‘åœºæ™¯åˆ‡æ¢æ£€æµ‹</title>
      <link href="/2025/04/03/video-secene-detect/"/>
      <url>/2025/04/03/video-secene-detect/</url>
      
        <content type="html"><![CDATA[<h2 id="èƒŒæ™¯">èƒŒæ™¯</h2><p>ä¸€ä¸ªæ‘„åƒæœºè¿ç»­æ‹æ‘„çš„ä¸€æ®µè§†é¢‘ç‰‡æ®µï¼Œæ²¡æœ‰è¿›è¡Œä¸­æ–­ã€‚ä¸€ä¸ªé•œå¤´é€šå¸¸æ˜¯è§†é¢‘å™äº‹çš„åŸºæœ¬å•ä½ã€‚</p><p><strong>2. é•œå¤´è¯†åˆ«çš„æ„ä¹‰ï¼š</strong></p><ul><li><strong>è§†é¢‘åˆ†æå’Œç†è§£ï¼š</strong> é•œå¤´è¯†åˆ«æ˜¯è§†é¢‘åˆ†æå’Œç†è§£çš„åŸºç¡€ï¼Œå¯ä»¥å¸®åŠ©æå–è§†é¢‘å†…å®¹ï¼Œè¿›è¡Œç»“æ„åŒ–åˆ†æï¼Œä¾‹å¦‚åœºæ™¯æ£€æµ‹ã€æ•…äº‹åˆ†å‰²ç­‰ã€‚</li><li><strong>è§†é¢‘æ£€ç´¢ï¼š</strong> å¯ä»¥ç”¨äºåŸºäºå†…å®¹çš„è§†é¢‘æ£€ç´¢ï¼Œä¾‹å¦‚æŸ¥æ‰¾åŒ…å«ç‰¹å®šå¯¹è±¡çš„é•œå¤´ã€‚</li><li><strong>è§†é¢‘æ‘˜è¦ï¼š</strong> å¯ä»¥ç”¨äºç”Ÿæˆè§†é¢‘æ‘˜è¦ï¼Œé€‰å–å…³é”®é•œå¤´æ¥ä»£è¡¨è§†é¢‘å†…å®¹ã€‚</li><li><strong>è§†é¢‘ç¼–è¾‘ï¼š</strong> æ–¹ä¾¿è§†é¢‘ç¼–è¾‘äººå‘˜å¯¹è§†é¢‘è¿›è¡Œåˆ†å‰²ã€é‡ç»„ç­‰æ“ä½œã€‚</li><li><strong>è§†é¢‘ç›‘æ§ï¼š</strong> å¼‚å¸¸äº‹ä»¶æ£€æµ‹ï¼Œè¡Œä¸ºåˆ†æç­‰ã€‚</li></ul><p><strong>3. é•œå¤´è¯†åˆ«çš„ä¸»è¦æ–¹æ³•ï¼š</strong></p><p>é•œå¤´è¯†åˆ«ä¸»è¦åŸºäºåˆ†æè¿ç»­å¸§ä¹‹é—´çš„å˜åŒ–ï¼Œé€šè¿‡æ£€æµ‹åœºæ™¯è¾¹ç•Œæ¥è¯†åˆ«é•œå¤´ã€‚å¸¸è§çš„æ–¹æ³•åŒ…æ‹¬ï¼š</p><ul><li><strong>åŸºäºé˜ˆå€¼çš„é•œå¤´è¯†åˆ«ï¼š</strong><ul><li><strong>åŸç†ï¼š</strong> é€šè¿‡è®¡ç®—è¿ç»­å¸§ä¹‹é—´çš„å·®å¼‚ï¼ˆä¾‹å¦‚é¢œè‰²ç›´æ–¹å›¾å·®å¼‚ã€åƒç´ å·®å¼‚ã€è¾¹ç¼˜å·®å¼‚ç­‰ï¼‰ï¼Œå½“å·®å¼‚å€¼è¶…è¿‡é¢„è®¾çš„é˜ˆå€¼æ—¶ï¼Œåˆ™è®¤ä¸ºå‘ç”Ÿäº†é•œå¤´åˆ‡æ¢ã€‚</li><li><strong>ä¼˜ç‚¹ï¼š</strong> ç®€å•å¿«é€Ÿï¼Œæ˜“äºå®ç°ã€‚</li><li><strong>ç¼ºç‚¹ï¼š</strong> å¯¹é˜ˆå€¼çš„é€‰æ‹©æ•æ„Ÿï¼Œå®¹æ˜“å—åˆ°å…‰ç…§å˜åŒ–ã€è¿åŠ¨ç­‰å› ç´ çš„å½±å“ã€‚</li></ul></li><li><strong>åŸºäºç»Ÿè®¡æ¨¡å‹çš„é•œå¤´è¯†åˆ«ï¼š</strong><ul><li><strong>åŸç†ï¼š</strong> ä½¿ç”¨ç»Ÿè®¡æ¨¡å‹ï¼ˆä¾‹å¦‚éšé©¬å°”å¯å¤«æ¨¡å‹ HMMï¼‰æ¥æè¿°è§†é¢‘å¸§çš„ç‰¹å¾å˜åŒ–ï¼Œé€šè¿‡æ£€æµ‹æ¨¡å‹çŠ¶æ€çš„å˜åŒ–æ¥è¯†åˆ«é•œå¤´ã€‚</li><li><strong>ä¼˜ç‚¹ï¼š</strong> å¯¹å™ªå£°å’Œå…‰ç…§å˜åŒ–å…·æœ‰ä¸€å®šçš„é²æ£’æ€§ã€‚</li><li><strong>ç¼ºç‚¹ï¼š</strong> æ¨¡å‹è®­ç»ƒéœ€è¦å¤§é‡çš„æ ‡æ³¨æ•°æ®ï¼Œè®¡ç®—å¤æ‚åº¦è¾ƒé«˜ã€‚</li></ul></li><li><strong>åŸºäºæœºå™¨å­¦ä¹ å’Œæ·±åº¦å­¦ä¹ çš„é•œå¤´è¯†åˆ«ï¼š</strong><ul><li><strong>åŸç†ï¼š</strong> ä½¿ç”¨æœºå™¨å­¦ä¹ æˆ–æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼ˆä¾‹å¦‚æ”¯æŒå‘é‡æœº SVMã€å·ç§¯ç¥ç»ç½‘ç»œ CNNã€å¾ªç¯ç¥ç»ç½‘ç»œ RNNï¼‰æ¥å­¦ä¹ è§†é¢‘å¸§çš„ç‰¹å¾ï¼Œå¹¶å¯¹é•œå¤´è¾¹ç•Œè¿›è¡Œåˆ†ç±»ã€‚</li><li><strong>ä¼˜ç‚¹ï¼š</strong> å¯ä»¥å­¦ä¹ å¤æ‚çš„ç‰¹å¾è¡¨ç¤ºï¼Œå…·æœ‰è¾ƒé«˜çš„è¯†åˆ«ç²¾åº¦ã€‚</li><li><strong>ç¼ºç‚¹ï¼š</strong> éœ€è¦å¤§é‡çš„æ ‡æ³¨æ•°æ®è¿›è¡Œè®­ç»ƒï¼Œè®¡ç®—èµ„æºéœ€æ±‚è¾ƒé«˜ã€‚</li></ul></li></ul><p><strong>4. å…·ä½“æ­¥éª¤ï¼š</strong></p><ol><li><strong>è§†é¢‘é¢„å¤„ç†ï¼š</strong><ul><li><strong>è§£ç ï¼š</strong> å°†è§†é¢‘æ–‡ä»¶è§£ç ä¸ºå¸§åºåˆ—ã€‚</li><li><strong>é™å™ªï¼š</strong> å¯¹å¸§åºåˆ—è¿›è¡Œé™å™ªå¤„ç†ï¼Œä¾‹å¦‚ä½¿ç”¨é«˜æ–¯æ»¤æ³¢æˆ–ä¸­å€¼æ»¤æ³¢ã€‚</li><li><strong>è°ƒæ•´å¤§å°ï¼š</strong> å°†å¸§åºåˆ—è°ƒæ•´åˆ°ç»Ÿä¸€çš„å¤§å°ï¼Œä»¥ä¾¿è¿›è¡Œåç»­å¤„ç†ã€‚</li></ul></li><li><strong>ç‰¹å¾æå–ï¼š</strong>  æå–è§†é¢‘å¸§çš„ç‰¹å¾ï¼Œç”¨äºæè¿°è§†é¢‘å†…å®¹ã€‚å¸¸ç”¨çš„ç‰¹å¾åŒ…æ‹¬ï¼š<ul><li><strong>é¢œè‰²ç›´æ–¹å›¾ï¼š</strong>  æè¿°å›¾åƒçš„é¢œè‰²åˆ†å¸ƒã€‚</li><li><strong>ç°åº¦å…±ç”ŸçŸ©é˜µ (GLCM)ï¼š</strong> æè¿°å›¾åƒçš„çº¹ç†ç‰¹å¾ã€‚</li><li><strong>å…‰æµï¼š</strong> æè¿°å›¾åƒä¸­ç‰©ä½“çš„è¿åŠ¨ä¿¡æ¯ã€‚</li><li><strong>å±€éƒ¨äºŒå€¼æ¨¡å¼ (LBP)ï¼š</strong> æè¿°å›¾åƒçš„å±€éƒ¨çº¹ç†ç‰¹å¾ã€‚</li><li><strong>æ·±åº¦å­¦ä¹ ç‰¹å¾ï¼š</strong> ä½¿ç”¨é¢„è®­ç»ƒçš„æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼ˆä¾‹å¦‚ VGGNetã€ResNetï¼‰æå–å›¾åƒçš„ç‰¹å¾ã€‚</li></ul></li><li><strong>å·®å¼‚è®¡ç®—ï¼š</strong>  è®¡ç®—è¿ç»­å¸§ä¹‹é—´çš„å·®å¼‚ã€‚ å¸¸ç”¨çš„å·®å¼‚è®¡ç®—æ–¹æ³•åŒ…æ‹¬ï¼š<ul><li><strong>æ¬§æ°è·ç¦»ï¼š</strong>  è®¡ç®—ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„è·ç¦»ã€‚</li><li><strong>ä½™å¼¦ç›¸ä¼¼åº¦ï¼š</strong> è®¡ç®—ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„è§’åº¦ã€‚</li><li><strong>å¡æ–¹è·ç¦»ï¼š</strong>  è®¡ç®—ä¸¤ä¸ªç›´æ–¹å›¾ä¹‹é—´çš„è·ç¦»ã€‚</li></ul></li><li><strong>é•œå¤´è¾¹ç•Œæ£€æµ‹ï¼š</strong><ul><li><strong>é˜ˆå€¼æ³•ï¼š</strong>  å½“å·®å¼‚å€¼è¶…è¿‡é¢„è®¾çš„é˜ˆå€¼æ—¶ï¼Œåˆ™è®¤ä¸ºå‘ç”Ÿäº†é•œå¤´åˆ‡æ¢ã€‚</li><li><strong>æœºå™¨å­¦ä¹ æ–¹æ³•ï¼š</strong>  ä½¿ç”¨æœºå™¨å­¦ä¹ æ¨¡å‹å¯¹é•œå¤´è¾¹ç•Œè¿›è¡Œåˆ†ç±»ã€‚</li></ul></li><li><strong>åå¤„ç†ï¼š</strong><ul><li><strong>åˆå¹¶çŸ­é•œå¤´ï¼š</strong>  å°†é•¿åº¦å°äºä¸€å®šé˜ˆå€¼çš„é•œå¤´åˆå¹¶åˆ°ç›¸é‚»çš„é•œå¤´ä¸­ã€‚</li><li><strong>å¹³æ»‘é•œå¤´è¾¹ç•Œï¼š</strong>  å¯¹é•œå¤´è¾¹ç•Œè¿›è¡Œå¹³æ»‘å¤„ç†ï¼Œä»¥æé«˜è§†é¢‘è§‚çœ‹ä½“éªŒã€‚</li></ul></li></ol><p><strong>5. æŠ€æœ¯ç»†èŠ‚:</strong></p><ul><li><strong>å¸§é€Ÿç‡ï¼ˆFrame Rateï¼‰ï¼š</strong> å½±å“åˆ†æçš„ç²¾åº¦å’Œè®¡ç®—æˆæœ¬ã€‚é«˜å¸§é€Ÿç‡æä¾›æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼Œä½†ä¹Ÿéœ€è¦æ›´å¤šçš„è®¡ç®—èµ„æºã€‚</li><li><strong>ç‰¹å¾é€‰æ‹©ï¼š</strong> é€‰æ‹©åˆé€‚çš„ç‰¹å¾å¯¹é•œå¤´è¯†åˆ«çš„ç²¾åº¦è‡³å…³é‡è¦ã€‚ ä¾‹å¦‚ï¼Œå¯¹äºå¿«é€Ÿè¿åŠ¨çš„åœºæ™¯ï¼Œå…‰æµç‰¹å¾å¯èƒ½æ›´æœ‰æ•ˆã€‚</li><li><strong>é˜ˆå€¼è®¾å®šï¼š</strong> é˜ˆå€¼çš„è®¾å®šéœ€è¦æ ¹æ®å…·ä½“çš„è§†é¢‘å†…å®¹è¿›è¡Œè°ƒæ•´ã€‚</li><li><strong>æ·±åº¦å­¦ä¹ æ¨¡å‹çš„é€‰æ‹©ï¼š</strong> é€‰æ‹©åˆé€‚çš„æ·±åº¦å­¦ä¹ æ¨¡å‹éœ€è¦æ ¹æ®å…·ä½“çš„åº”ç”¨åœºæ™¯è¿›è¡Œè€ƒè™‘ã€‚</li></ul><h2 id="å®ç°æŠ€æœ¯">å®ç°æŠ€æœ¯</h2><ul><li><strong>OpenCV:</strong>  ä¸€ä¸ªå¼ºå¤§çš„è®¡ç®—æœºè§†è§‰åº“ï¼Œæä¾›äº†å›¾åƒå¤„ç†ã€ç‰¹å¾æå–ã€è§†é¢‘åˆ†æç­‰åŠŸèƒ½ã€‚</li><li><strong>FFmpeg:</strong>  ä¸€ä¸ªå¼€æºçš„å¤šåª’ä½“æ¡†æ¶ï¼Œå¯ä»¥ç”¨äºè§†é¢‘è§£ç ã€ç¼–ç ã€æ ¼å¼è½¬æ¢ç­‰æ“ä½œã€‚</li><li><strong>Scikit-learn:</strong>  ä¸€ä¸ªæµè¡Œçš„æœºå™¨å­¦ä¹ åº“ï¼Œæä¾›äº†å„ç§æœºå™¨å­¦ä¹ ç®—æ³•ã€‚</li><li><strong>TensorFlow/PyTorch:</strong>  æ·±åº¦å­¦ä¹ æ¡†æ¶ï¼Œå¯ä»¥ç”¨äºæ„å»ºå’Œè®­ç»ƒæ·±åº¦å­¦ä¹ æ¨¡å‹ã€‚</li><li><strong>PySceneDetect:</strong> ä¸€ä¸ªä¸“é—¨ç”¨äºåœºæ™¯åˆ†å‰²ï¼ˆå³é•œå¤´è¯†åˆ«ï¼‰çš„Pythonåº“ï¼Œå®ƒåŸºäºOpenCVå’ŒNumPyã€‚</li></ul><h2 id="æŠ€æœ¯é€‰æ‹©">æŠ€æœ¯é€‰æ‹©</h2><p><strong>PySceneDetect:</strong></p><ul><li><strong>æè¿°:</strong> PySceneDetect æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äºåœºæ™¯åˆ†å‰²çš„ Python åº“ï¼Œå®ƒæ„å»ºåœ¨ OpenCV å’Œ NumPy ä¹‹ä¸Šã€‚å®ƒæä¾›äº†å¤šç§åœºæ™¯æ£€æµ‹ç®—æ³•ï¼ŒåŒ…æ‹¬åŸºäºå†…å®¹çš„æ¯”è¾ƒï¼ˆContentDetectorï¼‰ã€é˜ˆå€¼æ£€æµ‹ï¼ˆThresholdDetectorï¼‰ç­‰ã€‚</li><li><strong>ä¼˜ç‚¹:</strong><ul><li>æ˜“äºä½¿ç”¨ï¼šæä¾›äº†ç®€å•çš„ APIï¼Œæ–¹ä¾¿å¿«é€Ÿä¸Šæ‰‹ã€‚</li><li>å¤šç§ç®—æ³•ï¼šå†…ç½®äº†å¤šç§åœºæ™¯æ£€æµ‹ç®—æ³•ï¼Œå¯ä»¥æ ¹æ®è§†é¢‘å†…å®¹é€‰æ‹©åˆé€‚çš„ç®—æ³•ã€‚</li><li>å¯å®šåˆ¶æ€§ï¼šå…è®¸è‡ªå®šä¹‰åœºæ™¯æ£€æµ‹ç®—æ³•ã€‚</li><li>æ–‡æ¡£å®Œå–„ï¼šæ‹¥æœ‰æ¯”è¾ƒå®Œå–„çš„æ–‡æ¡£ã€‚</li></ul></li><li><strong>ç¼ºç‚¹:</strong><ul><li>æ€§èƒ½ï¼šå¯¹äºéå¸¸å¤§çš„è§†é¢‘ï¼Œå¯èƒ½éœ€è¦ä¼˜åŒ–æ€§èƒ½ã€‚</li><li>ç²¾åº¦ï¼šé»˜è®¤å‚æ•°å¯èƒ½ä¸é€‚ç”¨äºæ‰€æœ‰ç±»å‹çš„è§†é¢‘ï¼Œéœ€è¦è°ƒæ•´å‚æ•°ã€‚</li></ul></li></ul><h2 id="ç¬¬ä¸‰æ–¹åº“å®‰è£…ä½¿ç”¨">ç¬¬ä¸‰æ–¹åº“å®‰è£…ä½¿ç”¨</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install scenedetect opencv-python tqdm</span><br></pre></td></tr></table></figure><h3 id="ç®€æ˜“demo">ç®€æ˜“demo</h3><ul><li>æ£€æµ‹è§†é¢‘ä¸­çš„åœºæ™¯åˆ‡æ¢å¸§ï¼Œè¾“å‡ºå›¾ç‰‡ä¸csvæ–‡ä»¶</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scenedetect --input goldeneye.mp4 detect-adaptive list-scenes save-images</span><br></pre></td></tr></table></figure><h3 id="å…³äºåœºæ™¯åˆ‡æ¢æ£€æµ‹é˜ˆå€¼çš„ç¡®è®¤">å…³äºåœºæ™¯åˆ‡æ¢æ£€æµ‹é˜ˆå€¼çš„ç¡®è®¤</h3><blockquote><p>ä¾‹å¦‚ï¼Œå¯¹äºdetect-contentï¼Œå¦‚æœé»˜è®¤é˜ˆå€¼27æ²¡æœ‰äº§ç”Ÿæ­£ç¡®çš„ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é¦–å…ˆç”Ÿæˆç»Ÿè®¡æ–‡ä»¶æ¥ç¡®å®šé€‚å½“çš„é˜ˆå€¼ï¼š</p></blockquote><blockquote><p>scenedetect --input goldeneye.mp4 --stats goldeneye.stats.csv detect-adaptive<br>ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ç»˜åˆ¶content_valåˆ—çš„å€¼</p></blockquote><ul><li>ä»£ç å¦‚ä¸‹ï¼š</li></ul><blockquote><p>å…³é”®ä»£ç å±•ç¤º</p></blockquote><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">generate_stats_csv</span>(<span class="params">video_path, output_dir, threshold</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Detects scenes and saves frame statistics (Frame Num, content_val) to a CSV.</span></span><br><span class="line"><span class="string">    Returns True on success, False on failure.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    thread_name = threading.current_thread().name</span><br><span class="line">    video_filename_base = os.path.splitext(os.path.basename(video_path))[<span class="number">0</span>]</span><br><span class="line">    output_csv_path = os.path.join(output_dir, <span class="string">f&quot;<span class="subst">&#123;video_filename_base&#125;</span>_stats.csv&quot;</span>)</span><br><span class="line">    temp_stats_path = os.path.join(output_dir, <span class="string">f&quot;<span class="subst">&#123;video_filename_base&#125;</span>_temp_full_stats.csv&quot;</span>)</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Processing: <span class="subst">&#123;os.path.basename(video_path)&#125;</span>&quot;</span>)</span><br><span class="line">    video_manager = <span class="literal">None</span></span><br><span class="line">    stats_manager = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 1. Initialize</span></span><br><span class="line">        video_manager = VideoStreamCv2(video_path)</span><br><span class="line">        stats_manager = StatsManager()</span><br><span class="line">        scene_manager = SceneManager(stats_manager)</span><br><span class="line">        scene_manager.add_detector(ContentDetector(threshold=threshold))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2. Get duration</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            total_frames = video_manager.duration.get_frames()</span><br><span class="line">            <span class="keyword">if</span> total_frames &lt;= <span class="number">0</span>:</span><br><span class="line">                logger.warning(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Video <span class="subst">&#123;os.path.basename(video_path)&#125;</span> reported 0 frames. Skipping.&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> info_err:</span><br><span class="line">             logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Error getting video duration for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;info_err&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">             <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3. Run detection</span></span><br><span class="line">        logger.debug(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Running detect_scenes for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>&quot;</span>)</span><br><span class="line">        scene_manager.detect_scenes(frame_source=video_manager)</span><br><span class="line">        logger.debug(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] detect_scenes finished for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 4. Save *full* statistics temporarily by passing a FILE HANDLE</span></span><br><span class="line">        logger.debug(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Saving full stats to temporary file: <span class="subst">&#123;temp_stats_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># --- MODIFIED PART ---</span></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(temp_stats_path, <span class="string">&#x27;w&#x27;</span>, newline=<span class="string">&#x27;&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                 stats_manager.save_to_csv(f) <span class="comment"># Pass the open file handle &#x27;f&#x27; directly</span></span><br><span class="line">            <span class="comment"># ---------------------</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(temp_stats_path):</span><br><span class="line">                 logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] StatsManager failed to create the temporary stats file: <span class="subst">&#123;temp_stats_path&#125;</span>&quot;</span>)</span><br><span class="line">                 <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">except</span> TypeError <span class="keyword">as</span> te:</span><br><span class="line">             <span class="comment"># Catch if even passing a handle is wrong</span></span><br><span class="line">             logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] TypeError calling save_to_csv for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>. API mismatch. Error: <span class="subst">&#123;te&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">             <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> save_err:</span><br><span class="line">             logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Error saving temporary stats file <span class="subst">&#123;temp_stats_path&#125;</span>: <span class="subst">&#123;save_err&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">             <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 5. Read the temp stats CSV and extract desired columns</span></span><br><span class="line">        <span class="comment"># (Keep this part the same as the previous version)</span></span><br><span class="line">        logger.debug(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Reading temporary stats file: <span class="subst">&#123;temp_stats_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            stats_df = pd.read_csv(temp_stats_path, skipinitialspace=<span class="literal">True</span>)</span><br><span class="line">            stats_df.columns = stats_df.columns.<span class="built_in">str</span>.strip()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> FRAME_NUM_COL <span class="keyword">not</span> <span class="keyword">in</span> stats_df.columns <span class="keyword">or</span> CONTENT_VAL_COL <span class="keyword">not</span> <span class="keyword">in</span> stats_df.columns:</span><br><span class="line">                logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Temporary stats file (<span class="subst">&#123;temp_stats_path&#125;</span>) is missing required columns. Found: <span class="subst">&#123;stats_df.columns.tolist()&#125;</span>. Expected: &#x27;<span class="subst">&#123;FRAME_NUM_COL&#125;</span>&#x27;, &#x27;<span class="subst">&#123;CONTENT_VAL_COL&#125;</span>&#x27;&quot;</span>)</span><br><span class="line">                <span class="comment"># Keep the temp file for inspection if columns are missing</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span> <span class="comment"># Return failure</span></span><br><span class="line"></span><br><span class="line">            output_df = stats_df[[FRAME_NUM_COL, CONTENT_VAL_COL]]</span><br><span class="line">            logger.debug(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Saving extracted stats to final file: <span class="subst">&#123;output_csv_path&#125;</span>&quot;</span>)</span><br><span class="line">            output_df.to_csv(output_csv_path, index=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">            logger.info(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Successfully generated stats CSV: <span class="subst">&#123;os.path.basename(output_csv_path)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span> <span class="comment"># Return success</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> pd.errors.EmptyDataError:</span><br><span class="line">            logger.warning(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Temporary stats file was empty: <span class="subst">&#123;temp_stats_path&#125;</span>. No scenes likely detected or error during stats generation.&quot;</span>)</span><br><span class="line">            <span class="comment"># Create an empty output file with correct headers</span></span><br><span class="line">            pd.DataFrame(columns=[FRAME_NUM_COL, CONTENT_VAL_COL]).to_csv(output_csv_path, index=<span class="literal">False</span>)</span><br><span class="line">            logger.info(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Created empty stats CSV (as temp was empty): <span class="subst">&#123;os.path.basename(output_csv_path)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span> <span class="comment"># Count as processed successfully (empty result)</span></span><br><span class="line">        <span class="keyword">except</span> KeyError <span class="keyword">as</span> e:</span><br><span class="line">             logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Column not found in temporary stats file (<span class="subst">&#123;temp_stats_path&#125;</span>): <span class="subst">&#123;e&#125;</span>. Available columns: <span class="subst">&#123;stats_df.columns.tolist()&#125;</span>&quot;</span>)</span><br><span class="line">             <span class="comment"># Keep the temp file for inspection</span></span><br><span class="line">             <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Error processing temporary stats file <span class="subst">&#123;temp_stats_path&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> VideoOpenFailure <span class="keyword">as</span> vf_err:</span><br><span class="line">        logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Failed to open video <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;vf_err&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Error during scene detection/stats generation for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">if</span> video_manager <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">hasattr</span>(video_manager, <span class="string">&#x27;_cap&#x27;</span>) <span class="keyword">and</span> video_manager._cap <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="built_in">hasattr</span>(video_manager._cap, <span class="string">&#x27;release&#x27;</span>):</span><br><span class="line">                    video_manager._cap.release()</span><br><span class="line">                <span class="keyword">del</span> video_manager</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> del_e:</span><br><span class="line">                 logger.warning(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Exception while cleaning up video_manager for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;del_e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Clean up temporary stats file ONLY IF the final CSV was successfully created or was intentionally empty</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;output_df&#x27;</span> <span class="keyword">in</span> <span class="built_in">locals</span>() <span class="keyword">or</span> ( <span class="string">&#x27;stats_df&#x27;</span> <span class="keyword">in</span> <span class="built_in">locals</span>() <span class="keyword">and</span> stats_df.empty ): <span class="comment"># Check if processing reached CSV saving/empty handling stage</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;temp_stats_path&#x27;</span> <span class="keyword">in</span> <span class="built_in">locals</span>() <span class="keyword">and</span> os.path.exists(temp_stats_path):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    os.remove(temp_stats_path)</span><br><span class="line">                    logger.debug(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Removed temporary stats file: <span class="subst">&#123;temp_stats_path&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">except</span> OSError <span class="keyword">as</span> e:</span><br><span class="line">                    logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Failed to remove temporary stats file <span class="subst">&#123;temp_stats_path&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">             <span class="comment"># If processing failed before reading/writing the final CSV, keep the temp file for debugging</span></span><br><span class="line">              <span class="keyword">if</span> <span class="string">&#x27;temp_stats_path&#x27;</span> <span class="keyword">in</span> <span class="built_in">locals</span>() <span class="keyword">and</span> os.path.exists(temp_stats_path):</span><br><span class="line">                    logger.warning(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Keeping temporary stats file due to processing error: <span class="subst">&#123;temp_stats_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ... (Rest of the code remains the same: process_video, find_video_files, move_video, main, __main__) ...</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">root_dir, dest_dir, num_threads, threshold</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Main function to orchestrate the CSV generation process.&quot;&quot;&quot;</span></span><br><span class="line">    root_dir = os.path.normpath(root_dir)</span><br><span class="line">    dest_dir = os.path.normpath(dest_dir)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Ensure destination directory exists</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        os.makedirs(dest_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">        logger.info(<span class="string">f&quot;Ensured destination directory exists: <span class="subst">&#123;dest_dir&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> OSError <span class="keyword">as</span> e:</span><br><span class="line">        logger.critical(<span class="string">f&quot;Failed to create destination directory &#x27;<span class="subst">&#123;dest_dir&#125;</span>&#x27;: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="comment"># Cannot proceed without output directory</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">         logger.critical(<span class="string">f&quot;Unexpected error creating destination directory &#x27;<span class="subst">&#123;dest_dir&#125;</span>&#x27;: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Find video files, excluding any already in the destination</span></span><br><span class="line">    video_files_all = find_video_files(root_dir)</span><br><span class="line">    abs_dest_dir = os.path.abspath(dest_dir)</span><br><span class="line">    video_files = [f <span class="keyword">for</span> f <span class="keyword">in</span> video_files_all <span class="keyword">if</span> <span class="keyword">not</span> os.path.abspath(f).startswith(abs_dest_dir)]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(video_files) &lt; <span class="built_in">len</span>(video_files_all):</span><br><span class="line">         logger.warning(<span class="string">f&quot;Filtered out <span class="subst">&#123;<span class="built_in">len</span>(video_files_all) - <span class="built_in">len</span>(video_files)&#125;</span> files potentially inside the destination directory &#x27;<span class="subst">&#123;dest_dir&#125;</span>&#x27;.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> video_files:</span><br><span class="line">        logger.error(<span class="string">f&quot;No valid video files found in &#x27;<span class="subst">&#123;root_dir&#125;</span>&#x27; (excluding destination directory).&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">f&quot;Starting stats CSV generation for <span class="subst">&#123;<span class="built_in">len</span>(video_files)&#125;</span> videos from &#x27;<span class="subst">&#123;root_dir&#125;</span>&#x27; using <span class="subst">&#123;num_threads&#125;</span> threads.&quot;</span>)</span><br><span class="line">    logger.info(<span class="string">f&quot;Output CSV files will be saved in: <span class="subst">&#123;dest_dir&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    start_overall_time = time.time()</span><br><span class="line">    processed_count = <span class="number">0</span></span><br><span class="line">    successful_runs = <span class="number">0</span></span><br><span class="line">    failed_runs = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(max_workers=num_threads, thread_name_prefix=<span class="string">&#x27;StatsGenWorker&#x27;</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        <span class="comment"># Submit tasks: Pass video path, output dir, and threshold</span></span><br><span class="line">        futures = &#123;executor.submit(generate_stats_csv, video_file, dest_dir, threshold): video_file <span class="keyword">for</span> video_file <span class="keyword">in</span> video_files&#125;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;All tasks submitted. Waiting for completion...&quot;</span>)</span><br><span class="line">        <span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> as_completed</span><br><span class="line">        <span class="comment"># Use tqdm with as_completed for better progress feedback</span></span><br><span class="line">        <span class="keyword">for</span> future <span class="keyword">in</span> tqdm(as_completed(futures), total=<span class="built_in">len</span>(futures), desc=<span class="string">&quot;Overall Progress&quot;</span>):</span><br><span class="line">            video_file = futures[future] <span class="comment"># Get associated video file</span></span><br><span class="line">            processed_count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                success = future.result() <span class="comment"># Get boolean result from generate_stats_csv</span></span><br><span class="line">                <span class="keyword">if</span> success:</span><br><span class="line">                    successful_runs += <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    failed_runs += <span class="number">1</span></span><br><span class="line">                    <span class="comment"># Error is already logged within the function</span></span><br><span class="line">                    logger.debug(<span class="string">f&quot;Task for <span class="subst">&#123;os.path.basename(video_file)&#125;</span> completed with failure (logged previously).&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">                <span class="comment"># Catch exceptions that might occur if future.result() itself fails unexpectedly</span></span><br><span class="line">                failed_runs += <span class="number">1</span></span><br><span class="line">                logger.error(<span class="string">f&quot;Unexpected error getting result for <span class="subst">&#123;os.path.basename(video_file)&#125;</span>: <span class="subst">&#123;exc&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    end_overall_time = time.time()</span><br><span class="line">    logger.info(<span class="string">f&quot;Stats CSV generation complete.&quot;</span>)</span><br><span class="line">    logger.info(<span class="string">f&quot;Summary: <span class="subst">&#123;<span class="built_in">len</span>(video_files)&#125;</span> videos submitted. <span class="subst">&#123;successful_runs&#125;</span> processed successfully, <span class="subst">&#123;failed_runs&#125;</span> encountered errors.&quot;</span>)</span><br><span class="line">    logger.info(<span class="string">f&quot;Total execution time: <span class="subst">&#123;end_overall_time - start_overall_time:<span class="number">.2</span>f&#125;</span> seconds.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># --- Initial Checks ---</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> check_ffmpeg():</span><br><span class="line">        <span class="comment"># Optional: Decide whether to proceed without FFmpeg warning or exit</span></span><br><span class="line">        <span class="comment"># sys.exit(1)</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    check_acceleration_support()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- Setup Directories ---</span></span><br><span class="line">    root_directory = <span class="string">r&#x27;/Volumes/shared/æ ‡æ³¨/å½±è§†&#x27;</span></span><br><span class="line">    destination_directory = <span class="string">r&#x27;./data&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Use defaults if not using argparse</span></span><br><span class="line">    detection_threshold = DEFAULT_THRESHOLD</span><br><span class="line">    thread_count = DEFAULT_NUM_THREADS</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- Directory Validation ---</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(root_directory):</span><br><span class="line">        logger.critical(<span class="string">f&quot;Input root directory &#x27;<span class="subst">&#123;root_directory&#125;</span>&#x27; not found or is not a directory.&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># Destination directory creation is handled in main()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- Run Main Process ---</span></span><br><span class="line">    main(root_directory, destination_directory, thread_count, detection_threshold)</span><br></pre></td></tr></table></figure><h2 id="æµ‹è¯•demo">æµ‹è¯•demo</h2><blockquote><p>ä½¿ç”¨ PySceneDetect å¿«é€Ÿåˆ†æè§†é¢‘ å¹¶è¾“å‡ºå„ç§å‚æ•°åˆ°csv</p></blockquote> <figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥ç¡¬ä»¶åŠ é€Ÿæ”¯æŒ</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detect_scenes</span>(<span class="params">video_path, threshold=<span class="number">30.0</span>, downscale_width=<span class="number">640</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Detects scene changes in a video using PySceneDetect with VideoStreamCv2.&quot;&quot;&quot;</span></span><br><span class="line">    video_manager = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 1. åˆå§‹åŒ–</span></span><br><span class="line">        logging.debug(<span class="string">f&quot;Initializing VideoStreamCv2 for: <span class="subst">&#123;os.path.basename(video_path)&#125;</span>&quot;</span>)</span><br><span class="line">        video_manager = VideoStreamCv2(video_path)</span><br><span class="line">        logging.info(<span class="string">f&quot;Initialized VideoStreamCv2 for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        stats_manager = StatsManager()</span><br><span class="line">        scene_manager = SceneManager(stats_manager)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2. æ·»åŠ åœºæ™¯æ£€æµ‹å™¨</span></span><br><span class="line">        scene_manager.add_detector(ContentDetector(threshold=threshold))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3. è·å–è§†é¢‘ä¿¡æ¯ for Progress Bar</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            total_frames = video_manager.duration.get_frames()</span><br><span class="line">            logging.debug(<span class="string">f&quot;Video Info: Total Frames=<span class="subst">&#123;total_frames&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> info_err:</span><br><span class="line">             logging.error(<span class="string">f&quot;Error getting video info (duration) for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;info_err&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">             <span class="keyword">if</span> video_manager <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>: <span class="keyword">del</span> video_manager</span><br><span class="line">             <span class="keyword">return</span> <span class="literal">None</span>, video_path</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> total_frames &lt;= <span class="number">0</span>:</span><br><span class="line">             logging.warning(<span class="string">f&quot;Video <span class="subst">&#123;os.path.basename(video_path)&#125;</span> reported 0 frames. Skipping processing.&quot;</span>)</span><br><span class="line">             <span class="keyword">if</span> video_manager <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>: <span class="keyword">del</span> video_manager</span><br><span class="line">             <span class="keyword">return</span> <span class="number">0</span>, video_path</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 4. è®¾ç½®(ç®€åŒ–çš„)è¿›åº¦æ¡å¹¶æ‰§è¡Œæ£€æµ‹</span></span><br><span class="line">        <span class="comment"># The frame-by-frame callback doesn&#x27;t work with this version.</span></span><br><span class="line">        <span class="comment"># The tqdm bar will show progress only after detect_scenes finishes for the file.</span></span><br><span class="line">        <span class="keyword">with</span> tqdm(total=total_frames, desc=<span class="string">f&quot;Processing <span class="subst">&#123;os.path.basename(video_path)&#125;</span>&quot;</span>, unit=<span class="string">&quot;frame&quot;</span>, leave=<span class="literal">False</span>) <span class="keyword">as</span> pbar:</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 5. æ‰§è¡Œåœºæ™¯æ£€æµ‹ - Pass the video_manager as frame_source</span></span><br><span class="line">            scene_manager.detect_scenes(frame_source=video_manager)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Manually update pbar to 100% after completion if needed,</span></span><br><span class="line">            <span class="comment"># though tqdm might do this automatically on exit from &#x27;with&#x27;.</span></span><br><span class="line">            pbar.n = total_frames <span class="comment"># Set progress to max</span></span><br><span class="line">            pbar.refresh()       <span class="comment"># Refresh display</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 6. è·å–ç»“æœ</span></span><br><span class="line">        scene_list = scene_manager.get_scene_list()</span><br><span class="line"></span><br><span class="line">        logging.info(<span class="string">f&quot;Detected <span class="subst">&#123;<span class="built_in">len</span>(scene_list)&#125;</span> scenes in <span class="subst">&#123;os.path.basename(video_path)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 7. èµ„æºç®¡ç†</span></span><br><span class="line">        <span class="comment"># del video_manager</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(scene_list), video_path</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> cv2.error <span class="keyword">as</span> cv_err:</span><br><span class="line">         logging.error(<span class="string">f&quot;OpenCV error processing <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;cv_err&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">None</span>, video_path</span><br><span class="line">    <span class="keyword">except</span> VideoOpenFailure <span class="keyword">as</span> vf_err:</span><br><span class="line">         logging.error(<span class="string">f&quot;Failed to open video <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;vf_err&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">None</span>, video_path</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;Generic error processing <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, video_path</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">         <span class="keyword">if</span> <span class="string">&#x27;video_manager&#x27;</span> <span class="keyword">in</span> <span class="built_in">locals</span>() <span class="keyword">and</span> video_manager <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">             <span class="keyword">try</span>: <span class="keyword">del</span> video_manager</span><br><span class="line">             <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ... (Keep process_video, find_video_files, move_video, main, __main__ block the same) ...</span></span><br><span class="line"><span class="comment"># ... [Rest of the code] ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_video</span>(<span class="params">video_path, threshold, dest_dir, downscale_width</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¤„ç†å•ä¸ªè§†é¢‘ï¼Œæ•è·å¼‚å¸¸, å¹¶ç§»åŠ¨è§†é¢‘&quot;&quot;&quot;</span></span><br><span class="line">    thread_name = threading.current_thread().name</span><br><span class="line">    logging.info(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Starting processing for: <span class="subst">&#123;os.path.basename(video_path)&#125;</span>&quot;</span>)</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    num_scenes = <span class="literal">None</span>  <span class="comment"># Initialize</span></span><br><span class="line">    processed_video_path = video_path  <span class="comment"># Assume original path initially</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        num_scenes, processed_video_path = detect_scenes(video_path, threshold, downscale_width)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Check if detect_scenes returned None for path (shouldn&#x27;t happen with current logic, but defensive)</span></span><br><span class="line">        <span class="keyword">if</span> processed_video_path <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            logging.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Video path became None during processing for <span class="subst">&#123;video_path&#125;</span>. Skipping move.&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span>  <span class="comment"># Explicitly return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> num_scenes <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> num_scenes &gt; <span class="number">1</span>:</span><br><span class="line">            <span class="comment"># Check if the source file still exists before moving (it might fail during processing)</span></span><br><span class="line">            <span class="keyword">if</span> os.path.exists(processed_video_path):</span><br><span class="line">                move_video(processed_video_path, dest_dir)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                logging.warning(</span><br><span class="line">                    <span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Source file <span class="subst">&#123;processed_video_path&#125;</span> not found after processing. Cannot move.&quot;</span>)</span><br><span class="line">        <span class="keyword">elif</span> num_scenes <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:  <span class="comment"># Includes case where num_scenes is 0 because no frames were processed</span></span><br><span class="line">            logging.info(</span><br><span class="line">                <span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Video <span class="subst">&#123;os.path.basename(processed_video_path)&#125;</span> is single scene or failed processing. No move needed.&quot;</span>)</span><br><span class="line">        <span class="comment"># else case (num_scenes is None) is implicitly handled by the warning below</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> num_scenes <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># This case means detect_scenes failed and returned None for num_scenes</span></span><br><span class="line">            logging.warning(</span><br><span class="line">                <span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Video <span class="subst">&#123;os.path.basename(processed_video_path)&#125;</span> failed processing entirely. No move needed.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># Catch any unexpected error during the move decision or logging</span></span><br><span class="line">        logging.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Top-level error in process_video for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>,</span><br><span class="line">                      exc_info=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        end_time = time.time()</span><br><span class="line">        status = <span class="string">&quot;failed&quot;</span> <span class="keyword">if</span> num_scenes <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> <span class="string">f&quot;<span class="subst">&#123;num_scenes&#125;</span> scenes&quot;</span></span><br><span class="line">        logging.info(</span><br><span class="line">            <span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Finished processing <span class="subst">&#123;os.path.basename(video_path)&#125;</span> (<span class="subst">&#123;status&#125;</span>) in <span class="subst">&#123;end_time - start_time:<span class="number">.2</span>f&#125;</span> seconds.&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="åœºæ™¯åˆ‡å‰²">åœºæ™¯åˆ‡å‰²</h2><ul><li>æ ¹æ®è§†é¢‘å†…åœºæ™¯åˆ‡æ¢ åˆ‡å‰²è§†é¢‘</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detect_scenes</span>(<span class="params">video_path, threshold=<span class="number">30.0</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Detects scene changes in a video using PySceneDetect with VideoStreamCv2.&quot;&quot;&quot;</span></span><br><span class="line">    video_manager = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        logger.debug(<span class="string">f&quot;Initializing VideoStreamCv2 for: <span class="subst">&#123;os.path.basename(video_path)&#125;</span>&quot;</span>)</span><br><span class="line">        video_manager = VideoStreamCv2(video_path)</span><br><span class="line">        logger.info(<span class="string">f&quot;Initialized VideoStreamCv2 for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        stats_manager = StatsManager()</span><br><span class="line">        scene_manager = SceneManager(stats_manager)</span><br><span class="line">        scene_manager.add_detector(ContentDetector(threshold=threshold))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            total_frames = video_manager.duration.get_frames()</span><br><span class="line">            <span class="comment"># base_timecode = video_manager.base_timecode # No longer needed for get_scene_list</span></span><br><span class="line">            logging.debug(<span class="string">f&quot;Video Info: Total Frames=<span class="subst">&#123;total_frames&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> info_err:</span><br><span class="line">             logger.error(<span class="string">f&quot;Error getting video info (duration) for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;info_err&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">             <span class="keyword">return</span> <span class="literal">None</span>, video_path, <span class="literal">None</span> <span class="comment"># Return None for scene list</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> total_frames &lt;= <span class="number">0</span>:</span><br><span class="line">             logger.warning(<span class="string">f&quot;Video <span class="subst">&#123;os.path.basename(video_path)&#125;</span> reported 0 frames. Skipping processing.&quot;</span>)</span><br><span class="line">             <span class="keyword">return</span> <span class="number">0</span>, video_path, [] <span class="comment"># Return 0 scenes, empty list</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Execute scene detection (no progress bar here as callback wasn&#x27;t reliable)</span></span><br><span class="line">        logger.debug(<span class="string">f&quot;Starting scene detection for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>&quot;</span>)</span><br><span class="line">        scene_manager.detect_scenes(frame_source=video_manager)</span><br><span class="line">        logger.debug(<span class="string">f&quot;Finished scene detection for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Get scene list (without base_timecode)</span></span><br><span class="line">        scene_list = scene_manager.get_scene_list()</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">f&quot;Detected <span class="subst">&#123;<span class="built_in">len</span>(scene_list)&#125;</span> scenes in <span class="subst">&#123;os.path.basename(video_path)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Return scene count, path, and the actual scene list for splitting</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(scene_list), video_path, scene_list</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> cv2.error <span class="keyword">as</span> cv_err:</span><br><span class="line">         logger.error(<span class="string">f&quot;OpenCV error processing <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;cv_err&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">None</span>, video_path, <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> VideoOpenFailure <span class="keyword">as</span> vf_err:</span><br><span class="line">         logger.error(<span class="string">f&quot;Failed to open video <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;vf_err&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">None</span>, video_path, <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Generic error during scene detection for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, video_path, <span class="literal">None</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">         <span class="comment"># Ensure the video file is closed/released by deleting the reference</span></span><br><span class="line">         <span class="keyword">if</span> <span class="string">&#x27;video_manager&#x27;</span> <span class="keyword">in</span> <span class="built_in">locals</span>() <span class="keyword">and</span> video_manager <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">             <span class="keyword">try</span>:</span><br><span class="line">                 <span class="comment"># Explicitly call internal capture release if possible</span></span><br><span class="line">                 <span class="keyword">if</span> <span class="built_in">hasattr</span>(video_manager, <span class="string">&#x27;_cap&#x27;</span>) <span class="keyword">and</span> video_manager._cap <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="built_in">hasattr</span>(video_manager._cap, <span class="string">&#x27;release&#x27;</span>):</span><br><span class="line">                     video_manager._cap.release()</span><br><span class="line">                 <span class="keyword">del</span> video_manager</span><br><span class="line">             <span class="keyword">except</span> Exception <span class="keyword">as</span> del_e:</span><br><span class="line">                 logger.warning(<span class="string">f&quot;Exception while cleaning up video_manager for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;del_e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">split_video_scene</span>(<span class="params">input_path, output_path, start_timecode_str, end_timecode_str</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Splits a video segment using FFmpeg without re-encoding.&quot;&quot;&quot;</span></span><br><span class="line">    thread_name = threading.current_thread().name</span><br><span class="line">    logger.info(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Splitting scene: <span class="subst">&#123;os.path.basename(output_path)&#125;</span> (<span class="subst">&#123;start_timecode_str&#125;</span> -&gt; <span class="subst">&#123;end_timecode_str&#125;</span>)&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Ensure output directory exists</span></span><br><span class="line">    os.makedirs(os.path.dirname(output_path), exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Construct FFmpeg command</span></span><br><span class="line">    <span class="comment"># Using -ss after -i and -copyts is generally more frame-accurate for splitting with -c copy</span></span><br><span class="line">    command = [</span><br><span class="line">        <span class="string">&#x27;ffmpeg&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;-i&#x27;</span>, <span class="built_in">str</span>(input_path),         <span class="comment"># Input file</span></span><br><span class="line">        <span class="string">&#x27;-ss&#x27;</span>, start_timecode_str,     <span class="comment"># Start time</span></span><br><span class="line">        <span class="string">&#x27;-to&#x27;</span>, end_timecode_str,       <span class="comment"># End time</span></span><br><span class="line">        <span class="string">&#x27;-copyts&#x27;</span>,                     <span class="comment"># Copy timestamps</span></span><br><span class="line">        <span class="string">&#x27;-avoid_negative_ts&#x27;</span>, <span class="string">&#x27;make_zero&#x27;</span>, <span class="comment"># Handle timestamp issues</span></span><br><span class="line">        <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;copy&#x27;</span>,                  <span class="comment"># Copy codecs (no re-encoding)</span></span><br><span class="line">        <span class="string">&#x27;-y&#x27;</span>,                          <span class="comment"># Overwrite output file if it exists</span></span><br><span class="line">        <span class="built_in">str</span>(output_path)               <span class="comment"># Output file</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># Run FFmpeg command</span></span><br><span class="line">        <span class="comment"># creationflags prevents console window popup on Windows</span></span><br><span class="line">        process = subprocess.run(</span><br><span class="line">            command,</span><br><span class="line">            stdout=subprocess.PIPE,</span><br><span class="line">            stderr=subprocess.PIPE,</span><br><span class="line">            check=<span class="literal">True</span>, <span class="comment"># Raise CalledProcessError if ffmpeg returns non-zero exit code</span></span><br><span class="line">            creationflags=subprocess.CREATE_NO_WINDOW <span class="keyword">if</span> platform.system() == <span class="string">&quot;Windows&quot;</span> <span class="keyword">else</span> <span class="number">0</span>,</span><br><span class="line">            encoding=<span class="string">&#x27;utf-8&#x27;</span>, <span class="comment"># Capture output as text</span></span><br><span class="line">            errors=<span class="string">&#x27;replace&#x27;</span> <span class="comment"># Handle potential decoding errors in ffmpeg output</span></span><br><span class="line">        )</span><br><span class="line">        logger.info(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Successfully split: <span class="subst">&#123;os.path.basename(output_path)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># logger.debug(f&quot;FFmpeg stdout:\n&#123;process.stdout&#125;&quot;) # Usually empty for -c copy</span></span><br><span class="line">        <span class="comment"># logger.debug(f&quot;FFmpeg stderr:\n&#123;process.stderr&#125;&quot;) # Contains progress/info</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> subprocess.CalledProcessError <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] FFmpeg failed for <span class="subst">&#123;os.path.basename(output_path)&#125;</span>.&quot;</span>)</span><br><span class="line">        logger.error(<span class="string">f&quot;  Command: <span class="subst">&#123;<span class="string">&#x27; &#x27;</span>.join(command)&#125;</span>&quot;</span>) <span class="comment"># Log the command for easier debugging</span></span><br><span class="line">        logger.error(<span class="string">f&quot;  Return Code: <span class="subst">&#123;e.returncode&#125;</span>&quot;</span>)</span><br><span class="line">        logger.error(<span class="string">f&quot;  Stderr:\n<span class="subst">&#123;e.stderr&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># Optionally log stdout too: logger.error(f&quot;  Stdout:\n&#123;e.stdout&#125;&quot;)</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        logger.critical(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] FFmpeg command not found during split. Ensure FFmpeg is installed and in PATH.&quot;</span>)</span><br><span class="line">        <span class="comment"># No point continuing if ffmpeg isn&#x27;t found for any split</span></span><br><span class="line">        <span class="keyword">raise</span> <span class="comment"># Re-raise to potentially stop the whole process</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Unexpected error splitting <span class="subst">&#123;os.path.basename(output_path)&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_video</span>(<span class="params">video_path, threshold, base_dest_dir, originals_dir, downscale_width</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Detects scenes, splits video if multiple scenes are found, and moves original.&quot;&quot;&quot;</span></span><br><span class="line">    thread_name = threading.current_thread().name</span><br><span class="line">    base_name = os.path.splitext(os.path.basename(video_path))[<span class="number">0</span>]</span><br><span class="line">    file_ext = os.path.splitext(video_path)[<span class="number">1</span>]</span><br><span class="line">    logger.info(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Starting processing for: <span class="subst">&#123;base_name&#125;</span><span class="subst">&#123;file_ext&#125;</span>&quot;</span>)</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    split_success_count = <span class="number">0</span></span><br><span class="line">    split_fail_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        num_scenes, _, scene_list = detect_scenes(video_path, threshold) <span class="comment"># Get scene_list now</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> num_scenes <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            logger.warning(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Video <span class="subst">&#123;base_name&#125;</span><span class="subst">&#123;file_ext&#125;</span> failed scene detection. Skipping.&quot;</span>)</span><br><span class="line">            <span class="comment"># Optionally move failed files to a specific error directory</span></span><br><span class="line">            <span class="keyword">return</span> <span class="comment"># Stop processing this file</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> num_scenes &lt;= <span class="number">1</span>:</span><br><span class="line">            logger.info(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Video <span class="subst">&#123;base_name&#125;</span><span class="subst">&#123;file_ext&#125;</span> has <span class="subst">&#123;num_scenes&#125;</span> scene(s). No splitting needed.&quot;</span>)</span><br><span class="line">            <span class="comment"># Decide if you want to move single-scene videos somewhere else or leave them</span></span><br><span class="line">            <span class="comment"># Example: move_video(video_path, os.path.join(base_dest_dir, &quot;single_scene&quot;))</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logger.info(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Video <span class="subst">&#123;base_name&#125;</span><span class="subst">&#123;file_ext&#125;</span> has <span class="subst">&#123;num_scenes&#125;</span> scenes. Starting split...&quot;</span>)</span><br><span class="line">            <span class="comment"># Create a subdirectory for this video&#x27;s scenes</span></span><br><span class="line">            video_scene_dir = os.path.join(base_dest_dir, base_name)</span><br><span class="line">            os.makedirs(video_scene_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> i, (start_tc, end_tc) <span class="keyword">in</span> <span class="built_in">enumerate</span>(scene_list):</span><br><span class="line">                scene_num = i + <span class="number">1</span></span><br><span class="line">                output_filename = <span class="string">f&quot;<span class="subst">&#123;base_name&#125;</span>_scene_<span class="subst">&#123;scene_num:03d&#125;</span><span class="subst">&#123;file_ext&#125;</span>&quot;</span></span><br><span class="line">                output_filepath = os.path.join(video_scene_dir, output_filename)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Use get_timecode() for FFmpeg compatible strings</span></span><br><span class="line">                start_str = start_tc.get_timecode()</span><br><span class="line">                end_str = end_tc.get_timecode()</span><br><span class="line"></span><br><span class="line">                success = split_video_scene(video_path, output_filepath, start_str, end_str)</span><br><span class="line">                <span class="keyword">if</span> success:</span><br><span class="line">                    split_success_count += <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    split_fail_count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># After attempting all splits, move the original file</span></span><br><span class="line">            <span class="keyword">if</span> split_fail_count == <span class="number">0</span> <span class="keyword">and</span> split_success_count &gt; <span class="number">0</span>: <span class="comment"># Only move original if all splits succeeded</span></span><br><span class="line">                logger.info(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] All <span class="subst">&#123;split_success_count&#125;</span> scenes split successfully for <span class="subst">&#123;base_name&#125;</span><span class="subst">&#123;file_ext&#125;</span>. Moving original.&quot;</span>)</span><br><span class="line">                move_video(video_path, originals_dir)</span><br><span class="line">            <span class="keyword">elif</span> split_success_count &gt; <span class="number">0</span>: <span class="comment"># Some splits succeeded, some failed</span></span><br><span class="line">                logger.warning(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Completed splitting for <span class="subst">&#123;base_name&#125;</span><span class="subst">&#123;file_ext&#125;</span> with <span class="subst">&#123;split_fail_count&#125;</span> failures out of <span class="subst">&#123;num_scenes&#125;</span>. Original NOT moved.&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>: <span class="comment"># All splits failed</span></span><br><span class="line">                logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] All <span class="subst">&#123;num_scenes&#125;</span> split attempts failed for <span class="subst">&#123;base_name&#125;</span><span class="subst">&#123;file_ext&#125;</span>. Original NOT moved.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Top-level error processing <span class="subst">&#123;base_name&#125;</span><span class="subst">&#123;file_ext&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        end_time = time.time()</span><br><span class="line">        result_summary = <span class="string">f&quot;<span class="subst">&#123;num_scenes&#125;</span> scenes detected&quot;</span> <span class="keyword">if</span> num_scenes <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">else</span> <span class="string">&quot;failed detection&quot;</span></span><br><span class="line">        <span class="keyword">if</span> num_scenes <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> num_scenes &gt; <span class="number">1</span>:</span><br><span class="line">             result_summary += <span class="string">f&quot; (<span class="subst">&#123;split_success_count&#125;</span> split OK, <span class="subst">&#123;split_fail_count&#125;</span> split failed)&quot;</span></span><br><span class="line">        logger.info(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Finished processing <span class="subst">&#123;base_name&#125;</span><span class="subst">&#123;file_ext&#125;</span> (<span class="subst">&#123;result_summary&#125;</span>) in <span class="subst">&#123;end_time - start_time:<span class="number">.2</span>f&#125;</span> seconds.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">root_dir, dest_dir, num_threads=<span class="number">4</span>, threshold=<span class="number">30.0</span>, downscale_width=<span class="number">640</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Main function to process multiple videos in parallel.&quot;&quot;&quot;</span></span><br><span class="line">    root_dir = os.path.normpath(root_dir)</span><br><span class="line">    dest_dir = os.path.normpath(dest_dir)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Define directory for processed original files</span></span><br><span class="line">    originals_processed_dir = os.path.join(dest_dir, <span class="string">&quot;originals_processed&quot;</span>)</span><br><span class="line">    os.makedirs(originals_processed_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Filter out files already in the destination or originals directory</span></span><br><span class="line">    video_files_all = find_video_files(root_dir)</span><br><span class="line">    abs_dest_dir = os.path.abspath(dest_dir) <span class="comment"># Includes originals_processed_dir</span></span><br><span class="line">    video_files = [f <span class="keyword">for</span> f <span class="keyword">in</span> video_files_all <span class="keyword">if</span> <span class="keyword">not</span> os.path.abspath(f).startswith(abs_dest_dir)]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(video_files) &lt; <span class="built_in">len</span>(video_files_all):</span><br><span class="line">         logger.warning(<span class="string">f&quot;Filtered out <span class="subst">&#123;<span class="built_in">len</span>(video_files_all) - <span class="built_in">len</span>(video_files)&#125;</span> files potentially inside destination subdirectories.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> video_files:</span><br><span class="line">        logger.error(<span class="string">f&quot;No valid video files found in <span class="subst">&#123;root_dir&#125;</span> (excluding destination).&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    logging.info(<span class="string">f&quot;Starting scene splitting on <span class="subst">&#123;<span class="built_in">len</span>(video_files)&#125;</span> videos from <span class="subst">&#123;root_dir&#125;</span> using <span class="subst">&#123;num_threads&#125;</span> threads.&quot;</span>)</span><br><span class="line">    logging.info(<span class="string">f&quot;Output segments will be in subfolders under: <span class="subst">&#123;dest_dir&#125;</span>&quot;</span>)</span><br><span class="line">    logging.info(<span class="string">f&quot;Originals (if successfully split) will be moved to: <span class="subst">&#123;originals_processed_dir&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    start_overall_time = time.time()</span><br><span class="line">    processed_count = <span class="number">0</span></span><br><span class="line">    successful_runs = <span class="number">0</span></span><br><span class="line">    failed_runs = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(max_workers=num_threads, thread_name_prefix=<span class="string">&#x27;SceneSplitWorker&#x27;</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        futures = &#123;executor.submit(process_video, video_file, threshold, dest_dir, originals_processed_dir, downscale_width): video_file <span class="keyword">for</span> video_file <span class="keyword">in</span> video_files&#125;</span><br><span class="line"></span><br><span class="line">        logging.info(<span class="string">&quot;All tasks submitted. Waiting for completion...&quot;</span>)</span><br><span class="line">        <span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> as_completed</span><br><span class="line">        <span class="keyword">for</span> future <span class="keyword">in</span> tqdm(as_completed(futures), total=<span class="built_in">len</span>(futures), desc=<span class="string">&quot;Overall Progress&quot;</span>):</span><br><span class="line">            video_file = futures[future]</span><br><span class="line">            processed_count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                future.result() <span class="comment"># Check for exceptions from the thread</span></span><br><span class="line">                successful_runs += <span class="number">1</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">                <span class="comment"># Exception already logged in thread or called functions</span></span><br><span class="line">                failed_runs += <span class="number">1</span></span><br><span class="line">                logging.debug(<span class="string">f&quot;Worker thread for <span class="subst">&#123;os.path.basename(video_file)&#125;</span> failed top-level (already logged).&quot;</span>)</span><br><span class="line"></span><br><span class="line">    end_overall_time = time.time()</span><br><span class="line">    logging.info(<span class="string">f&quot;Scene splitting complete.&quot;</span>)</span><br><span class="line">    logging.info(<span class="string">f&quot;Summary: <span class="subst">&#123;<span class="built_in">len</span>(video_files)&#125;</span> videos submitted. <span class="subst">&#123;successful_runs&#125;</span> processed without top-level errors, <span class="subst">&#123;failed_runs&#125;</span> encountered errors.&quot;</span>)</span><br><span class="line">    logging.info(<span class="string">f&quot;Total execution time: <span class="subst">&#123;end_overall_time - start_overall_time:<span class="number">.2</span>f&#125;</span> seconds.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># --- CHECK FFMPEG FIRST ---</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> check_ffmpeg():</span><br><span class="line">        sys.exit(<span class="number">1</span>) <span class="comment"># Exit if FFmpeg is not found</span></span><br><span class="line"></span><br><span class="line">    root_dir = <span class="string">r&quot;/Volumes/shared/æ ‡æ³¨/å½±è§†&quot;</span></span><br><span class="line">    dest_dir = <span class="string">r&quot;/Volumes/shared/0328-1-detect-scene-ret&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Standard directory checks</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(root_dir) <span class="keyword">or</span> <span class="keyword">not</span> os.path.isdir(root_dir):</span><br><span class="line">        logging.critical(<span class="string">f&quot;Root directory &#x27;<span class="subst">&#123;root_dir&#125;</span>&#x27; not found or is not a directory.&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        os.makedirs(dest_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">        logging.info(<span class="string">f&quot;Ensured base destination directory exists: <span class="subst">&#123;dest_dir&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> OSError <span class="keyword">as</span> e:</span><br><span class="line">        logging.critical(<span class="string">f&quot;Failed to create base destination directory &#x27;<span class="subst">&#123;dest_dir&#125;</span>&#x27;: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">         logging.critical(<span class="string">f&quot;Unexpected error creating destination directory &#x27;<span class="subst">&#123;dest_dir&#125;</span>&#x27;: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">         sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    check_acceleration_support()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Run main process</span></span><br><span class="line">    <span class="comment"># Adjust num_threads, threshold, downscale_width as needed</span></span><br><span class="line">    main(root_dir, dest_dir, num_threads=<span class="number">4</span>, threshold=<span class="number">27.0</span>, downscale_width=<span class="number">640</span>)</span><br></pre></td></tr></table></figure><h2 id="æµ‹è¯•ç»“æœå±•ç¤º">æµ‹è¯•ç»“æœå±•ç¤º</h2><blockquote><p>å€¼ä¸­çš„å³°å€¼å¯¹åº”äºè¾“å…¥è§†é¢‘ä¸­çš„åœºæ™¯ä¸­æ–­ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½éœ€è¦ç›¸åº”åœ°æé«˜æˆ–é™ä½é˜ˆå€¼ã€‚</p></blockquote><p><img src="/2025/04/03/video-secene-detect/example.png" class="lazyload placeholder" data-srcset="/2025/04/03/video-secene-detect/example.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="see">see</h2><ul><li>1.<a href="https://www.scenedetect.com/cli/#quickstart">https://www.scenedetect.com/cli/#quickstart</a></li><li>2.<a href="https://github.com/Breakthrough/PySceneDetect">https://github.com/Breakthrough/PySceneDetect</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åœ¨ubuntuä½¿ç”¨Postfixæ­å»ºé‚®ä»¶æœåŠ¡å™¨</title>
      <link href="/2025/03/26/mail-server-Postfix/"/>
      <url>/2025/03/26/mail-server-Postfix/</url>
      
        <content type="html"><![CDATA[<h1>åœ¨ubuntuä½¿ç”¨Postfixæ­å»ºé‚®ä»¶æœåŠ¡å™¨</h1><blockquote><p>åœ¨ Ubuntu æœåŠ¡å™¨ä¸Šæ­å»ºé‚®ä»¶æœåŠ¡å™¨çš„æ•™ç¨‹ã€‚ Postfix ä½œä¸ºé‚®ä»¶ä¼ è¾“ä»£ç† (MTA)ï¼ŒDovecot ä½œä¸ºé‚®ä»¶æŠ•é€’ä»£ç† (MDA)</p></blockquote><p><strong>ç›®æ ‡ï¼š</strong></p><ul><li>åœ¨ Ubuntu æœåŠ¡å™¨ä¸Šæ­å»ºä¸€ä¸ªåŠŸèƒ½å®Œå–„çš„é‚®ä»¶æœåŠ¡å™¨ã€‚</li><li>æ”¯æŒå‘é€å’Œæ¥æ”¶é‚®ä»¶ã€‚</li><li>å®ç°åŸºæœ¬çš„å®‰å…¨æªæ–½ï¼Œé˜²æ­¢åƒåœ¾é‚®ä»¶å’Œæœªç»æˆæƒçš„è®¿é—®ã€‚</li></ul><p><strong>å‡†å¤‡å·¥ä½œï¼š</strong></p><ol><li><strong>ä¸€å°è¿è¡Œ Ubuntu Server çš„æœåŠ¡å™¨ã€‚</strong> æ¨èä½¿ç”¨ Ubuntu 20.04 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚</li><li><strong>å…·æœ‰ <code>sudo</code> æƒé™çš„é root ç”¨æˆ·ã€‚</strong></li><li><strong>ä¸€ä¸ªåŸŸåã€‚</strong> ä½ éœ€è¦ä¸€ä¸ªæ³¨å†Œçš„åŸŸåï¼Œä»¥ä¾¿è®¾ç½®é‚®ä»¶æœåŠ¡å™¨çš„ DNS è®°å½•ã€‚</li><li><strong>ä¸€ä¸ªé™æ€ IP åœ°å€ã€‚</strong> ä½ çš„æœåŠ¡å™¨éœ€è¦ä¸€ä¸ªé™æ€ IP åœ°å€ï¼Œä»¥ä¾¿ DNS è®°å½•å¯ä»¥æ­£ç¡®è§£æåˆ°ä½ çš„æœåŠ¡å™¨ã€‚</li><li><strong>ç¡®ä¿æœåŠ¡å™¨ä¸»æœºåè®¾ç½®æ­£ç¡®ã€‚</strong> ä½¿ç”¨ <code>hostnamectl</code> å‘½ä»¤è®¾ç½®ä¸»æœºåã€‚ä¸»æœºååº”è¯¥ä¸ä½ çš„åŸŸåæˆ–å­åŸŸåç›¸å…³ã€‚ä¾‹å¦‚ï¼Œ<code>mail.example.com</code>ã€‚</li></ol><p><strong>æ­¥éª¤ 1ï¼šå®‰è£… Postfix</strong></p><p>Postfix æ˜¯ä¸€ä¸ªæµè¡Œçš„ã€å®‰å…¨çš„ã€æ˜“äºé…ç½®çš„é‚®ä»¶ä¼ è¾“ä»£ç† (MTA)ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install postfix</span><br></pre></td></tr></table></figure><p>åœ¨å®‰è£…è¿‡ç¨‹ä¸­ï¼Œä¼šå¼¹å‡ºä¸€ä¸ªé…ç½®çª—å£ã€‚é€‰æ‹© â€œInternet Siteâ€ å¹¶è¾“å…¥ä½ çš„åŸŸåï¼ˆä¾‹å¦‚ï¼Œ<code>example.com</code>ï¼‰ã€‚</p><p><strong>æ­¥éª¤ 2ï¼šé…ç½® Postfix</strong></p><p>ç¼–è¾‘ Postfix çš„ä¸»é…ç½®æ–‡ä»¶ <code>main.cf</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> nano /etc/postfix/main.cf</span><br></pre></td></tr></table></figure><p>è¿›è¡Œä»¥ä¸‹ä¿®æ”¹ï¼š</p><ul><li><p><strong><code>myhostname</code>ï¼š</strong> è®¾ç½®æœåŠ¡å™¨çš„ä¸»æœºåã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myhostname = mail.example.com</span><br></pre></td></tr></table></figure></li><li><p><strong><code>myorigin</code>ï¼š</strong> è®¾ç½®å‘é€é‚®ä»¶æ—¶ä½¿ç”¨çš„åŸŸåã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myorigin = example.com</span><br></pre></td></tr></table></figure></li><li><p><strong><code>mydestination</code>ï¼š</strong> è®¾ç½®æœåŠ¡å™¨æ¥æ”¶é‚®ä»¶çš„åŸŸåã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mydestination = mail.example.com, example.com, localhost.localdomain, localhost</span><br></pre></td></tr></table></figure></li><li><p><strong><code>mynetworks</code>ï¼š</strong> è®¾ç½®å…è®¸é€šè¿‡æ­¤æœåŠ¡å™¨å‘é€é‚®ä»¶çš„ç½‘ç»œã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128</span><br></pre></td></tr></table></figure></li><li><p><strong><code>relayhost</code>ï¼š</strong> å¦‚æœä½ éœ€è¦é€šè¿‡å¦ä¸€ä¸ªé‚®ä»¶æœåŠ¡å™¨å‘é€é‚®ä»¶ï¼Œè¯·è®¾ç½®æ­¤é€‰é¡¹ã€‚ å¦åˆ™ï¼Œæ³¨é‡Šæ‰æˆ–ç•™ç©ºã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#relayhost =</span><br></pre></td></tr></table></figure></li><li><p><strong><code>inet_interfaces</code>ï¼š</strong> è®¾ç½® Postfix ç›‘å¬çš„ç½‘ç»œæ¥å£ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inet_interfaces = all</span><br></pre></td></tr></table></figure></li><li><p><strong><code>inet_protocols</code>ï¼š</strong> è®¾ç½® Postfix ä½¿ç”¨çš„ç½‘ç»œåè®®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inet_protocols = all</span><br></pre></td></tr></table></figure></li></ul><p>ä¿å­˜å¹¶å…³é—­æ–‡ä»¶ã€‚</p><p><strong>æ­¥éª¤ 3ï¼šå®‰è£… Dovecot</strong></p><p>Dovecot æ˜¯ä¸€ä¸ªæµè¡Œçš„ã€å®‰å…¨çš„é‚®ä»¶æŠ•é€’ä»£ç† (MDA)ã€‚ å®ƒè´Ÿè´£å°†é‚®ä»¶æŠ•é€’åˆ°ç”¨æˆ·çš„é‚®ç®±ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install dovecot-core dovecot-imapd dovecot-pop3d</span><br></pre></td></tr></table></figure><p><strong>æ­¥éª¤ 4ï¼šé…ç½® Dovecot</strong></p><p>é…ç½® Dovecot ä»¥ä½¿ç”¨ Postfix è¿›è¡Œé‚®ä»¶æŠ•é€’ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> nano /etc/dovecot/dovecot.conf</span><br></pre></td></tr></table></figure><p>å–æ¶ˆæ³¨é‡Šä»¥ä¸‹è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">!include conf.d/10-mail.conf</span><br><span class="line">!include conf.d/10-auth.conf</span><br><span class="line">!include conf.d/10-master.conf</span><br></pre></td></tr></table></figure><p>ä¿å­˜å¹¶å…³é—­æ–‡ä»¶ã€‚</p><p>ç¼–è¾‘ <code>10-mail.conf</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> nano /etc/dovecot/conf.d/10-mail.conf</span><br></pre></td></tr></table></figure><p>è®¾ç½® <code>mail_location</code> é€‰é¡¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mail_location = mbox:~/mail:INBOX=/var/mail/%u</span><br></pre></td></tr></table></figure><p>ä¿å­˜å¹¶å…³é—­æ–‡ä»¶ã€‚</p><p>ç¼–è¾‘ <code>10-auth.conf</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> nano /etc/dovecot/conf.d/10-auth.conf</span><br></pre></td></tr></table></figure><p>å–æ¶ˆæ³¨é‡Š <code>disable_plaintext_auth</code> é€‰é¡¹å¹¶å°†å…¶è®¾ç½®ä¸º <code>no</code>ã€‚<strong>ï¼ˆæ³¨æ„ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¼ºçƒˆå»ºè®®å¯ç”¨ TLS/SSL åŠ å¯†ï¼Œå¹¶ä¿æŒ <code>disable_plaintext_auth = yes</code> ä»¥æé«˜å®‰å…¨æ€§ã€‚ï¼‰</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">disable_plaintext_auth = no</span><br></pre></td></tr></table></figure><p>æ‰¾åˆ° <code>auth_mechanisms</code> è¡Œï¼Œå¹¶ç¡®ä¿å®ƒåŒ…å« <code>plain</code> å’Œ <code>login</code>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auth_mechanisms = plain login</span><br></pre></td></tr></table></figure><p>ä¿å­˜å¹¶å…³é—­æ–‡ä»¶ã€‚</p><p>ç¼–è¾‘ <code>10-master.conf</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> nano /etc/dovecot/conf.d/10-master.conf</span><br></pre></td></tr></table></figure><p>æ‰¾åˆ° <code>service auth</code> éƒ¨åˆ†ï¼Œå¹¶ç¡®ä¿ <code>unix_listener /var/spool/postfix/private/auth</code> è¡Œå­˜åœ¨ä¸”æœªæ³¨é‡Šï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">service auth &#123;</span><br><span class="line">  unix_listener /var/spool/postfix/private/auth &#123;</span><br><span class="line">    mode = 0660</span><br><span class="line">    user = postfix</span><br><span class="line">    group = postfix</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰¾åˆ° <code>service imap-login</code> å’Œ <code>service pop3-login</code> éƒ¨åˆ†ï¼Œç¡®ä¿ <code>inet_listener</code> é€‰é¡¹å­˜åœ¨ä¸”æœªæ³¨é‡Šã€‚</p><p>ä¿å­˜å¹¶å…³é—­æ–‡ä»¶ã€‚</p><p><strong>æ­¥éª¤ 5ï¼šé…ç½® Postfix ä»¥ä½¿ç”¨ Dovecot è¿›è¡Œèº«ä»½éªŒè¯</strong></p><p>ç¼–è¾‘ Postfix çš„ <code>main.cf</code> æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> nano /etc/postfix/main.cf</span><br></pre></td></tr></table></figure><p>æ·»åŠ ä»¥ä¸‹è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">smtpd_sasl_type = dovecot</span><br><span class="line">smtpd_sasl_path = private/auth</span><br><span class="line">smtpd_sasl_auth_enable = yes</span><br><span class="line">smtpd_relay_restrictions = permit_mynetworks,permit_sasl_authenticated,defer_unauth_destination</span><br><span class="line">broken_sasl_auth_clients = yes</span><br></pre></td></tr></table></figure><p>ä¿å­˜å¹¶å…³é—­æ–‡ä»¶ã€‚</p><p><strong>æ­¥éª¤ 6ï¼šè®¾ç½® DNS è®°å½•</strong></p><p>ä½ éœ€è¦è®¾ç½®ä»¥ä¸‹ DNS è®°å½•ï¼Œä»¥ä¾¿é‚®ä»¶æœåŠ¡å™¨å¯ä»¥æ­£å¸¸å·¥ä½œï¼š</p><ul><li><p><strong>A è®°å½•ï¼š</strong> å°†ä½ çš„åŸŸåæˆ–å­åŸŸåï¼ˆä¾‹å¦‚ï¼Œ<code>mail.example.com</code>ï¼‰æŒ‡å‘ä½ çš„æœåŠ¡å™¨çš„é™æ€ IP åœ°å€ã€‚</p></li><li><p><strong>MX è®°å½•ï¼š</strong> æŒ‡ç¤ºé‚®ä»¶æœåŠ¡å™¨çš„åŸŸåã€‚ å°† MX è®°å½•æŒ‡å‘ä½ çš„åŸŸåæˆ–å­åŸŸåï¼ˆä¾‹å¦‚ï¼Œ<code>mail.example.com</code>ï¼‰ã€‚</p></li><li><p><strong>TXT è®°å½• (SPF)ï¼š</strong> SPF è®°å½•ç”¨äºé˜²æ­¢åƒåœ¾é‚®ä»¶ã€‚ æ·»åŠ ä¸€ä¸ª TXT è®°å½•ï¼ŒæŒ‡å®šå…è®¸ä»ä½ çš„åŸŸåå‘é€é‚®ä»¶çš„æœåŠ¡å™¨ã€‚ ä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v=spf1 mx a ip4:ä½ çš„æœåŠ¡å™¨IPåœ°å€ -all</span><br></pre></td></tr></table></figure></li><li><p><strong>TXT è®°å½• (DMARC)ï¼š</strong> DMARC è®°å½•ç”¨äºè¿›ä¸€æ­¥æé«˜é‚®ä»¶å®‰å…¨æ€§ã€‚ æ·»åŠ ä¸€ä¸ª DMARC è®°å½•ï¼ŒæŒ‡ç¤ºå¦‚ä½•å¤„ç†æœªé€šè¿‡ SPF å’Œ DKIM æ£€æŸ¥çš„é‚®ä»¶ã€‚ ä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v=DMARC1; p=none; rua=mailto:postmaster@example.com;</span><br></pre></td></tr></table></figure><p><em>æ³¨æ„ï¼š<code>rua=mailto:postmaster@example.com;</code> è¿™éƒ¨åˆ†æ˜¯å¯é€‰çš„ï¼Œç”¨äºæŒ‡å®šæ¥æ”¶ DMARC æŠ¥å‘Šçš„é‚®ç®±ã€‚</em></p><p>å…·ä½“çš„ DNS è®°å½•è®¾ç½®æ–¹æ³•å–å†³äºä½ çš„åŸŸåæ³¨å†Œå•†ã€‚</p></li></ul><p><strong>æ­¥éª¤ 7ï¼šé‡æ–°å¯åŠ¨æœåŠ¡</strong></p><p>é‡æ–°å¯åŠ¨ Postfix å’Œ Dovecot æœåŠ¡ä»¥åº”ç”¨æ›´æ”¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl restart postfix</span><br><span class="line"><span class="built_in">sudo</span> systemctl restart dovecot</span><br></pre></td></tr></table></figure><p><strong>æ­¥éª¤ 8ï¼šæµ‹è¯•é‚®ä»¶æœåŠ¡å™¨</strong></p><ol><li><strong>åˆ›å»ºç”¨æˆ·:</strong> åˆ›å»ºä¸€ä¸ªç³»ç»Ÿç”¨æˆ·ç”¨äºé‚®ä»¶æµ‹è¯•</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> adduser testuser</span><br></pre></td></tr></table></figure><ol start="2"><li><strong>å‘é€é‚®ä»¶:</strong> ä½¿ç”¨ <code>mail</code> å‘½ä»¤å‘é€é‚®ä»¶ã€‚</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;This is a test email.&quot;</span> | mail -s <span class="string">&quot;Test Email&quot;</span> testuser@example.com</span><br></pre></td></tr></table></figure><ol start="3"><li><strong>æ¥æ”¶é‚®ä»¶:</strong> ä½¿ç”¨ <code>dovecot</code> æä¾›çš„å·¥å…·æˆ–è€… <code>mutt</code> å‘½ä»¤æ¥æ¥æ”¶é‚®ä»¶ã€‚ é¦–å…ˆå®‰è£… <code>mutt</code>:</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install mutt</span><br></pre></td></tr></table></figure><p>ç„¶åè¿è¡Œ <code>mutt</code>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mutt -f /var/mail/testuser</span><br></pre></td></tr></table></figure><p>ä½ åº”è¯¥èƒ½çœ‹åˆ°ä½ å‘é€çš„æµ‹è¯•é‚®ä»¶ã€‚</p><p><strong>æ­¥éª¤ 9ï¼šå®‰å…¨åŠ å›º (é‡è¦!)</strong></p><ul><li><p><strong>å¯ç”¨ TLS/SSL åŠ å¯†ï¼š</strong> ä½¿ç”¨ Letâ€™s Encrypt è·å–å…è´¹çš„ TLS/SSL è¯ä¹¦ï¼Œå¹¶é…ç½® Postfix å’Œ Dovecot ä»¥ä½¿ç”¨åŠ å¯†è¿æ¥ã€‚ è¿™å¯ä»¥ä¿æŠ¤ä½ çš„é‚®ä»¶åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¸è¢«çªƒå¬ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install certbot python3-certbot-nginx</span><br><span class="line"><span class="built_in">sudo</span> certbot --nginx -d mail.example.com</span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œç¼–è¾‘ <code>main.cf</code> å’Œ <code>10-ssl.conf</code> æ–‡ä»¶ä»¥é…ç½® TLS/SSL åŠ å¯†ã€‚</p></li><li><p><strong>é…ç½®é˜²ç«å¢™ï¼š</strong> ä½¿ç”¨ <code>ufw</code> é˜²ç«å¢™ï¼Œåªå…è®¸å¿…è¦çš„ç«¯å£ï¼ˆä¾‹å¦‚ï¼Œ25, 143, 993, 587ï¼‰é€šè¿‡ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> ufw allow 25</span><br><span class="line"><span class="built_in">sudo</span> ufw allow 143</span><br><span class="line"><span class="built_in">sudo</span> ufw allow 993</span><br><span class="line"><span class="built_in">sudo</span> ufw allow 587</span><br><span class="line"><span class="built_in">sudo</span> ufw <span class="built_in">enable</span></span><br></pre></td></tr></table></figure></li><li><p><strong>å®‰è£…å’Œé…ç½® Fail2banï¼š</strong> Fail2ban å¯ä»¥è‡ªåŠ¨é˜»æ­¢å°è¯•æš´åŠ›ç ´è§£ä½ çš„æœåŠ¡å™¨çš„ IP åœ°å€ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install fail2ban</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> /etc/fail2ban/jail.conf /etc/fail2ban/jail.local</span><br><span class="line"><span class="built_in">sudo</span> nano /etc/fail2ban/jail.local</span><br></pre></td></tr></table></figure><p>ç¼–è¾‘ <code>jail.local</code> æ–‡ä»¶ï¼Œå¯ç”¨å¯¹ Postfix å’Œ Dovecot çš„ä¿æŠ¤ã€‚</p></li><li><p><strong>å®šæœŸæ›´æ–°ç³»ç»Ÿï¼š</strong> ä¿æŒä½ çš„ Ubuntu æœåŠ¡å™¨æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œä»¥ä¿®è¡¥å®‰å…¨æ¼æ´ã€‚</p></li></ul><p><strong>æ­¥éª¤ 10ï¼šé˜²æ­¢åƒåœ¾é‚®ä»¶</strong></p><ul><li><strong>è®¾ç½®åå‘ DNS (PTR) è®°å½•ï¼š</strong> ç¡®ä¿ä½ çš„æœåŠ¡å™¨ IP åœ°å€å…·æœ‰æ­£ç¡®çš„åå‘ DNS è®°å½•ã€‚ è¿™å¯ä»¥å¸®åŠ©éªŒè¯ä½ çš„æœåŠ¡å™¨æ˜¯å¦æ˜¯ä¸€ä¸ªåˆæ³•çš„é‚®ä»¶æœåŠ¡å™¨ã€‚ è”ç³»ä½ çš„æœåŠ¡å™¨æä¾›å•†è®¾ç½® PTR è®°å½•ã€‚</li><li><strong>ä½¿ç”¨ DKIMï¼š</strong> DKIMï¼ˆDomainKeys Identified Mailï¼‰æ˜¯ä¸€ç§ç”µå­é‚®ä»¶èº«ä»½éªŒè¯æ–¹æ³•ï¼Œå…è®¸ä½ çš„é‚®ä»¶æœåŠ¡å™¨å¯¹å‘å‡ºçš„é‚®ä»¶è¿›è¡Œæ•°å­—ç­¾åã€‚</li><li><strong>ä½¿ç”¨ DMARCï¼š</strong> DMARCï¼ˆDomain-based Message Authentication, Reporting &amp; Conformanceï¼‰æ˜¯ä¸€ç§ç”µå­é‚®ä»¶èº«ä»½éªŒè¯ç­–ç•¥ï¼Œå…è®¸ä½ æŒ‡å®šå¦‚ä½•å¤„ç†æœªé€šè¿‡ SPF å’Œ DKIM æ£€æŸ¥çš„é‚®ä»¶ã€‚</li></ul><p><strong>æ³¨æ„äº‹é¡¹ï¼š</strong></p><ul><li><strong>å®‰å…¨æ€§ï¼š</strong> è®¾ç½®é‚®ä»¶æœåŠ¡å™¨éœ€è¦éå¸¸é‡è§†å®‰å…¨æ€§ã€‚ è¯·åŠ¡å¿…é‡‡å–æ‰€æœ‰å¿…è¦çš„å®‰å…¨æªæ–½ï¼Œä»¥é˜²æ­¢åƒåœ¾é‚®ä»¶ã€ç½‘ç»œé’“é±¼å’Œå…¶ä»–æ¶æ„æ´»åŠ¨ã€‚</li><li><strong>å¯é€è¾¾æ€§ï¼š</strong> ç¡®ä¿ä½ çš„é‚®ä»¶æœåŠ¡å™¨ç¬¦åˆç”µå­é‚®ä»¶å‘é€çš„æœ€ä½³å®è·µï¼Œä»¥æé«˜é‚®ä»¶çš„å¯é€è¾¾æ€§ã€‚ è¿™åŒ…æ‹¬è®¾ç½®æ­£ç¡®çš„ DNS è®°å½•ã€ä½¿ç”¨ DKIM å’Œ DMARCï¼Œä»¥åŠé¿å…å‘é€åƒåœ¾é‚®ä»¶ã€‚</li><li><strong>ç›‘æ§ï¼š</strong> æŒç»­ç›‘æ§ä½ çš„é‚®ä»¶æœåŠ¡å™¨çš„æ€§èƒ½å’Œå®‰å…¨çŠ¶å†µã€‚ æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ï¼Œä»¥ä¾¿åŠæ—¶å‘ç°å’Œè§£å†³ä»»ä½•é—®é¢˜ã€‚</li><li>**IPä¿¡èª‰ï¼š**ä¿æŒIPä¿¡èª‰è‰¯å¥½å¯¹äºé‚®ä»¶çš„æˆåŠŸå‘é€è‡³å…³é‡è¦ï¼ŒåŠ¡å¿…éµå®ˆå‘é€è§„åˆ™å’Œé¿å…å‘é€åƒåœ¾é‚®ä»¶ï¼Œå¦åˆ™ä½ çš„é‚®ä»¶å¯èƒ½è¢«æ ‡è®°ä¸ºåƒåœ¾é‚®ä»¶ã€‚</li></ul><h2 id="å®¢æˆ·ç«¯ä½¿ç”¨">å®¢æˆ·ç«¯ä½¿ç”¨</h2><p>åœ¨æœ¬åœ°æµ‹è¯•é‚®ä»¶æœåŠ¡å™¨çš„å¯ç”¨æ€§ï¼Œæ˜¯æŒ‡åœ¨ä½ çš„é‚®ä»¶æœåŠ¡å™¨æ­å»ºå¥½åï¼Œåœ¨ä¸æ¶‰åŠåˆ°å¤–éƒ¨ç½‘ç»œçš„æƒ…å†µä¸‹ï¼ŒéªŒè¯å®ƒæ˜¯å¦èƒ½å¤Ÿæ­£ç¡®åœ°å‘é€å’Œæ¥æ”¶é‚®ä»¶ã€‚ è¿™é€šå¸¸åœ¨ä½ æœåŠ¡å™¨æ­å»ºçš„åˆæœŸé˜¶æ®µè¿›è¡Œï¼Œç”¨äºæ’æŸ¥åŸºæœ¬é…ç½®é—®é¢˜ã€‚</p><p>ä»¥ä¸‹æ˜¯å‡ ç§åœ¨æœ¬åœ°æµ‹è¯•é‚®ä»¶æœåŠ¡å™¨å¯ç”¨æ€§çš„æ–¹æ³•ï¼š</p><p><strong>æ–¹æ³• 1ï¼šä½¿ç”¨ <code>mail</code> å‘½ä»¤ï¼ˆç®€å•å¿«é€Ÿï¼‰</strong></p><p><code>mail</code> å‘½ä»¤æ˜¯ä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œé‚®ä»¶å®¢æˆ·ç«¯ï¼Œé€‚ç”¨äºå¿«é€Ÿæµ‹è¯•ã€‚</p><ol><li><p><strong>ç¡®ä¿ <code>mail</code> å‘½ä»¤å·²å®‰è£…ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install mailutils</span><br></pre></td></tr></table></figure></li><li><p><strong>å‘é€é‚®ä»¶åˆ°æœ¬åœ°ç”¨æˆ·ï¼š</strong><br>å‡è®¾ä½ çš„ç³»ç»Ÿä¸Šæœ‰ä¸€ä¸ªç”¨æˆ·åä¸º <code>testuser</code>ï¼Œå¹¶ä¸”é‚®ä»¶æœåŠ¡å™¨é…ç½®äº†åŸŸå <code>example.com</code>ï¼Œä½ å¯ä»¥å°è¯•å‘ <code>testuser@example.com</code> å‘é€é‚®ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;This is a test email.&quot;</span> | mail -s <span class="string">&quot;Test Email&quot;</span> testuser@example.com</span><br></pre></td></tr></table></figure></li><li><p><strong>æ£€æŸ¥æœ¬åœ°ç”¨æˆ·çš„é‚®ç®±ï¼š</strong></p><p>æœ¬åœ°ç”¨æˆ·çš„é‚®ç®±é€šå¸¸ä½äº <code>/var/mail/&lt;ç”¨æˆ·å&gt;</code>ã€‚ ä½¿ç”¨ <code>mutt</code> æˆ–è€…ç›´æ¥æŸ¥çœ‹æ–‡ä»¶å†…å®¹ï¼š</p><ul><li><p><strong>ä½¿ç”¨ <code>mutt</code>ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install mutt  <span class="comment"># å¦‚æœæ²¡æœ‰å®‰è£…</span></span><br><span class="line">mutt -f /var/mail/testuser</span><br></pre></td></tr></table></figure></li><li><p><strong>ç›´æ¥æŸ¥çœ‹æ–‡ä»¶ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">cat</span> /var/mail/testuser</span><br></pre></td></tr></table></figure></li></ul><p>å¦‚æœé‚®ä»¶æœåŠ¡å™¨é…ç½®æ­£ç¡®ï¼Œä½ åº”è¯¥èƒ½åœ¨ <code>testuser</code> çš„é‚®ç®±ä¸­çœ‹åˆ°ä½ å‘é€çš„æµ‹è¯•é‚®ä»¶ã€‚</p></li></ol><p><strong>æ–¹æ³• 2ï¼šä½¿ç”¨ <code>swaks</code> å‘½ä»¤ï¼ˆæ›´è¯¦ç»†çš„æµ‹è¯•ï¼‰</strong></p><p><code>swaks</code> (Swiss Army Knife for SMTP) æ˜¯ä¸€ä¸ªæ›´å¼ºå¤§çš„å‘½ä»¤è¡Œ SMTP æµ‹è¯•å·¥å…·ã€‚ å®ƒå¯ä»¥è®©ä½ æ›´è¯¦ç»†åœ°æ§åˆ¶é‚®ä»¶å‘é€è¿‡ç¨‹ï¼Œå¹¶æ£€æŸ¥æœåŠ¡å™¨çš„å“åº”ã€‚</p><ol><li><p><strong>å®‰è£… <code>swaks</code>ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install swaks</span><br></pre></td></tr></table></figure></li><li><p><strong>å‘é€é‚®ä»¶å¹¶æ£€æŸ¥å“åº”ï¼š</strong></p><p>ä½¿ç”¨ <code>swaks</code> å‘½ä»¤å‘é€é‚®ä»¶ï¼Œå¹¶æ£€æŸ¥æœåŠ¡å™¨çš„å“åº”ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swaks --to testuser@example.com --from youruser@example.com --server localhost --header <span class="string">&quot;Subject: Test Email from Swaks&quot;</span> --body <span class="string">&quot;This is a test email from swaks.&quot;</span> --verbose</span><br></pre></td></tr></table></figure><ul><li><code>--to</code>ï¼šæ”¶ä»¶äººåœ°å€ã€‚</li><li><code>--from</code>ï¼šå‘ä»¶äººåœ°å€ï¼ˆå¿…é¡»æ˜¯é‚®ä»¶æœåŠ¡å™¨å…è®¸å‘é€çš„åœ°å€ï¼‰ã€‚</li><li><code>--server</code>ï¼šé‚®ä»¶æœåŠ¡å™¨åœ°å€ (localhost è¡¨ç¤ºæœ¬åœ°æœåŠ¡å™¨)ã€‚</li><li><code>--header</code>ï¼šé‚®ä»¶å¤´éƒ¨ä¿¡æ¯ (ä¾‹å¦‚ï¼Œä¸»é¢˜)ã€‚</li><li><code>--body</code>ï¼šé‚®ä»¶æ­£æ–‡ã€‚</li><li><code>--verbose</code>ï¼šæ˜¾ç¤ºè¯¦ç»†çš„å‘é€è¿‡ç¨‹å’ŒæœåŠ¡å™¨å“åº”ã€‚</li></ul><p>æ£€æŸ¥ <code>swaks</code> çš„è¾“å‡ºï¼Œç¡®ä¿æœåŠ¡å™¨è¿”å›äº† â€œ250 OKâ€ æˆ–ç±»ä¼¼çš„æˆåŠŸä»£ç ã€‚ å¦‚æœå‡ºç°é”™è¯¯ï¼Œå¯ä»¥æ ¹æ®é”™è¯¯ä¿¡æ¯æ’æŸ¥é—®é¢˜ã€‚</p></li></ol><p><strong>æ–¹æ³• 3ï¼šä½¿ç”¨æœ¬åœ°é‚®ä»¶å®¢æˆ·ç«¯ï¼ˆä¾‹å¦‚ Thunderbirdï¼‰</strong></p><p>å¦‚æœä½ çš„ç³»ç»Ÿä¸Šå®‰è£…äº†å›¾å½¢ç•Œé¢çš„é‚®ä»¶å®¢æˆ·ç«¯ (ä¾‹å¦‚ Thunderbird)ï¼Œä½ å¯ä»¥é…ç½®å®ƒæ¥è¿æ¥åˆ°æœ¬åœ°é‚®ä»¶æœåŠ¡å™¨ï¼Œå¹¶å‘é€å’Œæ¥æ”¶é‚®ä»¶ã€‚</p><ol><li><p><strong>é…ç½®é‚®ä»¶å®¢æˆ·ç«¯ï¼š</strong></p><ul><li><strong>è´¦æˆ·ç±»å‹ï¼š</strong> æ‰‹åŠ¨é…ç½®è´¦æˆ·ã€‚</li><li><strong>æ”¶ä»¶æœåŠ¡å™¨ (IMAP/POP3)ï¼š</strong><ul><li>æœåŠ¡å™¨åœ°å€ï¼š<code>localhost</code> æˆ– <code>127.0.0.1</code></li><li>ç«¯å£ï¼š143 (IMAP) æˆ– 110 (POP3) - å¦‚æœå¯ç”¨äº† SSL/TLSï¼Œåˆ™ä½¿ç”¨ 993 (IMAPS) æˆ– 995 (POP3S)</li><li>å®‰å…¨è¿æ¥ï¼šæ ¹æ®ä½ çš„æœåŠ¡å™¨é…ç½®é€‰æ‹© â€œSTARTTLSâ€ æˆ– â€œSSL/TLSâ€ã€‚ å¦‚æœä½ æ²¡æœ‰å¯ç”¨ TLS/SSLï¼Œåˆ™é€‰æ‹© â€œæ— åŠ å¯†â€ã€‚</li><li>èº«ä»½éªŒè¯æ–¹æ³•ï¼šé€‰æ‹© â€œæ™®é€šå¯†ç â€ æˆ– â€œåŠ å¯†å¯†ç â€ã€‚</li></ul></li><li><strong>å‘ä»¶æœåŠ¡å™¨ (SMTP)ï¼š</strong><ul><li>æœåŠ¡å™¨åœ°å€ï¼š<code>localhost</code> æˆ– <code>127.0.0.1</code></li><li>ç«¯å£ï¼š25 æˆ– 587 (å¦‚æœä½¿ç”¨ STARTTLS) - å¦‚æœå¯ç”¨äº† SSL/TLSï¼Œåˆ™ä½¿ç”¨ 465 (SMTPS)</li><li>å®‰å…¨è¿æ¥ï¼šæ ¹æ®ä½ çš„æœåŠ¡å™¨é…ç½®é€‰æ‹© â€œSTARTTLSâ€ æˆ– â€œSSL/TLSâ€ã€‚ å¦‚æœä½ æ²¡æœ‰å¯ç”¨ TLS/SSLï¼Œåˆ™é€‰æ‹© â€œæ— åŠ å¯†â€ã€‚</li><li>èº«ä»½éªŒè¯æ–¹æ³•ï¼šé€‰æ‹© â€œæ™®é€šå¯†ç â€ æˆ– â€œåŠ å¯†å¯†ç â€ã€‚</li><li>ç”¨æˆ·åï¼šå¿…é¡»è®¾ç½®ä¸ºå¯ç”¨çš„ç”¨æˆ·ï¼Œè®¾ç½®éœ€è¦å‘é€è´¦å·å’Œç”¨æˆ·å¯†ç </li></ul></li></ul></li><li><p><strong>å‘é€å’Œæ¥æ”¶é‚®ä»¶ï¼š</strong><br>ä½¿ç”¨é‚®ä»¶å®¢æˆ·ç«¯å‘é€é‚®ä»¶åˆ°æœ¬åœ°ç”¨æˆ·ï¼ˆä¾‹å¦‚ï¼Œ<code>testuser@example.com</code>ï¼‰ï¼Œå¹¶æ£€æŸ¥æ˜¯å¦èƒ½å¤ŸæˆåŠŸæ¥æ”¶ã€‚</p></li></ol><p><strong>æ–¹æ³• 4ï¼šæ£€æŸ¥é‚®ä»¶æ—¥å¿—</strong></p><p>æ— è®ºä½¿ç”¨å“ªç§æ–¹æ³•æµ‹è¯•ï¼Œéƒ½åº”è¯¥æ£€æŸ¥é‚®ä»¶æœåŠ¡å™¨çš„æ—¥å¿—æ–‡ä»¶ï¼Œä»¥äº†è§£é‚®ä»¶çš„å‘é€å’Œæ¥æ”¶æƒ…å†µã€‚</p><ul><li><strong>Postfix æ—¥å¿—ï¼š</strong> <code>/var/log/mail.log</code> æˆ– <code>/var/log/maillog</code></li><li><strong>Dovecot æ—¥å¿—ï¼š</strong> <code>/var/log/dovecot.log</code></li></ul><h2 id="å¯è§†åŒ–æ³¨å†Œä¸ä½¿ç”¨æ–¹æ¡ˆ">å¯è§†åŒ–æ³¨å†Œä¸ä½¿ç”¨æ–¹æ¡ˆ</h2><p>åœ¨ Ubuntu æœåŠ¡å™¨ä¸Šæ­å»ºé‚®ä»¶æœåŠ¡å™¨åï¼Œå¹¶ä¸èƒ½ç›´æ¥â€œå›¾å½¢åŒ–æ³¨å†Œé‚®ç®±â€ã€‚ ä¸Šè¿°æ•™ç¨‹æ­å»ºçš„æ˜¯é‚®ä»¶æœåŠ¡å™¨çš„åº•å±‚åŸºç¡€ï¼Œéœ€è¦æ‰‹åŠ¨åˆ›å»º Linux ç³»ç»Ÿç”¨æˆ·ï¼Œè¿™äº›ç”¨æˆ·æ‰èƒ½é€šè¿‡ IMAP/POP3 ç­‰åè®®è®¿é—®é‚®ä»¶ã€‚ å¦‚æœä½ æƒ³è¦æä¾›ä¸€ç§â€œå›¾å½¢åŒ–æ³¨å†Œé‚®ç®±â€çš„ä½“éªŒï¼Œä½ éœ€è¦é¢å¤–çš„è½¯ä»¶æ¥ç®¡ç†é‚®ç®±è´¦æˆ·ï¼Œå¹¶æä¾›ä¸€ä¸ª Web ç•Œé¢ä¾›ç”¨æˆ·æ³¨å†Œå’Œç®¡ç†ä»–ä»¬çš„é‚®ç®±ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€äº›å¯è¡Œçš„æ–¹æ¡ˆï¼Œå®ƒä»¬éƒ½éœ€è¦å®‰è£…é¢å¤–çš„è½¯ä»¶ï¼Œå¹¶è¿›è¡Œé…ç½®ã€‚</p><p><strong>æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ iRedMail (æ¨è)</strong></p><p>iRedMail æ˜¯ä¸€ä¸ªéå¸¸æµè¡Œçš„ã€å¼€æºçš„é‚®ä»¶æœåŠ¡å™¨è§£å†³æ–¹æ¡ˆï¼Œå®ƒæä¾›äº†ä¸€ä¸ª Web ç•Œé¢ï¼Œç”¨äºç®¡ç†é‚®ç®±ã€ç”¨æˆ·å’ŒåŸŸåã€‚ iRedMail å¯ä»¥è‡ªåŠ¨åŒ–é…ç½® Postfixã€Dovecotã€Roundcube Webmail ç­‰ç»„ä»¶ï¼Œå¹¶æä¾›äº†ä¸€ä¸ªæ˜“äºä½¿ç”¨çš„ç®¡ç†ç•Œé¢ã€‚</p><ol><li><p><strong>ä¸‹è½½ iRedMail å®‰è£…è„šæœ¬ï¼š</strong><br>è®¿é—® <a href="https://www.iredmail.org/">https://www.iredmail.org/</a> ä¸‹è½½æœ€æ–°çš„ iRedMail å®‰è£…è„šæœ¬ã€‚</p></li><li><p><strong>è¿è¡Œå®‰è£…è„šæœ¬ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar xzf iRedMail-x.y.z.tar.gz  <span class="comment"># è§£å‹ä¸‹è½½çš„å‹ç¼©åŒ…</span></span><br><span class="line"><span class="built_in">cd</span> iRedMail-x.y.z</span><br><span class="line"><span class="built_in">sudo</span> bash iRedMail.sh</span><br></pre></td></tr></table></figure><p>æŒ‰ç…§å®‰è£…è„šæœ¬çš„æç¤ºè¿›è¡Œæ“ä½œã€‚ ä½ éœ€è¦è®¾ç½®ç®¡ç†å‘˜å¯†ç ã€é€‰æ‹©æ•°æ®åº“ç±»å‹ã€è®¾ç½®åŸŸåç­‰ã€‚</p></li><li><p><strong>è®¿é—® iRedMail Web ç®¡ç†ç•Œé¢ï¼š</strong><br>å®‰è£…å®Œæˆåï¼Œè®¿é—® iRedMail Web ç®¡ç†ç•Œé¢ã€‚ ç•Œé¢åœ°å€é€šå¸¸æ˜¯ <code>https://ä½ çš„æœåŠ¡å™¨IPåœ°å€/iredadmin/</code> æˆ– <code>https://ä½ çš„åŸŸå/iredadmin/</code>ã€‚</p></li><li><p><strong>ä½¿ç”¨ Web ç•Œé¢åˆ›å»ºé‚®ç®±è´¦æˆ·ï¼š</strong><br>ä½¿ç”¨ç®¡ç†å‘˜è´¦æˆ·ç™»å½• iRedMail Web ç®¡ç†ç•Œé¢ï¼Œç„¶åä½ å¯ä»¥åˆ›å»ºæ–°çš„é‚®ç®±è´¦æˆ·ï¼Œè®¾ç½®å¯†ç ç­‰ã€‚</p></li><li><p><strong>è®©ç”¨æˆ·è®¿é—®Webé‚®ç®±</strong></p><p>iRedMail é›†æˆäº† Roundcube Webmailã€‚ ç”¨æˆ·å¯ä»¥ä½¿ç”¨æµè§ˆå™¨è®¿é—®ä»–ä»¬çš„é‚®ç®±ï¼Œåœ°å€é€šå¸¸æ˜¯<code>https://ä½ çš„æœåŠ¡å™¨IPåœ°å€/mail/</code> æˆ– <code>https://ä½ çš„åŸŸå/mail/</code>ã€‚</p></li></ol><p><strong>æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ Mail-in-a-Box</strong></p><p>Mail-in-a-Box æ˜¯å¦ä¸€ä¸ªæ˜“äºä½¿ç”¨çš„é‚®ä»¶æœåŠ¡å™¨è§£å†³æ–¹æ¡ˆï¼Œæ—¨åœ¨ç®€åŒ–é‚®ä»¶æœåŠ¡å™¨çš„è®¾ç½®å’Œç®¡ç†ã€‚ å®ƒä¹Ÿæä¾›äº†ä¸€ä¸ª Web ç•Œé¢ï¼Œç”¨äºç®¡ç†é‚®ç®±ã€ç”¨æˆ·å’ŒåŸŸåã€‚</p><ol><li><p><strong>ä¸‹è½½ Mail-in-a-Box å®‰è£…è„šæœ¬ï¼š</strong><br>è®¿é—® <a href="https://mailinabox.email/">https://mailinabox.email/</a> è·å–æœ€æ–°çš„å®‰è£…è¯´æ˜ã€‚</p></li><li><p><strong>è¿è¡Œå®‰è£…è„šæœ¬ï¼š</strong><br>æŒ‰ç…§ Mail-in-a-Box çš„å®‰è£…è¯´æ˜è¿›è¡Œæ“ä½œã€‚ å®‰è£…è¿‡ç¨‹ç›¸å¯¹ç®€å•ï¼Œä¼šè‡ªåŠ¨é…ç½®æ‰€éœ€çš„ç»„ä»¶ã€‚</p></li><li><p><strong>è®¿é—® Mail-in-a-Box Web ç®¡ç†ç•Œé¢ï¼š</strong><br>å®‰è£…å®Œæˆåï¼Œè®¿é—® Mail-in-a-Box Web ç®¡ç†ç•Œé¢ã€‚</p></li><li><p><strong>ä½¿ç”¨ Web ç•Œé¢åˆ›å»ºé‚®ç®±è´¦æˆ·ï¼š</strong><br>ä½¿ç”¨ç®¡ç†å‘˜è´¦æˆ·ç™»å½• Mail-in-a-Box Web ç®¡ç†ç•Œé¢ï¼Œç„¶åä½ å¯ä»¥åˆ›å»ºæ–°çš„é‚®ç®±è´¦æˆ·ã€‚</p></li></ol><p><strong>æ–¹æ¡ˆ 3ï¼šæ‰‹åŠ¨é…ç½® Roundcube Webmail æˆ– Rainloop (æ›´å¤æ‚)</strong></p><p>å¦‚æœä½ ä¸æƒ³ä½¿ç”¨å®Œæ•´çš„é‚®ä»¶æœåŠ¡å™¨è§£å†³æ–¹æ¡ˆï¼Œä½ å¯ä»¥æ‰‹åŠ¨å®‰è£…å’Œé…ç½® Roundcube Webmail æˆ– Rainloop Webmailï¼Œå¹¶å°†å…¶ä¸ä½ çš„ Postfix å’Œ Dovecot é‚®ä»¶æœåŠ¡å™¨é›†æˆã€‚</p><ol><li><p><strong>å®‰è£… Web æœåŠ¡å™¨ï¼š</strong><br>é¦–å…ˆï¼Œä½ éœ€è¦å®‰è£…ä¸€ä¸ª Web æœåŠ¡å™¨ï¼ˆä¾‹å¦‚ï¼ŒApache æˆ– Nginxï¼‰ã€‚</p></li><li><p><strong>å®‰è£… PHPï¼š</strong><br>ä½ éœ€è¦å®‰è£… PHP å’Œä¸€äº›å¿…è¦çš„ PHP æ‰©å±•ã€‚</p></li><li><p><strong>ä¸‹è½½å’Œå®‰è£… Roundcube Webmail æˆ– Rainloopï¼š</strong><br>ä»å®˜æ–¹ç½‘ç«™ä¸‹è½½ Roundcube Webmail æˆ– Rainloop çš„æœ€æ–°ç‰ˆæœ¬ï¼Œå¹¶å°†å…¶è§£å‹åˆ°ä½ çš„ Web æœåŠ¡å™¨çš„æ–‡æ¡£æ ¹ç›®å½•ä¸­ã€‚</p></li><li><p><strong>é…ç½® Roundcube Webmail æˆ– Rainloopï¼š</strong><br>æŒ‰ç…§ Roundcube Webmail æˆ– Rainloop çš„å®‰è£…è¯´æ˜è¿›è¡Œé…ç½®ã€‚ ä½ éœ€è¦è®¾ç½®æ•°æ®åº“è¿æ¥ä¿¡æ¯ã€IMAP å’Œ SMTP æœåŠ¡å™¨åœ°å€ã€èº«ä»½éªŒè¯æ–¹æ³•ç­‰ã€‚</p></li><li><p><strong>åˆ›å»º Web ç•Œé¢ç”¨äºæ³¨å†Œç”¨æˆ·ï¼š</strong><br>å¼€å‘è‡ªå·±çš„Webç•Œé¢ï¼Œç”¨äºæ·»åŠ ç”¨æˆ·åˆ°æ•°æ®åº“ä¸­ã€‚</p></li></ol><p><strong>æ–¹æ¡ˆå¯¹æ¯”</strong></p><table><thead><tr><th>ç‰¹æ€§</th><th>iRedMail</th><th>Mail-in-a-Box</th><th>æ‰‹åŠ¨é…ç½® Webmail</th></tr></thead><tbody><tr><td>æ˜“ç”¨æ€§</td><td>ç®€å•</td><td>ç®€å•</td><td>å¤æ‚</td></tr><tr><td>Web ç®¡ç†ç•Œé¢</td><td>æœ‰</td><td>æœ‰</td><td>éœ€è¦æ‰‹åŠ¨æ·»åŠ </td></tr><tr><td>è‡ªåŠ¨é…ç½®</td><td>æ˜¯</td><td>æ˜¯</td><td>å¦</td></tr><tr><td>çµæ´»æ€§</td><td>è¾ƒä½</td><td>è¾ƒä½</td><td>é«˜</td></tr><tr><td>ç¤¾åŒºæ”¯æŒ</td><td>æ´»è·ƒ</td><td>æ´»è·ƒ</td><td>å–å†³äºé€‰æ‹©çš„ Webmail</td></tr><tr><td>é€‚ç”¨åœºæ™¯</td><td>å¿«é€Ÿæ­å»ºé‚®ä»¶æœåŠ¡å™¨</td><td>å¿«é€Ÿæ­å»ºé‚®ä»¶æœåŠ¡å™¨</td><td>è‡ªå®šä¹‰ç¨‹åº¦é«˜çš„åœºæ™¯</td></tr></tbody></table><p><strong>é€‰æ‹©å“ªä¸ªæ–¹æ¡ˆï¼Ÿ</strong></p><ul><li><p><strong>iRedMail æˆ– Mail-in-a-Boxï¼š</strong> å¦‚æœä½ å¸Œæœ›å¿«é€Ÿæ­å»ºä¸€ä¸ªåŠŸèƒ½å®Œå–„çš„é‚®ä»¶æœåŠ¡å™¨ï¼Œå¹¶ä¸”ä¸éœ€è¦å¤ªå¤šçš„è‡ªå®šä¹‰ï¼Œé‚£ä¹ˆ iRedMail æˆ– Mail-in-a-Box æ˜¯ä¸é”™çš„é€‰æ‹©ã€‚</p></li><li><p><strong>æ‰‹åŠ¨é…ç½®Webmail:</strong> å¦‚æœä½ éœ€è¦é«˜åº¦è‡ªå®šä¹‰ï¼Œ é‚£ä¹ˆé€‰æ‹©è¿™ä¸ªæ–¹å¼ã€‚</p></li></ul><p><strong>æ€»ç»“ï¼š</strong></p><p>è¦å®ç°â€œå›¾å½¢åŒ–æ³¨å†Œé‚®ç®±â€çš„åŠŸèƒ½ï¼Œä½ éœ€è¦å®‰è£…é¢å¤–çš„è½¯ä»¶ï¼Œå¹¶æä¾›ä¸€ä¸ª Web ç•Œé¢ä¾›ç”¨æˆ·æ³¨å†Œå’Œç®¡ç†ä»–ä»¬çš„é‚®ç®±ã€‚ iRedMail å’Œ Mail-in-a-Box æ˜¯ä¸¤ç§æµè¡Œçš„é€‰æ‹©ï¼Œå®ƒä»¬æä¾›äº†æ˜“äºä½¿ç”¨çš„ Web ç®¡ç†ç•Œé¢ï¼Œå¯ä»¥ç®€åŒ–é‚®ä»¶æœåŠ¡å™¨çš„ç®¡ç†ã€‚ ä½ ä¹Ÿå¯ä»¥é€‰æ‹©æ‰‹åŠ¨å®‰è£…å’Œé…ç½® Roundcube Webmail æˆ– Rainloop Webmailï¼Œä½†è¿™ç§æ–¹æ³•æ›´å¤æ‚ã€‚ è¯·åŠ¡å¿…ä»”ç»†é˜…è¯»æ‰€é€‰æ–¹æ¡ˆçš„æ–‡æ¡£ï¼Œå¹¶æŒ‰ç…§è¯´æ˜è¿›è¡Œæ“ä½œã€‚</p><h2 id="æ—¥å¿—è¯Šæ–­">æ—¥å¿—è¯Šæ–­</h2><ul><li>nginx</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> less /var/log/nginx/error.log</span><br><span class="line"><span class="built_in">sudo</span> less /var/log/nginx/access.log</span><br></pre></td></tr></table></figure><ul><li>mail</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">tail</span> -n 50 /var/log/mail.err</span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ­å»º Git æˆ– SVN æœåŠ¡å™¨å¹¶é€šè¿‡ Samba å…±äº«</title>
      <link href="/2025/03/18/smb-git-svn/"/>
      <url>/2025/03/18/smb-git-svn/</url>
      
        <content type="html"><![CDATA[<p><strong>ä¸€ã€æ­å»º Git æœåŠ¡å™¨å¹¶é€šè¿‡ Samba å…±äº«</strong></p><p>è¿™ç§æ–¹å¼ä¸‹ï¼ŒGit æœåŠ¡å™¨æœ¬èº«å¤„ç†ç‰ˆæœ¬æ§åˆ¶é€»è¾‘ï¼ŒSamba åªè´Ÿè´£å…±äº« Git ä»“åº“æ‰€åœ¨çš„ç›®å½•ã€‚</p><p><strong>1. å®‰è£… Git å’Œ Samba</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install git samba</span><br></pre></td></tr></table></figure><p><strong>2. åˆ›å»º Git ä»“åº“</strong></p><ul><li><p><strong>åˆ›å»ºä¸€ä¸ªç”¨äºå­˜æ”¾ Git ä»“åº“çš„ç›®å½•ï¼ˆä¾‹å¦‚ <code>/srv/git</code>ï¼‰ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /srv/git</span><br></pre></td></tr></table></figure></li><li><p><strong>è¿›å…¥è¯¥ç›®å½•å¹¶åˆå§‹åŒ–ä¸€ä¸ªè£¸ä»“åº“ï¼ˆbare repositoryï¼‰ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /srv/git</span><br><span class="line"><span class="built_in">sudo</span> git init --bare myproject.git  <span class="comment"># &quot;myproject&quot; æ˜¯ä½ çš„é¡¹ç›®åç§°</span></span><br></pre></td></tr></table></figure><p>è£¸ä»“åº“åªåŒ…å«ç‰ˆæœ¬æ§åˆ¶ä¿¡æ¯ï¼Œæ²¡æœ‰å·¥ä½œç›®å½•ã€‚</p></li><li><p><strong>è®¾ç½®æƒé™</strong></p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> -R www-data:www-data /srv/git/myproject.git <span class="comment">#å‡è®¾ä½ çš„sambaç”¨æˆ·æ˜¯www-data</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> -R 775 /srv/git/myproject.git</span><br></pre></td></tr></table></figure></li></ul><p><strong>3. é…ç½® Samba å…±äº«</strong></p><ul><li><p><strong>ç¼–è¾‘ Samba é…ç½®æ–‡ä»¶ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> vim /etc/samba/smb.conf</span><br></pre></td></tr></table></figure></li><li><p><strong>åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼ˆæ ¹æ®ä½ çš„å®é™…æƒ…å†µä¿®æ”¹ï¼‰ï¼š</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[git-repos]</span></span><br><span class="line">    <span class="attr">comment</span> = Git Repositories</span><br><span class="line">    <span class="attr">path</span> = /srv/git</span><br><span class="line">    <span class="attr">browseable</span> = <span class="literal">yes</span></span><br><span class="line">    read <span class="attr">only</span> = <span class="literal">no</span></span><br><span class="line">    guest <span class="attr">ok</span> = <span class="literal">no</span>  <span class="comment"># å¦‚æœéœ€è¦åŒ¿åè®¿é—®ï¼Œè®¾ç½®ä¸º yes</span></span><br><span class="line">    valid <span class="attr">users</span> = @gitusers  <span class="comment"># å…è®¸è®¿é—®çš„ç”¨æˆ·ç»„ (è§ä¸‹ä¸€æ­¥)</span></span><br><span class="line">    create <span class="attr">mask</span> = <span class="number">0664</span></span><br><span class="line">    directory <span class="attr">mask</span> = <span class="number">0775</span></span><br><span class="line">    force <span class="attr">group</span> = gitusers <span class="comment">#å¼ºåˆ¶ç»„</span></span><br></pre></td></tr></table></figure><ul><li><code>[git-repos]</code>: å…±äº«åç§°ï¼Œå®¢æˆ·ç«¯è®¿é—®æ—¶ä½¿ç”¨ã€‚</li><li><code>path</code>: Git ä»“åº“æ‰€åœ¨çš„ç›®å½•ã€‚</li><li><code>valid users</code>: å…è®¸è®¿é—®çš„ç”¨æˆ·æˆ–ç”¨æˆ·ç»„ï¼ˆéœ€è¦å…ˆåˆ›å»ºç”¨æˆ·/ç»„ï¼‰ã€‚</li><li><code>guest ok</code>: æ˜¯å¦å…è®¸åŒ¿åè®¿é—®ï¼ˆä¸æ¨èï¼‰ã€‚</li></ul></li><li><p><strong>åˆ›å»ºä¸€ä¸ª Samba ç”¨æˆ·ç»„ï¼ˆä¾‹å¦‚ <code>gitusers</code>ï¼‰å¹¶å°†ç”¨æˆ·æ·»åŠ åˆ°è¯¥ç»„ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> groupadd gitusers</span><br><span class="line"><span class="built_in">sudo</span> usermod -aG gitusers nas  </span><br><span class="line"><span class="built_in">sudo</span> smbpasswd -a nas   </span><br></pre></td></tr></table></figure><p>é‡å¤<code>usermod</code>å’Œ<code>smbpasswd</code>å‘½ä»¤ï¼Œæ·»åŠ å¤šä¸ªç”¨æˆ·ã€‚</p></li><li><p><strong>é‡å¯ Samba æœåŠ¡ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl restart smbd</span><br></pre></td></tr></table></figure></li></ul><p><strong>4. å®¢æˆ·ç«¯è®¿é—®</strong></p><ul><li><p><strong>åœ¨ Windows ä¸Šï¼š</strong></p><ul><li>æ‰“å¼€æ–‡ä»¶èµ„æºç®¡ç†å™¨ï¼Œåœ¨åœ°å€æ è¾“å…¥ <code>\\your_server_ip\git-repos</code> ï¼ˆå°† <code>your_server_ip</code> æ›¿æ¢ä¸ºä½ çš„æœåŠ¡å™¨ IP åœ°å€æˆ–ä¸»æœºåï¼‰ã€‚</li><li>è¾“å…¥ä½ çš„ Samba ç”¨æˆ·åå’Œå¯†ç ã€‚</li><li>ä½ åº”è¯¥èƒ½çœ‹åˆ° <code>myproject.git</code> ç›®å½•ã€‚</li></ul></li><li><p><strong>åœ¨ Linux/macOS ä¸Šï¼š</strong></p><ul><li>å¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œæˆ–å›¾å½¢ç•Œé¢çš„ SMB/CIFS å®¢æˆ·ç«¯è®¿é—®ã€‚</li><li>æŒ‚è½½ Samba å…±äº«ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> mount -t cifs //your_server_ip/git-repos /mnt/git -o username=yourusername,password=yourpassword</span><br></pre></td></tr></table></figure>(å°† <code>/mnt/git</code> æ›¿æ¢ä¸ºä½ æƒ³è¦æŒ‚è½½åˆ°çš„æœ¬åœ°ç›®å½•)ã€‚</li></ul></li><li><p><strong>ä½¿ç”¨ Git å®¢æˆ·ç«¯å…‹éš†ä»“åº“ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> smb://your_server_ip/git-repos/myproject.git</span><br><span class="line"><span class="comment"># æˆ–è€…, å¦‚æœå·²ç»æŒ‚è½½:</span></span><br><span class="line">git <span class="built_in">clone</span> /mnt/git/myproject.git  </span><br></pre></td></tr></table></figure><p>ä¹‹åå°±å¯ä»¥åƒä½¿ç”¨æ™®é€šçš„ Git ä»“åº“ä¸€æ ·è¿›è¡Œ <code>add</code>ã€<code>commit</code>ã€<code>push</code>ã€<code>pull</code> ç­‰æ“ä½œã€‚</p></li></ul><p><strong>äºŒã€æ­å»º SVN æœåŠ¡å™¨å¹¶é€šè¿‡ Samba å…±äº«</strong></p><p>ä¸ Git ç±»ä¼¼ï¼ŒSVN æœåŠ¡å™¨å¤„ç†ç‰ˆæœ¬æ§åˆ¶ï¼ŒSamba å…±äº« SVN ä»“åº“ç›®å½•ã€‚</p><p><strong>1. å®‰è£… SVN å’Œ Samba</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install subversion samba libapache2-mod-svn</span><br></pre></td></tr></table></figure><p><code>libapache2-mod-svn</code> æä¾›äº†é€šè¿‡ Apache è¿›è¡Œ SVN è®¿é—®çš„åŠŸèƒ½ (å¯é€‰, ä½†æ›´å®‰å…¨, æ¨è)</p><p><strong>2. åˆ›å»º SVN ä»“åº“</strong></p><ul><li><p><strong>åˆ›å»ºä¸€ä¸ªç”¨äºå­˜æ”¾ SVN ä»“åº“çš„ç›®å½•ï¼ˆä¾‹å¦‚ <code>/srv/svn</code>ï¼‰ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /srv/svn</span><br></pre></td></tr></table></figure></li><li><p><strong>è¿›å…¥è¯¥ç›®å½•å¹¶åˆ›å»ºä¸€ä¸ª SVN ä»“åº“ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /srv/svn</span><br><span class="line"><span class="built_in">sudo</span> svnadmin create myproject  <span class="comment"># &quot;myproject&quot; æ˜¯ä½ çš„é¡¹ç›®åç§°</span></span><br></pre></td></tr></table></figure></li><li><p><strong>è®¾ç½®æƒé™</strong></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> -R www-data:www-data /srv/svn/myproject</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> -R 775 /srv/svn/myproject</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>3.  (å¯é€‰, æ¨è) é…ç½® Apache + SVN (æ›´å®‰å…¨)</strong></p><ul><li><p><strong>åˆ›å»º SVN çš„å¯†ç æ–‡ä»¶ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> htpasswd -c /etc/apache2/dav_svn.passwd yourusername  <span class="comment"># åˆ›å»ºç¬¬ä¸€ä¸ªç”¨æˆ·</span></span><br><span class="line"><span class="built_in">sudo</span> htpasswd /etc/apache2/dav_svn.passwd anotheruser     <span class="comment"># æ·»åŠ æ›´å¤šç”¨æˆ·</span></span><br></pre></td></tr></table></figure></li><li><p><strong>åˆ›å»ºä¸€ä¸ª Apache é…ç½®æ–‡ä»¶ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> nano /etc/apache2/mods-available/dav_svn.conf</span><br></pre></td></tr></table></figure><p>æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;Location /svn&gt;</span></span><br><span class="line">   <span class="attribute">DAV</span> svn</span><br><span class="line">   <span class="attribute">SVNParentPath</span> /srv/svn</span><br><span class="line">   <span class="attribute">AuthType</span> Basic</span><br><span class="line">   <span class="attribute">AuthName</span> <span class="string">&quot;Subversion Repository&quot;</span></span><br><span class="line">   <span class="attribute">AuthUserFile</span> /etc/apache2/dav_svn.passwd</span><br><span class="line">   <span class="attribute">Require</span> valid-user</span><br><span class="line"><span class="section">&lt;/Location&gt;</span></span><br></pre></td></tr></table></figure></li><li><p><strong>å¯ç”¨å¿…è¦çš„ Apache æ¨¡å—å¹¶é‡å¯ Apacheï¼š</strong></p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> a2enmod dav</span><br><span class="line"><span class="built_in">sudo</span> a2enmod dav_svn</span><br><span class="line"><span class="built_in">sudo</span> systemctl restart apache2</span><br></pre></td></tr></table></figure><ul><li>ç°åœ¨, å¯ä»¥é€šè¿‡ <code>http://your_server_ip/svn/myproject</code> æ¥è®¿é—® SVN ä»“åº“ (éœ€è¦ç”¨æˆ·åå’Œå¯†ç ).</li></ul></li></ul><p><strong>4. é…ç½® Samba å…±äº« (å¦‚æœä¸ç”¨ Apache, å¯ä»¥é€šè¿‡ Samba å…±äº«)</strong></p><ul><li><p><strong>ç¼–è¾‘ Samba é…ç½®æ–‡ä»¶ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> nano /etc/samba/smb.conf</span><br></pre></td></tr></table></figure></li><li><p><strong>åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[svn-repos]</span></span><br><span class="line">    <span class="attr">comment</span> = SVN Repositories</span><br><span class="line">    <span class="attr">path</span> = /srv/svn</span><br><span class="line">    <span class="attr">browseable</span> = <span class="literal">yes</span></span><br><span class="line">    read <span class="attr">only</span> = <span class="literal">no</span></span><br><span class="line">    guest <span class="attr">ok</span> = <span class="literal">no</span>  <span class="comment"># å¦‚æœéœ€è¦åŒ¿åè®¿é—®ï¼Œè®¾ç½®ä¸º yes</span></span><br><span class="line">    valid <span class="attr">users</span> = @svnusers <span class="comment">#åŒä¸Šï¼Œéœ€è¦åˆ›å»ºsvnusersç»„å’Œç”¨æˆ·</span></span><br><span class="line">    create <span class="attr">mask</span> = <span class="number">0664</span></span><br><span class="line">    directory <span class="attr">mask</span> = <span class="number">0775</span></span><br><span class="line">    force <span class="attr">group</span> = svnusers</span><br></pre></td></tr></table></figure></li><li><p><strong>åˆ›å»º Samba ç”¨æˆ·ç»„å’Œç”¨æˆ· (å‚è€ƒ Git éƒ¨åˆ†çš„æ­¥éª¤)ã€‚</strong></p></li><li><p><strong>é‡å¯ Samba æœåŠ¡ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl restart smbd</span><br></pre></td></tr></table></figure></li></ul><p><strong>5. å®¢æˆ·ç«¯è®¿é—®</strong></p><ul><li>å¦‚æœä½¿ç”¨ Apache + SVN, ä½¿ç”¨ SVN å®¢æˆ·ç«¯é€šè¿‡ <code>http://your_server_ip/svn/myproject</code> è®¿é—®.</li><li>å¦‚æœä½¿ç”¨ Samba å…±äº«ï¼š<ul><li><strong>Windows:</strong>  <code>\\your_server_ip\svn-repos</code></li><li><strong>Linux/macOS:</strong>  <code>smb://your_server_ip/svn-repos</code> (æˆ–æŒ‚è½½)</li><li>ä½¿ç”¨ SVN å®¢æˆ·ç«¯ï¼ˆå¦‚ TortoiseSVNã€<code>svn</code> å‘½ä»¤è¡Œå·¥å…·ï¼‰è¿›è¡Œ <code>checkout</code>ã€<code>commit</code>ã€<code>update</code> ç­‰æ“ä½œã€‚</li></ul></li></ul><h2 id="smb-å¯ç”¨å›æ”¶ç«™">smb å¯ç”¨å›æ”¶ç«™</h2><p>Samba çš„ <code>vfs_recycle</code> æ¨¡å—æä¾›äº†ä¸€ä¸ªç®€å•ä½†å®ç”¨çš„å›æ”¶ç«™åŠŸèƒ½ï¼Œå¯ä»¥é˜²æ­¢ç”¨æˆ·æ„å¤–åˆ é™¤å…±äº«æ–‡ä»¶ã€‚å½“ç”¨æˆ·é€šè¿‡ Samba åˆ é™¤æ–‡ä»¶æ—¶ï¼Œæ–‡ä»¶ä¸ä¼šè¢«ç«‹å³ä»æœåŠ¡å™¨ä¸Šæ°¸ä¹…åˆ é™¤ï¼Œè€Œæ˜¯ä¼šè¢«ç§»åŠ¨åˆ°ä¸€ä¸ªç‰¹æ®Šçš„å›æ”¶ç«™ç›®å½•ä¸­ã€‚ç®¡ç†å‘˜å¯ä»¥é…ç½®å›æ”¶ç«™çš„ä¿ç•™ç­–ç•¥ï¼Œä¾‹å¦‚æ–‡ä»¶ä¿ç•™æ—¶é—´ã€å›æ”¶ç«™æœ€å¤§å®¹é‡ç­‰ã€‚</p><p>ä¸‹é¢æ˜¯å…³äº <code>vfs_recycle</code> æ¨¡å—çš„è¯¦ç»†è¯´æ˜å’Œé…ç½®æ–¹æ³•ï¼š</p><p><strong>1. å·¥ä½œåŸç†</strong></p><ul><li>å½“ç”¨æˆ·é€šè¿‡ Samba å®¢æˆ·ç«¯åˆ é™¤æ–‡ä»¶æ—¶ï¼Œ<code>vfs_recycle</code> æ¨¡å—ä¼šæ‹¦æˆªåˆ é™¤æ“ä½œã€‚</li><li>æ–‡ä»¶ä¸ä¼šè¢«çœŸæ­£åˆ é™¤ï¼Œè€Œæ˜¯è¢«ç§»åŠ¨åˆ°é¢„å…ˆé…ç½®å¥½çš„å›æ”¶ç«™ç›®å½•ä¸­ã€‚</li><li>ç§»åŠ¨åˆ°å›æ”¶ç«™çš„æ–‡ä»¶ä¼šä¿ç•™ä¸€æ®µæ—¶é—´ï¼ˆå¯é…ç½®ï¼‰ï¼Œè¶…è¿‡ä¿ç•™æ—¶é—´åæ‰ä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚</li><li>ç®¡ç†å‘˜å¯ä»¥æ‰‹åŠ¨æ¸…ç†å›æ”¶ç«™ï¼Œæˆ–è€…æ¢å¤å›æ”¶ç«™ä¸­çš„æ–‡ä»¶ã€‚</li></ul><p><strong>2. é…ç½®æ–¹æ³•</strong></p><p><code>vfs_recycle</code> æ¨¡å—çš„é…ç½®ä¸»è¦åœ¨ Samba çš„é…ç½®æ–‡ä»¶ (<code>/etc/samba/smb.conf</code>) ä¸­å®Œæˆã€‚ä½ å¯ä»¥åœ¨å…¨å±€é…ç½®éƒ¨åˆ† (<code>[global]</code>) ä¸­è®¾ç½®é»˜è®¤çš„å›æ”¶ç«™å‚æ•°ï¼Œä¹Ÿå¯ä»¥åœ¨å•ä¸ªå…±äº«é…ç½®éƒ¨åˆ†ä¸­ä¸ºç‰¹å®šçš„å…±äº«è®¾ç½®ä¸åŒçš„å›æ”¶ç«™å‚æ•°ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªé…ç½®ç¤ºä¾‹ï¼Œæ·»åŠ åˆ°ä½ çš„ <code>smb.conf</code> æ–‡ä»¶ä¸­ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[global]</span></span><br><span class="line">    <span class="comment"># ... å…¶ä»–å…¨å±€é…ç½® ...</span></span><br><span class="line"></span><br><span class="line">    vfs <span class="attr">objects</span> = recycle  <span class="comment"># åœ¨å…¨å±€é…ç½®ä¸­å¯ç”¨ recycle æ¨¡å—</span></span><br><span class="line"></span><br><span class="line">    recycle:<span class="attr">repository</span> = .recycle/%U  <span class="comment"># å›æ”¶ç«™ç›®å½•ï¼Œ%U ä»£è¡¨ç”¨æˆ·å</span></span><br><span class="line">    recycle:<span class="attr">keeptree</span> = <span class="literal">Yes</span>            <span class="comment"># ä¿ç•™åŸå§‹ç›®å½•ç»“æ„</span></span><br><span class="line">    recycle:<span class="attr">versions</span> = <span class="literal">Yes</span>            <span class="comment"># å¯ç”¨ç‰ˆæœ¬æ§åˆ¶ (å¦‚æœæ–‡ä»¶åç›¸åŒ)</span></span><br><span class="line">    recycle:<span class="attr">touch</span> = <span class="literal">Yes</span>               <span class="comment"># æ›´æ–°æ–‡ä»¶çš„è®¿é—®æ—¶é—´</span></span><br><span class="line">    recycle:<span class="attr">maxsize</span> = <span class="number">0</span>               <span class="comment"># å›æ”¶ç«™æœ€å¤§å®¹é‡ (0 è¡¨ç¤ºæ— é™åˆ¶)</span></span><br><span class="line">    recycle:<span class="attr">exclude</span> = *.tmp, *.temp    <span class="comment"># æ’é™¤çš„æ–‡ä»¶ç±»å‹</span></span><br><span class="line">    recycle:<span class="attr">exclude_dir</span> = /tmp, /cache <span class="comment"># æ’é™¤çš„ç›®å½•</span></span><br><span class="line">    recycle:<span class="attr">noversions</span> = *.doc        <span class="comment"># ä¸ä¿ç•™ç‰ˆæœ¬çš„æ–‡ä»¶ç±»å‹</span></span><br><span class="line">    <span class="comment"># recycle:minsize = 1024            # æœ€å°æ–‡ä»¶å¤§å° (å•ä½: å­—èŠ‚)</span></span><br><span class="line">    <span class="comment"># recycle:days_kept = 30           # æ–‡ä»¶ä¿ç•™å¤©æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="section">[myshare]</span></span><br><span class="line">    <span class="attr">comment</span> = My Shared Folder</span><br><span class="line">    <span class="attr">path</span> = /path/to/myshare</span><br><span class="line">    <span class="comment"># ... å…¶ä»–å…±äº«é…ç½® ...</span></span><br><span class="line"></span><br><span class="line">    vfs <span class="attr">objects</span> = recycle  <span class="comment"># ä¹Ÿå¯ä»¥åœ¨å•ä¸ªå…±äº«ä¸­å¯ç”¨ recycle æ¨¡å—</span></span><br><span class="line">    recycle:<span class="attr">repository</span> = .recycle/%U <span class="comment">#å¯é€‰ï¼Œå¦‚æœéœ€è¦å’Œå…¨å±€ä¸ä¸€æ ·çš„é…ç½®</span></span><br></pre></td></tr></table></figure><p><strong>å‚æ•°è¯´æ˜:</strong></p><ul><li><strong><code>vfs objects = recycle</code></strong>: å¯ç”¨ <code>vfs_recycle</code> æ¨¡å—ã€‚å¯ä»¥æ”¾åœ¨ <code>[global]</code> éƒ¨åˆ†ï¼ˆå¯¹æ‰€æœ‰å…±äº«ç”Ÿæ•ˆï¼‰æˆ–å•ä¸ªå…±äº«é…ç½®éƒ¨åˆ†ï¼ˆåªå¯¹è¯¥å…±äº«ç”Ÿæ•ˆï¼‰ã€‚</li><li><strong><code>recycle:repository = .recycle/%U</code></strong>:<ul><li>æŒ‡å®šå›æ”¶ç«™ç›®å½•çš„ä½ç½®ã€‚</li><li><code>.recycle</code> æ˜¯å›æ”¶ç«™ç›®å½•çš„åç§°ï¼ˆå¯ä»¥è‡ªå®šä¹‰ï¼‰ã€‚</li><li><code>%U</code> æ˜¯ä¸€ä¸ªå˜é‡ï¼Œä»£è¡¨åˆ é™¤æ–‡ä»¶çš„ç”¨æˆ·åï¼Œè¿™æ ·å¯ä»¥ä¸ºæ¯ä¸ªç”¨æˆ·åˆ›å»ºå•ç‹¬çš„å›æ”¶ç«™ã€‚</li><li>ä¹Ÿå¯ä»¥ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œä¾‹å¦‚ <code>/path/to/recycle/%U</code>ã€‚</li><li>å¦‚æœä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚ <code>.recycle</code>ï¼‰ï¼Œå›æ”¶ç«™ç›®å½•ä¼šåˆ›å»ºåœ¨å…±äº«ç›®å½•çš„æ ¹ç›®å½•ä¸‹ã€‚</li></ul></li><li><strong><code>recycle:keeptree = Yes</code></strong>:  åœ¨å›æ”¶ç«™ä¸­ä¿ç•™æ–‡ä»¶è¢«åˆ é™¤å‰çš„åŸå§‹ç›®å½•ç»“æ„ã€‚å¦‚æœè®¾ç½®ä¸º <code>No</code>ï¼Œæ‰€æœ‰æ–‡ä»¶éƒ½ä¼šè¢«ç›´æ¥æ”¾åœ¨å›æ”¶ç«™æ ¹ç›®å½•ä¸‹ã€‚</li><li><strong><code>recycle:versions = Yes</code></strong>:<ul><li>å¦‚æœå›æ”¶ç«™ä¸­å·²ç»å­˜åœ¨åŒåæ–‡ä»¶ï¼Œæ˜¯å¦åˆ›å»ºæ–°ç‰ˆæœ¬ã€‚</li><li>è®¾ç½®ä¸º <code>Yes</code> æ—¶ï¼Œæ–°ç‰ˆæœ¬çš„æ–‡ä»¶åä¼šé™„åŠ ä¸€ä¸ªç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚ <code>file.txt.1</code>ã€<code>file.txt.2</code>ï¼‰ã€‚</li><li>è®¾ç½®ä¸º <code>No</code> æ—¶ï¼Œæ–°æ–‡ä»¶ä¼šè¦†ç›–æ—§æ–‡ä»¶ã€‚</li></ul></li><li><strong><code>recycle:touch = Yes</code></strong>:  å½“æ–‡ä»¶è¢«ç§»åŠ¨åˆ°å›æ”¶ç«™æ—¶ï¼Œæ›´æ–°æ–‡ä»¶çš„è®¿é—®æ—¶é—´ï¼ˆatimeï¼‰ã€‚</li><li><strong><code>recycle:maxsize = 0</code></strong>:<ul><li>è®¾ç½®å›æ”¶ç«™çš„æœ€å¤§å®¹é‡ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚</li><li><code>0</code> è¡¨ç¤ºæ— é™åˆ¶ã€‚</li><li>å½“å›æ”¶ç«™è¾¾åˆ°æœ€å¤§å®¹é‡æ—¶ï¼Œæœ€æ—©çš„æ–‡ä»¶ä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚</li></ul></li><li><strong><code>recycle:exclude = *.tmp, *.temp</code></strong>:  æŒ‡å®šä¸æ”¾å…¥å›æ”¶ç«™çš„æ–‡ä»¶ç±»å‹ï¼ˆä½¿ç”¨é€šé…ç¬¦ï¼‰ã€‚</li><li><strong><code>recycle:exclude_dir = /tmp, /cache</code></strong>:  æŒ‡å®šä¸æ”¾å…¥å›æ”¶ç«™çš„ç›®å½•ï¼ˆç»å¯¹è·¯å¾„ï¼‰ã€‚</li><li><strong><code>recycle:noversions = *.doc</code></strong>:  æŒ‡å®šä¸ä¿ç•™ç‰ˆæœ¬çš„æ–‡ä»¶ç±»å‹ï¼ˆå³ä½¿ <code>recycle:versions = Yes</code>ï¼‰ã€‚</li><li><strong><code>recycle:minsize = 1024</code></strong>:  æŒ‡å®šåªæœ‰å¤§äºæ­¤å¤§å°ï¼ˆå­—èŠ‚ï¼‰çš„æ–‡ä»¶æ‰ä¼šè¢«æ”¾å…¥å›æ”¶ç«™ã€‚</li><li><strong><code>recycle:days_kept = 30</code></strong>:  æŒ‡å®šæ–‡ä»¶åœ¨å›æ”¶ç«™ä¸­ä¿ç•™çš„å¤©æ•°ã€‚è¶…è¿‡æ­¤å¤©æ•°çš„æ–‡ä»¶ä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚</li></ul><p><strong>3. æ³¨æ„äº‹é¡¹</strong></p><ul><li><strong>æƒé™:</strong> ç¡®ä¿ Samba ç”¨æˆ·å¯¹å›æ”¶ç«™ç›®å½•æœ‰è¯»å†™æƒé™ã€‚</li><li><strong>æ€§èƒ½:</strong> å¦‚æœå›æ”¶ç«™ä¸­æ–‡ä»¶è¿‡å¤šï¼Œå¯èƒ½ä¼šå½±å“ Samba çš„æ€§èƒ½ã€‚å»ºè®®å®šæœŸæ¸…ç†å›æ”¶ç«™ã€‚</li><li><strong>åˆ é™¤</strong>: å›æ”¶ç«™ä¸­çš„æ–‡ä»¶ï¼Œæ˜¯çœŸæ­£è¢«åˆ é™¤ã€‚</li><li><strong>ä¸ç‰ˆæœ¬æ§åˆ¶çš„åŒºåˆ«:</strong> <code>vfs_recycle</code> æ¨¡å—åªæ˜¯ä¸€ä¸ªç®€å•çš„å›æ”¶ç«™åŠŸèƒ½ï¼Œå®ƒä¸èƒ½åƒ Gitã€SVN é‚£æ ·è¿›è¡Œç»†ç²’åº¦çš„ç‰ˆæœ¬æ§åˆ¶ï¼ˆè®°å½•æ¯æ¬¡ä¿®æ”¹ã€å›æ»šåˆ°ç‰¹å®šç‰ˆæœ¬ç­‰ï¼‰ã€‚å®ƒåªèƒ½æ¢å¤è¢«åˆ é™¤çš„æ–‡ä»¶ï¼Œè€Œä¸èƒ½æ¢å¤æ–‡ä»¶çš„å†å²ç‰ˆæœ¬ï¼ˆé™¤éå¯ç”¨äº† <code>recycle:versions</code> å¹¶ä¸”æ–‡ä»¶åç›¸åŒï¼‰ã€‚</li><li><strong>å®¢æˆ·ç«¯å…¼å®¹æ€§</strong>: é€šè¿‡smbåˆ é™¤çš„æ–‡ä»¶æ‰ä¼šè¿›å…¥å›æ”¶ç«™ï¼Œç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šé€šè¿‡<code>rm</code>ç­‰å‘½ä»¤åˆ é™¤ï¼Œä¸ä¼šè¿›å…¥å›æ”¶ç«™ã€‚</li></ul><p><strong>4. ä½¿ç”¨æ–¹æ³•</strong></p><p>é…ç½®å®Œæˆåï¼Œç”¨æˆ·é€šè¿‡ Samba å®¢æˆ·ç«¯åˆ é™¤æ–‡ä»¶æ—¶ï¼Œæ–‡ä»¶ä¼šè‡ªåŠ¨è¿›å…¥å›æ”¶ç«™ã€‚ç®¡ç†å‘˜å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ç®¡ç†å›æ”¶ç«™ï¼š</p><ul><li><strong>ç›´æ¥è®¿é—®å›æ”¶ç«™ç›®å½•:</strong> å›æ”¶ç«™ç›®å½•é€šå¸¸ä½äºå…±äº«ç›®å½•çš„æ ¹ç›®å½•ä¸‹ï¼ˆå¦‚æœä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼‰æˆ–æŒ‡å®šçš„ç»å¯¹è·¯å¾„ä¸‹ã€‚ç®¡ç†å‘˜å¯ä»¥ç›´æ¥è®¿é—®è¯¥ç›®å½•æ¥æŸ¥çœ‹ã€æ¢å¤æˆ–åˆ é™¤å›æ”¶ç«™ä¸­çš„æ–‡ä»¶ã€‚</li><li><strong>ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·:</strong> å¯ä»¥ç¼–å†™è„šæœ¬ï¼Œå®šæœŸæ¸…ç†å›æ”¶ç«™ä¸­è¶…è¿‡ä¿ç•™æ—¶é—´çš„æ–‡ä»¶ã€‚</li></ul><p>é€šè¿‡åˆç†é…ç½® <code>vfs_recycle</code> æ¨¡å—ï¼Œä½ å¯ä»¥ä¸º Samba å…±äº«æä¾›ä¸€ä¸ªç®€å•æœ‰æ•ˆçš„å›æ”¶ç«™åŠŸèƒ½ï¼Œé˜²æ­¢ç”¨æˆ·è¯¯åˆ é™¤æ–‡ä»¶ï¼Œæé«˜æ•°æ®å®‰å…¨æ€§ã€‚</p><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¼ä¸šçº§VPNæ­å»ºæ–¹æ¡ˆå¯¹æ¯”ä¸æŒ‡å¯¼</title>
      <link href="/2025/03/17/vpn-ee-build/"/>
      <url>/2025/03/17/vpn-ee-build/</url>
      
        <content type="html"><![CDATA[<h2 id="æŠ€æœ¯é€‰å‹">æŠ€æœ¯é€‰å‹</h2><ul><li><p><strong>SoftEther VPN:</strong></p><ul><li><strong>æœåŠ¡ç«¯:</strong> SoftEther VPN Server</li><li><strong>å®¢æˆ·ç«¯:</strong> SoftEther VPN Client (å®˜æ–¹æä¾›ï¼Œè·¨å¹³å°), æˆ–è€…å…¶ä»–å…¼å®¹çš„ VPN å®¢æˆ·ç«¯ (å¦‚ OpenVPN å®¢æˆ·ç«¯, ç³»ç»Ÿå†…ç½®çš„ L2TP/IPsec å®¢æˆ·ç«¯ç­‰)</li></ul></li><li><p><strong>OpenVPN Access Server:</strong></p><ul><li><strong>æœåŠ¡ç«¯:</strong> OpenVPN Access Server</li><li><strong>å®¢æˆ·ç«¯:</strong> OpenVPN Connect (å®˜æ–¹æä¾›ï¼Œè·¨å¹³å°), æˆ–è€…å…¶ä»–å…¼å®¹çš„ OpenVPN å®¢æˆ·ç«¯</li></ul></li><li><p><strong>WireGuard (é€šè¿‡ Algo æˆ– wg-easy):</strong></p><ul><li><strong>æœåŠ¡ç«¯:</strong> Algo æˆ– wg-easy éƒ¨ç½²çš„ WireGuard æœåŠ¡</li><li><strong>å®¢æˆ·ç«¯:</strong> WireGuard å®˜æ–¹å®¢æˆ·ç«¯ (è·¨å¹³å°)</li></ul></li><li><p><strong>Pritunl:</strong></p><ul><li><strong>æœåŠ¡ç«¯:</strong> Pritunl Server</li><li><strong>å®¢æˆ·ç«¯:</strong> Pritunl Client (å®˜æ–¹æä¾›ï¼Œè·¨å¹³å°), æˆ–è€…å…¶ä»–å…¼å®¹çš„ OpenVPN å®¢æˆ·ç«¯.</li></ul></li></ul><h2 id="æ–¹æ¡ˆé€‰æ‹©">æ–¹æ¡ˆé€‰æ‹©</h2><p>é€‰æ‹© wg-easy + WireGuardï¼Ÿ**</p><ul><li><strong>ç®€å•æ€§:</strong> WireGuard çš„é…ç½®éå¸¸ç®€æ´ï¼Œè€Œ wg-easy è¿›ä¸€æ­¥ç®€åŒ–äº†éƒ¨ç½²å’Œç®¡ç†è¿‡ç¨‹ï¼Œæä¾›äº†å›¾å½¢åŒ–ç•Œé¢ã€‚</li><li><strong>é€Ÿåº¦:</strong> WireGuard ä»¥å…¶å“è¶Šçš„æ€§èƒ½è€Œé—»åï¼Œæ¯” OpenVPN å’Œ IPsec æ›´å¿«ã€‚</li><li><strong>å®‰å…¨æ€§:</strong> WireGuard ä½¿ç”¨æœ€å…ˆè¿›çš„åŠ å¯†æŠ€æœ¯ï¼Œå¹¶ä¸”ä»£ç åº“éå¸¸å°ï¼Œæ˜“äºå®¡è®¡ã€‚</li><li><strong>æœªæ¥è¶‹åŠ¿:</strong> WireGuard æ­£åœ¨è¿…é€Ÿæˆä¸º VPN åè®®çš„æ–°æ ‡å‡†ï¼Œè®¸å¤šå¤§å‹å…¬å¸å’Œé¡¹ç›®éƒ½åœ¨é‡‡ç”¨å®ƒã€‚</li><li><strong>Dockeréƒ¨ç½²:</strong> æ–¹ä¾¿éƒ¨ç½²ã€æ›´æ–°å’Œè¿ç§»ã€‚</li></ul><p><strong>è¯¦ç»†æ­å»ºæ­¥éª¤ï¼š</strong></p><p><strong>1. å‡†å¤‡å·¥ä½œ</strong></p><ul><li><strong>æœåŠ¡å™¨ï¼š</strong><ul><li>ä¸€å°å…·æœ‰å…¬ç½‘ IP åœ°å€çš„æœåŠ¡å™¨ï¼ˆVPS æˆ– ç‹¬ç«‹æœåŠ¡å™¨ï¼‰ã€‚</li><li>æ“ä½œç³»ç»Ÿï¼šæ¨èä½¿ç”¨ Linux å‘è¡Œç‰ˆï¼ˆå¦‚ Ubuntu Serverã€Debianã€CentOSï¼‰ã€‚</li><li>æœåŠ¡å™¨éœ€è¦å¼€æ”¾ UDP 51820 ç«¯å£ (WireGuard é»˜è®¤ç«¯å£) å’Œ TCP 51821 ç«¯å£ (wg-easy Web UI ç«¯å£).  å¦‚æœä½ ä½¿ç”¨äº‘æœåŠ¡å•†, éœ€è¦åœ¨å®‰å…¨ç»„/é˜²ç«å¢™è§„åˆ™ä¸­æ”¾è¡Œè¿™ä¸¤ä¸ªç«¯å£.</li></ul></li><li><strong>åŸŸå (å¯é€‰ï¼Œå¼ºçƒˆæ¨è)ï¼š</strong><ul><li>ä¸€ä¸ªåŸŸåï¼Œä¾‹å¦‚ <code>vpn.yourcompany.com</code>ã€‚</li><li>å°†åŸŸåè§£æåˆ°æ‚¨çš„æœåŠ¡å™¨å…¬ç½‘ IP åœ°å€ã€‚</li></ul></li><li><strong>æœ¬åœ°ç¯å¢ƒï¼š</strong><ul><li>å®‰è£…äº† Docker å’Œ Docker Compose çš„ç”µè„‘ï¼ˆç”¨äºç®¡ç†æœåŠ¡å™¨ä¸Šçš„ wg-easy å®¹å™¨ï¼‰ã€‚</li></ul></li></ul><p><strong>2. æœåŠ¡å™¨ç«¯éƒ¨ç½² (ä½¿ç”¨ wg-easy)</strong></p><ul><li><p><strong>SSH è¿æ¥åˆ°æ‚¨çš„æœåŠ¡å™¨ã€‚</strong></p></li><li><p><strong>å®‰è£… Docker å’Œ Docker Composeï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu/Debian</span></span><br><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install docker.io docker-compose -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS</span></span><br><span class="line"><span class="built_in">sudo</span> yum install -y yum-utils</span><br><span class="line"><span class="built_in">sudo</span> yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"><span class="built_in">sudo</span> yum install docker-ce docker-ce-cli containerd.io -y</span><br><span class="line"><span class="built_in">sudo</span> systemctl start docker</span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> docker</span><br><span class="line"><span class="built_in">sudo</span> curl -L <span class="string">&quot;https://github.com/docker/compose/releases/download/v2.2.2/docker-compose-<span class="subst">$(uname -s)</span>-<span class="subst">$(uname -m)</span>&quot;</span> -o /usr/local/bin/docker-compose  <span class="comment">#æ³¨æ„, è¿™ä¸ªç‰ˆæœ¬å·å¯èƒ½ä¼šè¿‡æ—¶, è¯·å» https://github.com/docker/compose/releases/ ç¡®è®¤æœ€æ–°ç‰ˆæœ¬.</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> +x /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure></li><li><p><strong>åˆ›å»º <code>docker-compose.yml</code> æ–‡ä»¶ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano docker-compose.yml</span><br></pre></td></tr></table></figure><p>å°†ä»¥ä¸‹å†…å®¹å¤åˆ¶åˆ°æ–‡ä»¶ä¸­ï¼Œå¹¶æ ¹æ®æ‚¨çš„å®é™…æƒ…å†µä¿®æ”¹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">wg-easy:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">weejewel/wg-easy</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">wg-easy</span></span><br><span class="line">    <span class="attr">cap_add:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">NET_ADMIN</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SYS_MODULE</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">WG_HOST=your_server_public_ip_or_domain</span>  <span class="comment"># æ›¿æ¢ä¸ºä½ çš„æœåŠ¡å™¨å…¬ç½‘ IP æˆ–åŸŸå</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PASSWORD=your_web_ui_password</span>  <span class="comment"># æ›¿æ¢ä¸º Web UI çš„å¯†ç ï¼ŒåŠ¡å¿…è®¾ç½®å¼ºå¯†ç ï¼</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">WG_DEFAULT_ADDRESS=10.8.0.x</span>  <span class="comment"># VPN å®¢æˆ·ç«¯çš„ IP åœ°å€æ®µï¼Œä¸è¦ä¸å†…ç½‘ IP å†²çª</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">WG_DEFAULT_DNS=1.1.1.1</span>  <span class="comment"># é»˜è®¤ DNS æœåŠ¡å™¨ï¼Œå¯ä»¥æ”¹ä¸ºå†…ç½‘ DNS æˆ–å…¶ä»–å…¬å…± DNS</span></span><br><span class="line">      <span class="comment"># å…¶ä»–å¯é€‰ç¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼‰ï¼š</span></span><br><span class="line">      <span class="comment"># - WG_PORT=51820  # WireGuard ç›‘å¬ç«¯å£ï¼Œé»˜è®¤ä¸º 51820</span></span><br><span class="line">      <span class="comment"># - WG_ALLOWED_IPS=0.0.0.0/0  # å…è®¸è¿æ¥çš„å®¢æˆ·ç«¯ IP èŒƒå›´ï¼Œé»˜è®¤ä¸ºæ‰€æœ‰ IP</span></span><br><span class="line">      <span class="comment"># - WG_MTU=1420  # MTU å€¼ï¼Œé€šå¸¸ä¸éœ€è¦ä¿®æ”¹</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./wg-data:/etc/wireguard</span>  <span class="comment"># å°† WireGuard é…ç½®æŒä¹…åŒ–åˆ°å®¿ä¸»æœºçš„ ./wg-data ç›®å½•</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;51820:51820/udp&quot;</span>  <span class="comment"># WireGuard ç«¯å£</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;51821:51821/tcp&quot;</span>  <span class="comment"># wg-easy Web UI ç«¯å£</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">sysctls:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">net.ipv4.ip_forward=1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">net.ipv4.conf.all.src_valid_mark=1</span></span><br></pre></td></tr></table></figure></li><li><p><strong>å¯åŠ¨ wg-easy å®¹å™¨ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure></li><li><p><strong>ç¡®è®¤å®¹å™¨æ­£åœ¨è¿è¡Œï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></table></figure><p>åº”è¯¥èƒ½çœ‹åˆ°åä¸º <code>wg-easy</code> çš„å®¹å™¨æ­£åœ¨è¿è¡Œã€‚</p></li></ul><p><strong>3. é…ç½® wg-easy Web UI</strong></p><ul><li><strong>åœ¨æµè§ˆå™¨ä¸­è®¿é—® <code>http://your_server_ip:51821</code> æˆ– <code>http://your_domain:51821</code>ã€‚</strong></li><li><strong>ä½¿ç”¨æ‚¨åœ¨ <code>docker-compose.yml</code> æ–‡ä»¶ä¸­è®¾ç½®çš„å¯†ç ç™»å½•ã€‚</strong></li><li><strong>åœ¨ Web UI ä¸­åˆ›å»ºå®¢æˆ·ç«¯é…ç½®ï¼š</strong><ul><li>ç‚¹å‡» â€œNewâ€ æŒ‰é’®ã€‚</li><li>è¾“å…¥å®¢æˆ·ç«¯åç§°ï¼ˆä¾‹å¦‚ â€œuser1â€ï¼‰ã€‚</li><li>ç‚¹å‡» â€œCreateâ€ æŒ‰é’®ã€‚</li><li>ç‚¹å‡»æ–°åˆ›å»ºçš„å®¢æˆ·ç«¯æ—è¾¹çš„ä¸‹è½½æŒ‰é’®ï¼Œä¸‹è½½ <code>.conf</code> é…ç½®æ–‡ä»¶ã€‚  æˆ–è€…ç‚¹å‡»äºŒç»´ç å›¾æ ‡, ç”¨æ‰‹æœºå®¢æˆ·ç«¯æ‰«æäºŒç»´ç .</li></ul></li></ul><p><strong>4. å®¢æˆ·ç«¯é…ç½®</strong></p><ul><li><p><strong>ä¸‹è½½å¹¶å®‰è£… WireGuard å®¢æˆ·ç«¯ï¼š</strong></p><ul><li><strong>Windowsã€macOSã€Androidã€iOSï¼š</strong> ä» WireGuard å®˜ç½‘ä¸‹è½½å¹¶å®‰è£…ç›¸åº”çš„å®¢æˆ·ç«¯ï¼š<a href="https://www.wireguard.com/install/">https://www.wireguard.com/install/</a></li><li><strong>Linux:</strong> ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu/Debian</span></span><br><span class="line"><span class="built_in">sudo</span> apt install wireguard</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS</span></span><br><span class="line"><span class="built_in">sudo</span> yum install epel-release</span><br><span class="line"><span class="built_in">sudo</span> yum install wireguard-tools</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>å¯¼å…¥å®¢æˆ·ç«¯é…ç½®æ–‡ä»¶ï¼š</strong></p><ul><li><strong>Windowsã€macOSã€Androidã€iOSï¼š</strong> æ‰“å¼€ WireGuard å®¢æˆ·ç«¯ï¼Œç‚¹å‡» â€œImport tunnel(s) from fileâ€ï¼Œé€‰æ‹©æ‚¨ä» wg-easy Web UI ä¸‹è½½çš„ <code>.conf</code> æ–‡ä»¶ã€‚</li><li><strong>Linux:</strong> å°† <code>.conf</code> æ–‡ä»¶å¤åˆ¶åˆ° <code>/etc/wireguard/</code> ç›®å½•ï¼Œå¹¶é‡å‘½åä¸º <code>wg0.conf</code> (æˆ–å…¶ä»–æ‚¨å–œæ¬¢çš„åç§°, ä¾‹å¦‚<code>client1.conf</code>)ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> user1.conf /etc/wireguard/wg0.conf</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>è¿æ¥ VPNï¼š</strong></p><ul><li><strong>Windowsã€macOSã€Androidã€iOSï¼š</strong> åœ¨ WireGuard å®¢æˆ·ç«¯ä¸­ï¼Œç‚¹å‡»æ‚¨å¯¼å…¥çš„é…ç½®æ–‡ä»¶çš„ â€œActivateâ€ æˆ– â€œConnectâ€ æŒ‰é’®ã€‚</li><li><strong>Linux:</strong> ä½¿ç”¨ <code>wg-quick</code> å‘½ä»¤å¯åŠ¨ VPN è¿æ¥ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> wg-quick up wg0  <span class="comment"># wg0 æ˜¯æ‚¨çš„é…ç½®æ–‡ä»¶åï¼ˆä¸å¸¦ .confï¼‰</span></span><br><span class="line"><span class="comment"># æ–­å¼€è¿æ¥ï¼š</span></span><br><span class="line"><span class="built_in">sudo</span> wg-quick down wg0</span><br><span class="line"> <span class="comment">#è®¾ç½®å¼€æœºè‡ªå¯</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> wg-quick@wg0</span><br></pre></td></tr></table></figure></li></ul></li></ul><p><strong>5. æµ‹è¯•è¿æ¥</strong></p><ul><li>è¿æ¥ VPN åï¼Œè®¿é—®ä¸€ä¸ªå¯ä»¥æ˜¾ç¤ºæ‚¨ IP åœ°å€çš„ç½‘ç«™ï¼ˆä¾‹å¦‚ <a href="https://www.whatismyip.com/">https://www.whatismyip.com/</a>ï¼‰ï¼Œç¡®è®¤æ‚¨çš„ IP åœ°å€å·²å˜ä¸ºæœåŠ¡å™¨çš„å…¬ç½‘ IP åœ°å€ã€‚</li><li>å°è¯•è®¿é—®æ‚¨å†…ç½‘çš„èµ„æºï¼Œç¡®è®¤å¯ä»¥æ­£å¸¸è®¿é—®ã€‚</li></ul><p><strong>åç»­ç»´æŠ¤ï¼š</strong></p><ul><li><strong>æ·»åŠ æ–°ç”¨æˆ·ï¼š</strong> åœ¨ wg-easy Web UI ä¸­åˆ›å»ºæ–°çš„å®¢æˆ·ç«¯é…ç½®å³å¯ã€‚</li><li><strong>æ’¤é”€ç”¨æˆ·ï¼š</strong> åœ¨ wg-easy Web UI ä¸­åˆ é™¤ç›¸åº”çš„å®¢æˆ·ç«¯é…ç½®ã€‚</li><li><strong>æ›´æ–° wg-easyï¼š</strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-compose pull</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure></li><li><strong>æŸ¥çœ‹ WireGuard çŠ¶æ€:</strong> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> wg show</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨rsyncåŒæ­¥å¤‡ä»½NASä¸­çš„æ–‡ä»¶åˆ°å…¶ä»–NSAæœåŠ¡å™¨</title>
      <link href="/2025/03/11/rsync-nas-backup/"/>
      <url>/2025/03/11/rsync-nas-backup/</url>
      
        <content type="html"><![CDATA[<h1>ä½¿ç”¨rsyncåŒæ­¥å¤‡ä»½NASä¸­çš„æ–‡ä»¶åˆ°å…¶ä»–NSAæœåŠ¡å™¨</h1><h2 id="rsyncç®€ä»‹">rsyncç®€ä»‹</h2><p><code>rsync</code> æ˜¯ä¸€ä¸ªå¿«é€Ÿã€é€šç”¨ä¸”æå…¶å¼ºå¤§çš„æ–‡ä»¶å¤åˆ¶å·¥å…·ï¼Œä¸»è¦ç”¨äº Unix-like ç³»ç»Ÿï¼ˆåŒ…æ‹¬ Linuxã€macOSï¼‰ã€‚å®ƒä¹Ÿå¯ä»¥åœ¨ Windows ä¸Šé€šè¿‡ Cygwinã€WSL æˆ–æœ¬åœ°ç§»æ¤ç‰ˆæœ¬ä½¿ç”¨ã€‚ <code>rsync</code> ä¸ä»…å¯ä»¥è¿›è¡Œæœ¬åœ°å¤åˆ¶ï¼Œè¿˜å¯ä»¥é€šè¿‡ç½‘ç»œï¼ˆé€šå¸¸ä½¿ç”¨ SSHï¼‰è¿›è¡Œè¿œç¨‹å¤åˆ¶ã€‚</p><p><strong>rsync çš„ä¸»è¦ä¼˜ç‚¹ï¼š</strong></p><ul><li><strong>å¢é‡ä¼ è¾“ï¼ˆDelta Transferï¼‰ï¼š</strong> <code>rsync</code> æœ€æ˜¾è‘—çš„ç‰¹ç‚¹æ˜¯å®ƒçš„å¢é‡ä¼ è¾“ç®—æ³•ã€‚å®ƒåªå¤åˆ¶æºæ–‡ä»¶å’Œç›®æ ‡æ–‡ä»¶ä¹‹é—´ä¸åŒçš„éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯å¤åˆ¶æ•´ä¸ªæ–‡ä»¶ã€‚è¿™ä½¿å¾— <code>rsync</code> åœ¨åŒæ­¥å¤§å‹æ–‡ä»¶æˆ–ç›®å½•æ—¶éå¸¸é«˜æ•ˆï¼Œå°¤å…¶æ˜¯åœ¨ç½‘ç»œå¸¦å®½æœ‰é™çš„æƒ…å†µä¸‹ã€‚</li><li><strong>é€Ÿåº¦å¿«ï¼š</strong> ç”±äºåªä¼ è¾“å·®å¼‚éƒ¨åˆ†ï¼Œ<code>rsync</code> é€šå¸¸æ¯”å…¶ä»–å¤åˆ¶å·¥å…·ï¼ˆå¦‚ <code>scp</code>ï¼‰å¿«å¾—å¤šï¼Œå°¤å…¶æ˜¯åœ¨è¿›è¡Œé‡å¤åŒæ­¥æ—¶ã€‚</li><li><strong>çµæ´»ï¼š</strong> <code>rsync</code> æä¾›äº†å¤§é‡çš„é€‰é¡¹ï¼Œå¯ä»¥å¯¹å¤åˆ¶è¿‡ç¨‹è¿›è¡Œç²¾ç»†æ§åˆ¶ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥ï¼š<ul><li>ä¿ç•™æ–‡ä»¶æƒé™ã€æ‰€æœ‰è€…ã€ç»„ã€æ—¶é—´æˆ³ç­‰å±æ€§ã€‚</li><li>æ’é™¤/åŒ…å«ç‰¹å®šæ–‡ä»¶æˆ–ç›®å½•ã€‚</li><li>é™åˆ¶å¸¦å®½ä½¿ç”¨ã€‚</li><li>åˆ é™¤ç›®æ ‡ç›®å½•ä¸­å­˜åœ¨ä½†æºç›®å½•ä¸­ä¸å­˜åœ¨çš„æ–‡ä»¶ï¼ˆåŒæ­¥åˆ é™¤ï¼‰ã€‚</li><li>åˆ›å»ºå¤‡ä»½ï¼ˆä¿ç•™å·²åˆ é™¤æˆ–ä¿®æ”¹æ–‡ä»¶çš„æ—§ç‰ˆæœ¬ï¼‰ã€‚</li><li>ä½¿ç”¨ SSH è¿›è¡ŒåŠ å¯†ä¼ è¾“ã€‚</li></ul></li><li><strong>å¯é ï¼š</strong> <code>rsync</code> ç»è¿‡äº†å¹¿æ³›çš„æµ‹è¯•ï¼Œéå¸¸ç¨³å®šã€‚å®ƒè¿˜æ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼Œå¯ä»¥åœ¨ä¼ è¾“ä¸­æ–­åç»§ç»­ã€‚</li><li><strong>ç”¨é€”å¹¿æ³›ï¼š</strong> <code>rsync</code> ä¸ä»…å¯ä»¥ç”¨äºå¤‡ä»½ï¼Œè¿˜å¯ä»¥ç”¨äºï¼š<ul><li>ç½‘ç«™é•œåƒã€‚</li><li>æ–‡ä»¶åŒæ­¥ã€‚</li><li>è½¯ä»¶éƒ¨ç½²ã€‚</li><li>ç³»ç»Ÿè¿ç§»ã€‚</li></ul></li></ul><p><strong>rsync çš„åŸºæœ¬è¯­æ³•ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync [options] <span class="built_in">source</span> destination</span><br></pre></td></tr></table></figure><ul><li><strong><code>options</code>ï¼š</strong>  <code>rsync</code> çš„é€‰é¡¹ï¼ˆä¾‹å¦‚ <code>-a</code>ã€<code>-v</code>ã€<code>-z</code>ã€<code>--delete</code> ç­‰ï¼‰ã€‚</li><li><strong><code>source</code>ï¼š</strong>  æºæ–‡ä»¶æˆ–ç›®å½•ã€‚</li><li><strong><code>destination</code>ï¼š</strong> ç›®æ ‡æ–‡ä»¶æˆ–ç›®å½•ã€‚</li></ul><p><strong>å¸¸ç”¨é€‰é¡¹ï¼š</strong></p><ul><li><code>-a</code>ï¼šå½’æ¡£æ¨¡å¼ï¼Œç­‰æ•ˆäº <code>-rlptgoD</code>ï¼Œä¿ç•™æ–‡ä»¶çš„å„ç§å±æ€§ã€‚</li><li><code>-v</code>ï¼šè¯¦ç»†æ¨¡å¼ï¼Œæ˜¾ç¤ºä¼ è¾“çš„æ–‡ä»¶åã€‚</li><li><code>-z</code>ï¼šå‹ç¼©ä¼ è¾“çš„æ•°æ®ã€‚</li><li><code>-h</code>ï¼šä»¥äººç±»å¯è¯»çš„æ ¼å¼æ˜¾ç¤ºæ•°å­—ï¼ˆä¾‹å¦‚ï¼Œ1Kã€234Mã€2Gï¼‰ã€‚</li><li><code>--progress</code>ï¼šæ˜¾ç¤ºä¼ è¾“è¿›åº¦ã€‚</li><li><code>--delete</code>ï¼šåˆ é™¤ç›®æ ‡ç›®å½•ä¸­å­˜åœ¨ä½†æºç›®å½•ä¸­ä¸å­˜åœ¨çš„æ–‡ä»¶ï¼ˆè°¨æ…ä½¿ç”¨ï¼ï¼‰ã€‚</li><li><code>-e ssh</code>ï¼šä½¿ç”¨ SSH è¿›è¡ŒåŠ å¯†ä¼ è¾“ã€‚</li><li><code>--exclude=PATTERN</code>ï¼šæ’é™¤åŒ¹é… <code>PATTERN</code> çš„æ–‡ä»¶æˆ–ç›®å½•ã€‚</li><li><code>--include=PATTERN</code>ï¼šåŒ…å«åŒ¹é… <code>PATTERN</code> çš„æ–‡ä»¶æˆ–ç›®å½•ï¼ˆé€šå¸¸ä¸ <code>--exclude='*'</code> ä¸€èµ·ä½¿ç”¨ï¼‰ã€‚</li><li><code>--bwlimit=RATE</code>ï¼šé™åˆ¶å¸¦å®½ä½¿ç”¨ï¼ˆé€Ÿç‡å•ä½ä¸º KB/sï¼‰ã€‚</li><li><code>--partial</code> : ä¿ç•™éƒ¨åˆ†ä¼ è¾“æ–‡ä»¶, ç”¨äºæ–­ç‚¹ç»­ä¼ ã€‚</li><li><code>--dry-run</code> æˆ– <code>-n</code>ï¼šæ¨¡æ‹Ÿè¿è¡Œï¼Œä¸å®é™…ä¼ è¾“æ–‡ä»¶ã€‚</li></ul><p><strong>æœ¬åœ°å¤åˆ¶ç¤ºä¾‹ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -avzh --progress /path/to/source/ /path/to/destination/</span><br></pre></td></tr></table></figure><p><strong>è¿œç¨‹å¤åˆ¶ç¤ºä¾‹ (ä½¿ç”¨ SSH)ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rsync -avz --progress -e ssh user@remote_host:/path/to/source/ /path/to/destination/</span><br><span class="line"><span class="comment"># æˆ–è€…</span></span><br><span class="line">rsync -avz --progress -e ssh /path/to/source/ user@remote_host:/path/to/destination/</span><br></pre></td></tr></table></figure><h3 id="2-ä½¿ç”¨-rsync-å¤‡ä»½æ•°æ®åˆ°å¦ä¸€-NAS-æœåŠ¡å™¨å®ç°æ­¥éª¤">2. ä½¿ç”¨ rsync å¤‡ä»½æ•°æ®åˆ°å¦ä¸€ NAS æœåŠ¡å™¨å®ç°æ­¥éª¤</h3><p><strong>å‡è®¾ï¼š</strong></p><ul><li>æº NAS çš„ IP åœ°å€æ˜¯ <code>192.168.1.10</code>ï¼Œç”¨æˆ·åæ˜¯ <code>admin</code>ã€‚</li><li>ç›®æ ‡ NAS çš„ IP åœ°å€æ˜¯ <code>192.168.1.20</code>ï¼Œç”¨æˆ·åæ˜¯ <code>backupuser</code>ã€‚</li><li>è¦å¤‡ä»½çš„æºç›®å½•æ˜¯ <code>/volume1/data</code>ã€‚</li><li>ç›®æ ‡ç›®å½•æ˜¯ <code>/volume1/backups/data_backup</code>ã€‚</li><li>ä½ å·²ç»åœ¨æº NAS æˆ–ç›®æ ‡ NAS ä¸Šï¼ˆæˆ–ä»»ä½•å¯ä»¥è®¿é—®è¿™ä¸¤ä¸ª NAS çš„æœºå™¨ä¸Šï¼‰å®‰è£…äº† <code>rsync</code>ã€‚</li><li>ä½ å·²ç»é…ç½®å¥½äº† SSH å…å¯†ç™»å½•.</li></ul><p><strong>æ­¥éª¤ï¼š</strong></p><ol><li><p><strong>ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰è®¾ç½® SSH å…å¯†ç ç™»å½•ï¼š</strong></p><p>ä¸ºäº†é¿å…æ¯æ¬¡è¿è¡Œ <code>rsync</code> éƒ½éœ€è¦è¾“å…¥å¯†ç ï¼Œå»ºè®®è®¾ç½® SSH å¯†é’¥è®¤è¯ã€‚è¿™æ ·å¯ä»¥å®ç°è‡ªåŠ¨åŒ–å¤‡ä»½ï¼Œè€Œæ— éœ€äººå·¥å¹²é¢„ã€‚</p><ul><li><strong>åœ¨è¦è¿è¡Œ <code>rsync</code> å‘½ä»¤çš„æœºå™¨ä¸Šï¼ˆä¾‹å¦‚ï¼Œä½ çš„æº NASï¼‰ç”Ÿæˆ SSH å¯†é’¥å¯¹ï¼š</strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -b 4096  <span class="comment"># ç”Ÿæˆ 4096 ä½ RSA å¯†é’¥å¯¹</span></span><br><span class="line"><span class="comment"># ä¸€è·¯å›è½¦ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®å³å¯ã€‚</span></span><br></pre></td></tr></table></figure></li><li><strong>å°†å…¬é’¥å¤åˆ¶åˆ°ç›®æ ‡ NASï¼š</strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id backupuser@192.168.1.20</span><br><span class="line"><span class="comment"># è¾“å…¥ç›®æ ‡ NAS ä¸Š backupuser çš„å¯†ç </span></span><br></pre></td></tr></table></figure>å¦‚æœ<code>ssh-copy-id</code>å‘½ä»¤ä¸å­˜åœ¨, å¯ä»¥æ‰‹åŠ¨å¤åˆ¶</li></ul>   <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> ~/.ssh/id_rsa.pub | ssh backupuser@192.168.1.20 <span class="string">&#x27;mkdir -p ~/.ssh &amp;&amp; cat &gt;&gt; ~/.ssh/authorized_keys&#x27;</span></span><br></pre></td></tr></table></figure><ul><li><strong>æµ‹è¯•å…å¯†ç ç™»å½•ï¼š</strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh backupuser@192.168.1.20</span><br></pre></td></tr></table></figure>å¦‚æœèƒ½ç›´æ¥ç™»å½•åˆ°ç›®æ ‡ NASï¼Œè€Œæ— éœ€è¾“å…¥å¯†ç ï¼Œåˆ™è¯´æ˜é…ç½®æˆåŠŸã€‚</li></ul></li><li><p><strong>æµ‹è¯• <code>rsync</code> å‘½ä»¤ (ä½¿ç”¨ <code>--dry-run</code>):</strong></p><p>åœ¨å®é™…è¿è¡Œ <code>rsync</code> ä¹‹å‰ï¼Œå¼ºçƒˆå»ºè®®ä½¿ç”¨ <code>--dry-run</code>ï¼ˆæˆ– <code>-n</code>ï¼‰é€‰é¡¹è¿›è¡Œæµ‹è¯•ï¼Œä»¥ç¡®ä¿å‘½ä»¤æŒ‰é¢„æœŸå·¥ä½œï¼Œå¹¶ä¸”ä¸ä¼šæ„å¤–åˆ é™¤æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rsync -avzhn --progress -e ssh \</span><br><span class="line">    admin@192.168.1.10:/volume1/data/ \</span><br><span class="line">    backupuser@192.168.1.20:/volume1/backups/data_backup/</span><br></pre></td></tr></table></figure><p>ä»”ç»†æ£€æŸ¥è¾“å‡ºï¼Œçœ‹çœ‹å“ªäº›æ–‡ä»¶å°†è¢«ä¼ è¾“ï¼ˆæˆ–åˆ é™¤ï¼Œå¦‚æœä½ ä½¿ç”¨äº† <code>--delete</code>ï¼‰ã€‚</p></li><li><p><strong>è¿è¡Œ <code>rsync</code> å‘½ä»¤ (è¿›è¡Œå®é™…å¤‡ä»½):</strong></p><p>ä¸€æ—¦ä½ ç¡®ä¿¡ <code>--dry-run</code> çš„è¾“å‡ºæ˜¯æ­£ç¡®çš„ï¼Œå°±å¯ä»¥å»æ‰ <code>-n</code> é€‰é¡¹ï¼Œè¿›è¡Œå®é™…çš„å¤‡ä»½ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rsync -avz --progress -e ssh \</span><br><span class="line">    admin@192.168.1.10:/volume1/data/ \</span><br><span class="line">    backupuser@192.168.1.20:/volume1/backups/data_backup/</span><br></pre></td></tr></table></figure></li></ol><p>æˆ–è€…, ä¿ç•™åˆ é™¤çš„æ–‡ä»¶ (æ¨è)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rsync -avz --progress --delete -e ssh \</span><br><span class="line">  admin@192.168.1.10:/volume1/data/ \</span><br><span class="line">  backupuser@192.168.1.20:/volume1/backups/data_backup/</span><br></pre></td></tr></table></figure></p><ol start="4"><li><strong>æ£€æŸ¥å¤‡ä»½</strong><br>åœ¨ç›®æ ‡NASæ£€æŸ¥å¤‡ä»½æ–‡ä»¶æ˜¯å¦å­˜åœ¨, æ•°æ®æ˜¯å¦å®Œæ•´</li></ol><h3 id="3-ç¼–å†™å¤‡ä»½è„šæœ¬">3. ç¼–å†™å¤‡ä»½è„šæœ¬</h3><p>ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œå¯ä»¥å°† <code>rsync</code> å‘½ä»¤æ”¾å…¥ä¸€ä¸ªè„šæœ¬ä¸­ï¼Œå¹¶ä½¿ç”¨ <code>cron</code> å®šæ—¶è¿è¡Œã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Configuration ---</span></span><br><span class="line"><span class="built_in">timeout</span>=60</span><br><span class="line">source_user=<span class="string">&quot;nas&quot;</span></span><br><span class="line">source_ip=<span class="string">&quot;192.168.10.96&quot;</span></span><br><span class="line">source_dir=<span class="string">&quot;/volume1/shared/&quot;</span></span><br><span class="line">dest_user=<span class="string">&quot;nas&quot;</span></span><br><span class="line">dest_ip=<span class="string">&quot;192.168.10.97&quot;</span></span><br><span class="line">dest_dir=<span class="string">&quot;/volume1/shared/backup/&quot;</span></span><br><span class="line"><span class="comment"># ---  DO NOT STORE PASSWORDS LIKE THIS! ---</span></span><br><span class="line">source_password=<span class="string">&quot;111&quot;</span>  <span class="comment"># TERRIBLE!  DO NOT DO THIS!</span></span><br><span class="line">dest_password=<span class="string">&quot;111&quot;</span>    <span class="comment"># TERRIBLE!  DO NOT DO THIS!</span></span><br><span class="line"><span class="comment"># ---  ----------------------------------------</span></span><br><span class="line">log_file=<span class="string">&quot;/var/log/rsync_backup.log&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Functions ---</span></span><br><span class="line"><span class="function"><span class="title">log_message</span></span>() &#123;</span><br><span class="line">    now=$(<span class="built_in">date</span> +<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$now</span> - <span class="variable">$1</span>&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$log_file</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- The rsync command ---</span></span><br><span class="line">rsync_cmd=<span class="string">&quot;rsync -avz --progress --delete -e ssh&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Main Script ---</span></span><br><span class="line">log_message <span class="string">&quot;Backup started.&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Run rsync with sshpass, using passwords on the command line.  VERY INSECURE!</span></span><br><span class="line"><span class="keyword">if</span> ! sshpass -p <span class="string">&quot;<span class="variable">$source_password</span>&quot;</span> sh -c <span class="string">&#x27;sshpass -p &quot;&#x27;</span><span class="string">&quot;<span class="variable">$dest_password</span>&quot;</span><span class="string">&#x27;&quot; &#x27;</span><span class="string">&quot;<span class="variable">$rsync_cmd</span>&quot;</span><span class="string">&#x27; &#x27;</span><span class="string">&quot;<span class="variable">$source_user</span>@<span class="variable">$source_ip</span>:<span class="variable">$source_dir</span>&quot;</span><span class="string">&#x27; &#x27;</span><span class="string">&quot;<span class="variable">$dest_user</span>@<span class="variable">$dest_ip</span>:<span class="variable">$dest_dir</span>&quot;</span> 2&gt;&amp;1 | <span class="built_in">tee</span> -a <span class="string">&quot;<span class="variable">$log_file</span>&quot;</span> ; <span class="keyword">then</span></span><br><span class="line">    log_message <span class="string">&quot;Backup failed (ssh or rsync error)!&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">log_message <span class="string">&quot;Backup successful.&quot;</span>  <span class="comment"># Only reached if the previous command succeeds</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure><p><strong>ä½¿ç”¨è„šæœ¬ï¼š</strong></p><ol><li><strong>ä¿å­˜è„šæœ¬:</strong>  å°†ä¸Šè¿°è„šæœ¬ä¿å­˜ä¸ºä¸€ä¸ªæ–‡ä»¶ï¼Œä¾‹å¦‚ <code>backup.sh</code>ã€‚</li><li><strong>èµ‹äºˆæ‰§è¡Œæƒé™:</strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x backup.sh</span><br></pre></td></tr></table></figure></li><li><strong>æµ‹è¯•è„šæœ¬:</strong>  æ‰‹åŠ¨è¿è¡Œè„šæœ¬ï¼Œç¡®ä¿å®ƒèƒ½æ­£å¸¸å·¥ä½œï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./backup.sh</span><br></pre></td></tr></table></figure></li><li><strong>è®¾ç½®å®šæ—¶ä»»åŠ¡ (ä½¿ç”¨ <code>cron</code>):</strong><ul><li>è¿è¡Œ <code>crontab -e</code> å‘½ä»¤æ¥ç¼–è¾‘ <code>crontab</code> æ–‡ä»¶ã€‚</li><li>æ·»åŠ ä¸€è¡Œæ¥æŒ‡å®šä½•æ—¶è¿è¡Œä½ çš„è„šæœ¬ã€‚ ä¾‹å¦‚ï¼Œæ¯å¤©å‡Œæ™¨ 2 ç‚¹è¿è¡Œï¼š<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 2 * * * /path/to/your/backup.sh</span><br></pre></td></tr></table></figure></li><li>ä¿å­˜å¹¶å…³é—­ <code>crontab</code> æ–‡ä»¶ã€‚</li></ul></li></ol><h2 id="å®‰è£…ç¬¬ä¸‰æ–¹åº“">å®‰è£…ç¬¬ä¸‰æ–¹åº“</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install expect</span><br></pre></td></tr></table></figure><h2 id="å…¶ä»–">å…¶ä»–</h2><ul><li>rdiff-backupï¼š</li><li>Baculaï¼š</li><li>Amandaï¼š</li><li>Duplicityï¼š</li><li>BorgBackup (Borg)ï¼š</li><li>Restic:</li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> rsync </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Samba (Linux) + Syslog + Logstash + Elasticsearch è½¬å‘smbæ—¥å¿—</title>
      <link href="/2025/03/10/smb-elk-log/"/>
      <url>/2025/03/10/smb-elk-log/</url>
      
        <content type="html"><![CDATA[<h2 id="æ–¹æ¡ˆç®€ä»‹">æ–¹æ¡ˆç®€ä»‹</h2><blockquote><p>Elasticsearch é›†ç¾¤éƒ¨ç½²: ä¸ºäº†é«˜å¯ç”¨æ€§å’Œå¯æ‰©å±•æ€§ï¼Œå¯ä»¥å°† Elasticsearch éƒ¨ç½²ä¸ºé›†ç¾¤ã€‚</p></blockquote><blockquote><p>Logstash ç®¡é“ä¼˜åŒ–: æ ¹æ®æ—¥å¿—é‡å’Œå¤æ‚åº¦ï¼Œè°ƒæ•´ Logstash çš„ worker æ•°é‡ã€æ‰¹å¤„ç†å¤§å°ç­‰å‚æ•°ã€‚</p></blockquote><blockquote><p>ç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç† (ILM): ä½¿ç”¨ ILM ç­–ç•¥è‡ªåŠ¨ç®¡ç† Elasticsearch ç´¢å¼•ï¼ˆä¾‹å¦‚ï¼Œå®šæœŸæ»šåŠ¨ã€åˆ é™¤æ—§ç´¢å¼•ï¼‰ã€‚</p></blockquote><blockquote><p>å®‰å…¨æ€§: å¯ç”¨ Elasticsearch å’Œ Kibana çš„å®‰å…¨è®¤è¯ï¼ˆç”¨æˆ·å/å¯†ç ã€TLS/SSLï¼‰ã€‚<br>ç›‘æ§: ç›‘æ§ ELK Stack çš„æ€§èƒ½å’Œå¥åº·çŠ¶æ€. å¯ä»¥ä½¿ç”¨ Elastic Stack Monitoring åŠŸèƒ½, æˆ–è€… Prometheus + Grafana.</p></blockquote><h2 id="å®‰è£…ä½¿ç”¨">å®‰è£…ä½¿ç”¨</h2><ul><li><p><strong>å®‰è£… Docker å’Œ Docker Compose:</strong></p><ul><li><p><strong>Ubuntu:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install apt-transport-https ca-certificates curl software-properties-common</span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | <span class="built_in">sudo</span> gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb [arch=<span class="subst">$(dpkg --print-architecture)</span> signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu <span class="subst">$(lsb_release -cs)</span> stable&quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install docker-ce docker-ce-cli containerd.io docker-compose-plugin</span><br></pre></td></tr></table></figure></li><li><p><strong>CentOS/RHEL:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> yum install -y yum-utils</span><br><span class="line"><span class="built_in">sudo</span> yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"><span class="built_in">sudo</span> yum install docker-ce docker-ce-cli containerd.io docker-compose-plugin</span><br></pre></td></tr></table></figure></li><li><p><strong>éªŒè¯å®‰è£…:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker --version</span><br><span class="line">docker compose version</span><br></pre></td></tr></table></figure></li></ul></li><li><p>** å¢åŠ  Docker ç”¨æˆ·åˆ° <code>docker</code> ç»„:**  é¿å…æ¯æ¬¡éƒ½ä½¿ç”¨ <code>sudo</code>.</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> usermod -aG docker <span class="variable">$USER</span></span><br><span class="line">newgrp docker <span class="comment"># æˆ–è€…æ³¨é”€å¹¶é‡æ–°ç™»å½•</span></span><br></pre></td></tr></table></figure></li><li><p><strong>åˆ›å»ºå·¥ä½œç›®å½•:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> elk-smb</span><br><span class="line"><span class="built_in">cd</span> elk-smb</span><br></pre></td></tr></table></figure></li></ul><p><strong>2. åˆ›å»º Docker Compose æ–‡ä»¶ (docker-compose.yml):</strong></p><p>åœ¨ <code>elk-smb</code> ç›®å½•ä¸‹åˆ›å»º <code>docker-compose.yml</code> æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">elasticsearch:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.elastic.co/elasticsearch/elasticsearch:8.10.4</span>  <span class="comment"># ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">elasticsearch</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">discovery.type=single-node</span>  <span class="comment"># å•èŠ‚ç‚¹æ¨¡å¼</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ES_JAVA_OPTS=-Xms1g</span> <span class="string">-Xmx1g</span>  <span class="comment"># è®¾ç½® JVM å†…å­˜ (æ ¹æ®éœ€è¦è°ƒæ•´)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.enabled=false</span> <span class="comment">#ç¦ç”¨xpack</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">esdata:/usr/share/elasticsearch/data</span>  <span class="comment"># æ•°æ®æŒä¹…åŒ–</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9200:9200&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9300:9300&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">elk</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">logstash:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.elastic.co/logstash/logstash:8.10.4</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">logstash</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logstash/pipeline/:/usr/share/logstash/pipeline/</span>  <span class="comment"># æŒ‚è½½ Logstash ç®¡é“é…ç½®</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;5044:5044&quot;</span>  <span class="comment"># Beats input</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;514:514/udp&quot;</span>  <span class="comment"># Syslog input (UDP)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;514:514/tcp&quot;</span> <span class="comment"># Syslog input (TCP)</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">LS_JAVA_OPTS:</span> <span class="string">&quot;-Xmx256m -Xms256m&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">elk</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">elasticsearch</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">kibana:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.elastic.co/kibana/kibana:8.10.4</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">kibana</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;5601:5601&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">ELASTICSEARCH_URL:</span> <span class="string">&quot;http://elasticsearch:9200&quot;</span> <span class="comment"># é€šè¿‡æœåŠ¡åè®¿é—® Elasticsearch</span></span><br><span class="line">      <span class="comment">#ELASTICSEARCH_HOSTS: &quot;http://elasticsearch:9200&quot; #8.x ä¹‹åä½¿ç”¨ ELASTICSEARCH_URL</span></span><br><span class="line">      <span class="comment"># å¦‚æœå¯ç”¨äº† Elasticsearch å®‰å…¨ç‰¹æ€§ï¼Œéœ€è¦é…ç½®ç”¨æˆ·åå’Œå¯†ç </span></span><br><span class="line">      <span class="comment">#ELASTICSEARCH_USERNAME: &quot;elastic&quot;</span></span><br><span class="line">      <span class="comment">#ELASTICSEARCH_PASSWORD: &quot;changeme&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">elk</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">elasticsearch</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">esdata:</span>  <span class="comment"># å®šä¹‰ Elasticsearch æ•°æ®å·</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">elk:</span>  <span class="comment"># å®šä¹‰ç½‘ç»œ</span></span><br></pre></td></tr></table></figure><p><strong>3. åˆ›å»º Logstash ç®¡é“é…ç½®:</strong></p><p>åœ¨ <code>elk-smb</code> ç›®å½•ä¸‹åˆ›å»º <code>logstash/pipeline</code> ç›®å½•ï¼Œå¹¶åœ¨å…¶ä¸­åˆ›å»º Logstash ç®¡é“é…ç½®æ–‡ä»¶ <code>smb-pipeline.conf</code>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"># logstash/pipeline/smb-pipeline.conf</span><br><span class="line"></span><br><span class="line">input &#123;</span><br><span class="line">  # ä» Beats æ¥æ”¶æ•°æ® (ä¾‹å¦‚ Winlogbeat)</span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; 5044</span><br><span class="line">    type =&gt; &quot;windows-eventlog&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # ä» Syslog æ¥æ”¶æ•°æ® (ä¾‹å¦‚ Samba)</span><br><span class="line">  syslog &#123;</span><br><span class="line">    port =&gt; 514</span><br><span class="line">    type =&gt; &quot;samba-syslog&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  # Windows äº‹ä»¶æ—¥å¿—å¤„ç† (ç¤ºä¾‹)</span><br><span class="line">  if [type] == &quot;windows-eventlog&quot; &#123;</span><br><span class="line">        if [event][code] == 5140 &#123;</span><br><span class="line">             xml &#123;</span><br><span class="line">                source =&gt; &quot;[event][provider_data][data]&quot;</span><br><span class="line">                target =&gt; &quot;event_data&quot;</span><br><span class="line">                xpath =&gt; [</span><br><span class="line">                    &quot;/Event/EventData/Data[@Name=&#x27;SubjectUserSid&#x27;]/text()&quot;, &quot;SubjectUserSid&quot;,</span><br><span class="line">                    &quot;/Event/EventData/Data[@Name=&#x27;SubjectUserName&#x27;]/text()&quot;, &quot;SubjectUserName&quot;,</span><br><span class="line">                    &quot;/Event/EventData/Data[@Name=&#x27;SubjectDomainName&#x27;]/text()&quot;, &quot;SubjectDomainName&quot;,</span><br><span class="line">                    &quot;/Event/EventData/Data[@Name=&#x27;SubjectLogonId&#x27;]/text()&quot;, &quot;SubjectLogonId&quot;,</span><br><span class="line">                     &quot;/Event/EventData/Data[@Name=&#x27;ShareName&#x27;]/text()&quot;, &quot;ShareName&quot;,</span><br><span class="line">                    &quot;/Event/EventData/Data[@Name=&#x27;ShareLocalPath&#x27;]/text()&quot;, &quot;ShareLocalPath&quot;,</span><br><span class="line">                    &quot;/Event/EventData/Data[@Name=&#x27;ClientAddress&#x27;]/text()&quot;, &quot;[client][ip]&quot;,  # å®¢æˆ·ç«¯ IP</span><br><span class="line">                    &quot;/Event/EventData/Data[@Name=&#x27;ClientName&#x27;]/text()&quot;,&quot;ClientName&quot;</span><br><span class="line">                   ]</span><br><span class="line">                remove_field =&gt; [&quot;[event][provider_data][data]&quot;]</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              # æå–å®¢æˆ·ç«¯ IP</span><br><span class="line">                mutate &#123;</span><br><span class="line">                  rename =&gt; &#123; &quot;[event_data][ClientAddress]&quot; =&gt; &quot;[client][ip]&quot; &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">    # ... å…¶ä»– Windows äº‹ä»¶æ—¥å¿—å¤„ç† ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # Samba æ—¥å¿—å¤„ç† (ç¤ºä¾‹)</span><br><span class="line">  if [type] == &quot;samba-syslog&quot; &#123;</span><br><span class="line">        grok &#123;</span><br><span class="line">        match =&gt; &#123; &quot;message&quot; =&gt; [</span><br><span class="line">          # åŒ¹é…å¸¸è§çš„ Samba æ—¥å¿—æ ¼å¼ (æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´)</span><br><span class="line">          &quot;%&#123;SYSLOGTIMESTAMP:syslog_timestamp&#125; %&#123;SYSLOGHOST:syslog_hostname&#125; smbd\[%&#123;POSINT:pid&#125;\]: \[%&#123;YEAR:year&#125;/%&#123;MONTHNUM:month&#125;/%&#123;MONTHDAY:day&#125; %&#123;TIME:time&#125;\] %&#123;WORD:smb_client&#125; \(%&#123;IPORHOST:client_ip&#125;\) %&#123;WORD:smb_action&#125; %&#123;GREEDYDATA:smb_path&#125;&quot;,</span><br><span class="line">          # å¦ä¸€ç§å¸¸è§çš„æ ¼å¼</span><br><span class="line">          &quot;%&#123;SYSLOGTIMESTAMP:syslog_timestamp&#125; %&#123;SYSLOGHOST:syslog_hostname&#125; smbd_audit: %&#123;USER:username&#125;\|%&#123;IP:client_ip&#125;\|%&#123;HOSTNAME:client_hostname&#125;\|%&#123;GREEDYDATA:share_name&#125;\|%&#123;WORD:operation&#125;\|%&#123;GREEDYDATA:file_path&#125;&quot;,</span><br><span class="line">          # æ›´å¤šåŒ¹é…è§„åˆ™...</span><br><span class="line">          &quot;%&#123;GREEDYDATA:message&#125;&quot; # æœ€åçš„åŒ¹é…è§„åˆ™æ•è·æ‰€æœ‰å†…å®¹</span><br><span class="line">         ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">       mutate &#123;</span><br><span class="line">         add_field =&gt; &#123; &quot;[client][ip]&quot; =&gt; &quot;%&#123;client_ip&#125;&quot; &#125;</span><br><span class="line">         remove_field =&gt; [ &quot;client_ip&quot; ]</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      date &#123;</span><br><span class="line">        match =&gt; [ &quot;syslog_timestamp&quot;, &quot;MMM  d HH:mm:ss&quot;, &quot;MMM dd HH:mm:ss&quot;, &quot;ISO8601&quot; ]</span><br><span class="line">        target =&gt; &quot;@timestamp&quot;</span><br><span class="line">        remove_field =&gt; [&quot;syslog_timestamp&quot;]</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [&quot;http://elasticsearch:9200&quot;] # ä½¿ç”¨æœåŠ¡åè®¿é—® Elasticsearch</span><br><span class="line">    index =&gt; &quot;smb-audit-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">     #user =&gt; &quot;elastic&quot;  # å¦‚æœå¯ç”¨äº†å®‰å…¨è®¤è¯</span><br><span class="line">     #password =&gt; &quot;changeme&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  stdout &#123; codec =&gt; rubydebug &#125; # ç”¨äºè°ƒè¯•</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¯´æ˜:</strong></p><ul><li>è¿™ä¸ªé…ç½®æ–‡ä»¶åŒæ—¶å¤„ç†æ¥è‡ª Beats (Windows Event Log) å’Œ Syslog (Samba) çš„è¾“å…¥.</li><li>Windows éƒ¨åˆ†, ä½¿ç”¨ <code>xml</code> æ’ä»¶è§£æäº‹ä»¶æ—¥å¿—çš„ XML æ•°æ®.</li><li>Samba éƒ¨åˆ†, ä½¿ç”¨ <code>grok</code> æ’ä»¶è§£ææ—¥å¿—.  ä½ éœ€è¦æ ¹æ®å®é™…çš„ Samba æ—¥å¿—æ ¼å¼è°ƒæ•´ <code>grok</code> è¡¨è¾¾å¼.</li><li><code>mutate</code> ç”¨äºé‡å‘½åå­—æ®µ, æ·»åŠ å­—æ®µç­‰.</li><li><code>date</code> ç”¨äºè§£ææ—¶é—´æˆ³.</li></ul><ul><li>ä»£ç†æœåŠ¡å™¨æŸ¥è¯¢</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">systemctl show --property=Environment docker</span><br><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload</span><br><span class="line"><span class="built_in">sudo</span> systemctl restart docker</span><br><span class="line"><span class="comment"># docker config æ–‡ä»¶ç›®å½•</span></span><br><span class="line">/etc/systemd/system/docker.service.d/</span><br><span class="line">/etc/default/docker</span><br><span class="line">/etc/sysconfig/docker</span><br></pre></td></tr></table></figure><p><strong>4. å¯åŠ¨ ELK Stack:</strong></p><p>åœ¨ <code>elk-smb</code> ç›®å½•ä¸‹ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker compose up -d</span></span><br><span class="line"><span class="built_in">sudo</span> docker-compose up -d </span><br></pre></td></tr></table></figure><p>è¿™å°†å¯åŠ¨ Elasticsearchã€Logstash å’Œ Kibana å®¹å™¨ã€‚<code>-d</code> é€‰é¡¹è¡¨ç¤ºåœ¨åå°è¿è¡Œã€‚</p><p><strong>5. éªŒè¯å®‰è£…:</strong></p><ul><li><p><strong>Elasticsearch:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9200</span><br></pre></td></tr></table></figure></li></ul><ul><li>è¿”å›ç»“æœ</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span> : <span class="string">&quot;800c9626c439&quot;</span>,</span><br><span class="line">  <span class="string">&quot;cluster_name&quot;</span> : <span class="string">&quot;docker-cluster&quot;</span>,</span><br><span class="line">  <span class="string">&quot;cluster_uuid&quot;</span> : <span class="string">&quot;2MXalfBNSGGwktsjV8R-eQ&quot;</span>,</span><br><span class="line">  <span class="string">&quot;version&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;number&quot;</span> : <span class="string">&quot;8.10.4&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_flavor&quot;</span> : <span class="string">&quot;default&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_type&quot;</span> : <span class="string">&quot;docker&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_hash&quot;</span> : <span class="string">&quot;b4a62ac808e886ff032700c391f45f1408b2538c&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_date&quot;</span> : <span class="string">&quot;2023-10-11T22:04:35.506990650Z&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_snapshot&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;lucene_version&quot;</span> : <span class="string">&quot;9.7.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;minimum_wire_compatibility_version&quot;</span> : <span class="string">&quot;7.17.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;minimum_index_compatibility_version&quot;</span> : <span class="string">&quot;7.0.0&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;tagline&quot;</span> : <span class="string">&quot;You Know, for Search&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><pre><code>åº”è¯¥ä¼šçœ‹åˆ° JSON å“åº”ï¼Œè¡¨æ˜ Elasticsearch æ­£åœ¨è¿è¡Œã€‚</code></pre><ul><li><p><strong>Kibana:</strong></p><p>åœ¨æµè§ˆå™¨ä¸­è®¿é—® <code>http://localhost:5601</code>ï¼Œåº”è¯¥èƒ½çœ‹åˆ° Kibana çš„ç•Œé¢ã€‚</p></li><li><p><strong>Logstash:</strong><br>Logstash å¯åŠ¨åä¼šç›‘å¬ 5044 (Beats) å’Œ 514 (Syslog) ç«¯å£. å¯ä»¥é€šè¿‡æŸ¥çœ‹ Logstash çš„æ—¥å¿—æ¥ç¡®è®¤:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs logstash</span><br></pre></td></tr></table></figure></li></ul><p><strong>6. é…ç½®æ•°æ®æº (Samba å’Œ Windows):</strong></p><ul><li><p><strong>Samba (Linux):</strong></p><ol><li>é…ç½® Samba (<code>/etc/samba/smb.conf</code>) ä»¥å°†æ—¥å¿—å‘é€åˆ° Syslogï¼ˆå¦‚å‰æ‰€è¿°ï¼‰ï¼š<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[global]</span></span><br><span class="line">   log <span class="attr">level</span> = <span class="number">3</span></span><br><span class="line">   syslog <span class="attr">only</span> = <span class="literal">yes</span></span><br><span class="line">   <span class="attr">syslog</span> = <span class="number">3</span></span><br></pre></td></tr></table></figure></li><li>é…ç½® rsyslog æˆ– syslog-ng å°† Samba çš„æ—¥å¿—è½¬å‘åˆ° Logstash å®¹å™¨çš„ IP åœ°å€å’Œç«¯å£ 514ã€‚ (å¦‚æœ Logstash å’Œ Samba åœ¨åŒä¸€å°æœºå™¨, å¯ä»¥ç”¨ <code>127.0.0.1</code>, å¦åˆ™ç”¨ Logstash æ‰€åœ¨æœºå™¨çš„ IP).  rsyslog é…ç½®ç¤ºä¾‹ (<code>/etc/rsyslog.conf</code> æˆ– <code>/etc/rsyslog.d/50-default.conf</code>):<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">local7.* @&lt;Logstash å®¹å™¨ IP&gt;:514  # UDP</span><br></pre></td></tr></table></figure></li><li>é‡å¯ Samba å’Œ rsyslogï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl restart smbd</span><br><span class="line"><span class="built_in">sudo</span> systemctl restart rsyslog</span><br></pre></td></tr></table></figure></li></ol></li><li><p><strong>Windows Server:</strong></p><ol><li>é…ç½® Windows å®¡æ ¸ç­–ç•¥ï¼ˆå¦‚å‰æ‰€è¿°ï¼‰ã€‚</li><li>å®‰è£…å’Œé…ç½® Winlogbeatï¼ˆå¦‚å‰æ‰€è¿°ï¼‰ï¼Œå°† <code>output.logstash.hosts</code> è®¾ç½®ä¸º Logstash å®¹å™¨çš„ IP åœ°å€å’Œç«¯å£ 5044ã€‚  Winlogbeat é…ç½®ç¤ºä¾‹ (<code>winlogbeat.yml</code>):</li></ol>   <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">output.logstash:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;&lt;Logstash å®¹å™¨ IP&gt;:5044&quot;</span>]</span><br></pre></td></tr></table></figure><ul><li>è·å– Logstash å®¹å™¨çš„ IP: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect -f &#x27;&#123;&#123;range.NetworkSettings.Networks&#125;&#125;&#123;&#123;.IPAddress&#125;&#125;&#123;&#123;end&#125;&#125;&#x27; logstash</span><br></pre></td></tr></table></figure></li></ul><ol start="3"><li>å¯åŠ¨ Winlogbeat æœåŠ¡ã€‚</li></ol></li></ul><p><strong>7. åœ¨ Kibana ä¸­æŸ¥çœ‹æ—¥å¿—:</strong></p><ol><li><p>åœ¨ Kibana ä¸­åˆ›å»º Index Pattern (ç´¢å¼•æ¨¡å¼)ï¼š</p><ul><li>é¦–æ¬¡è®¿é—® Kibana æ—¶ï¼Œå®ƒä¼šæç¤ºæ‚¨åˆ›å»º Index Patternã€‚</li><li>åœ¨ Management -&gt; Stack Management -&gt; Index Patterns ä¸­åˆ›å»ºã€‚</li><li>Index Pattern åç§°ï¼š<code>smb-audit-*</code> (ä¸ Logstash é…ç½®ä¸­çš„ <code>index</code> åŒ¹é…)ã€‚</li><li>æ—¶é—´ç­›é€‰å­—æ®µï¼š<code>@timestamp</code></li></ul></li><li><p>åœ¨ Discover ä¸­æŸ¥çœ‹æ—¥å¿—ï¼š</p><ul><li>é€‰æ‹© <code>smb-audit-*</code> ç´¢å¼•æ¨¡å¼ã€‚</li><li>è®¾ç½®æ—¶é—´èŒƒå›´ã€‚</li><li>æ‚¨åº”è¯¥èƒ½çœ‹åˆ°æ¥è‡ª Samba å’Œ Windows çš„ SMB è®¿é—®æ—¥å¿—ã€‚</li></ul></li></ol><p><strong>8. åœæ­¢å’Œåˆ é™¤å®¹å™¨:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker compose down</span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python_spider_introduce</title>
      <link href="/2025/03/04/python-spider-introduce/"/>
      <url>/2025/03/04/python-spider-introduce/</url>
      
        <content type="html"><![CDATA[<h1>Python æ•°æ®é‡‡é›†æŠ€æœ¯åŠåº”ç”¨åœºæ™¯</h1><p><strong>æ¦‚è¦ï¼š</strong></p><p>å¸¸ç”¨ Python æ•°æ®é‡‡é›†æŠ€æœ¯åŠåº”ç”¨åœºæ™¯çš„æ€»ç»“ã€‚</p><p><strong>å¸¸ç”¨çˆ¬è™«ç¼–ç¨‹è¯­è¨€å’ŒæŠ€æœ¯æ¡†æ¶ï¼š</strong></p><ul><li><strong>Python:</strong> Scrapy, Beautiful Soup, Requests, Selenium</li><li><strong>Java:</strong> Jsoup, HttpClient, WebMagic</li><li><strong>Node.js:</strong> Cheerio, Puppeteer, Axios</li></ul><p><strong>å¸¸ç”¨æŠ€æœ¯ï¼š</strong></p><ul><li><strong>ç½‘ç»œè¯·æ±‚:</strong> requests, urllib</li><li><strong>HTML/XML è§£æ:</strong> Beautiful Soup, lxml, Scrapy</li><li><strong>åŠ¨æ€ç½‘é¡µçˆ¬å–:</strong> Selenium, Playwright</li><li><strong>API æ¥å£è°ƒç”¨:</strong> requests, å„ç±» API å®¢æˆ·ç«¯åº“</li><li><strong>æ•°æ®åº“æ“ä½œ:</strong> sqlite3, pymysql, psycopg2, mongoengine ç­‰</li><li><strong>å¤šåª’ä½“å¤„ç†:</strong> PIL/Pillow (å›¾ç‰‡), Librosa (éŸ³é¢‘), OpenCV (å›¾ç‰‡/è§†é¢‘), moviepy (è§†é¢‘)</li></ul><h2 id="1-æ–‡å­—æ•°æ®é‡‡é›†">1. æ–‡å­—æ•°æ®é‡‡é›†</h2><p><strong>ç½‘é¡µçˆ¬è™«:</strong></p><ul><li><strong>requests + Beautiful Soup / lxml:</strong> ç»å…¸ç»„åˆï¼Œé€‚ç”¨äºé™æ€ç½‘é¡µæŠ“å–ã€‚</li><li><strong>Scrapy:</strong> é«˜çº§çˆ¬è™«æ¡†æ¶ï¼Œé€‚ç”¨äºå¤§è§„æ¨¡ã€ç»“æ„åŒ–çš„ç½‘é¡µæ•°æ®é‡‡é›†ã€‚</li><li><strong>Selenium / Playwright:</strong> æ¨¡æ‹Ÿæµè§ˆå™¨è¡Œä¸ºï¼Œå¤„ç† JavaScript åŠ¨æ€åŠ è½½å†…å®¹ã€‚</li></ul><p><strong>API æ¥å£è°ƒç”¨:</strong></p><ul><li><strong>requests:</strong> å‘é€ HTTP è¯·æ±‚ï¼Œè·å– JSON æˆ– XML æ ¼å¼çš„æ–‡æœ¬æ•°æ®ã€‚</li></ul><p><strong>æ–‡ä»¶è¯»å–:</strong></p><ul><li>Python å†…ç½®æ–‡ä»¶æ“ä½œå‡½æ•° (open(), read(), readlines(), csv, json æ¨¡å—ç­‰)ã€‚</li><li><strong>pandas åº“:</strong> é«˜æ•ˆå¤„ç† CSV, Excel ç­‰è¡¨æ ¼æ•°æ®ã€‚</li></ul><p><strong>æ•°æ®åº“æ“ä½œ:</strong></p><ul><li><strong>sqlite3:</strong> (SQLite æ•°æ®åº“)ã€‚</li><li><strong>pymysql, psycopg2:</strong> (MySQL, PostgreSQL æ•°æ®åº“)ã€‚</li><li><strong>mongoengine, pymongo:</strong> (MongoDB æ•°æ®åº“)ã€‚</li></ul><p><strong>OCR:</strong></p><ul><li><strong>pytesseract:</strong> (å°è£… Tesseract OCR å¼•æ“)ã€‚</li><li><strong>äº‘ç«¯ OCR API:</strong> (å¦‚ç™¾åº¦ OCR, è…¾è®¯äº‘ OCR ç­‰)ã€‚</li></ul><h2 id="2-å›¾ç‰‡æ•°æ®é‡‡é›†">2. å›¾ç‰‡æ•°æ®é‡‡é›†</h2><p><strong>æŠ€æœ¯:</strong></p><ul><li><strong>requests + Beautiful Soup:</strong> é€‚ç”¨äºé™æ€ç½‘é¡µçš„å›¾ç‰‡é“¾æ¥æŠ“å–ã€‚<code>requests</code> ç”¨äºå‘èµ· HTTP è¯·æ±‚ï¼Œ<code>Beautiful Soup</code> ç”¨äºè§£æ HTMLï¼Œæå–å›¾ç‰‡ URLã€‚</li><li><strong>Scrapy:</strong> æ›´å¼ºå¤§çš„çˆ¬è™«æ¡†æ¶ï¼Œé€‚ç”¨äºå¤§è§„æ¨¡å›¾ç‰‡é‡‡é›†ï¼Œæ”¯æŒå¼‚æ­¥å¤„ç†ã€è‡ªå®šä¹‰ä¸­é—´ä»¶ç­‰ã€‚</li><li><strong>Selenium:</strong> æ¨¡æ‹Ÿæµè§ˆå™¨è¡Œä¸ºï¼Œé€‚ç”¨äºåŠ¨æ€åŠ è½½çš„ç½‘é¡µï¼ˆå¦‚ JavaScript æ¸²æŸ“çš„å›¾ç‰‡ï¼‰ã€‚</li></ul><p><strong>API æ¥å£:</strong></p><ul><li>è®¸å¤šç½‘ç«™å’Œå¹³å°æä¾› API æ¥å£ï¼Œå¯ä»¥ç›´æ¥è·å–å›¾ç‰‡æ•°æ®ï¼Œå¦‚ Google Images API, Flickr API, Instagram API ç­‰ã€‚ä½¿ç”¨ <code>requests</code> åº“æˆ–å…¶ä»– HTTP å®¢æˆ·ç«¯åº“è°ƒç”¨ APIã€‚</li></ul><p><strong>å›¾åƒå¤„ç†åº“:</strong></p><ul><li><strong>PIL (Pillow):</strong> ç”¨äºæ‰“å¼€ã€æ“ä½œå’Œä¿å­˜å„ç§å›¾åƒæ–‡ä»¶æ ¼å¼ã€‚å¯ä»¥ç”¨äºå›¾ç‰‡é¢„å¤„ç†ã€æ ¼å¼è½¬æ¢ç­‰ã€‚</li><li><strong>OpenCV:</strong> æ›´å¼ºå¤§çš„è®¡ç®—æœºè§†è§‰åº“ï¼Œç”¨äºå›¾åƒåˆ†æã€ç‰¹å¾æå–ã€ç›®æ ‡æ£€æµ‹ç­‰ã€‚</li></ul><p><strong>OCRï¼ˆå…‰å­¦å­—ç¬¦è¯†åˆ«ï¼‰:</strong></p><ul><li><strong>Tesseract:</strong> å¼€æº OCR å¼•æ“ï¼Œå¯ä»¥å°†å›¾ç‰‡ä¸­çš„æ–‡å­—è½¬æ¢ä¸ºæ–‡æœ¬ã€‚</li><li><strong>pytesseract:</strong> Python å°è£…çš„ Tesseract åº“ï¼Œæ–¹ä¾¿ä½¿ç”¨ã€‚</li></ul><p><strong>åº”ç”¨åœºæ™¯:</strong></p><ul><li><strong>ç”µå•†ç½‘ç«™å•†å“å›¾ç‰‡é‡‡é›†:</strong> æŠ“å–å•†å“å›¾ç‰‡ï¼Œç”¨äºå»ºç«‹å•†å“å›¾åº“ã€æ¯”ä»·ã€æ•°æ®åˆ†æç­‰ã€‚</li><li><strong>ç¤¾äº¤åª’ä½“å›¾ç‰‡é‡‡é›†:</strong> æŠ“å–ç”¨æˆ·å¤´åƒã€ç…§ç‰‡å¢™ç­‰ï¼Œç”¨äºç”¨æˆ·è¡Œä¸ºåˆ†æã€å†…å®¹æ¨èç­‰ã€‚</li><li><strong>æ–°é—»ç½‘ç«™å›¾ç‰‡é‡‡é›†:</strong> æŠ“å–æ–°é—»é…å›¾ï¼Œç”¨äºæ–°é—»èšåˆã€å†…å®¹åˆ†æç­‰ã€‚</li><li><strong>æœç´¢å¼•æ“å›¾ç‰‡ç´¢å¼•:</strong> æŠ“å–ç½‘é¡µå›¾ç‰‡ï¼Œå»ºç«‹å›¾ç‰‡ç´¢å¼•ï¼Œæä¾›å›¾ç‰‡æœç´¢æœåŠ¡ã€‚</li><li><strong>åŒ»å­¦å½±åƒåˆ†æ:</strong> é‡‡é›†åŒ»å­¦å½±åƒæ•°æ®ï¼ˆå¦‚ X å…‰ç‰‡ã€CT æ‰«æç­‰ï¼‰ï¼Œç”¨äºç–¾ç—…è¯Šæ–­ã€è¾…åŠ©æ²»ç–—ç­‰ã€‚</li><li><strong>é¥æ„Ÿå›¾åƒåˆ†æ:</strong> é‡‡é›†å«æ˜Ÿé¥æ„Ÿå›¾åƒï¼Œç”¨äºåœŸåœ°åˆ©ç”¨åˆ†æã€ç¯å¢ƒç›‘æµ‹ã€ç¾å®³è¯„ä¼°ç­‰ã€‚</li><li><strong>è‰ºæœ¯å“å›¾åƒé‡‡é›†:</strong> é‡‡é›†è‰ºæœ¯å“å›¾ç‰‡ï¼Œç”¨äºå»ºç«‹æ•°å­—åšç‰©é¦†ã€è‰ºæœ¯å“é‰´å®šç­‰ã€‚</li><li><strong>æ–‡æ¡£æ•°å­—åŒ–:</strong> å°†çº¸è´¨æ–‡æ¡£æ‰«ææˆ–æ‹ç…§ï¼Œé€šè¿‡ OCR æŠ€æœ¯è½¬æ¢ä¸ºç”µå­æ–‡æœ¬ã€‚</li><li><strong>éªŒè¯ç è¯†åˆ«:</strong> é‡‡é›†ç½‘ç«™éªŒè¯ç å›¾ç‰‡ï¼Œä½¿ç”¨ OCR æˆ–æ·±åº¦å­¦ä¹ æ¨¡å‹è¿›è¡Œè¯†åˆ«ã€‚</li></ul><h2 id="3-éŸ³é¢‘æ•°æ®é‡‡é›†">3. éŸ³é¢‘æ•°æ®é‡‡é›†</h2><p><strong>æŠ€æœ¯:</strong></p><p><strong>éº¦å…‹é£å½•éŸ³:</strong></p><ul><li><strong>PyAudio:</strong> Python åº“ï¼Œç”¨äºä»éº¦å…‹é£æˆ–å…¶ä»–éŸ³é¢‘è¾“å…¥è®¾å¤‡å½•åˆ¶éŸ³é¢‘ã€‚</li><li><strong>sounddevice:</strong> è·¨å¹³å°éŸ³é¢‘ I/O åº“ï¼Œæ”¯æŒå½•éŸ³å’Œæ’­æ”¾ã€‚</li></ul><p><strong>ç½‘ç»œéŸ³é¢‘æµ:</strong></p><ul><li><strong>requests:</strong> å¯ä»¥ç”¨äºä¸‹è½½åœ¨çº¿éŸ³é¢‘æ–‡ä»¶ï¼ˆå¦‚ MP3ã€WAV ç­‰ï¼‰ã€‚</li><li><strong>youtube-dl:</strong> å‘½ä»¤è¡Œå·¥å…·ï¼Œå¯ä»¥ä¸‹è½½ YouTube ç­‰è§†é¢‘ç½‘ç«™çš„éŸ³é¢‘ã€‚</li><li><strong>æµåª’ä½“åè®®åº“:</strong> å¦‚ <code>rtsp-lib</code>ï¼Œç”¨äºå¤„ç†å®æ—¶æµåª’ä½“åè®®ï¼ˆå¦‚ RTSPï¼‰çš„éŸ³é¢‘æµã€‚</li></ul><p><strong>API æ¥å£:</strong></p><ul><li>ä¸€äº›éŸ³é¢‘å¹³å°ï¼ˆå¦‚ Spotifyã€SoundCloudï¼‰æä¾› APIï¼Œå¯ä»¥è·å–éŸ³é¢‘æ•°æ®ã€‚</li></ul><p><strong>éŸ³é¢‘å¤„ç†åº“:</strong></p><ul><li><strong>Librosa:</strong> ç”¨äºéŸ³é¢‘å’ŒéŸ³ä¹åˆ†æçš„ Python åº“ï¼Œæä¾›ç‰¹å¾æå–ã€èŠ‚å¥åˆ†æç­‰åŠŸèƒ½ã€‚</li><li><strong>pydub:</strong> ç”¨äºéŸ³é¢‘å¤„ç†ï¼Œå¦‚å‰ªè¾‘ã€åˆå¹¶ã€æ ¼å¼è½¬æ¢ç­‰ã€‚</li></ul><p><strong>åº”ç”¨åœºæ™¯:</strong></p><ul><li><strong>è¯­éŸ³è¯†åˆ«:</strong> é‡‡é›†è¯­éŸ³æ•°æ®ï¼Œç”¨äºè¯­éŸ³è¯†åˆ«ç³»ç»Ÿè®­ç»ƒã€è¯­éŸ³åŠ©æ‰‹å¼€å‘ç­‰ã€‚</li><li><strong>éŸ³ä¹ä¿¡æ¯æ£€ç´¢:</strong> é‡‡é›†éŸ³ä¹æ•°æ®ï¼Œç”¨äºéŸ³ä¹è¯†åˆ«ã€éŸ³ä¹æ¨èã€éŸ³ä¹åˆ†ç±»ç­‰ã€‚</li><li><strong>ç¯å¢ƒå£°éŸ³ç›‘æµ‹:</strong> é‡‡é›†ç¯å¢ƒå£°éŸ³æ•°æ®ï¼Œç”¨äºå™ªå£°æ±¡æŸ“ç›‘æµ‹ã€å®‰å…¨ç›‘æ§ç­‰ã€‚</li></ul><h2 id="4-è§†é¢‘æ•°æ®é‡‡é›†">4. è§†é¢‘æ•°æ®é‡‡é›†</h2><p><strong>æŠ€æœ¯:</strong></p><p><strong>ç½‘ç»œè§†é¢‘ä¸‹è½½:</strong></p><ul><li><strong>requests:</strong> å¯ä»¥ç”¨äºä¸‹è½½é™æ€è§†é¢‘æ–‡ä»¶ã€‚</li><li><strong>youtube-dl:</strong> å¯ä»¥ä¸‹è½½ YouTube ç­‰è§†é¢‘ç½‘ç«™çš„è§†é¢‘ã€‚</li><li><strong>you-get:</strong> å¦ä¸€ä¸ªæµè¡Œçš„è§†é¢‘ä¸‹è½½å·¥å…·ï¼Œæ”¯æŒå¤šä¸ªè§†é¢‘ç½‘ç«™ã€‚</li><li><strong>æµåª’ä½“åè®®åº“:</strong> å¦‚ <code>rtsp-lib</code>ï¼Œç”¨äºå¤„ç†å®æ—¶æµåª’ä½“åè®®ï¼ˆå¦‚ RTSPï¼‰çš„è§†é¢‘æµã€‚</li></ul><p><strong>API æ¥å£:</strong></p><ul><li>ä¸€äº›è§†é¢‘å¹³å°ï¼ˆå¦‚ YouTubeã€Vimeoï¼‰æä¾› APIï¼Œå¯ä»¥è·å–è§†é¢‘æ•°æ®ã€‚</li></ul><p><strong>è§†é¢‘å¤„ç†åº“:</strong></p><ul><li><strong>OpenCV:</strong> ç”¨äºè§†é¢‘åˆ†æã€å¤„ç†ã€ç›®æ ‡è·Ÿè¸ªã€è¡Œä¸ºè¯†åˆ«ç­‰ã€‚</li><li><strong>MoviePy:</strong> ç”¨äºè§†é¢‘ç¼–è¾‘ã€å‰ªè¾‘ã€åˆæˆç­‰ã€‚</li></ul><h2 id="å‚è€ƒï¼š">å‚è€ƒï¼š</h2><ol><li><a href="https://github.com/Pierian-Data/Beautiful-Soup-and-Requests">https://github.com/Pierian-Data/Beautiful-Soup-and-Requests</a></li><li><a href="https://github.com/aditya-sengupta/Web-Scraping-with-Python">https://github.com/aditya-sengupta/Web-Scraping-with-Python</a></li><li><a href="https://github.com/Jack-Cherish/Python-Crawler-Tutorial">https://github.com/Jack-Cherish/Python-Crawler-Tutorial</a></li></ol><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pythonæ‰¹é‡å†™å…¥å›¾ç‰‡åˆ°excelä¸­</title>
      <link href="/2025/02/28/py-gen-excel/"/>
      <url>/2025/02/28/py-gen-excel/</url>
      
        <content type="html"><![CDATA[<h1>pythonæ‰¹é‡å†™å…¥å›¾ç‰‡åˆ°excelä¸­</h1><h2 id="æŠ€æœ¯">æŠ€æœ¯</h2><p><strong>1. pandas</strong></p><ul><li><p><strong>ç”¨é€”ï¼š</strong></p><ul><li>æ•°æ®åˆ†æå’Œå¤„ç†çš„æ ¸å¿ƒåº“ï¼Œç‰¹åˆ«æ˜¯å¤„ç†è¡¨æ ¼å‹æ•°æ®ã€‚</li><li>æä¾›é«˜æ•ˆã€çµæ´»çš„æ•°æ®ç»“æ„ï¼Œä¾‹å¦‚ <code>Series</code> (ä¸€ç»´æ•°æ®) å’Œ <code>DataFrame</code> (äºŒç»´è¡¨æ ¼æ•°æ®)ã€‚</li><li>æ”¯æŒæ•°æ®çš„è¯»å–ã€å†™å…¥ã€æ¸…æ´—ã€è½¬æ¢ã€èšåˆã€åˆå¹¶ç­‰æ“ä½œã€‚</li><li>å¹¿æ³›åº”ç”¨äºæ•°æ®ç§‘å­¦ã€é‡‘èåˆ†æã€ç»Ÿè®¡åˆ†æã€æœºå™¨å­¦ä¹ ç­‰é¢†åŸŸã€‚</li></ul></li><li><p><strong>ç‰¹ç‚¹ï¼š</strong></p><ul><li><strong>DataFrame:</strong>  ç±»ä¼¼ç”µå­è¡¨æ ¼çš„ç»“æ„ï¼Œå¯ä»¥å­˜å‚¨å„ç§æ•°æ®ç±»å‹ (æ•°å€¼ã€å­—ç¬¦ä¸²ã€æ—¥æœŸç­‰)ã€‚</li><li><strong>Series:</strong>  å¸¦æœ‰æ ‡ç­¾ (ç´¢å¼•) çš„ä¸€ç»´æ•°ç»„ï¼Œå¯ä»¥çœ‹ä½œ DataFrame çš„ä¸€åˆ—ã€‚</li><li><strong>æ•°æ®å¯¹é½:</strong>  pandas è‡ªåŠ¨æ ¹æ®ç´¢å¼•è¿›è¡Œæ•°æ®å¯¹é½ï¼Œå¤„ç†ç¼ºå¤±å€¼ã€‚</li><li><strong>çµæ´»çš„ç´¢å¼•å’Œé€‰æ‹©:</strong>  æ–¹ä¾¿æ ¹æ®æ ‡ç­¾æˆ–ä½ç½®é€‰æ‹©æ•°æ®ã€‚</li><li><strong>åˆ†ç»„å’Œèšåˆ:</strong>  å¯ä»¥è½»æ¾åœ°å¯¹æ•°æ®è¿›è¡Œåˆ†ç»„ (groupby) å¹¶è¿›è¡Œèšåˆè®¡ç®— (sum, mean, count ç­‰)ã€‚</li><li><strong>åˆå¹¶å’Œè¿æ¥:</strong>  æ”¯æŒå„ç§æ•°æ®åˆå¹¶ (merge) å’Œè¿æ¥ (join) æ“ä½œã€‚</li><li><strong>æ—¶é—´åºåˆ—å¤„ç†:</strong>  ä¸“é—¨ç”¨äºå¤„ç†æ—¶é—´åºåˆ—æ•°æ®çš„åŠŸèƒ½ã€‚</li><li><strong>æ–‡ä»¶ I/O:</strong>  å¯ä»¥è¯»å–å’Œå†™å…¥å¤šç§æ ¼å¼çš„æ–‡ä»¶ï¼Œä¾‹å¦‚ CSV, Excel, SQL æ•°æ®åº“ç­‰ã€‚</li><li><strong>æ€§èƒ½ä¼˜åŒ–:</strong>  åŸºäº NumPy æ„å»ºï¼Œæ€§èƒ½è¾ƒé«˜ã€‚</li></ul><p><strong>2. Pillow</strong></p></li><li><p><strong>ç”¨é€”:</strong></p><ul><li>å›¾åƒå¤„ç†åº“ï¼Œæ˜¯ Python Imaging Library (PIL) çš„ä¸€ä¸ªåˆ†æ”¯ã€‚</li><li>æä¾›å›¾åƒçš„æ‰“å¼€ã€ä¿å­˜ã€ä¿®æ”¹ã€åˆ›å»ºç­‰åŠŸèƒ½ã€‚</li><li>æ”¯æŒå¤šç§å›¾åƒæ ¼å¼ï¼Œä¾‹å¦‚ JPEG, PNG, GIF, TIFF, BMP ç­‰ã€‚</li><li>å¹¿æ³›åº”ç”¨äºå›¾åƒç¼–è¾‘ã€å›¾åƒåˆ†æã€è®¡ç®—æœºè§†è§‰ç­‰é¢†åŸŸã€‚</li></ul></li><li><p><strong>ç‰¹ç‚¹:</strong></p><ul><li><strong>å›¾åƒæ ¼å¼æ”¯æŒ:</strong>  æ”¯æŒå¤šç§å›¾åƒæ ¼å¼çš„è¯»å–å’Œå†™å…¥ã€‚</li><li><strong>å›¾åƒå¤„ç†æ“ä½œ:</strong>  æä¾›ä¸°å¯Œçš„å›¾åƒå¤„ç†æ“ä½œï¼Œä¾‹å¦‚è°ƒæ•´å¤§å°ã€è£å‰ªã€æ—‹è½¬ã€é¢œè‰²è½¬æ¢ã€æ»¤æ³¢ç­‰ã€‚</li><li><strong>ç»˜å›¾åŠŸèƒ½:</strong>  å¯ä»¥åœ¨å›¾åƒä¸Šç»˜åˆ¶çº¿æ¡ã€å½¢çŠ¶ã€æ–‡æœ¬ç­‰ã€‚</li><li><strong>å›¾åƒåºåˆ—å¤„ç†:</strong>  å¯ä»¥å¤„ç†åŠ¨ç”» GIF å’Œå¤šé¡µ TIFF æ–‡ä»¶ã€‚</li><li><strong>æ˜“äºä½¿ç”¨:</strong>  API è®¾è®¡ç®€æ´æ˜“æ‡‚ã€‚</li></ul><p><strong>3. openpyxl</strong></p></li><li><p><strong>ç”¨é€”:</strong></p><ul><li>ç”¨äºè¯»å†™ Excel (<code>.xlsx</code>) æ–‡ä»¶çš„åº“ã€‚</li><li>å¯ä»¥åˆ›å»ºã€ä¿®æ”¹ã€è¯»å– Excel æ–‡ä»¶ä¸­çš„å·¥ä½œç°¿ã€å·¥ä½œè¡¨ã€å•å…ƒæ ¼ã€æ ·å¼ç­‰ã€‚</li><li>å¹¿æ³›åº”ç”¨äºæ•°æ®æŠ¥è¡¨ç”Ÿæˆã€æ•°æ®å¯¼å‡ºã€è‡ªåŠ¨åŒ– Excel å¤„ç†ç­‰é¢†åŸŸã€‚</li></ul></li><li><p><strong>ç‰¹ç‚¹:</strong></p><ul><li><strong>æ”¯æŒ Excel æ–‡ä»¶æ ¼å¼:</strong>  å®Œå…¨æ”¯æŒ Excel 2010 åŠæ›´é«˜ç‰ˆæœ¬çš„ <code>.xlsx</code> æ–‡ä»¶æ ¼å¼ã€‚</li><li><strong>å•å…ƒæ ¼æ“ä½œ:</strong>  å¯ä»¥è¯»å†™å•å…ƒæ ¼çš„å€¼ã€æ ¼å¼ã€å…¬å¼ç­‰ã€‚</li><li><strong>å·¥ä½œè¡¨æ“ä½œ:</strong>  å¯ä»¥åˆ›å»ºã€åˆ é™¤ã€é‡å‘½åå·¥ä½œè¡¨ï¼Œè®¾ç½®å·¥ä½œè¡¨çš„å±æ€§ã€‚</li><li><strong>æ ·å¼è®¾ç½®:</strong>  å¯ä»¥è®¾ç½®å•å…ƒæ ¼çš„å­—ä½“ã€é¢œè‰²ã€å¯¹é½æ–¹å¼ã€è¾¹æ¡†ç­‰æ ·å¼ã€‚</li><li><strong>å›¾è¡¨æ”¯æŒ:</strong>  å¯ä»¥åˆ›å»ºå„ç§å›¾è¡¨ï¼Œä¾‹å¦‚æŸ±çŠ¶å›¾ã€æŠ˜çº¿å›¾ã€é¥¼å›¾ç­‰ã€‚</li><li><strong>æ˜“äºä½¿ç”¨:</strong>  API è®¾è®¡å‹å¥½ï¼Œæ˜“äºå­¦ä¹ å’Œä½¿ç”¨ã€‚</li></ul></li></ul><h2 id="åº”ç”¨">åº”ç”¨</h2><h3 id="è¡¨æ ¼å›¾ç‰‡æ’å…¥">è¡¨æ ¼å›¾ç‰‡æ’å…¥</h3><ul><li>code</li></ul> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">insert_image_with_resize</span>(<span class="params">image_path: <span class="built_in">str</span>, cell_width=<span class="number">80.79</span>, cell_height=<span class="number">259.8</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Insert and resize image, handling errors and returning PIL Image.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        img = Image.<span class="built_in">open</span>(image_path)</span><br><span class="line">        width, height = img.size</span><br><span class="line">        width_ratio = (cell_width * <span class="number">7</span>) / width</span><br><span class="line">        height_ratio = cell_height / height</span><br><span class="line">        ratio = <span class="built_in">min</span>(width_ratio, height_ratio)</span><br><span class="line">        new_width = <span class="built_in">int</span>(width * ratio)  <span class="comment"># Calculate new_width</span></span><br><span class="line">        new_height = <span class="built_in">int</span>(height * ratio)  <span class="comment"># Calculate new_height</span></span><br><span class="line">        img = img.resize((new_width, new_height), Image.LANCZOS)</span><br><span class="line"></span><br><span class="line">        base, ext = os.path.splitext(os.path.basename(image_path))</span><br><span class="line">        temp_img_path = os.path.join(TEMP_DIR, <span class="string">f&quot;temp_<span class="subst">&#123;base&#125;</span>_<span class="subst">&#123;<span class="built_in">hash</span>(image_path)&#125;</span><span class="subst">&#123;ext&#125;</span>&quot;</span>)</span><br><span class="line">        img.save(temp_img_path, optimize=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> img, temp_img_path</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        logger.error(<span class="string">f&quot;Image file not found: <span class="subst">&#123;image_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> (UnidentifiedImageError, OSError) <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Image format error or corrupted file: <span class="subst">&#123;image_path&#125;</span> - <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.exception(<span class="string">f&quot;Error processing image <span class="subst">&#123;image_path&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br></pre></td></tr></table></figure><h3 id="å›¾ç‰‡æ•°æ®æ’å…¥å‰å¤„ç†">å›¾ç‰‡æ•°æ®æ’å…¥å‰å¤„ç†</h3> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">MAX_IMAGE_PIXELS = <span class="number">178956970</span>  <span class="comment"># Define the maximum pixel limit</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rgba_to_rgb_numpy</span>(<span class="params">image, background_color=(<span class="params"><span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span></span>)</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä½¿ç”¨ NumPy å°† RGBA/LA å›¾åƒè½¬æ¢ä¸º RGB å›¾åƒï¼Œå¯ä»¥æŒ‡å®šèƒŒæ™¯é¢œè‰²ã€‚&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> image.mode == <span class="string">&#x27;L&#x27;</span>:  <span class="comment"># ç°åº¦å›¾åƒ</span></span><br><span class="line">            logger.debug(<span class="string">f&quot;Converting grayscale image to RGB.&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> image.convert(<span class="string">&#x27;RGB&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> image.mode == <span class="string">&#x27;LA&#x27;</span>:</span><br><span class="line">            logger.debug(<span class="string">f&quot;Converting LA image to RGB (grayscale with alpha).&quot;</span>)</span><br><span class="line">            img_array = np.array(image)</span><br><span class="line">            l_channel = img_array[:, :, <span class="number">0</span>]  <span class="comment"># Luminance channel</span></span><br><span class="line">            alpha_channel = img_array[:, :, <span class="number">1</span>] <span class="comment">#Alpha channel</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Create an RGB image where R=G=B=L</span></span><br><span class="line">            rgb = np.stack([l_channel, l_channel, l_channel], axis=<span class="number">2</span>)  <span class="comment"># Replicate L to R, G, B</span></span><br><span class="line"></span><br><span class="line">            background = np.array(background_color, dtype=np.uint8)</span><br><span class="line">            new_rgb = (rgb * (alpha_channel / <span class="number">255.0</span>)[:, :, <span class="literal">None</span>] + background * (<span class="number">1</span> - (alpha_channel / <span class="number">255.0</span>)[:, :, <span class="literal">None</span>])).astype(np.uint8)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Image.fromarray(new_rgb)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> image.mode == <span class="string">&#x27;RGBA&#x27;</span>:</span><br><span class="line">            logger.debug(<span class="string">f&quot;Converting RGBA image to RGB.&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># å¼ºåˆ¶åŠ è½½å›¾åƒæ•°æ®</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                image.load()  <span class="comment"># ç¡®ä¿å›¾åƒæ•°æ®å·²åŠ è½½</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logger.error(<span class="string">f&quot;Failed to load image data: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> image  <span class="comment"># æ— æ³•åŠ è½½ï¼Œç›´æ¥è¿”å›åŸå§‹å›¾åƒ</span></span><br><span class="line"></span><br><span class="line">            img_array = np.array(image)</span><br><span class="line">            logger.debug(<span class="string">f&quot;Image array shape: <span class="subst">&#123;img_array.shape&#125;</span>, mode: <span class="subst">&#123;image.mode&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(img_array.shape) &lt; <span class="number">3</span>:</span><br><span class="line">                logger.error(<span class="string">f&quot;Image has insufficient dimensions (shape: <span class="subst">&#123;img_array.shape&#125;</span>), skipping conversion.&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> image</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> img_array.shape[<span class="number">2</span>] &lt; <span class="number">4</span>:  <span class="comment"># æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„é€šé“</span></span><br><span class="line">                logger.warning(<span class="string">f&quot;Image has only <span class="subst">&#123;img_array.shape[<span class="number">2</span>]&#125;</span> channels, assuming no alpha and skipping conversion.&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> image.convert(<span class="string">&quot;RGB&quot;</span>)  <span class="comment"># ç›´æ¥è½¬æ¢ä¸ºRGBï¼Œä¸åšalphaæ··åˆ</span></span><br><span class="line"></span><br><span class="line">            alpha = img_array[:, :, <span class="number">3</span>]  <span class="comment"># Alpha channel</span></span><br><span class="line">            rgb = img_array[:, :, :<span class="number">3</span>]  <span class="comment"># RGB channels</span></span><br><span class="line"></span><br><span class="line">            background = np.array(background_color, dtype=np.uint8)</span><br><span class="line">            new_rgb = (rgb * (alpha / <span class="number">255.0</span>)[:, :, <span class="literal">None</span>] + background * (<span class="number">1</span> - (alpha / <span class="number">255.0</span>)[:, :, <span class="literal">None</span>])).astype(</span><br><span class="line">                np.uint8)</span><br><span class="line">            <span class="keyword">return</span> Image.fromarray(new_rgb)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logger.debug(<span class="string">f&quot;Converting non-RGBA/LA image to RGB.&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> image.convert(<span class="string">&quot;RGB&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.exception(<span class="string">f&quot;Error during RGBA to RGB conversion: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> image</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_image</span>(<span class="params">file_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Check if a file is a valid image (and resizes if needed) and its mode is RGB (or can be converted to RGB).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        True if the file is a valid image,</span></span><br><span class="line"><span class="string">        False if the file is not found or is not a valid image, or exceeds the limit.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">global</span> MAX_IMAGE_PIXELS</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> file_path:</span><br><span class="line">        logger.error(<span class="string">f&quot;Error: Path empty -<span class="subst">&#123;file_path&#125;</span>&quot;</span>)  <span class="comment"># check all path first</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(file_path):</span><br><span class="line">            logger.error(</span><br><span class="line">                <span class="string">f&quot;Error: The file was Not found at the location - <span class="subst">&#123;file_path&#125;</span>&quot;</span></span><br><span class="line">            )  <span class="comment"># check if all locations have files.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            img = Image.<span class="built_in">open</span>(file_path)</span><br><span class="line">            width, height = img.size</span><br><span class="line">            total_pixels = width * height</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> total_pixels &gt; MAX_IMAGE_PIXELS:</span><br><span class="line">                logger.warning(<span class="string">f&quot;Image <span class="subst">&#123;file_path&#125;</span> exceeds pixel limit. Resizing.&quot;</span>)</span><br><span class="line">                <span class="comment"># Calculate new dimensions while preserving aspect ratio</span></span><br><span class="line">                ratio = (MAX_IMAGE_PIXELS / total_pixels) ** <span class="number">0.5</span></span><br><span class="line">                new_width = <span class="built_in">int</span>(width * ratio)</span><br><span class="line">                new_height = <span class="built_in">int</span>(height * ratio)</span><br><span class="line">                img = img.resize((new_width, new_height), Image.LANCZOS)  <span class="comment"># Or another resampling filter</span></span><br><span class="line">                logger.info(<span class="string">f&quot;Resized image to <span class="subst">&#123;new_width&#125;</span>x<span class="subst">&#123;new_height&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            img.load()  <span class="comment"># Force load to find problems</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> (FileNotFoundError, UnidentifiedImageError, OSError) <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Error opening image file <span class="subst">&#123;file_path&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(</span><br><span class="line">                <span class="string">f&quot;Different from other error: it is an Unexpected error opening image: <span class="subst">&#123;file_path&#125;</span>  <span class="subst">&#123;e&#125;</span>&quot;</span></span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span>  <span class="comment"># It may have just not passed the test and is just a bad file path that is expected.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Verify the file and get the image format</span></span><br><span class="line">            <span class="comment"># Verify a copy instead</span></span><br><span class="line">            img_copy = img.copy()</span><br><span class="line">            img_copy.verify()</span><br><span class="line">            img_copy.close()  <span class="comment"># Release resources</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(</span><br><span class="line">                <span class="string">f&quot;Error: Image verification failed - <span class="subst">&#123;file_path&#125;</span>  <span class="subst">&#123;e&#125;</span>&quot;</span></span><br><span class="line">            )  <span class="comment"># This can be all bad names, or some other error with image.</span></span><br><span class="line">            img.close()  <span class="comment"># Release resources</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># If RBGA was never called it was a fail</span></span><br><span class="line">        <span class="keyword">if</span> img.mode == <span class="string">&quot;RGBA&quot;</span>:</span><br><span class="line">            <span class="comment"># Check the image.</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                img = rgba_to_rgb_numpy(</span><br><span class="line">                    img</span><br><span class="line">                )  <span class="comment"># try and convert if RGBA is needed and all cases works</span></span><br><span class="line">                logger.warning(<span class="string">f&quot;img: <span class="subst">&#123;file_path&#125;</span> , img: <span class="subst">&#123;img&#125;</span>, rgba to rgb...&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logger.error(<span class="string">f&quot;convert error, detail: <span class="subst">&#123;e&#125;</span>, file path : <span class="subst">&#123;file_path&#125;</span>&quot;</span>)</span><br><span class="line">                img.close()  <span class="comment"># Release Resources before returning</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span>  <span class="comment"># If the image cannot load and convert, test that this is correct image</span></span><br><span class="line"></span><br><span class="line">        img.close()  <span class="comment"># Close when done if conversion was not needed.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span>  <span class="comment"># It was tested if all file loads.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(</span><br><span class="line">            <span class="string">f&quot;Different from other error: it is an Unexpected error opening image: or image does not pass checks and there may not be image or corrupted with  other issues - <span class="subst">&#123;file_path&#125;</span>  <span class="subst">&#123;e&#125;</span>&quot;</span></span><br><span class="line">        )  <span class="comment"># This case is just a bad path</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>  <span class="comment"># It may have just not passed the test and is just a bad file path that is expected.</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="æ•°æ®æ‰¹é‡å†™å…¥excelè¡¨æ ¼">æ•°æ®æ‰¹é‡å†™å…¥excelè¡¨æ ¼</h3> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">process_image_group</span>(<span class="params">identifiers, images_map_dir1, images_map_dir2, instruction_txt_path, start_index</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Processes a group of images.&quot;&quot;&quot;</span></span><br><span class="line">    sheet_data = []</span><br><span class="line">    temp_files = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> index, identifier <span class="keyword">in</span> <span class="built_in">enumerate</span>(identifiers, start=start_index + <span class="number">1</span>):</span><br><span class="line">        image1_path = images_map_dir1.get(identifier)</span><br><span class="line">        image2_path = images_map_dir2.get(identifier)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> image1_path <span class="keyword">and</span> image2_path:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                original_filename = os.path.basename(image1_path)</span><br><span class="line">                processed_filename = os.path.basename(image2_path)</span><br><span class="line">                instruction_text = generate_modification_instruction(processed_filename)</span><br><span class="line"></span><br><span class="line">                logger.info(<span class="string">f&quot;source image: <span class="subst">&#123;image1_path&#125;</span> instruction txt: <span class="subst">&#123;instruction_text&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Extract filename without instruction using a helper function</span></span><br><span class="line">                processed_filename_without_instruction = extract_filename_without_instruction(processed_filename,</span><br><span class="line">                                                                                              instruction_text)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">with</span> concurrent.futures.ThreadPoolExecutor() <span class="keyword">as</span> executor:</span><br><span class="line">                    future1 = executor.submit(insert_image_with_resize, image1_path)</span><br><span class="line">                    future2 = executor.submit(insert_image_with_resize, image2_path)</span><br><span class="line">                    img1, temp_img1_path = future1.result()</span><br><span class="line">                    img2, temp_img2_path = future2.result()</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> temp_img1_path:</span><br><span class="line">                    temp_files.append(temp_img1_path)</span><br><span class="line">                <span class="keyword">if</span> temp_img2_path:</span><br><span class="line">                    temp_files.append(temp_img2_path)</span><br><span class="line"></span><br><span class="line">                original_numbers = extract_numbers_from_filename(original_filename)</span><br><span class="line">                processed_numbers = extract_numbers_from_filename(processed_filename)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># logger.info(f&quot;get source number image: &#123;original_numbers&#125;, processed numbers: &#123;processed_numbers&#125;!!!&quot;)</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># æ„å»ºæ–‡ä»¶å</span></span><br><span class="line">                base_name, ext = os.path.splitext(processed_filename)  <span class="comment"># è·å–åŸå§‹æ‰©å±•å</span></span><br><span class="line">                <span class="comment"># process_path = os.path.split(image2_path)</span></span><br><span class="line">                new_image1_filename, ext = extract_directory_and_extension(image2_path)</span><br><span class="line">                new_image1_filename = os.path.join(new_image1_filename, <span class="built_in">str</span>(processed_numbers[<span class="number">0</span>]) + <span class="built_in">str</span>(ext))</span><br><span class="line"></span><br><span class="line">                parent_dir_name = get_parent_directory_name(image2_path)</span><br><span class="line">                parent_dir_name = os.path.join(parent_dir_name, <span class="string">&#x27;copy&#x27;</span>)</span><br><span class="line"></span><br><span class="line">                copied_image2_path = copy_and_rename(image2_path, parent_dir_name, new_image1_filename)</span><br><span class="line">                <span class="comment"># copied_image2_path = copy_and_rename(image2_path, &quot;./copy&quot;, new_image2_filename)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment"># logger.info(f&quot;already copy image2: &#123;image2_path&#125; to new dir: &#123;copied_image2_path&#125;!!! name: &#123;new_image1_filename&#125;.&quot;)</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> img1 <span class="keyword">and</span> img2:</span><br><span class="line">                    sheet_data.append(&#123;</span><br><span class="line">                        <span class="string">&#x27;index&#x27;</span>: index,</span><br><span class="line">                        <span class="string">&#x27;original_filename&#x27;</span>: original_numbers[<span class="number">0</span>],</span><br><span class="line">                        <span class="string">&#x27;img1&#x27;</span>: img1,</span><br><span class="line">                        <span class="string">&#x27;temp_img1_path&#x27;</span>: temp_img1_path,</span><br><span class="line">                        <span class="string">&#x27;processed_filename&#x27;</span>: processed_numbers[<span class="number">0</span>],</span><br><span class="line">                        <span class="string">&#x27;processed_filename_without_instruction&#x27;</span>: processed_filename_without_instruction,  <span class="comment"># Added field</span></span><br><span class="line">                        <span class="string">&#x27;img2&#x27;</span>: img2,</span><br><span class="line">                        <span class="string">&#x27;temp_img2_path&#x27;</span>: temp_img2_path,</span><br><span class="line">                        <span class="string">&#x27;instruction_text&#x27;</span>: instruction_text</span><br><span class="line">                    &#125;)</span><br><span class="line">                    logger.info(<span class="string">f&quot;writing image: <span class="subst">&#123;original_filename&#125;</span> and <span class="subst">&#123;processed_filename&#125;</span> to excel file!!!&quot;</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    logger.error(<span class="string">f&quot;Skipping row: <span class="subst">&#123;original_filename&#125;</span>, <span class="subst">&#123;processed_filename&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logger.error(<span class="string">f&quot;Error processing: <span class="subst">&#123;image1_path&#125;</span> or <span class="subst">&#123;image2_path&#125;</span> - <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logger.warning(<span class="string">f&quot;Error processing: <span class="subst">&#123;image1_path&#125;</span> or <span class="subst">&#123;image2_path&#125;</span> not get part.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sheet_data, temp_files</span><br></pre></td></tr></table></figure><h3 id="æ•°æ®æ±‡æ€»è¾“å‡ºExcel">æ•°æ®æ±‡æ€»è¾“å‡ºExcel</h3> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_images_to_excel</span>(<span class="params">dir1, dir2, output_excel, progress_var, progress_bar, progress_label, ps_root,</span></span><br><span class="line"><span class="params">                          instruction_txt_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Write images and filenames to Excel.&quot;&quot;&quot;</span></span><br><span class="line">    files_dir1 = get_all_files(dir1)</span><br><span class="line">    files_dir2 = get_all_files(dir2)</span><br><span class="line"></span><br><span class="line">    images_map_dir1 = &#123;&#125;</span><br><span class="line">    images_map_dir2 = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> files_dir1:</span><br><span class="line">        <span class="keyword">if</span> is_image(file):</span><br><span class="line">            identifier = extract_identifier_de(os.path.basename(file)) <span class="keyword">or</span> os.path.basename(file)</span><br><span class="line">            images_map_dir1[identifier] = file</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logger.warning(<span class="string">f&quot;file path not image!!! <span class="subst">&#123;file&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> files_dir2:</span><br><span class="line">        <span class="keyword">if</span> is_image(file):</span><br><span class="line">            identifier = extract_identifier_de(os.path.basename(file)) <span class="keyword">or</span> os.path.basename(file)</span><br><span class="line">            images_map_dir2[identifier] = file</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logger.warning(<span class="string">f&quot;file path not image!!! <span class="subst">&#123;file&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> images_map_dir1 <span class="keyword">and</span> <span class="keyword">not</span> images_map_dir2:</span><br><span class="line">        logger.warning(<span class="string">&quot;No image files found.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    common_identifiers = <span class="built_in">list</span>(<span class="built_in">set</span>(images_map_dir1.keys()) &amp; <span class="built_in">set</span>(images_map_dir2.keys()))</span><br><span class="line">    total_images = <span class="built_in">len</span>(common_identifiers)</span><br><span class="line">    logger.info(<span class="string">f&quot;total image: <span class="subst">&#123;total_images&#125;</span>!!!&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># logger.info(&quot;start output all image content:!!!&quot;)</span></span><br><span class="line">    <span class="keyword">if</span> dev_tools_mode:</span><br><span class="line">        logger.info(<span class="string">&quot;dev tools mode enable!!!&quot;</span>)</span><br><span class="line">        compare_and_info_dicts(images_map_dir1, images_map_dir2)</span><br><span class="line">    <span class="comment"># logger.info(&quot;end output all image content:!!!&quot;)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> common_identifiers:</span><br><span class="line">        logger.warning(<span class="string">&quot;No common identifiers found.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    common_identifiers.sort(</span><br><span class="line">        key=<span class="keyword">lambda</span> x: (<span class="built_in">int</span>(extract_identifier(x)) <span class="keyword">if</span> extract_identifier(x).isdigit() <span class="keyword">else</span> <span class="built_in">float</span>(<span class="string">&#x27;inf&#x27;</span>), x))</span><br><span class="line"></span><br><span class="line">    output_dir = os.path.dirname(output_excel)</span><br><span class="line">    base_name, ext = os.path.splitext(os.path.basename(output_excel))</span><br><span class="line">    os.makedirs(output_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> tqdm(total=total_images, desc=<span class="string">&quot;Processing Images&quot;</span>, unit=<span class="string">&quot;pair&quot;</span>, dynamic_ncols=<span class="literal">True</span>) <span class="keyword">as</span> pbar:</span><br><span class="line">        <span class="keyword">for</span> start_index <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, total_images, <span class="number">500</span>):</span><br><span class="line">            end_index = <span class="built_in">min</span>(start_index + <span class="number">500</span>, total_images)</span><br><span class="line">            current_identifiers = common_identifiers[start_index:end_index]</span><br><span class="line"></span><br><span class="line">            sheet_data, temp_files = process_image_group(current_identifiers, images_map_dir1, images_map_dir2,</span><br><span class="line">                                                         instruction_txt_path, start_index)</span><br><span class="line"></span><br><span class="line">            workbook = openpyxl.Workbook()</span><br><span class="line">            sheet = workbook.active</span><br><span class="line">            sheet.title = <span class="string">&quot;Image Comparison&quot;</span></span><br><span class="line"></span><br><span class="line">            headers = [<span class="string">&quot;åºå·&quot;</span>, <span class="string">&quot;åŸå›¾æ–‡ä»¶å&quot;</span>, <span class="string">&quot;åŸå›¾&quot;</span>, <span class="string">&quot;ä¿®æ”¹å›¾æ–‡ä»¶å&quot;</span>, <span class="string">&quot;ä¿®æ”¹å›¾&quot;</span>, <span class="string">&quot;ä¿®æ”¹å†…å®¹&quot;</span>]</span><br><span class="line">            <span class="keyword">for</span> col_num, header <span class="keyword">in</span> <span class="built_in">enumerate</span>(headers, <span class="number">1</span>):</span><br><span class="line">                cell = sheet.cell(row=<span class="number">1</span>, column=col_num, value=header)</span><br><span class="line">                cell.alignment = Alignment(horizontal=<span class="string">&#x27;center&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            row = <span class="number">2</span></span><br><span class="line">            original_filenames = []</span><br><span class="line">            processed_filenames = []</span><br><span class="line">            modification_instructions = []</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> item <span class="keyword">in</span> sheet_data:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    sheet.cell(row=row, column=<span class="number">1</span>, value=item[<span class="string">&#x27;index&#x27;</span>]).alignment = Alignment(horizontal=<span class="string">&#x27;center&#x27;</span>)</span><br><span class="line">                    original_filenames.append(item[<span class="string">&#x27;original_filename&#x27;</span>])</span><br><span class="line">                    sheet.cell(row=row, column=<span class="number">2</span>, value=item[<span class="string">&#x27;original_filename&#x27;</span>])</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> item[<span class="string">&#x27;img1&#x27;</span>]:</span><br><span class="line">                        excel_img1 = ExcelImage(item[<span class="string">&#x27;temp_img1_path&#x27;</span>])</span><br><span class="line">                        sheet.add_image(excel_img1, <span class="string">f&#x27;C<span class="subst">&#123;row&#125;</span>&#x27;</span>)</span><br><span class="line">                        sheet.row_dimensions[row].height = <span class="number">259.8</span></span><br><span class="line"></span><br><span class="line">                    processed_filenames.append(item[<span class="string">&#x27;processed_filename&#x27;</span>])</span><br><span class="line">                    sheet.cell(row=row, column=<span class="number">4</span>, value=item[<span class="string">&#x27;processed_filename&#x27;</span>])</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> item[<span class="string">&#x27;img2&#x27;</span>]:</span><br><span class="line">                        excel_img2 = ExcelImage(item[<span class="string">&#x27;temp_img2_path&#x27;</span>])</span><br><span class="line">                        sheet.add_image(excel_img2, <span class="string">f&#x27;E<span class="subst">&#123;row&#125;</span>&#x27;</span>)</span><br><span class="line">                        sheet.row_dimensions[row].height = <span class="number">259.8</span></span><br><span class="line"></span><br><span class="line">                    modification_instructions.append(item[<span class="string">&#x27;instruction_text&#x27;</span>])</span><br><span class="line">                    sheet.cell(row=row, column=<span class="number">6</span>, value=item[<span class="string">&#x27;instruction_text&#x27;</span>]).alignment = Alignment(vertical=<span class="string">&#x27;top&#x27;</span>)</span><br><span class="line"></span><br><span class="line">                    row += <span class="number">1</span></span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    logger.exception(<span class="string">f&quot;Error adding row: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            adjust_column_width(sheet, <span class="string">&#x27;B&#x27;</span>, original_filenames)</span><br><span class="line">            adjust_column_width(sheet, <span class="string">&#x27;D&#x27;</span>, processed_filenames)</span><br><span class="line">            adjust_column_width(sheet, <span class="string">&#x27;F&#x27;</span>, modification_instructions)</span><br><span class="line">            adjust_column_width(sheet, <span class="string">&#x27;A&#x27;</span>, <span class="built_in">range</span>(start_index + <span class="number">1</span>, start_index + <span class="built_in">len</span>(current_identifiers) + <span class="number">1</span>))</span><br><span class="line">            sheet.column_dimensions[<span class="string">&#x27;C&#x27;</span>].width = <span class="number">80.79</span></span><br><span class="line">            sheet.column_dimensions[<span class="string">&#x27;E&#x27;</span>].width = <span class="number">80.79</span></span><br><span class="line"></span><br><span class="line">            file_counter = start_index // <span class="number">500</span> + <span class="number">1</span></span><br><span class="line">            new_output_excel = os.path.join(output_dir, <span class="string">f&quot;<span class="subst">&#123;base_name&#125;</span>_<span class="subst">&#123;file_counter&#125;</span><span class="subst">&#123;ext&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                workbook.save(new_output_excel)</span><br><span class="line">                logger.info(<span class="string">f&quot;Saved batch: <span class="subst">&#123;new_output_excel&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logger.error(<span class="string">f&quot;Failed to save <span class="subst">&#123;new_output_excel&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            <span class="keyword">finally</span>:</span><br><span class="line">                <span class="keyword">for</span> temp_file <span class="keyword">in</span> temp_files:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        os.remove(temp_file)</span><br><span class="line">                    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">                        <span class="keyword">pass</span></span><br><span class="line">                    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                        logger.error(<span class="string">f&quot;Error deleting <span class="subst">&#123;temp_file&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            pbar.update(<span class="built_in">len</span>(current_identifiers))</span><br><span class="line">            progress_percentage = <span class="built_in">int</span>((pbar.n / total_images) * <span class="number">100</span>)</span><br><span class="line">            progress_var.<span class="built_in">set</span>(progress_percentage)</span><br><span class="line">            progress_label.config(text=<span class="string">f&quot;<span class="subst">&#123;progress_percentage&#125;</span>%&quot;</span>)</span><br><span class="line">            ps_root.update_idletasks()</span><br><span class="line"></span><br><span class="line">    progress_var.<span class="built_in">set</span>(<span class="number">100</span>)</span><br><span class="line">    progress_label.config(text=<span class="string">&quot;100%&quot;</span>)</span><br><span class="line">    ps_root.update_idletasks()</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åœ¨macOSä½¿ç”¨ntfsæ ¼å¼ç¡¬ç›˜æ–¹æ³•</title>
      <link href="/2025/02/25/ntfs-macos-mounty/"/>
      <url>/2025/02/25/ntfs-macos-mounty/</url>
      
        <content type="html"><![CDATA[<h1>åœ¨macOSä½¿ç”¨ntfsæ ¼å¼ç¡¬ç›˜æ–¹æ³•</h1><p><strong>1. FAT32 (File Allocation Table 32-bit)</strong></p><ul><li><strong>å†å²ï¼š</strong> FAT32 æ˜¯ FAT æ–‡ä»¶ç³»ç»Ÿå®¶æ—çš„ä¸€å‘˜ï¼Œæ˜¯ FAT16 çš„åç»§è€…ã€‚å®ƒåœ¨ Windows 95 OSR2 ä¸­é¦–æ¬¡å¼•å…¥ï¼Œæ—¨åœ¨å…‹æœ FAT16 çš„ä¸€äº›é™åˆ¶ã€‚</li><li><strong>ç»“æ„ï¼š</strong> FAT32 æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨æ–‡ä»¶åˆ†é…è¡¨ (FAT) æ¥è·Ÿè¸ªç£ç›˜ä¸Šçš„æ–‡ä»¶å’Œç›®å½•ã€‚FAT è¡¨å®é™…ä¸Šæ˜¯ä¸€ä¸ªç´¢å¼•è¡¨ï¼Œè®°å½•äº†ç£ç›˜ä¸Šæ¯ä¸ªç°‡ï¼ˆclusterï¼Œç£ç›˜ä¸Šæœ€å°çš„å­˜å‚¨å•å…ƒï¼‰çš„ä½¿ç”¨æƒ…å†µã€‚</li><li><strong>ç‰¹ç‚¹ï¼š</strong><ul><li><strong>å…¼å®¹æ€§å¥½ï¼š</strong> FAT32 å¾—åˆ°äº†å¹¿æ³›çš„æ”¯æŒï¼Œå‡ ä¹æ‰€æœ‰çš„æ“ä½œç³»ç»Ÿå’Œè®¾å¤‡ï¼ˆåŒ…æ‹¬ Windowsã€macOSã€Linuxã€åµŒå…¥å¼ç³»ç»Ÿã€æ¸¸æˆæœºç­‰ï¼‰éƒ½å¯ä»¥è¯»å–å’Œå†™å…¥ FAT32 æ ¼å¼çš„ç£ç›˜ã€‚</li><li><strong>ç®€å•æ˜“ç”¨ï¼š</strong> FAT32 çš„ç»“æ„æ¯”è¾ƒç®€å•ï¼Œå®ç°èµ·æ¥ä¹Ÿç›¸å¯¹å®¹æ˜“ã€‚</li></ul></li><li><strong>ç¼ºç‚¹ï¼š</strong><ul><li><strong>æœ€å¤§æ–‡ä»¶å°ºå¯¸é™åˆ¶ï¼š</strong> FAT32 æ–‡ä»¶ç³»ç»Ÿå¯¹å•ä¸ªæ–‡ä»¶çš„å¤§å°æœ‰é™åˆ¶ï¼Œæœ€å¤§ä¸èƒ½è¶…è¿‡ 4GBã€‚ è¿™ä½¿å¾—å®ƒæ— æ³•å­˜å‚¨é«˜æ¸…è§†é¢‘ã€å¤§å‹æ•°æ®åº“æ–‡ä»¶ç­‰ã€‚</li><li><strong>æœ€å¤§åˆ†åŒºå°ºå¯¸é™åˆ¶ï¼š</strong> è™½ç„¶ç†è®ºä¸Š FAT32 å¯ä»¥æ”¯æŒæœ€å¤§ 8TB çš„åˆ†åŒºï¼Œä½†å®é™…ä¸Šç”±äºä¸€äº›æ“ä½œç³»ç»Ÿï¼ˆç‰¹åˆ«æ˜¯ Windowsï¼‰çš„é™åˆ¶ï¼ŒFAT32 åˆ†åŒºé€šå¸¸é™åˆ¶åœ¨ 32GBã€‚</li><li><strong>å®‰å…¨æ€§è¾ƒå·®ï¼š</strong> FAT32 ä¸æ”¯æŒæ–‡ä»¶æƒé™ã€åŠ å¯†ç­‰å®‰å…¨ç‰¹æ€§ã€‚</li><li><strong>å¯é æ€§è¾ƒä½ï¼š</strong> FAT32 çš„å…ƒæ•°æ®ï¼ˆFAT è¡¨ï¼‰é€šå¸¸åªæœ‰ä¸€ä¸ªå‰¯æœ¬ï¼Œä¸€æ—¦æŸåï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚</li></ul></li><li><strong>é€‚ç”¨åœºæ™¯ï¼š</strong><ul><li><strong>ç§»åŠ¨å­˜å‚¨è®¾å¤‡ï¼š</strong> æ¯”å¦‚ U ç›˜ã€SD å¡ç­‰ï¼Œå¦‚æœä¸éœ€è¦å­˜å‚¨è¶…è¿‡ 4GB çš„å•ä¸ªæ–‡ä»¶ï¼Œå¹¶ä¸”éœ€è¦åœ¨å¤šä¸ªæ“ä½œç³»ç»Ÿæˆ–è®¾å¤‡ä¸Šä½¿ç”¨ï¼ŒFAT32 æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</li><li><strong>åµŒå…¥å¼ç³»ç»Ÿï¼š</strong> ä¸€äº›åµŒå…¥å¼è®¾å¤‡ä»ç„¶ä½¿ç”¨ FAT32ï¼Œå› ä¸ºå®ƒçš„å®ç°ç®€å•ä¸”èµ„æºå ç”¨è¾ƒå°‘ã€‚</li><li><strong>è€æ—§æ“ä½œç³»ç»Ÿï¼š</strong> å¯¹äºä¸€äº›è€æ—§çš„æ“ä½œç³»ç»Ÿï¼Œå¯èƒ½åªèƒ½æ”¯æŒ FAT32 æ ¼å¼ã€‚</li></ul></li></ul><p><strong>2. NTFS (New Technology File System)</strong></p><ul><li><strong>å†å²ï¼š</strong> NTFS æ˜¯å¾®è½¯ä¸º Windows NT ç³»åˆ—æ“ä½œç³»ç»Ÿè®¾è®¡çš„ç°ä»£æ–‡ä»¶ç³»ç»Ÿï¼Œæ—¨åœ¨å–ä»£ FAT æ–‡ä»¶ç³»ç»Ÿã€‚å®ƒé¦–æ¬¡å‡ºç°åœ¨ Windows NT 3.1 ä¸­ï¼Œå¹¶åœ¨åç»­çš„ Windows ç‰ˆæœ¬ä¸­å¾—åˆ°äº†å¹¿æ³›åº”ç”¨ã€‚</li><li><strong>ç»“æ„ï¼š</strong> NTFS ä½¿ç”¨ä¸»æ–‡ä»¶è¡¨ (MFT, Master File Table) æ¥ç®¡ç†ç£ç›˜ä¸Šçš„æ–‡ä»¶å’Œç›®å½•ã€‚MFT ç±»ä¼¼äºä¸€ä¸ªæ•°æ®åº“ï¼Œè®°å½•äº†æ¯ä¸ªæ–‡ä»¶å’Œç›®å½•çš„å…ƒæ•°æ®ï¼ˆå¤§å°ã€åˆ›å»ºæ—¶é—´ã€æƒé™ç­‰ï¼‰ä»¥åŠæ•°æ®å­˜å‚¨ä½ç½®ã€‚</li><li><strong>ç‰¹ç‚¹ï¼š</strong><ul><li><strong>æ”¯æŒå¤§æ–‡ä»¶å’Œåˆ†åŒºï¼š</strong> NTFS æ²¡æœ‰ 4GB çš„æ–‡ä»¶å°ºå¯¸é™åˆ¶ï¼Œå¯ä»¥å­˜å‚¨å¤§å‹æ–‡ä»¶ã€‚ NTFS å¯ä»¥æ”¯æŒéå¸¸å¤§çš„åˆ†åŒºï¼ˆç†è®ºä¸Šå¯è¾¾ 256TBï¼‰ï¼Œä½†å®é™…å—æ“ä½œç³»ç»Ÿé™åˆ¶ã€‚</li><li><strong>å®‰å…¨æ€§é«˜ï¼š</strong> NTFS æ”¯æŒæ–‡ä»¶æƒé™ç®¡ç†ï¼Œå¯ä»¥æ§åˆ¶ç”¨æˆ·å¯¹æ–‡ä»¶å’Œç›®å½•çš„è®¿é—®æƒé™ã€‚ å®ƒè¿˜æ”¯æŒåŠ å¯†æ–‡ä»¶ç³»ç»Ÿ (EFS)ï¼Œå¯ä»¥å¯¹æ–‡ä»¶è¿›è¡ŒåŠ å¯†å­˜å‚¨ã€‚</li><li><strong>å¯é æ€§é«˜ï¼š</strong> NTFS å…·æœ‰æ—¥å¿—åŠŸèƒ½ï¼Œå¯ä»¥è®°å½•æ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œï¼Œå¹¶åœ¨ç³»ç»Ÿå´©æºƒåè¿›è¡Œæ¢å¤ï¼Œä»è€Œä¿è¯æ•°æ®çš„å®Œæ•´æ€§ã€‚ NTFS çš„å…ƒæ•°æ®ï¼ˆMFTï¼‰é€šå¸¸æœ‰å¤šä¸ªå‰¯æœ¬ï¼Œå¯ä»¥æé«˜å®¹é”™èƒ½åŠ›ã€‚</li><li><strong>é«˜çº§ç‰¹æ€§ï¼š</strong> NTFS æ”¯æŒç£ç›˜é…é¢ã€å‹ç¼©ã€ç¨€ç–æ–‡ä»¶ã€ç¬¦å·é“¾æ¥ç­‰é«˜çº§ç‰¹æ€§ã€‚</li></ul></li><li><strong>ç¼ºç‚¹ï¼š</strong><ul><li><strong>å…¼å®¹æ€§ç¨å·®ï¼š</strong> è™½ç„¶ Windows æ“ä½œç³»ç»Ÿå¯¹ NTFS çš„æ”¯æŒéå¸¸å¥½ï¼Œä½† macOS å’Œ Linux å¯¹ NTFS çš„æ”¯æŒå¯èƒ½å­˜åœ¨ä¸€äº›é—®é¢˜ã€‚ åœ¨ macOS ä¸Šï¼Œé»˜è®¤åªèƒ½è¯»å– NTFS æ ¼å¼çš„ç£ç›˜ï¼Œæ— æ³•å†™å…¥ã€‚ åœ¨ Linux ä¸Šï¼Œè™½ç„¶å¯ä»¥é€šè¿‡å®‰è£…é©±åŠ¨ç¨‹åºæ¥æ”¯æŒ NTFS çš„è¯»å†™ï¼Œä½†æ€§èƒ½å¯èƒ½ä¸å¦‚åœ¨ Windows ä¸Šã€‚</li><li><strong>å®ç°å¤æ‚ï¼š</strong> NTFS çš„ç»“æ„æ¯” FAT32 å¤æ‚å¾—å¤šï¼Œå®ç°èµ·æ¥ä¹Ÿæ¯”è¾ƒå›°éš¾ã€‚</li></ul></li><li><strong>é€‚ç”¨åœºæ™¯ï¼š</strong><ul><li><strong>Windows æ“ä½œç³»ç»Ÿï¼š</strong> NTFS æ˜¯ Windows æ“ä½œç³»ç»Ÿçš„é»˜è®¤æ–‡ä»¶ç³»ç»Ÿï¼Œç”¨äºç³»ç»Ÿç›˜å’Œæ•°æ®ç›˜ã€‚</li><li><strong>éœ€è¦å­˜å‚¨å¤§æ–‡ä»¶çš„åœºåˆï¼š</strong> æ¯”å¦‚é«˜æ¸…è§†é¢‘ç¼–è¾‘ã€å¤§å‹æ•°æ®åº“æœåŠ¡å™¨ç­‰ã€‚</li><li><strong>å¯¹æ•°æ®å®‰å…¨æ€§æœ‰è¾ƒé«˜è¦æ±‚çš„åœºåˆï¼š</strong> æ¯”å¦‚ä¼ä¸šæœåŠ¡å™¨ã€å­˜å‚¨æ•æ„Ÿæ•°æ®çš„ç£ç›˜ç­‰ã€‚</li><li><strong>éœ€è¦ä½¿ç”¨ NTFS é«˜çº§ç‰¹æ€§çš„åœºåˆï¼š</strong> æ¯”å¦‚ç£ç›˜é…é¢ã€å‹ç¼©ç­‰ã€‚</li></ul></li></ul><h2 id="brew">brew</h2><h3 id="install">install</h3><ul><li>script example</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è®¾ç½®è„šæœ¬é‡åˆ°é”™è¯¯æ—¶é€€å‡º</span></span><br><span class="line">set -e</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®šä¹‰é¢œè‰²</span></span><br><span class="line">RED=&#x27;\033[0;31m&#x27;</span><br><span class="line">GREEN=&#x27;\033[0;32m&#x27;</span><br><span class="line">YELLOW=&#x27;\033[0;33m&#x27;</span><br><span class="line">NC=&#x27;\033[0m&#x27; # No Color</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥æ˜¯å¦ä¸º macOS</span></span><br><span class="line">if [[ &quot;$(uname)&quot; != &quot;Darwin&quot; ]]; then</span><br><span class="line">    echo -e &quot;$&#123;RED&#125;This script is intended for macOS only.$&#123;NC&#125;&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥æ˜¯å¦å·²å®‰è£… Homebrew</span></span><br><span class="line">if ! command -v brew &amp;&gt; /dev/null; then</span><br><span class="line">    echo -e &quot;$&#123;YELLOW&#125;Homebrew is not installed. Installing...$&#123;NC&#125;&quot;</span><br><span class="line">    /bin/bash -c &quot;$(curl -fsSL https://gitee.com/cunkai/HomebrewCN/raw/master/Homebrew.sh)&quot;</span><br><span class="line">    if [ $? -ne 0 ]; then</span><br><span class="line">        echo -e &quot;$&#123;RED&#125;Failed to install Homebrew. Please install it manually and then rerun this script.$&#123;NC&#125;&quot;</span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line">    echo -e &quot;$&#123;GREEN&#125;Homebrew installed successfully!$&#123;NC&#125;&quot;</span><br><span class="line">else</span><br><span class="line">    # æ›´æ–° Homebrew</span><br><span class="line">    echo -e &quot;$&#123;YELLOW&#125;Updating Homebrew...$&#123;NC&#125;&quot;</span><br><span class="line">    brew update</span><br><span class="line">    if [ $? -ne 0 ]; then</span><br><span class="line">      echo -e &quot;$&#123;RED&#125;Warning: Failed to update Homebrew.  Continuing anyway...$&#123;NC&#125;&quot;</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£… FFmpeg</span></span><br><span class="line">if ! brew list --versions ffmpeg &amp;&gt; /dev/null; then</span><br><span class="line">  echo -e &quot;$&#123;YELLOW&#125;Installing FFmpeg...$&#123;NC&#125;&quot;</span><br><span class="line">  brew install ffmpeg</span><br><span class="line">  if [ $? -ne 0 ]; then</span><br><span class="line">      echo -e &quot;$&#123;RED&#125;Failed to install FFmpeg.$&#123;NC&#125;&quot;</span><br><span class="line">      exit 1</span><br><span class="line">  fi</span><br><span class="line">  echo -e &quot;$&#123;GREEN&#125;FFmpeg installed successfully!$&#123;NC&#125;&quot;</span><br><span class="line">else</span><br><span class="line">  echo -e &quot;$&#123;YELLOW&#125;FFmpeg is already installed. Skipping...$&#123;NC&#125;&quot;</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£… macFUSE, ntfs-3g-mac å’Œ Mounty (ç”¨äº NTFS å†™å…¥æ”¯æŒ)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">see https://mounty.app/#installation</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">macFUSE (Cask)</span></span><br><span class="line">if ! brew list --cask --versions macfuse &amp;&gt; /dev/null; then</span><br><span class="line">  echo -e &quot;$&#123;YELLOW&#125;Installing macFUSE...$&#123;NC&#125;&quot;</span><br><span class="line">  brew install --cask macfuse</span><br><span class="line">  if [ $? -ne 0 ]; then</span><br><span class="line">      echo -e &quot;$&#123;RED&#125;Failed to install macFUSE.  You may need to install it manually from https://osxfuse.github.io/. Continuing...$&#123;NC&#125;&quot;</span><br><span class="line">  fi</span><br><span class="line">else</span><br><span class="line">  echo -e &quot;$&#123;YELLOW&#125;macFUSE is already installed. Skipping...$&#123;NC&#125;&quot;</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ntfs-3g-mac (Formula)</span></span><br><span class="line">if ! brew list --versions ntfs-3g-mac &amp;&gt; /dev/null; then</span><br><span class="line">  echo -e &quot;$&#123;YELLOW&#125;Installing ntfs-3g-mac...$&#123;NC&#125;&quot;</span><br><span class="line">  brew install gromgit/fuse/ntfs-3g-mac</span><br><span class="line">  if [ $? -ne 0 ]; then</span><br><span class="line">    echo -e &quot;$&#123;RED&#125;Failed to install ntfs-3g-mac. This may cause issues with writing to NTFS drives. Continuing...$&#123;NC&#125;&quot;</span><br><span class="line">  fi</span><br><span class="line">else</span><br><span class="line">  echo -e &quot;$&#123;YELLOW&#125;ntfs-3g-mac is already installed. Skipping...$&#123;NC&#125;&quot;</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Mounty (Cask)</span></span><br><span class="line">if ! brew list --cask --versions mounty &amp;&gt; /dev/null; then</span><br><span class="line">  echo -e &quot;$&#123;YELLOW&#125;Installing Mounty...$&#123;NC&#125;&quot;</span><br><span class="line">  brew install --cask mounty</span><br><span class="line">  if [ $? -ne 0 ]; then</span><br><span class="line">      echo -e &quot;$&#123;RED&#125;Failed to install Mounty.  You may need to manually mount NTFS drives. Continuing...$&#123;NC&#125;&quot;</span><br><span class="line">  fi</span><br><span class="line">else</span><br><span class="line">  echo -e &quot;$&#123;YELLOW&#125;Mounty is already installed. Skipping...$&#123;NC&#125;&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">echo -e &quot;$&#123;GREEN&#125;Installation complete!$&#123;NC&#125;&quot;</span><br><span class="line">echo -e &quot;$&#123;YELLOW&#125;Please reboot your computer for the changes (especially macFUSE) to take effect.$&#123;NC&#125;&quot;</span><br><span class="line">echo -e &quot;$&#123;YELLOW&#125;After rebooting, you may need to manually enable &#x27;System Extensions&#x27; for macFUSE in System Preferences &gt; Security &amp; Privacy &gt; General.$&#123;NC&#125;&quot;</span><br><span class="line">echo -e &quot;$&#123;GREEN&#125;If you encounter any issues, run &#x27;brew doctor&#x27; to diagnose potential problems.$&#123;NC&#125;&quot;</span><br></pre></td></tr></table></figure><ul><li>use</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod 777 ./sh.sh</span><br><span class="line">./sh.sh</span><br></pre></td></tr></table></figure><h2 id="mounty">mounty</h2><h3 id="åœ°å€ï¼š">åœ°å€ï¼š</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://mounty.app</span><br></pre></td></tr></table></figure><h3 id="install-and-use">install and use</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">macbook:~ uwe$ brew install --cask macfuse</span><br><span class="line">macbook:~ uwe$ brew install gromgit/fuse/ntfs-3g-mac</span><br><span class="line">macbook:~ uwe$ brew install --cask mounty</span><br></pre></td></tr></table></figure><h2 id="use">use</h2><ul><li><p>å®‰è£…å®Œæˆåï¼Œé‡å¯è½¯ä»¶ è¿›å…¥è®¾ç½®-&gt;éšç§ä¸å®‰å…¨æ€§-&gt;å¯ç”¨æœªçŸ¥æ¥æºå®‰è£…</p></li><li><p>ç³»ç»Ÿè‡ªåŠ¨é‡å¯åï¼Œé•¿æŒ‰ç”µæºé”®è¿›å…¥æ¢å¤æ¨¡å¼ï¼Œç‚¹å‡»èœå•æ æŸ¥çœ‹å¯åŠ¨å®‰å…¨å®ç”¨å·¥å…·ï¼Œç‚¹å‡»é€‰æ‹©ä¸­ç­‰å®‰å…¨æ€§ï¼Œç„¶åé‡å¯</p></li><li><p>å°è¯•é‡æ–°æŒ‚è½½ç¡¬ç›˜ï¼Œå¦‚æœmountyå›¾æ ‡ç”±é»„å˜è“åˆ™ä»£è¡¨æŒ‚è½½æˆåŠŸï¼Œå³å¯åœ¨ç›®æ ‡ç£ç›˜åˆ›å»ºæ–‡ä»¶</p></li></ul><h2 id="ffmpegå®‰è£…">ffmpegå®‰è£…</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install ffmpeg</span><br></pre></td></tr></table></figure><h1>see</h1><ul><li><a href="https://mounty.app/#aBitOfBackground">https://mounty.app/#aBitOfBackground</a></li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> macOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python å¯è§†åŒ–æ‰“åŒ…å·¥å…·é›†é”¦</title>
      <link href="/2025/02/08/python-publish/"/>
      <url>/2025/02/08/python-publish/</url>
      
        <content type="html"><![CDATA[<h1>python å¯è§†åŒ–æ‰“åŒ…å·¥å…·é›†é”¦</h1><h2 id="æ‰“åŒ…">æ‰“åŒ…</h2><blockquote><p>Python æ‰“åŒ…å·¥å…·ç”¨äºå°†ä»£ç ã€ä¾èµ–å’Œèµ„æºæ–‡ä»¶æ•´ç†æˆå¯åˆ†å‘çš„æ ¼å¼ï¼ˆå¦‚åº“ã€å¯æ‰§è¡Œæ–‡ä»¶ç­‰ï¼‰</p></blockquote><h2 id="å¸¸ç”¨æ‰“åŒ…å·¥å…·">å¸¸ç”¨æ‰“åŒ…å·¥å…·</h2><h3 id="pyinstaller">pyinstaller</h3><ul><li>ä½¿ç”¨æ–¹æ³•</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyinstaller --onefile main.py</span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡specæ–‡ä»¶æ‰“åŒ…</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"># -*- mode: python ; coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">block_cipher = None</span><br><span class="line"></span><br><span class="line">a = Analysis(</span><br><span class="line">    [&#x27;main.py&#x27;],</span><br><span class="line">    pathex=[&#x27;/path/to/my_dash_app&#x27;],</span><br><span class="line">    binaries=[],</span><br><span class="line">    datas=[(&#x27;assets/*&#x27;, &#x27;assets&#x27;)],  # æ‰“åŒ… assets æ–‡ä»¶å¤¹</span><br><span class="line">    hiddenimports=[],</span><br><span class="line">    hookspath=[],</span><br><span class="line">    runtime_hooks=[],</span><br><span class="line">    excludes=[],</span><br><span class="line">    win_no_prefer_redirects=False,</span><br><span class="line">    win_private_assemblies=False,</span><br><span class="line">    cipher=block_cipher,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)</span><br><span class="line"></span><br><span class="line">exe = EXE(</span><br><span class="line">    pyz,</span><br><span class="line">    a.scripts,</span><br><span class="line">    [],</span><br><span class="line">    exclude_binaries=True,</span><br><span class="line">    name=&#x27;my_dash_app&#x27;,</span><br><span class="line">    debug=False,</span><br><span class="line">    bootloader_ignore_signals=False,</span><br><span class="line">    strip=False,</span><br><span class="line">    upx=True,</span><br><span class="line">    console=False,  # éšè—æ§åˆ¶å°çª—å£</span><br><span class="line">    icon=&#x27;icon.ico&#x27;,  # è®¾ç½®å›¾æ ‡</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">coll = COLLECT(</span><br><span class="line">    exe,</span><br><span class="line">    a.binaries,</span><br><span class="line">    a.zipfiles,</span><br><span class="line">    a.datas,</span><br><span class="line">    strip=False,</span><br><span class="line">    upx=True,</span><br><span class="line">    upx_exclude=[],</span><br><span class="line">    name=&#x27;my_dash_app&#x27;,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><blockquote><p>è¯¦ç»†å‚è€ƒå¦‚ä¸‹ï¼š<a href="https://caozhaoqi.github.io/2024/04/09/pyinstaller-publish-python/">https://caozhaoqi.github.io/2024/04/09/pyinstaller-publish-python/</a></p></blockquote><h3 id="nuitka">nuitka</h3><blockquote><p>å°† Python ä»£ç ç¼–è¯‘ä¸º C ä»£ç ï¼Œå†ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶, æ€§èƒ½ä¼˜äºæ™®é€šæ‰“åŒ…å·¥å…·</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nuitka --standalone --onefile your_script.py</span><br></pre></td></tr></table></figure><blockquote><p>è¯¦ç»†å‚è€ƒå¦‚ä¸‹ï¼š<a href="https://caozhaoqi.github.io/2024/04/10/setup-tools-python/">https://caozhaoqi.github.io/2024/04/10/setup-tools-python/</a></p></blockquote><h3 id="cx-Freeze">cx_Freeze</h3><ul><li>publish</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cxfreeze your_script.py --target-dir dist</span><br></pre></td></tr></table></figure><h3 id="Briefcase">Briefcase</h3><blockquote><p>æ‰“åŒ…ä¸ºæ¡Œé¢åº”ç”¨</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pip install briefcase</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºé¡¹ç›®æ¨¡æ¿</span></span><br><span class="line">briefcase new</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¿›å…¥é¡¹ç›®ç›®å½•</span></span><br><span class="line">cd myapp</span><br></pre></td></tr></table></figure><ul><li>æ‰“åŒ…</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”Ÿæˆå„å¹³å°å®‰è£…åŒ…</span></span><br><span class="line">briefcase create          # åˆ›å»ºåŸºç¡€ç»“æ„</span><br><span class="line">briefcase build           # æ„å»ºåº”ç”¨</span><br><span class="line">briefcase run             # æœ¬åœ°è¿è¡Œæµ‹è¯•</span><br><span class="line">briefcase package         # ç”Ÿæˆå®‰è£…åŒ…ï¼ˆå¦‚ .dmgã€.msiï¼‰</span><br></pre></td></tr></table></figure><h3 id="PyOxidizer">PyOxidizer</h3><blockquote><p>å°† Python åº”ç”¨ç¼–è¯‘ä¸ºç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¯åŠ¨é€Ÿåº¦å¿«ã€‚<br>æ”¯æŒè·¨å¹³å°ã€‚<br>ç”Ÿæˆçš„æ–‡ä»¶ä½“ç§¯è¾ƒå°ã€‚</p></blockquote><ul><li>æ‰“åŒ…</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£…</span></span><br><span class="line">pip install pyoxidizer</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºé…ç½®æ–‡ä»¶</span></span><br><span class="line">pyoxidizer init-config-file</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç¼–è¾‘ç”Ÿæˆçš„ `pyoxidizer.bzl` æ–‡ä»¶ï¼ŒæŒ‡å®šå…¥å£è„šæœ¬å’Œä¾èµ–</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶</span></span><br><span class="line">pyoxidizer build</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¾“å‡ºè·¯å¾„ï¼š`build/` ç›®å½•</span></span><br></pre></td></tr></table></figure><h3 id="Briefcase-2">Briefcase</h3><blockquote><p>è·¨å¹³å°GUIå·¥å…· å¯ç”Ÿæˆè·¨å¹³å°å®‰è£…åŒ…</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install briefcase</span><br><span class="line">fbs startproject</span><br></pre></td></tr></table></figure><h3 id="fbs">fbs</h3><blockquote><p>ç”¨äº pyside pyqt5 æ‰“åŒ… å±€é™æ€§è¾ƒå¤§</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install fbs</span><br></pre></td></tr></table></figure><ul><li>æ‰“åŒ…</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fbs freeze       # ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶</span><br><span class="line">fbs installer    # åˆ›å»ºå®‰è£…åŒ…ï¼ˆå¦‚ .exeã€.dmgï¼‰</span><br></pre></td></tr></table></figure><blockquote><p>ä¿®æ”¹ src/build/settings/base.json è®¾ç½®åº”ç”¨åç§°ã€ç‰ˆæœ¬ç­‰ã€‚</p></blockquote><h2 id="æ‰“åŒ…åæ–‡ä»¶è½¬æ¢">æ‰“åŒ…åæ–‡ä»¶è½¬æ¢</h2><h3 id="NSIS">NSIS</h3><blockquote><p>æ‰“åŒ…åæ–‡ä»¶è½¬æ¢ä¸ºå®‰è£…å·¥å…· å¯æ ¹æ®å®‰è£…å·¥å…·å®‰è£…ç¨‹åº</p></blockquote><h3 id="Inno-Setup">Inno Setup</h3><blockquote><p>åˆ›å»ºè‡ªå®šä¹‰çš„å®‰è£…å‘å¯¼</p></blockquote><ul><li>å‚è€ƒé“¾æ¥</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://caozhaoqi.github.io/2024/04/09/nuitka-publish-python/</span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç£åŠ›é“¾æ¥ä¸ed2kçš„è‡ªåŠ¨åŒ–æ£€æµ‹å¤„ç†</title>
      <link href="/2025/01/23/ed2k-bit/"/>
      <url>/2025/01/23/ed2k-bit/</url>
      
        <content type="html"><![CDATA[<h1>ç£åŠ›é“¾æ¥ä¸ed2kçš„è‡ªåŠ¨åŒ–æ£€æµ‹å¤„ç†</h1><blockquote><p>ç£åŠ›é“¾æ¥ä¸ed2kå¯¹æ¯”</p></blockquote><p><strong>ç£åŠ›é“¾æ¥ä¸‹è½½é€Ÿåº¦çš„å½±å“å› ç´  (BitTorrent åè®®):</strong></p><ol><li><strong>ç§å­æ•°é‡ï¼ˆSeedersï¼‰ï¼š</strong><ul><li><strong>å®šä¹‰ï¼š</strong> æŒ‡çš„æ˜¯å®Œæ•´æ‹¥æœ‰ä½ æƒ³è¦ä¸‹è½½çš„æ–‡ä»¶çš„ç”¨æˆ·æ•°é‡ã€‚</li><li><strong>å½±å“ï¼š</strong> ç§å­è¶Šå¤šï¼Œä½ ä¸‹è½½çš„é€Ÿåº¦é€šå¸¸å°±è¶Šå¿«ï¼Œå› ä¸ºä½ å¯ä»¥ä»å¤šä¸ªæ¥æºåŒæ—¶ä¸‹è½½æ•°æ®ã€‚</li><li><strong>é‡è¦æ€§ï¼š</strong> ç§å­æ•°é‡æ˜¯å½±å“ä¸‹è½½é€Ÿåº¦çš„æœ€å…³é”®å› ç´ ä¹‹ä¸€ã€‚å¦‚æœç§å­æ•°ä¸ºé›¶æˆ–å¾ˆå°‘ï¼Œä¸‹è½½é€Ÿåº¦ä¼šéå¸¸æ…¢ç”šè‡³æ— æ³•ä¸‹è½½ã€‚</li></ul></li><li><strong>èŠ‚ç‚¹æ•°é‡ï¼ˆPeersï¼‰ï¼š</strong><ul><li><strong>å®šä¹‰ï¼š</strong> æŒ‡çš„æ˜¯æ­£åœ¨ä¸‹è½½æˆ–éƒ¨åˆ†æ‹¥æœ‰è¯¥æ–‡ä»¶çš„ç”¨æˆ·æ•°é‡ã€‚</li><li><strong>å½±å“ï¼š</strong> èŠ‚ç‚¹æ•°é‡è¶Šå¤šï¼Œä½ è·å¾—æ•°æ®çš„æœºä¼šå°±è¶Šå¤šï¼Œä½†èŠ‚ç‚¹ä¸ä¸€å®šæ‹¥æœ‰å®Œæ•´æ–‡ä»¶ï¼Œæ‰€ä»¥ä¸‹è½½é€Ÿåº¦ä¸ä¸€å®šæ€»æ˜¯æ›´å¿«ã€‚</li><li><strong>åŒºåˆ«äºç§å­ï¼š</strong> èŠ‚ç‚¹å¯èƒ½åªæ‹¥æœ‰éƒ¨åˆ†æ–‡ä»¶ï¼Œè€Œç§å­æ‹¥æœ‰å®Œæ•´æ–‡ä»¶ã€‚</li></ul></li><li><strong>ç§å­è´¨é‡ (å¸¦å®½å’Œè¿æ¥æ•°):</strong><ul><li><strong>å®šä¹‰ï¼š</strong> ç§å­çš„ä¸Šä¼ å¸¦å®½å’Œè¿æ¥æ•°é™åˆ¶ã€‚</li><li><strong>å½±å“ï¼š</strong> å¦‚æœç§å­ç”¨æˆ·çš„ä¸Šä¼ å¸¦å®½å¾ˆä½æˆ–è€…è¿æ¥æ•°æœ‰é™åˆ¶ï¼Œä½ ä¸‹è½½é€Ÿåº¦ä¼šå—åˆ°é™åˆ¶ã€‚é«˜è´¨é‡çš„ç§å­ä¸Šä¼ é€Ÿåº¦å¿«ä¸”å…è®¸æ›´å¤šäººè¿æ¥ã€‚</li><li><strong>å®é™…æƒ…å†µï¼š</strong> å¾ˆå¤šç”¨æˆ·ä¸Šä¼ å¸¦å®½ä¸é«˜ï¼Œè¿™ä¹Ÿæ˜¯å½±å“ä¸‹è½½é€Ÿåº¦çš„å› ç´ ã€‚</li></ul></li><li><strong>ä½ çš„ç½‘ç»œå¸¦å®½ï¼š</strong><ul><li><strong>å®šä¹‰ï¼š</strong> ä½ çš„ç½‘ç»œæœåŠ¡æä¾›å•† (ISP) æä¾›çš„æœ€å¤§ä¸‹è½½é€Ÿåº¦ã€‚</li><li><strong>å½±å“ï¼š</strong> å¦‚æœä½ çš„ç½‘ç»œå¸¦å®½å¾ˆä½ï¼Œä¸‹è½½é€Ÿåº¦ä¼šå—åˆ°ç‰©ç†é™åˆ¶ã€‚å³ä½¿ç§å­å¾ˆå¤šï¼Œä¸‹è½½é€Ÿåº¦ä¹Ÿä¸ä¼šè¶…è¿‡ä½ çš„å¸¦å®½ä¸Šé™ã€‚</li><li><strong>é™åˆ¶ï¼š</strong> å¾ˆå¤šè¿è¥å•†å¯¹ä¸Šä¼ å’Œä¸‹è½½é€Ÿåº¦æœ‰é™åˆ¶ï¼Œæ¯”å¦‚ä¸Šè¡Œå¸¦å®½é€šå¸¸ä½äºä¸‹è¡Œå¸¦å®½ã€‚</li></ul></li><li><strong>ä½ çš„ç½‘ç»œç¯å¢ƒï¼š</strong><ul><li><strong>å®šä¹‰ï¼š</strong> ä½ çš„ç½‘ç»œè¿æ¥è´¨é‡å’Œç¨³å®šæ€§ã€‚</li><li><strong>å½±å“ï¼š</strong> å¦‚æœä½ çš„ç½‘ç»œä¸¢åŒ…ä¸¥é‡æˆ–è€…å»¶è¿Ÿå¾ˆé«˜ï¼Œä¸‹è½½é€Ÿåº¦ä¼šå—åˆ°å½±å“ã€‚ç½‘ç»œç¯å¢ƒä¸ä½³ä¼šå¯¼è‡´ä¸‹è½½ä¸ç¨³å®šï¼Œé¢‘ç¹ä¸­æ–­ã€‚</li><li><strong>NAT ç±»å‹ï¼š</strong> ç½‘ç»œåœ°å€è½¬æ¢ (NAT) ç±»å‹ä¹Ÿä¼šå½±å“ P2P è¿æ¥ï¼Œæ¯”å¦‚ä¸¥æ ¼çš„ NAT ä¼šé™åˆ¶è¿æ¥æ•°ã€‚</li></ul></li><li><strong>ä¸‹è½½å®¢æˆ·ç«¯ï¼š</strong><ul><li><strong>å®šä¹‰ï¼š</strong> ä½ ä½¿ç”¨çš„ BitTorrent å®¢æˆ·ç«¯è½¯ä»¶çš„è®¾ç½®å’Œæ€§èƒ½ã€‚</li><li><strong>å½±å“ï¼š</strong> ä¸åŒçš„å®¢æˆ·ç«¯åœ¨æ€§èƒ½ã€è¿æ¥æ•°ã€ä¼˜åŒ–ç®—æ³•ç­‰æ–¹é¢æœ‰æ‰€ä¸åŒï¼Œä¼šå½±å“ä¸‹è½½é€Ÿåº¦ã€‚</li><li><strong>ä¼˜åŒ–ï¼š</strong> å¥½çš„å®¢æˆ·ç«¯ä¼šè‡ªåŠ¨å¯»æ‰¾æœ€ä¼˜çš„è¿æ¥ï¼Œæ™ºèƒ½åˆ†é…å¸¦å®½ã€‚</li></ul></li><li><strong>æ–‡ä»¶çƒ­é—¨ç¨‹åº¦ï¼š</strong><ul><li><strong>å®šä¹‰ï¼š</strong> æ–‡ä»¶åœ¨ P2P ç½‘ç»œä¸­çš„å—æ¬¢è¿ç¨‹åº¦ã€‚</li><li><strong>å½±å“ï¼š</strong> çƒ­é—¨æ–‡ä»¶é€šå¸¸ç§å­è¾ƒå¤šï¼Œä¸‹è½½é€Ÿåº¦æ›´å¿«ï¼Œå†·é—¨æ–‡ä»¶å¯èƒ½ç¼ºå°‘ç§å­æˆ–ç§å­è´¨é‡ä¸é«˜ã€‚</li></ul></li><li><strong>DHT ç½‘ç»œå’Œ Trackerï¼š</strong><ul><li><strong>å®šä¹‰ï¼š</strong> DHT ç½‘ç»œå’Œ Tracker æœåŠ¡å™¨å¸®åŠ©å®¢æˆ·ç«¯æ‰¾åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚</li><li><strong>å½±å“ï¼š</strong> å¦‚æœ DHT ç½‘ç»œè¿æ¥ä¸å¥½æˆ–è€… Tracker æœåŠ¡å™¨ä¸ç¨³å®šï¼Œä¼šå½±å“èŠ‚ç‚¹å‘ç°å’Œä¸‹è½½é€Ÿåº¦ã€‚</li><li><strong>é‡è¦æ€§ï¼š</strong> DHT ç½‘ç»œå’Œ Tracker æœåŠ¡å™¨æ˜¯ä¿è¯ P2P ç½‘ç»œæ­£å¸¸è¿è¡Œçš„å…³é”®ç»„ä»¶ã€‚</li></ul></li></ol><p><strong>eD2k é“¾æ¥ä¸‹è½½é€Ÿåº¦çš„å½±å“å› ç´  (eDonkey2000 åè®®):</strong></p><ol><li><strong>æºæ•°é‡ (Sources):</strong><ul><li><strong>å®šä¹‰ï¼š</strong> æŒ‡çš„æ˜¯æ‹¥æœ‰ä½ æƒ³è¦ä¸‹è½½çš„æ–‡ä»¶ï¼ˆæˆ–éƒ¨åˆ†ï¼‰çš„ç”¨æˆ·æ•°é‡ã€‚</li><li><strong>å½±å“ï¼š</strong> æºè¶Šå¤šï¼Œä½ ä¸‹è½½é€Ÿåº¦é€šå¸¸å°±è¶Šå¿«ï¼Œå› ä¸ºä½ å¯ä»¥ä»å¤šä¸ªæ¥æºåŒæ—¶ä¸‹è½½æ•°æ®ã€‚</li><li><strong>å…³é”®æ€§ï¼š</strong> æºæ•°é‡æ˜¯å½±å“ eD2k ä¸‹è½½é€Ÿåº¦çš„æœ€é‡è¦å› ç´ ã€‚</li></ul></li><li><strong>ç”¨æˆ·é˜Ÿåˆ—ï¼ˆQueueï¼‰:</strong><ul><li><strong>å®šä¹‰ï¼š</strong> ä½ åœ¨æ¯ä¸ªæºç”¨æˆ·å¤„çš„ä¸‹è½½é˜Ÿåˆ—ä¸­çš„ä½ç½®ã€‚</li><li><strong>å½±å“ï¼š</strong> å¦‚æœä½ ä½äºé˜Ÿåˆ—ä¸­æ¯”è¾ƒé åçš„ä½ç½®ï¼Œä½ éœ€è¦ç­‰å¾…å‰é¢çš„ç”¨æˆ·ä¸‹è½½å®Œæ¯•ï¼Œæ‰èƒ½è½®åˆ°ä½ ã€‚</li><li><strong>ç­‰å¾…æ—¶é—´ï¼š</strong> é˜Ÿåˆ—é•¿åº¦ä¼šç›´æ¥å½±å“ä¸‹è½½çš„ç­‰å¾…æ—¶é—´ã€‚</li></ul></li><li><strong>ç”¨æˆ·å…±äº«è®¾ç½® (Credits):</strong><ul><li><strong>å®šä¹‰ï¼š</strong> eDonkey ç½‘ç»œä¸­é¼“åŠ±ç”¨æˆ·å…±äº«çš„æœºåˆ¶ã€‚ä¸Šä¼ æ›´å¤šæ•°æ®ä¼šè·å¾—æ›´é«˜çš„ä¿¡ç”¨ï¼Œä»è€Œåœ¨ä¸‹è½½é˜Ÿåˆ—ä¸­ä¼˜å…ˆã€‚</li><li><strong>å½±å“ï¼š</strong> å¦‚æœä½ æ²¡æœ‰ä¸Šä¼ è¶³å¤Ÿçš„é‡ï¼Œä¸‹è½½é€Ÿåº¦ä¼šå—åˆ°é™åˆ¶ã€‚</li><li><strong>é‡è¦æ€§ï¼š</strong> eDonkey ç½‘ç»œå¼ºè°ƒå…±äº«ç²¾ç¥ï¼Œç§¯æä¸Šä¼ æœ‰åŠ©äºæå‡ä¸‹è½½é€Ÿåº¦ã€‚</li></ul></li><li><strong>ä½ çš„ç½‘ç»œå¸¦å®½ï¼š</strong><ul><li><strong>å®šä¹‰ï¼š</strong> ä½ çš„ç½‘ç»œæœåŠ¡æä¾›å•† (ISP) æä¾›çš„æœ€å¤§ä¸‹è½½é€Ÿåº¦ã€‚</li><li><strong>å½±å“ï¼š</strong> å¦‚æœä½ çš„ç½‘ç»œå¸¦å®½å¾ˆä½ï¼Œä¸‹è½½é€Ÿåº¦ä¼šå—åˆ°ç‰©ç†é™åˆ¶ã€‚</li></ul></li><li><strong>ä½ çš„ç½‘ç»œç¯å¢ƒï¼š</strong><ul><li><strong>å®šä¹‰ï¼š</strong> ä½ çš„ç½‘ç»œè¿æ¥è´¨é‡å’Œç¨³å®šæ€§ã€‚</li><li><strong>å½±å“ï¼š</strong> å¦‚æœä½ çš„ç½‘ç»œä¸¢åŒ…ä¸¥é‡æˆ–è€…å»¶è¿Ÿå¾ˆé«˜ï¼Œä¸‹è½½é€Ÿåº¦ä¼šå—åˆ°å½±å“ã€‚</li><li><strong>NAT ç±»å‹ï¼š</strong> NAT ç±»å‹ä¹Ÿä¼šå½±å“ P2P è¿æ¥ï¼Œç‰¹åˆ«æ˜¯ä½ ID ç”¨æˆ·ï¼ˆLow IDï¼‰ä¼šå½±å“è¿æ¥å…¶ä»–ç”¨æˆ·ã€‚</li></ul></li><li><strong>ä¸‹è½½å®¢æˆ·ç«¯:</strong><ul><li><strong>å®šä¹‰ï¼š</strong> ä½ ä½¿ç”¨çš„ eDonkey å®¢æˆ·ç«¯è½¯ä»¶çš„è®¾ç½®å’Œæ€§èƒ½ã€‚</li><li><strong>å½±å“ï¼š</strong> ä¸åŒçš„å®¢æˆ·ç«¯åœ¨æ€§èƒ½ã€è¿æ¥æ•°ã€ä¼˜åŒ–ç®—æ³•ç­‰æ–¹é¢æœ‰æ‰€ä¸åŒï¼Œä¼šå½±å“ä¸‹è½½é€Ÿåº¦ã€‚</li><li><strong>é«˜IDï¼š</strong>  å®¢æˆ·ç«¯è·å–é«˜IDæœ‰åŠ©äºæå‡è¿æ¥æ•ˆç‡ã€‚</li></ul></li><li><strong>eD2k æœåŠ¡å™¨:</strong><ul><li><strong>å®šä¹‰ï¼š</strong> eD2k æœåŠ¡å™¨å¸®åŠ©å®¢æˆ·ç«¯æ‰¾åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚</li><li><strong>å½±å“ï¼š</strong> å¦‚æœæœåŠ¡å™¨ä¸ç¨³å®šæˆ–è¿æ¥è¾ƒæ…¢ï¼Œä¼šå½±å“è¿æ¥æ•ˆç‡ã€‚</li><li><strong>é‡è¦æ€§ï¼š</strong> æœåŠ¡å™¨æ˜¯ eD2k ç½‘ç»œçš„å…³é”®ç»„ä»¶ã€‚</li></ul></li></ol><h2 id="å·¥å…·å®‰è£…">å·¥å…·å®‰è£…</h2><ul><li>qbittorrent</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install qbittorrent-api</span><br><span class="line">https://www.fosshub.com/qBittorrent.html#</span><br></pre></td></tr></table></figure><ul><li>emule</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://sourceforge.net/projects/emule/files/latest/download</span><br></pre></td></tr></table></figure><h2 id="æ£€æµ‹å¯ç”¨æ€§ç­‰æŒ‡æ ‡">æ£€æµ‹å¯ç”¨æ€§ç­‰æŒ‡æ ‡</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> logging.handlers <span class="keyword">import</span> RotatingFileHandler</span><br><span class="line"></span><br><span class="line">log_dir = <span class="string">&quot;./logs&quot;</span></span><br><span class="line">log_file = os.path.join(log_dir, <span class="string">&quot;man_detect.log&quot;</span>)</span><br><span class="line">max_log_size = <span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>  <span class="comment"># 10MB</span></span><br><span class="line">backup_count = <span class="number">5</span>  <span class="comment"># æœ€å¤šä¿ç•™5ä¸ªæ—¥å¿—æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºlogsç›®å½•ï¼Œå¦‚æœä¸å­˜åœ¨</span></span><br><span class="line">os.makedirs(log_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># åˆ›å»º RotatingFileHandler å®ä¾‹</span></span><br><span class="line">log_handler = RotatingFileHandler(log_file, maxBytes=max_log_size, backupCount=backup_count, encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="comment"># è®¾ç½®æ—¥å¿—æ ¼å¼</span></span><br><span class="line">log_format = logging.Formatter(<span class="string">&#x27;%(asctime)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line">log_handler.setFormatter(log_format)</span><br><span class="line"><span class="comment"># è·å– logger å®ä¾‹</span></span><br><span class="line">logger = logging.getLogger()</span><br><span class="line">logger.setLevel(logging.INFO)</span><br><span class="line"><span class="comment"># æ·»åŠ  handler</span></span><br><span class="line">logger.addHandler(log_handler)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ æ§åˆ¶å°è¾“å‡º</span></span><br><span class="line">stream_handler = logging.StreamHandler()</span><br><span class="line">stream_handler.setFormatter(log_format)</span><br><span class="line">logger.addHandler(stream_handler)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">check_tracker</span>(<span class="params">tracker_url, timeout=<span class="number">5</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¼‚æ­¥æ£€æŸ¥å•ä¸ª Tracker æ˜¯å¦å¯ç”¨&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        parsed_url = urllib.parse.urlparse(tracker_url)</span><br><span class="line">        <span class="keyword">if</span> parsed_url.scheme <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">&#x27;udp&#x27;</span>, <span class="string">&#x27;http&#x27;</span>, <span class="string">&#x27;https&#x27;</span>):</span><br><span class="line">            logging.warning(<span class="string">f&quot;è·³è¿‡ä¸æ”¯æŒçš„åè®®: <span class="subst">&#123;parsed_url.scheme&#125;</span> in <span class="subst">&#123;tracker_url&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> parsed_url.scheme <span class="keyword">in</span> (<span class="string">&#x27;http&#x27;</span>, <span class="string">&#x27;https&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span>  <span class="comment"># å¯¹äº httpå’Œ https åè®®ä¸åšæµ‹è¯•ç›´æ¥è¿”å›æˆåŠŸã€‚</span></span><br><span class="line"></span><br><span class="line">        host = parsed_url.hostname</span><br><span class="line">        port = parsed_url.port <span class="keyword">or</span> <span class="number">80</span>  <span class="comment"># udpé»˜è®¤53ï¼Œ httpé»˜è®¤80</span></span><br><span class="line"></span><br><span class="line">        loop = asyncio.get_event_loop()</span><br><span class="line"></span><br><span class="line">        logging.info(<span class="string">f&quot;å°è¯•è¿æ¥ tracker: <span class="subst">&#123;host&#125;</span>:<span class="subst">&#123;port&#125;</span>  åè®®: <span class="subst">&#123;parsed_url.scheme&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        future = loop.create_connection(</span><br><span class="line">            <span class="keyword">lambda</span>: asyncio.Protocol(),</span><br><span class="line">            host,</span><br><span class="line">            port</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä½¿ç”¨asyncio.wait_forè®¾ç½®è¶…æ—¶</span></span><br><span class="line">        connection_tuple = <span class="keyword">await</span> asyncio.wait_for(future, timeout)</span><br><span class="line">        transport, protocol = connection_tuple</span><br><span class="line">        transport.close()</span><br><span class="line">        logging.info(<span class="string">f&quot;Tracker <span class="subst">&#123;host&#125;</span>:<span class="subst">&#123;port&#125;</span> è¿æ¥æˆåŠŸ&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> asyncio.TimeoutError:</span><br><span class="line">        logging.warning(<span class="string">f&quot;Tracker <span class="subst">&#123;tracker_url&#125;</span> è¿æ¥è¶…æ—¶&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">except</span> OSError <span class="keyword">as</span> e:</span><br><span class="line">        logging.warning(<span class="string">f&quot;Tracker <span class="subst">&#123;tracker_url&#125;</span> è¿æ¥é”™è¯¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;å¤„ç† Tracker <span class="subst">&#123;tracker_url&#125;</span> å¼‚å¸¸: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">check_magnet_link</span>(<span class="params">magnet_link, timeout=<span class="number">5</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æ£€æŸ¥ç£åŠ›é“¾æ¥æ˜¯å¦å¯ç”¨&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        parsed_magnet = urllib.parse.urlparse(magnet_link)</span><br><span class="line">        query_params = urllib.parse.parse_qs(parsed_magnet.query)</span><br><span class="line"></span><br><span class="line">        trackers = query_params.get(<span class="string">&#x27;tr&#x27;</span>, [])  <span class="comment"># è·å–æ‰€æœ‰ trackers</span></span><br><span class="line">        info_hash = query_params.get(<span class="string">&#x27;xt&#x27;</span>, [])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> trackers <span class="keyword">or</span> <span class="keyword">not</span> info_hash:</span><br><span class="line">            logging.warning(<span class="string">f&quot;ç£åŠ›é“¾ä¸å®Œæ•´: <span class="subst">&#123;magnet_link&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        info_hash = info_hash[<span class="number">0</span>].split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">2</span>] <span class="keyword">if</span> info_hash[<span class="number">0</span>].startswith(<span class="string">&quot;urn:btih:&quot;</span>) <span class="keyword">else</span> info_hash[<span class="number">0</span>]</span><br><span class="line">        logging.info(<span class="string">f&quot;å¼€å§‹æ£€æŸ¥ç£åŠ›é“¾: <span class="subst">&#123;magnet_link&#125;</span> ,info_hash: <span class="subst">&#123;info_hash&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        tracker_tasks = [check_tracker(tracker, timeout) <span class="keyword">for</span> tracker <span class="keyword">in</span> trackers]</span><br><span class="line"></span><br><span class="line">        results = <span class="keyword">await</span> asyncio.gather(*tracker_tasks)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">any</span>(results):</span><br><span class="line">            logging.info(<span class="string">f&quot;ç£åŠ›é“¾ <span class="subst">&#123;magnet_link&#125;</span> æœ‰æ•ˆ&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logging.info(<span class="string">f&quot;ç£åŠ›é“¾ <span class="subst">&#123;magnet_link&#125;</span> æ— æ•ˆ&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;å¤„ç†ç£åŠ›é“¾ <span class="subst">&#123;magnet_link&#125;</span> å¼‚å¸¸: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_check_ed2k_emule</span>(<span class="params">ed2k_link, emule_path, timeout=<span class="number">20</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; åŒæ­¥çš„ eMule å‘½ä»¤è¡Œæ£€æµ‹å‡½æ•°ï¼Œä¸åº”ç›´æ¥åœ¨asyncioçº¿ç¨‹è°ƒç”¨ &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 1. æ·»åŠ  ed2k é“¾æ¥</span></span><br><span class="line">        add_cmd = [emule_path, <span class="string">&quot;-add&quot;</span>, ed2k_link]</span><br><span class="line">        add_process = subprocess.run(add_cmd, capture_output=<span class="literal">True</span>, text=<span class="literal">True</span>, check=<span class="literal">False</span>, timeout=<span class="number">10</span>)</span><br><span class="line">        <span class="keyword">if</span> add_process.returncode != <span class="number">0</span>:</span><br><span class="line">            logging.warning(<span class="string">f&quot;æ·»åŠ  ed2k é“¾æ¥å¤±è´¥ï¼š<span class="subst">&#123;add_process.stderr.strip()&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="comment"># 2. è·å–ä¸‹è½½çŠ¶æ€</span></span><br><span class="line">        start_time = time.time()</span><br><span class="line">        <span class="keyword">while</span> time.time() - start_time &lt; timeout:</span><br><span class="line">            status_cmd = [emule_path, <span class="string">&quot;-show&quot;</span>, <span class="string">&quot;-complete&quot;</span>]  <span class="comment"># show all downloading files</span></span><br><span class="line">            status_process = subprocess.run(status_cmd, capture_output=<span class="literal">True</span>, text=<span class="literal">True</span>, check=<span class="literal">False</span>)</span><br><span class="line">            <span class="keyword">if</span> status_process.returncode == <span class="number">0</span>:</span><br><span class="line">                output = status_process.stdout</span><br><span class="line">                <span class="comment"># æ­£åˆ™åŒ¹é… ed2k é“¾æ¥ æˆ–æ–‡ä»¶å</span></span><br><span class="line">                pattern = re.<span class="built_in">compile</span>(re.escape(os.path.basename(ed2k_link)) <span class="keyword">or</span> re.escape(ed2k_link), re.IGNORECASE)</span><br><span class="line">                <span class="keyword">if</span> pattern.search(output):</span><br><span class="line">                    <span class="comment"># çŠ¶æ€åŒ¹é…ï¼Œå¦‚æœçŠ¶æ€å­˜åœ¨åˆ™å¯èƒ½å¯ç”¨</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="string">&quot;Downloading&quot;</span> <span class="keyword">in</span> output <span class="keyword">or</span> <span class="string">&quot;Connecting&quot;</span> <span class="keyword">in</span> output <span class="keyword">or</span> <span class="string">&quot;Queued&quot;</span> <span class="keyword">in</span> output <span class="keyword">or</span> <span class="string">&quot;Waiting&quot;</span> <span class="keyword">in</span> output:</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        logging.warning(<span class="string">f&quot;eMule é“¾æ¥çŠ¶æ€ä¸åœ¨é¢„æœŸçŠ¶æ€ï¼š<span class="subst">&#123;output&#125;</span>&quot;</span>)</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    logging.warning(<span class="string">f&quot;eMule æœªæ‰¾åˆ°æŒ‡å®šé“¾æ¥ï¼š<span class="subst">&#123;output&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                logging.warning(<span class="string">f&quot;è·å– eMule çŠ¶æ€å¤±è´¥ï¼š<span class="subst">&#123;status_process.stderr.strip()&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            time.sleep(<span class="number">2</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;æ£€æŸ¥ ed2k é“¾æ¥æ—¶å‘ç”Ÿå¼‚å¸¸: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">check_ed2k_emule</span>(<span class="params">ed2k_link, emule_path, timeout=<span class="number">20</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¼‚æ­¥çš„ eMule å‘½ä»¤è¡Œæ£€æµ‹å‡½æ•°&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = <span class="keyword">await</span> asyncio.to_thread(_check_ed2k_emule, ed2k_link, emule_path, timeout)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;è°ƒç”¨å¼‚æ­¥ eMule æ£€æµ‹å‡½æ•°å‘ç”Ÿå¼‚å¸¸:<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_get_column_index</span>(<span class="params">header, column_names</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; æŸ¥æ‰¾ç¬¬ä¸€ä¸ªåŒ¹é…çš„åˆ—åï¼Œè¿”å›ç´¢å¼•ï¼Œå¦åˆ™è¿”å›-1 &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> header:</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> column_names:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> header.index(name)</span><br><span class="line">        <span class="keyword">except</span> ValueError:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">process_csv_file</span>(<span class="params">file_path, magnet_column_names, ed2k_column_names=<span class="literal">None</span>, emule_path=<span class="literal">None</span>, use_ed2k=<span class="literal">False</span>,</span></span><br><span class="line"><span class="params">                           timeout=<span class="number">5</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¤„ç†å•ä¸ª CSV æ–‡ä»¶ï¼Œå¹¶éªŒè¯å…¶ä¸­çš„ç£åŠ›é“¾æ¥å’Œed2ké“¾æ¥, è¿”å›å¯ç”¨çš„ç£åŠ›é“¾æ¥åˆ—è¡¨, ä¿ç•™åŸå§‹æ•°æ®&quot;&quot;&quot;</span></span><br><span class="line">    logging.info(<span class="string">f&quot;å¼€å§‹å¤„ç† CSV æ–‡ä»¶: <span class="subst">&#123;file_path&#125;</span>&quot;</span>)</span><br><span class="line">    available_rows = []</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>, errors=<span class="string">&#x27;ignore&#x27;</span>) <span class="keyword">as</span> csvfile:</span><br><span class="line">            reader = csv.reader(csvfile)</span><br><span class="line">            header = <span class="built_in">next</span>(reader, <span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> header:</span><br><span class="line">                logging.warning(<span class="string">f&quot;CSVæ–‡ä»¶ä¸ºç©º: <span class="subst">&#123;file_path&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> available_rows</span><br><span class="line"></span><br><span class="line">            magnet_column_index = _get_column_index(header, magnet_column_names)</span><br><span class="line">            <span class="keyword">if</span> magnet_column_index == -<span class="number">1</span>:</span><br><span class="line">                logging.error(<span class="string">f&quot;ç£åŠ›é“¾åˆ—ååˆ—è¡¨ &#x27;<span class="subst">&#123;magnet_column_names&#125;</span>&#x27; åœ¨ CSV æ–‡ä»¶ä¸­æœªæ‰¾åˆ°: <span class="subst">&#123;file_path&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> available_rows</span><br><span class="line">            ed2k_column_index = -<span class="number">1</span>  <span class="comment"># é»˜è®¤å€¼</span></span><br><span class="line">            <span class="keyword">if</span> use_ed2k <span class="keyword">and</span> ed2k_column_names:</span><br><span class="line">                ed2k_column_index = _get_column_index(header, ed2k_column_names)</span><br><span class="line">                <span class="keyword">if</span> ed2k_column_index == -<span class="number">1</span>:</span><br><span class="line">                    logging.error(<span class="string">f&quot;ed2kåˆ—ååˆ—è¡¨ &#x27;<span class="subst">&#123;ed2k_column_names&#125;</span>&#x27; åœ¨ CSV æ–‡ä»¶ä¸­æœªæ‰¾åˆ°: <span class="subst">&#123;file_path&#125;</span>&quot;</span>)</span><br><span class="line">                    use_ed2k = <span class="literal">False</span>  <span class="comment"># å…³é—­ed2k</span></span><br><span class="line"></span><br><span class="line">            link_tasks = []</span><br><span class="line">            rows = []</span><br><span class="line">            <span class="keyword">for</span> row <span class="keyword">in</span> reader:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">len</span>(row) &gt; magnet_column_index <span class="keyword">and</span> row[magnet_column_index]:</span><br><span class="line">                        magnet_link = row[magnet_column_index]</span><br><span class="line">                        link_tasks.append(check_magnet_link(magnet_link, timeout))</span><br><span class="line">                        rows.append(row)  <span class="comment"># å­˜å‚¨è¡Œæ•°æ®</span></span><br><span class="line">                    <span class="keyword">elif</span> use_ed2k <span class="keyword">and</span> <span class="built_in">len</span>(row) &gt; ed2k_column_index <span class="keyword">and</span> row[ed2k_column_index]:</span><br><span class="line">                        ed2k_link = row[ed2k_column_index]</span><br><span class="line">                        link_tasks.append(check_ed2k_emule(ed2k_link, emule_path))</span><br><span class="line">                        rows.append(row)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        logging.warning(<span class="string">f&quot;è·³è¿‡æ— æ•ˆè¡Œï¼Œé“¾æ¥ç´¢å¼•è¶…å‡ºèŒƒå›´æˆ–ä¸ºç©º, æ–‡ä»¶:<span class="subst">&#123;file_path&#125;</span>, è¡Œæ•°æ®: <span class="subst">&#123;row&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    logging.error(<span class="string">f&quot;è·³è¿‡æ— æ•ˆè¡Œï¼Œå¤„ç†è¡Œæ•°æ®å¼‚å¸¸ï¼Œ æ–‡ä»¶:<span class="subst">&#123;file_path&#125;</span>, è¡Œæ•°æ®: <span class="subst">&#123;row&#125;</span>, å¼‚å¸¸: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            results = <span class="keyword">await</span> asyncio.gather(*link_tasks)</span><br><span class="line"></span><br><span class="line">            available_rows = [row <span class="keyword">for</span> row, is_valid <span class="keyword">in</span> <span class="built_in">zip</span>(rows, results) <span class="keyword">if</span> is_valid]</span><br><span class="line">            logging.info(<span class="string">f&quot;CSV æ–‡ä»¶å¤„ç†å®Œæ¯•: <span class="subst">&#123;file_path&#125;</span>ï¼Œ æ‰¾åˆ°äº† <span class="subst">&#123;<span class="built_in">len</span>(available_rows)&#125;</span> ä¸ªå¯ç”¨çš„é“¾æ¥&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> header <span class="keyword">and</span> available_rows:  <span class="comment"># å°†header æ’å…¥</span></span><br><span class="line">                available_rows.insert(<span class="number">0</span>, header)</span><br><span class="line">            <span class="keyword">return</span> available_rows</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;å¤„ç†CSVæ–‡ä»¶å¼‚å¸¸ï¼š<span class="subst">&#123;file_path&#125;</span>, å¼‚å¸¸ï¼š<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">directory, magnet_column_names, output_directory, ed2k_column_names=<span class="literal">None</span>, emule_path=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">               use_ed2k=<span class="literal">False</span>, timeout=<span class="number">5</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä¸»å‡½æ•°ï¼Œéå†ç›®å½•ä¸­çš„ CSV æ–‡ä»¶ï¼ŒéªŒè¯ç£åŠ›é“¾æ¥ï¼Œå¹¶å°†ç»“æœæŒ‰æ–‡ä»¶åè¾“å‡ºåˆ°æ–°çš„ CSV æ–‡ä»¶&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(directory):</span><br><span class="line">        logging.error(<span class="string">f&quot;æŒ‡å®šçš„ç›®å½•ä¸å­˜åœ¨: <span class="subst">&#123;directory&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(output_directory):</span><br><span class="line">        os.makedirs(output_directory)</span><br><span class="line"></span><br><span class="line">    csv_tasks = []</span><br><span class="line">    <span class="keyword">for</span> dirpath, _, filenames <span class="keyword">in</span> os.walk(directory):</span><br><span class="line">        <span class="keyword">for</span> filename <span class="keyword">in</span> filenames:</span><br><span class="line">            <span class="keyword">if</span> filename.lower().endswith(<span class="string">&#x27;.csv&#x27;</span>):</span><br><span class="line">                file_path = os.path.join(dirpath, filename)</span><br><span class="line">                csv_tasks.append(</span><br><span class="line">                    process_csv_file(file_path, magnet_column_names, ed2k_column_names, emule_path, use_ed2k, timeout))</span><br><span class="line"></span><br><span class="line">    results = <span class="keyword">await</span> asyncio.gather(*csv_tasks)</span><br><span class="line"></span><br><span class="line">    csv_files = []</span><br><span class="line">    <span class="keyword">for</span> dirpath, _, filenames <span class="keyword">in</span> os.walk(directory):</span><br><span class="line">        <span class="keyword">for</span> filename <span class="keyword">in</span> filenames:</span><br><span class="line">            <span class="keyword">if</span> filename.lower().endswith(<span class="string">&#x27;.csv&#x27;</span>):</span><br><span class="line">                csv_files.append(os.path.join(dirpath, filename))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> filename, available_rows <span class="keyword">in</span> <span class="built_in">zip</span>(</span><br><span class="line">            csv_files, results):</span><br><span class="line"></span><br><span class="line">        output_file_path = os.path.join(output_directory, os.path.relpath(filename, directory))  <span class="comment"># åˆ›å»ºç›¸å¯¹è·¯å¾„ï¼Œä¿ç•™ç›®å½•ç»“æ„</span></span><br><span class="line">        os.makedirs(os.path.dirname(output_file_path), exist_ok=<span class="literal">True</span>)  <span class="comment"># åˆ›å»ºè¾“å‡ºç›®å½•</span></span><br><span class="line">        logging.info(</span><br><span class="line">            <span class="string">f&quot;å¼€å§‹å†™å…¥ <span class="subst">&#123;<span class="built_in">len</span>(available_rows) - <span class="number">1</span> <span class="keyword">if</span> available_rows <span class="keyword">else</span> <span class="number">0</span>&#125;</span> æ¡å¯ç”¨é“¾æ¥åˆ°æ–‡ä»¶ï¼š<span class="subst">&#123;output_file_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> available_rows:</span><br><span class="line">            logging.info(<span class="string">f&quot;CSVæ–‡ä»¶ <span class="subst">&#123;filename&#125;</span> ä¸­æ²¡æœ‰å¯ç”¨çš„é“¾æ¥&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span>  <span class="comment"># å¦‚æœå½“å‰æ–‡ä»¶æ²¡æœ‰æœ‰æ•ˆé“¾æ¥ï¼Œåˆ™è·³è¿‡</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(output_file_path, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>, newline=<span class="string">&#x27;&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                writer = csv.writer(f)</span><br><span class="line">                writer.writerows(available_rows)  <span class="comment"># å†™å…¥æ‰€æœ‰è¡Œ</span></span><br><span class="line">            logging.info(<span class="string">f&quot;æˆåŠŸå†™å…¥å¯ç”¨é“¾æ¥åˆ°æ–‡ä»¶: <span class="subst">&#123;output_file_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logging.error(<span class="string">f&quot;å†™å…¥æ–‡ä»¶ <span class="subst">&#123;output_file_path&#125;</span> å¤±è´¥: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    target_directory = <span class="string">r&quot;D:\pythonProject\audio_record_server\src\utils\data\man_link&quot;</span>  <span class="comment"># æŒ‡å®š CSV æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•</span></span><br><span class="line">    magnet_column_names = [<span class="string">&quot;ç£åŠ›é“¾&quot;</span>, <span class="string">&quot;ç£åŠ›é“¾æ¥&quot;</span>]  <span class="comment"># æŒ‡å®šç£åŠ›é“¾æ‰€åœ¨çš„åˆ—ååˆ—è¡¨</span></span><br><span class="line">    ed2k_column_names = [<span class="string">&quot;ç£åŠ›é“¾&quot;</span>, <span class="string">&quot;ç£åŠ›é“¾æ¥&quot;</span>]  <span class="comment"># æŒ‡å®šed2k æ‰€åœ¨çš„åˆ—ååˆ—è¡¨</span></span><br><span class="line">    output_dir = <span class="string">r&quot;D:\pythonProject\audio_record_server\src\utils\data&quot;</span>  <span class="comment"># æŒ‡å®šè¾“å‡ºç›®å½•</span></span><br><span class="line">    link_timeout = <span class="number">5</span>  <span class="comment"># è®¾ç½®è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œç§’</span></span><br><span class="line">    emule_path = <span class="string">r&quot;C:\Program Files (x86)\eMule\emule.exe&quot;</span>  <span class="comment"># é…ç½® eMule å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ (æ ¹æ®ä½ çš„å®‰è£…è·¯å¾„ä¿®æ”¹)</span></span><br><span class="line">    use_ed2k = <span class="literal">True</span>  <span class="comment"># æ˜¯å¦å¯ç”¨ed2kæ£€æµ‹</span></span><br><span class="line"></span><br><span class="line">    asyncio.run(</span><br><span class="line">        main(target_directory, magnet_column_names, output_dir, ed2k_column_names, emule_path, use_ed2k, link_timeout))</span><br></pre></td></tr></table></figure><h2 id="æ£€æµ‹é€Ÿç‡ç­‰æŒ‡æ ‡å®ç°">æ£€æµ‹é€Ÿç‡ç­‰æŒ‡æ ‡å®ç°</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _*_ coding: utf-8 _*_</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Time:     2025/1/22 11:02</span></span><br><span class="line"><span class="string">Author:   ZhaoQi Cao(czq)</span></span><br><span class="line"><span class="string">Version:  V 0.1</span></span><br><span class="line"><span class="string">File:     link_benck_mark.py</span></span><br><span class="line"><span class="string">Describe: Write during the python at zgxmt, Github link: https://github.com/caozhaoqi</span></span><br><span class="line"><span class="string">link: https://www.fosshub.com/qBittorrent.html#</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> qbittorrentapi <span class="keyword">import</span> Client, LoginFailed</span><br><span class="line"></span><br><span class="line">logging.basicConfig(level=logging.INFO, <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">check_tracker</span>(<span class="params">tracker_url, timeout=<span class="number">5</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¼‚æ­¥æ£€æŸ¥å•ä¸ª Tracker æ˜¯å¦å¯ç”¨&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        parsed_url = urllib.parse.urlparse(tracker_url)</span><br><span class="line">        <span class="keyword">if</span> parsed_url.scheme <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">&#x27;udp&#x27;</span>, <span class="string">&#x27;http&#x27;</span>, <span class="string">&#x27;https&#x27;</span>):</span><br><span class="line">            logging.warning(<span class="string">f&quot;è·³è¿‡ä¸æ”¯æŒçš„åè®®: <span class="subst">&#123;parsed_url.scheme&#125;</span> in <span class="subst">&#123;tracker_url&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> parsed_url.scheme <span class="keyword">in</span> (<span class="string">&#x27;http&#x27;</span>, <span class="string">&#x27;https&#x27;</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span>  <span class="comment"># å¯¹äº httpå’Œ https åè®®ä¸åšæµ‹è¯•ç›´æ¥è¿”å›æˆåŠŸã€‚</span></span><br><span class="line"></span><br><span class="line">        host = parsed_url.hostname</span><br><span class="line">        port = parsed_url.port <span class="keyword">or</span> <span class="number">80</span>  <span class="comment"># udpé»˜è®¤53ï¼Œ httpé»˜è®¤80</span></span><br><span class="line"></span><br><span class="line">        loop = asyncio.get_event_loop()</span><br><span class="line"></span><br><span class="line">        logging.info(<span class="string">f&quot;å°è¯•è¿æ¥ tracker: <span class="subst">&#123;host&#125;</span>:<span class="subst">&#123;port&#125;</span>  åè®®: <span class="subst">&#123;parsed_url.scheme&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        future = loop.create_connection(</span><br><span class="line">            <span class="keyword">lambda</span>: asyncio.Protocol(),</span><br><span class="line">            host,</span><br><span class="line">            port</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä½¿ç”¨asyncio.wait_forè®¾ç½®è¶…æ—¶</span></span><br><span class="line">        connection_tuple = <span class="keyword">await</span> asyncio.wait_for(future, timeout)</span><br><span class="line">        transport, protocol = connection_tuple</span><br><span class="line">        transport.close()</span><br><span class="line">        logging.info(<span class="string">f&quot;Tracker <span class="subst">&#123;host&#125;</span>:<span class="subst">&#123;port&#125;</span> è¿æ¥æˆåŠŸ&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> asyncio.TimeoutError:</span><br><span class="line">        logging.warning(<span class="string">f&quot;Tracker <span class="subst">&#123;tracker_url&#125;</span> è¿æ¥è¶…æ—¶&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">except</span> OSError <span class="keyword">as</span> e:</span><br><span class="line">        logging.warning(<span class="string">f&quot;Tracker <span class="subst">&#123;tracker_url&#125;</span> è¿æ¥é”™è¯¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;å¤„ç† Tracker <span class="subst">&#123;tracker_url&#125;</span> å¼‚å¸¸: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">check_magnet_link</span>(<span class="params">magnet_link, timeout=<span class="number">5</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æ£€æŸ¥ç£åŠ›é“¾æ¥æ˜¯å¦å¯ç”¨&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        parsed_magnet = urllib.parse.urlparse(magnet_link)</span><br><span class="line">        query_params = urllib.parse.parse_qs(parsed_magnet.query)</span><br><span class="line"></span><br><span class="line">        trackers = query_params.get(<span class="string">&#x27;tr&#x27;</span>, [])  <span class="comment"># è·å–æ‰€æœ‰ trackers</span></span><br><span class="line">        info_hash = query_params.get(<span class="string">&#x27;xt&#x27;</span>, [])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> trackers <span class="keyword">or</span> <span class="keyword">not</span> info_hash:</span><br><span class="line">            logging.warning(<span class="string">f&quot;ç£åŠ›é“¾ä¸å®Œæ•´: <span class="subst">&#123;magnet_link&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        info_hash = info_hash[<span class="number">0</span>].split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">2</span>] <span class="keyword">if</span> info_hash[<span class="number">0</span>].startswith(<span class="string">&quot;urn:btih:&quot;</span>) <span class="keyword">else</span> info_hash[<span class="number">0</span>]</span><br><span class="line">        logging.info(<span class="string">f&quot;å¼€å§‹æ£€æŸ¥ç£åŠ›é“¾: <span class="subst">&#123;magnet_link&#125;</span> ,info_hash: <span class="subst">&#123;info_hash&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        tracker_tasks = [check_tracker(tracker, timeout) <span class="keyword">for</span> tracker <span class="keyword">in</span> trackers]</span><br><span class="line"></span><br><span class="line">        results = <span class="keyword">await</span> asyncio.gather(*tracker_tasks)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">any</span>(results):</span><br><span class="line">            logging.info(<span class="string">f&quot;ç£åŠ›é“¾ <span class="subst">&#123;magnet_link&#125;</span> æœ‰æ•ˆ&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logging.info(<span class="string">f&quot;ç£åŠ›é“¾ <span class="subst">&#123;magnet_link&#125;</span> æ— æ•ˆ&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;å¤„ç†ç£åŠ›é“¾ <span class="subst">&#123;magnet_link&#125;</span> å¼‚å¸¸: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_check_ed2k_emule</span>(<span class="params">ed2k_link, emule_path, timeout=<span class="number">20</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; åŒæ­¥çš„ eMule å‘½ä»¤è¡Œæ£€æµ‹å‡½æ•°ï¼Œä¸åº”ç›´æ¥åœ¨asyncioçº¿ç¨‹è°ƒç”¨ &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 1. æ·»åŠ  ed2k é“¾æ¥</span></span><br><span class="line">        add_cmd = [emule_path, <span class="string">&quot;-add&quot;</span>, ed2k_link]</span><br><span class="line">        add_process = subprocess.run(add_cmd, capture_output=<span class="literal">True</span>, text=<span class="literal">True</span>, check=<span class="literal">False</span>, timeout=<span class="number">10</span>)</span><br><span class="line">        <span class="keyword">if</span> add_process.returncode != <span class="number">0</span>:</span><br><span class="line">            logging.warning(<span class="string">f&quot;æ·»åŠ  ed2k é“¾æ¥å¤±è´¥ï¼š<span class="subst">&#123;add_process.stderr.strip()&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="comment"># 2. è·å–ä¸‹è½½çŠ¶æ€</span></span><br><span class="line">        start_time = time.time()</span><br><span class="line">        <span class="keyword">while</span> time.time() - start_time &lt; timeout:</span><br><span class="line">            status_cmd = [emule_path, <span class="string">&quot;-show&quot;</span>, <span class="string">&quot;-complete&quot;</span>]  <span class="comment"># show all downloading files</span></span><br><span class="line">            status_process = subprocess.run(status_cmd, capture_output=<span class="literal">True</span>, text=<span class="literal">True</span>, check=<span class="literal">False</span>)</span><br><span class="line">            <span class="keyword">if</span> status_process.returncode == <span class="number">0</span>:</span><br><span class="line">                output = status_process.stdout</span><br><span class="line">                <span class="comment"># æ­£åˆ™åŒ¹é… ed2k é“¾æ¥ æˆ–æ–‡ä»¶å</span></span><br><span class="line">                pattern = re.<span class="built_in">compile</span>(re.escape(os.path.basename(ed2k_link)) <span class="keyword">or</span> re.escape(ed2k_link), re.IGNORECASE)</span><br><span class="line">                <span class="keyword">if</span> pattern.search(output):</span><br><span class="line">                    <span class="comment"># çŠ¶æ€åŒ¹é…ï¼Œå¦‚æœçŠ¶æ€å­˜åœ¨åˆ™å¯èƒ½å¯ç”¨</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="string">&quot;Downloading&quot;</span> <span class="keyword">in</span> output <span class="keyword">or</span> <span class="string">&quot;Connecting&quot;</span> <span class="keyword">in</span> output <span class="keyword">or</span> <span class="string">&quot;Queued&quot;</span> <span class="keyword">in</span> output <span class="keyword">or</span> <span class="string">&quot;Waiting&quot;</span> <span class="keyword">in</span> output:</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        logging.warning(<span class="string">f&quot;eMule é“¾æ¥çŠ¶æ€ä¸åœ¨é¢„æœŸçŠ¶æ€ï¼š<span class="subst">&#123;output&#125;</span>&quot;</span>)</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    logging.warning(<span class="string">f&quot;eMule æœªæ‰¾åˆ°æŒ‡å®šé“¾æ¥ï¼š<span class="subst">&#123;output&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                logging.warning(<span class="string">f&quot;è·å– eMule çŠ¶æ€å¤±è´¥ï¼š<span class="subst">&#123;status_process.stderr.strip()&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            time.sleep(<span class="number">2</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;æ£€æŸ¥ ed2k é“¾æ¥æ—¶å‘ç”Ÿå¼‚å¸¸: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">check_ed2k_emule</span>(<span class="params">ed2k_link, emule_path, timeout=<span class="number">20</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¼‚æ­¥çš„ eMule å‘½ä»¤è¡Œæ£€æµ‹å‡½æ•°&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = <span class="keyword">await</span> asyncio.to_thread(_check_ed2k_emule, ed2k_link, emule_path, timeout)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;è°ƒç”¨å¼‚æ­¥ eMule æ£€æµ‹å‡½æ•°å‘ç”Ÿå¼‚å¸¸:<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_bittorrent_info</span>(<span class="params">magnet_link, qbt_host=<span class="string">&#x27;127.0.0.1&#x27;</span>, qbt_port=<span class="number">8080</span>, qbt_user=<span class="string">&#x27;admin&#x27;</span>,</span></span><br><span class="line"><span class="params">                              qbt_pass=<span class="string">&#x27;adminadmin&#x27;</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä½¿ç”¨ qBittorrent API è·å–ç£åŠ›é“¾æ¥ä¿¡æ¯ (ç¤ºä¾‹)ã€‚&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        client = Client(host=qbt_host, port=qbt_port, username=qbt_user, password=qbt_pass)</span><br><span class="line">        client.auth_log_in()  <span class="comment"># ç™»å½•å®¢æˆ·ç«¯</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ·»åŠ ç£åŠ›é“¾æ¥</span></span><br><span class="line">        torrent = client.torrents_add(magnet_link)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> torrent:</span><br><span class="line">            logging.info(<span class="string">f&quot;æˆåŠŸæ·»åŠ ç£åŠ›é“¾åˆ° qBittorrent: <span class="subst">&#123;magnet_link&#125;</span>&quot;</span>)</span><br><span class="line">            start_time = time.time()</span><br><span class="line">            <span class="keyword">while</span> time.time() - start_time &lt; <span class="number">30</span>:  <span class="comment"># æœ€é•¿ç­‰å¾…30ç§’</span></span><br><span class="line">                <span class="comment"># ç­‰å¾…ç§å­æ·»åŠ å®Œæˆ</span></span><br><span class="line">                torrent = client.torrents_info(torrent_hashes=torrent.<span class="built_in">hash</span>)[<span class="number">0</span>]</span><br><span class="line">                <span class="keyword">if</span> torrent.state <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">&quot;stalledDL&quot;</span>, <span class="string">&quot;queuedDL&quot;</span>, <span class="string">&quot;checkingDL&quot;</span>):</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)  <span class="comment"># é˜²æ­¢CPUè¿‡é«˜</span></span><br><span class="line">            <span class="keyword">if</span> torrent.state <span class="keyword">in</span> (<span class="string">&quot;stalledDL&quot;</span>, <span class="string">&quot;queuedDL&quot;</span>, <span class="string">&quot;checkingDL&quot;</span>):</span><br><span class="line">                logging.warning(<span class="string">f&quot;qBittorrent æ·»åŠ ç£åŠ›é“¾åè¶…æ—¶: <span class="subst">&#123;magnet_link&#125;</span> ,çŠ¶æ€:<span class="subst">&#123;torrent.state&#125;</span>&quot;</span>)</span><br><span class="line">                client.torrents_delete(delete_files=<span class="literal">True</span>, torrent_hashes=torrent.<span class="built_in">hash</span>)</span><br><span class="line">                <span class="keyword">return</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">            seeders = torrent.num_seeds</span><br><span class="line">            peers = torrent.num_peers</span><br><span class="line">            progress = torrent.progress</span><br><span class="line">            down_speed = torrent.dlspeed</span><br><span class="line">            up_speed = torrent.upspeed</span><br><span class="line">            <span class="comment"># åˆ é™¤torrent</span></span><br><span class="line">            client.torrents_delete(delete_files=<span class="literal">True</span>, torrent_hashes=torrent.<span class="built_in">hash</span>)</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;seeders&quot;</span>: seeders,</span><br><span class="line">                <span class="string">&quot;peers&quot;</span>: peers,</span><br><span class="line">                <span class="string">&quot;progress&quot;</span>: progress,</span><br><span class="line">                <span class="string">&quot;down_speed&quot;</span>: down_speed,</span><br><span class="line">                <span class="string">&quot;up_speed&quot;</span>: up_speed,</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logging.warning(<span class="string">f&quot;qBittorrent æ·»åŠ ç£åŠ›é“¾å¤±è´¥: <span class="subst">&#123;magnet_link&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">except</span> LoginFailed:</span><br><span class="line">        logging.error(<span class="string">f&quot;qBittorrentç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥åœ°å€ï¼Œç”¨æˆ·åå’Œå¯†ç ï¼š&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;è·å– BitTorrent ä¿¡æ¯æ—¶å‘ç”Ÿå¼‚å¸¸: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_ed2k_info</span>(<span class="params">ed2k_link, timeout=<span class="number">20</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    å°è¯•è§£æ ed2k é“¾æ¥ï¼Œæå–æ–‡ä»¶åï¼Œå¤§å°ã€‚</span></span><br><span class="line"><span class="string">    æ³¨æ„ï¼šè¿™ä»…ä»…æ˜¯è§£æé“¾æ¥ä¿¡æ¯ï¼Œæ— æ³•è·å–å®æ—¶ä¸‹è½½çŠ¶æ€ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ed2k_link:</span><br><span class="line">            <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">        file_name = <span class="literal">None</span></span><br><span class="line">        file_size = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">match</span> = re.<span class="keyword">match</span>(<span class="string">r&#x27;ed2k:\/\/\|file\|(.+?)\|(\d+)\|.+&#x27;</span>, ed2k_link)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">            file_name = <span class="keyword">match</span>.group(<span class="number">1</span>)</span><br><span class="line">            file_size = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;file_name&quot;</span>: file_name,</span><br><span class="line">            <span class="string">&quot;file_size&quot;</span>: file_size</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;è§£æ ed2k é“¾æ¥å¤±è´¥: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_get_column_index</span>(<span class="params">header, column_names</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; æŸ¥æ‰¾ç¬¬ä¸€ä¸ªåŒ¹é…çš„åˆ—åï¼Œè¿”å›ç´¢å¼•ï¼Œå¦åˆ™è¿”å›-1 &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> header:</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> column_names:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> header.index(name)</span><br><span class="line">        <span class="keyword">except</span> ValueError:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">process_csv_file</span>(<span class="params">file_path, magnet_column_names, ed2k_column_names=<span class="literal">None</span>, emule_path=<span class="literal">None</span>, use_ed2k=<span class="literal">False</span>,</span></span><br><span class="line"><span class="params">                           qbt_host=<span class="string">&#x27;127.0.0.1&#x27;</span>, qbt_port=<span class="number">8080</span>, qbt_user=<span class="string">&#x27;admin&#x27;</span>,</span></span><br><span class="line"><span class="params">                           qbt_pass=<span class="string">&#x27;adminadmin&#x27;</span>, timeout=<span class="number">5</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¤„ç†å•ä¸ª CSV æ–‡ä»¶ï¼Œå¹¶éªŒè¯å…¶ä¸­çš„ç£åŠ›é“¾æ¥å’Œed2ké“¾æ¥, è¿”å›å¯ç”¨çš„ç£åŠ›é“¾æ¥åˆ—è¡¨, ä¿ç•™åŸå§‹æ•°æ®&quot;&quot;&quot;</span></span><br><span class="line">    logging.info(<span class="string">f&quot;å¼€å§‹å¤„ç† CSV æ–‡ä»¶: <span class="subst">&#123;file_path&#125;</span>&quot;</span>)</span><br><span class="line">    available_rows = []</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>, errors=<span class="string">&#x27;ignore&#x27;</span>) <span class="keyword">as</span> csvfile:</span><br><span class="line">            reader = csv.reader(csvfile)</span><br><span class="line">            header = <span class="built_in">next</span>(reader, <span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> header:</span><br><span class="line">                logging.warning(<span class="string">f&quot;CSVæ–‡ä»¶ä¸ºç©º: <span class="subst">&#123;file_path&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> available_rows</span><br><span class="line"></span><br><span class="line">            magnet_column_index = _get_column_index(header, magnet_column_names)</span><br><span class="line">            <span class="keyword">if</span> magnet_column_index == -<span class="number">1</span>:</span><br><span class="line">                logging.error(<span class="string">f&quot;ç£åŠ›é“¾åˆ—ååˆ—è¡¨ &#x27;<span class="subst">&#123;magnet_column_names&#125;</span>&#x27; åœ¨ CSV æ–‡ä»¶ä¸­æœªæ‰¾åˆ°: <span class="subst">&#123;file_path&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> available_rows</span><br><span class="line">            ed2k_column_index = -<span class="number">1</span>  <span class="comment"># é»˜è®¤å€¼</span></span><br><span class="line">            <span class="keyword">if</span> use_ed2k <span class="keyword">and</span> ed2k_column_names:</span><br><span class="line">                ed2k_column_index = _get_column_index(header, ed2k_column_names)</span><br><span class="line">                <span class="keyword">if</span> ed2k_column_index == -<span class="number">1</span>:</span><br><span class="line">                    logging.error(<span class="string">f&quot;ed2kåˆ—ååˆ—è¡¨ &#x27;<span class="subst">&#123;ed2k_column_names&#125;</span>&#x27; åœ¨ CSV æ–‡ä»¶ä¸­æœªæ‰¾åˆ°: <span class="subst">&#123;file_path&#125;</span>&quot;</span>)</span><br><span class="line">                    use_ed2k = <span class="literal">False</span>  <span class="comment"># å…³é—­ed2k</span></span><br><span class="line"></span><br><span class="line">            link_tasks = []</span><br><span class="line">            rows = []</span><br><span class="line">            <span class="keyword">for</span> row <span class="keyword">in</span> reader:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">len</span>(row) &gt; magnet_column_index <span class="keyword">and</span> row[magnet_column_index]:</span><br><span class="line">                        magnet_link = row[magnet_column_index]</span><br><span class="line">                        link_tasks.append(check_magnet_link(magnet_link, timeout))</span><br><span class="line">                        rows.append(row)  <span class="comment"># å­˜å‚¨è¡Œæ•°æ®</span></span><br><span class="line">                    <span class="keyword">elif</span> use_ed2k <span class="keyword">and</span> <span class="built_in">len</span>(row) &gt; ed2k_column_index <span class="keyword">and</span> row[ed2k_column_index]:</span><br><span class="line">                        ed2k_link = row[ed2k_column_index]</span><br><span class="line">                        link_tasks.append(check_ed2k_emule(ed2k_link, emule_path))</span><br><span class="line">                        rows.append(row)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        logging.warning(<span class="string">f&quot;è·³è¿‡æ— æ•ˆè¡Œï¼Œé“¾æ¥ç´¢å¼•è¶…å‡ºèŒƒå›´æˆ–ä¸ºç©º, æ–‡ä»¶:<span class="subst">&#123;file_path&#125;</span>, è¡Œæ•°æ®: <span class="subst">&#123;row&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    logging.error(<span class="string">f&quot;è·³è¿‡æ— æ•ˆè¡Œï¼Œå¤„ç†è¡Œæ•°æ®å¼‚å¸¸ï¼Œ æ–‡ä»¶:<span class="subst">&#123;file_path&#125;</span>, è¡Œæ•°æ®: <span class="subst">&#123;row&#125;</span>, å¼‚å¸¸: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            results = <span class="keyword">await</span> asyncio.gather(*link_tasks)</span><br><span class="line"></span><br><span class="line">            available_rows = [row <span class="keyword">for</span> row, is_valid <span class="keyword">in</span> <span class="built_in">zip</span>(rows, results) <span class="keyword">if</span> is_valid]</span><br><span class="line">            logging.info(<span class="string">f&quot;CSV æ–‡ä»¶å¤„ç†å®Œæ¯•: <span class="subst">&#123;file_path&#125;</span>ï¼Œ æ‰¾åˆ°äº† <span class="subst">&#123;<span class="built_in">len</span>(available_rows)&#125;</span> ä¸ªå¯ç”¨çš„é“¾æ¥&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># æ·»åŠ é¢å¤–ä¿¡æ¯</span></span><br><span class="line">            available_rows_with_info = []</span><br><span class="line">            <span class="keyword">if</span> header <span class="keyword">and</span> available_rows:</span><br><span class="line">                available_rows_with_info.append(</span><br><span class="line">                    header + [<span class="string">&quot;ç£åŠ›é“¾ç§å­æ•°&quot;</span>, <span class="string">&quot;ç£åŠ›é“¾èŠ‚ç‚¹æ•°&quot;</span>, <span class="string">&quot;ç£åŠ›é“¾ä¸‹è½½è¿›åº¦&quot;</span>, <span class="string">&quot;ç£åŠ›é“¾ä¸‹è½½é€Ÿåº¦&quot;</span>, <span class="string">&quot;ç£åŠ›é“¾ä¸Šä¼ é€Ÿåº¦&quot;</span>,</span><br><span class="line">                              <span class="string">&quot;ed2kæ–‡ä»¶å&quot;</span>, <span class="string">&quot;ed2kæ–‡ä»¶å¤§å°&quot;</span>])</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> row, is_valid <span class="keyword">in</span> <span class="built_in">zip</span>(rows, results):</span><br><span class="line">                <span class="keyword">if</span> is_valid:</span><br><span class="line">                    extra_info = [<span class="string">&quot;N/A&quot;</span>, <span class="string">&quot;N/A&quot;</span>, <span class="string">&quot;N/A&quot;</span>, <span class="string">&quot;N/A&quot;</span>, <span class="string">&quot;N/A&quot;</span>, <span class="string">&quot;N/A&quot;</span>, <span class="string">&quot;N/A&quot;</span>]</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">len</span>(row) &gt; magnet_column_index <span class="keyword">and</span> row[magnet_column_index]:</span><br><span class="line">                        magnet_link = row[magnet_column_index]</span><br><span class="line">                        torrent_info = <span class="keyword">await</span> get_bittorrent_info(magnet_link, qbt_host, qbt_port, qbt_user, qbt_pass)</span><br><span class="line">                        <span class="keyword">if</span> torrent_info:</span><br><span class="line">                            extra_info[<span class="number">0</span>] = torrent_info.get(<span class="string">&#x27;seeders&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>)</span><br><span class="line">                            extra_info[<span class="number">1</span>] = torrent_info.get(<span class="string">&#x27;peers&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>)</span><br><span class="line">                            extra_info[<span class="number">2</span>] = <span class="string">f&quot;<span class="subst">&#123;torrent_info.get(<span class="string">&#x27;progress&#x27;</span>, <span class="number">0</span>) * <span class="number">100</span>:<span class="number">.2</span>f&#125;</span>%&quot;</span></span><br><span class="line">                            extra_info[<span class="number">3</span>] = <span class="string">f&quot;<span class="subst">&#123;torrent_info.get(<span class="string">&#x27;down_speed&#x27;</span>, <span class="number">0</span>) / <span class="number">1024</span>:<span class="number">.2</span>f&#125;</span> KB/s&quot;</span></span><br><span class="line">                            extra_info[<span class="number">4</span>] = <span class="string">f&quot;<span class="subst">&#123;torrent_info.get(<span class="string">&#x27;up_speed&#x27;</span>, <span class="number">0</span>) / <span class="number">1024</span>:<span class="number">.2</span>f&#125;</span> KB/s&quot;</span></span><br><span class="line">                    <span class="keyword">if</span> use_ed2k <span class="keyword">and</span> <span class="built_in">len</span>(row) &gt; ed2k_column_index <span class="keyword">and</span> row[ed2k_column_index]:</span><br><span class="line">                        ed2k_link = row[ed2k_column_index]</span><br><span class="line">                        ed2k_info = <span class="keyword">await</span> get_ed2k_info(ed2k_link)</span><br><span class="line">                        extra_info[<span class="number">5</span>] = ed2k_info.get(<span class="string">&quot;file_name&quot;</span>, <span class="string">&#x27;N/A&#x27;</span>)</span><br><span class="line">                        extra_info[<span class="number">6</span>] = ed2k_info.get(<span class="string">&quot;file_size&quot;</span>, <span class="string">&#x27;N/A&#x27;</span>)</span><br><span class="line">                    available_rows_with_info.append(row + extra_info)</span><br><span class="line">            <span class="keyword">return</span> available_rows_with_info</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;å¤„ç†CSVæ–‡ä»¶å¼‚å¸¸ï¼š<span class="subst">&#123;file_path&#125;</span>, å¼‚å¸¸ï¼š<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">directory, magnet_column_names, output_directory, ed2k_column_names=<span class="literal">None</span>, emule_path=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">               use_ed2k=<span class="literal">False</span>, qbt_host=<span class="string">&#x27;127.0.0.1&#x27;</span>, qbt_port=<span class="number">8080</span>, qbt_user=<span class="string">&#x27;admin&#x27;</span>,</span></span><br><span class="line"><span class="params">               qbt_pass=<span class="string">&#x27;adminadmin&#x27;</span>, timeout=<span class="number">5</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä¸»å‡½æ•°ï¼Œéå†ç›®å½•ä¸­çš„ CSV æ–‡ä»¶ï¼ŒéªŒè¯ç£åŠ›é“¾æ¥ï¼Œå¹¶å°†ç»“æœæŒ‰æ–‡ä»¶åè¾“å‡ºåˆ°æ–°çš„ CSV æ–‡ä»¶&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(directory):</span><br><span class="line">        logging.error(<span class="string">f&quot;æŒ‡å®šçš„ç›®å½•ä¸å­˜åœ¨: <span class="subst">&#123;directory&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(output_directory):</span><br><span class="line">        os.makedirs(output_directory)</span><br><span class="line"></span><br><span class="line">    csv_tasks = []</span><br><span class="line">    <span class="keyword">for</span> dirpath, _, filenames <span class="keyword">in</span> os.walk(directory):</span><br><span class="line">        <span class="keyword">for</span> filename <span class="keyword">in</span> filenames:</span><br><span class="line">            <span class="keyword">if</span> filename.lower().endswith(<span class="string">&#x27;.csv&#x27;</span>):</span><br><span class="line">                file_path = os.path.join(dirpath, filename)</span><br><span class="line">                csv_tasks.append(</span><br><span class="line">                    process_csv_file(file_path, magnet_column_names, ed2k_column_names, emule_path, use_ed2k, qbt_host,</span><br><span class="line">                                     qbt_port, qbt_user, qbt_pass, timeout))</span><br><span class="line"></span><br><span class="line">    results = <span class="keyword">await</span> asyncio.gather(*csv_tasks)</span><br><span class="line"></span><br><span class="line">    csv_files = []</span><br><span class="line">    <span class="keyword">for</span> dirpath, _, filenames <span class="keyword">in</span> os.walk(directory):</span><br><span class="line">        <span class="keyword">for</span> filename <span class="keyword">in</span> filenames:</span><br><span class="line">            <span class="keyword">if</span> filename.lower().endswith(<span class="string">&#x27;.csv&#x27;</span>):</span><br><span class="line">                csv_files.append(os.path.join(dirpath, filename))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> filename, available_rows <span class="keyword">in</span> <span class="built_in">zip</span>(</span><br><span class="line">            csv_files, results):</span><br><span class="line"></span><br><span class="line">        output_file_path = os.path.join(output_directory, os.path.relpath(filename, directory))  <span class="comment"># åˆ›å»ºç›¸å¯¹è·¯å¾„ï¼Œä¿ç•™ç›®å½•ç»“æ„</span></span><br><span class="line">        os.makedirs(os.path.dirname(output_file_path), exist_ok=<span class="literal">True</span>)  <span class="comment"># åˆ›å»ºè¾“å‡ºç›®å½•</span></span><br><span class="line">        logging.info(</span><br><span class="line">            <span class="string">f&quot;å¼€å§‹å†™å…¥ <span class="subst">&#123;<span class="built_in">len</span>(available_rows) - <span class="number">1</span> <span class="keyword">if</span> available_rows <span class="keyword">else</span> <span class="number">0</span>&#125;</span> æ¡å¯ç”¨é“¾æ¥åˆ°æ–‡ä»¶ï¼š<span class="subst">&#123;output_file_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> available_rows:</span><br><span class="line">            logging.info(<span class="string">f&quot;CSVæ–‡ä»¶ <span class="subst">&#123;filename&#125;</span> ä¸­æ²¡æœ‰å¯ç”¨çš„é“¾æ¥&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span>  <span class="comment"># å¦‚æœå½“å‰æ–‡ä»¶æ²¡æœ‰æœ‰æ•ˆé“¾æ¥ï¼Œåˆ™è·³è¿‡</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(output_file_path, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>, newline=<span class="string">&#x27;&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                writer = csv.writer(f)</span><br><span class="line">                writer.writerows(available_rows)  <span class="comment"># å†™å…¥æ‰€æœ‰è¡Œ</span></span><br><span class="line">            logging.info(<span class="string">f&quot;æˆåŠŸå†™å…¥å¯ç”¨é“¾æ¥åˆ°æ–‡ä»¶: <span class="subst">&#123;output_file_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logging.error(<span class="string">f&quot;å†™å…¥æ–‡ä»¶ <span class="subst">&#123;output_file_path&#125;</span> å¤±è´¥: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    target_directory = <span class="string">r&quot;D:\pythonProject\audio_record_server\src\utils\data\man_link&quot;</span>  <span class="comment"># æŒ‡å®š CSV æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•</span></span><br><span class="line">    magnet_column_names = [<span class="string">&quot;ç£åŠ›é“¾&quot;</span>, <span class="string">&quot;ç£åŠ›é“¾æ¥&quot;</span>]  <span class="comment"># æŒ‡å®šç£åŠ›é“¾æ‰€åœ¨çš„åˆ—ååˆ—è¡¨</span></span><br><span class="line">    ed2k_column_names = [<span class="string">&quot;ç£åŠ›é“¾&quot;</span>, <span class="string">&quot;ç£åŠ›é“¾æ¥&quot;</span>]  <span class="comment"># æŒ‡å®šed2k æ‰€åœ¨çš„åˆ—ååˆ—è¡¨</span></span><br><span class="line">    output_dir = <span class="string">r&quot;D:\pythonProject\audio_record_server\src\utils\data&quot;</span>  <span class="comment"># æŒ‡å®šè¾“å‡ºç›®å½•</span></span><br><span class="line">    link_timeout = <span class="number">5</span>  <span class="comment"># è®¾ç½®è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œç§’</span></span><br><span class="line">    emule_path = <span class="string">r&quot;C:\Program Files (x86)\eMule\emule.exe&quot;</span>  <span class="comment"># é…ç½® eMule å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ (æ ¹æ®ä½ çš„å®‰è£…è·¯å¾„ä¿®æ”¹)</span></span><br><span class="line">    use_ed2k = <span class="literal">True</span>  <span class="comment"># æ˜¯å¦å¯ç”¨ed2kæ£€æµ‹</span></span><br><span class="line">    qbt_host = <span class="string">&#x27;127.0.0.1&#x27;</span>  <span class="comment"># qBittorrent WebUI åœ°å€</span></span><br><span class="line">    qbt_port = <span class="number">8080</span>  <span class="comment"># qBittorrent WebUI ç«¯å£</span></span><br><span class="line">    qbt_user = <span class="string">&#x27;admin&#x27;</span>  <span class="comment"># qBittorrent WebUI ç”¨æˆ·å</span></span><br><span class="line">    qbt_pass = <span class="string">&#x27;adminadmin&#x27;</span>  <span class="comment"># qBittorrent WebUI å¯†ç </span></span><br><span class="line"></span><br><span class="line">    asyncio.run(</span><br><span class="line">        main(target_directory, magnet_column_names, output_dir, ed2k_column_names, emule_path, use_ed2k, qbt_host,</span><br><span class="line">             qbt_port, qbt_user, qbt_pass, link_timeout))</span><br></pre></td></tr></table></figure><h2 id="æ¥å…¥è¿…é›·-è‡ªåŠ¨åŒ–ä¸‹è½½">æ¥å…¥è¿…é›· è‡ªåŠ¨åŒ–ä¸‹è½½</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">download_with_thunder</span>(<span class="params">thunder_path, link, output_path=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä½¿ç”¨è¿…é›·ä¸‹è½½é“¾æ¥&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> thunder_path:</span><br><span class="line">        logging.warning(<span class="string">&quot;è¿…é›·è·¯å¾„æœªæ‰¾åˆ°ï¼Œæ— æ³•ä¸‹è½½&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        cmd = [thunder_path, link]  <span class="comment"># æœ€åŸºç¡€çš„ä¸‹è½½å‘½ä»¤</span></span><br><span class="line">        <span class="keyword">if</span> output_path:</span><br><span class="line">            cmd.insert(<span class="number">1</span>, <span class="string">f&quot;--output=<span class="subst">&#123;shlex.quote(output_path)&#125;</span>&quot;</span>)</span><br><span class="line">        subprocess.Popen(cmd, creationflags=subprocess.CREATE_NO_WINDOW)</span><br><span class="line">        logging.info(<span class="string">f&quot;å·²æ·»åŠ è¿…é›·ä¸‹è½½ä»»åŠ¡: <span class="subst">&#123;link&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;è¿…é›·ä¸‹è½½å¤±è´¥ï¼š<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="ç£åŠ›é“¾ä¸­å…³é”®ä¿¡æ¯æå–">ç£åŠ›é“¾ä¸­å…³é”®ä¿¡æ¯æå–</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _*_ coding: utf-8 _*_</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Time:     2025/1/22 14:11</span></span><br><span class="line"><span class="string">Author:   ZhaoQi Cao(czq)</span></span><br><span class="line"><span class="string">Version:  V 0.1</span></span><br><span class="line"><span class="string">File:     bit_link_msg_split.py</span></span><br><span class="line"><span class="string">Describe: Write during the python at zgxmt, Github link: https://github.com/caozhaoqi</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> qbittorrentapi <span class="keyword">import</span> Client, LoginFailed</span><br><span class="line"><span class="keyword">from</span> qbittorrentapi.torrents <span class="keyword">import</span> TorrentDictionary</span><br><span class="line"><span class="keyword">import</span> time  <span class="comment"># å¯¼å…¥timeæ¨¡å—</span></span><br><span class="line"></span><br><span class="line">logging.basicConfig(level=logging.INFO, <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">open_magnet_link</span>(<span class="params">magnet_link, qbt_host=<span class="string">&#x27;127.0.0.1&#x27;</span>, qbt_port=<span class="number">8080</span>, qbt_user=<span class="string">&#x27;admin&#x27;</span>, qbt_pass=<span class="string">&#x27;adminadmin&#x27;</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä½¿ç”¨æŒ‡å®šçš„ç¨‹åºæ‰“å¼€ç£åŠ›é“¾æ¥å¹¶æå–ä¿¡æ¯ã€‚&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line"></span><br><span class="line">        client = Client(host=qbt_host, port=qbt_port, username=qbt_user, password=qbt_pass)</span><br><span class="line">        client.auth_log_in()</span><br><span class="line"></span><br><span class="line">        torrent = client.torrents_add(magnet_link)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(torrent, TorrentDictionary):</span><br><span class="line">            torrent_hash = torrent.<span class="built_in">hash</span></span><br><span class="line">            logging.info(<span class="string">f&quot;æˆåŠŸæ·»åŠ ç£åŠ›é“¾åˆ° qBittorrent: <span class="subst">&#123;magnet_link&#125;</span>, torrent hash:<span class="subst">&#123;torrent_hash&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(torrent, <span class="built_in">str</span>):</span><br><span class="line">            torrent_hash = torrent</span><br><span class="line">            logging.warning(<span class="string">f&quot;æ·»åŠ ç£åŠ›é“¾è¿”å›äº†å­—ç¬¦ä¸²ï¼Œå°è¯•ä½¿ç”¨hash:<span class="subst">&#123;magnet_link&#125;</span>, torrent hash:<span class="subst">&#123;torrent_hash&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> torrent <span class="keyword">in</span> (<span class="string">&quot;Fails&quot;</span>, <span class="string">&quot;Ok&quot;</span>):</span><br><span class="line">                logging.error(<span class="string">f&quot;æ·»åŠ ç£åŠ›é“¾å¤±è´¥ï¼Œè¿”å›äº†Failsæˆ–è€…Okå­—ç¬¦ä¸²ï¼š<span class="subst">&#123;magnet_link&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logging.error(<span class="string">f&quot;æ·»åŠ ç£åŠ›é“¾è¿”å›æœªçŸ¥å¯¹è±¡ï¼š<span class="subst">&#123;<span class="built_in">type</span>(torrent)&#125;</span>ï¼Œ<span class="subst">&#123;torrent&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> torrent_hash:</span><br><span class="line"></span><br><span class="line">            start_time = time.time()</span><br><span class="line">            <span class="keyword">while</span> time.time() - start_time &lt; <span class="number">30</span>:  <span class="comment"># æœ€é•¿ç­‰å¾…30ç§’</span></span><br><span class="line">                <span class="comment"># ç­‰å¾…ç§å­æ·»åŠ å®Œæˆ</span></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    torrent = client.torrents_info(torrent_hashes=torrent_hash)[<span class="number">0</span>]</span><br><span class="line">                    <span class="keyword">if</span> torrent.state <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">&quot;stalledDL&quot;</span>, <span class="string">&quot;queuedDL&quot;</span>, <span class="string">&quot;checkingDL&quot;</span>):</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    logging.error(<span class="string">f&quot;è·å– torrent ä¿¡æ¯å¤±è´¥ï¼Œ<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">                    client.torrents_delete(delete_files=<span class="literal">True</span>, torrent_hashes=torrent_hash)</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)  <span class="comment"># é˜²æ­¢CPUè¿‡é«˜</span></span><br><span class="line">            <span class="keyword">if</span> torrent.state <span class="keyword">in</span> (<span class="string">&quot;stalledDL&quot;</span>, <span class="string">&quot;queuedDL&quot;</span>, <span class="string">&quot;checkingDL&quot;</span>):</span><br><span class="line">                logging.warning(<span class="string">f&quot;qBittorrent æ·»åŠ ç£åŠ›é“¾åè¶…æ—¶: <span class="subst">&#123;magnet_link&#125;</span> ,çŠ¶æ€:<span class="subst">&#123;torrent.state&#125;</span>&quot;</span>)</span><br><span class="line">                client.torrents_delete(delete_files=<span class="literal">True</span>, torrent_hashes=torrent_hash)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">            name = torrent.name</span><br><span class="line">            size = torrent.size</span><br><span class="line"></span><br><span class="line">            <span class="comment"># è§£æåç§°</span></span><br><span class="line">            pattern = re.<span class="built_in">compile</span>(<span class="string">r&quot;^(.*?)\.S(\d+)(?:E(\d+))?.*?(?:(\d&#123;3,4&#125;p))?.*$&quot;</span>)</span><br><span class="line">            <span class="keyword">match</span> = pattern.<span class="keyword">match</span>(name)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">                title = <span class="keyword">match</span>.group(<span class="number">1</span>).replace(<span class="string">&quot;.&quot;</span>, <span class="string">&quot; &quot;</span>)  <span class="comment"># æ›¿æ¢ç‚¹å·ä¸ºç©ºæ ¼</span></span><br><span class="line">                season = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">2</span>)) <span class="keyword">if</span> <span class="keyword">match</span>.group(<span class="number">2</span>) <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">                episode = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">3</span>)) <span class="keyword">if</span> <span class="keyword">match</span>.group(<span class="number">3</span>) <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">                resolution = <span class="keyword">match</span>.group(<span class="number">4</span>) <span class="keyword">if</span> <span class="keyword">match</span>.group(<span class="number">4</span>) <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                title = name</span><br><span class="line">                season = <span class="literal">None</span></span><br><span class="line">                episode = <span class="literal">None</span></span><br><span class="line">                resolution = <span class="literal">None</span></span><br><span class="line">            <span class="comment"># åˆ é™¤torrent</span></span><br><span class="line">            client.torrents_delete(delete_files=<span class="literal">True</span>, torrent_hashes=torrent_hash)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;title&quot;</span>: title.strip(),</span><br><span class="line">                <span class="string">&quot;season&quot;</span>: season,</span><br><span class="line">                <span class="string">&quot;episode&quot;</span>: episode,</span><br><span class="line">                <span class="string">&quot;resolution&quot;</span>: resolution,</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: name,</span><br><span class="line">                <span class="string">&quot;size&quot;</span>: size</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logging.warning(<span class="string">f&quot;qBittorrent æ·»åŠ ç£åŠ›é“¾å¤±è´¥ï¼Œè¿”å›hashä¸ºç©º : <span class="subst">&#123;magnet_link&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> LoginFailed:</span><br><span class="line">        logging.error(<span class="string">f&quot;qBittorrentç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥åœ°å€ï¼Œç”¨æˆ·åå’Œå¯†ç ï¼š&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;ä½¿ç”¨ qBittorrent æ‰“å¼€ç£åŠ›é“¾å¤±è´¥ï¼Œ<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_magnet_info_from_string</span>(<span class="params">magnet_link</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä»ç£åŠ›é“¾æ¥æœ¬èº«è§£æä¿¡æ¯&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        parsed_magnet = urllib.parse.urlparse(magnet_link)</span><br><span class="line">        query_params = urllib.parse.parse_qs(parsed_magnet.query)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;dn&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> query_params:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        file_name = query_params[<span class="string">&#x27;dn&#x27;</span>][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ­£åˆ™è¡¨è¾¾å¼</span></span><br><span class="line">        pattern = re.<span class="built_in">compile</span>(<span class="string">r&quot;^(.*?)\.S(\d+)(?:E(\d+))?.*?(?:(\d&#123;3,4&#125;p))?.*$&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">match</span> = pattern.<span class="keyword">match</span>(file_name)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">            title = <span class="keyword">match</span>.group(<span class="number">1</span>).replace(<span class="string">&quot;.&quot;</span>, <span class="string">&quot; &quot;</span>)  <span class="comment"># æ›¿æ¢ç‚¹å·ä¸ºç©ºæ ¼</span></span><br><span class="line">            season = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">2</span>)) <span class="keyword">if</span> <span class="keyword">match</span>.group(<span class="number">2</span>) <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">            episode = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">3</span>)) <span class="keyword">if</span> <span class="keyword">match</span>.group(<span class="number">3</span>) <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">            resolution = <span class="keyword">match</span>.group(<span class="number">4</span>) <span class="keyword">if</span> <span class="keyword">match</span>.group(<span class="number">4</span>) <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;title&quot;</span>: title.strip(),</span><br><span class="line">                <span class="string">&quot;season&quot;</span>: season,</span><br><span class="line">                <span class="string">&quot;episode&quot;</span>: episode,</span><br><span class="line">                <span class="string">&quot;resolution&quot;</span>: resolution,</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: file_name,</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;è§£æç£åŠ›é“¾æ¥å¼‚å¸¸ï¼š<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    magnet_link = <span class="string">&quot;magnet:?xt=urn:btih:362f3486e3ac1df5844305e90fd5cdae01f5ac0c&amp;tr=http://tr.cili001.com:8070/announce&amp;tr=udp://p4p.arenabg.com:1337&amp;tr=udp://tracker.opentrackr.org:1337/announce&amp;tr=udp://open.demonii.com:1337&quot;</span></span><br><span class="line">    qbt_host = <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">    qbt_port = <span class="number">8080</span></span><br><span class="line">    qbt_user = <span class="string">&#x27;admin&#x27;</span></span><br><span class="line">    qbt_pass = <span class="string">&#x27;adminadmin&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä½¿ç”¨ qBittorrent</span></span><br><span class="line">        info_from_qbt = <span class="keyword">await</span> open_magnet_link(magnet_link, qbt_host, qbt_port, qbt_user, qbt_pass)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> info_from_qbt:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;é€šè¿‡ qBittorrent è·å–ä¿¡æ¯:&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  æ ‡é¢˜: <span class="subst">&#123;info_from_qbt.get(<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> info_from_qbt.get(<span class="string">&#x27;season&#x27;</span>):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;  å­£æ•°: ç¬¬ <span class="subst">&#123;info_from_qbt[<span class="string">&#x27;season&#x27;</span>]&#125;</span> å­£&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> info_from_qbt.get(<span class="string">&#x27;episode&#x27;</span>):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;  é›†æ•°: ç¬¬ <span class="subst">&#123;info_from_qbt[<span class="string">&#x27;episode&#x27;</span>]&#125;</span> é›†&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  æ¸…æ™°åº¦: <span class="subst">&#123;info_from_qbt.get(<span class="string">&#x27;resolution&#x27;</span>, <span class="string">&#x27;æœªçŸ¥&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  æ–‡ä»¶å: <span class="subst">&#123;info_from_qbt.get(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;æœªçŸ¥&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  æ–‡ä»¶å¤§å°: <span class="subst">&#123;info_from_qbt.get(<span class="string">&#x27;size&#x27;</span>, <span class="string">&#x27;æœªçŸ¥&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">            info_from_magnet = extract_magnet_info_from_string(magnet_link)</span><br><span class="line">            <span class="keyword">if</span> info_from_magnet:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;é€šè¿‡è§£æç£åŠ›é“¾æ¥è·å–ä¿¡æ¯:&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;  æ ‡é¢˜: <span class="subst">&#123;info_from_magnet.get(<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;N/A&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> info_from_magnet.get(<span class="string">&#x27;season&#x27;</span>):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;  å­£æ•°: ç¬¬ <span class="subst">&#123;info_from_magnet.get(<span class="string">&#x27;season&#x27;</span>)&#125;</span> å­£&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> info_from_magnet.get(<span class="string">&#x27;episode&#x27;</span>):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;  é›†æ•°: ç¬¬ <span class="subst">&#123;info_from_magnet.get(<span class="string">&#x27;episode&#x27;</span>)&#125;</span> é›†&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;  æ¸…æ™°åº¦: <span class="subst">&#123;info_from_magnet.get(<span class="string">&#x27;resolution&#x27;</span>, <span class="string">&#x27;æœªçŸ¥&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;  æ–‡ä»¶å: <span class="subst">&#123;info_from_magnet.get(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;æœªçŸ¥&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;æ— æ³•æå–ç£åŠ›é“¾ä¿¡æ¯&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    asyncio.run(main())</span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åœ¨ubuntuæœåŠ¡å™¨æ­å»º NAS</title>
      <link href="/2025/01/23/ubuntu-nas/"/>
      <url>/2025/01/23/ubuntu-nas/</url>
      
        <content type="html"><![CDATA[<h1>åœ¨ubuntuæœåŠ¡å™¨æ­å»º NAS</h1><h2 id="SMBåè®®æ­å»ºNAS">SMBåè®®æ­å»ºNAS</h2><blockquote><p>é€šè¿‡webminiä½¿ç”¨sambaå¯è§†åŒ–æ­å»ºnas</p></blockquote><h3 id="ç£ç›˜æŒ‚è½½">ç£ç›˜æŒ‚è½½</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">df -h</span><br><span class="line">sudo pvdisplay  # æŸ¥çœ‹ç‰©ç†å·ä¿¡æ¯</span><br><span class="line">sudo vgdisplay  # æŸ¥çœ‹å·ç»„ä¿¡æ¯</span><br><span class="line">sudo lvdisplay  # æŸ¥çœ‹é€»è¾‘å·ä¿¡æ¯</span><br><span class="line">sudo lvextend -l +100%FREE /dev/ubuntu-vg/ubuntu-lv</span><br><span class="line">sudo resize2fs /dev/ubuntu-vg/ubuntu-l</span><br><span class="line">df -h /dev/ubuntu-vg/ubuntu-lv</span><br><span class="line">sudo lvdisplay /dev/ubuntu-vg/ubuntu-lv</span><br></pre></td></tr></table></figure><h3 id="webmin">webmin</h3><blockquote><p>Webmin æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ Web ç³»ç»Ÿç®¡ç†å·¥å…·ï¼Œæä¾›äº†ä¸°å¯Œçš„å›¾å½¢åŒ–ç•Œé¢ï¼Œå¯ä»¥é…ç½® Linux æœåŠ¡å™¨çš„å„ä¸ªæ–¹é¢</p></blockquote><h4 id="install">install</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget http://www.webmin.com/jcameron-key.asc</span><br><span class="line">sudo apt-key add jcameron-key.asc</span><br><span class="line">sudo echo &quot;deb http://download.webmin.com/download/repository sarge contrib&quot; | sudo tee /etc/apt/sources.list.d/webmin.list</span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install webmin</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="proxy">proxy</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">sudo</span> vim ~/.bashrc</span></span><br><span class="line"></span><br><span class="line">export http_proxy=http://192.168.10.65:7890</span><br><span class="line">export https_proxy=https://192.168.10.65:7890</span><br><span class="line">export no_proxy=&quot;localhost,127.0.0.1,*.local&quot;</span><br><span class="line">export all_proxy=socks5://192.168.10.65:7890 # å¦‚æœæ˜¯ socks ä»£ç†</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="samba">samba</h3><ul><li>install</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install samba</span><br></pre></td></tr></table></figure><ul><li>config</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/samba/smb.conf</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">workgroup = WORKGROUP        # è®¾ç½®å·¥ä½œç»„åç§°ï¼Œé€šå¸¸ä¸º WORKGROUP</span><br><span class="line">server string = %h server    # è®¾ç½®æœåŠ¡å™¨æè¿°</span><br><span class="line">netbios name = nas-server    # è®¾ç½®æœåŠ¡å™¨ NetBIOS åç§°</span><br><span class="line">security = user              # è®¾ç½®å®‰å…¨æ¨¡å¼ä¸ºç”¨æˆ·è®¤è¯</span><br><span class="line">map to guest = bad user      # æ‹’ç»åŒ¿åç”¨æˆ·è®¿é—®</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[shared]                       # è®¾ç½®å…±äº«åç§°</span><br><span class="line">path = /mnt/nas                # è®¾ç½®å…±äº«ç›®å½•è·¯å¾„</span><br><span class="line">valid users = user1,user2       # è®¾ç½®å…è®¸è®¿é—®çš„ç”¨æˆ·åˆ—è¡¨</span><br><span class="line">read only = no                 # å…è®¸è¯»å†™è®¿é—®</span><br><span class="line">browseable = yes               # å…è®¸åœ¨ç½‘ç»œä¸­æµè§ˆ</span><br><span class="line">guest ok = no                 # ç¦æ­¢åŒ¿åè®¿é—®</span><br><span class="line">force user = root              # ç”¨ root èº«ä»½æ“ä½œ</span><br><span class="line">create mask = 0777             # åˆ›å»ºæ–‡ä»¶çš„æƒé™</span><br><span class="line">directory mask = 0777           # åˆ›å»ºç›®å½•çš„æƒé™</span><br></pre></td></tr></table></figure><ul><li>æœåŠ¡é‡å¯</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart smbd</span><br></pre></td></tr></table></figure><h3 id="sambaå®Œæ•´é…ç½®æ–‡ä»¶">sambaå®Œæ•´é…ç½®æ–‡ä»¶</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#======================= Global Settings =======================</span></span><br><span class="line"></span><br><span class="line"><span class="section">[global]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Browsing/Identification ###</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Change this to the workgroup/NT-domain name your Samba server will part of</span></span><br><span class="line"><span class="attr">workgroup</span> = zgxmt</span><br><span class="line"></span><br><span class="line"><span class="comment"># server string is the equivalent of the NT Description field</span></span><br><span class="line">server <span class="attr">string</span> = %h server (Samba, Ubuntu)</span><br><span class="line"></span><br><span class="line">netbios <span class="attr">name</span> = nas</span><br><span class="line"></span><br><span class="line"><span class="attr">security</span> = user</span><br><span class="line"></span><br><span class="line">map to <span class="attr">guest</span> = bad user</span><br><span class="line"></span><br><span class="line">log <span class="attr">file</span> = /var/log/samba/log.%m</span><br><span class="line"></span><br><span class="line"><span class="comment"># Cap the size of the individual log files (in KiB).</span></span><br><span class="line">max log <span class="attr">size</span> = <span class="number">1000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># We want Samba to only log to /var/log/samba/log.&#123;smbd,nmbd&#125;.</span></span><br><span class="line"><span class="comment"># Append syslog@1 if you want important messages to be sent to syslog too.</span></span><br><span class="line"><span class="attr">logging</span> = file</span><br><span class="line"></span><br><span class="line"><span class="comment"># Do something sensible when Samba crashes: mail the admin a backtrace</span></span><br><span class="line">panic <span class="attr">action</span> = /usr/share/samba/panic-action %d</span><br><span class="line"></span><br><span class="line">server <span class="attr">role</span> = standalone server</span><br><span class="line"></span><br><span class="line">obey pam <span class="attr">restrictions</span> = <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This boolean parameter controls whether Samba attempts to sync the Unix</span></span><br><span class="line"><span class="comment"># password with the SMB password when the encrypted SMB password in the</span></span><br><span class="line"><span class="comment"># passdb is changed.</span></span><br><span class="line">unix password <span class="attr">sync</span> = <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># For Unix password sync to work on a Debian GNU/Linux system, the following</span></span><br><span class="line"><span class="comment"># parameters must be set (thanks to Ian Kahan &lt;&lt;kahan@informatik.tu-muenchen.de&gt; for</span></span><br><span class="line"><span class="comment"># sending the correct chat script for the passwd program in Debian Sarge).</span></span><br><span class="line">passwd <span class="attr">program</span> = /usr/bin/passwd %u</span><br><span class="line">passwd <span class="attr">chat</span> = *Enter\snew\s*\spassword:* %n\n *Retype\snew\s*\spassword:* %n\n *password\supdated\ssuccessfully* .</span><br><span class="line"></span><br><span class="line"><span class="comment"># This boolean controls whether PAM will be used for password changes</span></span><br><span class="line"><span class="comment"># when requested by an SMB client instead of the program listed in</span></span><br><span class="line"><span class="comment"># &#x27;passwd program&#x27;. The default is &#x27;no&#x27;.</span></span><br><span class="line">pam password <span class="attr">change</span> = <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This option controls how unsuccessful authentication attempts are mapped</span></span><br><span class="line"><span class="comment"># to anonymous connections</span></span><br><span class="line">map to <span class="attr">guest</span> = bad user</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[printers]</span></span><br><span class="line"><span class="attr">comment</span> = All Printers</span><br><span class="line"><span class="attr">browseable</span> = <span class="literal">no</span></span><br><span class="line"><span class="attr">path</span> = /var/tmp</span><br><span class="line"><span class="attr">printable</span> = <span class="literal">yes</span></span><br><span class="line">guest <span class="attr">ok</span> = <span class="literal">no</span></span><br><span class="line">read <span class="attr">only</span> = <span class="literal">no</span></span><br><span class="line">create <span class="attr">mask</span> = <span class="number">0700</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Windows clients look for this share name as a source of downloadable</span></span><br><span class="line"><span class="comment"># printer drivers</span></span><br><span class="line"><span class="section">[print$]</span></span><br><span class="line"><span class="attr">comment</span> = Printer Drivers</span><br><span class="line"><span class="attr">path</span> = /var/lib/samba/printers</span><br><span class="line"><span class="attr">browseable</span> = <span class="literal">yes</span></span><br><span class="line">read <span class="attr">only</span> = <span class="literal">no</span></span><br><span class="line">guest <span class="attr">ok</span> = <span class="literal">no</span></span><br><span class="line"><span class="comment"># Uncomment to allow remote administration of Windows print drivers.</span></span><br><span class="line"><span class="comment"># You may need to replace &#x27;lpadmin&#x27; with the name of the group your</span></span><br><span class="line"><span class="comment"># admin users are members of.</span></span><br><span class="line"><span class="comment"># Please note that you also need to set appropriate Unix permissions</span></span><br><span class="line"><span class="comment"># to the drivers directory for these users to have write rights in it</span></span><br><span class="line"><span class="comment">;   write list = root, @lpadmin</span></span><br><span class="line"></span><br><span class="line"><span class="section">[shared]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">path</span> = /home/nas</span><br><span class="line"></span><br><span class="line">valid <span class="attr">users</span> = nas,root</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å…è®¸è®¿é—®çš„ç”¨æˆ·åˆ—è¡¨</span></span><br><span class="line">read <span class="attr">only</span> = <span class="literal">no</span></span><br><span class="line"><span class="comment"># å…è®¸è¯»å†™è®¿é—®</span></span><br><span class="line"><span class="attr">browseable</span> = <span class="literal">yes</span></span><br><span class="line">           <span class="comment"># å…è®¸åœ¨ç½‘ç»œä¸­æµè§ˆ</span></span><br><span class="line">           guest <span class="attr">ok</span> = <span class="literal">no</span></span><br><span class="line">           <span class="comment"># ç¦æ­¢åŒ¿åè®¿é—®</span></span><br><span class="line">           force <span class="attr">user</span> = root</span><br><span class="line">           <span class="comment"># ç”¨ root èº«ä»½æ“ä½œ</span></span><br><span class="line">           create <span class="attr">mask</span> = <span class="number">0777</span></span><br><span class="line"><span class="comment"># åˆ›å»ºæ–‡ä»¶çš„æƒé™</span></span><br><span class="line">directory <span class="attr">mask</span> = <span class="number">0777</span></span><br><span class="line"><span class="comment"># åˆ›å»ºç›®å½•çš„æƒé™</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="samba-ç”¨æˆ·åˆ›å»º">samba ç”¨æˆ·åˆ›å»º</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo useradd -m -s /bin/bash nas</span><br><span class="line">sudo passwd nas</span><br><span class="line">sudo smbpasswd -a nas</span><br><span class="line">sudo pdbedit -L # éªŒè¯ç”¨æˆ·</span><br></pre></td></tr></table></figure><h3 id="è§£é™¤winç»„ç­–ç•¥é™åˆ¶">è§£é™¤winç»„ç­–ç•¥é™åˆ¶</h3><blockquote><p>åœ¨windows æ— æ³•ç™»å½•æ—¶è§£é™¤ç»„ç­–ç•¥é™åˆ¶</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-SmbClientConfiguration -RequireSecuritySignature $false</span><br></pre></td></tr></table></figure><h3 id="é€šè¿‡è„šæœ¬æ‰¹é‡æŒ‚è½½ç£ç›˜">é€šè¿‡è„šæœ¬æ‰¹é‡æŒ‚è½½ç£ç›˜</h3><ul><li>ç¬¬ä¸‰æ–¹åº“å®‰è£…ä¸é…ç½®</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Debian/Ubuntu</span></span><br><span class="line">sudo apt install mergerfs</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">RHEL/CentOS</span></span><br><span class="line">sudo yum install epel-release</span><br><span class="line">sudo yum install mergerfs</span><br></pre></td></tr></table></figure><ul><li>ç£ç›˜åˆ†åŒºåˆå§‹åŒ–</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">for dev in /dev/sd&#123;a..v&#125;; do</span><br><span class="line">  echo &quot;æ­£åœ¨å¤„ç† $dev&quot;</span><br><span class="line">  sudo parted -s $dev mklabel gpt</span><br><span class="line">  sudo parted -s $dev mkpart primary 0% 100%</span><br><span class="line">  sudo mkfs.ext4 -L &quot;$&#123;dev##*/&#125;&quot; &quot;$&#123;dev&#125;1&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><ul><li>ç£ç›˜æŒ‚è½½</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ–‡ä»¶åï¼šstorage_pool_final.sh</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åŠŸèƒ½ï¼šè‡ªåŠ¨åŒ–åˆå§‹åŒ–ç£ç›˜ã€åˆ›å»ºåˆ†åŒºã€æ ¼å¼åŒ–æŒ‚è½½ã€é…ç½®mergerfså­˜å‚¨æ± </span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--------------------------</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½®å‚æ•°ï¼ˆæŒ‰éœ€ä¿®æ”¹ï¼‰</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--------------------------</span></span><br><span class="line">MOUNT_ROOT=&quot;/mnt/all_disks&quot;         # å­˜å‚¨æ± æ ¹ç›®å½•</span><br><span class="line">MOUNT_DIR=&quot;$MOUNT_ROOT/mounts&quot;      # å•ä¸ªç£ç›˜æŒ‚è½½ç›®å½•</span><br><span class="line">SHARED_DIR=&quot;$MOUNT_ROOT/shared&quot;     # åˆå¹¶å­˜å‚¨ç›®å½•</span><br><span class="line">MIN_FREE_SPACE=&quot;20G&quot;                # æœ€å°ä¿ç•™ç©ºé—´</span><br><span class="line">LOG_FILE=&quot;/var/log/storage_pool.log&quot; # æ—¥å¿—æ–‡ä»¶è·¯å¾„</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--------------------------</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--------------------------</span></span><br><span class="line">exec 3&gt;&amp;1 4&gt;&amp;2</span><br><span class="line">trap &#x27;exec 2&gt;&amp;4 1&gt;&amp;3&#x27; EXIT</span><br><span class="line">exec &gt; &gt;(tee -a &quot;$LOG_FILE&quot;) 2&gt;&amp;1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--------------------------</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é¢„æ£€æ¨¡å—</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--------------------------</span></span><br><span class="line">check_prerequisites() &#123;</span><br><span class="line">    # æ£€æŸ¥rootæƒé™</span><br><span class="line">    [[ $EUID -ne 0 ]] &amp;&amp; echo &quot;é”™è¯¯ï¼šå¿…é¡»ä½¿ç”¨sudoè¿è¡Œè„šæœ¬&quot; &amp;&amp; exit 1</span><br><span class="line"></span><br><span class="line">    # æ£€æŸ¥å¿…è¦å·¥å…·</span><br><span class="line">    declare -A REQUIRED_TOOLS=(</span><br><span class="line">        [&quot;parted&quot;]=&quot;åˆ†åŒºå·¥å…·&quot;</span><br><span class="line">        [&quot;mkfs.ext4&quot;]=&quot;æ ¼å¼åŒ–å·¥å…·&quot;</span><br><span class="line">        [&quot;mergerfs&quot;]=&quot;å­˜å‚¨åˆå¹¶å·¥å…·&quot;</span><br><span class="line">    )</span><br><span class="line">    for tool in &quot;$&#123;!REQUIRED_TOOLS[@]&#125;&quot;; do</span><br><span class="line">        if ! command -v $tool &amp;&gt; /dev/null; then</span><br><span class="line">            echo &quot;é”™è¯¯ï¼šç¼ºå°‘ä¾èµ– $&#123;REQUIRED_TOOLS[$tool]&#125; ($tool)&quot;</span><br><span class="line">            exit 1</span><br><span class="line">        fi</span><br><span class="line">    done</span><br><span class="line"></span><br><span class="line">    # åˆ›å»ºç›®å½•ç»“æ„</span><br><span class="line">    mkdir -p &quot;$MOUNT_DIR&quot; &quot;$SHARED_DIR&quot;</span><br><span class="line">    chmod 1777 &quot;$SHARED_DIR&quot;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--------------------------</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰å…¨è®¾å¤‡è¿‡æ»¤</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--------------------------</span></span><br><span class="line">get_data_disks() &#123;</span><br><span class="line">    lsblk -lp -o NAME,SIZE,TYPE,MOUNTPOINT | awk &#x27;</span><br><span class="line">        BEGIN &#123;IGNORECASE=1&#125;</span><br><span class="line">        $3 == &quot;disk&quot; &amp;&amp;</span><br><span class="line">        $4 == &quot;&quot; &amp;&amp;</span><br><span class="line">        $2 ~ /3\.6T/ &amp;&amp;</span><br><span class="line">        $1 !~ /sdaw/ &#123;  # æ’é™¤ç³»ç»Ÿç›˜sdaw</span><br><span class="line">            print $1</span><br><span class="line">        &#125;&#x27;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--------------------------</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç£ç›˜åˆå§‹åŒ–</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--------------------------</span></span><br><span class="line">init_disk() &#123;</span><br><span class="line">    local dev=$1</span><br><span class="line">    echo &quot;===== åˆå§‹åŒ–ç£ç›˜ $dev =====&quot;</span><br><span class="line"></span><br><span class="line">    # åˆ›å»ºGPTåˆ†åŒºè¡¨</span><br><span class="line">    if ! parted -s &quot;$dev&quot; mklabel gpt; then</span><br><span class="line">        echo &quot;é”™è¯¯ï¼šæ— æ³•åˆ›å»ºGPTåˆ†åŒºè¡¨&quot;</span><br><span class="line">        return 1</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # åˆ›å»ºä¸»åˆ†åŒº</span><br><span class="line">    if ! parted -s &quot;$dev&quot; mkpart primary 0% 100%; then</span><br><span class="line">        echo &quot;é”™è¯¯ï¼šæ— æ³•åˆ›å»ºåˆ†åŒº&quot;</span><br><span class="line">        return 1</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # æ ¼å¼åŒ–åˆ†åŒºä¸ºext4</span><br><span class="line">    local partition=&quot;$&#123;dev&#125;1&quot;</span><br><span class="line">    if ! mkfs.ext4 -q -L &quot;DATA_$&#123;dev##*/&#125;&quot; &quot;$partition&quot;; then</span><br><span class="line">        echo &quot;é”™è¯¯ï¼šæ ¼å¼åŒ–å¤±è´¥&quot;</span><br><span class="line">        return 1</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    echo &quot;âˆš åˆå§‹åŒ–å®Œæˆï¼š$dev â†’ $partition&quot;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--------------------------</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŒ‚è½½ç®¡ç†</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--------------------------</span></span><br><span class="line">mount_partition() &#123;</span><br><span class="line">    local partition=$1</span><br><span class="line">    # è·å–UUID</span><br><span class="line">    local uuid=$(blkid -s UUID -o value &quot;$partition&quot;)</span><br><span class="line">    [[ -z &quot;$uuid&quot; ]] &amp;&amp; return 1</span><br><span class="line"></span><br><span class="line">    # åˆ›å»ºæŒ‚è½½ç‚¹</span><br><span class="line">    local mount_point=&quot;$MOUNT_DIR/$uuid&quot;</span><br><span class="line">    mkdir -p &quot;$mount_point&quot;</span><br><span class="line"></span><br><span class="line">    # å†™å…¥fstabï¼ˆå¹‚ç­‰æ“ä½œï¼‰</span><br><span class="line">    if ! grep -q &quot;UUID=$uuid&quot; /etc/fstab; then</span><br><span class="line">        echo &quot;UUID=$uuid $mount_point ext4 defaults,nofail,noatime 0 0&quot; &gt;&gt; /etc/fstab</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # æ‰§è¡ŒæŒ‚è½½</span><br><span class="line">    if mount -v &quot;$mount_point&quot;; then</span><br><span class="line">        echo &quot;âˆš æŒ‚è½½æˆåŠŸï¼š$partition â†’ $mount_point&quot;</span><br><span class="line">    else</span><br><span class="line">        sed -i &quot;\|UUID=$uuid|d&quot; /etc/fstab</span><br><span class="line">        rmdir &quot;$mount_point&quot;</span><br><span class="line">        return 1</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--------------------------</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mergerfsé…ç½®</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--------------------------</span></span><br><span class="line">configure_mergerfs() &#123;</span><br><span class="line">    # ç”ŸæˆæŒ‚è½½ç‚¹åˆ—è¡¨</span><br><span class="line">    local mount_points=($(ls -d &quot;$MOUNT_DIR&quot;/* 2&gt;/dev/null))</span><br><span class="line">    if [[ $&#123;#mount_points[@]&#125; -eq 0 ]]; then</span><br><span class="line">        echo &quot;é”™è¯¯ï¼šæ²¡æœ‰å¯ç”¨çš„æŒ‚è½½ç‚¹ï¼&quot;</span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # ç”Ÿæˆfstabæ¡ç›®</span><br><span class="line">    local mergerfs_entry=&quot;$&#123;mount_points[@]/%/\\:&#125; $SHARED_DIR fuse.mergerfs defaults,allow_other,category.create=epmfs,minfreespace=$MIN_FREE_SPACE,fsname=StoragePool 0 0&quot;</span><br><span class="line"></span><br><span class="line">    # æ¸…ç†æ—§é…ç½®</span><br><span class="line">    sed -i &#x27;\|fuse.mergerfs|d&#x27; /etc/fstab</span><br><span class="line"></span><br><span class="line">    # å†™å…¥æ–°é…ç½®</span><br><span class="line">    echo &quot;$mergerfs_entry&quot; &gt;&gt; /etc/fstab</span><br><span class="line"></span><br><span class="line">    # åº”ç”¨æŒ‚è½½</span><br><span class="line">    if mount -av; then</span><br><span class="line">        echo &quot;âˆš mergerfsé…ç½®æˆåŠŸ&quot;</span><br><span class="line">        df -hT &quot;$SHARED_DIR&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;Ã— mergerfsæŒ‚è½½å¤±è´¥&quot;</span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--------------------------</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸»ç¨‹åºæµç¨‹</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--------------------------</span></span><br><span class="line">main() &#123;</span><br><span class="line">    check_prerequisites</span><br><span class="line"></span><br><span class="line">    # å¤„ç†æ‰€æœ‰æ•°æ®ç£ç›˜</span><br><span class="line">    while read -r dev; do</span><br><span class="line">        # åˆå§‹åŒ–ç£ç›˜</span><br><span class="line">        if ! init_disk &quot;$dev&quot;; then</span><br><span class="line">            echo &quot;Ã— ç£ç›˜åˆå§‹åŒ–å¤±è´¥ï¼š$dev&quot;</span><br><span class="line">            continue</span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">        # æŒ‚è½½åˆ†åŒº</span><br><span class="line">        partition=&quot;$&#123;dev&#125;1&quot;</span><br><span class="line">        if ! mount_partition &quot;$partition&quot;; then</span><br><span class="line">            echo &quot;Ã— åˆ†åŒºæŒ‚è½½å¤±è´¥ï¼š$partition&quot;</span><br><span class="line">            continue</span><br><span class="line">        fi</span><br><span class="line">    done &lt; &lt;(get_data_disks)</span><br><span class="line"></span><br><span class="line">    # é…ç½®mergerfs</span><br><span class="line">    configure_mergerfs</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--------------------------</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ‰§è¡Œå…¥å£</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--------------------------</span></span><br><span class="line">main &quot;$@&quot;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight plaintext"><figcaption><span>./mount.sh``` è¿è¡Œ</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### ç£ç›˜å¤§å°æŸ¥çœ‹</span><br><span class="line"></span><br><span class="line">```shell</span><br><span class="line">lsblk -b -o SIZE | grep -v &quot;loop&quot; | grep -v &quot;rom&quot;  | grep -v &quot;SIZE&quot; | awk &#x27;&#123;sum+=$1&#125; END &#123;print sum&#125;&#x27; | numfmt --to=iec-i --suffix=B --padding=7```</span><br></pre></td></tr></table></figure></blockquote><h3 id="éªŒè¯">éªŒè¯</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df -hT /mnt/all_disks/shared</span><br></pre></td></tr></table></figure><h3 id="å¸è½½ç£ç›˜é‡æ–°åŠ è½½">å¸è½½ç£ç›˜é‡æ–°åŠ è½½</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo umount -a</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">df -h</span><br></pre></td></tr></table></figure><h3 id="æœ€ç»ˆéªŒè¯">æœ€ç»ˆéªŒè¯</h3><h4 id="æ­¥éª¤-1ï¼šéªŒè¯-mergerfs-é…ç½®">æ­¥éª¤ 1ï¼šéªŒè¯ mergerfs é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ /etc/fstab ä¸­æ˜¯å¦æœ‰ mergerfs æ¡ç›®</span></span><br><span class="line"><span class="built_in">cat</span> /etc/fstab | grep <span class="string">&quot;fuse.mergerfs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é¢„æœŸåº”è¾“å‡ºç±»ä¼¼ï¼š</span></span><br><span class="line"><span class="comment"># /mnt/all_disks/mounts/* /mnt/all_disks/shared fuse.mergerfs defaults,allow_other,... 0 0</span></span><br></pre></td></tr></table></figure><h4 id="æ­¥éª¤-2ï¼šæ‰‹åŠ¨è§¦å‘æŒ‚è½½">æ­¥éª¤ 2ï¼šæ‰‹åŠ¨è§¦å‘æŒ‚è½½</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¸è½½é”™è¯¯æŒ‚è½½</span></span><br><span class="line"><span class="built_in">sudo</span> umount -l /mnt/all_disks/shared</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡æ–°æŒ‚è½½æ‰€æœ‰è®¾å¤‡</span></span><br><span class="line"><span class="built_in">sudo</span> mount -av</span><br></pre></td></tr></table></figure><h4 id="æ­¥éª¤-3ï¼šæ£€æŸ¥-mergerfs-æŒ‚è½½çŠ¶æ€">æ­¥éª¤ 3ï¼šæ£€æŸ¥ mergerfs æŒ‚è½½çŠ¶æ€</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ mergerfs æ˜¯å¦ç”Ÿæ•ˆ</span></span><br><span class="line">mount | grep <span class="string">&quot;mergerfs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é¢„æœŸè¾“å‡ºåº”åŒ…å«ï¼š</span></span><br><span class="line"><span class="comment"># StoragePool on /mnt/all_disks/shared type fuse.mergerfs (...)</span></span><br></pre></td></tr></table></figure><h4 id="æ­¥éª¤-4ï¼šä¿®å¤é…ç½®é—®é¢˜">æ­¥éª¤ 4ï¼šä¿®å¤é…ç½®é—®é¢˜</h4><blockquote><p>è‹¥ä¸Šè¿°æ­¥éª¤æ— æ•ˆï¼Œæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p></blockquote><ul><li>æ¸…ç†æ—§é…ç½®</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤æ— æ•ˆçš„ mergerfs æ¡ç›®</span></span><br><span class="line"><span class="built_in">sudo</span> sed -i <span class="string">&#x27;\|fuse.mergerfs|d&#x27;</span> /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¡®ä¿æ‰€æœ‰ç£ç›˜å·²æ­£ç¡®æŒ‚è½½åˆ° mounts/ å­ç›®å½•</span></span><br><span class="line"><span class="built_in">ls</span> -l /mnt/all_disks/mounts</span><br></pre></td></tr></table></figure><ul><li>é‡æ–°ç”Ÿæˆ mergerfs é…ç½®</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># è·å–æ‰€æœ‰æŒ‚è½½ç‚¹è·¯å¾„</span></span><br><span class="line">MOUNT_PATHS=$(<span class="built_in">ls</span> -d /mnt/all_disks/mounts/* | <span class="built_in">tr</span> <span class="string">&#x27;\n&#x27;</span> <span class="string">&#x27;:&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†™å…¥æ–°çš„ mergerfs é…ç½®</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;MOUNT_PATHS%:&#125;</span> /mnt/all_disks/shared fuse.mergerfs defaults,allow_other,category.create=epmfs,minfreespace=20G,fsname=StoragePool 0 0&quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> -a /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="comment"># åº”ç”¨é…ç½®</span></span><br><span class="line"><span class="built_in">sudo</span> mount -av</span><br></pre></td></tr></table></figure><h4 id="æ­¥éª¤-5ï¼šéªŒè¯æœ€ç»ˆçŠ¶æ€">æ­¥éª¤ 5ï¼šéªŒè¯æœ€ç»ˆçŠ¶æ€</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥å­˜å‚¨æ± å®¹é‡</span></span><br><span class="line"><span class="built_in">df</span> -hT /mnt/all_disks/shared</span><br><span class="line"></span><br><span class="line"><span class="comment"># é¢„æœŸè¾“å‡ºç¤ºä¾‹ï¼š</span></span><br><span class="line"><span class="comment">#Filesystem      Type           Size  Used Avail Use% Mounted on</span></span><br><span class="line"><span class="comment">#StoragePool     fuse.mergerfs  7.2T  3.6T  3.6T  50% /mnt/all_disks/shared</span></span><br></pre></td></tr></table></figure><h3 id="NASå¼‚å¸¸é‡å¯é”™è¯¯æ’é™¤">NASå¼‚å¸¸é‡å¯é”™è¯¯æ’é™¤</h3><blockquote><p>è„šæœ¬å¦‚ä¸‹</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ–‡ä»¶åï¼šcheck_reboot_logs.sh</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åŠŸèƒ½ï¼šè‡ªåŠ¨æ”¶é›†å’Œåˆ†æç³»ç»Ÿé‡å¯ç›¸å…³æ—¥å¿—</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥ root æƒé™</span></span><br><span class="line">if [ &quot;$EUID&quot; -ne 0 ]; then</span><br><span class="line">  echo &quot;è¯·ä½¿ç”¨ sudo æˆ– root æƒé™è¿è¡Œæ­¤è„šæœ¬&quot;</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®šä¹‰æ—¥å¿—ä¿å­˜ç›®å½•</span></span><br><span class="line">LOG_DIR=&quot;/var/log/reboot_investigation_$(date +%Y%m%d%H%M%S)&quot;</span><br><span class="line">mkdir -p &quot;$LOG_DIR&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ”¶é›†åŸºç¡€ç³»ç»Ÿä¿¡æ¯</span></span><br><span class="line">&#123;</span><br><span class="line">  echo &quot;======= ç³»ç»ŸåŸºæœ¬ä¿¡æ¯ =======&quot;</span><br><span class="line">  lsb_release -a</span><br><span class="line">  uname -a</span><br><span class="line">  uptime</span><br><span class="line">  echo &quot;&quot;</span><br><span class="line">&#125; &gt; &quot;$LOG_DIR/system_info.txt&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ”¶é›†æœ€è¿‘é‡å¯è®°å½•</span></span><br><span class="line">&#123;</span><br><span class="line">  echo &quot;======= æœ€è¿‘ 5 æ¬¡é‡å¯è®°å½• =======&quot;</span><br><span class="line">  last reboot | head -n 5</span><br><span class="line">  echo &quot;&quot;</span><br><span class="line">&#125; &gt; &quot;$LOG_DIR/reboot_history.txt&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ”¶é›†å†…æ ¸æ—¥å¿—ä¸­çš„å¼‚å¸¸ä¿¡æ¯</span></span><br><span class="line">&#123;</span><br><span class="line">  echo &quot;======= å†…æ ¸æ—¥å¿—å…³é”®äº‹ä»¶ =======&quot;</span><br><span class="line">  journalctl -k --since &quot;1 week ago&quot; | grep -Ei \</span><br><span class="line">  -e &quot;oom&quot; \</span><br><span class="line">  -e &quot;panic&quot; \</span><br><span class="line">  -e &quot;segfault&quot; \</span><br><span class="line">  -e &quot;hard reset&quot; \</span><br><span class="line">  -e &quot;kernel bug&quot; \</span><br><span class="line">  -e &quot;rcu stall&quot;</span><br><span class="line">  echo &quot;&quot;</span><br><span class="line">&#125; &gt; &quot;$LOG_DIR/kernel_events.txt&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ”¶é›†ç³»ç»Ÿæ—¥å¿—ä¸­çš„å´©æºƒè®°å½•</span></span><br><span class="line">&#123;</span><br><span class="line">  echo &quot;======= ç³»ç»ŸæœåŠ¡å´©æºƒè®°å½• =======&quot;</span><br><span class="line">  journalctl -b -1 --since &quot;1 week ago&quot; | grep -Ei \</span><br><span class="line">  -e &quot;crash&quot; \</span><br><span class="line">  -e &quot;failed&quot; \</span><br><span class="line">  -e &quot;segmentation fault&quot; \</span><br><span class="line">  -e &quot;core dumped&quot; \</span><br><span class="line">  -e &quot;out of memory&quot;</span><br><span class="line">  echo &quot;&quot;</span><br><span class="line">&#125; &gt; &quot;$LOG_DIR/service_crashes.txt&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ”¶é›†ç¡¬ä»¶ç›¸å…³æ—¥å¿—</span></span><br><span class="line">&#123;</span><br><span class="line">  echo &quot;======= ç¡¬ä»¶é”™è¯¯/è­¦å‘Š =======&quot;</span><br><span class="line">  dmesg -T | grep -Ei \</span><br><span class="line">  -e &quot;error&quot; \</span><br><span class="line">  -e &quot;warning&quot; \</span><br><span class="line">  -e &quot;temperature&quot; \</span><br><span class="line">  -e &quot;overheat&quot; \</span><br><span class="line">  -e &quot;corrected error&quot; \</span><br><span class="line">  -e &quot;mce&quot;</span><br><span class="line">  echo &quot;&quot;</span><br><span class="line">&#125; &gt; &quot;$LOG_DIR/hardware_issues.txt&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ”¶é›†è‡ªåŠ¨æ›´æ–°è®°å½•</span></span><br><span class="line">&#123;</span><br><span class="line">  echo &quot;======= è‡ªåŠ¨æ›´æ–°è®°å½• =======&quot;</span><br><span class="line">  grep -h -E &quot;apt|unattended&quot; /var/log/apt/* /var/log/unattended-upgrades/* 2&gt;/dev/null</span><br><span class="line">  echo &quot;&quot;</span><br><span class="line">&#125; &gt; &quot;$LOG_DIR/auto_updates.txt&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ”¶é›†å†…å­˜ä½¿ç”¨å†å²</span></span><br><span class="line">&#123;</span><br><span class="line">  echo &quot;======= å†…å­˜ä½¿ç”¨ç»Ÿè®¡ =======&quot;</span><br><span class="line">  sar -r -s &quot;$(date -d &#x27;1 week ago&#x27; +%H:%M:%S)&quot; | tail -n +3</span><br><span class="line">  echo &quot;&quot;</span><br><span class="line">&#125; &gt; &quot;$LOG_DIR/memory_usage.txt&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”Ÿæˆåˆ†ææŠ¥å‘Š</span></span><br><span class="line">&#123;</span><br><span class="line">  echo &quot;=== è‡ªåŠ¨åˆ†ææŠ¥å‘Š ===&quot;</span><br><span class="line">  echo &quot;[1] æœ€è¿‘é‡å¯æ¬¡æ•°: $(grep -c &quot;reboot&quot; &quot;$LOG_DIR/reboot_history.txt&quot;)&quot;</span><br><span class="line">  echo &quot;[2] ç¡¬ä»¶é”™è¯¯è®¡æ•°: $(grep -ciE &quot;error|warning&quot; &quot;$LOG_DIR/hardware_issues.txt&quot;)&quot;</span><br><span class="line">  echo &quot;[3] OOM äº‹ä»¶è®¡æ•°: $(grep -ci &quot;oom&quot; &quot;$LOG_DIR/kernel_events.txt&quot;)&quot;</span><br><span class="line">  echo &quot;[4] æœåŠ¡å´©æºƒè®¡æ•°: $(grep -ciE &quot;crash|failed&quot; &quot;$LOG_DIR/service_crashes.txt&quot;)&quot;</span><br><span class="line">  echo &quot;&quot;</span><br><span class="line">  echo &quot;=== å»ºè®®æ’æŸ¥æ–¹å‘ ===&quot;</span><br><span class="line">  echo &quot;1. å¦‚æœå­˜åœ¨ç¡¬ä»¶é”™è¯¯: æ£€æŸ¥ç¡¬ç›˜(SMART)ã€å†…å­˜(memtest86+)ã€CPUæ¸©åº¦(sensors)&quot;</span><br><span class="line">  echo &quot;2. å¦‚æœå­˜åœ¨ OOM äº‹ä»¶: åˆ†æå†…å­˜ä½¿ç”¨æ¨¡å¼ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å†…å­˜æ³„æ¼&quot;</span><br><span class="line">  echo &quot;3. å¦‚æœæœåŠ¡é¢‘ç¹å´©æºƒ: æ£€æŸ¥å¯¹åº”æœåŠ¡çš„æ—¥å¿—(/var/log/[service])&quot;</span><br><span class="line">  echo &quot;4. å¦‚æœä¸æ›´æ–°ç›¸å…³: æ£€æŸ¥ /var/log/apt/history.log&quot;</span><br><span class="line">&#125; &gt; &quot;$LOG_DIR/analysis_report.txt&quot;</span><br><span class="line"></span><br><span class="line">echo &quot;æ—¥å¿—æ”¶é›†å®Œæˆï¼Œç»“æœä¿å­˜åœ¨: $LOG_DIR&quot;</span><br><span class="line">echo &quot;è¯·æŸ¥çœ‹ä»¥ä¸‹å…³é”®æ–‡ä»¶:&quot;</span><br><span class="line">echo &quot;1. analysis_report.txt    - å¿«é€Ÿåˆ†ææŠ¥å‘Š&quot;</span><br><span class="line">echo &quot;2. hardware_issues.txt    - ç¡¬ä»¶ç›¸å…³é—®é¢˜&quot;</span><br><span class="line">echo &quot;3. kernel_events.txt      - å†…æ ¸çº§é”™è¯¯&quot;</span><br><span class="line">echo &quot;4. service_crashes.txt    - æœåŠ¡å´©æºƒè®°å½•&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="HTTP-åè®®NASæ­å»º">HTTP åè®®NASæ­å»º</h2><blockquote><p>Nginx: ä½œä¸ºåå‘ä»£ç†ï¼Œå¤„ç† HTTPS å’Œè·¯ç”±ã€‚</p></blockquote><blockquote><p>FileBrowser: è½»é‡çº§æ–‡ä»¶ç®¡ç†å®¹å™¨ï¼ˆæ›¿ä»£ä¼ ç»Ÿ NAS ç•Œé¢ï¼‰ã€‚</p></blockquote><blockquote><p>Docker Compose: ç¼–æ’å®¹å™¨ä¾èµ–å…³ç³»ã€‚</p></blockquote><h3 id="docker-install-on-ubuntu">docker install on ubuntu</h3><blockquote><p>nginx å®‰è£…é…ç½®</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update -y</span><br><span class="line">sudo apt install docker.io</span><br><span class="line">sudo systemctl start docker</span><br><span class="line">sudo systemctl enable docker</span><br><span class="line">docker --version</span><br><span class="line">sudo apt install docker-compose</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br><span class="line"></span><br><span class="line">sudo docker pull nginx</span><br><span class="line">sudo docker images</span><br><span class="line">sudo mkdir -p /data/nginx/conf</span><br><span class="line">sudo mkdir -p /data/nginx/conf.d</span><br><span class="line">sudo mkdir -p /data/nginx/html</span><br><span class="line">sudo mkdir -p /data/nginx/logs</span><br><span class="line"></span><br><span class="line">docker run --name nginx -d  -p 80:80   -v ~/nginx/nginx.conf:/etc/nginx/nginx.conf   -v ~/nginx/html:/usr/share/nginx/html   nginx</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="docker-ä»£ç†è®¾ç½®">docker ä»£ç†è®¾ç½®</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /etc/systemd/system/docker.service.d</span><br><span class="line">sudo vim /etc/systemd/system/docker.service.d/proxy.conf</span><br></pre></td></tr></table></figure><ul><li>å†™å…¥å¦‚ä¸‹æ–‡ä»¶</li></ul><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Environment</span>=<span class="string">&quot;HTTP_PROXY=http://192.168.10.65:7890&quot;</span></span><br><span class="line"><span class="attr">Environment</span>=<span class="string">&quot;HTTPS_PROXY=http://192.168.10.65.7890&quot;</span></span><br><span class="line"><span class="attr">Environment</span>=<span class="string">&quot;NO_PROXY=localhost,127.0.0.1&quot;</span></span><br></pre></td></tr></table></figure><ul><li>sudo vim /etc/docker/daemon.json</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;registry-mirrors&quot;: [&quot;https://dockerhub.icu&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="apache-æœåŠ¡å®‰è£…">apache æœåŠ¡å®‰è£…</h4><blockquote><p>åŸºç¡€å‡†å¤‡</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~/nas-docker/&#123;data,config,nginx,ssl&#125;</span><br><span class="line">cd ~/nas-docker</span><br></pre></td></tr></table></figure><blockquote><p>yml ç¼–è¾‘</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="comment"># FileBrowser æ–‡ä»¶ç®¡ç†æœåŠ¡</span></span><br><span class="line">  <span class="attr">filebrowser:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">filebrowser/filebrowser:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">filebrowser</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data:/srv</span>      <span class="comment"># æŒ‚è½½å…±äº«æ•°æ®ç›®å½•</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config/filebrowser:/etc/filebrowser</span>  <span class="comment"># é…ç½®æ–‡ä»¶</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">FB_BASEURL=/files</span>  <span class="comment"># æœåŠ¡è·¯å¾„</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nas-network</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Nginx åå‘ä»£ç†</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx-proxy</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;443:443&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx/nginx.conf:/etc/nginx/nginx.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./ssl:/etc/nginx/ssl</span>  <span class="comment"># SSL è¯ä¹¦ç›®å½•</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data:/usr/share/nginx/html</span>  <span class="comment"># é™æ€æ–‡ä»¶æ‰˜ç®¡ï¼ˆå¯é€‰ï¼‰</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">filebrowser</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nas-network</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">nas-network:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure><blockquote><p>nginx.conf</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  auto;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name localhost;  # æ›¿æ¢ä¸ºä½ çš„åŸŸå</span><br><span class="line">        return 301 https://$host$request_uri;  # HTTP é‡å®šå‘åˆ° HTTPS</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 443 ssl;</span><br><span class="line">        server_name nas.yourdomain.com;</span><br><span class="line"></span><br><span class="line">        # SSL è¯ä¹¦è·¯å¾„ï¼ˆéœ€æå‰ç”³è¯·æˆ–è‡ªç­¾åï¼‰</span><br><span class="line">        ssl_certificate /etc/nginx/ssl/fullchain.pem;</span><br><span class="line">        ssl_certificate_key /etc/nginx/ssl/privkey.pem;</span><br><span class="line"></span><br><span class="line">        # é™æ€æ–‡ä»¶æœåŠ¡ï¼ˆå¯é€‰ï¼‰</span><br><span class="line">        location / &#123;</span><br><span class="line">            root /usr/share/nginx/html;</span><br><span class="line">            autoindex on;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # ä»£ç† FileBrowser</span><br><span class="line">        location /files &#123;</span><br><span class="line">            proxy_pass http://filebrowser:80;</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">            proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è‡ªç­¾è¯ä¹¦</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£… certbot</span></span><br><span class="line">sudo apt install certbot</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”³è¯·è¯ä¹¦ï¼ˆéœ€ç¡®ä¿åŸŸåå·²è§£æåˆ°æœåŠ¡å™¨IPï¼‰</span></span><br><span class="line">sudo certbot certonly --standalone -d nas.yourdomain.com</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¤åˆ¶è¯ä¹¦åˆ° Docker æŒ‚è½½ç›®å½•</span></span><br><span class="line">sudo cp /etc/letsencrypt/live/nas.yourdomain.com/fullchain.pem ~/nas-docker/ssl/</span><br><span class="line">sudo cp /etc/letsencrypt/live/nas.yourdomain.com/privkey.pem ~/nas-docker/ssl/</span><br></pre></td></tr></table></figure><h4 id="æœåŠ¡å¯åŠ¨">æœåŠ¡å¯åŠ¨</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker-compose up -d</span><br></pre></td></tr></table></figure><h2 id="see">see</h2><ul><li><a href="https://webmin.com/">https://webmin.com/</a></li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäºè¾¹ç¼˜æ£€æµ‹ç®—æ³•æ£€æµ‹è§†é¢‘ä¸­æ–‡å­—</title>
      <link href="/2025/01/10/easyocr-gpuocr/"/>
      <url>/2025/01/10/easyocr-gpuocr/</url>
      
        <content type="html"><![CDATA[<h1>åŸºäºEasyocrçš„æ–‡å­—è¯†åˆ«</h1><blockquote><p>EasyOCR æ˜¯ä¸€ä¸ªå¼€æºçš„ OCR (å…‰å­¦å­—ç¬¦è¯†åˆ«) å·¥å…·ï¼Œèƒ½å¤Ÿå¿«é€Ÿå¹¶é«˜æ•ˆåœ°ä»å›¾åƒä¸­æå–æ–‡æœ¬ã€‚ä¸å…¶ä»–OCRå·¥å…·å¦‚ Tesseract ç›¸æ¯”ï¼ŒEasyOCR å…·æœ‰æ›´å¼ºçš„å¤šè¯­è¨€æ”¯æŒï¼ŒåŒ…æ‹¬å¯¹ä¸­æ–‡ã€æ—¥è¯­ã€é˜¿æ‹‰ä¼¯è¯­ç­‰å¤æ‚æ–‡å­—çš„æ”¯æŒï¼Œå¹¶ä¸”å®ƒçš„å®‰è£…å’Œä½¿ç”¨éå¸¸ç®€ä¾¿ã€‚</p></blockquote><h2 id="ä¸»è¦åŠŸèƒ½">ä¸»è¦åŠŸèƒ½</h2><blockquote><p>EasyOCR æ˜¯ä¸€ä¸ª Python åŒ…ï¼Œç”¨äºæ‰§è¡Œå…‰å­¦å­—ç¬¦è¯†åˆ« (OCR)ã€‚å®ƒæ—¨åœ¨æ˜“äºä½¿ç”¨ï¼Œå¹¶æ”¯æŒå¤šç§è¯­è¨€çš„æ–‡æœ¬è¯†åˆ«ã€‚å…¶ä¸»è¦ç‰¹ç‚¹åŒ…æ‹¬ï¼š</p></blockquote><ul><li><p>ç®€å•æ˜“ç”¨</p></li><li><p>å¤šè¯­è¨€æ”¯æŒ</p></li><li><p>GPU åŠ é€Ÿæ”¯æŒ</p></li><li><p>å¼€æº</p></li></ul><h2 id="å›¾åƒå¤„ç†ç®—æ³•è¯¦è§£">å›¾åƒå¤„ç†ç®—æ³•è¯¦è§£</h2><h2 id="1-å›¾åƒç¼©æ”¾-Image-Resizing">1. å›¾åƒç¼©æ”¾ (Image Resizing)</h2><h3 id="åŸç†">åŸç†</h3><p>å›¾åƒç¼©æ”¾æ˜¯æŒ‡æ”¹å˜å›¾åƒçš„å°ºå¯¸ï¼ŒåŒ…æ‹¬æ”¾å¤§ï¼ˆupscalingï¼‰å’Œç¼©å°ï¼ˆdownscalingï¼‰ä¸¤ç§æ“ä½œã€‚å…¶åŸºæœ¬åŸç†æ˜¯é€šè¿‡åƒç´ æ’å€¼ç®—æ³•ï¼Œåœ¨æ–°çš„å°ºå¯¸ä¸‹ä¼°è®¡å›¾åƒåƒç´ çš„å€¼ã€‚</p><h3 id="æŠ€æœ¯">æŠ€æœ¯</h3><p>å¸¸ç”¨çš„å›¾åƒç¼©æ”¾æŠ€æœ¯åŒ…æ‹¬ï¼š</p><ul><li><strong>æœ€è¿‘é‚»æ’å€¼ (Nearest Neighbor Interpolation):</strong><ul><li><strong>åŸç†:</strong> å°†ç›®æ ‡å›¾åƒçš„åƒç´ å€¼è®¾ç½®ä¸ºæºå›¾åƒä¸­è·ç¦»æœ€è¿‘çš„åƒç´ å€¼ã€‚</li><li><strong>ç‰¹ç‚¹:</strong> ç®€å•å¿«é€Ÿï¼Œä½†å¯èƒ½å¯¼è‡´å›¾åƒè¾¹ç¼˜å‡ºç°é”¯é½¿çŠ¶ã€‚</li></ul></li><li><strong>åŒçº¿æ€§æ’å€¼ (Bilinear Interpolation):</strong><ul><li><strong>åŸç†:</strong>  ä½¿ç”¨ç›®æ ‡å›¾åƒåƒç´ å‘¨å›´çš„ 2x2 é‚»åŸŸåƒç´ å€¼è¿›è¡ŒåŒçº¿æ€§æ’å€¼è®¡ç®—ã€‚</li><li><strong>ç‰¹ç‚¹:</strong> å›¾åƒæ•ˆæœæ¯”æœ€è¿‘é‚»æ’å€¼å¹³æ»‘ï¼Œè®¡ç®—é‡é€‚ä¸­ã€‚</li></ul></li><li><strong>åŒä¸‰æ¬¡æ’å€¼ (Bicubic Interpolation):</strong><ul><li><strong>åŸç†:</strong>  ä½¿ç”¨ç›®æ ‡å›¾åƒåƒç´ å‘¨å›´çš„ 4x4 é‚»åŸŸåƒç´ å€¼è¿›è¡ŒåŒä¸‰æ¬¡æ’å€¼è®¡ç®—ã€‚</li><li><strong>ç‰¹ç‚¹:</strong> å›¾åƒæ•ˆæœè¾ƒå¥½ï¼Œç»†èŠ‚ä¿ç•™è¾ƒå¤šï¼Œä½†è®¡ç®—é‡è¾ƒå¤§ã€‚</li></ul></li><li><strong>åŸºäºæ·±åº¦å­¦ä¹ çš„è¶…åˆ†è¾¨ç‡ (Super-Resolution):</strong><ul><li><strong>åŸç†:</strong> ä½¿ç”¨æ·±åº¦å­¦ä¹ æ¨¡å‹ (ä¾‹å¦‚, SRCNN, EDSR, ESRGAN) ä»ä½åˆ†è¾¨ç‡å›¾åƒé‡å»ºé«˜åˆ†è¾¨ç‡å›¾åƒ.</li><li><strong>ç‰¹ç‚¹:</strong> å¯ä»¥ç”Ÿæˆé«˜è´¨é‡çš„å›¾åƒï¼Œä½†æ˜¯è®¡ç®—é‡å¤§ï¼Œéœ€è¦å¤§é‡çš„è®­ç»ƒæ•°æ®ã€‚</li></ul></li></ul><h3 id="ç”¨é€”">ç”¨é€”</h3><ul><li><strong>è°ƒæ•´å›¾åƒå¤§å°ï¼š</strong>  é€‚åº”ä¸åŒçš„æ˜¾ç¤ºè®¾å¤‡æˆ–åº”ç”¨åœºæ™¯ã€‚</li><li><strong>é¢„å¤„ç†æ­¥éª¤ï¼š</strong>  ä½œä¸ºå…¶ä»–å›¾åƒå¤„ç†ç®—æ³• (å¦‚ç›®æ ‡æ£€æµ‹, OCR) çš„é¢„å¤„ç†æ­¥éª¤.</li><li><strong>ç”Ÿæˆä¸åŒåˆ†è¾¨ç‡çš„å›¾åƒï¼š</strong>  ç”¨äºåˆ›å»ºå›¾åƒé‡‘å­—å¡”æˆ–è¿›è¡Œå¤šå°ºåº¦åˆ†æã€‚</li></ul><h2 id="2-å›¾åƒè£å‰ª-Image-Cropping">2. å›¾åƒè£å‰ª (Image Cropping)</h2><h3 id="åŸç†-2">åŸç†</h3><p>å›¾åƒè£å‰ªæ˜¯æŒ‡ä»å›¾åƒä¸­é€‰æ‹©ä¸€ä¸ªçŸ©å½¢åŒºåŸŸï¼Œç„¶åå°†å…¶æå–å‡ºæ¥ã€‚å…¶åŸºæœ¬åŸç†æ˜¯æ ¹æ®æŒ‡å®šçš„èµ·å§‹åæ ‡å’Œå®½é«˜ï¼Œæˆªå–å›¾åƒå¯¹åº”çš„åƒç´ æ•°æ®ã€‚</p><h3 id="æŠ€æœ¯-2">æŠ€æœ¯</h3><ul><li><strong>çŸ©å½¢è£å‰ª:</strong>  æŒ‡å®šçŸ©å½¢å·¦ä¸Šè§’åæ ‡(x, y) å’ŒçŸ©å½¢çš„å®½åº¦ (w) å’Œé«˜åº¦ (h)ï¼Œç„¶åæå–è¿™ä¸ªçŸ©å½¢åŒºåŸŸçš„åƒç´ ã€‚</li><li><strong>ä»»æ„å½¢çŠ¶è£å‰ª:</strong>  ä½¿ç”¨æ©ç  (mask) æ¥æŒ‡å®šéœ€è¦è£å‰ªçš„åŒºåŸŸï¼Œmask å¯ä»¥æ˜¯ä»»æ„å½¢çŠ¶ã€‚</li></ul><h3 id="ç”¨é€”-2">ç”¨é€”</h3><ul><li><strong>å»é™¤å›¾åƒä¸­ä¸å¿…è¦çš„åŒºåŸŸï¼š</strong> çªå‡ºæ„Ÿå…´è¶£çš„ç›®æ ‡å¯¹è±¡æˆ–åŒºåŸŸã€‚</li><li><strong>è°ƒæ•´å›¾åƒæ„å›¾ï¼š</strong>  é‡æ–°æ„å›¾ï¼Œä½¿å›¾åƒæ›´ç¬¦åˆéœ€æ±‚ã€‚</li><li><strong>æ•°æ®å¢å¼ºï¼š</strong> ä½œä¸ºå›¾åƒæ•°æ®å¢å¼ºçš„ä¸€ç§æ–¹æ³•ï¼Œå¯ä»¥ç”Ÿæˆä¸åŒçš„å›¾åƒæ ·æœ¬ã€‚</li></ul><h2 id="3-å›¾åƒæ‹¼æ¥-Image-Stitching">3. å›¾åƒæ‹¼æ¥ (Image Stitching)</h2><h3 id="åŸç†-3">åŸç†</h3><p>å›¾åƒæ‹¼æ¥æ˜¯æŒ‡å°†å¤šå¼ å…·æœ‰é‡å åŒºåŸŸçš„å›¾åƒæ‹¼æ¥æˆä¸€å¼ å®Œæ•´çš„å…¨æ™¯å›¾åƒã€‚å…¶åŸºæœ¬åŸç†åŒ…æ‹¬å›¾åƒé…å‡†å’Œå›¾åƒèåˆä¸¤ä¸ªæ­¥éª¤ã€‚</p><h3 id="æŠ€æœ¯-3">æŠ€æœ¯</h3><ul><li><strong>ç‰¹å¾æ£€æµ‹å’ŒåŒ¹é… (Feature Detection and Matching):</strong><ul><li><strong>ç›®çš„:</strong>  æå–å›¾åƒä¸­çš„ç‰¹å¾ç‚¹ (å¦‚ SIFT, SURF, ORB ç­‰) å¹¶è¿›è¡ŒåŒ¹é…ï¼Œæ‰¾åˆ°å›¾åƒä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚</li></ul></li><li><strong>å›¾åƒé…å‡† (Image Registration):</strong><ul><li><strong>ç›®çš„:</strong>  æ ¹æ®åŒ¹é…åˆ°çš„ç‰¹å¾ç‚¹ï¼Œè®¡ç®—å›¾åƒä¹‹é—´çš„å˜æ¢å…³ç³»ï¼Œå°†å›¾åƒå¯¹é½ã€‚</li><li><strong>æŠ€æœ¯:</strong> ä½¿ç”¨å¦‚ RANSAC ç­‰ç®—æ³•ä¼°è®¡å›¾åƒçš„å˜æ¢çŸ©é˜µã€‚</li></ul></li><li><strong>å›¾åƒèåˆ (Image Blending):</strong><ul><li><strong>ç›®çš„:</strong> å°†å¯¹é½çš„å›¾åƒæ‹¼æ¥æˆä¸€å¼ å®Œæ•´çš„å›¾åƒã€‚</li><li><strong>æŠ€æœ¯:</strong>  ä½¿ç”¨å¦‚å¤šé¢‘å¸¦èåˆæˆ–åŠ æƒå¹³å‡ç­‰æ–¹æ³•å¤„ç†å›¾åƒé‡å åŒºåŸŸï¼Œé¿å…æ˜æ˜¾çš„æ¥ç¼ã€‚</li></ul></li><li><strong>æŸ±é¢æŠ•å½±:</strong><ul><li>**ç›®çš„:**å°†å›¾åƒæ˜ å°„åˆ°æŸ±é¢åæ ‡ç³»ï¼Œä»¥ä¾¿æ›´å¥½åœ°æ‹¼æ¥æ°´å¹³æ–¹å‘ä¸Šè§†è§’å˜åŒ–å¾ˆå¤§çš„å›¾åƒã€‚</li></ul></li></ul><h2 id="æµç¨‹">æµç¨‹</h2><pre><code>                             +-----------------------+                             | å¼€å§‹ process_video_threaded |                             +-----------------------+                                        |                                        V                  +------------------------------------------------+                  |  è°ƒç”¨ process_video å¤„ç†å•ä¸ªè§†é¢‘æ–‡ä»¶         |                  |  è·å– CPU, å†…å­˜ï¼ŒGPU ä½¿ç”¨ç‡ä¿¡æ¯             |                  |  è¾“å‡ºè§†é¢‘å¤„ç†ä¿¡æ¯å’Œæ€§èƒ½ä¿¡æ¯                      |                  +------------------------------------------------+                                        |                                        V       +------------------------------------------------------------+       | æ ¹æ® move_file, has_subtitle, ç§»åŠ¨æ–‡ä»¶åˆ° output_dir_with_subtitle  |       | æˆ– output_dir_without_subtitle ä¸‹çš„å­ç›®å½•ï¼Œå¹¶è®°å½•æ—¥å¿—         |       | (å¦‚æœªç§»åŠ¨ï¼Œåˆ™è®°å½•æœªç§»åŠ¨æ—¥å¿—)                                  |       +------------------------------------------------------------+                                        |                                        V                  +--------------------------------------------+                  |      ç»“æŸ process_video_threaded             |                  +--------------------------------------------+                                          |                                         V                             +-----------------------+                             | å¼€å§‹ process_video   |                             +-----------------------+                                        |                                        V                    +------------------------------------------------+                    |  ä½¿ç”¨ cv2.VideoCapture æ‰“å¼€è§†é¢‘æ–‡ä»¶              |                    |  å¦‚æœæ‰“å¼€å¤±è´¥ï¼Œè®°å½•æ—¥å¿—å¹¶è¿”å›                       |                    |  åˆå§‹åŒ– frame_count, subtitle_frame_count       |                    |  è®¾ç½®è·³å¸§å‚æ•° frame_skip                         |                    +------------------------------------------------+                                         |                                         V                            +------------------------+                            |  while å¾ªç¯è¯»å–è§†é¢‘å¸§        |                            |    å¦‚æœè¯»å–å¤±è´¥ï¼Œé€€å‡ºå¾ªç¯ |                            +------------------------+                                        |                                        V              +----------------------------------------------+              | å¦‚æœæ˜¯æŠ½å¸§ï¼Œåˆ™æ‰§è¡Œå­—å¹•åŒºåŸŸæ£€æµ‹ detect_subtitle_area|              |  å¦‚æœæ£€æµ‹å¤±è´¥ è¿”å›                               |              +----------------------------------------------+                                        |                                        V                         +---------------------------+                         | for subtitle_area in subtitle_areas |                         |    è°ƒç”¨ ocr_check           |                         +---------------------------+                                         |                                         V                 +------------------------------------------------------+                 |    æ ¹æ®ocræ£€æµ‹ç»“æœæ›´æ–° subtitle_frame_count            |                 +------------------------------------------------------+                                        |                                        V            +----------------------------------------------------------+            |  æ ¹æ® subtitle_frame_count å’Œ min_subtitle_frames       |            |  ç¡®å®šè§†é¢‘æ˜¯å¦æœ‰å­—å¹•ï¼Œå¹¶ç”Ÿæˆ output_file è·¯å¾„            |            |   è®°å½•è§†é¢‘å¤„ç†ä¿¡æ¯                                      |            +----------------------------------------------------------+                                       |                                       V                   +--------------------------+                   |  é‡Šæ”¾è§†é¢‘èµ„æºå’ŒGPUç¼“å­˜   |                   |     æ‰‹åŠ¨å†…å­˜å›æ”¶          |                   +--------------------------+                                        |                                        V                    +---------------------+                    |  ç»“æŸ process_video   |                    +---------------------+                                        |                                         V                           +------------------------+                           | å¼€å§‹ ocr_check      |                           +------------------------+                                      |                                      V                           +-----------------------------------+                           | ä½¿ç”¨ reader.readtext(roi,detail=0)     |                           |  å¦‚æœæ£€æµ‹åˆ°æ–‡å­—è¿”å› Trueï¼Œå¦åˆ™è¿”å› False |                           +-----------------------------------+                                      |                                      V                      +--------------------------+                      | ç»“æŸ ocr_check       |                      +--------------------------+</code></pre><h2 id="å®ç°">å®ç°</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _*_ coding: utf-8 _*_</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Time:     2025/1/3 10:37</span></span><br><span class="line"><span class="string">Author:   ZhaoQi Cao(czq)</span></span><br><span class="line"><span class="string">Version:  V 0.1</span></span><br><span class="line"><span class="string">File:     lan_detect_cal_new.py</span></span><br><span class="line"><span class="string">Describe: Write during the python at zgxmt, Github link: https://github.com/caozhaoqi</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> easyocr</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">import</span> psutil</span><br><span class="line"></span><br><span class="line">logging.basicConfig(level=logging.INFO, <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨GPU åŠ é€Ÿ</span></span><br><span class="line">reader = easyocr.Reader([<span class="string">&#x27;ch_sim&#x27;</span>,<span class="string">&#x27;en&#x27;</span>], gpu=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detect_subtitle_area</span>(<span class="params">frame, min_area=<span class="number">100</span>, max_area = <span class="number">1000</span>,threshold1 = <span class="number">100</span>, threshold2 = <span class="number">200</span></span>):</span><br><span class="line">  <span class="string">&quot;&quot;&quot;æ£€æµ‹å­—å¹•åŒºåŸŸ&quot;&quot;&quot;</span></span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">      gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)</span><br><span class="line">      blurred = cv2.GaussianBlur(gray, (<span class="number">5</span>, <span class="number">5</span>), <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">      edges = cv2.Canny(blurred, threshold1, threshold2)</span><br><span class="line">      contours, _ = cv2.findContours(edges, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)</span><br><span class="line">      subtitle_areas = []</span><br><span class="line">      <span class="keyword">for</span> contour <span class="keyword">in</span> contours:</span><br><span class="line">        area = cv2.contourArea(contour)</span><br><span class="line">        x, y, w, h = cv2.boundingRect(contour)</span><br><span class="line">        <span class="keyword">if</span> min_area &lt; area &lt; max_area:</span><br><span class="line">           subtitle_areas.append((x, y, w, h))</span><br><span class="line">      <span class="keyword">return</span> subtitle_areas</span><br><span class="line">  <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    logging.error(<span class="string">f&quot;æ£€æµ‹å­—å¹•åŒºåŸŸå¤±è´¥ <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ocr_check</span>(<span class="params">frame, subtitle_area</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ocræ£€æµ‹æ˜¯å¦æœ‰å­—å¹•&quot;&quot;&quot;</span></span><br><span class="line">    x,y,w,h = subtitle_area</span><br><span class="line">    roi = frame[y:y+h, x:x+w]</span><br><span class="line">    result = reader.readtext(roi)</span><br><span class="line">    <span class="keyword">if</span> result:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_video</span>(<span class="params">video_path, output_dir, min_area=<span class="number">100</span>, max_area=<span class="number">1000</span>, threshold1=<span class="number">100</span>, threshold2=<span class="number">200</span>, move_file=<span class="literal">False</span>, max_retries = <span class="number">3</span>, retry_delay = <span class="number">5</span>, min_subtitle_frames = <span class="number">5</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¤„ç†å•ä¸ªè§†é¢‘&quot;&quot;&quot;</span></span><br><span class="line">    logging.info(<span class="string">f&quot;å¼€å§‹å¤„ç†è§†é¢‘ï¼š<span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line">    temp_video_path = <span class="literal">None</span> <span class="comment"># ç”¨äºä¸´æ—¶æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">      <span class="keyword">if</span> move_file:</span><br><span class="line">          temp_dir = tempfile.mkdtemp()</span><br><span class="line">          temp_video_path = os.path.join(temp_dir, os.path.basename(video_path))</span><br><span class="line">          shutil.copy2(video_path, temp_video_path)  <span class="comment"># ä½¿ç”¨copy2 ä¿å­˜å…ƒæ•°æ®ï¼Œé¿å…ç§»åŠ¨æ–‡ä»¶</span></span><br><span class="line">          video_path = temp_video_path</span><br><span class="line">      cap = cv2.VideoCapture(video_path)</span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">not</span> cap.isOpened():</span><br><span class="line">            logging.error(<span class="string">f&quot;æ— æ³•æ‰“å¼€è§†é¢‘æ–‡ä»¶ï¼š<span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(output_dir):</span><br><span class="line">          os.makedirs(output_dir)</span><br><span class="line">      frame_count = <span class="number">0</span></span><br><span class="line">      subtitle_frame_count = <span class="number">0</span></span><br><span class="line">      <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">          ret, frame = cap.read()</span><br><span class="line">          <span class="keyword">if</span> <span class="keyword">not</span> ret:</span><br><span class="line">             <span class="keyword">break</span></span><br><span class="line">          subtitle_areas = detect_subtitle_area(frame, min_area, max_area, threshold1, threshold2)</span><br><span class="line">          <span class="keyword">for</span> subtitle_area <span class="keyword">in</span> subtitle_areas:</span><br><span class="line">            <span class="keyword">if</span> ocr_check(frame, subtitle_area):</span><br><span class="line">                subtitle_frame_count += <span class="number">1</span></span><br><span class="line">          frame_count += <span class="number">1</span></span><br><span class="line">          logging.info(<span class="string">f&quot;æ­£åœ¨å¤„ç†ç¬¬<span class="subst">&#123;frame_count&#125;</span>å¸§&quot;</span>)</span><br><span class="line">      logging.info(<span class="string">f&quot;å…±æ£€æµ‹åˆ°<span class="subst">&#123;subtitle_frame_count&#125;</span>å¼ å­—å¹•å›¾ç‰‡&quot;</span>)</span><br><span class="line">      cap.release()</span><br><span class="line">      has_subtitle = subtitle_frame_count &gt; min_subtitle_frames <span class="comment"># è‡³å°‘éœ€è¦min_subtitle_frameså¸§åŒ…å«å­—å¹•</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> has_subtitle <span class="keyword">and</span> move_file:</span><br><span class="line">         output_file = os.path.join(output_dir, os.path.basename(video_path))</span><br><span class="line">         <span class="keyword">for</span> attempt <span class="keyword">in</span> <span class="built_in">range</span>(max_retries):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                 shutil.move(video_path, output_file)</span><br><span class="line">                 logging.info(<span class="string">f&quot;ç§»åŠ¨æ–‡ä»¶åˆ°ï¼š <span class="subst">&#123;output_file&#125;</span>&quot;</span>)</span><br><span class="line">                 <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logging.error(<span class="string">f&quot;ç§»åŠ¨æ–‡ä»¶ <span class="subst">&#123;video_path&#125;</span> å¤±è´¥ï¼š<span class="subst">&#123;e&#125;</span>ï¼Œå°è¯•é‡æ–°ç§»åŠ¨ <span class="subst">&#123;attempt+<span class="number">1</span>&#125;</span> æ¬¡&quot;</span>)</span><br><span class="line">                time.sleep(retry_delay)</span><br><span class="line">         <span class="keyword">else</span>:</span><br><span class="line">               logging.error(<span class="string">f&quot;å°è¯•å¤šæ¬¡ç§»åŠ¨æ–‡ä»¶ <span class="subst">&#123;video_path&#125;</span> å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ˜¯å¦æœ‰è¿›ç¨‹æ­£åœ¨ä½¿ç”¨è¯¥æ–‡ä»¶&quot;</span>)</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">         <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">      <span class="keyword">elif</span> has_subtitle:</span><br><span class="line">            logging.info(<span class="string">f&quot;å½“å‰è§†é¢‘æœ‰å­—å¹•: <span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">           logging.info(<span class="string">f&quot;å½“å‰è§†é¢‘æ²¡æœ‰å­—å¹•: <span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">       logging.error(<span class="string">f&quot;å¤„ç†è§†é¢‘è¿‡ç¨‹å¤±è´¥ï¼š<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">if</span> temp_video_path <span class="keyword">and</span> os.path.exists(temp_video_path):</span><br><span class="line">            shutil.rmtree(os.path.dirname(temp_video_path), ignore_errors = <span class="literal">True</span>)</span><br><span class="line">            logging.info(<span class="string">f&quot;æ¸…ç†ä¸´æ—¶æ–‡ä»¶ <span class="subst">&#123;temp_video_path&#125;</span> å®Œæˆ&quot;</span>)</span><br><span class="line">        logging.info(<span class="string">f&quot;è§†é¢‘å¤„ç†å®Œæˆï¼š<span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_video_threaded</span>(<span class="params">video_path, output_dir, min_area=<span class="number">100</span>, max_area=<span class="number">1000</span>, threshold1=<span class="number">100</span>, threshold2=<span class="number">200</span>, move_file = <span class="literal">False</span>, max_retries = <span class="number">3</span>, retry_delay = <span class="number">5</span>, min_subtitle_frames = <span class="number">5</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¤šçº¿ç¨‹å¤„ç†è§†é¢‘&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">       start_time = time.time()</span><br><span class="line">       result = process_video(video_path, output_dir, min_area, max_area, threshold1, threshold2, move_file, max_retries, retry_delay, min_subtitle_frames)</span><br><span class="line">       end_time = time.time()</span><br><span class="line">       cpu_percent = psutil.cpu_percent() <span class="comment"># è·å–cpuä½¿ç”¨ç‡</span></span><br><span class="line">       logging.info(<span class="string">f&quot;è§†é¢‘ï¼š<span class="subst">&#123;video_path&#125;</span>, è€—æ—¶ï¼š<span class="subst">&#123;end_time - start_time:<span class="number">.2</span>f&#125;</span> ç§’,  CPU åˆ©ç”¨ç‡ï¼š<span class="subst">&#123;cpu_percent:<span class="number">.2</span>f&#125;</span>%&quot;</span>)</span><br><span class="line">       <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">      logging.error(<span class="string">f&quot;å¤„ç†è§†é¢‘ <span class="subst">&#123;video_path&#125;</span> å¤±è´¥ï¼š<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_directory_multithreaded</span>(<span class="params">input_dir, output_dir, min_area=<span class="number">100</span>, max_area=<span class="number">1000</span>, threshold1=<span class="number">100</span>, threshold2=<span class="number">200</span>, allowed_extensions=(<span class="params"><span class="string">&#x27;.mp4&#x27;</span>, <span class="string">&#x27;.avi&#x27;</span>, <span class="string">&#x27;.mov&#x27;</span>, <span class="string">&#x27;.mkv&#x27;</span></span>), num_threads = <span class="number">4</span>, move_file = <span class="literal">False</span>, max_retries = <span class="number">3</span>, retry_delay = <span class="number">5</span>, min_subtitle_frames = <span class="number">5</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¤šçº¿ç¨‹å¤„ç†æŒ‡å®šç›®å½•ä¸‹æ‰€æœ‰è§†é¢‘&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(input_dir):</span><br><span class="line">      logging.error(<span class="string">f&quot;é”™è¯¯ï¼šè¾“å…¥çš„ä¸æ˜¯ç›®å½•: <span class="subst">&#123;input_dir&#125;</span>&quot;</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    video_files = []</span><br><span class="line">    <span class="keyword">for</span> root, _, files <span class="keyword">in</span> os.walk(input_dir):</span><br><span class="line">      <span class="keyword">for</span> filename <span class="keyword">in</span> files:</span><br><span class="line">        <span class="keyword">if</span> filename.lower().endswith(allowed_extensions):</span><br><span class="line">          video_files.append(os.path.join(root, filename))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> tqdm(total=<span class="built_in">len</span>(video_files), desc=<span class="string">&quot;å¤„ç†è§†é¢‘&quot;</span>, unit=<span class="string">&quot;video&quot;</span>) <span class="keyword">as</span> pbar:</span><br><span class="line">        threads = []</span><br><span class="line">        <span class="keyword">for</span> video_path <span class="keyword">in</span> video_files:</span><br><span class="line">          relative_path = os.path.relpath(video_path, input_dir)</span><br><span class="line">          output_subdir = os.path.join(output_dir, os.path.splitext(relative_path)[<span class="number">0</span>])</span><br><span class="line">          thread = threading.Thread(target=process_video_threaded, args=(video_path, output_subdir, min_area, max_area, threshold1, threshold2, move_file, max_retries, retry_delay, min_subtitle_frames))</span><br><span class="line">          threads.append(thread)</span><br><span class="line">          thread.start()</span><br><span class="line">          <span class="keyword">if</span> <span class="built_in">len</span>(threads) &gt;= num_threads:  <span class="comment"># æ§åˆ¶çº¿ç¨‹æ•°é‡</span></span><br><span class="line">            <span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">               thread.join()</span><br><span class="line">            threads = []</span><br><span class="line">          pbar.update(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> thread <span class="keyword">in</span> threads:</span><br><span class="line">          thread.join()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    input_dir = <span class="string">r&#x27;E:\æµ‹è¯•&#x27;</span>  <span class="comment"># æ›¿æ¢ä¸ºä½ çš„è§†é¢‘æ–‡ä»¶æ ¹ç›®å½•è·¯å¾„</span></span><br><span class="line">    output_dir = <span class="string">r&quot;E:\æµ‹è¯•\subtitle_videos&quot;</span>  <span class="comment"># æ›¿æ¢ä¸ºä½ çš„å­—å¹•è§†é¢‘è¾“å‡ºè·¯å¾„</span></span><br><span class="line">    min_area = <span class="number">100</span>  <span class="comment"># å¯é€‰å‚æ•°ï¼Œæœ€å°è¿é€šåŸŸé¢ç§¯</span></span><br><span class="line">    max_area = <span class="number">1000</span>  <span class="comment"># å¯é€‰å‚æ•°ï¼Œæœ€å¤§è¿é€šåŸŸé¢ç§¯</span></span><br><span class="line">    threshold1 = <span class="number">100</span>  <span class="comment"># å¯é€‰å‚æ•°ï¼Œ cannyè¾¹ç¼˜æ£€æµ‹çš„é˜ˆå€¼</span></span><br><span class="line">    threshold2 = <span class="number">200</span>  <span class="comment"># å¯é€‰å‚æ•°ï¼Œ cannyè¾¹ç¼˜æ£€æµ‹çš„é˜ˆå€¼</span></span><br><span class="line">    num_threads = <span class="number">4</span>  <span class="comment"># å¯é€‰å‚æ•°ï¼Œ çº¿ç¨‹æ•°</span></span><br><span class="line">    move_file = <span class="literal">True</span> <span class="comment"># æ˜¯å¦ç§»åŠ¨æ–‡ä»¶</span></span><br><span class="line">    max_retries = <span class="number">3</span>  <span class="comment"># æœ€å¤§é‡è¯•æ¬¡æ•°</span></span><br><span class="line">    retry_delay = <span class="number">5</span> <span class="comment"># é‡è¯•é—´éš”æ—¶é—´</span></span><br><span class="line">    min_subtitle_frames = <span class="number">5</span> <span class="comment"># æœ€å°å­—å¹•å¸§æ•°</span></span><br><span class="line"></span><br><span class="line">    process_directory_multithreaded(input_dir, output_dir, min_area, max_area, threshold1, threshold2, num_threads= num_threads, move_file=move_file, max_retries=max_retries, retry_delay=retry_delay, min_subtitle_frames=min_subtitle_frames)</span><br></pre></td></tr></table></figure><h2 id="tips">tips</h2><p><strong>å‚æ•°è§£é‡Šä¸å»ºè®®å€¼:</strong></p><ol><li><p><strong><code>min_area = 100</code> (å¯é€‰å‚æ•°ï¼Œæœ€å°è¿é€šåŸŸé¢ç§¯)</strong></p><ul><li><strong>å«ä¹‰ï¼š</strong> è¿™ä¸ªå‚æ•°è¡¨ç¤ºåœ¨æ£€æµ‹å­—å¹•åŒºåŸŸæ—¶ï¼Œè¢«è®¤ä¸ºæ˜¯æœ‰æ•ˆå­—å¹•åŒºåŸŸçš„æœ€å°è¿é€šåŸŸé¢ç§¯ã€‚è¿é€šåŸŸæ˜¯æŒ‡å›¾åƒä¸­åƒç´ å€¼ç›¸è¿‘ä¸”ç›¸äº’è¿æ¥çš„åŒºåŸŸã€‚</li><li><strong>å•ä½ï¼š</strong> åƒç´  (pixels)ã€‚</li><li><strong>ä½œç”¨ï¼š</strong> ç”¨äºè¿‡æ»¤æ‰è¿‡å°çš„å™ªå£°æˆ–å¹²æ‰°åŒºåŸŸï¼Œè¿™äº›åŒºåŸŸé€šå¸¸ä¸æ˜¯çœŸå®çš„å­—å¹•ã€‚</li><li><strong>å»ºè®®å€¼ï¼š</strong><ul><li><strong>é»˜è®¤å€¼ï¼š</strong> <code>100</code> æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„èµ·å§‹å€¼ï¼Œé€‚ç”¨äºå­—å¹•å­—ä½“å¤§å°é€‚ä¸­çš„æƒ…å†µã€‚</li><li><strong>è°ƒæ•´æ–¹å‘ï¼š</strong><ul><li><strong>å¦‚æœæ£€æµ‹åˆ°å¤ªå¤šå™ªå£°ï¼š</strong> å¯ä»¥é€‚å½“å¢å¤§ <code>min_area</code> çš„å€¼ï¼Œä¾‹å¦‚ <code>150</code> æˆ– <code>200</code>ã€‚</li><li><strong>å¦‚æœæ¼æ£€äº†å°å­—å¹•ï¼š</strong> å¯ä»¥é€‚å½“å‡å° <code>min_area</code> çš„å€¼ï¼Œä¾‹å¦‚ <code>50</code> æˆ– <code>80</code>ã€‚</li></ul></li><li><strong>å…·ä½“è°ƒæ•´ï¼š</strong><ul><li>ä½ éœ€è¦æ ¹æ®è§†é¢‘çš„åˆ†è¾¨ç‡å’Œå­—å¹•å­—ä½“å¤§å°è¿›è¡Œè°ƒæ•´ï¼Œ å¦‚æœä½ çš„è§†é¢‘æ˜¯é«˜æ¸…çš„ï¼Œå­—å¹•å­—ä½“æ¯”è¾ƒå¤§ï¼Œåˆ™å¯ä»¥è®¾ç½®æ›´å¤§ï¼Œåä¹‹åˆ™å‡å°ã€‚</li><li>å¯ä»¥å…ˆå°è¯•ä¸ä¿®æ”¹ï¼Œè¿è¡Œä»£ç æŸ¥çœ‹æ—¥å¿—æˆ–è€…è¾“å‡ºçš„å›¾ç‰‡ï¼Œå†æ ¹æ®ç»“æœè¿›è¡Œè°ƒæ•´ã€‚</li></ul></li></ul></li><li><strong>æ³¨æ„äº‹é¡¹ï¼š</strong><ul><li><code>min_area</code> çš„å€¼ä¸åº”è®¾ç½®å¾—å¤ªå°ï¼Œå¦åˆ™ä¼šæŠŠä¸€äº›å°çš„å™ªç‚¹é”™è¯¯è¯†åˆ«ä¸ºå­—å¹•ã€‚</li></ul></li></ul></li><li><p><strong><code>max_area = 1000</code> (å¯é€‰å‚æ•°ï¼Œæœ€å¤§è¿é€šåŸŸé¢ç§¯)</strong></p><ul><li><strong>å«ä¹‰ï¼š</strong> è¿™ä¸ªå‚æ•°è¡¨ç¤ºåœ¨æ£€æµ‹å­—å¹•åŒºåŸŸæ—¶ï¼Œè¢«è®¤ä¸ºæ˜¯æœ‰æ•ˆå­—å¹•åŒºåŸŸçš„æœ€å¤§è¿é€šåŸŸé¢ç§¯ã€‚</li><li><strong>å•ä½ï¼š</strong> åƒç´  (pixels)ã€‚</li><li><strong>ä½œç”¨ï¼š</strong> ç”¨äºè¿‡æ»¤æ‰è¿‡å¤§çš„åŒºåŸŸï¼Œä¾‹å¦‚èƒŒæ™¯æˆ–å…¶ä»–çš„æ–‡æœ¬åŒºåŸŸã€‚</li><li><strong>å»ºè®®å€¼ï¼š</strong><ul><li><strong>é»˜è®¤å€¼ï¼š</strong> <code>1000</code> æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„èµ·å§‹å€¼ï¼Œé€‚ç”¨äºå­—å¹•å­—ä½“å¤§å°é€‚ä¸­çš„æƒ…å†µã€‚</li><li><strong>è°ƒæ•´æ–¹å‘ï¼š</strong><ul><li><strong>å¦‚æœæ£€æµ‹åˆ°è¿‡å¤§çš„åŒºåŸŸï¼š</strong> å¯ä»¥é€‚å½“å‡å° <code>max_area</code> çš„å€¼ï¼Œä¾‹å¦‚ <code>800</code> æˆ– <code>900</code>ã€‚</li><li><strong>å¦‚æœæ¼æ£€äº†å­—å¹•ï¼š</strong> å¦‚æœä½ çš„å­—å¹•å­—ä½“éå¸¸å¤§ï¼Œæˆ–è€…åŒ…å«å¤šä¸ªè¿é€šåŒºåŸŸï¼Œ å¯ä»¥å°è¯•å¢åŠ  <code>max_area</code> ä¾‹å¦‚ <code>1500</code>ã€‚</li></ul></li><li><strong>å…·ä½“è°ƒæ•´ï¼š</strong><ul><li>ä½ éœ€è¦æ ¹æ®è§†é¢‘çš„åˆ†è¾¨ç‡å’Œå­—å¹•å­—ä½“å¤§å°è¿›è¡Œè°ƒæ•´ï¼Œ å¦‚æœä½ çš„è§†é¢‘æ˜¯é«˜æ¸…çš„ï¼Œå­—å¹•å­—ä½“æ¯”è¾ƒå¤§ï¼Œåˆ™å¯ä»¥è®¾ç½®æ›´å¤§ï¼Œåä¹‹åˆ™å‡å°ã€‚</li><li>å¯ä»¥å…ˆå°è¯•ä¸ä¿®æ”¹ï¼Œè¿è¡Œä»£ç æŸ¥çœ‹æ—¥å¿—æˆ–è€…è¾“å‡ºçš„å›¾ç‰‡ï¼Œå†æ ¹æ®ç»“æœè¿›è¡Œè°ƒæ•´ã€‚</li></ul></li></ul></li><li><strong>æ³¨æ„äº‹é¡¹ï¼š</strong><ul><li><code>max_area</code> çš„å€¼ä¸åº”è®¾ç½®çš„å¤ªé«˜ï¼Œå¦åˆ™ä¼šå°†ä¸€äº›èƒŒæ™¯ä¸­çš„æ–‡å­—è¯¯è®¤ä¸ºæ˜¯å­—å¹•ã€‚</li></ul></li></ul></li><li><p><strong><code>threshold1 = 100</code> (å¯é€‰å‚æ•°ï¼ŒCanny è¾¹ç¼˜æ£€æµ‹çš„é˜ˆå€¼ 1)</strong></p><ul><li><strong>å«ä¹‰ï¼š</strong>  Canny è¾¹ç¼˜æ£€æµ‹ç®—æ³•æœ‰ä¸¤ä¸ªé˜ˆå€¼ï¼Œ<code>threshold1</code> æ˜¯è¾ƒä½çš„é˜ˆå€¼ã€‚</li><li><strong>å•ä½ï¼š</strong>  æ— å•ä½ï¼Œè¡¨ç¤ºåƒç´ å€¼å˜åŒ–çš„å¤§å°ã€‚</li><li><strong>ä½œç”¨ï¼š</strong> ç”¨äºæ£€æµ‹å›¾åƒä¸­çš„è¾¹ç¼˜ã€‚è¾ƒä½çš„é˜ˆå€¼å°†æ£€æµ‹å‡ºæ›´å¤šçš„è¾¹ç¼˜ï¼Œå¯èƒ½åŒ…æ‹¬ä¸€äº›å™ªå£°ã€‚</li><li><strong>å»ºè®®å€¼ï¼š</strong><ul><li><strong>é»˜è®¤å€¼ï¼š</strong> <code>100</code> æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„èµ·å§‹å€¼ã€‚</li><li><strong>è°ƒæ•´æ–¹å‘ï¼š</strong><ul><li><strong>å¦‚æœæ£€æµ‹åˆ°å¤ªå¤šä¸å¿…è¦çš„è¾¹ç¼˜ï¼š</strong> å¯ä»¥é€‚å½“å¢å¤§ <code>threshold1</code> çš„å€¼ï¼Œä¾‹å¦‚ <code>120</code> æˆ– <code>150</code>ã€‚</li><li><strong>å¦‚æœæ¼æ£€äº†å­—å¹•çš„è¾¹ç¼˜ï¼š</strong> å¯ä»¥é€‚å½“å‡å° <code>threshold1</code> çš„å€¼ï¼Œä¾‹å¦‚ <code>80</code> æˆ– <code>90</code>ã€‚</li></ul></li><li><strong>å…·ä½“è°ƒæ•´ï¼š</strong><ul><li>éœ€è¦æ ¹æ®è§†é¢‘çš„å›¾åƒè´¨é‡è¿›è¡Œè°ƒæ•´ï¼Œå¦‚æœè§†é¢‘æ¯”è¾ƒæ¨¡ç³Šï¼Œåˆ™å¯ä»¥é€‚å½“é™ä½<code>threshold1</code>çš„å€¼ï¼Œæé«˜æ£€æµ‹çš„æ•æ„Ÿæ€§ï¼Œåä¹‹åˆ™å¯ä»¥å¢åŠ <code>threshold1</code>ã€‚</li><li>å¯ä»¥å…ˆå°è¯•ä¸ä¿®æ”¹ï¼Œè¿è¡Œä»£ç æŸ¥çœ‹æ—¥å¿—æˆ–è€…è¾“å‡ºçš„å›¾ç‰‡ï¼Œå†æ ¹æ®ç»“æœè¿›è¡Œè°ƒæ•´ã€‚</li></ul></li></ul></li></ul></li><li><p><strong><code>threshold2 = 200</code> (å¯é€‰å‚æ•°ï¼ŒCanny è¾¹ç¼˜æ£€æµ‹çš„é˜ˆå€¼ 2)</strong></p><ul><li><strong>å«ä¹‰ï¼š</strong> <code>threshold2</code> æ˜¯ Canny è¾¹ç¼˜æ£€æµ‹ç®—æ³•ä¸­è¾ƒé«˜çš„é˜ˆå€¼ã€‚</li><li><strong>å•ä½ï¼š</strong> æ— å•ä½ï¼Œè¡¨ç¤ºåƒç´ å€¼å˜åŒ–çš„å¤§å°ã€‚</li><li><strong>ä½œç”¨ï¼š</strong> è¾ƒé«˜é˜ˆå€¼ç”¨äºè¿‡æ»¤æ‰å¼±è¾¹ç¼˜ï¼Œç¡®ä¿åªç•™ä¸‹è¾ƒå¼ºçš„è¾¹ç¼˜ã€‚</li><li><strong>å»ºè®®å€¼ï¼š</strong><ul><li><strong>é»˜è®¤å€¼:</strong> <code>200</code> æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„èµ·å§‹å€¼ã€‚</li><li><strong>è°ƒæ•´æ–¹å‘:</strong><ul><li><strong>å¦‚æœæ£€æµ‹åˆ°å¤ªå¤šä¸å¿…è¦çš„è¾¹ç¼˜:</strong> å¯ä»¥é€‚å½“å¢å¤§ <code>threshold2</code> çš„å€¼ï¼Œä¾‹å¦‚ <code>220</code> æˆ– <code>250</code>ã€‚</li><li><strong>å¦‚æœæ¼æ£€äº†å­—å¹•çš„è¾¹ç¼˜:</strong> å¯ä»¥é€‚å½“å‡å° <code>threshold2</code> çš„å€¼ï¼Œä¾‹å¦‚ <code>180</code> æˆ– <code>190</code>ã€‚</li></ul></li><li><strong>å…·ä½“è°ƒæ•´:</strong><ul><li><code>threshold2</code>çš„å€¼éœ€è¦é«˜äº<code>threshold1</code>çš„å€¼ï¼Œ ä½ å¯ä»¥æ ¹æ®è§†é¢‘çš„å›¾åƒè´¨é‡è¿›è¡Œè°ƒæ•´ï¼Œå¦‚æœè§†é¢‘æ¯”è¾ƒæ¨¡ç³Šï¼Œåˆ™å¯ä»¥é€‚å½“é™ä½<code>threshold2</code>çš„å€¼ï¼Œæé«˜æ£€æµ‹çš„æ•æ„Ÿæ€§ï¼Œåä¹‹åˆ™å¯ä»¥å¢åŠ <code>threshold2</code>ã€‚</li><li>å¯ä»¥å…ˆå°è¯•ä¸ä¿®æ”¹ï¼Œè¿è¡Œä»£ç æŸ¥çœ‹æ—¥å¿—æˆ–è€…è¾“å‡ºçš„å›¾ç‰‡ï¼Œå†æ ¹æ®ç»“æœè¿›è¡Œè°ƒæ•´ã€‚</li></ul></li></ul></li><li><strong>æ³¨æ„äº‹é¡¹:</strong><ul><li><code>threshold2</code> çš„å€¼ä¸åº”ä¸ <code>threshold1</code> ç›¸å·®è¿‡å¤§ï¼Œå¦åˆ™è¾¹ç¼˜æ£€æµ‹å¯èƒ½ä¼šå¤±è´¥ã€‚</li></ul></li></ul></li><li><p><strong><code>num_threads = 4</code> (å¯é€‰å‚æ•°ï¼Œçº¿ç¨‹æ•°)</strong></p><ul><li><strong>å«ä¹‰ï¼š</strong>  ç”¨äºæŒ‡å®šå¤šçº¿ç¨‹å¤„ç†è§†é¢‘æ—¶ä½¿ç”¨çš„çº¿ç¨‹æ•°é‡ã€‚</li><li><strong>å•ä½ï¼š</strong> çº¿ç¨‹æ•°ã€‚</li><li><strong>ä½œç”¨ï¼š</strong>  å¤šçº¿ç¨‹å¯ä»¥æé«˜è§†é¢‘å¤„ç†é€Ÿåº¦ï¼Œå……åˆ†åˆ©ç”¨ CPU èµ„æºã€‚</li><li><strong>å»ºè®®å€¼ï¼š</strong><ul><li><strong>é»˜è®¤å€¼:</strong> <code>4</code> æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„èµ·å§‹å€¼ï¼Œé€‚ç”¨äºå¤§å¤šæ•° 4 æ ¸æˆ– 8 æ ¸ CPUã€‚</li><li><strong>è°ƒæ•´æ–¹å‘:</strong><ul><li><strong>å¦‚æœä½ çš„ CPU æ ¸å¿ƒæ•°è¾ƒå°‘ï¼š</strong> å¯ä»¥é€‚å½“å‡å° <code>num_threads</code> çš„å€¼ï¼Œä¾‹å¦‚ <code>2</code>ã€‚</li><li><strong>å¦‚æœä½ çš„ CPU æ ¸å¿ƒæ•°è¾ƒå¤šï¼Œä¸”èµ„æºå……è¶³:</strong> å¯ä»¥é€‚å½“å¢åŠ  <code>num_threads</code> çš„å€¼ï¼Œä¾‹å¦‚ <code>8</code> æˆ– <code>16</code>ã€‚</li></ul></li><li><strong>å…·ä½“è°ƒæ•´ï¼š</strong><ul><li>ä½ éœ€è¦æ ¹æ®ä½ çš„CPUçš„æ€§èƒ½è¿›è¡Œè°ƒæ•´ï¼Œå¦‚æœCPUæ€§èƒ½æ¯”è¾ƒå¼ºï¼Œå¯ä»¥é€‚å½“æé«˜ï¼Œå¦åˆ™åˆ™å¯ä»¥é™ä½ã€‚</li><li>å¦‚æœå¤šçº¿ç¨‹å¤„ç†å¯¼è‡´å†…å­˜å ç”¨è¿‡å¤šï¼Œå¯ä»¥è€ƒè™‘é™ä½çº¿ç¨‹æ•°é‡ã€‚</li></ul></li></ul></li><li><strong>æ³¨æ„äº‹é¡¹ï¼š</strong><ul><li><code>num_threads</code> ä¸åº”è¶…è¿‡ä½  CPU çš„æ ¸å¿ƒæ•°ï¼Œè¿‡å¤šçš„çº¿ç¨‹å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ï¼Œèµ„æºå ç”¨è¿‡å¤šã€‚</li></ul></li></ul></li><li><p><strong><code>move_file = True</code> (å¯é€‰å‚æ•°ï¼Œæ˜¯å¦ç§»åŠ¨æ–‡ä»¶)</strong></p><ul><li><strong>å«ä¹‰ï¼š</strong>  ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œå†³å®šæ˜¯å¦å°†æ£€æµ‹åˆ°å­—å¹•çš„è§†é¢‘æ–‡ä»¶ç§»åŠ¨åˆ°è¾“å‡ºæ–‡ä»¶å¤¹ã€‚</li><li><strong>å–å€¼ï¼š</strong>  <code>True</code> (ç§»åŠ¨æ–‡ä»¶) æˆ– <code>False</code> (ä¸ç§»åŠ¨æ–‡ä»¶)ã€‚</li><li><strong>ä½œç”¨ï¼š</strong><ul><li><code>True</code>: å°†æ£€æµ‹åˆ°å­—å¹•çš„è§†é¢‘æ–‡ä»¶ç§»åŠ¨åˆ°è¾“å‡ºæ–‡ä»¶å¤¹ã€‚</li><li><code>False</code>: åªæ£€æµ‹è§†é¢‘ä¸­æ˜¯å¦æœ‰å­—å¹•ï¼Œä¸ç§»åŠ¨è§†é¢‘æ–‡ä»¶ã€‚</li></ul></li><li><strong>å»ºè®®å€¼ï¼š</strong><ul><li><strong>æ ¹æ®ä½ çš„éœ€æ±‚é€‰æ‹©:</strong> å¦‚æœä½ éœ€è¦æ•´ç†æœ‰å­—å¹•çš„è§†é¢‘æ–‡ä»¶ï¼Œè®¾ç½®ä¸º <code>True</code>ï¼›å¦‚æœåªéœ€è¦æ£€æµ‹å­—å¹•ï¼Œåˆ™è®¾ç½®ä¸º <code>False</code>ã€‚</li></ul></li></ul></li><li><p><strong><code>max_retries = 3</code> (å¯é€‰å‚æ•°ï¼Œæœ€å¤§é‡è¯•æ¬¡æ•°)</strong></p><ul><li><strong>å«ä¹‰ï¼š</strong>  å½“ç§»åŠ¨è§†é¢‘æ–‡ä»¶å¤±è´¥æ—¶ï¼Œä»£ç ä¼šå°è¯•é‡æ–°ç§»åŠ¨çš„æœ€å¤§æ¬¡æ•°ã€‚</li><li><strong>å•ä½ï¼š</strong>  æ¬¡æ•°ã€‚</li><li><strong>ä½œç”¨ï¼š</strong>  é¿å…ç”±äºä¸´æ—¶æ–‡ä»¶å ç”¨å¯¼è‡´çš„ç§»åŠ¨å¤±è´¥ï¼Œä¿è¯ä»£ç çš„é²æ£’æ€§ã€‚</li><li><strong>å»ºè®®å€¼ï¼š</strong><ul><li><strong>é»˜è®¤å€¼ï¼š</strong> <code>3</code> æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„èµ·å§‹å€¼ã€‚</li><li><strong>è°ƒæ•´æ–¹å‘ï¼š</strong><ul><li>å¦‚æœä½ çš„è¿è¡Œç¯å¢ƒç»å¸¸å‡ºç°æ–‡ä»¶è¢«å ç”¨çš„é—®é¢˜ï¼Œå¯ä»¥è€ƒè™‘å¢åŠ æ¬¡æ•°ï¼Œæ¯”å¦‚<code>5</code></li><li>å¦‚æœå¯¹é€Ÿåº¦è¦æ±‚æ¯”è¾ƒé«˜ï¼Œå¯ä»¥è€ƒè™‘å‡å°æ¬¡æ•°ï¼Œæ¯”å¦‚ <code>2</code></li></ul></li></ul></li><li><strong>æ³¨æ„äº‹é¡¹ï¼š</strong><ul><li><code>max_retries</code> ä¸å®œè®¾ç½®è¿‡é«˜ï¼Œé¿å…ä¸€ç›´ç­‰å¾…å ç”¨èµ„æºã€‚</li></ul></li></ul></li><li><p><strong><code>retry_delay = 5</code> (å¯é€‰å‚æ•°ï¼Œé‡è¯•é—´éš”æ—¶é—´)</strong></p><ul><li><strong>å«ä¹‰ï¼š</strong>  å½“ç§»åŠ¨è§†é¢‘æ–‡ä»¶å¤±è´¥æ—¶ï¼Œä»£ç ç­‰å¾…å¤šé•¿æ—¶é—´å†æ¬¡å°è¯•ç§»åŠ¨ï¼Œå•ä½ä¸ºç§’ã€‚</li><li><strong>å•ä½ï¼š</strong> ç§’ (seconds)ã€‚</li><li><strong>ä½œç”¨ï¼š</strong>  é¿å…é¢‘ç¹åœ°é‡è¯•å ç”¨æ–‡ä»¶å¯¼è‡´ç³»ç»Ÿèµ„æºç´§å¼ ã€‚</li><li><strong>å»ºè®®å€¼ï¼š</strong><ul><li><strong>é»˜è®¤å€¼ï¼š</strong> <code>5</code> ç§’æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„èµ·å§‹å€¼ã€‚</li><li><strong>è°ƒæ•´æ–¹å‘ï¼š</strong><ul><li>å¦‚æœä½ è®¤ä¸º5ç§’çš„ç­‰å¾…æ—¶é—´å¤ªé•¿ï¼Œå¯ä»¥ç¼©çŸ­ä¸º<code>3</code> æˆ–è€…æ›´å°ã€‚</li><li>å¦‚æœä½ è®¤ä¸º5ç§’çš„ç­‰å¾…æ—¶é—´å¤ªçŸ­ï¼Œå¯ä»¥åŠ é•¿åˆ°<code>10</code> æˆ–è€…æ›´å¤šã€‚</li></ul></li></ul></li><li><strong>æ³¨æ„äº‹é¡¹ï¼š</strong><ul><li><code>retry_delay</code> çš„æ—¶é—´ä¸åº”è¿‡çŸ­ï¼Œå¦åˆ™å¯èƒ½ä»ç„¶å› ä¸ºèµ„æºæœªé‡Šæ”¾è€Œç§»åŠ¨å¤±è´¥ã€‚</li></ul></li></ul></li></ol><h2 id="å›¾åƒå¤„ç†ç®—æ³•è¯¦è§£-2">å›¾åƒå¤„ç†ç®—æ³•è¯¦è§£</h2><h2 id="1-å›¾åƒç¼©æ”¾-Image-Resizing-2">1. å›¾åƒç¼©æ”¾ (Image Resizing)</h2><h3 id="åŸç†-4">åŸç†</h3><p>å›¾åƒç¼©æ”¾æ˜¯æŒ‡æ”¹å˜å›¾åƒçš„å°ºå¯¸ï¼ŒåŒ…æ‹¬æ”¾å¤§ï¼ˆupscalingï¼‰å’Œç¼©å°ï¼ˆdownscalingï¼‰ä¸¤ç§æ“ä½œã€‚å…¶åŸºæœ¬åŸç†æ˜¯é€šè¿‡åƒç´ æ’å€¼ç®—æ³•ï¼Œåœ¨æ–°çš„å°ºå¯¸ä¸‹ä¼°è®¡å›¾åƒåƒç´ çš„å€¼ã€‚</p><h3 id="æŠ€æœ¯-4">æŠ€æœ¯</h3><p>å¸¸ç”¨çš„å›¾åƒç¼©æ”¾æŠ€æœ¯åŒ…æ‹¬ï¼š</p><ul><li><strong>æœ€è¿‘é‚»æ’å€¼ (Nearest Neighbor Interpolation):</strong><ul><li><strong>åŸç†:</strong> å°†ç›®æ ‡å›¾åƒçš„åƒç´ å€¼è®¾ç½®ä¸ºæºå›¾åƒä¸­è·ç¦»æœ€è¿‘çš„åƒç´ å€¼ã€‚</li><li><strong>ç‰¹ç‚¹:</strong> ç®€å•å¿«é€Ÿï¼Œä½†å¯èƒ½å¯¼è‡´å›¾åƒè¾¹ç¼˜å‡ºç°é”¯é½¿çŠ¶ã€‚</li></ul></li><li><strong>åŒçº¿æ€§æ’å€¼ (Bilinear Interpolation):</strong><ul><li><strong>åŸç†:</strong>  ä½¿ç”¨ç›®æ ‡å›¾åƒåƒç´ å‘¨å›´çš„ 2x2 é‚»åŸŸåƒç´ å€¼è¿›è¡ŒåŒçº¿æ€§æ’å€¼è®¡ç®—ã€‚</li><li><strong>ç‰¹ç‚¹:</strong> å›¾åƒæ•ˆæœæ¯”æœ€è¿‘é‚»æ’å€¼å¹³æ»‘ï¼Œè®¡ç®—é‡é€‚ä¸­ã€‚</li></ul></li><li><strong>åŒä¸‰æ¬¡æ’å€¼ (Bicubic Interpolation):</strong><ul><li><strong>åŸç†:</strong>  ä½¿ç”¨ç›®æ ‡å›¾åƒåƒç´ å‘¨å›´çš„ 4x4 é‚»åŸŸåƒç´ å€¼è¿›è¡ŒåŒä¸‰æ¬¡æ’å€¼è®¡ç®—ã€‚</li><li><strong>ç‰¹ç‚¹:</strong> å›¾åƒæ•ˆæœè¾ƒå¥½ï¼Œç»†èŠ‚ä¿ç•™è¾ƒå¤šï¼Œä½†è®¡ç®—é‡è¾ƒå¤§ã€‚</li></ul></li><li><strong>åŸºäºæ·±åº¦å­¦ä¹ çš„è¶…åˆ†è¾¨ç‡ (Super-Resolution):</strong><ul><li><strong>åŸç†:</strong> ä½¿ç”¨æ·±åº¦å­¦ä¹ æ¨¡å‹ (ä¾‹å¦‚, SRCNN, EDSR, ESRGAN) ä»ä½åˆ†è¾¨ç‡å›¾åƒé‡å»ºé«˜åˆ†è¾¨ç‡å›¾åƒ.</li><li><strong>ç‰¹ç‚¹:</strong> å¯ä»¥ç”Ÿæˆé«˜è´¨é‡çš„å›¾åƒï¼Œä½†æ˜¯è®¡ç®—é‡å¤§ï¼Œéœ€è¦å¤§é‡çš„è®­ç»ƒæ•°æ®ã€‚</li></ul></li></ul><h3 id="ç”¨é€”-3">ç”¨é€”</h3><ul><li><strong>è°ƒæ•´å›¾åƒå¤§å°ï¼š</strong>  é€‚åº”ä¸åŒçš„æ˜¾ç¤ºè®¾å¤‡æˆ–åº”ç”¨åœºæ™¯ã€‚</li><li><strong>é¢„å¤„ç†æ­¥éª¤ï¼š</strong>  ä½œä¸ºå…¶ä»–å›¾åƒå¤„ç†ç®—æ³• (å¦‚ç›®æ ‡æ£€æµ‹, OCR) çš„é¢„å¤„ç†æ­¥éª¤.</li><li><strong>ç”Ÿæˆä¸åŒåˆ†è¾¨ç‡çš„å›¾åƒï¼š</strong>  ç”¨äºåˆ›å»ºå›¾åƒé‡‘å­—å¡”æˆ–è¿›è¡Œå¤šå°ºåº¦åˆ†æã€‚</li></ul><h2 id="2-å›¾åƒè£å‰ª-Image-Cropping-2">2. å›¾åƒè£å‰ª (Image Cropping)</h2><h3 id="åŸç†-5">åŸç†</h3><p>å›¾åƒè£å‰ªæ˜¯æŒ‡ä»å›¾åƒä¸­é€‰æ‹©ä¸€ä¸ªçŸ©å½¢åŒºåŸŸï¼Œç„¶åå°†å…¶æå–å‡ºæ¥ã€‚å…¶åŸºæœ¬åŸç†æ˜¯æ ¹æ®æŒ‡å®šçš„èµ·å§‹åæ ‡å’Œå®½é«˜ï¼Œæˆªå–å›¾åƒå¯¹åº”çš„åƒç´ æ•°æ®ã€‚</p><h3 id="æŠ€æœ¯-5">æŠ€æœ¯</h3><ul><li><strong>çŸ©å½¢è£å‰ª:</strong>  æŒ‡å®šçŸ©å½¢å·¦ä¸Šè§’åæ ‡(x, y) å’ŒçŸ©å½¢çš„å®½åº¦ (w) å’Œé«˜åº¦ (h)ï¼Œç„¶åæå–è¿™ä¸ªçŸ©å½¢åŒºåŸŸçš„åƒç´ ã€‚</li><li><strong>ä»»æ„å½¢çŠ¶è£å‰ª:</strong>  ä½¿ç”¨æ©ç  (mask) æ¥æŒ‡å®šéœ€è¦è£å‰ªçš„åŒºåŸŸï¼Œmask å¯ä»¥æ˜¯ä»»æ„å½¢çŠ¶ã€‚</li></ul><h3 id="ç”¨é€”-4">ç”¨é€”</h3><ul><li><strong>å»é™¤å›¾åƒä¸­ä¸å¿…è¦çš„åŒºåŸŸï¼š</strong> çªå‡ºæ„Ÿå…´è¶£çš„ç›®æ ‡å¯¹è±¡æˆ–åŒºåŸŸã€‚</li><li><strong>è°ƒæ•´å›¾åƒæ„å›¾ï¼š</strong>  é‡æ–°æ„å›¾ï¼Œä½¿å›¾åƒæ›´ç¬¦åˆéœ€æ±‚ã€‚</li><li><strong>æ•°æ®å¢å¼ºï¼š</strong> ä½œä¸ºå›¾åƒæ•°æ®å¢å¼ºçš„ä¸€ç§æ–¹æ³•ï¼Œå¯ä»¥ç”Ÿæˆä¸åŒçš„å›¾åƒæ ·æœ¬ã€‚</li></ul><h2 id="3-å›¾åƒæ‹¼æ¥-Image-Stitching-2">3. å›¾åƒæ‹¼æ¥ (Image Stitching)</h2><h3 id="åŸç†-6">åŸç†</h3><p>å›¾åƒæ‹¼æ¥æ˜¯æŒ‡å°†å¤šå¼ å…·æœ‰é‡å åŒºåŸŸçš„å›¾åƒæ‹¼æ¥æˆä¸€å¼ å®Œæ•´çš„å…¨æ™¯å›¾åƒã€‚å…¶åŸºæœ¬åŸç†åŒ…æ‹¬å›¾åƒé…å‡†å’Œå›¾åƒèåˆä¸¤ä¸ªæ­¥éª¤ã€‚</p><h3 id="æŠ€æœ¯-6">æŠ€æœ¯</h3><ul><li><strong>ç‰¹å¾æ£€æµ‹å’ŒåŒ¹é… (Feature Detection and Matching):</strong><ul><li><strong>ç›®çš„:</strong>  æå–å›¾åƒä¸­çš„ç‰¹å¾ç‚¹ (å¦‚ SIFT, SURF, ORB ç­‰) å¹¶è¿›è¡ŒåŒ¹é…ï¼Œæ‰¾åˆ°å›¾åƒä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚</li></ul></li><li><strong>å›¾åƒé…å‡† (Image Registration):</strong><ul><li><strong>ç›®çš„:</strong>  æ ¹æ®åŒ¹é…åˆ°çš„ç‰¹å¾ç‚¹ï¼Œè®¡ç®—å›¾åƒä¹‹é—´çš„å˜æ¢å…³ç³»ï¼Œå°†å›¾åƒå¯¹é½ã€‚</li><li><strong>æŠ€æœ¯:</strong> ä½¿ç”¨å¦‚ RANSAC ç­‰ç®—æ³•ä¼°è®¡å›¾åƒçš„å˜æ¢çŸ©é˜µã€‚</li></ul></li><li><strong>å›¾åƒèåˆ (Image Blending):</strong><ul><li><strong>ç›®çš„:</strong> å°†å¯¹é½çš„å›¾åƒæ‹¼æ¥æˆä¸€å¼ å®Œæ•´çš„å›¾åƒã€‚</li><li><strong>æŠ€æœ¯:</strong>  ä½¿ç”¨å¦‚å¤šé¢‘å¸¦èåˆæˆ–åŠ æƒå¹³å‡ç­‰æ–¹æ³•å¤„ç†å›¾åƒé‡å åŒºåŸŸï¼Œé¿å…æ˜æ˜¾çš„æ¥ç¼ã€‚</li></ul></li><li><strong>æŸ±é¢æŠ•å½±:</strong><ul><li>**ç›®çš„:**å°†å›¾åƒæ˜ å°„åˆ°æŸ±é¢åæ ‡ç³»ï¼Œä»¥ä¾¿æ›´å¥½åœ°æ‹¼æ¥æ°´å¹³æ–¹å‘ä¸Šè§†è§’å˜åŒ–å¾ˆå¤§çš„å›¾åƒã€‚</li></ul></li></ul><h3 id="ç”¨é€”-5">ç”¨é€”</h3><ul><li><strong>ç”Ÿæˆå…¨æ™¯å›¾ï¼š</strong>  å°†å¤šå¼ å›¾ç‰‡æ‹¼æ¥æˆä¸€å¼ å®½è§†é‡çš„å…¨æ™¯å›¾åƒã€‚</li><li><strong>åˆ›å»ºé«˜åˆ†è¾¨ç‡å›¾åƒï¼š</strong>  å°†å¤šå¼ ä½åˆ†è¾¨ç‡å›¾åƒæ‹¼æ¥æˆä¸€å¼ é«˜åˆ†è¾¨ç‡å›¾åƒã€‚</li><li><strong>åˆ›å»º 3D æ¨¡å‹ï¼š</strong>  é€šè¿‡å¤šå¼ å›¾ç‰‡å¯ä»¥é‡å»º 3D æ¨¡å‹ã€‚</li></ul><h2 id="4-å›¾åƒå»å™ª-Image-Denoising">4. å›¾åƒå»å™ª (Image Denoising)</h2><h3 id="åŸç†-7">åŸç†</h3><p>å›¾åƒå»å™ªæ˜¯æŒ‡å‡å°‘å›¾åƒä¸­å™ªå£°çš„æŠ€æœ¯ã€‚å™ªå£°æ˜¯æŒ‡å›¾åƒä¸­ä¸å¸Œæœ›å‡ºç°çš„éšæœºå¹²æ‰°ä¿¡å·ã€‚å…¶åŸºæœ¬åŸç†æ˜¯åŒºåˆ†å›¾åƒä¸­çš„æœ‰ç”¨ä¿¡å·å’Œå™ªå£°ä¿¡å·ï¼Œç„¶åå¯¹å™ªå£°ä¿¡å·è¿›è¡ŒæŠ‘åˆ¶æˆ–å»é™¤ã€‚</p><h3 id="æŠ€æœ¯-7">æŠ€æœ¯</h3><ul><li><strong>ç©ºåŸŸæ»¤æ³¢ (Spatial Filtering):</strong><ul><li><strong>åŸç†:</strong> ä½¿ç”¨æ»¤æ³¢å™¨å¯¹å›¾åƒåƒç´ è¿›è¡ŒåŠ æƒå¹³å‡ï¼Œä»¥å¹³æ»‘å›¾åƒï¼Œé™ä½å™ªå£°ã€‚</li><li><strong>æŠ€æœ¯:</strong><ul><li><strong>å‡å€¼æ»¤æ³¢ (Mean Filtering):</strong> ä½¿ç”¨é‚»åŸŸåƒç´ çš„å¹³å‡å€¼æ›¿æ¢ä¸­å¿ƒåƒç´ å€¼ã€‚</li><li><strong>é«˜æ–¯æ»¤æ³¢ (Gaussian Filtering):</strong> ä½¿ç”¨é«˜æ–¯æ ¸å¯¹é‚»åŸŸåƒç´ è¿›è¡ŒåŠ æƒå¹³å‡ã€‚</li><li><strong>ä¸­å€¼æ»¤æ³¢ (Median Filtering):</strong> ä½¿ç”¨é‚»åŸŸåƒç´ çš„ä¸­å€¼æ›¿æ¢ä¸­å¿ƒåƒç´ å€¼ï¼Œå¯ä»¥å»é™¤è„‰å†²å™ªå£°ã€‚</li><li><strong>åŒè¾¹æ»¤æ³¢ (Bilateral Filtering):</strong> ç»“åˆåƒç´ çš„ç©ºé—´è·ç¦»å’Œå€¼åŸŸç›¸ä¼¼åº¦ï¼Œåœ¨å»é™¤å™ªå£°çš„åŒæ—¶ä¿æŒè¾¹ç¼˜ã€‚</li></ul></li></ul></li><li><strong>é¢‘åŸŸæ»¤æ³¢ (Frequency Filtering):</strong><ul><li><strong>åŸç†:</strong> å°†å›¾åƒè½¬æ¢åˆ°é¢‘åŸŸï¼Œå¯¹å™ªå£°é¢‘ç‡è¿›è¡ŒæŠ‘åˆ¶ã€‚</li><li><strong>æŠ€æœ¯:</strong>  ä½¿ç”¨å¦‚ä½é€šæ»¤æ³¢å™¨ (Low-Pass Filter) å‡å°‘é«˜é¢‘å™ªå£°ã€‚</li></ul></li><li><strong>åŸºäºæ·±åº¦å­¦ä¹ çš„æ–¹æ³•:</strong><ul><li><strong>åŸç†:</strong> ä½¿ç”¨æ·±åº¦å­¦ä¹ æ¨¡å‹ (ä¾‹å¦‚ï¼ŒDnCNN, FFDNet, RIDNet) ä»å™ªå£°å›¾åƒé‡å»ºæ¸…æ™°çš„å›¾åƒ.</li><li><strong>ç‰¹ç‚¹:</strong> å¯ä»¥å–å¾—è¾ƒå¥½çš„å»å™ªæ•ˆæœï¼Œä½†æ˜¯æ¨¡å‹è®­ç»ƒéœ€è¦å¤§é‡çš„å¸¦å™ªå£°å’Œæ— å™ªå£°çš„å›¾åƒå¯¹ã€‚</li></ul></li></ul><h3 id="ç”¨é€”-6">ç”¨é€”</h3><ul><li><strong>æé«˜å›¾åƒè´¨é‡ï¼š</strong>  å»é™¤å›¾åƒä¸­çš„å™ªå£°ï¼Œä½¿å›¾åƒæ›´åŠ æ¸…æ™°ã€‚</li><li><strong>é¢„å¤„ç†æ­¥éª¤ï¼š</strong> ä½œä¸ºå…¶ä»–å›¾åƒå¤„ç†ç®—æ³•çš„é¢„å¤„ç†æ­¥éª¤ï¼Œä¾‹å¦‚ï¼Œç”¨äºæé«˜ç›®æ ‡æ£€æµ‹æˆ– OCR çš„å‡†ç¡®ç‡ã€‚</li><li><strong>å¢å¼ºå›¾åƒå¯è¯»æ€§ï¼š</strong> é™ä½å™ªå£°å¯¹å›¾åƒçš„å¹²æ‰°ï¼Œä½¿äººçœ¼æ›´å®¹æ˜“è¯†åˆ«å›¾åƒå†…å®¹ã€‚</li></ul><h2 id="5-å›¾åƒä¿®å¤-Image-Inpainting">5. å›¾åƒä¿®å¤ (Image Inpainting)</h2><h3 id="åŸç†-8">åŸç†</h3><p>å›¾åƒä¿®å¤æ˜¯æŒ‡æ ¹æ®å›¾åƒä¸­å·²çŸ¥åŒºåŸŸçš„ä¿¡æ¯ï¼Œæ¢å¤å›¾åƒä¸­ç¼ºå¤±æˆ–æŸååŒºåŸŸçš„æŠ€æœ¯ã€‚å…¶åŸºæœ¬åŸç†æ˜¯åˆ†æå›¾åƒçš„ç»“æ„å’Œçº¹ç†ä¿¡æ¯ï¼Œç„¶åä½¿ç”¨æ’å€¼ã€çº¹ç†åˆæˆç­‰æ–¹æ³•ï¼Œå¡«å……ç¼ºå¤±åŒºåŸŸã€‚</p><h3 id="æŠ€æœ¯-8">æŠ€æœ¯</h3><ul><li><strong>åŸºäºæ‰©æ•£ (Diffusion) çš„æ–¹æ³•:</strong><ul><li><strong>åŸç†:</strong>  æ ¹æ®å‘¨å›´çš„åƒç´ å€¼é€æ­¥å¡«å……ç¼ºå¤±åŒºåŸŸï¼Œæ¨¡æ‹Ÿçƒ­æ‰©æ•£è¿‡ç¨‹ã€‚</li><li><strong>æŠ€æœ¯:</strong>  å¯ä»¥ä½¿ç”¨å¦‚ Navier-Stokes æ–¹ç¨‹è¿›è¡Œå»ºæ¨¡ã€‚</li></ul></li><li><strong>åŸºäºçº¹ç†åˆæˆ (Texture Synthesis) çš„æ–¹æ³•:</strong><ul><li><strong>åŸç†:</strong>  ä½¿ç”¨å‘¨å›´åŒºåŸŸçš„çº¹ç†æ¥å¡«å……ç¼ºå¤±åŒºåŸŸã€‚</li><li><strong>æŠ€æœ¯:</strong>  å¯ä»¥ä½¿ç”¨åŸºäºæ ·æœ¬çš„æ–¹æ³•æˆ–åŸºäºé©¬å°”å¯å¤«éšæœºåœºçš„æ–¹æ³•ã€‚</li></ul></li><li><strong>åŸºäºæ·±åº¦å­¦ä¹ çš„æ–¹æ³•:</strong><ul><li><strong>åŸç†:</strong>  ä½¿ç”¨æ·±åº¦å­¦ä¹ æ¨¡å‹ (ä¾‹å¦‚ï¼ŒContext Encoder, GAN) ä»å·²çŸ¥çš„åŒºåŸŸæ¨æ–­ç¼ºå¤±åŒºåŸŸçš„å†…å®¹ã€‚</li><li><strong>ç‰¹ç‚¹:</strong>  å¯ä»¥å®ç°è¾ƒä¸ºçœŸå®çš„å›¾åƒä¿®å¤ï¼Œç‰¹åˆ«æ˜¯å¯¹äºå¤æ‚ç»“æ„å’Œçº¹ç†çš„ä¿®å¤ã€‚</li></ul></li></ul><h3 id="ç”¨é€”-7">ç”¨é€”</h3><ul><li><strong>ä¿®å¤æŸåçš„å›¾åƒï¼š</strong>  ä¾‹å¦‚ï¼Œä¿®å¤è€ç…§ç‰‡æˆ–æŸåçš„æ–‡ç‰©å›¾ç‰‡ã€‚</li><li><strong>ç§»é™¤å›¾åƒä¸­çš„é®æŒ¡ç‰©ï¼š</strong>  ä¾‹å¦‚ï¼Œç§»é™¤å›¾åƒä¸­çš„æ–‡å­—ã€æ°´å°ã€æˆ–ä¸æƒ³è¦çš„å¯¹è±¡ã€‚</li><li><strong>å›¾åƒç¼–è¾‘ï¼š</strong>  å®ç°é«˜çº§çš„å›¾åƒç¼–è¾‘åŠŸèƒ½ï¼Œå¦‚ç§»é™¤äººåƒä¸Šçš„æ–‘ç‚¹æˆ–ä¿®å¤èƒŒæ™¯ä¸­çš„ç‘•ç–µã€‚</li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åœ¨ubuntuç³»ç»Ÿä½¿ç”¨dockerå®‰è£… CVAT</title>
      <link href="/2025/01/10/docker-install-cvat/"/>
      <url>/2025/01/10/docker-install-cvat/</url>
      
        <content type="html"><![CDATA[<h1>åœ¨ubuntuç³»ç»Ÿä½¿ç”¨dockerå®‰è£… CVAT</h1><blockquote><p>CVAT æ˜¯ä¸€ä¸ª<strong>å…è´¹ã€å¼€æº</strong>çš„ Web åº”ç”¨ç¨‹åºï¼Œç”¨äºæ ‡æ³¨è®¡ç®—æœºè§†è§‰ä»»åŠ¡çš„æ•°æ®é›†ã€‚å®ƒç”± Intel å¼€å‘å¹¶ç»´æŠ¤ï¼Œæ—¨åœ¨ä¸ºå„ç§è®¡ç®—æœºè§†è§‰åº”ç”¨æä¾›ä¸€ä¸ªé«˜æ•ˆã€å¼ºå¤§ä¸”åä½œå¼çš„æ ‡æ³¨å¹³å°ã€‚</p></blockquote><h2 id="åŠŸèƒ½">åŠŸèƒ½</h2><ol><li><p><strong>å¤šæ¨¡æ€æ•°æ®æ ‡æ³¨ï¼š</strong></p><ul><li><strong>å›¾åƒæ ‡æ³¨ï¼š</strong> æ”¯æŒå„ç§å›¾åƒæ ‡æ³¨ç±»å‹ï¼ŒåŒ…æ‹¬ï¼š<ul><li><strong>è¾¹ç•Œæ¡† (Bounding Boxes):</strong> ç”¨äºæ£€æµ‹å’Œå®šä½ç‰©ä½“ã€‚</li><li><strong>å¤šè¾¹å½¢ (Polygons):</strong> ç”¨äºç²¾ç¡®å‹¾å‹’å¤æ‚å½¢çŠ¶çš„ç‰©ä½“ã€‚</li><li><strong>å…³é”®ç‚¹ (Keypoints):</strong> ç”¨äºæ ‡æ³¨ç‰©ä½“çš„å…³é”®éƒ¨ä½ï¼Œå¦‚äººè„¸å…³é”®ç‚¹ã€‚</li><li><strong>çº¿æ¡ (Lines) å’Œ ç‚¹ (Points):</strong> ç”¨äºç®€å•å½¢çŠ¶æˆ–ç›®æ ‡çš„æ ‡æ³¨ã€‚</li><li><strong>åˆ†å‰²æ©ç  (Segmentation Masks):</strong> ç”¨äºåƒç´ çº§åˆ«çš„å¯¹è±¡åˆ†å‰²ï¼ˆéœ€è¦ä¸å…¶ä»–å·¥å…·ç»“åˆï¼Œå¦‚åŠè‡ªåŠ¨æ ‡æ³¨å·¥å…·ï¼‰ã€‚</li></ul></li><li><strong>è§†é¢‘æ ‡æ³¨ï¼š</strong><ul><li>æ”¯æŒå¯¹è§†é¢‘ä¸­çš„å¯¹è±¡è¿›è¡Œè·Ÿè¸ªå’Œæ ‡æ³¨ï¼Œå¹¶å¯ä»¥å¯¹æ¯å¸§è¿›è¡Œä¿®æ”¹ï¼Œæ–¹ä¾¿åŠ¨ä½œè¯†åˆ«å’Œè§†é¢‘åˆ†æã€‚</li></ul></li><li><strong>3D æ•°æ®æ ‡æ³¨ï¼š</strong><ul><li>å¯ä»¥æ ‡æ³¨3D ç‚¹äº‘æ•°æ®ï¼Œæ”¯æŒç‚¹äº‘çš„ bounding box å’Œ segmentationã€‚</li></ul></li></ul></li><li><p><strong>å¼ºå¤§çš„ç”¨æˆ·ç•Œé¢ï¼š</strong></p><ul><li><strong>ç›´è§‚æ˜“ç”¨ï¼š</strong> æä¾›ç®€æ´çš„ç”¨æˆ·ç•Œé¢ï¼Œæ–¹ä¾¿ç”¨æˆ·å¿«é€Ÿä¸Šæ‰‹ã€‚</li><li><strong>è‡ªå®šä¹‰å¿«æ·é”®ï¼š</strong> å¯è‡ªå®šä¹‰å¿«æ·é”®ï¼Œæé«˜æ ‡æ³¨æ•ˆç‡ã€‚</li><li><strong>åˆ†å±æ˜¾ç¤ºï¼š</strong> å¯ä»¥åŒæ—¶æ˜¾ç¤ºå¤šä¸ªå›¾åƒ/è§†é¢‘ç‰‡æ®µï¼Œæ–¹ä¾¿å¯¹æ¯”æ ‡æ³¨ã€‚</li><li><strong>å¯å®šåˆ¶çš„æ ‡æ³¨æ ‡ç­¾ï¼š</strong> å…è®¸ç”¨æˆ·åˆ›å»ºè‡ªå·±çš„æ ‡æ³¨æ ‡ç­¾ï¼Œæ»¡è¶³ä¸åŒä»»åŠ¡çš„éœ€æ±‚ã€‚</li><li><strong>æ ‡æ³¨å†å²è®°å½•:</strong> å¯ä»¥æŸ¥çœ‹å’Œå›æº¯æ ‡æ³¨æ“ä½œã€‚</li></ul></li><li><p><strong>åä½œå¼æ ‡æ³¨ï¼š</strong></p><ul><li><strong>å¤šç”¨æˆ·æ”¯æŒï¼š</strong> æ”¯æŒå¤šä¸ªç”¨æˆ·åŒæ—¶åä½œæ ‡æ³¨åŒä¸€ä¸ªé¡¹ç›®ï¼Œæé«˜æ ‡æ³¨æ•ˆç‡ã€‚</li><li><strong>è§’è‰²æƒé™ç®¡ç†ï¼š</strong> å¯ä»¥ä¸ºä¸åŒçš„ç”¨æˆ·è®¾ç½®ä¸åŒçš„è§’è‰²å’Œæƒé™ã€‚</li><li><strong>æ ‡æ³¨ä»»åŠ¡åˆ†é…ï¼š</strong> å¯ä»¥å°†æ ‡æ³¨ä»»åŠ¡åˆ†é…ç»™ä¸åŒçš„ç”¨æˆ·ã€‚</li><li><strong>æ ‡æ³¨å®¡æ ¸ï¼š</strong> ç®¡ç†å‘˜å¯ä»¥å¯¹æ ‡æ³¨ç»“æœè¿›è¡Œå®¡æ ¸ï¼Œç¡®ä¿æ ‡æ³¨è´¨é‡ã€‚</li></ul></li><li><p><strong>è‡ªåŠ¨åŒ–å’ŒåŠè‡ªåŠ¨åŒ–æ ‡æ³¨ï¼š</strong></p><ul><li><strong>é¢„æ ‡æ³¨æ”¯æŒï¼š</strong> æ”¯æŒå¯¼å…¥ä½¿ç”¨å…¶ä»–å·¥å…·é¢„å…ˆæ ‡æ³¨çš„ç»“æœï¼Œä½œä¸ºæ ‡æ³¨çš„èµ·ç‚¹ã€‚</li><li><strong>åŠè‡ªåŠ¨æ ‡æ³¨å·¥å…·:</strong> å¯ä»¥ä½¿ç”¨ä¸€äº›åŠè‡ªåŠ¨æ ‡æ³¨å·¥å…·ï¼Œä¾‹å¦‚æ™ºèƒ½å¤šè¾¹å½¢ç”Ÿæˆã€æ¨¡å‹è¾…åŠ©æ ‡æ³¨ç­‰ï¼Œæé«˜æ ‡æ³¨é€Ÿåº¦ã€‚</li><li><strong>æ¨¡å‹é›†æˆï¼š</strong> å¯ä»¥é›†æˆæ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œç”¨äºè¾…åŠ©æ ‡æ³¨ã€‚</li></ul></li><li><p><strong>æ•°æ®ç®¡ç†ï¼š</strong></p><ul><li><strong>é¡¹ç›®ç®¡ç†ï¼š</strong> å¯ä»¥åˆ›å»ºä¸åŒçš„æ ‡æ³¨é¡¹ç›®ï¼Œç»„ç»‡å’Œç®¡ç†æ ‡æ³¨æ•°æ®ã€‚</li><li><strong>æ•°æ®é›†å¯¼å…¥å’Œå¯¼å‡ºï¼š</strong> æ”¯æŒå¯¼å…¥å„ç§æ ¼å¼çš„æ•°æ®é›†ï¼Œå¹¶å¯¼å‡ºä¸ºå¤šç§æ ‡æ³¨æ ¼å¼ï¼Œä¾‹å¦‚ COCOã€PASCAL VOCã€YOLO ç­‰ã€‚</li><li><strong>æ•°æ®ç‰ˆæœ¬æ§åˆ¶ï¼š</strong> å¯ä»¥è¿½è¸ªæ•°æ®å’Œæ ‡æ³¨çš„å˜æ›´ï¼Œæ–¹ä¾¿è¿›è¡Œç‰ˆæœ¬æ§åˆ¶ã€‚</li><li><strong>æ•°æ®ç»Ÿè®¡ï¼š</strong> å¯ä»¥æŸ¥çœ‹æ ‡æ³¨æ•°æ®çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå¦‚æ ‡æ³¨æ•°é‡ã€æ ‡æ³¨ç±»å‹ç­‰ã€‚</li><li><strong>å¯å®šåˆ¶åŒ–çš„å·¥ä½œæµç¨‹ï¼š</strong> æ”¯æŒè‡ªå®šä¹‰æ ‡æ³¨çš„å·¥ä½œæµç¨‹ï¼Œä¾‹å¦‚é¢„æ ‡æ³¨ï¼Œæ ‡æ³¨ï¼Œå®¡æ ¸ç­‰ã€‚</li></ul></li><li><p><strong>æ‰©å±•æ€§å’Œå¯å®šåˆ¶æ€§ï¼š</strong></p><ul><li><strong>å¼€æ”¾çš„ APIï¼š</strong> æä¾› RESTful APIï¼Œæ–¹ä¾¿ä¸å…¶ä»–ç³»ç»Ÿé›†æˆã€‚</li><li><strong>æ’ä»¶æ”¯æŒï¼š</strong> å¯ä»¥å¼€å‘è‡ªå·±çš„æ’ä»¶ï¼Œæ‰©å±• CVAT çš„åŠŸèƒ½ã€‚</li><li><strong>Docker æ”¯æŒï¼š</strong> å¯ä»¥ä½¿ç”¨ Docker å¿«é€Ÿéƒ¨ç½² CVATã€‚</li></ul></li></ol><p><strong>Ubuntu ç³»ç»Ÿ:</strong> å»ºè®®ä½¿ç”¨ Ubuntu 20.04 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚</p><ul><li><strong>Docker å’Œ Docker Compose:</strong> ä½ éœ€è¦åœ¨ä½ çš„ Ubuntu ç³»ç»Ÿä¸Šå®‰è£… Docker å’Œ Docker Composeã€‚</li></ul><p><strong>æ­¥éª¤ï¼š</strong></p><ol><li><p><strong>æ›´æ–°ç³»ç»ŸåŒ…åˆ—è¡¨ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br></pre></td></tr></table></figure></li><li><p><strong>å®‰è£… Dockerï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install docker.io</span><br></pre></td></tr></table></figure><p>éªŒè¯å®‰è£…ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl start docker</span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> docker</span><br><span class="line">docker --version</span><br></pre></td></tr></table></figure><p>å¦‚æœå‘½ä»¤è¾“å‡ºäº†Dockerç‰ˆæœ¬ä¿¡æ¯ï¼Œåˆ™è¯´æ˜å®‰è£…æˆåŠŸã€‚</p></li><li><p><strong>å®‰è£… Docker Composeï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install docker-compose</span><br></pre></td></tr></table></figure><p>éªŒè¯å®‰è£…ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose --version</span><br></pre></td></tr></table></figure><p>å¦‚æœå‘½ä»¤è¾“å‡ºäº†Docker Composeç‰ˆæœ¬ä¿¡æ¯ï¼Œåˆ™è¯´æ˜å®‰è£…æˆåŠŸã€‚</p></li><li><p><strong>ä¸‹è½½ CVAT é…ç½®æ–‡ä»¶ï¼š</strong></p><ul><li><p>CVAT çš„å®˜æ–¹ GitHub ä»“åº“æä¾›äº† <code>docker-compose.yml</code> æ–‡ä»¶ï¼Œç›´æ¥ä¸‹è½½ä½¿ç”¨ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/opencv/cvat/develop/docker-compose.yml</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>ä¿®æ”¹ docker-compose.yml æ–‡ä»¶ï¼š</strong></p><ul><li>æ‰¾åˆ°  <code>services/cvat/volumes:</code> æ¨¡å—ï¼Œå°†å…¶ä¿®æ”¹ä¸ºï¼š</li></ul> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">cvat_data:/home/django/data</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">./data:/home/django/media</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">./logs:/home/django/logs</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·å¯ä»¥æ–¹ä¾¿åœ°å°†ä½ çš„æ•°æ®æ”¾åˆ°å½“å‰ç›®å½•çš„dataå’Œlogsæ–‡ä»¶å¤¹ä¸‹ï¼Œå¹¶ä¸”é¿å…äº†é»˜è®¤æ•°æ®ç›®å½•åœ¨Dockerå®¹å™¨å†…ï¼Œæ•°æ®ä¸¢å¤±çš„é—®é¢˜ã€‚</p><ul><li>åœ¨ <code>version</code> çš„ä¸‹é¢åŠ ä¸Š  <code>networks:</code></li></ul> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">    <span class="attr">default:</span></span><br></pre></td></tr></table></figure><p>ç¡®ä¿å…¶ä»–å®¹å™¨èƒ½å¤Ÿè®¿é—®åˆ°CVATæœåŠ¡</p></li><li><p><strong>åˆ›å»ºæ•°æ®ç›®å½•:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> data</span><br><span class="line"><span class="built_in">mkdir</span> logs</span><br></pre></td></tr></table></figure></li><li><p><strong>å¯åŠ¨ CVATï¼š</strong></p><ul><li><p>åœ¨ <code>docker-compose.yml</code> æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ä¸‹ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure><ul><li><code>-d</code> å‚æ•°è¡¨ç¤ºåœ¨åå°è¿è¡Œ (detached mode)ã€‚</li><li>é¦–æ¬¡è¿è¡Œä¼šä¸‹è½½æ‰€éœ€çš„ Docker é•œåƒï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚</li></ul></li></ul></li><li><p><strong>ç­‰å¾… CVAT å¯åŠ¨ï¼š</strong></p><ul><li><p>å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å®¹å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose ps</span><br></pre></td></tr></table></figure></li><li><p>å¦‚æœæ‰€æœ‰å®¹å™¨çš„çŠ¶æ€éƒ½æ˜¯ <code>Up</code>ï¼Œåˆ™è¡¨ç¤º CVAT å·²ç»å¯åŠ¨æˆåŠŸã€‚</p></li><li><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>docker logs -f &lt;cvat_container_id&gt; </code> æ¥æŸ¥çœ‹cvat å®¹å™¨çš„æ—¥å¿—ã€‚<code>&lt;cvat_container_id&gt;</code> ä½ å¯ä»¥ä½¿ç”¨<code>docker ps</code> å‘½ä»¤æŸ¥çœ‹ã€‚</p></li></ul></li><li><p><strong>è®¿é—® CVATï¼š</strong></p><ul><li>åœ¨ä½ çš„ Web æµè§ˆå™¨ä¸­ï¼Œæ‰“å¼€ä»¥ä¸‹åœ°å€ï¼š<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8080</span><br></pre></td></tr></table></figure></li><li>é»˜è®¤çš„ç®¡ç†å‘˜ç”¨æˆ·åæ˜¯ <code>admin</code>ï¼Œå¯†ç æ˜¯ <code>admin</code>ã€‚<ul><li><strong>é¦–æ¬¡ç™»å½•åè¯·ç«‹å³ä¿®æ”¹ç®¡ç†å‘˜å¯†ç ï¼</strong></li></ul></li></ul></li><li><p><strong>å¯é€‰ï¼šåˆ›å»ºæ–°çš„ç®¡ç†å‘˜ç”¨æˆ·</strong></p><ul><li>ä½ å¯ä»¥åœ¨ç”¨æˆ·ç®¡ç†é¡µé¢åˆ›å»ºæ–°çš„ç®¡ç†å‘˜ç”¨æˆ·</li></ul></li></ol><p><strong>å¸¸ç”¨å‘½ä»¤ï¼š</strong></p><ul><li><p><strong>åœæ­¢ CVATï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose down</span><br></pre></td></tr></table></figure></li><li><p><strong>é‡å¯ CVATï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose restart</span><br></pre></td></tr></table></figure></li><li><p><strong>æŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose logs -f</span><br></pre></td></tr></table></figure></li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å€ŸåŠ©æ·±åº¦å­¦ä¹ æ¨¡å‹å®ç°åˆ†ç¦»äººå£°ä¸èƒŒæ™¯å£°</title>
      <link href="/2025/01/01/split-voice/"/>
      <url>/2025/01/01/split-voice/</url>
      
        <content type="html"><![CDATA[<h1>å€ŸåŠ©æ·±åº¦å­¦ä¹ æ¨¡å‹å®ç°åˆ†ç¦»äººå£°ä¸èƒŒæ™¯å£°</h1><h2 id="spleeter">spleeter</h2><blockquote><p>Spleeter æ˜¯ä¸€ä¸ªç”± Deezer å¼€å‘çš„éŸ³é¢‘æºåˆ†ç¦»å·¥å…·ï¼Œæ”¯æŒå°†éŸ³é¢‘åˆ†ç¦»ä¸ºä¼´å¥å’Œäººå£°ã€‚</p></blockquote><h2 id="æŠ€æœ¯åº“">æŠ€æœ¯åº“</h2><ul><li>spleeter</li><li>ffmpeg</li><li>open-unmix</li><li>demuicx</li></ul><h2 id="å®‰è£…ä½¿ç”¨">å®‰è£…ä½¿ç”¨</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install spleeter</span><br></pre></td></tr></table></figure><h2 id="ç®€å•demo">ç®€å•demo</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spleeter separate -i audio.wav -p spleeter:2stems -o output/</span><br></pre></td></tr></table></figure><h2 id="å®ç°äººå£°ä¸èƒŒæ™¯éŸ³åˆ†ç¦»">å®ç°äººå£°ä¸èƒŒæ™¯éŸ³åˆ†ç¦»</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> spleeter.separator <span class="keyword">import</span> Separator</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰è¾“å…¥å’Œè¾“å‡ºè·¯å¾„</span></span><br><span class="line">video_file = <span class="string">&#x27;input_video.mp4&#x27;</span>  <span class="comment"># è¾“å…¥è§†é¢‘æ–‡ä»¶</span></span><br><span class="line">audio_file = <span class="string">&#x27;extracted_audio.wav&#x27;</span>  <span class="comment"># æå–çš„éŸ³é¢‘æ–‡ä»¶</span></span><br><span class="line">output_dir = <span class="string">&#x27;output&#x27;</span>  <span class="comment"># è¾“å‡ºæ–‡ä»¶å¤¹</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¥éª¤ 1: ä½¿ç”¨ ffmpeg æå–éŸ³é¢‘</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_audio_from_video</span>(<span class="params">video_file, audio_file</span>):</span><br><span class="line">    command = [</span><br><span class="line">        <span class="string">&#x27;ffmpeg&#x27;</span>, <span class="string">&#x27;-i&#x27;</span>, video_file, <span class="string">&#x27;-vn&#x27;</span>, <span class="string">&#x27;-acodec&#x27;</span>, <span class="string">&#x27;pcm_s16le&#x27;</span>, <span class="string">&#x27;-ar&#x27;</span>, <span class="string">&#x27;44100&#x27;</span>, <span class="string">&#x27;-ac&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, audio_file</span><br><span class="line">    ]</span><br><span class="line">    subprocess.run(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Audio extracted to <span class="subst">&#123;audio_file&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¥éª¤ 2: ä½¿ç”¨ Spleeter åˆ†ç¦»éŸ³é¢‘ä¸­çš„äººå£°å’Œä¼´å¥</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">separate_audio</span>(<span class="params">audio_file, output_dir</span>):</span><br><span class="line">    separator = Separator(<span class="string">&#x27;spleeter:2stems&#x27;</span>)  <span class="comment"># é€‰æ‹©åˆ†ç¦»äººå£°å’Œä¼´å¥</span></span><br><span class="line">    separator.separate_to_file(audio_file, output_dir)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Audio separation complete. Files saved in <span class="subst">&#123;output_dir&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¥éª¤ 3: åˆå¹¶å»é™¤äººå£°çš„ä¼´å¥ä¸åŸè§†é¢‘</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge_audio_with_video</span>(<span class="params">video_file, audio_file, output_video_file</span>):</span><br><span class="line">    command = [</span><br><span class="line">        <span class="string">&#x27;ffmpeg&#x27;</span>, <span class="string">&#x27;-i&#x27;</span>, video_file, <span class="string">&#x27;-i&#x27;</span>, audio_file, <span class="string">&#x27;-c:v&#x27;</span>, <span class="string">&#x27;copy&#x27;</span>, <span class="string">&#x27;-c:a&#x27;</span>, <span class="string">&#x27;aac&#x27;</span>, <span class="string">&#x27;-strict&#x27;</span>, <span class="string">&#x27;experimental&#x27;</span>, output_video_file</span><br><span class="line">    ]</span><br><span class="line">    subprocess.run(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Video saved as <span class="subst">&#123;output_video_file&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸»ç¨‹åº</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_video</span>(<span class="params">video_file</span>):</span><br><span class="line">    <span class="comment"># æå–éŸ³é¢‘</span></span><br><span class="line">    extract_audio_from_video(video_file, audio_file)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ†ç¦»éŸ³é¢‘</span></span><br><span class="line">    separate_audio(audio_file, output_dir)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å–åˆ†ç¦»åçš„ä¼´å¥éŸ³é¢‘è·¯å¾„</span></span><br><span class="line">    accompaniment_audio = os.path.join(output_dir, os.path.basename(audio_file).replace(<span class="string">&#x27;.wav&#x27;</span>, <span class="string">&#x27;/accompaniment.wav&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(accompaniment_audio):</span><br><span class="line">        <span class="comment"># åˆå¹¶ä¼´å¥å’Œè§†é¢‘</span></span><br><span class="line">        output_video_file = <span class="string">&#x27;output_video.mp4&#x27;</span></span><br><span class="line">        merge_audio_with_video(video_file, accompaniment_audio, output_video_file)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Process complete, output video created.&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Error: Accompaniment audio file not found.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œ</span></span><br><span class="line">process_video(video_file)</span><br></pre></td></tr></table></figure><blockquote><p>ffmpeg æå–éŸ³é¢‘æ—¶ï¼Œé»˜è®¤å°†è§†é¢‘ä¸­çš„éŸ³é¢‘è½¨é“æå–ä¸º .wav æ ¼å¼ã€‚å¦‚æœä½ çš„éŸ³é¢‘æœ‰ä¸åŒçš„æ ¼å¼ï¼ˆå¦‚ .mp3ï¼‰ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹æå–éŸ³é¢‘çš„æ ¼å¼ã€‚</p></blockquote><blockquote><p>Spleeter ä½¿ç”¨çš„æ˜¯æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œå› æ­¤åˆ†ç¦»è´¨é‡å–å†³äºæ¨¡å‹çš„æ•ˆæœï¼Œå°½ç®¡å®ƒèƒ½è¾ƒå¥½åœ°åˆ†ç¦»äººå£°å’Œä¼´å¥ï¼Œä½†ç»“æœå¯èƒ½ä¸æ˜¯å®Œç¾çš„ã€‚</p></blockquote><h2 id="è¾“å‡ºæ–‡ä»¶è¯´æ˜">è¾“å‡ºæ–‡ä»¶è¯´æ˜</h2><ul><li><p>accompaniment.wavï¼šåˆ†ç¦»å‡ºçš„ä¼´å¥éŸ³è½¨ï¼Œå»é™¤äº†äººå£°ã€‚</p></li><li><p>vocals.wavï¼šåˆ†ç¦»å‡ºçš„äººå£°éŸ³è½¨ã€‚</p></li><li><p>output_video.mp4ï¼šç”Ÿæˆçš„å»äººå£°è§†é¢‘ã€‚</p></li></ul><h2 id="GUI-å®ç°">GUI å®ç°</h2><ul><li>åˆ†å‰²è§†é¢‘å‡ºéŸ³é¢‘æ•°æ®</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> moviepy.editor <span class="keyword">import</span> VideoFileClip</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_audio_from_video</span>(<span class="params">video_path, output_audio_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ä»è§†é¢‘ä¸­æå–éŸ³é¢‘å¹¶ä¿å­˜ä¸º WAV æ ¼å¼ã€‚</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    :param video_path: è¾“å…¥è§†é¢‘æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"><span class="string">    :param output_audio_path: è¾“å‡ºéŸ³é¢‘æ–‡ä»¶è·¯å¾„ (ä¾‹å¦‚: &#x27;output_audio.wav&#x27;)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># è¯»å–è§†é¢‘æ–‡ä»¶</span></span><br><span class="line">        video = VideoFileClip(video_path)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æå–éŸ³é¢‘</span></span><br><span class="line">        audio = video.audio</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å†™å…¥éŸ³é¢‘æ–‡ä»¶ï¼Œä¿å­˜ä¸º WAV æ ¼å¼</span></span><br><span class="line">        audio.write_audiofile(output_audio_path, codec=<span class="string">&#x27;pcm_s16le&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># é‡Šæ”¾èµ„æº</span></span><br><span class="line">        audio.close()</span><br><span class="line">        video.close()</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;éŸ³é¢‘å·²æˆåŠŸæå–å¹¶ä¿å­˜ä¸º: <span class="subst">&#123;output_audio_path&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;å¤„ç†è§†é¢‘æ—¶å‡ºé”™: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹ä½¿ç”¨</span></span><br><span class="line">video_path = <span class="string">&quot;input_video.mp4&quot;</span>  <span class="comment"># è¾“å…¥çš„è§†é¢‘æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">output_audio_path = <span class="string">&quot;output_audio.wav&quot;</span>  <span class="comment"># è¾“å‡ºçš„éŸ³é¢‘æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"></span><br><span class="line">extract_audio_from_video(video_path, output_audio_path)</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>åœ¨å¦‚ä¸‹è·¯å¾„ä¸‹è½½(éœ€è¦ç§‘å­¦ä¸Šç½‘)</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://makenweb.com/SpleeterGUI</span><br></pre></td></tr></table></figure><blockquote><p>ä¸‹è½½æˆåŠŸåï¼Œå¯¼å…¥ä¸Šè¿°æ­¥éª¤è¾“å‡ºéŸ³é¢‘è¾“å‡ºå¼€å§‹è½¬æ¢</p></blockquote><h2 id="demucs-åˆ†ç¦»">demucs åˆ†ç¦»</h2><blockquote><p>Demucs æ˜¯ Facebook AI Research (FAIR) å‘å¸ƒçš„ä¸€ä¸ªå¼ºå¤§çš„æ·±åº¦å­¦ä¹ éŸ³é¢‘åˆ†ç¦»æ¨¡å‹ï¼Œå®ƒèƒ½å¤Ÿå°†éŸ³ä¹åˆ†ç¦»æˆå¤šä¸ªæˆåˆ†ï¼ˆå¦‚äººå£°ã€é¼“å£°ã€è´æ–¯ã€å…¶ä»–ï¼‰ã€‚Demucs é‡‡ç”¨äº†æ—¶åŸŸå·ç§¯ç½‘ç»œï¼ˆTemporal Convolutional Networksï¼ŒTCNsï¼‰ï¼Œåœ¨éŸ³é¢‘åˆ†ç¦»ä¸­è¡¨ç°å¾—éå¸¸ä¼˜ç§€ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤æ‚éŸ³é¢‘å’Œå¤šç§éŸ³é¢‘æˆåˆ†æ··åˆçš„æƒ…å†µä¸‹</p></blockquote><h3 id="å®‰è£…ä½¿ç”¨-2">å®‰è£…ä½¿ç”¨</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install demucs</span><br><span class="line">demucs output.wav</span><br></pre></td></tr></table></figure><h2 id="openunmix-åˆ†ç¦»">openunmix åˆ†ç¦»</h2><blockquote><p>Open-Unmix æ˜¯ä¸€ä¸ªä¸“ä¸ºéŸ³é¢‘åˆ†ç¦»è®¾è®¡çš„å¼€æºæ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œç‰¹åˆ«é€‚ç”¨äºåˆ†ç¦»éŸ³ä¹ä¸­çš„äººå£°ä¸ä¼´å¥ã€‚å®ƒæ˜¯åŸºäº PyTorch å®ç°çš„ï¼Œèƒ½å¤Ÿå°†éŸ³é¢‘åˆ†ç¦»æˆå¤šä¸ªæ¥æºï¼ˆé€šå¸¸ä¸ºäººå£°ã€é¼“ã€è´æ–¯å’Œå…¶ä»–ä¼´å¥ï¼‰ã€‚</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install openunmix</span><br><span class="line">umx input_audio.wav</span><br></pre></td></tr></table></figure><h2 id="è„šæœ¬å®ç°">è„šæœ¬å®ç°</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># openumix</span></span><br><span class="line"><span class="keyword">import</span> openunmix</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†ç¦»éŸ³é¢‘</span></span><br><span class="line">input_file = <span class="string">&quot;input_audio.wav&quot;</span></span><br><span class="line">output_dir = <span class="string">&quot;output_directory&quot;</span></span><br><span class="line">umx = openunmix.Umx()</span><br><span class="line">umx.separate(input_file, output_dir)</span><br><span class="line"><span class="comment"># demucs</span></span><br><span class="line"><span class="keyword">import</span> demucs</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†ç¦»éŸ³é¢‘</span></span><br><span class="line">input_file = <span class="string">&quot;input_audio.wav&quot;</span></span><br><span class="line">output_dir = <span class="string">&quot;output_directory&quot;</span></span><br><span class="line">demucs.separate(input_file, output_dir)</span><br></pre></td></tr></table></figure><ul><li>æ— éŸ³é¢‘æ•°æ®è§†é¢‘ä¸æ— äººå£°æ•°æ®åˆå¹¶</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge_video_audio</span>(<span class="params">video_file, audio_file, output_file</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ä½¿ç”¨ FFmpeg åˆå¹¶è§†é¢‘å’ŒéŸ³é¢‘ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param video_file: è¾“å…¥çš„è§†é¢‘æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"><span class="string">    :param audio_file: è¾“å…¥çš„éŸ³é¢‘æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"><span class="string">    :param output_file: åˆå¹¶åçš„è¾“å‡ºè§†é¢‘è·¯å¾„</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    command = [</span><br><span class="line">        <span class="string">r&#x27;D:\ffmpeg-7.0.2-essentials_build\bin\ffmpeg.exe&#x27;</span>,  <span class="comment"># FFmpeg å¯æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„</span></span><br><span class="line">        <span class="string">&#x27;-i&#x27;</span>, video_file,  <span class="comment"># è¾“å…¥è§†é¢‘æ–‡ä»¶</span></span><br><span class="line">        <span class="string">&#x27;-i&#x27;</span>, audio_file,  <span class="comment"># è¾“å…¥éŸ³é¢‘æ–‡ä»¶</span></span><br><span class="line">        <span class="string">&#x27;-c:v&#x27;</span>, <span class="string">&#x27;copy&#x27;</span>,  <span class="comment"># ä¿æŒè§†é¢‘ç¼–è§£ç æ ¼å¼ä¸å˜</span></span><br><span class="line">        <span class="string">&#x27;-c:a&#x27;</span>, <span class="string">&#x27;aac&#x27;</span>,  <span class="comment"># è®¾ç½®éŸ³é¢‘ç¼–ç æ ¼å¼ä¸º AAC</span></span><br><span class="line">        <span class="string">&#x27;-strict&#x27;</span>, <span class="string">&#x27;experimental&#x27;</span>,  <span class="comment"># å…è®¸ä½¿ç”¨å®éªŒæ€§çš„éŸ³é¢‘ç¼–è§£ç å™¨</span></span><br><span class="line">        <span class="string">&#x27;-map&#x27;</span>, <span class="string">&#x27;0:v:0&#x27;</span>,  <span class="comment"># æ˜ å°„è§†é¢‘æµ</span></span><br><span class="line">        <span class="string">&#x27;-map&#x27;</span>, <span class="string">&#x27;1:a:0&#x27;</span>,  <span class="comment"># æ˜ å°„éŸ³é¢‘æµ</span></span><br><span class="line">        <span class="string">&#x27;-y&#x27;</span>,  <span class="comment"># è¦†ç›–è¾“å‡ºæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰</span></span><br><span class="line">        output_file  <span class="comment"># è¾“å‡ºåˆå¹¶åçš„æ–‡ä»¶</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        subprocess.run(command, check=<span class="literal">True</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;è§†é¢‘å’ŒéŸ³é¢‘å·²æˆåŠŸåˆå¹¶å¹¶ä¿å­˜ä¸º: <span class="subst">&#123;output_file&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> subprocess.CalledProcessError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;åˆå¹¶è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scan_and_merge</span>(<span class="params">video_dir, audio_dir, output_dir</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æ‰«æè§†é¢‘å’ŒéŸ³é¢‘æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰æ–‡ä»¶ï¼Œå¹¶åˆå¹¶ä¸€ä¸€å¯¹åº”çš„æ–‡ä»¶ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param video_dir: å­˜æ”¾è§†é¢‘æ–‡ä»¶çš„ç›®å½•</span></span><br><span class="line"><span class="string">    :param audio_dir: å­˜æ”¾éŸ³é¢‘æ–‡ä»¶çš„ç›®å½•</span></span><br><span class="line"><span class="string">    :param output_dir: è¾“å‡ºåˆå¹¶åæ–‡ä»¶çš„ç›®å½•</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># é€’å½’è·å–è§†é¢‘æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰ .mp4 æ–‡ä»¶</span></span><br><span class="line">    video_files = []</span><br><span class="line">    <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(video_dir):</span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">            <span class="keyword">if</span> file.endswith(<span class="string">&#x27;.mp4&#x27;</span>):</span><br><span class="line">                video_files.append(os.path.join(root, file))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># é€’å½’è·å–éŸ³é¢‘æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰ .wav æ–‡ä»¶</span></span><br><span class="line">    audio_files = []</span><br><span class="line">    <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(audio_dir):</span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">            <span class="keyword">if</span> file.endswith(<span class="string">&#x27;.wav&#x27;</span>):</span><br><span class="line">                audio_files.append(os.path.join(root, file))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç¡®ä¿è¾“å‡ºæ–‡ä»¶å¤¹å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(output_dir):</span><br><span class="line">        os.makedirs(output_dir)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> video_file <span class="keyword">in</span> video_files:</span><br><span class="line">        <span class="comment"># è·å–ä¸å¸¦è·¯å¾„çš„æ–‡ä»¶åï¼ˆä¸åŒ…æ‹¬æ‰©å±•åï¼‰</span></span><br><span class="line">        video_name = os.path.splitext(os.path.basename(video_file))[<span class="number">0</span>].replace(<span class="string">&quot;_no_audio&quot;</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æŸ¥æ‰¾å¯¹åº”çš„éŸ³é¢‘æ–‡ä»¶ï¼ˆä»éŸ³é¢‘æ–‡ä»¶æ‰€åœ¨çš„çˆ¶ç›®å½•åç§°è¿›è¡ŒåŒ¹é…ï¼‰</span></span><br><span class="line">        matching_audio_file = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">for</span> audio_file <span class="keyword">in</span> audio_files:</span><br><span class="line">            <span class="comment"># è·å–éŸ³é¢‘æ–‡ä»¶çš„çˆ¶ç›®å½•åç§°</span></span><br><span class="line">            audio_file_parent_dir = os.path.basename(os.path.dirname(audio_file))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># ä½¿ç”¨éŸ³é¢‘æ–‡ä»¶çˆ¶ç›®å½•åç§°è¿›è¡ŒåŒ¹é…</span></span><br><span class="line">            <span class="keyword">if</span> video_name <span class="keyword">in</span> audio_file_parent_dir:</span><br><span class="line">                matching_audio_file = audio_file</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> matching_audio_file:</span><br><span class="line">            <span class="comment"># æ„é€ è¾“å‡ºæ–‡ä»¶è·¯å¾„</span></span><br><span class="line">            output_path = os.path.join(output_dir, <span class="string">f&quot;<span class="subst">&#123;video_name&#125;</span>_merged.mp4&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># åˆå¹¶è§†é¢‘å’ŒéŸ³é¢‘</span></span><br><span class="line">            merge_video_audio(video_file, matching_audio_file, output_path)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;æ‰¾ä¸åˆ°ä¸ <span class="subst">&#123;video_file&#125;</span> å¯¹åº”çš„éŸ³é¢‘æ–‡ä»¶.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹ä½¿ç”¨</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    video_dir = <span class="string">r&#x27;D:\pythonProject\audio_record_server\src\utils\output_video_dir&#x27;</span>  <span class="comment"># è§†é¢‘æ–‡ä»¶å¤¹è·¯å¾„</span></span><br><span class="line">    audio_dir = <span class="string">r&#x27;D:\pythonProject\audio_record_server\src\utils\output_audio_umxl&#x27;</span>  <span class="comment"># éŸ³é¢‘æ–‡ä»¶å¤¹è·¯å¾„</span></span><br><span class="line">    output_dir = <span class="string">r&#x27;D:\pythonProject\audio_record_server\src\utils\output_result&#x27;</span>  <span class="comment"># è¾“å‡ºæ–‡ä»¶å¤¹è·¯å¾„</span></span><br><span class="line"></span><br><span class="line">    scan_and_merge(video_dir, audio_dir, output_dir)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="æ•ˆæœå¯¹æ¯”">æ•ˆæœå¯¹æ¯”</h2><table><thead><tr><th>åº“</th><th>spleeter</th><th>demuics</th><th>open-unmix</th></tr></thead><tbody><tr><td>äººå£°åˆ†ç¦»æ•ˆæœ</td><td>å·®</td><td>è¾ƒå¥½</td><td>è¾ƒå¥½</td></tr><tr><td>æœ‰æ— GUI</td><td>æœ‰</td><td></td><td></td></tr><tr><td>é€Ÿåº¦</td><td>10s</td><td>5s</td><td>2s</td></tr><tr><td>å¤‡æ³¨</td><td></td><td></td><td></td></tr></tbody></table><blockquote><p>ä¸Šè¿°å¯¹æ¯”ä¸ºåŒæ—¶å¤„ç†32sæ—¶é•¿ wavæ ¼å¼é‡‡æ ·ç‡ä¸º44100khzï¼Œæ¯”ç‰¹ç‡ï¼š1411kpsï¼Œç«‹ä½“å£°çš„éŸ³é¢‘ç»“æœå¯¹æ¯”</p></blockquote><h2 id="æ•ˆæœæµ‹è¯•">æ•ˆæœæµ‹è¯•</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _*_ coding: utf-8 _*_</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Time:     2024/12/26 16:57</span></span><br><span class="line"><span class="string">Author:   ZhaoQi Cao(czq)</span></span><br><span class="line"><span class="string">Version:  V 0.1</span></span><br><span class="line"><span class="string">File:     video_split_audio.py</span></span><br><span class="line"><span class="string">Describe: Write during the python at zgxmt, Github link: https://github.com/caozhaoqi</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"><span class="keyword">import</span> openunmix</span><br><span class="line"><span class="keyword">import</span> demucs</span><br><span class="line"><span class="keyword">from</span> moviepy <span class="keyword">import</span> VideoFileClip, AudioFileClip, CompositeVideoClip</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">import</span> soundfile <span class="keyword">as</span> sf</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.meger_video_audio <span class="keyword">import</span> scan_and_merge</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®æ—¥å¿—</span></span><br><span class="line">logging.basicConfig(level=logging.INFO, <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…¨å±€å˜é‡</span></span><br><span class="line">OUTPUT_AUDIO_UMXL = <span class="string">&quot;./output_audio_umxl&quot;</span></span><br><span class="line">OUTPUT_AUDIO_DEMUCS = <span class="string">&quot;./output_audio_demucs&quot;</span></span><br><span class="line">PROCESSED_FILES = <span class="built_in">set</span>()  <span class="comment"># ç”¨äºè®°å½•å·²å¤„ç†çš„æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_audio_from_video</span>(<span class="params">video_path, output_audio_dir, output_video_dir</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ä»è§†é¢‘ä¸­æå–éŸ³é¢‘å¹¶ä¿å­˜ä¸º WAV æ ¼å¼ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param video_path: è¾“å…¥è§†é¢‘æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"><span class="string">    :param output_audio_dir: è¾“å‡ºéŸ³é¢‘æ–‡ä»¶ç›®å½•</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># è·å–è§†é¢‘æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰</span></span><br><span class="line">        video_name = os.path.basename(video_path).split(<span class="string">&quot;.&quot;</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¾“å‡ºéŸ³é¢‘æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">        output_audio_path = os.path.join(output_audio_dir, <span class="string">f&quot;<span class="subst">&#123;video_name&#125;</span>.wav&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¾“å‡ºä¸å«éŸ³é¢‘çš„è§†é¢‘æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">        output_video_path = os.path.join(output_video_dir, <span class="string">f&quot;<span class="subst">&#123;video_name&#125;</span>_no_audio.mp4&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œé¿å…é‡å¤æå–</span></span><br><span class="line">        <span class="keyword">if</span> os.path.exists(output_audio_path):</span><br><span class="line">            logging.warning(<span class="string">f&quot;éŸ³é¢‘æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡æå–ï¼š<span class="subst">&#123;output_audio_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logging.info(<span class="string">f&quot;å¼€å§‹æå–éŸ³é¢‘ï¼š<span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># è¯»å–è§†é¢‘æ–‡ä»¶</span></span><br><span class="line">            video = VideoFileClip(video_path)</span><br><span class="line">            <span class="comment"># æå–è§†é¢‘ä¸­çš„éŸ³é¢‘</span></span><br><span class="line">            audio = video.audio</span><br><span class="line">            <span class="comment"># ä¿å­˜éŸ³é¢‘ä¸º WAV æ ¼å¼</span></span><br><span class="line">            audio.write_audiofile(output_audio_path, codec=<span class="string">&#x27;pcm_s16le&#x27;</span>)</span><br><span class="line">            <span class="comment"># é‡Šæ”¾éŸ³é¢‘èµ„æº</span></span><br><span class="line">            audio.close()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¯»å–è§†é¢‘æ–‡ä»¶</span></span><br><span class="line">        video = VideoFileClip(video_path)</span><br><span class="line">        <span class="comment"># å°†è§†é¢‘çš„éŸ³é¢‘éƒ¨åˆ†è®¾ä¸º Noneï¼Œä»è€Œå»é™¤éŸ³é¢‘</span></span><br><span class="line">        video_without_audio = video.without_audio()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä¿å­˜ä¸å«éŸ³é¢‘çš„è§†é¢‘</span></span><br><span class="line">        video_without_audio.write_videofile(output_video_path, codec=<span class="string">&quot;libx264&quot;</span>, audio=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># é‡Šæ”¾è§†é¢‘èµ„æº</span></span><br><span class="line">        video.close()</span><br><span class="line">        video_without_audio.close()</span><br><span class="line"></span><br><span class="line">        logging.info(<span class="string">f&quot;éŸ³é¢‘å·²æˆåŠŸæå–å¹¶ä¿å­˜ä¸º: <span class="subst">&#123;output_audio_path&#125;</span>&quot;</span>)</span><br><span class="line">        logging.info(<span class="string">f&quot;ä¸å«éŸ³é¢‘çš„è§†é¢‘å·²ä¿å­˜ä¸º: <span class="subst">&#123;output_video_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> output_audio_path, output_video_path</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;å¤„ç†è§†é¢‘æ—¶å‡ºé”™: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_audio_umx</span>(<span class="params">file_path, output_dir</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ä½¿ç”¨ UMX æ¨¡å‹è¿›è¡ŒéŸ³é¢‘åˆ†ç¦»ï¼Œå¹¶æ·»åŠ æºæ–‡ä»¶ååˆ°è¾“å‡ºæ–‡ä»¶åä¸­</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> file_path <span class="keyword">in</span> PROCESSED_FILES:</span><br><span class="line">            logging.warning(<span class="string">f&quot;æ–‡ä»¶å·²å¤„ç†ï¼Œè·³è¿‡ UMX: <span class="subst">&#123;file_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        logging.info(<span class="string">f&quot;å¼€å§‹ UMX å¤„ç†: <span class="subst">&#123;file_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># ä½¿ç”¨ openunmix.umx.separate å‡½æ•°è°ƒç”¨</span></span><br><span class="line">        <span class="comment"># ä»æ–‡ä»¶è·¯å¾„ä¸­æå–æ–‡ä»¶åï¼ˆä¸åŒ…å«æ‰©å±•åï¼‰</span></span><br><span class="line">        file_name = os.path.basename(file_path).split(<span class="string">&quot;.&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">        output_prefix_dir = os.path.join(output_dir, file_name)  <span class="comment"># æ·»åŠ å‰ç¼€åˆ°è¾“å‡ºç›®å½•</span></span><br><span class="line">        os.makedirs(output_prefix_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># if umx_args is None:</span></span><br><span class="line">        <span class="comment">#     umx_args = []</span></span><br><span class="line">        <span class="comment">#     # æ„å»ºå®Œæ•´çš„ umx å‘½ä»¤</span></span><br><span class="line">        command = [<span class="string">&quot;umx&quot;</span>, file_path, <span class="string">&quot;--outdir&quot;</span>, output_prefix_dir]</span><br><span class="line"></span><br><span class="line">        result = subprocess.run(command, capture_output=<span class="literal">True</span>, text=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">if</span> result.returncode != <span class="number">0</span>:</span><br><span class="line">            logging.error(<span class="string">f&quot;UMX æ‰§è¡Œå‡ºé”™: <span class="subst">&#123;result.stderr&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        logging.info(<span class="string">f&quot;UMX å¤„ç†å®Œæˆ: <span class="subst">&#123;file_path&#125;</span>&quot;</span>)</span><br><span class="line">        PROCESSED_FILES.add(file_path)  <span class="comment"># è®°å½•å·²å¤„ç†</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;å¤„ç†UMXæ—¶å‡ºé”™: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_audio_demucs</span>(<span class="params">file_path, output_dir</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ä½¿ç”¨ Demucs æ¨¡å‹è¿›è¡ŒéŸ³é¢‘åˆ†ç¦»ï¼Œå¹¶æ·»åŠ æºæ–‡ä»¶ååˆ°è¾“å‡ºæ–‡ä»¶åä¸­</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> file_path <span class="keyword">in</span> PROCESSED_FILES:</span><br><span class="line">            logging.warning(<span class="string">f&quot;æ–‡ä»¶å·²å¤„ç†ï¼Œè·³è¿‡ Demucs: <span class="subst">&#123;file_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        logging.info(<span class="string">f&quot;å¼€å§‹ Demucs å¤„ç†: <span class="subst">&#123;file_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># ä½¿ç”¨ demucs.api.separate_audio å‡½æ•°è°ƒç”¨</span></span><br><span class="line">        <span class="comment"># ä»æ–‡ä»¶è·¯å¾„ä¸­æå–æ–‡ä»¶åï¼ˆä¸åŒ…å«æ‰©å±•åï¼‰</span></span><br><span class="line">        file_name = os.path.basename(file_path).split(<span class="string">&quot;.&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">        output_prefix_dir = os.path.join(output_dir, file_name)  <span class="comment"># æ·»åŠ å‰ç¼€åˆ°è¾“å‡ºç›®å½•</span></span><br><span class="line">        os.makedirs(output_prefix_dir, exist_ok=<span class="literal">True</span>)  <span class="comment"># åˆ›å»ºè¾“å‡ºç›®å½•</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># if umx_args is None:</span></span><br><span class="line">        <span class="comment">#     umx_args = []</span></span><br><span class="line">        <span class="comment"># æ„å»ºå®Œæ•´çš„ umx å‘½ä»¤</span></span><br><span class="line">        command = [<span class="string">&quot;umx&quot;</span>, file_path, <span class="string">&quot;--outdir&quot;</span>, output_prefix_dir]</span><br><span class="line"></span><br><span class="line">        result = subprocess.run(command, capture_output=<span class="literal">True</span>, text=<span class="literal">True</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>)  <span class="comment"># æŒ‡å®šç¼–ç </span></span><br><span class="line">        <span class="keyword">if</span> result.returncode != <span class="number">0</span>:</span><br><span class="line">            logging.error(<span class="string">f&quot;UMX æ‰§è¡Œå‡ºé”™: <span class="subst">&#123;result.stderr&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        logging.info(<span class="string">f&quot;UMX å¤„ç†å®Œæˆ: <span class="subst">&#123;file_path&#125;</span>&quot;</span>)</span><br><span class="line">        PROCESSED_FILES.add(file_path)  <span class="comment"># è®°å½•å·²å¤„ç†</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;å¤„ç†UMXæ—¶å‡ºé”™: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_all_audio_files</span>(<span class="params">audio_files, output_umx_dir, output_demucs_dir</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    å¤šçº¿ç¨‹å¤„ç†æ‰€æœ‰éŸ³é¢‘æ–‡ä»¶</span></span><br><span class="line"><span class="string">    :param audio_files:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    logging.info(<span class="string">f&quot;å¼€å§‹å¤„ç† <span class="subst">&#123;<span class="built_in">len</span>(audio_files)&#125;</span> ä¸ªéŸ³é¢‘æ–‡ä»¶.&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="number">4</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        futures = []</span><br><span class="line">        <span class="keyword">for</span> file_path <span class="keyword">in</span> audio_files:</span><br><span class="line">            futures.append(executor.submit(process_audio_umx, file_path, output_umx_dir))</span><br><span class="line">            <span class="comment"># futures.append(executor.submit(process_audio_demucs, file_path, output_demucs_dir))</span></span><br><span class="line">        <span class="keyword">for</span> future <span class="keyword">in</span> tqdm(futures, desc=<span class="string">&quot;å¤„ç†è¿›åº¦&quot;</span>):</span><br><span class="line">            future.result()  <span class="comment"># ç­‰å¾…å®Œæˆå¹¶å¤„ç†å¼‚å¸¸</span></span><br><span class="line">    logging.info(<span class="string">&quot;æ‰€æœ‰éŸ³é¢‘æ–‡ä»¶å¤„ç†å®Œæˆ.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">collect_audio_from_dir</span>(<span class="params">input_dir, output_audio_dir, output_video_dir</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è¯»å–æŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰è§†é¢‘æ–‡ä»¶ï¼Œæå–éŸ³é¢‘</span></span><br><span class="line"><span class="string">    :param input_dir:</span></span><br><span class="line"><span class="string">    :return: æ‰€æœ‰éŸ³é¢‘æ–‡ä»¶åˆ—è¡¨</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    audio_files = []</span><br><span class="line">    video_files = [os.path.join(input_dir, filename)</span><br><span class="line">                   <span class="keyword">for</span> filename <span class="keyword">in</span> os.listdir(input_dir)</span><br><span class="line">                   <span class="keyword">if</span> filename.lower().endswith((<span class="string">&#x27;.mp4&#x27;</span>, <span class="string">&#x27;.mov&#x27;</span>, <span class="string">&#x27;.mkv&#x27;</span>, <span class="string">&#x27;.avi&#x27;</span>, <span class="string">&#x27;.webm&#x27;</span>))]</span><br><span class="line">    <span class="keyword">with</span> tqdm(total=<span class="built_in">len</span>(video_files), desc=<span class="string">&quot;æå–éŸ³é¢‘&quot;</span>, unit=<span class="string">&quot;file&quot;</span>) <span class="keyword">as</span> pbar:</span><br><span class="line">        <span class="keyword">for</span> video_path <span class="keyword">in</span> video_files:</span><br><span class="line">            audio_file, video_files_out = extract_audio_from_video(video_path, output_audio_dir, output_video_dir)</span><br><span class="line">            <span class="keyword">if</span> audio_file:</span><br><span class="line">                audio_files.append(audio_file)</span><br><span class="line">            pbar.update(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> audio_files</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_all_files_from_dir</span>(<span class="params"><span class="built_in">dir</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ä»æŒ‡å®šç›®å½•è¯»å–æ‰€æœ‰æ–‡ä»¶</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    all_files = []</span><br><span class="line">    <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(<span class="built_in">dir</span>):</span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">            file_path = os.path.join(root, file)</span><br><span class="line">            all_files.append(file_path)</span><br><span class="line">    <span class="keyword">return</span> all_files</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    input_video_dir = <span class="string">r&#x27;E:\download\youtobe_video\test&#x27;</span>  <span class="comment"># è¾“å…¥è§†é¢‘æ–‡ä»¶ç›®å½•</span></span><br><span class="line">    output_audio_dir = <span class="string">&quot;output_audio&quot;</span>  <span class="comment"># è¾“å‡ºéŸ³é¢‘ç›®å½•</span></span><br><span class="line">    output_umx_dir = <span class="string">&quot;output_audio_umxl&quot;</span></span><br><span class="line">    output_demucs_dir = <span class="string">&quot;output_audio_demucs&quot;</span></span><br><span class="line">    output_video_dir = <span class="string">&quot;output_video_dir&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ›å»ºè¾“å‡ºç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰</span></span><br><span class="line">    os.makedirs(output_audio_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    os.makedirs(output_umx_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    os.makedirs(output_demucs_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    os.makedirs(output_video_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    logging.info(<span class="string">&quot;å¼€å§‹æå–éŸ³é¢‘ å•ç‹¬ä¿å­˜æ— éŸ³é¢‘è§†é¢‘æ–‡ä»¶&quot;</span>)</span><br><span class="line">    <span class="comment"># 1. ä»æŒ‡å®šç›®å½•è¯»å–è§†é¢‘æ–‡ä»¶å¹¶æå–éŸ³é¢‘</span></span><br><span class="line">    audio_files = collect_audio_from_dir(input_video_dir, output_audio_dir, output_video_dir)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. å¤šçº¿ç¨‹å¤„ç†æ‰€æœ‰éŸ³é¢‘æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> audio_files:</span><br><span class="line">        logging.info(<span class="string">&quot;å¼€å§‹å¤„ç†éŸ³é¢‘æ–‡ä»¶ è¾“å‡ºæ— äººå£°éŸ³é¢‘&quot;</span>)</span><br><span class="line">        process_all_audio_files(audio_files, output_umx_dir, output_demucs_dir)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logging.warning(<span class="string">&quot;æ²¡æœ‰æ‰¾åˆ°ä»»ä½•éŸ³é¢‘æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥è¾“å…¥ç›®å½•&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. è¯»å–æ‰€æœ‰è¾“å‡ºæ–‡ä»¶</span></span><br><span class="line">    <span class="comment"># logging.info(&quot;è¾“å‡ºæ–‡ä»¶&quot;)</span></span><br><span class="line">    <span class="comment"># all_output_files_umx = get_all_files_from_dir(output_umx_dir)</span></span><br><span class="line">    <span class="comment"># all_output_files_demucs = get_all_files_from_dir(output_demucs_dir)</span></span><br><span class="line">    logging.info(<span class="string">&quot;åˆå¹¶éŸ³ï¼ˆæ— äººå£°ï¼‰è§†é¢‘ï¼ˆæ— éŸ³é¢‘ï¼‰æ–‡ä»¶ è¾“å‡ºæ— äººå£°è§†é¢‘æ–‡ä»¶&quot;</span>)</span><br><span class="line">    video_dir = <span class="string">r&#x27;D:\pythonProject\audio_record_server\src\utils\output_video_dir&#x27;</span>  <span class="comment"># è§†é¢‘æ–‡ä»¶å¤¹è·¯å¾„</span></span><br><span class="line">    audio_dir = <span class="string">r&#x27;D:\pythonProject\audio_record_server\src\utils\output_audio_umxl&#x27;</span>  <span class="comment"># éŸ³é¢‘æ–‡ä»¶å¤¹è·¯å¾„</span></span><br><span class="line">    output_dir = <span class="string">r&#x27;D:\pythonProject\audio_record_server\src\utils\output_result&#x27;</span>  <span class="comment"># è¾“å‡ºæ–‡ä»¶å¤¹è·¯å¾„</span></span><br><span class="line"></span><br><span class="line">    scan_and_merge(video_dir, audio_dir, output_dir)</span><br><span class="line">    logging.info(<span class="string">&quot;å¤„ç†å®Œæˆ&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="å…¨æµç¨‹è€—æ—¶ç»Ÿè®¡">å…¨æµç¨‹è€—æ—¶ç»Ÿè®¡</h2><table><thead><tr><th>é¡¹ç›®</th><th>æ—¶é—´</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>åˆ†ç¦»è§†é¢‘éŸ³é¢‘</td><td>&lt;1s</td><td>ä½¿ç”¨æ—¶é•¿ä¸º10åˆ†15ç§’æ—¶é•¿è§†é¢‘æµ‹è¯•</td></tr><tr><td>éŸ³é¢‘å»é™¤äººå£°(umx)</td><td>40s</td><td></td></tr><tr><td>éŸ³é¢‘å»é™¤äººå£°(demucs)</td><td>36s</td><td></td></tr><tr><td>è§†é¢‘åˆ†ç¦»éŸ³é¢‘</td><td>145s/141s</td><td>CPUå ç”¨æå¤§</td></tr><tr><td>åˆå¹¶éŸ³è§†é¢‘</td><td>2s</td><td></td></tr></tbody></table><h2 id="one-more-thing">one more thing</h2><ul><li>å™ªå£°å»é™¤</li></ul><blockquote><p>ä½¿ç”¨pydubå’Œnoisereduceåº“å»é™¤,å…·ä½“å®ç°å¦‚ä¸‹:</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _*_ coding: utf-8 _*_</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Time:     2024/12/27 11:40</span></span><br><span class="line"><span class="string">Author:   ZhaoQi Cao(czq)</span></span><br><span class="line"><span class="string">Version:  V 0.1</span></span><br><span class="line"><span class="string">File:     noise_split_audio.py</span></span><br><span class="line"><span class="string">Describe: Write during the python at zgxmt, Github link: https://github.com/caozhaoqi</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> noisereduce <span class="keyword">as</span> nr</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pydub</span><br><span class="line"><span class="keyword">from</span> pydub <span class="keyword">import</span> AudioSegment</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reduce_noise</span>(<span class="params">input_audio_path, output_audio_path</span>):</span><br><span class="line">    <span class="comment"># åŠ è½½éŸ³é¢‘æ–‡ä»¶</span></span><br><span class="line">    audio = AudioSegment.from_wav(input_audio_path)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è½¬æ¢éŸ³é¢‘ä¸º numpy æ•°ç»„æ ¼å¼ï¼ˆ`pydub` é»˜è®¤ä»¥ 16-bit PCM æ ¼å¼åŠ è½½ï¼‰</span></span><br><span class="line">    samples = audio.get_array_of_samples()</span><br><span class="line">    samples = np.array(samples)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä½¿ç”¨ noisereduce å»é™¤å™ªå£°</span></span><br><span class="line">    reduced_noise_samples = nr.reduce_noise(y=samples, sr=audio.frame_rate)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è½¬æ¢å»å™ªåçš„æ ·æœ¬å› `pydub` æ ¼å¼</span></span><br><span class="line">    reduced_audio = AudioSegment(</span><br><span class="line">        reduced_noise_samples.tobytes(),</span><br><span class="line">        frame_rate=audio.frame_rate,</span><br><span class="line">        sample_width=audio.sample_width,</span><br><span class="line">        channels=audio.channels</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¿å­˜å»å™ªåçš„éŸ³é¢‘</span></span><br><span class="line">    reduced_audio.export(output_audio_path, <span class="built_in">format</span>=<span class="string">&quot;wav&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;å»å™ªåçš„éŸ³é¢‘å·²ä¿å­˜ä¸º: <span class="subst">&#123;output_audio_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹ä½¿ç”¨</span></span><br><span class="line">input_audio = <span class="string">r&quot;D:\pythonProject\audio_record_server\src\utils\output_audio\æ¯”èµ›é›†é”¦ï¼šHighlightsâ€”â€”Ma Jinbao VS Kanoya Ryohei (2018 LA Open).wav&quot;</span>  <span class="comment"># è¾“å…¥éŸ³é¢‘æ–‡ä»¶</span></span><br><span class="line">output_audio = <span class="string">&quot;output_audio_reduced.wav&quot;</span>  <span class="comment"># è¾“å‡ºå»å™ªéŸ³é¢‘æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line">reduce_noise(input_audio, output_audio)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="See">See</h2><ul><li><ol><li><a href="https://github.com/facebookresearch/demucs">https://github.com/facebookresearch/demucs</a></li></ol></li><li><ol start="2"><li><a href="https://github.com/sigsep/open-unmix-pytorch">https://github.com/sigsep/open-unmix-pytorch</a></li></ol></li><li><ol start="3"><li><a href="https://github.com/deezer/spleeter/">https://github.com/deezer/spleeter/</a></li></ol></li><li><ol start="4"><li><a href="https://archives.ismir.net/ismir2019/latebreaking/000036.pdf">https://archives.ismir.net/ismir2019/latebreaking/000036.pdf</a></li></ol></li><li><ol start="5"><li><a href="https://colab.research.google.com/drive/1ogqMwCY45Ka15Gb_ilMt7HUJbkrNX4y-">https://colab.research.google.com/drive/1ogqMwCY45Ka15Gb_ilMt7HUJbkrNX4y-</a></li></ol></li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>label studioå¼•å…¥nemo_asrå®ç°é¢„æµ‹æ ‡æ³¨æ–‡æœ¬</title>
      <link href="/2024/12/25/ml-backend-ls/"/>
      <url>/2024/12/25/ml-backend-ls/</url>
      
        <content type="html"><![CDATA[<h1>label studioå¼•å…¥nemo_asrå®ç°é¢„æµ‹æ ‡æ³¨æ–‡æœ¬</h1><h2 id="clone-and-use">clone and use</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/HumanSignal/label-studio-ml-backend</span><br></pre></td></tr></table></figure><h2 id="install">install</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip install -r requirements.txt</span><br><span class="line"></span><br><span class="line">pip install -e .</span><br></pre></td></tr></table></figure><h2 id="start">start</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">label-studio-ml start ./nemo_asr</span><br></pre></td></tr></table></figure><h2 id="coding">coding</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># _*_ coding: utf-8 _*_</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Time:     2024/12/19 16:59</span></span><br><span class="line"><span class="string">Author:   ZhaoQi Cao(czq)</span></span><br><span class="line"><span class="string">Version:  V 0.1</span></span><br><span class="line"><span class="string">File:     transit_nameko.py</span></span><br><span class="line"><span class="string">Describe: Write during the python at zgxmt, Github link: https://github.com/caozhaoqi</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> nemo</span><br><span class="line"><span class="keyword">import</span> nemo.collections.asr <span class="keyword">as</span> nemo_asr</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> nemo.collections.asr <span class="keyword">as</span> nemo_asr</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„æ¨¡å‹</span></span><br><span class="line"><span class="comment"># print(nemo_asr.models.ASRModel.list_available_models())</span></span><br><span class="line"><span class="comment"># é…ç½® Label Studio API å’Œé¡¹ç›®</span></span><br><span class="line">LABEL_STUDIO_API_URL = <span class="string">&quot;http://localhost:8080/api&quot;</span></span><br><span class="line">PROJECT_ID = <span class="number">12</span>  <span class="comment"># ä½ çš„ Label Studio é¡¹ç›® ID</span></span><br><span class="line">API_KEY = <span class="string">&quot;93e8ebc81cc1337c41567aa20113fd74934a4f17&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®è¯·æ±‚å¤´</span></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">f&quot;Token <span class="subst">&#123;API_KEY&#125;</span>&quot;</span>,</span><br><span class="line">    <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½ Nemo ASR æ¨¡å‹</span></span><br><span class="line">asr_model = nemo_asr.models.ASRModel.from_pretrained(model_name=<span class="string">&quot;stt_zh_citrinet_1024_gamma_0_25&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># éŸ³é¢‘è½¬å½•å‡½æ•°</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">transcribe_audio</span>(<span class="params">audio_file_path</span>):</span><br><span class="line">    transcription = asr_model.transcribe([audio_file_path])</span><br><span class="line">    <span class="keyword">return</span> transcription[<span class="number">0</span>]  <span class="comment"># è¿”å›è½¬å½•æ–‡æœ¬</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä»»åŠ¡å¹¶ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_task</span>(<span class="params">audio_file_path</span>):</span><br><span class="line">    files = &#123;</span><br><span class="line">        <span class="string">&#x27;file&#x27;</span>: <span class="built_in">open</span>(audio_file_path, <span class="string">&#x27;rb&#x27;</span>),</span><br><span class="line">    &#125;</span><br><span class="line">    response = requests.post(<span class="string">f&quot;<span class="subst">&#123;LABEL_STUDIO_API_URL&#125;</span>/projects/<span class="subst">&#123;PROJECT_ID&#125;</span>/import&quot;</span>, headers=headers, files=files)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">        task_data = response.json()</span><br><span class="line">        task_id = task_data[<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Task created with ID: <span class="subst">&#123;task_id&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> task_id</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Error uploading file: <span class="subst">&#123;response.text&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›´æ–°ä»»åŠ¡å¹¶å¡«å……è½¬å½•æ–‡æœ¬</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update_task_with_transcription</span>(<span class="params">task_id, transcription</span>):</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;audio&quot;</span>: task_id,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;annotations&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;result&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;from_name&quot;</span>: <span class="string">&quot;transcription&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;to_name&quot;</span>: <span class="string">&quot;audio&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;textarea&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;value&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;text&quot;</span>: transcription</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    response = requests.post(<span class="string">f&quot;<span class="subst">&#123;LABEL_STUDIO_API_URL&#125;</span>/tasks/<span class="subst">&#123;task_id&#125;</span>/annotations/&quot;</span>, headers=headers, json=data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Task <span class="subst">&#123;task_id&#125;</span> updated with transcription.&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Error updating task <span class="subst">&#123;task_id&#125;</span>: <span class="subst">&#123;response.text&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤„ç†å’Œæäº¤éŸ³é¢‘æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_and_submit_audio_files</span>(<span class="params">audio_files_dir</span>):</span><br><span class="line">    <span class="keyword">for</span> audio_file <span class="keyword">in</span> os.listdir(audio_files_dir):</span><br><span class="line">        audio_file_path = os.path.join(audio_files_dir, audio_file)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è·å–è½¬å½•ç»“æœ</span></span><br><span class="line">        transcription = transcribe_audio(audio_file_path)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># åˆ›å»ºä»»åŠ¡å¹¶ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶</span></span><br><span class="line">        task_id = create_task(audio_file_path)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> task_id:</span><br><span class="line">            <span class="comment"># æ›´æ–°ä»»åŠ¡å¹¶æäº¤è½¬å½•æ–‡æœ¬</span></span><br><span class="line">            update_task_with_transcription(task_id, transcription)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šéŸ³é¢‘æ–‡ä»¶å­˜æ”¾ç›®å½•</span></span><br><span class="line">audio_files_directory = <span class="string">&quot;./out&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œæ‰¹é‡å¤„ç†</span></span><br><span class="line">process_and_submit_audio_files(audio_files_directory)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åœ¨label studio å¼•å…¥whisper å®ç°è¯­éŸ³è½¬å†™ä¸è¯´è¯äººåˆ†ç¦»</title>
      <link href="/2024/12/17/label-studio-whisper/"/>
      <url>/2024/12/17/label-studio-whisper/</url>
      
        <content type="html"><![CDATA[<h1>åœ¨label studio å¼•å…¥whisper å®ç°è¯­éŸ³è½¬å†™ä¸è¯´è¯äººåˆ†ç¦»</h1><h2 id="Label-Studio-ä»‹ç»">Label Studio ä»‹ç»</h2><blockquote><p>Label Studio æ˜¯ä¸€ä¸ªå¼€æºçš„æ•°æ®æ ‡æ³¨å·¥å…·ï¼Œå¹¿æ³›åº”ç”¨äºæœºå™¨å­¦ä¹ å’Œäººå·¥æ™ºèƒ½é¡¹ç›®ä¸­ï¼Œç”¨äºæ ‡æ³¨å„ç§ç±»å‹çš„æ•°æ®ï¼Œå¦‚æ–‡æœ¬ã€å›¾åƒã€éŸ³é¢‘ã€è§†é¢‘ç­‰ã€‚å®ƒæ”¯æŒå¤šç§æ ‡æ³¨ä»»åŠ¡ï¼Œèƒ½å¤Ÿå¸®åŠ©ç”¨æˆ·å°†åŸå§‹æ•°æ®è½¬æ¢ä¸ºç»“æ„åŒ–çš„æ ‡ç­¾æ•°æ®ï¼Œä»¥ä¾¿è®­ç»ƒæœºå™¨å­¦ä¹ æ¨¡å‹</p></blockquote><h3 id="å®‰è£…ä½¿ç”¨">å®‰è£…ä½¿ç”¨</h3><ul><li>å®‰è£…</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pip install label-studio</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker</span></span><br><span class="line">docker run -p 8080:8080 -v /path/to/your/data:/mnt labelstudio/label-studio</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">label-studio start</span><br></pre></td></tr></table></figure><h3 id="API-è°ƒç”¨">API è°ƒç”¨</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> label_studio_sdk</span><br><span class="line"><span class="keyword">from</span> label_studio_sdk <span class="keyword">import</span> Client</span><br><span class="line"></span><br><span class="line">client = Client(url=<span class="string">&#x27;http://localhost:8080&#x27;</span>, api_key=<span class="string">&#x27;your_api_key&#x27;</span>)</span><br><span class="line">project = client.init_project(<span class="string">&#x27;Your Project Name&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="æ¨¡æ¿è‡ªå®šä¹‰">æ¨¡æ¿è‡ªå®šä¹‰</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">label</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Choice</span> <span class="attr">name</span>=<span class="string">&quot;Label&quot;</span> <span class="attr">toName</span>=<span class="string">&quot;text&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Choice</span> <span class="attr">value</span>=<span class="string">&quot;Positive&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Choice</span> <span class="attr">value</span>=<span class="string">&quot;Negative&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Choice</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Text</span> <span class="attr">name</span>=<span class="string">&quot;text&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$text&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Whisper-ä»‹ç»">Whisper ä»‹ç»</h2><blockquote><p>Whisper is an ASR model developed by OpenAI, trained on a large dataset of diverse audio. Whilst it does produces highly accurate transcriptions, the corresponding timestamps are at the utterance-level, not per word, and can be inaccurate by several seconds. OpenAIâ€™s whisper does not natively support batching.</p></blockquote><blockquote><p>Phoneme-Based ASR A suite of models finetuned to recognise the smallest unit of speech distinguishing one word from another, e.g. the element p in â€œtapâ€. A popular example model is wav2vec2.0.</p></blockquote><blockquote><p>Forced Alignment refers to the process by which orthographic transcriptions are aligned to audio recordings to automatically generate phone level segmentation.</p></blockquote><blockquote><p>Voice Activity Detection (VAD) is the detection of the presence or absence of human speech.</p></blockquote><blockquote><p>Speaker Diarization is the process of partitioning an audio stream containing human speech into homogeneous segments according to the identity of each speaker.</p></blockquote><h3 id="å®‰è£…ä½¿ç”¨-2">å®‰è£…ä½¿ç”¨</h3><ul><li>whisper</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pip install openai-whisper</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">or</span></span><br><span class="line">git clone https://github.com/openai/whisper.git</span><br><span class="line">cd whisper</span><br><span class="line">pip install .</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>pytorch</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pip install torch</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">or</span> </span><br><span class="line">pip install torch --no-index -f https://download.pytorch.org/whl/cpu/torch_stable.html</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>ffmpeg</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://ffmpeg.org/download.html</span></span><br><span class="line">sudo apt-get install ffmpeg</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</h3><ul><li>è¯­éŸ³è½¬æ–‡å­—</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> whisper</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½ Whisper æ¨¡å‹</span></span><br><span class="line">model = whisper.load_model(<span class="string">&quot;base&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯†åˆ«éŸ³é¢‘æ–‡ä»¶ä¸­çš„è¯­éŸ³</span></span><br><span class="line">result = model.transcribe(<span class="string">&quot;demo.wav&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºè¯†åˆ«ç»“æœ</span></span><br><span class="line"><span class="built_in">print</span>(result[<span class="string">&quot;text&quot;</span>])</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>éŸ³é¢‘åˆ‡å‰²</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _*_ coding: utf-8 _*_</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Time:     2024/12/17 16:09</span></span><br><span class="line"><span class="string">Author:   ZhaoQi Cao(czq)</span></span><br><span class="line"><span class="string">Version:  V 0.1</span></span><br><span class="line"><span class="string">File:     audio_seg.py</span></span><br><span class="line"><span class="string">Describe: Write during the python at zgxmt, Github link: https://github.com/caozhaoqi</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> whisper</span><br><span class="line"><span class="keyword">from</span> pydub <span class="keyword">import</span> AudioSegment</span><br><span class="line"><span class="keyword">import</span> webrtcvad</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ– Whisper æ¨¡å‹</span></span><br><span class="line">whisper_model = whisper.load_model(<span class="string">&quot;base&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># VAD éŸ³é¢‘æ´»åŠ¨æ£€æµ‹å™¨</span></span><br><span class="line">vad = webrtcvad.Vad(<span class="number">3</span>)  <span class="comment"># è®¾ç½®ä¸º 3 è¡¨ç¤ºä¸¥æ ¼çš„è¯­éŸ³æ´»åŠ¨æ£€æµ‹</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">vad_collected_segments</span>(<span class="params">audio_path, sample_rate=<span class="number">16000</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; ç”¨ VAD æ£€æµ‹éŸ³é¢‘ä¸­çš„è¯­éŸ³æ´»åŠ¨æ®µ &quot;&quot;&quot;</span></span><br><span class="line">    audio = AudioSegment.from_file(audio_path)</span><br><span class="line">    audio = audio.set_frame_rate(sample_rate)  <span class="comment"># è®¾ç½®ä¸º 16kHz é‡‡æ ·ç‡</span></span><br><span class="line">    raw_audio = audio.raw_data</span><br><span class="line">    frames = <span class="built_in">len</span>(raw_audio) // <span class="number">2</span>  <span class="comment"># 16ä½é‡‡æ ·</span></span><br><span class="line">    segments = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä½¿ç”¨ VAD åˆ‡å‰²éŸ³é¢‘</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, frames, sample_rate // <span class="number">50</span>):  <span class="comment"># 50msä¸ºæ­¥é•¿</span></span><br><span class="line">        frame = raw_audio[i:i + sample_rate // <span class="number">50</span>]</span><br><span class="line">        <span class="keyword">if</span> vad.is_speech(frame, sample_rate):</span><br><span class="line">            segments.append((i, i + sample_rate // <span class="number">50</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> segments, audio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">transcribe_audio</span>(<span class="params">audio_file</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; ä½¿ç”¨ Whisper æ¨¡å‹è¿›è¡Œè¯­éŸ³è½¬å½• &quot;&quot;&quot;</span></span><br><span class="line">    result = whisper_model.transcribe(audio_file)</span><br><span class="line">    <span class="keyword">return</span> result[<span class="string">&#x27;text&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cut_audio_by_vad</span>(<span class="params">audio_file, segments, output_folder</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; æ ¹æ® VAD æ£€æµ‹çš„éŸ³é¢‘ç‰‡æ®µåˆ‡å‰²éŸ³é¢‘ &quot;&quot;&quot;</span></span><br><span class="line">    audio = AudioSegment.from_file(audio_file)</span><br><span class="line">    segment_index = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> start, end <span class="keyword">in</span> segments:</span><br><span class="line">        segment_audio = audio[start:end]</span><br><span class="line">        segment_audio.export(<span class="string">f&quot;<span class="subst">&#123;output_folder&#125;</span>/segment_<span class="subst">&#123;segment_index&#125;</span>.wav&quot;</span>, <span class="built_in">format</span>=<span class="string">&quot;wav&quot;</span>)</span><br><span class="line">        segment_index += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_audio</span>(<span class="params">audio_file, output_folder</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; å¤„ç†éŸ³é¢‘æ–‡ä»¶ï¼Œè¿›è¡Œè¯­éŸ³è½¬å½•å’ŒæŒ‰å¥åˆ‡å‰² &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 1. ä½¿ç”¨ Whisper è½¬å½•éŸ³é¢‘</span></span><br><span class="line">    transcription = transcribe_audio(audio_file)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;è½¬å½•ç»“æœ: <span class="subst">&#123;transcription&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. ä½¿ç”¨ VAD æ£€æµ‹è¯­éŸ³æ´»åŠ¨åŒºåŸŸå¹¶åˆ‡å‰²éŸ³é¢‘</span></span><br><span class="line">    segments, audio = vad_collected_segments(audio_file)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. ä¿å­˜éŸ³é¢‘ç‰‡æ®µ</span></span><br><span class="line">    cut_audio_by_vad(audio_file, segments, output_folder)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;åˆ‡å‰²å®Œæˆï¼ŒéŸ³é¢‘ç‰‡æ®µä¿å­˜åœ¨ <span class="subst">&#123;output_folder&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># è°ƒç”¨å‡½æ•°ï¼Œä¼ å…¥éŸ³é¢‘æ–‡ä»¶è·¯å¾„å’Œä¿å­˜åˆ‡å‰²éŸ³é¢‘ç‰‡æ®µçš„æ–‡ä»¶å¤¹è·¯å¾„</span></span><br><span class="line">process_audio(<span class="string">r&quot;C:\Users\DELL\Desktop\audio_mark\1\1-è‹±æ–‡å¯¹è¯\1-è‹±æ–‡å¯¹è¯\12æœˆ17æ—¥.WAV&quot;</span>, <span class="string">&quot;./output_segments&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>å‘½ä»¤è¡Œ</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">whisper demo.wav --model base</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">or</span></span><br><span class="line">whisper demo.wav --model base --output_dir ./transcripts</span><br></pre></td></tr></table></figure><h2 id="ç»“åˆä½¿ç”¨">ç»“åˆä½¿ç”¨</h2><blockquote><p>whisper è½¬å†™è¯­éŸ³åå¼•å…¥label studio è¿›è¡Œæ ‡æ³¨</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _*_ coding: utf-8 _*_</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Time:     2024/12/17 10:49</span></span><br><span class="line"><span class="string">Author:   ZhaoQi Cao(czq)</span></span><br><span class="line"><span class="string">Version:  V 0.1</span></span><br><span class="line"><span class="string">File:     label_studio_whisper.py</span></span><br><span class="line"><span class="string">Describe: Write during the python at zgxmt, Github link: https://github.com/caozhaoqi</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> whisper</span><br><span class="line"><span class="keyword">from</span> speechbrain.pretrained <span class="keyword">import</span> SpeakerRecognition</span><br><span class="line"><span class="keyword">from</span> label_studio_sdk <span class="keyword">import</span> Client</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ– Whisper æ¨¡å‹</span></span><br><span class="line">whisper_model = whisper.load_model(<span class="string">&quot;base&quot;</span>)  <span class="comment"># ä½ å¯ä»¥é€‰æ‹©ä¸åŒå¤§å°çš„æ¨¡å‹ï¼Œå¦‚ &#x27;small&#x27;, &#x27;medium&#x27;, &#x27;large&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ– Speechbrain çš„è¯´è¯äººè¯†åˆ«æ¨¡å‹</span></span><br><span class="line">speaker_model = SpeakerRecognition.from_hparams(source=<span class="string">&quot;speechbrain/embedding-model-libri&quot;</span>, savedir=<span class="string">&quot;tmpdir&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">transcribe_audio</span>(<span class="params">audio_file</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; ä½¿ç”¨ Whisper å¯¹éŸ³é¢‘æ–‡ä»¶è¿›è¡Œè½¬å†™ &quot;&quot;&quot;</span></span><br><span class="line">    result = whisper_model.transcribe(audio_file)</span><br><span class="line">    <span class="keyword">return</span> result[<span class="string">&#x27;text&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">speaker_diarization</span>(<span class="params">audio_file</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; ä½¿ç”¨ Speechbrain å¯¹éŸ³é¢‘è¿›è¡Œè¯´è¯äººåˆ†ç¦» &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># è·å–éŸ³é¢‘çš„è¯´è¯äººåµŒå…¥</span></span><br><span class="line">    signal, fs = speaker_model.load_audio(audio_file)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å–è¯´è¯äººåˆ†ç¦»ç»“æœ</span></span><br><span class="line">    diarization = speaker_model.diarize(signal)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> diarization</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_audio_task</span>(<span class="params">task_data</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; å¤„ç†ä¼ å…¥çš„ Label Studio ä»»åŠ¡æ•°æ® &quot;&quot;&quot;</span></span><br><span class="line">    audio_file = task_data[<span class="string">&#x27;audio_file&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. ä½¿ç”¨ Whisper è¿›è¡Œè¯­éŸ³è½¬å†™</span></span><br><span class="line">    transcription = transcribe_audio(audio_file)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. ä½¿ç”¨ Speechbrain è¿›è¡Œè¯´è¯äººåˆ†ç¦»</span></span><br><span class="line">    diarization = speaker_diarization(audio_file)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¿”å›è½¬å†™æ–‡æœ¬å’Œè¯´è¯äººåˆ†ç¦»ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;transcription&#x27;</span>: transcription,</span><br><span class="line">        <span class="string">&#x27;diarization&#x27;</span>: diarization</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿è¡Œ Label Studio API æœåŠ¡</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    zq_api = <span class="string">&quot;93e8ebc81cc1337c41567aa20113fd74934a4f17&quot;</span></span><br><span class="line">    client = Client(url=<span class="string">&#x27;http://localhost:8080&#x27;</span>, api_key=zq_api)  <span class="comment"># è·å–ä½ çš„ Label Studio API key</span></span><br><span class="line">    project = client.get_project(project_id=<span class="number">1</span>)  <span class="comment"># å‡è®¾ä½ å·²åˆ›å»ºé¡¹ç›®å¹¶è®¾ç½®äº†ID</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å–å¾…æ ‡æ³¨ä»»åŠ¡</span></span><br><span class="line">    tasks = project.get_tasks()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¤„ç†æ¯ä¸ªä»»åŠ¡çš„éŸ³é¢‘æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">for</span> task <span class="keyword">in</span> tasks:</span><br><span class="line">        task_data = task.data</span><br><span class="line">        result = process_audio_task(task_data)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># åœ¨ Label Studio ä¸­æäº¤è½¬å†™å’Œè¯´è¯äººåˆ†ç¦»ç»“æœ</span></span><br><span class="line">        project.create_prediction(task.<span class="built_in">id</span>, result)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="pypinyin-éŸ³ç´ åºåˆ—è¾“å‡º">pypinyin éŸ³ç´ åºåˆ—è¾“å‡º</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> g2p_en <span class="keyword">import</span> G2p</span><br><span class="line"><span class="keyword">from</span> pypinyin <span class="keyword">import</span> pinyin, Style</span><br><span class="line"><span class="keyword">from</span> langdetect <span class="keyword">import</span> detect</span><br><span class="line"><span class="keyword">import</span> nltk</span><br><span class="line">nltk.download(<span class="string">&#x27;averaged_perceptron_tagger&#x27;</span>)</span><br><span class="line">nltk.download(<span class="string">&#x27;averaged_perceptron_tagger_eng&#x27;</span>)</span><br><span class="line">nltk.download(<span class="string">&#x27;punkt&#x27;</span>)  <span class="comment"># å¦‚æœè¿˜æœ‰ç¼ºå°‘çš„æ ‡ç‚¹ç¬¦å·èµ„æºï¼Œå¯ä»¥ä¸€å¹¶ä¸‹è½½</span></span><br><span class="line"><span class="comment"># C:\Users\DELL\AppData\Roaming\nltk_data</span></span><br><span class="line">nltk_data_path = <span class="string">r&#x27;C:\Users\DELL\AppData\Roaming\nltk_data&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœç›®å½•ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºè¯¥ç›®å½•</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(nltk_data_path):</span><br><span class="line">    os.makedirs(nltk_data_path)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½® NLTK æ•°æ®çš„æœç´¢è·¯å¾„</span></span><br><span class="line">nltk.data.path.append(nltk_data_path)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º G2P å¯¹è±¡ï¼ˆç”¨äºè‹±æ–‡ï¼‰</span></span><br><span class="line">g2p = G2p()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_phonemes</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="comment"># è‡ªåŠ¨æ£€æµ‹æ–‡æœ¬è¯­è¨€</span></span><br><span class="line">    language = detect(text)</span><br><span class="line"></span><br><span class="line">    phonemes = []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¤„ç†æ··åˆè¯­è¨€çš„æ–‡æœ¬ï¼ŒæŒ‰å­—ç¬¦å¤„ç†è¯­è¨€</span></span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> text:</span><br><span class="line">        <span class="keyword">if</span> re.<span class="keyword">match</span>(<span class="string">r&#x27;[\u4e00-\u9fa5]&#x27;</span>, char):  <span class="comment"># åˆ¤æ–­å­—ç¬¦æ˜¯å¦ä¸ºä¸­æ–‡</span></span><br><span class="line">            <span class="comment"># ä¸­æ–‡å­—ç¬¦å¤„ç†</span></span><br><span class="line">            pinyin_output = pinyin(char, style=Style.TONE3)</span><br><span class="line">            phonemes.append(pinyin_output[<span class="number">0</span>][<span class="number">0</span>].replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&#x27;</span>))  <span class="comment"># å»é™¤ç©ºæ ¼</span></span><br><span class="line">        <span class="keyword">elif</span> re.<span class="keyword">match</span>(<span class="string">r&#x27;[a-zA-Z]&#x27;</span>, char):  <span class="comment"># åˆ¤æ–­å­—ç¬¦æ˜¯å¦ä¸ºè‹±æ–‡</span></span><br><span class="line">            <span class="comment"># è‹±æ–‡å­—ç¬¦å¤„ç†</span></span><br><span class="line">            phonemes.extend(g2p(char))  <span class="comment"># ä½¿ç”¨ G2P å¯¹è±¡å¤„ç†è‹±æ–‡éŸ³ç´ </span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># å¯¹äºéä¸­æ–‡å’Œéè‹±æ–‡å­—ç¬¦ï¼ˆå¦‚æ ‡ç‚¹ç¬¦å·ï¼‰ï¼Œç›´æ¥ä¿ç•™</span></span><br><span class="line">            phonemes.append(char)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> phonemes</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•ä¸­è‹±æ–‡æ··åˆæ–‡æœ¬</span></span><br><span class="line">text_mixed = <span class="string">&quot;ä½ è¯´ä»€ä¹ˆï¼Ÿ Wash water off. Why is she inside my own boots? ä»–æ²¡æœ‰é›¨é‹å¾—ç»™ä»–ä¹°ä¸€åŒã€‚&quot;</span></span><br><span class="line">phonemes_mixed = get_phonemes(text_mixed)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Mixed language phonemes: <span class="subst">&#123;phonemes_mixed&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•è‹±æ–‡æ–‡æœ¬</span></span><br><span class="line">text_en = <span class="string">&quot;If we use it like. umm&quot;</span></span><br><span class="line">phonemes_en = get_phonemes(text_en)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;English phonemes: <span class="subst">&#123;phonemes_en&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•ä¸­æ–‡æ–‡æœ¬ï¼ˆç®€ä½“ï¼‰</span></span><br><span class="line">text_zh = <span class="string">&quot;ä½ è¯´ä»€ä¹ˆï¼Ÿ&quot;</span></span><br><span class="line">phonemes_zh = get_phonemes(text_zh)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Chinese phonemes: <span class="subst">&#123;phonemes_zh&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•è·å…°è¯­æ–‡æœ¬</span></span><br><span class="line">text_nl = <span class="string">&quot;Hallo wereld&quot;</span></span><br><span class="line">phonemes_nl = get_phonemes(text_nl)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Dutch phonemes: <span class="subst">&#123;phonemes_nl&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•ç®€ä½“ä¸­æ–‡ (zh-cn)</span></span><br><span class="line">text_zh_cn = <span class="string">&quot;ä»–ç®¡ä½ å«è€å§‘çˆ¶ã€‚å“ˆå“ˆå“ˆå“ˆå“ˆ  å˜¿ å“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆ&quot;</span></span><br><span class="line">phonemes_zh_cn = get_phonemes(text_zh_cn)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Chinese (Simplified) phonemes: <span class="subst">&#123;phonemes_zh_cn&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•ç¹ä½“ä¸­æ–‡ (zh-tw)</span></span><br><span class="line">text_zh_tw = <span class="string">&quot;ä½ å¥½ï¼Œä¸–ç•Œ&quot;</span></span><br><span class="line">phonemes_zh_tw = get_phonemes(text_zh_tw)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Chinese (Traditional) phonemes: <span class="subst">&#123;phonemes_zh_tw&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="See">See</h2><ul><li><ol><li><a href="https://github.com/m-bain/whisperX">https://github.com/m-bain/whisperX</a></li></ol></li><li><ol start="2"><li><a href="https://ffmpeg.org/download.html">https://ffmpeg.org/download.html</a></li></ol></li><li><ol start="3"><li><a href="https://labelstud.io/">https://labelstud.io/</a></li></ol></li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CentOS ç³»ç»Ÿä¸Šå®‰è£… Docker</title>
      <link href="/2024/12/15/centos-docker-install/"/>
      <url>/2024/12/15/centos-docker-install/</url>
      
        <content type="html"><![CDATA[<h1>CentOS ç³»ç»Ÿä¸Šå®‰è£… Docker</h1><p><strong>å‰ææ¡ä»¶ï¼š</strong></p><ul><li><strong>CentOS ç³»ç»Ÿï¼š</strong> ç¡®ä¿ä½ ä½¿ç”¨çš„æ˜¯ CentOS 7 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚</li><li><strong>å…·æœ‰ sudo æƒé™çš„ç”¨æˆ·ï¼š</strong> ä½ éœ€è¦ä¸€ä¸ªå…·æœ‰ sudo æƒé™çš„ç”¨æˆ·æ¥æ‰§è¡Œè¿™äº›å‘½ä»¤ã€‚</li><li><strong>ç½‘ç»œè¿æ¥ï¼š</strong> ä½ çš„ CentOS ç³»ç»Ÿéœ€è¦è¿æ¥åˆ°äº’è”ç½‘æ‰èƒ½ä¸‹è½½è½¯ä»¶åŒ…ã€‚</li></ul><p><strong>æ­¥éª¤ 1ï¼šæ›´æ–°ç³»ç»Ÿè½¯ä»¶åŒ…</strong></p><p>é¦–å…ˆï¼Œæ›´æ–°ä½ çš„ CentOS ç³»ç»Ÿè½¯ä»¶åŒ…åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œä»¥ç¡®ä¿ä¸€åˆ‡é¡ºåˆ©ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> yum update -y</span><br></pre></td></tr></table></figure><p><strong>æ­¥éª¤ 2ï¼šå®‰è£…ä¾èµ–è½¯ä»¶åŒ…</strong></p><p>å®‰è£… Docker éœ€è¦ä¸€äº›ä¾èµ–è½¯ä»¶åŒ…ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£…å®ƒä»¬ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> yum install -y yum-utils device-mapper-persistent-data lvm2</span><br></pre></td></tr></table></figure><p><strong>æ­¥éª¤ 3ï¼šæ·»åŠ  Docker å®˜æ–¹è½¯ä»¶ä»“åº“</strong></p><p>ä¸ºäº†å®‰è£… Dockerï¼Œä½ éœ€è¦æ·»åŠ  Docker å®˜æ–¹è½¯ä»¶ä»“åº“ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å›½å¤–</span></span><br><span class="line"><span class="built_in">sudo</span> yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"><span class="comment">#å›½å†…</span></span><br><span class="line"><span class="built_in">sudo</span> yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"><span class="comment">#ä½¿ç”¨ä»£ç†</span></span><br><span class="line"><span class="built_in">export</span> http_proxy=<span class="string">&quot;http://your_proxy_address:port&quot;</span></span><br><span class="line"><span class="built_in">export</span> https_proxy=<span class="string">&quot;https://your_proxy_address:port&quot;</span></span><br><span class="line"><span class="built_in">sudo</span> yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><p><strong>æ­¥éª¤ 4ï¼šå®‰è£… Docker Engine</strong></p><p>ç°åœ¨å¯ä»¥å®‰è£… Docker Engine äº†ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> yum install -y docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure><p>å¦‚æœæƒ³è¦å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ Dockerï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å¯ç”¨ç‰ˆæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum list docker-ce --showduplicates | <span class="built_in">sort</span> -r</span><br></pre></td></tr></table></figure><p>ç„¶åä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…æŒ‡å®šç‰ˆæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> yum install -y docker-ce-&lt;VERSION_STRING&gt; docker-ce-cli-&lt;VERSION_STRING&gt; containerd.io</span><br></pre></td></tr></table></figure><p><strong>æ­¥éª¤ 5ï¼šå¯åŠ¨ Docker æœåŠ¡</strong></p><p>å®‰è£…å®Œæˆåï¼Œå¯åŠ¨ Docker æœåŠ¡å¹¶è®¾ç½®å¼€æœºè‡ªå¯åŠ¨ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl start docker</span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> docker</span><br></pre></td></tr></table></figure><p><strong>æ­¥éª¤ 6ï¼šéªŒè¯ Docker å®‰è£…</strong></p><p>æ£€æŸ¥ Docker æ˜¯å¦æˆåŠŸå®‰è£…ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ Docker ç‰ˆæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker version</span><br></pre></td></tr></table></figure><p>æˆ–è€…è¿è¡Œä¸€ä¸ªç®€å•çš„ Docker å®¹å™¨ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run hello-world</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œä½ åº”è¯¥ä¼šçœ‹åˆ° â€œHello from Docker!â€ çš„è¾“å‡ºã€‚</p><p><strong>æ­¥éª¤ 7ï¼šå®‰è£… Docker Compose (å¯é€‰ï¼Œä½†æ¨è)</strong></p><p>Docker Compose æ˜¯ä¸€ä¸ªç”¨äºå®šä¹‰å’Œè¿è¡Œå¤šå®¹å™¨ Docker åº”ç”¨ç¨‹åºçš„å·¥å…·ã€‚ å¦‚æœä½ éœ€è¦ä½¿ç”¨ Docker Composeï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤å®‰è£…ï¼š</p><p><strong>ä¸‹è½½ Docker Compose äºŒè¿›åˆ¶æ–‡ä»¶:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> curl -L <span class="string">&quot;https://github.com/docker/compose/releases/download/v2.24.1/docker-compose-<span class="subst">$(uname -s)</span>-<span class="subst">$(uname -m)</span>&quot;</span> -o /usr/local/bin</span><br></pre></td></tr></table></figure><h2 id="é—®é¢˜è§£å†³">é—®é¢˜è§£å†³</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Unable to find image &#x27;nginx:latest&#x27; locally</span><br><span class="line">docker: Error response from daemon: Get &quot;https://registry-1.docker.io/v2/&quot;: dial tcp: lookup registry-1.docker.io on 100.127.194.200:53: server misbehaving.</span><br><span class="line">See &#x27;docker run --help&#x27;.</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;:</span><br><span class="line">    [</span><br><span class="line">      &quot;https://docker.m.daocloud.io/&quot;,</span><br><span class="line">      &quot;https://huecker.io/&quot;,</span><br><span class="line">      &quot;https://dockerhub.timeweb.cloud&quot;,</span><br><span class="line">      &quot;https://noohub.ru/&quot;,</span><br><span class="line">      &quot;https://dockerproxy.com&quot;,</span><br><span class="line">      &quot;https://docker.mirrors.ustc.edu.cn&quot;,</span><br><span class="line">      &quot;https://docker.nju.edu.cn&quot;,</span><br><span class="line">      &quot;https://xx4bwyg2.mirror.aliyuncs.com&quot;,</span><br><span class="line">      &quot;http://f1361db2.m.daocloud.io&quot;,</span><br><span class="line">      &quot;https://registry.docker-cn.com&quot;,</span><br><span class="line">      &quot;http://hub-mirror.c.163.com&quot;,</span><br><span class="line">      &quot;https://docker.mirrors.ustc.edu.cn&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäºEasyocrçš„æ–‡å­—è¯†åˆ«</title>
      <link href="/2024/12/15/easy-ocr-gpu/"/>
      <url>/2024/12/15/easy-ocr-gpu/</url>
      
        <content type="html"><![CDATA[<h1>åŸºäºEasyocrçš„æ–‡å­—è¯†åˆ«</h1><blockquote><p>EasyOCR æ˜¯ä¸€ä¸ªå¼€æºçš„ OCR (å…‰å­¦å­—ç¬¦è¯†åˆ«) å·¥å…·ï¼Œèƒ½å¤Ÿå¿«é€Ÿå¹¶é«˜æ•ˆåœ°ä»å›¾åƒä¸­æå–æ–‡æœ¬ã€‚ä¸å…¶ä»–OCRå·¥å…·å¦‚ Tesseract ç›¸æ¯”ï¼ŒEasyOCR å…·æœ‰æ›´å¼ºçš„å¤šè¯­è¨€æ”¯æŒï¼ŒåŒ…æ‹¬å¯¹ä¸­æ–‡ã€æ—¥è¯­ã€é˜¿æ‹‰ä¼¯è¯­ç­‰å¤æ‚æ–‡å­—çš„æ”¯æŒï¼Œå¹¶ä¸”å®ƒçš„å®‰è£…å’Œä½¿ç”¨éå¸¸ç®€ä¾¿ã€‚</p></blockquote><h2 id="ä¸»è¦åŠŸèƒ½">ä¸»è¦åŠŸèƒ½</h2><blockquote><p>EasyOCR æ˜¯ä¸€ä¸ª Python åŒ…ï¼Œç”¨äºæ‰§è¡Œå…‰å­¦å­—ç¬¦è¯†åˆ« (OCR)ã€‚å®ƒæ—¨åœ¨æ˜“äºä½¿ç”¨ï¼Œå¹¶æ”¯æŒå¤šç§è¯­è¨€çš„æ–‡æœ¬è¯†åˆ«ã€‚å…¶ä¸»è¦ç‰¹ç‚¹åŒ…æ‹¬ï¼š</p></blockquote><ul><li><p>ç®€å•æ˜“ç”¨</p></li><li><p>å¤šè¯­è¨€æ”¯æŒ</p></li><li><p>GPU åŠ é€Ÿæ”¯æŒ</p></li><li><p>å¼€æº</p></li></ul><h2 id="å®‰è£…-EasyOCR">å®‰è£… EasyOCR:</h2><blockquote><p>å¯ä»¥ä½¿ç”¨ pip å®‰è£…ï¼š</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install easyocr</span><br></pre></td></tr></table></figure><blockquote><p>ä½¿ç”¨ GPU åŠ é€Ÿï¼Œå®‰è£… PyTorch çš„ GPU ç‰ˆæœ¬</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="å¯¼å…¥-EasyOCR">å¯¼å…¥ EasyOCR:</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> easyocr</span><br></pre></td></tr></table></figure><h3 id="åˆ›å»º-OCR-è¯»å–å™¨-Reader">åˆ›å»º OCR è¯»å–å™¨ (Reader):</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reader = easyocr.Reader([<span class="string">&#x27;ch_sim&#x27;</span>, <span class="string">&#x27;en&#x27;</span>])  <span class="comment"># ch_sim è¡¨ç¤ºç®€ä½“ä¸­æ–‡ï¼Œen è¡¨ç¤ºè‹±æ–‡</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>ä½¿ç”¨ GPUåŠ é€Ÿï¼Œéœ€è¦æŒ‡å®š gpu=Trueï¼š</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reader = easyocr.Reader([<span class="string">&#x27;ch_sim&#x27;</span>, <span class="string">&#x27;en&#x27;</span>], gpu=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h3 id="demo">demo</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># readtext() æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªåŒ…å«è¯†åˆ«ç»“æœçš„åˆ—è¡¨ï¼Œåˆ—è¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªåŒ…å«æ–‡æœ¬æ¡†ä½ç½®åæ ‡å’Œè¯†åˆ«æ–‡æœ¬çš„å…ƒç»„ã€‚</span></span><br><span class="line"></span><br><span class="line">result = reader.readtext(<span class="string">&#x27;image.jpg&#x27;</span>)  <span class="comment"># image.jpg æ˜¯ä½ è¦è¯†åˆ«çš„å›¾åƒæ–‡ä»¶è·¯å¾„</span></span><br></pre></td></tr></table></figure><ul><li>å¤„ç†è¯†åˆ«ç»“æœ:</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">for</span> (bbox, text, prob) <span class="keyword">in</span> result:</span><br><span class="line">  (tl, tr, br, bl) = bbox  <span class="comment"># æ–‡æœ¬æ¡†çš„å·¦ä¸Šè§’ã€å³ä¸Šè§’ã€å³ä¸‹è§’ã€å·¦ä¸‹è§’çš„åæ ‡</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">f&quot;æ–‡æœ¬: <span class="subst">&#123;text&#125;</span>, ç½®ä¿¡åº¦: <span class="subst">&#123;prob&#125;</span>&quot;</span>)</span><br><span class="line">  <span class="comment"># åœ¨è¿™é‡Œå¯ä»¥æ ¹æ®åæ ‡å°†æ–‡æœ¬æ¡†ç»˜åˆ¶åˆ°å›¾åƒä¸Šï¼Œæˆ–è€…è¿›è¡Œå…¶ä»–å¤„ç†</span></span><br></pre></td></tr></table></figure><h3 id="åŸºç¡€åŠŸèƒ½æµ‹è¯•">åŸºç¡€åŠŸèƒ½æµ‹è¯•</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> easyocr</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º OCR Reader, ä½¿ç”¨ç®€ä½“ä¸­æ–‡å’Œè‹±æ–‡æ¨¡å‹ï¼Œå¹¶å¯ç”¨ GPU åŠ é€Ÿ</span></span><br><span class="line">reader = easyocr.Reader([<span class="string">&#x27;ch_sim&#x27;</span>, <span class="string">&#x27;en&#x27;</span>], gpu=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å–å›¾åƒ</span></span><br><span class="line">image_path = <span class="string">&#x27;test.png&#x27;</span>  <span class="comment"># æ›¿æ¢ä¸ºä½ çš„å›¾åƒæ–‡ä»¶è·¯å¾„</span></span><br><span class="line">image = cv2.imread(image_path)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œ OCR</span></span><br><span class="line">result = reader.readtext(image)</span><br><span class="line"></span><br><span class="line"><span class="comment"># éå†ç»“æœå¹¶æ‰“å°</span></span><br><span class="line"><span class="keyword">for</span> (bbox, text, prob) <span class="keyword">in</span> result:</span><br><span class="line">    (tl, tr, br, bl) = bbox</span><br><span class="line">    tl = (<span class="built_in">int</span>(tl[<span class="number">0</span>]), <span class="built_in">int</span>(tl[<span class="number">1</span>]))</span><br><span class="line">    tr = (<span class="built_in">int</span>(tr[<span class="number">0</span>]), <span class="built_in">int</span>(tr[<span class="number">1</span>]))</span><br><span class="line">    br = (<span class="built_in">int</span>(br[<span class="number">0</span>]), <span class="built_in">int</span>(br[<span class="number">0</span>]))</span><br><span class="line">    bl = (<span class="built_in">int</span>(bl[<span class="number">0</span>]), <span class="built_in">int</span>(bl[<span class="number">1</span>]))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;æ–‡æœ¬: <span class="subst">&#123;text&#125;</span>, ç½®ä¿¡åº¦: <span class="subst">&#123;prob&#125;</span>&quot;</span>)</span><br><span class="line">    cv2.rectangle(image, tl, br, (<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>), <span class="number">2</span>)</span><br><span class="line">    cv2.putText(image, text, tl, cv2.FONT_HERSHEY_SIMPLEX, <span class="number">0.8</span>, (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ˜¾ç¤ºå¸¦æœ‰æ–‡æœ¬æ¡†çš„å›¾åƒ</span></span><br><span class="line">cv2.imshow(<span class="string">&#x27;OCR Result&#x27;</span>, image)</span><br><span class="line">cv2.waitKey(<span class="number">0</span>)</span><br><span class="line">cv2.destroyAllWindows()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="one-more-thing">one more thing</h2><h3 id="ä¸€äº›å…¶ä»–ç”¨æ³•">ä¸€äº›å…¶ä»–ç”¨æ³•:</h3><ul><li><p>è¯†åˆ«ç‰¹å®šåŒºåŸŸ: å¯ä»¥ä½¿ç”¨ detect() æ–¹æ³•é¢„å…ˆæ£€æµ‹æ–‡æœ¬åŒºåŸŸï¼Œç„¶åä¼ é€’ç»™ readtext() æ–¹æ³•ã€‚</p></li><li><p>è‡ªå®šä¹‰æ¨¡å‹: å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰æ¨¡å‹ï¼Œå¹¶æŒ‡å®šè·¯å¾„ã€‚</p></li><li><p>æ‰¹å¤„ç†: å¯ä»¥å¤„ç†å¤šå¼ å›¾åƒã€‚</p></li><li><p>æ–‡æœ¬æ–¹å‘: EasyOCR ä¼šè‡ªåŠ¨æ£€æµ‹æ–‡æœ¬æ–¹å‘ï¼Œä½†ä¹Ÿå¯ä»¥æ‰‹åŠ¨æŒ‡å®šã€‚</p></li></ul><h4 id="ä½¿ç”¨åœºæ™¯">ä½¿ç”¨åœºæ™¯:</h4><ul><li><p>æ–‡æ¡£æ•°å­—åŒ–: å°†æ‰«æçš„çº¸è´¨æ–‡æ¡£è½¬åŒ–ä¸ºå¯ç¼–è¾‘çš„æ–‡æœ¬ã€‚</p></li><li><p>å›¾åƒä¿¡æ¯æå–: ä»å›¾åƒä¸­æå–å…³é”®æ–‡æœ¬ä¿¡æ¯ï¼Œä¾‹å¦‚è½¦ç‰Œå·ã€éªŒè¯ç ç­‰ã€‚</p></li><li><p>è‡ªåŠ¨åŒ–æ•°æ®è¾“å…¥: è‡ªåŠ¨åŒ–ä»å›¾åƒä¸­æå–æ–‡æœ¬å¹¶è¾“å…¥åˆ°ç³»ç»Ÿã€‚</p></li><li><p>å¤šè¯­è¨€åº”ç”¨: æ”¯æŒå¤šè¯­è¨€è¯†åˆ«ï¼Œæ–¹ä¾¿å›½é™…åŒ–åº”ç”¨å¼€å‘ã€‚</p></li></ul><h2 id="æ€»ç»“">æ€»ç»“:</h2><p>EasyOCR æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ä¸”æ˜“äºä½¿ç”¨çš„ OCR åº“ï¼Œå¯ä»¥å¸®åŠ©ä½ åœ¨ Python åº”ç”¨ä¸­å¿«é€Ÿå®ç°æ–‡æœ¬è¯†åˆ«åŠŸèƒ½ã€‚åªéœ€è¦å‡ è¡Œä»£ç ï¼Œä½ å°±å¯ä»¥ä»å›¾åƒä¸­æå–å‡ºæ–‡æœ¬ã€‚å¸Œæœ›è¿™ä¸ªä»‹ç»å’Œç¤ºä¾‹èƒ½å¸®åŠ©ä½ å¿«é€Ÿä¸Šæ‰‹ EasyOCR! è®°å¾—æ ¹æ®ä½ çš„å…·ä½“éœ€æ±‚è°ƒæ•´ä»£ç ã€‚</p><h2 id="å®é™…æ¡ˆä¾‹">å®é™…æ¡ˆä¾‹</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> decimal <span class="keyword">import</span> Decimal</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> easyocr</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> pypinyin <span class="keyword">import</span> pinyin, Style</span><br><span class="line"></span><br><span class="line">lan_code = [<span class="string">&#x27;ru&#x27;</span>, <span class="string">&#x27;ind&#x27;</span>, <span class="string">&#x27;tur&#x27;</span>, <span class="string">&#x27;deu&#x27;</span>, <span class="string">&#x27;ita&#x27;</span>, <span class="string">&#x27;jpn&#x27;</span>, <span class="string">&#x27;fra&#x27;</span>, <span class="string">&#x27;tha&#x27;</span>, <span class="string">&#x27;por&#x27;</span>, <span class="string">&#x27;spa&#x27;</span>, <span class="string">&#x27;vie&#x27;</span>, <span class="string">&#x27;ara&#x27;</span>, <span class="string">&#x27;kor&#x27;</span>, <span class="string">&#x27;msa&#x27;</span>]</span><br><span class="line">language_map = &#123;</span><br><span class="line">    <span class="string">&#x27;ä¿„è¯­&#x27;</span>: <span class="string">&#x27;ru&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;å°å°¼&#x27;</span>: <span class="string">&#x27;ind&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;åœŸè€³å…¶&#x27;</span>: <span class="string">&#x27;tur&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;å¾·è¯­&#x27;</span>: <span class="string">&#x27;deu&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;æ„å¤§åˆ©è¯­&#x27;</span>: <span class="string">&#x27;ita&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;æ—¥è¯­&#x27;</span>: <span class="string">&#x27;jpn&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;æ³•è¯­&#x27;</span>: <span class="string">&#x27;fra&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;æ³°è¯­&#x27;</span>: <span class="string">&#x27;tha&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;è‘¡è„ç‰™&#x27;</span>: <span class="string">&#x27;por&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;è¥¿ç­ç‰™è¯­&#x27;</span>: <span class="string">&#x27;spa&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;è¶Šå—è¯­&#x27;</span>: <span class="string">&#x27;vie&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;é˜¿æ‹‰ä¼¯è¯­&#x27;</span>: <span class="string">&#x27;ara&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;éŸ©è¯­&#x27;</span>: <span class="string">&#x27;kor&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;é©¬æ¥è¯­&#x27;</span>: <span class="string">&#x27;msa&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ– EasyOCR é˜…è¯»å™¨</span></span><br><span class="line"><span class="comment"># reader = easyocr.Reader([&#x27;en&#x27;, &#x27;ch_sim&#x27;, &#x27;ru&#x27;, &#x27;ja&#x27;, &#x27;de&#x27;, &#x27;fr&#x27;, &#x27;es&#x27;, &#x27;it&#x27;, &#x27;pt&#x27;, &#x27;tr&#x27;, &#x27;ar&#x27;], gpu=True)  # æ”¯æŒå¤šè¯­è¨€</span></span><br><span class="line"></span><br><span class="line">reader = easyocr.Reader([<span class="string">&#x27;ru&#x27;</span>], gpu=<span class="literal">True</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">convert_to_pinyin</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    å°†ä¸­æ–‡å­—ç¬¦è½¬æ¢ä¸ºæ‹¼éŸ³ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    result = pinyin(text, style=Style.NORMAL)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join([item[<span class="number">0</span>] <span class="keyword">for</span> item <span class="keyword">in</span> result])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">clean_path</span>(<span class="params">path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    å°†ï¿½ï¿½ï¿½å¾„ä¸­çš„éæ³•å­—ç¬¦æ›¿æ¢ä¸ºæ‹¼éŸ³ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    illegal_chars = <span class="string">r&#x27;[\/:*?&quot;&lt;&gt;|]&#x27;</span></span><br><span class="line">    path_parts = path.split(os.sep)</span><br><span class="line">    cleaned_parts = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> part <span class="keyword">in</span> path_parts:</span><br><span class="line">        part = convert_to_pinyin(part)  <span class="comment"># è½¬æ¢ä¸ºæ‹¼éŸ³</span></span><br><span class="line">        cleaned_parts.append(part)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> os.sep.join(cleaned_parts)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_language_code_in_directory</span>(<span class="params">directory_path, lan_codes</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æ£€æŸ¥æŒ‡å®šè·¯å¾„ä¸­æ˜¯å¦åŒ…å«è¯­è¨€ä»£ç åˆ—è¡¨ä¸­çš„ä»»ä½•ä¸€ä¸ªå†…å®¹ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    found_codes = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">for</span> lan_code <span class="keyword">in</span> lan_codes:</span><br><span class="line">            <span class="keyword">if</span> lan_code <span class="keyword">in</span> directory_path:</span><br><span class="line">                found_codes.append(lan_code)</span><br><span class="line">        <span class="keyword">return</span> found_codes</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;å‘ç”Ÿé”™è¯¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">numpy_encoder</span>(<span class="params">obj</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è‡ªå®šä¹‰ JSON åºåˆ—åŒ–å‡½æ•°ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj, np.ndarray):</span><br><span class="line">        <span class="keyword">return</span> obj.tolist()</span><br><span class="line">    <span class="keyword">raise</span> TypeError(<span class="string">f&quot;Type <span class="subst">&#123;<span class="built_in">type</span>(obj)&#125;</span> not serializable&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_text_with_coords</span>(<span class="params">image_path, folder, lan_code</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ä»å›¾åƒä¸­æå–æ–‡å­—åŠå…¶åæ ‡ï¼Œå¹¶è¿”å›æ ¼å¼åŒ–çš„ JSON æ•°æ®ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        lan_zh = check_language_code_in_directory(image_path, folder)</span><br><span class="line">        <span class="comment"># if not lan_zh:</span></span><br><span class="line">        <span class="comment">#     raise ValueError(f&quot;æœªåœ¨è·¯å¾„ä¸­æ‰¾åˆ°ä»»ä½•è¯­è¨€ä»£ç ï¼š&#123;image_path&#125;&quot;)</span></span><br><span class="line"></span><br><span class="line">        language_codes = <span class="string">&quot;ru&quot;</span></span><br><span class="line">        img = Image.<span class="built_in">open</span>(image_path)</span><br><span class="line">        img = cv2.cvtColor(np.array(img), cv2.COLOR_RGB2BGR)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> img <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="string">f&quot;æ— æ³•è¯»å–å›¾åƒ: <span class="subst">&#123;image_path&#125;</span>&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä½¿ç”¨ EasyOCR æå–æ–‡æœ¬å’Œåæ ‡</span></span><br><span class="line">        results = reader.readtext(image_path)</span><br><span class="line"></span><br><span class="line">        formatted_results = []</span><br><span class="line">        <span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">            <span class="comment"># result æ ¼å¼: [bbox, text, confidence]</span></span><br><span class="line">            bbox, text, _ = result</span><br><span class="line">            <span class="keyword">if</span> text.strip():</span><br><span class="line">                <span class="comment"># è·å–åæ ‡ï¼Œè½¬æ¢ä¸ºæµ®åŠ¨æ•°</span></span><br><span class="line">                x_min, y_min = bbox[<span class="number">0</span>]</span><br><span class="line">                x_max, y_max = bbox[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">                <span class="comment"># åˆ›å»ºæµ®åŠ¨æ•°åæ ‡æ•°ç»„ï¼Œä¿ç•™é«˜ç²¾åº¦</span></span><br><span class="line">                coords = np.array([</span><br><span class="line">                    [x_min, y_min],</span><br><span class="line">                    [x_max, y_min],</span><br><span class="line">                    [x_max, y_max],</span><br><span class="line">                    [x_min, y_max]</span><br><span class="line">                ], dtype=np.float64)  <span class="comment"># ä½¿ç”¨ float64 ä¿è¯é«˜ç²¾åº¦</span></span><br><span class="line"></span><br><span class="line">                result_dict = &#123;</span><br><span class="line">                    <span class="string">&quot;label&quot;</span>: text,</span><br><span class="line">                    <span class="string">&quot;points&quot;</span>: numpy_encoder(coords),  <span class="comment"># ä¿æŒé«˜ç²¾åº¦åæ ‡</span></span><br><span class="line">                    <span class="string">&quot;language&quot;</span>: lan_zh[<span class="number">0</span>],</span><br><span class="line">                    <span class="string">&quot;textType&quot;</span>: <span class="string">&quot;Mix&quot;</span> <span class="keyword">if</span> <span class="built_in">len</span>(text) &gt; <span class="number">1</span> <span class="keyword">else</span> <span class="string">&quot;Single&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;textDirection&quot;</span>: <span class="string">&quot;Horizontal_0&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;assign&quot;</span>: <span class="string">&quot;Normal&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;group_id&quot;</span>: <span class="literal">None</span>,</span><br><span class="line">                    <span class="string">&quot;shape_type&quot;</span>: <span class="string">&quot;polygon&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;flags&quot;</span>: &#123;&#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment"># å°†ç»“æœæ·»åŠ åˆ°åˆ—è¡¨</span></span><br><span class="line">                formatted_results.append(result_dict)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># ç»˜åˆ¶çŸ©å½¢æ¡†æ—¶ï¼Œä½¿ç”¨æ•´æ•°åæ ‡ï¼Œä¸æ”¹å˜ç²¾åº¦</span></span><br><span class="line">                cv2.rectangle(img, (<span class="built_in">int</span>(x_min), <span class="built_in">int</span>(y_min)), (<span class="built_in">int</span>(x_max), <span class="built_in">int</span>(y_max)), (<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>), <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ‹¼éŸ³è·¯å¾„</span></span><br><span class="line">        output_image_path = os.path.splitext(image_path)[<span class="number">0</span>] + <span class="string">&quot;_with_boxes.jpg&quot;</span></span><br><span class="line">        output_image_path = clean_path(output_image_path)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç›®æ ‡æ–‡ä»¶å¤¹</span></span><br><span class="line">        output_folder = os.path.dirname(output_image_path)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(output_folder):</span><br><span class="line">            os.makedirs(output_folder)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä¿å­˜å¸¦æ¡†å›¾åƒ</span></span><br><span class="line">        result = cv2.imwrite(output_image_path, img)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;å·²ä¿å­˜å¸¦æ¡†å›¾åƒ: <span class="subst">&#123;output_image_path&#125;</span>, result: <span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä¿ç•™åŸå›¾åˆ°æ‹¼éŸ³åŒ–ç›®å½•</span></span><br><span class="line">        original_image_path = clean_path(image_path)</span><br><span class="line">        original_output_folder = os.path.dirname(original_image_path)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(original_output_folder):</span><br><span class="line">            os.makedirs(original_output_folder)</span><br><span class="line"></span><br><span class="line">        shutil.copy(image_path, original_image_path)  <span class="comment"># å¤åˆ¶åŸå›¾åˆ°æ‹¼éŸ³åŒ–ç›®å½•</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;åŸå›¾å·²å¤åˆ¶åˆ°: <span class="subst">&#123;original_image_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> formatted_results</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="string">f&quot;å‘ç”Ÿé”™è¯¯: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_json_result</span>(<span class="params">image_path, result</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    å°†è¯†åˆ«ç»“æœä¿å­˜ä¸º JSON æ–‡ä»¶ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        image_name = os.path.splitext(os.path.basename(image_path))[<span class="number">0</span>]</span><br><span class="line">        json_path = os.path.join(os.path.dirname(image_path), <span class="string">f&quot;<span class="subst">&#123;image_name&#125;</span>.json&quot;</span>)</span><br><span class="line">        json_path = clean_path(json_path)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(json_path, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> json_file:</span><br><span class="line">            json.dump(result, json_file, ensure_ascii=<span class="literal">False</span>, indent=<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;ç»“æœå·²ä¿å­˜åˆ°: <span class="subst">&#123;json_path&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;ä¿å­˜ JSON æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_all_images_in_directory</span>(<span class="params">directory_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    é€’å½’è¯»å–æŒ‡å®šç›®å½•åŠå…¶å­ç›®å½•ä¸­çš„æ‰€æœ‰å›¾åƒæ–‡ä»¶ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    image_files = []</span><br><span class="line">    <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(directory_path):</span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">            <span class="keyword">if</span> file.lower().endswith((<span class="string">&#x27;.png&#x27;</span>, <span class="string">&#x27;.jpg&#x27;</span>, <span class="string">&#x27;.jpeg&#x27;</span>, <span class="string">&#x27;.bmp&#x27;</span>)):</span><br><span class="line">                image_files.append(os.path.join(root, file))</span><br><span class="line">    <span class="keyword">return</span> image_files</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_images_in_directory</span>(<span class="params">directory_path, folders, lan_code</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æ‰¹é‡å¤„ç†æŒ‡å®šç›®å½•ä¸­çš„æ‰€æœ‰å›¾åƒæ–‡ä»¶ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    image_paths = get_all_images_in_directory(directory_path)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> image_path <span class="keyword">in</span> tqdm(image_paths, desc=<span class="string">&quot;Processing images&quot;</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;æ­£åœ¨å¤„ç†å›¾åƒ: <span class="subst">&#123;image_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># è·å–æ–‡ä»¶å¤¹åä½œä¸ºè¯­è¨€ä»£ç </span></span><br><span class="line">            folder_name = os.path.basename(os.path.dirname(image_path))</span><br><span class="line">            <span class="keyword">if</span> folder_name <span class="keyword">in</span> language_map:</span><br><span class="line">                lan_code = language_map[folder_name]  <span class="comment"># æ ¹æ®æ–‡ä»¶å¤¹åè·å–è¯­è¨€ä»£ç </span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;æœªæ‰¾åˆ°å¯¹åº”çš„è¯­è¨€ä»£ç : <span class="subst">&#123;folder_name&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">continue</span>  <span class="comment"># å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„è¯­è¨€ä»£ç ï¼Œè·³è¿‡è¯¥å›¾åƒ</span></span><br><span class="line"></span><br><span class="line">            result = extract_text_with_coords(image_path, folders, lan_code)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(result, <span class="built_in">dict</span>) <span class="keyword">and</span> <span class="string">&quot;error&quot;</span> <span class="keyword">in</span> result:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;å¤„ç† <span class="subst">&#123;image_path&#125;</span> æ—¶å‘ç”Ÿé”™è¯¯: <span class="subst">&#123;result[<span class="string">&#x27;error&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(result, <span class="built_in">list</span>) <span class="keyword">and</span> result:</span><br><span class="line">                save_json_result(image_path, result)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;å¤„ç† <span class="subst">&#123;image_path&#125;</span> æ—¶æ²¡æœ‰æ£€æµ‹åˆ°æœ‰æ•ˆæ–‡æœ¬ã€‚&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;å¤„ç† <span class="subst">&#123;image_path&#125;</span> æ—¶å‘ç”Ÿé”™è¯¯: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_all_folders_in_directory</span>(<span class="params">directory_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è·å–ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶å¤¹åã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        items = os.listdir(directory_path)</span><br><span class="line">        folders = [item <span class="keyword">for</span> item <span class="keyword">in</span> items <span class="keyword">if</span> os.path.isdir(os.path.join(directory_path, item))]</span><br><span class="line">        <span class="keyword">return</span> folders</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;å‘ç”Ÿé”™è¯¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fix_non_ascii_path</span>(<span class="params">path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ä¿®å¤è·¯å¾„ä¸­çš„é ASCII å­—ç¬¦é—®é¢˜ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> path.encode(<span class="string">&#x27;utf-8&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹ï¼šä»æŒ‡å®šç›®å½•æ‰¹é‡å¤„ç†å›¾åƒ</span></span><br><span class="line">image_directory = <span class="string">r&quot;C:\Users\DELL\Desktop\CZQ\ä¿„è¯­&quot;</span>  <span class="comment"># æ›¿æ¢ä¸ºä½ çš„å›¾ç‰‡ç›®å½•è·¯å¾„</span></span><br><span class="line">image_directory = fix_non_ascii_path(image_directory)</span><br><span class="line">folders = get_all_folders_in_directory(image_directory)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;æ–‡ä»¶å¤¹åˆ—è¡¨:&quot;</span>, folders)  <span class="comment"># æ‰“å°æ–‡ä»¶å¤¹åˆ—è¡¨ï¼Œç¡®ä¿è·å–çš„æ–‡ä»¶å¤¹æ­£ç¡®</span></span><br><span class="line"></span><br><span class="line">process_images_in_directory(image_directory, folders, lan_code)</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>ä¸Šè¿°ä»£ç æ‰¹é‡å¤„ç†æŒ‡å®šç›®å½•åŠå…¶å­ç›®å½•ä¸‹çš„å›¾åƒæ–‡ä»¶ï¼Œä½¿ç”¨ EasyOCR æå–å›¾åƒä¸­çš„æ–‡æœ¬åŠå…¶åæ ‡ï¼Œå¹¶å°†ç»“æœä¿å­˜ä¸º JSON æ–‡ä»¶ã€‚åŒæ—¶ï¼Œå®ƒè¿˜ä¼šåœ¨åŸå§‹å›¾åƒä¸Šç»˜åˆ¶æ–‡æœ¬æ¡†ï¼Œå¹¶å°†å¸¦æ¡†çš„å›¾åƒå’ŒåŸå§‹å›¾åƒå¤åˆ¶åˆ°ä»¥æ‹¼éŸ³å‘½åçš„è·¯å¾„ä¸‹</p></blockquote><p><em>ä½¿ç”¨pillowã€easyocrã€numpyã€pypinyinã€tqdmã€å¤šçº¿ç¨‹ç­‰æŠ€æœ¯</em></p><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Appium Debug Bridge</title>
      <link href="/2024/11/21/appium_adb_app/"/>
      <url>/2024/11/21/appium_adb_app/</url>
      
        <content type="html"><![CDATA[<h1>Appium Debug Bridge</h1><h2 id="ADB">ADB</h2><h2 id="install">install</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://developer.android.com/studio?hl=zh-cn#command-line-tools-only</span><br></pre></td></tr></table></figure><h2 id="appium">appium</h2><h3 id="install-2">install</h3><ul><li>server</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/appium/appium</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">install</span></span><br><span class="line">npm i -g appium</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">install driver</span></span><br><span class="line">appium driver install uiautomator2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Start the server on the default host (0.0.0.0) and port (4723)</span></span><br><span class="line">appium server</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">You can also omit the <span class="string">&#x27;server&#x27;</span> subcommand</span></span><br><span class="line">appium</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Start the server on the given host, port and use a custom base path prefix (the default prefix is <span class="string">&#x27;/&#x27;</span>)</span></span><br><span class="line">appium --address 127.0.0.1 --port 9000 --base-path /wd/hub</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">use</span></span><br><span class="line">appium</span><br></pre></td></tr></table></figure><h2 id="python-selenium">python selenium</h2><p><a href="appium_adb_app.md">appium_adb_app.md</a></p><blockquote><p>automatic test</p></blockquote><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># from venv import logger</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="keyword">from</span> appium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> appium.options.android <span class="keyword">import</span> UiAutomator2Options</span><br><span class="line"><span class="keyword">from</span> appium.webdriver.common.appiumby <span class="keyword">import</span> AppiumBy</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">appium_init</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    appium catch video</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    delay_time = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">    desired_caps = &#123;</span><br><span class="line">        <span class="string">&#x27;platformName&#x27;</span>: <span class="string">&#x27;Android&#x27;</span>,  <span class="comment"># æˆ– &#x27;iOS&#x27;ï¼Œå–å†³äºä½ çš„è®¾å¤‡</span></span><br><span class="line">        <span class="string">&#x27;platformVersion&#x27;</span>: <span class="string">&#x27;10&#x27;</span>,  <span class="comment"># è®¾å¤‡çš„ Android ç‰ˆæœ¬</span></span><br><span class="line">        <span class="string">&#x27;deviceName&#x27;</span>: <span class="string">&#x27;Android&#x27;</span>,  <span class="comment"># æ¨¡æ‹Ÿå™¨çš„è®¾å¤‡åæˆ–è¿æ¥çš„è®¾å¤‡å</span></span><br><span class="line">        <span class="string">&#x27;appPackage&#x27;</span>: <span class="string">&#x27;com.ayay.yoga&#x27;</span>,  <span class="comment"># æ›¿æ¢ä¸ºä½ çš„ App åŒ…å</span></span><br><span class="line">        <span class="string">&#x27;appActivity&#x27;</span>: <span class="string">&#x27;.MainActivity&#x27;</span>,  <span class="comment"># æ›¿æ¢ä¸ºä½ çš„ä¸» Activity</span></span><br><span class="line">        <span class="string">&#x27;noReset&#x27;</span>: <span class="literal">True</span>,  <span class="comment"># ä¸é‡ç½®åº”ç”¨</span></span><br><span class="line">        <span class="string">&#x27;fullContextIgnore&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&#x27;automationName&#x27;</span>: <span class="string">&#x27;UiAutomator2&#x27;</span>,  <span class="comment"># Android ä½¿ç”¨ UiAutomator2</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ›å»º Appium WebDriver å®ä¾‹</span></span><br><span class="line">    <span class="comment"># åˆ›å»º UiAutomator2Options å¯¹è±¡ï¼Œå¹¶è®¾ç½®æ‰€éœ€çš„èƒ½åŠ›</span></span><br><span class="line">    options = UiAutomator2Options()</span><br><span class="line">    <span class="comment"># options.add_argument(&quot;--no-reset&quot;)  # ç”¨äºä¼ é€’å‘½ä»¤è¡Œå‚æ•°ï¼Œä¸æ˜¯èƒ½åŠ›é…ç½®</span></span><br><span class="line">    options.platform_name = <span class="string">&quot;Android&quot;</span></span><br><span class="line">    options.platform_version = <span class="string">&quot;10&quot;</span>  <span class="comment"># ç›®æ ‡è®¾å¤‡çš„ Android ç‰ˆæœ¬</span></span><br><span class="line">    options.device_name = <span class="string">&quot;emulator-5554&quot;</span>  <span class="comment"># æ¨¡æ‹Ÿå™¨æˆ–è®¾å¤‡å</span></span><br><span class="line">    options.app_package = <span class="string">&quot;com.ayay.yoga&quot;</span>  <span class="comment"># æ›¿æ¢ä¸ºä½ çš„ App åŒ…å</span></span><br><span class="line">    options.app_activity = <span class="string">&quot;com.ayay.yoga.MainActivity&quot;</span>  <span class="comment"># æ›¿æ¢ä¸ºä½ çš„ Activity åç§°</span></span><br><span class="line">    options.no_reset = <span class="literal">True</span>  <span class="comment"># ç¡®ä¿ä¼ é€’å¸ƒå°”å€¼</span></span><br><span class="line"></span><br><span class="line">    capabilities = <span class="built_in">dict</span>(</span><br><span class="line">        platformName=<span class="string">&#x27;Android&#x27;</span>,</span><br><span class="line">        automationName=<span class="string">&#x27;uiautomator2&#x27;</span>,</span><br><span class="line">        deviceName=<span class="string">&#x27;Android&#x27;</span>,</span><br><span class="line">        appPackage=<span class="string">&#x27;com.ayay.yoga&#x27;</span>,</span><br><span class="line">        appActivity=<span class="string">&#x27;.MainActivity&#x27;</span>,</span><br><span class="line">        language=<span class="string">&#x27;en&#x27;</span>,</span><br><span class="line">        locale=<span class="string">&#x27;US&#x27;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¿æ¥åˆ° Appium æœåŠ¡å™¨</span></span><br><span class="line">    driver = webdriver.Remote(<span class="string">&#x27;http://localhost:4723&#x27;</span>, options=UiAutomator2Options().load_capabilities(capabilities))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç­‰å¾…åº”ç”¨åŠ è½½</span></span><br><span class="line">    sleep(delay_time)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">click_element_by_xpath</span>(<span class="params">xpath</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;é€šè¿‡ XPath æŸ¥æ‰¾å¹¶ç‚¹å‡»å…ƒç´ &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># element = driver.find_element(xpath)</span></span><br><span class="line">        element_faxian = driver.find_element(by=AppiumBy.XPATH, value=xpath)</span><br><span class="line">        element_faxian.click()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">click_element_by_id</span>(<span class="params">element_id</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;é€šè¿‡ ID æŸ¥æ‰¾å¹¶ç‚¹å‡»å…ƒç´ &quot;&quot;&quot;</span></span><br><span class="line">        element = driver.find_element(by=AppiumBy.ID, value=element_id)</span><br><span class="line">        element.click()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">swipe_to_center</span>(<span class="params">x_offset, y_offset</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ¨¡æ‹Ÿç‚¹å‡»å±å¹•ä¸­å¿ƒ&quot;&quot;&quot;</span></span><br><span class="line">        center_x = x_offset // <span class="number">2</span></span><br><span class="line">        center_y = y_offset // <span class="number">2</span></span><br><span class="line">        <span class="comment"># TouchAction(driver).tap(x=center_x, y=center_y).perform()</span></span><br><span class="line"></span><br><span class="line">    sleep(delay_time)</span><br><span class="line">    <span class="comment"># element = driver.find_element_by_android_uiautomator(&#x27;new UiSelector().text(&quot;å‘ç°&quot;)&#x27;)</span></span><br><span class="line">    <span class="comment"># element_faxian = driver.find_element(by=AppiumBy.XPATH, value=&#x27;//*[@text=&quot;å‘ç°&quot;]&#x27;)</span></span><br><span class="line">    click_element_by_xpath(<span class="string">&#x27;//*[@text=&quot;å‘ç°&quot;]&#x27;</span>)</span><br><span class="line">    <span class="comment"># element.click()</span></span><br><span class="line">    <span class="comment"># element_faxian.click()</span></span><br><span class="line">    sleep(delay_time)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;switch tab&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. ç‚¹å‡» &quot;å‘ç°&quot; æŒ‰é’®ï¼ˆå‡è®¾å®ƒçš„ XPath æ˜¯ &#x27;/hierarchy/.../å‘ç°&#x27;ï¼‰</span></span><br><span class="line">    <span class="comment"># click_element_by_xpath(&#x27;//*[@text=&quot;å‘ç°&quot;]&#x27;)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. ç‚¹å‡» &quot;å…¨éƒ¨è¯¾ç¨‹&quot; æŒ‰é’®ï¼ˆå‡è®¾å®ƒçš„ XPath æ˜¯ &#x27;/hierarchy/.../å…¨éƒ¨è¯¾ç¨‹&#x27;ï¼‰</span></span><br><span class="line">    click_element_by_xpath(<span class="string">&#x27;//*[@text=&quot;å…¨éƒ¨è¯¾ç¨‹&quot;]&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;all course&quot;</span>)</span><br><span class="line">    sleep(delay_time)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å–æ‰€æœ‰è¯¾ç¨‹å›¾ç‰‡çš„å…ƒç´ ï¼ˆå‡è®¾å®ƒä»¬çš„ XPath æ˜¯ &#x27;/hierarchy/.../è¯¾ç¨‹å›¾ç‰‡&#x27;ï¼‰</span></span><br><span class="line">    <span class="comment"># è¿™é‡Œéœ€è¦ç¡®ä¿ä½ èƒ½å¤Ÿå®šä½åˆ°æ‰€æœ‰å›¾ç‰‡</span></span><br><span class="line">    images = driver.find_elements(by=AppiumBy.CLASS_NAME, value=<span class="string">&#x27;android.widget.ImageView&#x27;</span>)</span><br><span class="line">    <span class="comment"># images = driver.find_elements(by=AppiumBy.ID, value=&#x27;//*[@resource-id=&quot;com.ayay.yoga:id/course_image&quot;]&#x27;)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">str</span>(<span class="built_in">len</span>(images)) + <span class="string">&#x27;image load result&#x27;</span>)</span><br><span class="line">    sleep(delay_time)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> img <span class="keyword">in</span> images:</span><br><span class="line">        <span class="comment"># 3. ç‚¹å‡»æ¯ä¸ªè¯¾ç¨‹å›¾ç‰‡</span></span><br><span class="line">        img.click()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 4. ç‚¹å‡» &quot;å¼€å§‹è®­ç»ƒ&quot; æŒ‰é’®ï¼ˆå‡è®¾å®ƒçš„ XPath æ˜¯ &#x27;/hierarchy/.../å¼€å§‹è®­ç»ƒ&#x27;ï¼‰</span></span><br><span class="line">        click_element_by_xpath(<span class="string">&#x27;//*[@text=&quot;å¼€å§‹è®­ç»ƒ&quot;]&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 5. ç­‰å¾…åç§’</span></span><br><span class="line">        sleep(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 6. ç‚¹å‡»å±å¹•ä¸­å¿ƒä½ç½®ï¼ˆå‡è®¾å±å¹•å¤§å°ä¸º 1080x1920ï¼‰</span></span><br><span class="line">        swipe_to_center(<span class="number">1080</span>, <span class="number">1920</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 7. ç‚¹å‡»å·¦ä¸Šè§’çš„æŒ‰é’®é€€å‡ºï¼ˆå‡è®¾å®ƒçš„ XPath æ˜¯ &#x27;/hierarchy/.../å·¦ä¸Šè§’æŒ‰é’®&#x27;ï¼‰</span></span><br><span class="line">        click_element_by_xpath(<span class="string">&#x27;//*[@content-desc=&quot;Navigate up&quot;]&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 8. ç‚¹å‡» &quot;ç»“æŸè®­ç»ƒ&quot; æŒ‰é’®ï¼ˆå‡è®¾å®ƒçš„ XPath æ˜¯ &#x27;/hierarchy/.../ç»“æŸè®­ç»ƒ&#x27;ï¼‰</span></span><br><span class="line">        click_element_by_xpath(<span class="string">&#x27;//*[@text=&quot;ç»“æŸè®­ç»ƒ&quot;]&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 9. ç­‰å¾…åç§’åç»§ç»­å¾ªç¯</span></span><br><span class="line">        sleep(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å®Œæˆæ“ä½œåé€€å‡º</span></span><br><span class="line">    driver.quit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    appium_init()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="adb-pull-video">adb pull video</h2><blockquote><p>adb pull log</p></blockquote><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> extract_mp4_links <span class="keyword">import</span> extract_mp4_links, video_link_process</span><br><span class="line"><span class="keyword">from</span> src.pull_ld_video <span class="keyword">import</span> adb_connect, adb_root</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å– adb è·¯å¾„å’Œè®¾å¤‡ ID</span></span><br><span class="line">ADB_PATH = <span class="string">r&quot;C:\Users\DELL\Desktop\platform-tools\adb.exe&quot;</span></span><br><span class="line">DEVICE_ID = <span class="string">&quot;emulator-5554&quot;</span>  <span class="comment"># æ ¹æ®å®é™…è®¾å¤‡ ID é€‰æ‹©æ¨¡æ‹Ÿå™¨</span></span><br><span class="line">package_name = <span class="string">&#x27;com.ayay.yoga&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ adb shell pidof å‘½ä»¤è·å–æŒ‡å®šåŒ…åçš„è¿›ç¨‹ ID</span></span><br><span class="line">pid_command = [ADB_PATH, <span class="string">&#x27;shell&#x27;</span>, <span class="string">&#x27;pidof&#x27;</span>, <span class="string">&#x27;-s&#x27;</span>, package_name]</span><br><span class="line">pid_process = subprocess.Popen(pid_command, stdout=subprocess.PIPE, stderr=subprocess.PIPE)</span><br><span class="line">pid = pid_process.communicate()[<span class="number">0</span>].decode(<span class="string">&#x27;utf-8&#x27;</span>).strip()</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> pid:</span><br><span class="line">    logger.error(<span class="string">f&quot;æ— æ³•æ‰¾åˆ°åŒ…å &#x27;<span class="subst">&#123;package_name&#125;</span>&#x27; å¯¹åº”çš„è¿›ç¨‹ã€‚&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># ä½¿ç”¨ adb logcat å‘½ä»¤æŠ“å–æŒ‡å®šè¿›ç¨‹çš„æ—¥å¿—</span></span><br><span class="line">    log_command = [ADB_PATH, <span class="string">&#x27;logcat&#x27;</span>, <span class="string">&#x27;--pid=&#x27;</span> + pid]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿è¡Œ adb logcat è·å–æ¨¡æ‹Ÿå™¨æ—¥å¿—</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_simulator_log</span>():</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;simulator_log.txt&quot;</span>, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="comment"># æ‰§è¡Œ adb logcat å‘½ä»¤å¹¶å°†è¾“å‡ºå†™å…¥æ–‡ä»¶</span></span><br><span class="line">        adb_connect()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2. è·å– root æƒé™ï¼ˆå¦‚æœéœ€è¦ï¼‰</span></span><br><span class="line">        adb_root()</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            user_input = <span class="built_in">input</span>(<span class="string">&quot;æŒ‰ä¸‹ &#x27;c&#x27; é”®åœæ­¢ï¼š&quot;</span>)</span><br><span class="line">            <span class="comment"># åˆ¤æ–­ç”¨æˆ·è¾“å…¥æ˜¯å¦ä¸º &#x27;c&#x27;</span></span><br><span class="line">            <span class="keyword">if</span> user_input.lower() == <span class="string">&#x27;c&#x27;</span>:</span><br><span class="line">                logger.debug(<span class="string">&quot;ä½ æŒ‰ä¸‹äº† &#x27;c&#x27; é”®ï¼&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span>  <span class="comment"># æŒ‰ä¸‹ &#x27;c&#x27; é”®åé€€å‡ºå¾ªç¯</span></span><br><span class="line">            process = subprocess.Popen(log_command, stdout=f, stderr=subprocess.PIPE)</span><br><span class="line">            process.communicate()  <span class="comment"># ç­‰å¾… logcat å‘½ä»¤æ‰§è¡Œå®Œæˆ</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–æ—¥å¿—</span></span><br><span class="line">get_simulator_log()</span><br><span class="line">logger.success(<span class="string">&quot;start video link process...&quot;</span>)</span><br><span class="line">video_link_process()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="adb-pull-video-from-cache">adb pull video from cache</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> anyio <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> matplotlib.cbook <span class="keyword">import</span> pts_to_midstep</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å– adb è·¯å¾„å’Œè®¾å¤‡ ID</span></span><br><span class="line">ADB_PATH = <span class="string">r&quot;C:\Users\DELL\Desktop\platform-tools\adb.exe&quot;</span></span><br><span class="line">DEVICE_ID = <span class="string">&quot;emulator-5554&quot;</span>  <span class="comment"># æ ¹æ®å®é™…è®¾å¤‡ ID é€‰æ‹©æ¨¡æ‹Ÿå™¨</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹‰å–æŒ‡å®šè·¯å¾„çš„æ–‡ä»¶</span></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">adb_connect</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># ç¡®ä¿è¿æ¥åˆ°æŒ‡å®šæ¨¡æ‹Ÿå™¨</span></span><br><span class="line">        result = subprocess.run([ADB_PATH, <span class="string">&quot;-s&quot;</span>, DEVICE_ID, <span class="string">&quot;devices&quot;</span>], capture_output=<span class="literal">True</span>, text=<span class="literal">True</span>, check=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;device&quot;</span> <span class="keyword">in</span> result.stdout:</span><br><span class="line">            logger.debug(<span class="string">f&quot;å·²è¿æ¥åˆ°æ¨¡æ‹Ÿå™¨ <span class="subst">&#123;DEVICE_ID&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">f&quot;æ— æ³•è¿æ¥åˆ°æ¨¡æ‹Ÿå™¨ <span class="subst">&#123;DEVICE_ID&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> subprocess.CalledProcessError <span class="keyword">as</span> e:</span><br><span class="line">        logger.debug(<span class="string">f&quot;è¿æ¥æ¨¡æ‹Ÿå™¨å¤±è´¥: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å– root æƒé™</span></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">adb_root</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># è·å– root æƒé™ï¼ˆå¦‚æœæ¨¡æ‹Ÿå™¨æ”¯æŒï¼‰</span></span><br><span class="line">        subprocess.run([ADB_PATH, <span class="string">&quot;-s&quot;</span>, DEVICE_ID, <span class="string">&quot;root&quot;</span>], check=<span class="literal">True</span>)</span><br><span class="line">        logger.debug(<span class="string">&quot;è·å– root æƒé™æˆåŠŸï¼&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> subprocess.CalledProcessError <span class="keyword">as</span> e:</span><br><span class="line">        logger.debug(<span class="string">f&quot;æ— æ³•è·å– root æƒé™: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ—å‡ºæŒ‡å®šç›®å½•çš„æ–‡ä»¶</span></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">list_files</span>(<span class="params">remote_dir</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># ä½¿ç”¨ adb shell ls å‘½ä»¤åˆ—å‡ºè¿œç¨‹ç›®å½•æ–‡ä»¶</span></span><br><span class="line">        result = subprocess.run(</span><br><span class="line">            [ADB_PATH, <span class="string">&quot;-s&quot;</span>, DEVICE_ID, <span class="string">&quot;shell&quot;</span>, <span class="string">&quot;ls&quot;</span>, remote_dir],</span><br><span class="line">            capture_output=<span class="literal">True</span>, text=<span class="literal">True</span>, check=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        files = result.stdout.splitlines()  <span class="comment"># æŒ‰è¡Œåˆ†å‰²æ–‡ä»¶åˆ—è¡¨</span></span><br><span class="line">        <span class="keyword">return</span> files</span><br><span class="line">    <span class="keyword">except</span> subprocess.CalledProcessError <span class="keyword">as</span> e:</span><br><span class="line">        logger.debug(<span class="string">f&quot;è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°</span></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pull_files</span>(<span class="params">remote_dir, local_dir, files</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># ç¡®ä¿æœ¬åœ°ç›®å½•å­˜åœ¨</span></span><br><span class="line">        os.makedirs(local_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">            remote_file = os.path.join(remote_dir, file).replace(<span class="string">&quot;\\&quot;</span>, <span class="string">&quot;/&quot;</span>)  <span class="comment"># æ›¿æ¢åæ–œæ ä¸ºæ­£æ–œæ </span></span><br><span class="line">            local_file = os.path.join(local_dir, file).replace(<span class="string">&quot;\\&quot;</span>, <span class="string">&quot;/&quot;</span>)  <span class="comment"># æ›¿æ¢åæ–œæ ä¸ºæ­£æ–œæ </span></span><br><span class="line">            logger.debug(<span class="string">f&quot;æ­£åœ¨ä¸‹è½½ <span class="subst">&#123;remote_file&#125;</span> åˆ° <span class="subst">&#123;local_file&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># ä½¿ç”¨ adb pull å‘½ä»¤ä¸‹è½½æ–‡ä»¶</span></span><br><span class="line">            subprocess.run([ADB_PATH, <span class="string">&quot;-s&quot;</span>, DEVICE_ID, <span class="string">&quot;pull&quot;</span>, remote_file, local_file], check=<span class="literal">True</span>)</span><br><span class="line">            logger.debug(<span class="string">f&quot;<span class="subst">&#123;file&#125;</span> ä¸‹è½½å®Œæˆï¼&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> subprocess.CalledProcessError <span class="keyword">as</span> e:</span><br><span class="line">        logger.debug(<span class="string">f&quot;ä¸‹è½½æ–‡ä»¶å¤±è´¥: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸»å‡½æ•°</span></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    remote_dir = <span class="string">&quot;/storage/emulated/0/Android/data/com.wtp.wtpilates/cache/video-cache&quot;</span>  <span class="comment"># æŒ‡å®šè¿œç¨‹ç›®å½•</span></span><br><span class="line">    local_dir = <span class="string">&quot;./video/&quot;</span>  <span class="comment"># æœ¬åœ°ä¿å­˜è·¯å¾„</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 1. è¿æ¥åˆ°æ¨¡æ‹Ÿå™¨</span></span><br><span class="line">        adb_connect()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2. è·å– root æƒé™ï¼ˆå¦‚æœéœ€è¦ï¼‰</span></span><br><span class="line">        adb_root()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3. åˆ—å‡ºè¿œç¨‹ç›®å½•ä¸­çš„æ–‡ä»¶</span></span><br><span class="line">        files = list_files(remote_dir)</span><br><span class="line">        <span class="keyword">if</span> files:</span><br><span class="line">            logger.debug(<span class="string">&quot;æ–‡ä»¶åˆ—è¡¨ï¼š&quot;</span>)</span><br><span class="line">            <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(os.path.join(local_dir, file)):</span><br><span class="line">                    logger.debug(file)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    files.remove(file)</span><br><span class="line">                    logger.debug(file + <span class="string">&quot;, å·²å­˜åœ¨ï¼Œè·³è¿‡&quot;</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">            <span class="comment"># 4. æ‹‰å–æ–‡ä»¶åˆ°æœ¬åœ°</span></span><br><span class="line">            pull_files(remote_dir, local_dir, files)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logger.debug(<span class="string">&quot;æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.debug(<span class="string">f&quot;å‘ç”Ÿé”™è¯¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    logger.add(<span class="string">&quot;../logs/ld_monitor.log&quot;</span>, level=<span class="string">&quot;DEBUG&quot;</span>, rotation=<span class="string">&quot;5MB&quot;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        main()</span><br><span class="line">        logger.debug(<span class="string">&quot;sleep 60 s..&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="see">see</h2><ul><li>1.<a href="https://github.com/appium/appium">https://github.com/appium/appium</a></li><li>2.<a href="https://developer.android.com/studio?hl=zh-cn#command-line-tools-only">https://developer.android.com/studio?hl=zh-cn#command-line-tools-only</a></li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> Appium </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Excel file parser</title>
      <link href="/2024/11/21/excel_parser_pandas/"/>
      <url>/2024/11/21/excel_parser_pandas/</url>
      
        <content type="html"><![CDATA[<h1>Excel file parser</h1><h2 id="introduce">introduce</h2><blockquote><p>pandas æ˜¯ä¸€ä¸ªå¼€æºçš„ Python æ•°æ®åˆ†æåº“ï¼Œæä¾›äº†é«˜æ•ˆçš„æ•°æ®ç»“æ„ï¼ˆå¦‚ DataFrame å’Œ Seriesï¼‰å’Œå¤šç§æ•°æ®æ“ä½œå·¥å…·ã€‚å®ƒéå¸¸é€‚åˆç”¨äºæ•°æ®æ¸…æ´—ã€æ•°æ®åˆ†æå’Œæ•°æ®å¤„ç†ç­‰ä»»åŠ¡ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†è¡¨æ ¼å‹æ•°æ®ï¼ˆä¾‹å¦‚ Excel è¡¨æ ¼ã€CSV æ–‡ä»¶ã€SQL æ•°æ®åº“ç­‰ï¼‰æ—¶éå¸¸å¼ºå¤§ã€‚</p></blockquote><blockquote><p>pandas çš„åç§°æºè‡ªâ€œpanel dataâ€ï¼ˆé¢æ¿æ•°æ®ï¼‰ï¼Œå³å¸¦æœ‰æ—¶é—´å’Œå¤šç»´ç´¢å¼•çš„å¤æ‚æ•°æ®ç»“æ„ã€‚è™½ç„¶è¿™ä¸ªåå­—ä¸é¢æ¿æ•°æ®ç›¸å…³ï¼Œä½† pandas å·²ç»æˆä¸ºäº†æ‰€æœ‰ç±»å‹æ•°æ®åˆ†æçš„æ ‡å‡†å·¥å…·ä¹‹ä¸€ã€‚</p></blockquote><h2 id="æ ¸å¿ƒåŠŸèƒ½">æ ¸å¿ƒåŠŸèƒ½</h2><blockquote><p>é€šè¿‡ Series å’Œ DataFrame ä¸¤ä¸ªæ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œpandas æä¾›äº†æå…¶çµæ´»å’Œé«˜æ•ˆçš„æ“ä½œæ–¹å¼ï¼Œå‡ ä¹æ˜¯è¿›è¡Œæ•°æ®åˆ†æå’Œç§‘å­¦è®¡ç®—æ—¶çš„æ ‡å‡†å·¥å…·ã€‚</p></blockquote><ul><li>è¯»å†™excel\sql\csvæ–‡ä»¶</li><li>æ•°æ®è¿‡æ»¤ é€‰æ‹©</li><li>æ•°æ®æ¸…æ´— è½¬æ¢</li><li>æ•°æ®åˆå¹¶è¿æ¥</li><li>æ•°æ®é€è§†</li><li>æ•°æ®å¯è§†åŒ–</li><li>å¤§æ•°æ®å¤„ç†</li></ul><h2 id="lib">lib</h2><blockquote><p>pandas</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">pip install pandas</span><br></pre></td></tr></table></figure><h2 id="use-demo">use demo</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">åŠ æƒå¹³å‡å†…å®¹= </span></span><br><span class="line"><span class="string">âˆ‘(æ–‡æœ¬é•¿åº¦)</span></span><br><span class="line"><span class="string">â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</span></span><br><span class="line"><span class="string">âˆ‘(å†…å®¹Ã—æ–‡æœ¬é•¿åº¦)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å–Excelæ–‡ä»¶ï¼ˆå‡è®¾ä½ çš„æ•°æ®å·²ç»ä¿å­˜åœ¨Excelæ–‡ä»¶ä¸­ï¼‰</span></span><br><span class="line">file_path = <span class="string">&#x27;./data/data.xlsx&#x27;</span>  <span class="comment"># æ›¿æ¢ä¸ºå®é™…çš„Excelæ–‡ä»¶è·¯å¾„</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å–Excelæ–‡ä»¶</span></span><br><span class="line">df = pd.read_excel(file_path)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹åŸå§‹æ•°æ®ï¼ˆå¯é€‰ï¼‰</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;åŸå§‹æ•°æ®:&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(df.head())</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤„ç†â€œå†…å®¹â€åˆ—ï¼Œæ£€æŸ¥æ˜¯å¦ä¸ºå­—ç¬¦ä¸²ï¼Œè‹¥æ˜¯ç™¾åˆ†æ¯”æ–‡æœ¬ï¼Œåˆ™è½¬æ¢ä¸ºæµ®åŠ¨ç±»å‹</span></span><br><span class="line"><span class="comment"># å…ˆæ£€æŸ¥å†…å®¹åˆ—çš„æ•°æ®ç±»å‹</span></span><br><span class="line"><span class="keyword">if</span> df[<span class="string">&#x27;å†…å®¹&#x27;</span>].dtype == <span class="string">&#x27;object&#x27;</span>:  <span class="comment"># å¦‚æœæ˜¯å­—ç¬¦ä¸²ç±»å‹</span></span><br><span class="line">    df[<span class="string">&#x27;å†…å®¹&#x27;</span>] = df[<span class="string">&#x27;å†…å®¹&#x27;</span>].<span class="built_in">str</span>.replace(<span class="string">&#x27;%&#x27;</span>, <span class="string">&#x27;&#x27;</span>).astype(<span class="built_in">float</span>) / <span class="number">100</span>  <span class="comment"># å»æ‰ç™¾åˆ†å·å¹¶è½¬æ¢ä¸ºæµ®åŠ¨ç±»å‹</span></span><br><span class="line"><span class="keyword">elif</span> df[<span class="string">&#x27;å†…å®¹&#x27;</span>].dtype != <span class="string">&#x27;float&#x27;</span>:  <span class="comment"># å¦‚æœæ˜¯å…¶ä»–æ•°å€¼ç±»å‹ä½†ä¸æ˜¯float</span></span><br><span class="line">    df[<span class="string">&#x27;å†…å®¹&#x27;</span>] = df[<span class="string">&#x27;å†…å®¹&#x27;</span>].astype(<span class="built_in">float</span>)  <span class="comment"># å¼ºåˆ¶è½¬æ¢ä¸ºæµ®åŠ¨ç±»å‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æå–æ–‡ä»¶åçš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œä¾‹å¦‚â€œè¶…å® æ—¶ä»£â€ æˆ– â€œå°é»‘é¾™â€ ç­‰</span></span><br><span class="line">df[<span class="string">&#x27;æ–‡ä»¶å&#x27;</span>] = df[<span class="string">&#x27;æ–‡ä»¶å&#x27;</span>].apply(<span class="keyword">lambda</span> x: re.sub(<span class="string">r&#x27;\d+$&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="built_in">str</span>(x)))  <span class="comment"># å¼ºåˆ¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œå»é™¤åç§°æœ«å°¾çš„æ•°å­—</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‰å†…å®¹å’Œæ–‡ä»¶ååˆ†ç»„ï¼Œè®¡ç®—æ¯ä¸ªç»„çš„æ–‡æœ¬é•¿åº¦æ€»å’Œå’ŒåŠ æƒå¹³å‡å†…å®¹</span></span><br><span class="line">grouped = df.groupby([<span class="string">&#x27;å†…å®¹&#x27;</span>, <span class="string">&#x27;æ–‡ä»¶å&#x27;</span>]).agg(</span><br><span class="line">    æ–‡æœ¬é•¿åº¦æ€»å’Œ=(<span class="string">&#x27;æ–‡æœ¬é•¿åº¦&#x27;</span>, <span class="string">&#x27;sum&#x27;</span>),</span><br><span class="line">    å†…å®¹åŠ æƒå¹³å‡=(<span class="string">&#x27;å†…å®¹&#x27;</span>, <span class="keyword">lambda</span> x: (x * df.loc[x.index, <span class="string">&#x27;é•¿åº¦&#x27;</span>]).<span class="built_in">sum</span>() / x.<span class="built_in">sum</span>())</span><br><span class="line">).reset_index()</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†åŠ æƒå¹³å‡å†…å®¹è½¬æ¢ä¸ºç™¾åˆ†æ¯”å½¢å¼</span></span><br><span class="line">grouped[<span class="string">&#x27;æœ€ä½åŠ æƒå¹³å‡å†…å®¹&#x27;</span>] = grouped[<span class="string">&#x27;å†…å®¹åŠ æƒå¹³å‡&#x27;</span>].<span class="built_in">min</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ ¼å¼åŒ–ä¸ºç™¾åˆ†æ¯”ï¼Œä¿ç•™ä¸¤ä½å°æ•°</span></span><br><span class="line">grouped[<span class="string">&#x27;å†…å®¹åŠ æƒå¹³å‡&#x27;</span>] = grouped[<span class="string">&#x27;å†…å®¹åŠ æƒå¹³å‡&#x27;</span>].apply(<span class="keyword">lambda</span> x: <span class="string">f&quot;<span class="subst">&#123;x / <span class="number">1000</span>:<span class="number">.2</span>f&#125;</span>%&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå¹¶åçš„æ•°æ®</span></span><br><span class="line">merged_data = []</span><br><span class="line"><span class="keyword">for</span> _, group <span class="keyword">in</span> grouped.iterrows():</span><br><span class="line">    merged_data.append(&#123;</span><br><span class="line">        <span class="string">&#x27;å†…å®¹&#x27;</span>: group[<span class="string">&#x27;å†…å®¹&#x27;</span>]</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†åˆå¹¶åçš„æ•°æ®è½¬åŒ–ä¸ºDataFrame</span></span><br><span class="line">merged_df = pd.DataFrame(merged_data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºåˆå¹¶åçš„ç»“æœ</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\nåˆå¹¶åçš„æ•°æ®:&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(merged_df)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿å­˜ä¸ºæ–°çš„Excelæ–‡ä»¶</span></span><br><span class="line">output_path = <span class="string">&#x27;result_data.xlsx&#x27;</span>  <span class="comment"># è¾“å‡ºè·¯å¾„</span></span><br><span class="line">merged_df.to_excel(output_path, index=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;\næ•°æ®å·²ä¿å­˜åˆ° <span class="subst">&#123;output_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> Excel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nltk lib use</title>
      <link href="/2024/11/21/nltk-use/"/>
      <url>/2024/11/21/nltk-use/</url>
      
        <content type="html"><![CDATA[<h1>nltk lib use</h1><h2 id="ç®€ä»‹">ç®€ä»‹</h2><blockquote><p>NLTKï¼ˆNatural Language Toolkitï¼Œä¸­æ–‡å«åšè‡ªç„¶è¯­è¨€å·¥å…·åŒ…ï¼‰æ˜¯ä¸€ä¸ªç”¨äºå¤„ç†å’Œåˆ†æäººç±»è¯­è¨€æ•°æ®ï¼ˆè‡ªç„¶è¯­è¨€ï¼‰çš„Pythonåº“ã€‚å®ƒä¸ºè‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNLPï¼‰æä¾›äº†è®¸å¤šæœ‰ç”¨çš„å·¥å…·å’Œèµ„æºï¼Œå¹¿æ³›ç”¨äºå­¦æœ¯ç ”ç©¶ã€æœºå™¨å­¦ä¹ ã€æ–‡æœ¬åˆ†æç­‰é¢†åŸŸã€‚</p></blockquote><h2 id="å®‰è£…ä½¿ç”¨">å®‰è£…ä½¿ç”¨</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">pip install nltk</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="å®‰è£…èµ„æº">å®‰è£…èµ„æº</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import nltk</span><br><span class="line">nltk.download(&#x27;punkt&#x27;)  # ä¸‹è½½ç”¨äºæ ‡è®°åŒ–çš„èµ„æº</span><br><span class="line">nltk.download(&#x27;stopwords&#x27;)  # ä¸‹è½½åœç”¨è¯åˆ—è¡¨</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="åŠŸèƒ½">åŠŸèƒ½</h2><ol><li><p><strong>æ–‡æœ¬å¤„ç†å’Œæ ‡è®°åŒ–ï¼ˆTokenizationï¼‰</strong>ï¼š</p><ul><li>å°†æ–‡æœ¬åˆ†è§£ä¸ºæ›´å°çš„å•ä½ï¼Œå¦‚å•è¯ã€å¥å­ç­‰ã€‚ä¾‹å¦‚ï¼ŒæŠŠä¸€å¥è¯åˆ†æˆå•è¯åˆ—è¡¨ã€‚</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> nltk</span><br><span class="line"><span class="keyword">from</span> nltk.tokenize <span class="keyword">import</span> word_tokenize</span><br><span class="line">text = <span class="string">&quot;Hello, world!&quot;</span></span><br><span class="line">words = word_tokenize(text)</span><br><span class="line"><span class="built_in">print</span>(words)  <span class="comment"># è¾“å‡º: [&#x27;Hello&#x27;, &#x27;,&#x27;, &#x27;world&#x27;, &#x27;!&#x27;]</span></span><br></pre></td></tr></table></figure></li><li><p><strong>è¯æ€§æ ‡æ³¨ï¼ˆPOS Taggingï¼‰</strong>ï¼š</p><ul><li>ç»™æ¯ä¸ªå•è¯æ‰“ä¸Šä¸€ä¸ªè¯æ€§æ ‡ç­¾ï¼ˆå¦‚åè¯ã€åŠ¨è¯ã€å½¢å®¹è¯ç­‰ï¼‰ï¼Œå¸®åŠ©ç†è§£å•è¯åœ¨å¥ä¸­çš„è¯­æ³•ä½œç”¨ã€‚</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> nltk.tokenize <span class="keyword">import</span> word_tokenize</span><br><span class="line"><span class="keyword">from</span> nltk <span class="keyword">import</span> pos_tag</span><br><span class="line">sentence = <span class="string">&quot;I am learning Python.&quot;</span></span><br><span class="line">words = word_tokenize(sentence)</span><br><span class="line">tagged = pos_tag(words)</span><br><span class="line"><span class="built_in">print</span>(tagged)</span><br><span class="line"><span class="comment"># è¾“å‡º: [(&#x27;I&#x27;, &#x27;PRP&#x27;), (&#x27;am&#x27;, &#x27;VBP&#x27;), (&#x27;learning&#x27;, &#x27;VBG&#x27;), (&#x27;Python&#x27;, &#x27;NNP&#x27;)]</span></span><br></pre></td></tr></table></figure></li><li><p><strong>å‘½åå®ä½“è¯†åˆ«ï¼ˆNER, Named Entity Recognitionï¼‰</strong>ï¼š</p><ul><li>NLTKèƒ½å¤Ÿè¯†åˆ«æ–‡æœ¬ä¸­çš„å‘½åå®ä½“ï¼Œå¦‚äººåã€åœ°åã€ç»„ç»‡åç­‰ã€‚</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> nltk <span class="keyword">import</span> ne_chunk</span><br><span class="line"><span class="keyword">from</span> nltk.tokenize <span class="keyword">import</span> word_tokenize</span><br><span class="line"><span class="keyword">from</span> nltk <span class="keyword">import</span> pos_tag</span><br><span class="line"></span><br><span class="line">sentence = <span class="string">&quot;Barack Obama was born in Hawaii.&quot;</span></span><br><span class="line">words = word_tokenize(sentence)</span><br><span class="line">tagged = pos_tag(words)</span><br><span class="line">named_entities = ne_chunk(tagged)</span><br><span class="line"><span class="built_in">print</span>(named_entities)</span><br><span class="line"><span class="comment"># è¾“å‡º: (S (PERSON Barack/NNP Obama/NNP) was/VBD born/VBN in/IN Hawaii/NNP ./.)</span></span><br></pre></td></tr></table></figure></li><li><p><strong>è¯æ±‡å’Œè¯­æ–™åº“ï¼ˆCorporaï¼‰</strong>ï¼š</p><ul><li>NLTKæä¾›äº†è®¸å¤šå†…ç½®çš„è¯­æ–™åº“ï¼ˆcorporaï¼‰ï¼Œè¿™äº›è¯­æ–™åº“åŒ…å«å¤§é‡çš„æ–‡æœ¬æ•°æ®ï¼Œå¯ä»¥ç”¨äºè¯­è¨€æ¨¡å‹è®­ç»ƒã€æ–‡æœ¬åˆ†æç­‰ã€‚ä¾‹å¦‚ï¼Œ<code>punkt</code>è¯­æ–™åº“ç”¨äºå¥å­åˆ†å‰²ï¼Œ<code>stopwords</code>è¯­æ–™åº“æä¾›äº†å¸¸è§çš„åœç”¨è¯ï¼ˆå¦‚â€œtheâ€ï¼Œâ€œisâ€ç­‰ï¼‰ï¼Œå¯ä»¥åœ¨æ–‡æœ¬å¤„ç†æ—¶å¿½ç•¥è¿™äº›è¯ã€‚</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> nltk.corpus <span class="keyword">import</span> stopwords</span><br><span class="line">stop_words = <span class="built_in">set</span>(stopwords.words(<span class="string">&#x27;english&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(stop_words)  <span class="comment"># è¾“å‡º: &#123;&#x27;the&#x27;, &#x27;and&#x27;, &#x27;is&#x27;, &#x27;in&#x27;, &#x27;of&#x27;, &#x27;to&#x27;, ...&#125;</span></span><br></pre></td></tr></table></figure></li><li><p><strong>è¯å¹²æå–ï¼ˆStemmingï¼‰å’Œè¯å½¢è¿˜åŸï¼ˆLemmatizationï¼‰</strong>ï¼š</p><ul><li>è¿™ä¸¤ä¸ªæŠ€æœ¯ç”¨äºå°†å•è¯è¿˜åŸä¸ºå…¶åŸºç¡€å½¢å¼ï¼ˆå¦‚å°†â€œrunningâ€å˜ä¸ºâ€œrunâ€ï¼‰ã€‚</li><li>è¯å¹²æå–ï¼ˆStemmingï¼‰æ˜¯é€šè¿‡ç®€å•çš„è§„åˆ™æ¥å»é™¤è¯å°¾ï¼Œè€Œè¯å½¢è¿˜åŸï¼ˆLemmatizationï¼‰åˆ™è€ƒè™‘ä¸Šä¸‹æ–‡ï¼Œä½¿ç”¨å­—å…¸å’Œè§„åˆ™ã€‚</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> nltk.stem <span class="keyword">import</span> PorterStemmer</span><br><span class="line">stemmer = PorterStemmer()</span><br><span class="line"><span class="built_in">print</span>(stemmer.stem(<span class="string">&quot;running&quot;</span>))  <span class="comment"># è¾“å‡º: run</span></span><br></pre></td></tr></table></figure></li><li><p><strong>æ–‡æœ¬åˆ†ç±»ï¼ˆText Classificationï¼‰</strong>ï¼š</p><ul><li>NLTKæ”¯æŒæ„å»ºå’Œè®­ç»ƒæ–‡æœ¬åˆ†ç±»å™¨ï¼Œé€‚ç”¨äºåƒåœ¾é‚®ä»¶åˆ†ç±»ã€æƒ…æ„Ÿåˆ†æç­‰ä»»åŠ¡ã€‚</li></ul></li><li><p><strong>å¥æ³•åˆ†æï¼ˆParsingï¼‰</strong>ï¼š</p><ul><li>NLTKæ”¯æŒå„ç§å¥æ³•åˆ†ææŠ€æœ¯ï¼ŒåŒ…æ‹¬ä¸Šä¸‹æ–‡æ— å…³æ–‡æ³•ï¼ˆCFGï¼‰å’Œä¾å­˜å¥æ³•åˆ†æï¼Œå¸®åŠ©ç†è§£å¥å­çš„ç»“æ„ã€‚</li></ul></li><li><p><strong>æœºå™¨ç¿»è¯‘å’Œè¯å‘é‡ï¼ˆWord Embeddingsï¼‰</strong>ï¼š</p><ul><li>NLTKä¹Ÿå¯ä»¥ä¸å…¶ä»–åº“ï¼ˆå¦‚Gensimï¼‰ç»“åˆï¼Œç”¨äºè¯å‘é‡æ¨¡å‹å’Œæœºå™¨ç¿»è¯‘ç­‰ä»»åŠ¡ã€‚</li></ul></li></ol><h2 id="demo">demo</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> nltk</span><br><span class="line"><span class="keyword">from</span> nltk.corpus <span class="keyword">import</span> stopwords</span><br><span class="line"><span class="keyword">from</span> nltk.tokenize <span class="keyword">import</span> word_tokenize</span><br><span class="line"><span class="keyword">from</span> sklearn.feature_extraction.text <span class="keyword">import</span> TfidfVectorizer</span><br><span class="line"><span class="keyword">from</span> sklearn.decomposition <span class="keyword">import</span> LatentDirichletAllocation</span><br><span class="line"><span class="keyword">import</span> spacy</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Counter</span><br><span class="line"><span class="keyword">from</span> textblob <span class="keyword">import</span> TextBlob</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> src.txt_decode.txt_decode_new <span class="keyword">import</span> en_model_path</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½å¿…è¦çš„NLTKæ•°æ®</span></span><br><span class="line">nltk.download(<span class="string">&#x27;punkt&#x27;</span>)</span><br><span class="line">nltk.download(<span class="string">&#x27;stopwords&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½Spacyè‹±æ–‡æ¨¡å‹</span></span><br><span class="line">nlp = spacy.load(en_model_path)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">basic_text_features</span>(<span class="params">script</span>):</span><br><span class="line">    <span class="comment"># åˆ†è¯</span></span><br><span class="line">    words = word_tokenize(script)</span><br><span class="line">    <span class="comment"># å»é™¤åœç”¨è¯</span></span><br><span class="line">    stop_words = <span class="built_in">set</span>(stopwords.words(<span class="string">&#x27;english&#x27;</span>))</span><br><span class="line">    filtered_words = [word.lower() <span class="keyword">for</span> word <span class="keyword">in</span> words <span class="keyword">if</span> word.isalnum() <span class="keyword">and</span> word.lower() <span class="keyword">not</span> <span class="keyword">in</span> stop_words]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¯é¢‘ç»Ÿè®¡</span></span><br><span class="line">    word_freq = Counter(filtered_words)</span><br><span class="line">    <span class="keyword">return</span> word_freq</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">syntax_features</span>(<span class="params">script</span>):</span><br><span class="line">    doc = nlp(script)</span><br><span class="line">    pos_tags = [(token.text, token.pos_) <span class="keyword">for</span> token <span class="keyword">in</span> doc]</span><br><span class="line">    dependencies = [(token.text, token.dep_, token.head.text) <span class="keyword">for</span> token <span class="keyword">in</span> doc]</span><br><span class="line">    <span class="keyword">return</span> pos_tags, dependencies</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tfidf_features</span>(<span class="params">scripts</span>):</span><br><span class="line">    vectorizer = TfidfVectorizer()</span><br><span class="line">    X = vectorizer.fit_transform(scripts)</span><br><span class="line">    <span class="keyword">return</span> X, vectorizer.get_feature_names_out()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">topic_modeling</span>(<span class="params">scripts, num_topics=<span class="number">2</span></span>):</span><br><span class="line">    vectorizer = TfidfVectorizer()</span><br><span class="line">    X = vectorizer.fit_transform(scripts)</span><br><span class="line">    lda = LatentDirichletAllocation(n_components=num_topics, random_state=<span class="number">0</span>)</span><br><span class="line">    lda.fit(X)</span><br><span class="line">    <span class="keyword">return</span> lda, vectorizer</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sentiment_analysis</span>(<span class="params">script</span>):</span><br><span class="line">    blob = TextBlob(script)</span><br><span class="line">    sentiment = blob.sentiment</span><br><span class="line">    <span class="keyword">return</span> sentiment.polarity, sentiment.subjectivity</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dialogue_features</span>(<span class="params">script</span>):</span><br><span class="line">    <span class="comment"># æ”¹è¿›æ­£åˆ™è¡¨è¾¾å¼ï¼Œé€‚åº”ä¸­æ–‡å’Œè‹±æ–‡å¼•å·</span></span><br><span class="line">    dialogues = re.findall(<span class="string">r&#x27;[&quot;â€œâ€](.*?)[â€&quot;]&#x27;</span>, script)</span><br><span class="line">    <span class="keyword">return</span> dialogues</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_script</span>(<span class="params">file_path</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(file_path):</span><br><span class="line">        <span class="keyword">raise</span> FileNotFoundError(<span class="string">f&quot;File <span class="subst">&#123;file_path&#125;</span> not found.&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">            <span class="keyword">return</span> file.read()</span><br><span class="line">    <span class="keyword">except</span> PermissionError:</span><br><span class="line">        <span class="keyword">raise</span> PermissionError(<span class="string">f&quot;Permission denied to read the file <span class="subst">&#123;file_path&#125;</span>. Please check file permissions.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    file_path = <span class="string">r&#x27;D:\pythonProject\LE-SEO.doc&#x27;</span>  </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        script = read_script(file_path)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># åŸºæœ¬æ–‡æœ¬ç‰¹å¾æå–</span></span><br><span class="line">        word_freq = basic_text_features(script)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Basic Text Features (Word Frequency):&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(word_freq)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¯­æ³•ç‰¹å¾æå–</span></span><br><span class="line">        pos_tags, dependencies = syntax_features(script)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\nSyntax Features (POS Tags and Dependencies):&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;POS Tags:&quot;</span>, pos_tags)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Dependencies:&quot;</span>, dependencies)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¯­ä¹‰ç‰¹å¾æå–ï¼ˆTF-IDFï¼‰</span></span><br><span class="line">        scripts_list = [script]  <span class="comment"># å¦‚æœéœ€è¦åˆ†æå¤šä¸ªè„šæœ¬ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ </span></span><br><span class="line">        X, feature_names = tfidf_features(scripts_list)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\nTF-IDF Features:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(X.toarray())</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Feature Names:&quot;</span>, feature_names)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä¸»é¢˜å»ºæ¨¡ï¼ˆLDAï¼‰</span></span><br><span class="line">        lda, vectorizer = topic_modeling(scripts_list)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\nTopic Modeling (LDA):&quot;</span>)</span><br><span class="line">        <span class="comment"># æ‰“å°æ¯ä¸ªä¸»é¢˜çš„å‰å‡ ä¸ªå•è¯</span></span><br><span class="line">        <span class="keyword">for</span> topic_idx, topic <span class="keyword">in</span> <span class="built_in">enumerate</span>(lda.components_):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Topic #<span class="subst">&#123;topic_idx&#125;</span>:&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>([feature_names[i] <span class="keyword">for</span> i <span class="keyword">in</span> topic.argsort()[:-<span class="number">10</span> - <span class="number">1</span>:-<span class="number">1</span>]])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æƒ…æ„Ÿåˆ†æ</span></span><br><span class="line">        polarity, subjectivity = sentiment_analysis(script)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\nSentiment Analysis:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Polarity: <span class="subst">&#123;polarity&#125;</span>, Subjectivity: <span class="subst">&#123;subjectivity&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å¯¹è¯ç‰¹å¾æå–</span></span><br><span class="line">        dialogues = dialogue_features(script)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\nDialogue Features:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(dialogues)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;An error occurred: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="See">See</h2><ul><li><a href="https://www.nltk.org/">https://www.nltk.org/</a></li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> nlp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nlp scapy use</title>
      <link href="/2024/11/21/npl_scapy/"/>
      <url>/2024/11/21/npl_scapy/</url>
      
        <content type="html"><![CDATA[<h1>nlp scapy use</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pip install spacy</span><br><span class="line">python -m spacy download zh_core_web_sm</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">zä¸­ç­‰</span></span><br><span class="line">python -m spacy download zh-core-web-md</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">å¤§è¯­è¨€æ¨¡å‹</span></span><br><span class="line">python -m spacy download zh-core-web-lg</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ’ä»¶ æ”¯æŒ</span></span><br><span class="line">pip install &quot;spacy-pkuseg&lt;2.0.0,&gt;=1.0.0&quot; </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">add run</span> </span><br><span class="line">pip install &quot;spacy-pkuseg&gt;=0.0.27,&lt;0.1.0&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">or</span></span><br><span class="line">pip uninstall spacy-pkuseg</span><br><span class="line">pip install spacy-pkuseg==1.0.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">or</span></span><br><span class="line">pip uninstall spacy zh-core-web-sm spacy-pkuseg</span><br><span class="line">pip install spacy</span><br><span class="line">pip install zh-core-web-sm</span><br><span class="line">pip install &quot;spacy-pkuseg&gt;=1.0.0,&lt;2.0.0&quot;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python -m spacy download en_core_web_sm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="use">use</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># english</span></span><br><span class="line"><span class="keyword">import</span> spacy</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½ä¸‹è½½çš„æ¨¡å‹</span></span><br><span class="line">nlp = spacy.load(<span class="string">&#x27;en_core_web_sm&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤„ç†æ–‡æœ¬</span></span><br><span class="line">doc = nlp(<span class="string">&quot;Hello, how are you?&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> token <span class="keyword">in</span> doc:</span><br><span class="line">    <span class="built_in">print</span>(token.text, token.pos_)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># chinese</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> spacy</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½ä¸­æ–‡æ¨¡å‹</span></span><br><span class="line">nlp = spacy.load(<span class="string">&#x27;zh_core_web_sm&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_dialogue_with_spacy_chinese</span>(<span class="params">text</span>):</span><br><span class="line">    doc = nlp(text)</span><br><span class="line">    dialogues = []</span><br><span class="line">    current_speaker = <span class="literal">None</span></span><br><span class="line">    current_dialogue = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> sent <span class="keyword">in</span> doc.sents:</span><br><span class="line">        <span class="keyword">for</span> ent <span class="keyword">in</span> sent.ents:</span><br><span class="line">            <span class="keyword">if</span> ent.label_ == <span class="string">&quot;PERSON&quot;</span>:</span><br><span class="line">                <span class="comment"># å‡è®¾å®ä½“æ ‡ç­¾ä¸ºâ€œPERSONâ€è¡¨ç¤ºäººç‰©</span></span><br><span class="line">                <span class="keyword">if</span> current_speaker:  <span class="comment"># å¦‚æœä¹‹å‰æœ‰ä¸€ä¸ªäººç‰©ï¼Œè®°å½•å¯¹è¯</span></span><br><span class="line">                    dialogues.append((current_speaker, <span class="string">&quot; &quot;</span>.join(current_dialogue)))</span><br><span class="line">                current_speaker = ent.text</span><br><span class="line">                current_dialogue = []</span><br><span class="line">                <span class="keyword">break</span>  <span class="comment"># è·³åˆ°ä¸‹ä¸€ä¸ªå¥å­</span></span><br><span class="line">        <span class="keyword">if</span> current_speaker:</span><br><span class="line">            current_dialogue.append(sent.text.strip())</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> current_dialogue:</span><br><span class="line">        dialogues.append((current_speaker, <span class="string">&quot; &quot;</span>.join(current_dialogue)))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> dialogues</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹æ–‡æœ¬</span></span><br><span class="line">script = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">å¼ ä¸‰: ä½ å¥½å—ï¼Ÿ</span></span><br><span class="line"><span class="string">æå››: æˆ‘å¾ˆå¥½ï¼Œè°¢è°¢ï¼</span></span><br><span class="line"><span class="string">å¼ ä¸‰: å¤ªå¥½äº†ï¼</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">dialogues = extract_dialogue_with_spacy_chinese(script)</span><br><span class="line"><span class="keyword">for</span> character, line <span class="keyword">in</span> dialogues:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;äººç‰©: <span class="subst">&#123;character&#125;</span>, å¯¹è¯: <span class="subst">&#123;line&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> nlp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>yolov5s æ¨¡å‹è¯†åˆ«äººè„¸</title>
      <link href="/2024/11/21/yolo_user_face_recognized/"/>
      <url>/2024/11/21/yolo_user_face_recognized/</url>
      
        <content type="html"><![CDATA[<h1>yolov5s æ¨¡å‹è¯†åˆ«äººè„¸</h1><h2 id="ç®€ä»‹">ç®€ä»‹</h2><blockquote><p>YOLOï¼ˆYou Only Look Onceï¼‰æ˜¯ä¸€ä¸ªå¹¿æ³›ä½¿ç”¨çš„å®æ—¶ç›®æ ‡æ£€æµ‹ç®—æ³•ï¼Œå®ƒèƒ½å¤Ÿåœ¨å›¾ç‰‡æˆ–è§†é¢‘ä¸­å¿«é€Ÿæ£€æµ‹åˆ°ç›®æ ‡å¹¶è¿›è¡Œåˆ†ç±»ã€‚YOLO çš„ä¼˜ç‚¹åœ¨äºå…¶é€Ÿåº¦å’Œå‡†ç¡®åº¦ï¼Œèƒ½å¤Ÿåœ¨å•ä¸ªå‰å‘ä¼ æ’­ä¸­åŒæ—¶è¿›è¡Œç›®æ ‡å®šä½å’Œåˆ†ç±»ï¼Œä»è€Œå®ç°å®æ—¶ç›®æ ‡æ£€æµ‹ã€‚YOLO åœ¨è®¸å¤šåº”ç”¨åœºæ™¯ä¸­éƒ½æœ‰å¾ˆå¥½çš„è¡¨ç°ï¼ŒåŒ…æ‹¬è‡ªåŠ¨é©¾é©¶ã€è§†é¢‘ç›‘æ§ã€æ— äººæœºå·¡æ£€ç­‰ã€‚</p></blockquote><h2 id="ç‰¹ç‚¹">ç‰¹ç‚¹</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">YOLO é€šè¿‡ä»¥ä¸‹æ­¥éª¤è¿›è¡Œç›®æ ‡æ£€æµ‹ï¼š</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">è¾“å…¥å›¾åƒ: å°†è¾“å…¥å›¾åƒåˆ†å‰²æˆç½‘æ ¼ï¼Œå¹¶ä¸ºæ¯ä¸ªç½‘æ ¼é¢„æµ‹ä¸€ä¸ªè¾¹ç•Œæ¡†å’Œå¯¹åº”çš„ç±»æ¦‚ç‡ã€‚</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ç›®æ ‡æ£€æµ‹: æ¯ä¸ªç½‘æ ¼é¢„æµ‹ä¸€ä¸ªè¾¹ç•Œæ¡†ï¼ŒåŒ…å«ä½ç½®ï¼ˆx, y, w, hï¼‰å’Œç±»åˆ«æ¦‚ç‡ã€‚ç½‘ç»œè¿˜é¢„æµ‹æ˜¯å¦å­˜åœ¨ç›®æ ‡ã€‚</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">éæå¤§å€¼æŠ‘åˆ¶ï¼ˆNMSï¼‰: é€šè¿‡ NMS å»é™¤å†—ä½™çš„æ£€æµ‹ç»“æœï¼Œä»…ä¿ç•™æœ€æœ‰å¯èƒ½çš„è¾¹ç•Œæ¡†ã€‚</span></span><br></pre></td></tr></table></figure><h2 id="å®‰è£…ä½¿ç”¨">å®‰è£…ä½¿ç”¨</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">pip install torch</span><br><span class="line">pip install cv2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">or</span></span><br><span class="line"></span><br><span class="line">pip install torch torchvision torchaudio</span><br><span class="line">pip install yolov5</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="demo">demo</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®å‚æ•°</span></span><br><span class="line">MODEL_NAME = <span class="string">&#x27;yolov5s&#x27;</span>  <span class="comment"># ä½¿ç”¨ YOLOv5s æ¨¡å‹ï¼Œå¯æ ¹æ®éœ€æ±‚é€‰æ‹© yolov5m, yolov5l, yolov5x</span></span><br><span class="line">COCO_NAMES = <span class="string">r&quot;C:\Users\DELL\PycharmProjects\audio_record_server\src\config\coco.names&quot;</span></span><br><span class="line">DETECTED_HUMANS_DIR = <span class="string">r&quot;E:&quot;</span>  <span class="comment"># å­˜æ”¾æ£€æµ‹åˆ°äººçš„è§†é¢‘</span></span><br><span class="line">BATCH_SIZE = <span class="number">5</span>  <span class="comment"># æ¯æ‰¹å¤„ç†è§†é¢‘æ•°</span></span><br><span class="line">THREAD_COUNT = <span class="number">4</span>  <span class="comment"># çº¿ç¨‹æ•°é‡</span></span><br><span class="line">INTERVAL_DURATION_SECONDS = <span class="number">60</span>  <span class="comment"># æ¯ä¸ªæ£€æµ‹æ®µçš„æ—¶é•¿ï¼ˆç§’ï¼‰</span></span><br><span class="line">DETECTION_COUNT_PER_INTERVAL = <span class="number">10</span>  <span class="comment"># æ¯ä¸ª3åˆ†é’Ÿæ®µçš„æ£€æµ‹æ¬¡æ•°</span></span><br><span class="line">DETECTION_THRESHOLD = <span class="number">1</span>  <span class="comment"># æ¯ä¸ª3åˆ†é’Ÿæ®µçš„æ£€æµ‹é˜ˆå€¼</span></span><br><span class="line">MIN_CONFIDENCE = <span class="number">0.7</span>  <span class="comment"># æ£€æµ‹ç½®ä¿¡åº¦é˜ˆå€¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># çº¿ç¨‹é”</span></span><br><span class="line">model_lock = threading.Lock()</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœç›®æ ‡ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºå®ƒ</span></span><br><span class="line">os.makedirs(DETECTED_HUMANS_DIR, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½ç±»åˆ«åç§°</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(COCO_NAMES, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    classes = [line.strip() <span class="keyword">for</span> line <span class="keyword">in</span> f.readlines()]</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–æ—¥å¿—</span></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    filename=<span class="string">&#x27;log.log&#x27;</span>,</span><br><span class="line">    level=logging.INFO,</span><br><span class="line">    <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(levelname)s - %(message)s&#x27;</span>,</span><br><span class="line">    filemode=<span class="string">&#x27;w&#x27;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_output_dir</span>(<span class="params">output_dir</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åˆ›å»ºè¾“å‡ºç›®å½•&quot;&quot;&quot;</span></span><br><span class="line">    os.makedirs(output_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_model</span>(<span class="params">model_name=<span class="string">&#x27;yolov5s&#x27;</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åŠ è½½YOLOv5æ¨¡å‹ï¼Œè¿”å›æ¨¡å‹å¯¹è±¡&quot;&quot;&quot;</span></span><br><span class="line">    model = torch.hub.load(<span class="string">&#x27;ultralytics/yolov5&#x27;</span>, model_name, pretrained=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># è®¾ç½®æ¨¡å‹ä¸ºè¯„ä¼°æ¨¡å¼</span></span><br><span class="line">    model.<span class="built_in">eval</span>()</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_random_detection_times</span>(<span class="params">start_sec, end_sec, detection_count</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    åœ¨[start_sec, end_sec)åŒºé—´å†…ç”Ÿæˆéšæœºçš„æ£€æµ‹æ—¶é—´ç‚¹ï¼ˆç§’ï¼‰ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> end_sec &lt;= start_sec:</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">return</span> [random.uniform(start_sec, end_sec) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(detection_count)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detect_person_many</span>(<span class="params">model, frame</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    å¯¹å•å¸§å›¾åƒè¿›è¡Œäººæ£€æµ‹ï¼Œè¿”å›æ˜¯å¦ä»…æ£€æµ‹åˆ°ä¸€ä¸ªäººã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    results = model(frame)</span><br><span class="line">    <span class="comment"># è§£ææ£€æµ‹ç»“æœ</span></span><br><span class="line">    detections = results.xyxy[<span class="number">0</span>]  <span class="comment"># [xmin, ymin, xmax, ymax, confidence, class]</span></span><br><span class="line">    person_count = <span class="number">0</span>  <span class="comment"># è®°å½•æ£€æµ‹åˆ°çš„äººæ•°</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> *box, confidence, cls <span class="keyword">in</span> detections:</span><br><span class="line">        <span class="keyword">if</span> confidence &gt;= MIN_CONFIDENCE <span class="keyword">and</span> classes[<span class="built_in">int</span>(cls)].lower() == <span class="string">&quot;person&quot;</span>:</span><br><span class="line">            person_count += <span class="number">1</span></span><br><span class="line">            <span class="comment"># å¦‚æœæ£€æµ‹åˆ°è¶…è¿‡ä¸€ä¸ªäººï¼Œç›´æ¥è¿”å› False</span></span><br><span class="line">            <span class="keyword">if</span> person_count &gt; <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¦‚æœæ£€æµ‹åˆ°æ­£å¥½ä¸€ä¸ªäººï¼Œè¿”å› True</span></span><br><span class="line">    <span class="keyword">return</span> person_count == <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detect_person</span>(<span class="params">model, frame</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    å¯¹å•å¸§å›¾åƒè¿›è¡Œäººæ£€æµ‹ï¼Œè¿”å›æ˜¯å¦æ£€æµ‹åˆ°äººçš„å¸ƒå°”å€¼ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    results = model(frame)</span><br><span class="line">    <span class="comment"># è§£ææ£€æµ‹ç»“æœ</span></span><br><span class="line">    detections = results.xyxy[<span class="number">0</span>]  <span class="comment"># [xmin, ymin, xmax, ymax, confidence, class]</span></span><br><span class="line">    person_detected = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">for</span> *box, confidence, cls <span class="keyword">in</span> detections:</span><br><span class="line">        <span class="keyword">if</span> confidence &gt;= MIN_CONFIDENCE <span class="keyword">and</span> classes[<span class="built_in">int</span>(cls)].lower() == <span class="string">&quot;person&quot;</span>:</span><br><span class="line">            person_detected = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> person_detected</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detect_person_in_video</span>(<span class="params">video_path, model</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¤„ç†å•ä¸ªè§†é¢‘ï¼ŒæŒ‰ç…§æ¯3åˆ†é’Ÿæ®µè¿›è¡Œäººæ£€æµ‹&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        logging.info(<span class="string">f&quot;å¼€å§‹å¤„ç†è§†é¢‘: <span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;å¼€å§‹å¤„ç†è§†é¢‘: <span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line">        cap = cv2.VideoCapture(video_path)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> cap.isOpened():</span><br><span class="line">            logging.error(<span class="string">f&quot;æ— æ³•æ‰“å¼€è§†é¢‘æ–‡ä»¶: <span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;æ— æ³•æ‰“å¼€è§†é¢‘æ–‡ä»¶: <span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        width = <span class="built_in">int</span>(cap.get(cv2.CAP_PROP_FRAME_WIDTH))</span><br><span class="line">        height = <span class="built_in">int</span>(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))</span><br><span class="line">        fps = cap.get(cv2.CAP_PROP_FPS)</span><br><span class="line">        total_frames = <span class="built_in">int</span>(cap.get(cv2.CAP_PROP_FRAME_COUNT))</span><br><span class="line">        total_seconds = total_frames / fps <span class="keyword">if</span> fps <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">        logging.info(<span class="string">f&quot;è§†é¢‘ä¿¡æ¯ - å®½åº¦: <span class="subst">&#123;width&#125;</span>, é«˜åº¦: <span class="subst">&#123;height&#125;</span>, å¸§ç‡: <span class="subst">&#123;fps&#125;</span>, æ€»æ—¶é•¿: <span class="subst">&#123;total_seconds:<span class="number">.2</span>f&#125;</span> ç§’&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;è§†é¢‘ä¿¡æ¯ - å®½åº¦: <span class="subst">&#123;width&#125;</span>, é«˜åº¦: <span class="subst">&#123;height&#125;</span>, å¸§ç‡: <span class="subst">&#123;fps&#125;</span>, æ€»æ—¶é•¿: <span class="subst">&#123;total_seconds:<span class="number">.2</span>f&#125;</span> ç§’&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> total_seconds &lt;= <span class="number">0</span>:</span><br><span class="line">            logging.error(<span class="string">f&quot;è§†é¢‘æ—¶é•¿æ— æ•ˆ: <span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;è§†é¢‘æ—¶é•¿æ— æ•ˆ: <span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line">            cap.release()</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># è®¡ç®—3åˆ†é’Ÿæ®µæ•°</span></span><br><span class="line">        num_intervals = <span class="built_in">int</span>(total_seconds // INTERVAL_DURATION_SECONDS)</span><br><span class="line">        <span class="keyword">if</span> num_intervals == <span class="number">0</span>:</span><br><span class="line">            logging.error(<span class="string">f&quot;è§†é¢‘æ—¶é•¿ä¸è¶³3åˆ†é’Ÿ: <span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;è§†é¢‘æ—¶é•¿ä¸è¶³3åˆ†é’Ÿ: <span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line">            cap.release()</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        passed_segments = <span class="number">0</span>  <span class="comment"># é€šè¿‡æ£€æµ‹çš„æ®µæ•°</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># é€æ®µæ£€æµ‹</span></span><br><span class="line">        <span class="keyword">for</span> interval_idx <span class="keyword">in</span> <span class="built_in">range</span>(num_intervals):</span><br><span class="line">            <span class="keyword">if</span> passed_segments &gt;= <span class="number">3</span>:</span><br><span class="line">                <span class="comment"># å·²ç»æœ‰è¶³å¤Ÿçš„æ®µé€šè¿‡ï¼Œæå‰ç»“æŸ</span></span><br><span class="line">                logging.info(<span class="string">f&quot;å·²è¾¾åˆ°è¶³å¤Ÿçš„é€šè¿‡æ®µæ•° (<span class="subst">&#123;passed_segments&#125;</span>)ï¼Œæå‰ç»“æŸæ£€æµ‹&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;å·²è¾¾åˆ°è¶³å¤Ÿçš„é€šè¿‡æ®µæ•° (<span class="subst">&#123;passed_segments&#125;</span>)ï¼Œæå‰ç»“æŸæ£€æµ‹&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            interval_start = interval_idx * INTERVAL_DURATION_SECONDS</span><br><span class="line">            interval_end = (interval_idx + <span class="number">1</span>) * INTERVAL_DURATION_SECONDS</span><br><span class="line">            detection_times = get_random_detection_times(interval_start, interval_end, DETECTION_COUNT_PER_INTERVAL)</span><br><span class="line">            logging.info(<span class="string">f&quot;æ®µ <span class="subst">&#123;interval_idx + <span class="number">1</span>&#125;</span>/<span class="subst">&#123;num_intervals&#125;</span> æ£€æµ‹æ—¶é—´ç‚¹ï¼ˆç§’ï¼‰: <span class="subst">&#123;detection_times&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;æ®µ <span class="subst">&#123;interval_idx + <span class="number">1</span>&#125;</span>/<span class="subst">&#123;num_intervals&#125;</span> æ£€æµ‹æ—¶é—´ç‚¹ï¼ˆç§’ï¼‰: <span class="subst">&#123;detection_times&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            detections = <span class="number">0</span>  <span class="comment"># æ£€æµ‹åˆ°äººçš„æ¬¡æ•°</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> detection_time <span class="keyword">in</span> detection_times:</span><br><span class="line">                frame_number = <span class="built_in">int</span>(detection_time * fps)</span><br><span class="line">                cap.<span class="built_in">set</span>(cv2.CAP_PROP_POS_FRAMES, frame_number)</span><br><span class="line">                ret, frame = cap.read()</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> ret:</span><br><span class="line">                    logging.warning(<span class="string">f&quot;æ— æ³•è¯»å–è§†é¢‘ <span class="subst">&#123;video_path&#125;</span> çš„ç¬¬ <span class="subst">&#123;frame_number&#125;</span> å¸§&quot;</span>)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;æ— æ³•è¯»å–è§†é¢‘ <span class="subst">&#123;video_path&#125;</span> çš„ç¬¬ <span class="subst">&#123;frame_number&#125;</span> å¸§&quot;</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># ç¡®ä¿å¸§å†…å®¹æœ‰æ•ˆ</span></span><br><span class="line">                <span class="keyword">if</span> frame <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> frame.size == <span class="number">0</span>:</span><br><span class="line">                    logging.warning(<span class="string">f&quot;è¯»å–åˆ°ç©ºå¸§ï¼Œåœ¨æ—¶é—´ <span class="subst">&#123;detection_time:<span class="number">.2</span>f&#125;</span> ç§’&quot;</span>)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;è¯»å–åˆ°ç©ºå¸§ï¼Œåœ¨æ—¶é—´ <span class="subst">&#123;detection_time:<span class="number">.2</span>f&#125;</span> ç§’&quot;</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># ä½¿ç”¨é”ç¡®ä¿çº¿ç¨‹å®‰å…¨</span></span><br><span class="line">                <span class="keyword">with</span> model_lock:</span><br><span class="line">                    person_detected = detect_person_many(model, frame)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> person_detected:</span><br><span class="line">                    detections += <span class="number">1</span></span><br><span class="line">                    logging.info(<span class="string">f&quot;æ£€æµ‹åˆ°äººï¼Œåœ¨æ—¶é—´ <span class="subst">&#123;detection_time:<span class="number">.2</span>f&#125;</span> ç§’&quot;</span>)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;æ£€æµ‹åˆ°äººï¼Œåœ¨æ—¶é—´ <span class="subst">&#123;detection_time:<span class="number">.2</span>f&#125;</span> ç§’&quot;</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    logging.info(<span class="string">f&quot;æœªæ£€æµ‹åˆ°äººï¼Œåœ¨æ—¶é—´ <span class="subst">&#123;detection_time:<span class="number">.2</span>f&#125;</span> ç§’&quot;</span>)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;æœªæ£€æµ‹åˆ°äººï¼Œåœ¨æ—¶é—´ <span class="subst">&#123;detection_time:<span class="number">.2</span>f&#125;</span> ç§’&quot;</span>)</span><br><span class="line"></span><br><span class="line">            logging.info(<span class="string">f&quot;æ®µ <span class="subst">&#123;interval_idx + <span class="number">1</span>&#125;</span>/<span class="subst">&#123;num_intervals&#125;</span> æ£€æµ‹åˆ°äººæ¬¡æ•°: <span class="subst">&#123;detections&#125;</span>/<span class="subst">&#123;DETECTION_COUNT_PER_INTERVAL&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;æ®µ <span class="subst">&#123;interval_idx + <span class="number">1</span>&#125;</span>/<span class="subst">&#123;num_intervals&#125;</span> æ£€æµ‹åˆ°äººæ¬¡æ•°: <span class="subst">&#123;detections&#125;</span>/<span class="subst">&#123;DETECTION_COUNT_PER_INTERVAL&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> detections == DETECTION_THRESHOLD:</span><br><span class="line">                passed_segments += <span class="number">1</span></span><br><span class="line">                logging.info(<span class="string">f&quot;æ®µ <span class="subst">&#123;interval_idx + <span class="number">1</span>&#125;</span> é€šè¿‡æ£€æµ‹ï¼Œå½“å‰é€šè¿‡æ®µæ•°: <span class="subst">&#123;passed_segments&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;æ®µ <span class="subst">&#123;interval_idx + <span class="number">1</span>&#125;</span> é€šè¿‡æ£€æµ‹ï¼Œå½“å‰é€šè¿‡æ®µæ•°: <span class="subst">&#123;passed_segments&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                logging.info(<span class="string">f&quot;æ®µ <span class="subst">&#123;interval_idx + <span class="number">1</span>&#125;</span> æœªè¾¾åˆ°æ£€æµ‹é˜ˆå€¼&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;æ®µ <span class="subst">&#123;interval_idx + <span class="number">1</span>&#125;</span> æœªè¾¾åˆ°æ£€æµ‹é˜ˆå€¼&quot;</span>)</span><br><span class="line"></span><br><span class="line">        cap.release()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> passed_segments &gt;= <span class="number">3</span>:</span><br><span class="line">            logging.info(<span class="string">f&quot;è§†é¢‘å¤„ç†å®Œæˆä¸”ç¬¦åˆè¦æ±‚ï¼ˆé€šè¿‡æ®µæ•°: <span class="subst">&#123;passed_segments&#125;</span>ï¼‰: <span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;è§†é¢‘å¤„ç†å®Œæˆä¸”ç¬¦åˆè¦æ±‚ï¼ˆé€šè¿‡æ®µæ•°: <span class="subst">&#123;passed_segments&#125;</span>ï¼‰: <span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span>  <span class="comment"># ç¬¦åˆè¦æ±‚</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logging.info(<span class="string">f&quot;è§†é¢‘å¤„ç†å®Œæˆä½†ä¸ç¬¦åˆè¦æ±‚ï¼ˆé€šè¿‡æ®µæ•°: <span class="subst">&#123;passed_segments&#125;</span>ï¼‰: <span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;è§†é¢‘å¤„ç†å®Œæˆä½†ä¸ç¬¦åˆè¦æ±‚ï¼ˆé€šè¿‡æ®µæ•°: <span class="subst">&#123;passed_segments&#125;</span>ï¼‰: <span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span>  <span class="comment"># ä¸ç¬¦åˆè¦æ±‚</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;å¤„ç†è§†é¢‘æ—¶å‡ºé”™: <span class="subst">&#123;video_path&#125;</span>, é”™è¯¯: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;å¤„ç†è§†é¢‘æ—¶å‡ºé”™: <span class="subst">&#123;video_path&#125;</span>, é”™è¯¯: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_batch</span>(<span class="params">video_files, model</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¤„ç†ä¸€æ‰¹è§†é¢‘æ–‡ä»¶&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> video_file <span class="keyword">in</span> video_files:</span><br><span class="line">        relative_path = os.path.relpath(video_file, <span class="string">r&quot;E:\videoç«–å±_ä½åˆ†è¾¨ç‡&quot;</span>)</span><br><span class="line">        detected_human_dir = os.path.join(DETECTED_HUMANS_DIR, os.path.dirname(relative_path))</span><br><span class="line"></span><br><span class="line">        create_output_dir(detected_human_dir)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> detect_person_in_video(video_file, model):</span><br><span class="line">            logging.info(<span class="string">f&quot;æ£€æµ‹åˆ°äººä¸”ç¬¦åˆè¦æ±‚: <span class="subst">&#123;video_file&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;æ£€æµ‹åˆ°äººä¸”ç¬¦åˆè¦æ±‚: <span class="subst">&#123;video_file&#125;</span>&quot;</span>)</span><br><span class="line">            shutil.move(video_file, os.path.join(detected_human_dir, os.path.basename(video_file)))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logging.info(<span class="string">f&quot;æœªæ£€æµ‹åˆ°äººæˆ–ä¸ç¬¦åˆè¦æ±‚: <span class="subst">&#123;video_file&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;æœªæ£€æµ‹åˆ°äººæˆ–ä¸ç¬¦åˆè¦æ±‚: <span class="subst">&#123;video_file&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    video_files = []</span><br><span class="line">    root_path = <span class="string">r&quot;E:\videoç«–å±_ä½åˆ†è¾¨ç‡&quot;</span></span><br><span class="line">    root = Path(root_path).resolve()</span><br><span class="line">    exclude_dirs = &#123;<span class="string">&#x27;$RECYCLE.BIN&#x27;</span>, <span class="string">&#x27;System Volume Information&#x27;</span>, <span class="string">&#x27;Windows&#x27;</span>, <span class="string">&#x27;Program Files&#x27;</span>, <span class="string">&#x27;Program Files (x86)&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">    logging.info(<span class="string">f&quot;å¼€å§‹æŸ¥æ‰¾ç›®å½• <span class="subst">&#123;root_path&#125;</span> ä¸‹çš„è§†é¢‘æ–‡ä»¶&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;å¼€å§‹æŸ¥æ‰¾ç›®å½• <span class="subst">&#123;root_path&#125;</span> ä¸‹çš„è§†é¢‘æ–‡ä»¶&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> extension <span class="keyword">in</span> (<span class="string">&#x27;*.mp4&#x27;</span>, <span class="string">&#x27;*.avi&#x27;</span>, <span class="string">&#x27;*.mov&#x27;</span>, <span class="string">&#x27;*.mkv&#x27;</span>, <span class="string">&#x27;*.m4v&#x27;</span>, <span class="string">&#x27;*.WMV&#x27;</span>, <span class="string">&#x27;*.rmvb&#x27;</span>, <span class="string">&#x27;*.DAT&#x27;</span>, <span class="string">&#x27;*.VOB&#x27;</span>):</span><br><span class="line">        video_files += [</span><br><span class="line">            <span class="built_in">str</span>(file.resolve()) <span class="keyword">for</span> file <span class="keyword">in</span> root.rglob(extension)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">any</span>(excluded.lower() <span class="keyword">in</span> (part.lower() <span class="keyword">for</span> part <span class="keyword">in</span> file.parts) <span class="keyword">for</span> excluded <span class="keyword">in</span> exclude_dirs)</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> video_files:</span><br><span class="line">        logging.error(<span class="string">&quot;æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶&quot;</span>)</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åŠ è½½æ¨¡å‹ï¼ˆåœ¨ä¸»çº¿ç¨‹ä¸­åŠ è½½ä¸€æ¬¡æ¨¡å‹ï¼Œä¾›æ‰€æœ‰çº¿ç¨‹ä½¿ç”¨ï¼‰</span></span><br><span class="line">    model = load_model(MODEL_NAME)</span><br><span class="line"></span><br><span class="line">    start_main_time = time.time()</span><br><span class="line"></span><br><span class="line">    logging.info(<span class="string">f&quot;å¼€å§‹åˆ†æ‰¹å¤„ç†è§†é¢‘ï¼Œå…±æœ‰ <span class="subst">&#123;<span class="built_in">len</span>(video_files)&#125;</span> ä¸ªæ–‡ä»¶ï¼Œæ‰¹æ¬¡å¤§å°ä¸º <span class="subst">&#123;BATCH_SIZE&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;å¼€å§‹åˆ†æ‰¹å¤„ç†è§†é¢‘ï¼Œå…±æœ‰ <span class="subst">&#123;<span class="built_in">len</span>(video_files)&#125;</span> ä¸ªæ–‡ä»¶ï¼Œæ‰¹æ¬¡å¤§å°ä¸º <span class="subst">&#123;BATCH_SIZE&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¤šçº¿ç¨‹å¤„ç†</span></span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(max_workers=THREAD_COUNT) <span class="keyword">as</span> executor:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(video_files), BATCH_SIZE):</span><br><span class="line">            batch = video_files[i:i + BATCH_SIZE]</span><br><span class="line">            executor.submit(process_batch, batch, model)</span><br><span class="line"></span><br><span class="line">    logging.info(<span class="string">f&quot;æ‰€æœ‰è§†é¢‘æ–‡ä»¶å¤„ç†å®Œæˆï¼Œæ€»è€—æ—¶ <span class="subst">&#123;time.time() - start_main_time:<span class="number">.2</span>f&#125;</span> ç§’&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;æ‰€æœ‰è§†é¢‘æ–‡ä»¶å¤„ç†å®Œæˆï¼Œæ€»è€—æ—¶ <span class="subst">&#123;time.time() - start_main_time:<span class="number">.2</span>f&#125;</span> ç§’&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;ä»£ç ä¿®æ”¹è¯¦è§£</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### 1. **æ¨¡å‹åŠ è½½ä¸åˆå§‹åŒ–**</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">YOLOv5 ä½¿ç”¨ PyTorch å®ç°ï¼Œé€šè¿‡ `torch.hub` æ–¹ä¾¿åœ°åŠ è½½æ¨¡å‹ã€‚æˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹ä¸­åŠ è½½ä¸€æ¬¡æ¨¡å‹ï¼Œå¹¶åœ¨æ‰€æœ‰çº¿ç¨‹ä¸­å…±äº«è¯¥æ¨¡å‹å¯¹è±¡ï¼Œä»¥é¿å…é‡å¤åŠ è½½å’ŒèŠ‚çœå†…å­˜ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">def load_model(model_name=&#x27;yolov5s&#x27;):</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;åŠ è½½YOLOv5æ¨¡å‹ï¼Œè¿”å›æ¨¡å‹å¯¹è±¡&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    model = torch.hub.load(&#x27;ultralytics/yolov5&#x27;, model_name, pretrained=True)</span></span><br><span class="line"><span class="string">    # è®¾ç½®æ¨¡å‹ä¸ºè¯„ä¼°æ¨¡å¼</span></span><br><span class="line"><span class="string">    model.eval()</span></span><br><span class="line"><span class="string">    return model</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> yolov5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨js logåº“å’Œpython FastApiå®Œæˆ å¾®ä¿¡å°ç¨‹åºæ—¥å¿—ä¿å­˜ä¸ä¸Šä¼ </title>
      <link href="/2024/11/16/wechat-log-upload/"/>
      <url>/2024/11/16/wechat-log-upload/</url>
      
        <content type="html"><![CDATA[<h1>ä½¿ç”¨js logåº“å’Œpython FastApiå®Œæˆ å¾®ä¿¡å°ç¨‹åºæ—¥å¿—ä¿å­˜ä¸ä¸Šä¼ </h1><h2 id="ç®€ä»‹">ç®€ä»‹</h2><blockquote><p>ä½¿ç”¨log.js é€šè¿‡å®šä¹‰æ—¥å¿—è¾“å‡ºæ ¼å¼ï¼šconsole.log(<code>[$&#123;log.level&#125;] $&#123;log.timestamp&#125;: $&#123;log.message&#125;</code>); è¾“å‡ºæ—¥å¿— é€šè¿‡http postè¯·æ±‚ä¸Šä¼ æ—¥å¿—æ•°æ®åˆ°æœåŠ¡ç«¯</p></blockquote><h2 id="å¾®ä¿¡ç¨‹åºæ—¥å¿—ä¿å­˜ä¸ä¸Šä¼ ">å¾®ä¿¡ç¨‹åºæ—¥å¿—ä¿å­˜ä¸ä¸Šä¼ </h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// log.js - å¾®ä¿¡å°ç¨‹åºæ—¥å¿—åº“</span></span><br><span class="line"><span class="keyword">import</span> admin_url <span class="keyword">from</span> <span class="string">&#x27;@/common/config.js&#x27;</span></span><br><span class="line"><span class="keyword">const</span> user_msg = uni.<span class="title function_">getStorageSync</span>(<span class="string">&quot;token&quot;</span>)</span><br><span class="line"><span class="comment">// log.js</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Logger</span> &#123;</span><br><span class="line"><span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">logs</span> = []; <span class="comment">// å­˜å‚¨æ—¥å¿—è®°å½•çš„æ•°ç»„</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">levels</span> = &#123; <span class="comment">// å®šä¹‰æ—¥å¿—çº§åˆ«</span></span><br><span class="line"><span class="attr">INFO</span>: <span class="string">&#x27;INFO&#x27;</span>,</span><br><span class="line"><span class="attr">DEBUG</span>: <span class="string">&#x27;DEBUG&#x27;</span>,</span><br><span class="line"><span class="attr">ERROR</span>: <span class="string">&#x27;ERROR&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">isDebug</span> = <span class="literal">true</span>; <span class="comment">// æ§åˆ¶æ˜¯å¦åœ¨æ§åˆ¶å°è¾“å‡ºæ—¥å¿—ï¼Œè°ƒè¯•æœŸé—´å¼€å¯</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">uploadEndpoint</span> =<span class="string">&#x27;/api/upload-log&#x27;</span>; <span class="comment">// ä¸Šä¼ æ—¥å¿—çš„æ¥å£åœ°å€</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¼å¼åŒ–æ—¥å¿—</span></span><br><span class="line"><span class="title function_">formatLog</span>(<span class="params">level, message</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line"><span class="attr">level</span>: level,</span><br><span class="line"><span class="attr">message</span>: user_msg + <span class="string">&quot;: &quot;</span> + message,</span><br><span class="line"><span class="attr">timestamp</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toISOString</span>()</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“å°æ—¥å¿—åˆ°æ§åˆ¶å°</span></span><br><span class="line"><span class="title function_">printLog</span>(<span class="params">log</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isDebug</span>) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[<span class="subst">$&#123;log.level&#125;</span>] <span class="subst">$&#123;log.timestamp&#125;</span>: <span class="subst">$&#123;log.message&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®°å½•æ—¥å¿—åˆ°æ•°ç»„</span></span><br><span class="line"><span class="title function_">log</span>(<span class="params">level, message</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> logEntry = <span class="variable language_">this</span>.<span class="title function_">formatLog</span>(level, message);</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">logs</span>.<span class="title function_">push</span>(logEntry);</span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">printLog</span>(logEntry);</span><br><span class="line">wx.<span class="title function_">setStorageSync</span>(<span class="string">&#x27;appLogs&#x27;</span>, <span class="variable language_">this</span>.<span class="property">logs</span>); <span class="comment">// åŒæ­¥å­˜å‚¨åˆ°æœ¬åœ°</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å„çº§åˆ«çš„æ—¥å¿—è®°å½•æ–¹æ³•</span></span><br><span class="line"><span class="title function_">info</span>(<span class="params">message</span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">levels</span>.<span class="property">INFO</span>, message);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">debug</span>(<span class="params">message</span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">levels</span>.<span class="property">DEBUG</span>, message);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">error</span>(<span class="params">message</span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">levels</span>.<span class="property">ERROR</span>, message);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> logger = <span class="keyword">new</span> <span class="title class_">Logger</span>();</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> logger;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="æ—¥å¿—è¾“å‡ºä½¿ç”¨">æ—¥å¿—è¾“å‡ºä½¿ç”¨</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logger <span class="keyword">from</span> <span class="string">&#x27;../log.js&#x27;</span></span><br><span class="line"></span><br><span class="line">logger.<span class="title function_">info</span>(<span class="string">&#x27;è¾“å‡ºç¤ºä¾‹&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="æœåŠ¡ç«¯æ—¥å¿—ä¸Šä¼ æ¥å£å®šä¹‰">æœåŠ¡ç«¯æ—¥å¿—ä¸Šä¼ æ¥å£å®šä¹‰</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="meta">@router.post(<span class="params"><span class="string">&quot;/upload-log&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">upload_log</span>(<span class="params">request: LogUploadRequest</span>):</span><br><span class="line">    logs = request.logs</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> logs:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">&quot;æ—¥å¿—å†…å®¹ä¸èƒ½ä¸ºç©º&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å°†æ—¥å¿—æ•°æ®ä¿å­˜åˆ°æ–‡ä»¶</span></span><br><span class="line">    save_logs_to_file([log.<span class="built_in">dict</span>() <span class="keyword">for</span> log <span class="keyword">in</span> logs])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;success&quot;</span>, <span class="string">&quot;message&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">len</span>(logs)&#125;</span>æ¡æ—¥å¿—å·²ä¸Šä¼ &quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ—¥å¿—å­˜å‚¨æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"></span><br><span class="line">LOG_FILE_PATH = <span class="string">&quot;wechat_logs.log&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–å½“å‰æ—¶é—´ï¼Œå¹¶æ ¼å¼åŒ–ä¸ºæŒ‡å®šæ ¼å¼</span></span><br><span class="line">current_timestamp = datetime.now().strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S.%f&quot;</span>)[:-<span class="number">3</span>]</span><br><span class="line"><span class="comment"># print(current_timestamp)</span></span><br><span class="line"></span><br><span class="line">file_name = <span class="built_in">str</span>(uuid.uuid4()) + current_timestamp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># å†™å…¥æ—¥å¿—åˆ°æ–‡ä»¶</span></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_logs_to_file</span>(<span class="params">logs: <span class="type">List</span>[<span class="type">Dict</span>]</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;/wechat_logs/&quot;</span> + LOG_FILE_PATH + <span class="string">&quot;_&quot;</span> + file_name, <span class="string">&quot;a&quot;</span>) <span class="keyword">as</span> log_file:</span><br><span class="line">            <span class="keyword">for</span> log <span class="keyword">in</span> logs:</span><br><span class="line">                log_file.write(json.dumps(log) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;æ—¥å¿—ä¿å­˜åˆ°æ–‡ä»¶å¤±è´¥: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="å¾®ä¿¡å°ç¨‹åºè°ƒç”¨apiä¸Šä¼ log">å¾®ä¿¡å°ç¨‹åºè°ƒç”¨apiä¸Šä¼ log</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// æ‰¹é‡ä¸Šä¼ æ—¥å¿—åˆ°æœåŠ¡å™¨</span></span><br><span class="line"><span class="title function_">uploadLogs</span>(<span class="params">api</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> logsToUpload = wx.<span class="title function_">getStorageSync</span>(<span class="string">&#x27;appLogs&#x27;</span>) || [];</span><br><span class="line"><span class="keyword">if</span> (logsToUpload.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">wx.<span class="title function_">request</span>(&#123;</span><br><span class="line"><span class="attr">url</span>:  api + <span class="variable language_">this</span>.<span class="property">uploadEndpoint</span>,</span><br><span class="line"><span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line"><span class="attr">data</span>: &#123;</span><br><span class="line"><span class="attr">logs</span>: logsToUpload</span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">header</span>: &#123;</span><br><span class="line"><span class="string">&#x27;content-type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">success</span>: <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;æ—¥å¿—ä¸Šä¼ æˆåŠŸ&quot;</span>, res.<span class="property">data</span>);</span><br><span class="line">wx.<span class="title function_">removeStorageSync</span>(<span class="string">&#x27;appLogs&#x27;</span>); <span class="comment">// ä¸Šä¼ æˆåŠŸåæ¸…ç©ºæœ¬åœ°å­˜å‚¨çš„æ—¥å¿—</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">fail</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;æ—¥å¿—ä¸Šä¼ å¤±è´¥&quot;</span>, err);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="è¾“å‡ºç»“æœç¤ºä¾‹">è¾“å‡ºç»“æœç¤ºä¾‹</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;level&quot;: &quot;DEBUG&quot;, &quot;message&quot;: &quot;obGGb7aolzF2Tm0FaO0rn4gik1WQ: [object Object]&quot;, &quot;timestamp&quot;: &quot;2024-11-11T09:02:26.322Z&quot;&#125;</span><br><span class="line">&#123;&quot;level&quot;: &quot;DEBUG&quot;, &quot;message&quot;: &quot;obGGb7aolzF2Tm0FaO0rn4gik1WQ: start select user login msg&quot;, &quot;timestamp&quot;: &quot;2024-11-11T09:02:26.325Z&quot;&#125;</span><br><span class="line">&#123;&quot;level&quot;: &quot;DEBUG&quot;, &quot;message&quot;: &quot;obGGb7aolzF2Tm0FaO0rn4gik1WQ: [object Object]&quot;, &quot;timestamp&quot;: &quot;2024-11-11T09:02:26.520Z&quot;&#125;</span><br><span class="line">&#123;&quot;level&quot;: &quot;DEBUG&quot;, &quot;message&quot;: &quot;obGGb7aolzF2Tm0FaO0rn4gik1WQ: start select user login msg&quot;, &quot;timestamp&quot;: &quot;2024-11-11T09:02:26.523Z&quot;&#125;</span><br><span class="line">&#123;&quot;level&quot;: &quot;DEBUG&quot;, &quot;message&quot;: &quot;obGGb7aolzF2Tm0FaO0rn4gik1WQ: [object Object]&quot;, &quot;timestamp&quot;: &quot;2024-11-11T09:02:26.593Z&quot;&#125;</span><br><span class="line">&#123;&quot;level&quot;: &quot;DEBUG&quot;, &quot;message&quot;: &quot;obGGb7aolzF2Tm0FaO0rn4gik1WQ: [object Object]&quot;, &quot;timestamp&quot;: &quot;2024-11-11T09:02:26.706Z&quot;&#125;</span><br><span class="line">&#123;&quot;level&quot;: &quot;DEBUG&quot;, &quot;message&quot;: &quot;obGGb7aolzF2Tm0FaO0rn4gik1WQ: [object Object]&quot;, &quot;timestamp&quot;: &quot;2024-11-11T09:05:19.227Z&quot;&#125;</span><br><span class="line">&#123;&quot;level&quot;: &quot;DEBUG&quot;, &quot;message&quot;: &quot;obGGb7aolzF2Tm0FaO0rn4gik1WQ: start select user login msg&quot;, &quot;timestamp&quot;: &quot;2024-11-11T09:05:19.235Z&quot;&#125;</span><br><span class="line">&#123;&quot;level&quot;: &quot;DEBUG&quot;, &quot;message&quot;: &quot;obGGb7aolzF2Tm0FaO0rn4gik1WQ: [object Object]&quot;, &quot;timestamp&quot;: &quot;2024-11-11T09:05:19.389Z&quot;&#125;</span><br><span class="line">&#123;&quot;level&quot;: &quot;DEBUG&quot;, &quot;message&quot;: &quot;obGGb7aolzF2Tm0FaO0rn4gik1WQ: start select user login msg&quot;, &quot;timestamp&quot;: &quot;2024-11-11T09:05:19.392Z&quot;&#125;</span><br><span class="line">&#123;&quot;level&quot;: &quot;DEBUG&quot;, &quot;message&quot;: &quot;obGGb7aolzF2Tm0FaO0rn4gik1WQ: [object Object]&quot;, &quot;timestamp&quot;: &quot;2024-11-11T09:05:19.441Z&quot;&#125;</span><br><span class="line">&#123;&quot;level&quot;: &quot;DEBUG&quot;, &quot;message&quot;: &quot;obGGb7aolzF2Tm0FaO0rn4gik1WQ: [object Object]&quot;, &quot;timestamp&quot;: &quot;2024-11-11T09:05:19.676Z&quot;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäºAX516 FPGA å¼€å‘æ¿çš„éŸ³é¢‘å½•åˆ¶ä¸å›æ”¾</title>
      <link href="/2024/10/28/wm8731-record-audio/"/>
      <url>/2024/10/28/wm8731-record-audio/</url>
      
        <content type="html"><![CDATA[<h1>åŸºäºAX516 FPGA å¼€å‘æ¿çš„éŸ³é¢‘å½•åˆ¶ä¸å›æ”¾</h1><h2 id="ç¡¬ä»¶ä»‹ç»">ç¡¬ä»¶ä»‹ç»</h2><blockquote><p>AX516æ˜¯ä¸€æ¬¾åŸºäºFPGAå¹³å°çš„é«˜æ€§èƒ½å¼€å‘æ¿ï¼Œå®ƒä½¿ç”¨èµ›çµæ€ç”Ÿäº§çš„ Spartan6 ç³»åˆ—çš„XC6SLX16-2CSG324FPGA ä½œä¸ºCPUã€‚è¿™ä¸€ç³»åˆ—å…·æœ‰ä¼—å¤šä¼˜ç‚¹ï¼šå…·æœ‰ä¸°å¯Œç¡¬ä»¶èµ„æºã€å…·æœ‰ä¸°å¯Œæ¥å£ç­‰ã€‚åœ¨åŒ…æ‹¬ï¼šè½¯ä»¶æ— çº¿ç”µã€å·¥æ§ã€ICéªŒè¯ç­‰ä¼—å¤šé¢†åŸŸéƒ½æœ‰æ‰€å¹¿æ³›åº”ç”¨ã€‚</p></blockquote><h3 id="åŸºæœ¬æµç¨‹">åŸºæœ¬æµç¨‹</h3><blockquote><p>é€‰å–FPGAå¼€å‘æ¿ä¸å¤–æ¥éŸ³é¢‘æ¨¡å—ç›¸ç»“åˆçš„æ–¹å¼ï¼Œåˆ©ç”¨éŸ³é¢‘æ¨¡å—çš„éŸ³é¢‘èŠ¯ç‰‡WM8731æ¨¡æ‹Ÿä¿¡å·ä¸æ•°å­—ä¿¡å·ä¹‹é—´è½¬æ¢çš„åŠŸèƒ½æ¥å®ç°ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜ç”¨åˆ°I2Cå’ŒI2Sæ€»çº¿æ¥å£ï¼Œé€šè¿‡å®ƒä»¬æ¥å®ç°FPGAä¸WM8731ä¹‹é—´çš„æ§åˆ¶ä¸æ•°æ®é€šä¿¡ã€‚å…¶ä¸­ï¼ŒI2Cæ¥å£è´Ÿè´£FPGAå¯¹WM8731çš„å¯„å­˜å™¨çš„é…ç½®ï¼Œè€ŒI2Sæ¥å£è´Ÿè´£å¯¹éŸ³é¢‘æ•°æ®çš„é€šä¿¡ã€‚é€šè¿‡DDR3è¯»å†™æ§åˆ¶ã€éŸ³é¢‘é€šä¿¡ä¸æ§åˆ¶ã€æŒ‰é”®æ£€æµ‹ç­‰ç¨‹åºæ¥å®ç°ã€‚</p></blockquote><blockquote><p>åœ¨ç¡¬ä»¶ä¸Šç”µç»“æŸåï¼Œå¼€å§‹æŒ‰é”®æ£€æµ‹ã€‚åˆ¤æ–­æœ‰æŒ‰é”®æŒ‰ä¸‹æ—¶ï¼Œå†æ¬¡åˆ¤æ–­æŒ‰é”®æ˜¯å¦æ¾å¼€ã€‚åœ¨æŒ‰é”®æ¾å¼€åå¼€å§‹DDRè¯»å†™æ§åˆ¶ç¨‹åºï¼Œç„¶ååˆå§‹åŒ–ç®¡è„šé…ç½®ä¸ä½å®½ã€‚å°†æ—¶é’Ÿå¤ä½åï¼Œå†é…ç½®WM8731å¯„å­˜å™¨ï¼Œå¯åŠ¨éŸ³é¢‘äº§ç”Ÿç¨‹åºï¼Œå‘é€éŸ³é¢‘æ•°æ®ã€‚åœ¨å¦ä¸€ç«¯æ¥æ”¶éŸ³é¢‘æ•°æ®ï¼Œè‡³æ­¤ç»“æŸã€‚</p></blockquote><h3 id="ç¡¬ä»¶ç»“æ„">ç¡¬ä»¶ç»“æ„</h3><blockquote><p>å¦‚å›¾</p></blockquote><p><img src="/2024/10/28/wm8731-record-audio/st.png" class="lazyload placeholder" data-srcset="/2024/10/28/wm8731-record-audio/st.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h3 id="å¼€å‘æ¿ä¸»è¦å‚æ•°">å¼€å‘æ¿ä¸»è¦å‚æ•°</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">é¡¹ç›®            å‚æ•°</span><br><span class="line">é€»è¾‘å•å…ƒLogic Cells14579</span><br><span class="line">ä¹˜æ³•å™¨DSP48        32</span><br><span class="line">å¯é…ç½®é€»è¾‘å—CLBs 136Kb</span><br><span class="line">Block RAM       576Kb</span><br><span class="line">æ—¶é’Ÿå•å…ƒCMTs    2</span><br><span class="line">å¯ç”¨IOæ•°é‡        218ä¸ª</span><br><span class="line">å†…æ ¸ç”µå‹        1.15V-1.25Vï¼ˆæ¨è1.2Vï¼‰</span><br><span class="line">å·¥ä½œæ¸©åº¦        0-85â„ƒ</span><br></pre></td></tr></table></figure><h3 id="ç”µè·¯è®¾è®¡">ç”µè·¯è®¾è®¡</h3><blockquote><p>å¦‚å›¾</p></blockquote><p><img src="/2024/10/28/wm8731-record-audio/rou.png" class="lazyload placeholder" data-srcset="/2024/10/28/wm8731-record-audio/rou.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h3 id="WM8731ç»“æ„">WM8731ç»“æ„</h3><blockquote><p>å¦‚å›¾ WM8731ä¸»è¦è´Ÿè´£æ•°å­—ä¿¡å·ä¸æ¨¡æ‹Ÿä¿¡å·ä¹‹é—´çš„è½¬æ¢åŠŸèƒ½ã€‚</p></blockquote><p><img src="/2024/10/28/wm8731-record-audio/wm.png" class="lazyload placeholder" data-srcset="/2024/10/28/wm8731-record-audio/wm.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h3 id="å¯„å­˜å™¨ä¿¡æ¯">å¯„å­˜å™¨ä¿¡æ¯</h3><blockquote><p>å¦‚å›¾:åœ¨WM8731çš„å†…éƒ¨æœ‰11ä¸ªå¯„å­˜å™¨ï¼Œé€šè¿‡I2Cæ€»çº¿çš„æ–¹å¼å¯¹å…¶å†…éƒ¨çš„11ä¸ªå¯„å­˜å™¨è¿›è¡Œç›¸åº”çš„é…ç½®ï¼Œæ¥å®ç°å¯¹èŠ¯ç‰‡çš„åˆå§‹åŒ–ä»¥åŠå·¥ä½œæ—¶çš„å·¥ä½œçŠ¶æ€å’ŒåŠŸèƒ½ã€‚ADCå’ŒDACéƒ½æ˜¯WM8731çš„å†…éƒ¨æ¨¡å—ï¼ŒADCæ˜¯æ¨¡æ‹Ÿæ•°å­—è½¬æ¢å™¨ï¼ŒDACæ˜¯æ•°å­—æ¨¡æ‹Ÿè½¬æ¢å™¨ã€‚éŸ³é¢‘ä¿¡æ¯é€šè¿‡å¤–éƒ¨çš„éº¦å…‹é£è¾“å…¥ï¼Œåœ¨WM8731ä¸­æ¥è¿›è¡Œæ•°å­—ä¿¡å·ä¸æ¨¡æ‹Ÿä¿¡å·ä¹‹é—´çš„è½¬æ¢ã€‚æ§åˆ¶å™¨å¯ä»¥é€šè¿‡æ§åˆ¶æ¥å£æ¥å¯¹WM8731è¿›è¡Œé…ç½®ï¼Œç„¶ååœ¨é€šè¿‡éŸ³é¢‘æ¥å£è¯»å†™æ•°æ®éŸ³é¢‘ä¿¡å·ã€‚</p></blockquote><p><img src="/2024/10/28/wm8731-record-audio/jq.png" class="lazyload placeholder" data-srcset="/2024/10/28/wm8731-record-audio/jq.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h3 id="å¯„å­˜å™¨åœ°å€åŠåŠŸèƒ½">å¯„å­˜å™¨åœ°å€åŠåŠŸèƒ½</h3><blockquote><p>å¦‚ä¸‹</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">å¯„å­˜å™¨åœ°å€å¯„å­˜å™¨åç§°    ç›¸å…³åŠŸèƒ½</span><br><span class="line">0000000   å·¦é€šé“æ§åˆ¶   é™éŸ³æ§åˆ¶</span><br><span class="line">0000001   å³é€šé“æ§åˆ¶   é™éŸ³æ§åˆ¶</span><br><span class="line">0000100   æ¨¡æ‹ŸéŸ³é¢‘è·¯å¾„æ§åˆ¶A/Dè½¬æ¢è¾“å…¥é€‰æ‹©</span><br><span class="line">0000101   æ•°å­—éŸ³é¢‘è·¯å¾„æ§åˆ¶é«˜é€šæ»¤æ³¢å™¨ä½¿èƒ½æ§åˆ¶</span><br><span class="line">0000110   æ‰ç”µæ§åˆ¶       éº¦å…‹é£è¾“å…¥æ‰ç”µæ§åˆ¶</span><br><span class="line">0000111   æ•°å­—éŸ³é¢‘æ ¼å¼æ§åˆ¶éŸ³é¢‘ä½é•¿åº¦å’Œæ ¼å¼æ§åˆ¶</span><br><span class="line">0001000   é‡‡æ ·æ§åˆ¶       æ ¸å¿ƒæ—¶é’Ÿåˆ†é…æ§åˆ¶</span><br></pre></td></tr></table></figure><h3 id="wm8731-FPGAå¼•è„šåŠåŠŸèƒ½">wm8731 FPGAå¼•è„šåŠåŠŸèƒ½</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">WM8731å¼•è„šFPGAå¼•è„š</span><br><span class="line">VM_I2C_SCLKPIN:N11</span><br><span class="line">VM_I2C_SDATPIN:M11</span><br><span class="line">VM_BCLK    PIN:U16</span><br><span class="line">VM_DACDAT  PIN:V16</span><br><span class="line">VM_DADLRC  PIN:U15</span><br><span class="line">VM_ADCDAT  PIN:V15</span><br><span class="line">VM_ADCLRC  PIN:V13</span><br></pre></td></tr></table></figure><h2 id="å¼€å‘æµç¨‹">å¼€å‘æµç¨‹</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">è®¾è®¡å®šä¹‰ã€HDLå®ç°ã€åŠŸèƒ½ä»¿çœŸã€é€»è¾‘ç»¼åˆã€å‰ä»¿çœŸã€å¸ƒå±€å¸ƒçº¿ã€åä»¿çœŸã€é™æ€æ—¶åºåˆ†æã€ç³»ç»Ÿæµ‹è¯•</span><br></pre></td></tr></table></figure><p><img src="/2024/10/28/wm8731-record-audio/re.png" class="lazyload placeholder" data-srcset="/2024/10/28/wm8731-record-audio/re.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="åè®®">åè®®</h2><h3 id="i2c">i2c</h3><blockquote><p>I2Cï¼ˆInter Interface Circuitï¼‰å…¨ç§°ä¸ºèŠ¯ç‰‡é—´æ€»çº¿ï¼Œæ˜¯ç›®å‰ä½¿ç”¨å¹¿æ³›çš„èŠ¯ç‰‡é—´ä¸²è¡Œæ‰©å±•æ€»çº¿ã€‚ç›®å‰ä¸–ç•Œä¸Šé‡‡ç”¨I2Cæ€»çº¿æœ‰ä¸¤ä¸ªè§„èŒƒï¼Œè·å…°é£åˆ©æµ¦å…¬å¸å’Œæ—¥æœ¬ç´¢å°¼å…¬å¸ï¼Œç°å¤šé‡‡ç”¨é£åˆ©æµ¦å…¬å¸I2Cæ€»çº¿æŠ€æœ¯è§„èŒƒï¼Œå·²æˆä¸ºç”µå­è¡Œä¸šè®¤å¯çš„æ€»çº¿æ ‡å‡†ã€‚é‡‡ç”¨I2CæŠ€æœ¯å•ç‰‡æœºä»¥åŠå¤–å›´å™¨ä»¶ç§ç±»å¾ˆå¤šï¼Œå·²å¹¿æ³›ç”¨äºå„ç±»ç”µå­äº§å“ã€å®¶ç”¨ç”µå™¨åŠé€šä¿¡è®¾å¤‡ä¸­ã€‚<br>I2Cä¸²è¡Œæ€»çº¿åªæœ‰ä¸¤æ¡ä¿¡å·çº¿ï¼Œä¸€æ¡æ˜¯æ•°æ®çº¿SDAï¼Œå¦ä¸€æ¡æ˜¯æ—¶é’Ÿçº¿SCLã€‚SDAå’ŒSCLæ˜¯åŒå‘çš„ï¼ŒI2Cæ€»çº¿ä¸Šå„å™¨ä»¶æ•°æ®çº¿éƒ½æ¥åˆ°SDAçº¿ä¸Šï¼Œå„å™¨ä»¶æ—¶é’Ÿçº¿å‡æ¥åˆ°SCLçº¿ä¸Šã€‚<br>å¸¦æœ‰I2Cæ¥å£å•ç‰‡æœºå¯ç›´æ¥ä¸I2Cæ€»çº¿æ¥å£çš„å„ç§æ‰©å±•å™¨ä»¶ï¼ˆå¦‚å­˜å‚¨å™¨ã€I/OèŠ¯ç‰‡ã€A/Dã€D/Aã€é”®ç›˜ã€æ˜¾ç¤ºå™¨ã€æ—¥å†/æ—¶é’Ÿï¼‰è¿æ¥ã€‚ç”±äºI2Cæ€»çº¿é‡‡ç”¨çº¯è½¯ä»¶å¯»å€æ–¹æ³•ï¼Œæ— éœ€ç‰‡é€‰çº¿è¿æ¥ï¼Œå¤§å¤§ç®€åŒ–æ€»çº¿æ•°é‡ã€‚</p></blockquote><blockquote><p>åŸºæœ¬ç»“æ„å¦‚å›¾</p></blockquote><p><img src="/2024/10/28/wm8731-record-audio/ic.png" class="lazyload placeholder" data-srcset="/2024/10/28/wm8731-record-audio/ic.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h4 id="è®¿é—®">è®¿é—®</h4><blockquote><p>ç”±æ€»çº¿è§„èŒƒï¼Œèµ·å§‹ä¿¡å·è¡¨æ˜ä¸€æ¬¡æ•°æ®ä¼ é€çš„å¼€å§‹ï¼Œå…¶åä¸ºå¯»å€å­—èŠ‚ã€‚åœ¨å¯»å€å­—èŠ‚åæ˜¯æŒ‰æŒ‡å®šè¯»ã€å†™çš„æ•°æ®å­—èŠ‚ä¸åº”ç­”ä½ã€‚åœ¨æ•°æ®ä¼ é€å®Œæˆåä¸»å™¨ä»¶éƒ½å¿…é¡»å‘é€ç»ˆæ­¢ä¿¡å·ã€‚åœ¨èµ·å§‹ä¸ç»ˆæ­¢ä¿¡å·ä¹‹é—´ä¼ è¾“çš„æ•°æ®å­—èŠ‚æ•°ç”±ä¸»å™¨ä»¶ï¼ˆå•ç‰‡æœºï¼‰å†³å®š</p></blockquote><p><img src="/2024/10/28/wm8731-record-audio/fw.png" class="lazyload placeholder" data-srcset="/2024/10/28/wm8731-record-audio/fw.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h4 id="å¯„å­˜å™¨é…ç½®">å¯„å­˜å™¨é…ç½®</h4><blockquote><p>å¦‚å›¾ æ¯ä¸ªå¯„å­˜å™¨éƒ½éœ€i2cä¼ è¾“3ä¸ªå­—èŠ‚ã€‚</p></blockquote><p><img src="/2024/10/28/wm8731-record-audio/jcq.png" class="lazyload placeholder" data-srcset="/2024/10/28/wm8731-record-audio/jcq.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h3 id="i2s">i2s</h3><blockquote><p>æ•°å­—éŸ³é¢‘æ¥å£å››ç§æ¨¡å¼ 1.Right justified 2.Left justified 3.I2S 4.DSP mode</p></blockquote><blockquote><p>éŸ³é¢‘æ•°æ®ä¼ è¾“ï¼šWM8731çš„æ•°å­—éŸ³é¢‘æ¥å£æœ‰5æ ¹å¼•è„šï¼Œåˆ†åˆ«ä¸ºï¼šBCLKï¼ˆæ•°å­—éŸ³é¢‘ä½æ—¶é’Ÿï¼‰ã€DACDATï¼ˆDACæ•°å­—éŸ³é¢‘æ•°æ®è¾“å…¥ï¼‰ã€DACLRCï¼ˆDACé‡‡æ ·å·¦/å³å£°é“ä¿¡å·ï¼‰ã€ADCDATï¼ˆADCæ•°å­—éŸ³é¢‘ä¿¡å·è¾“å‡ºï¼‰ã€ADCLRCï¼ˆADCé‡‡æ ·å·¦/å³å£°é“ä¿¡å·ï¼‰ã€‚</p></blockquote><blockquote><p>FPGAä¸ºä»è®¾å¤‡ï¼ŒWM8731ä¸ºä¸»è®¾å¤‡ã€‚ADCDATã€DACDSTã€ADCLRCå’ŒDACLRCä¸ä½æ—¶é’ŸBCLKåŒæ­¥ï¼Œåœ¨æ¯ä¸ªBCLKçš„ä¸‹é™æ²¿è¿›è¡Œä¸€æ¬¡æ•°æ®ä¼ è¾“ã€‚BCLKã€DACDATã€DACLRCã€ADCLRCä¸ºWM8731çš„è¾“å…¥ä¿¡å·ã€‚ADCDATä¸ºWM8731çš„è¾“å‡ºä¿¡å·ã€‚FPGAå’ŒWM8731çš„I2Sçš„é€šä¿¡å³å¯¹é½çš„æ—¶åºå›¾å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p></blockquote><p><img src="/2024/10/28/wm8731-record-audio/is.png" class="lazyload placeholder" data-srcset="/2024/10/28/wm8731-record-audio/is.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="DDR3-è¯»å†™">DDR3 è¯»å†™</h2><blockquote><p>å½•å–çš„æ•°æ®å­˜æ”¾åˆ°DDR3 é€‰æ‹©çš„æ˜¯ä¸¤ä¸ª64bitç”¨æˆ·portå£ï¼Œä¸€ä¸ªportå£ç”¨æ¥è¯»å–DDR3æ•°æ®ï¼Œå¦ä¸€ä¸ªåˆ™ç”¨æ¥è¯»å†™æ•°æ®åˆ°DDR3é‡Œ</p></blockquote><h2 id="ä»£ç å®ç°">ä»£ç å®ç°</h2><blockquote><p>éŸ³é¢‘éƒ¨åˆ†åŒ…å«ä¸€ä¸ªä¸»ç¨‹åºï¼ˆmywav.vï¼‰å’Œå››ä¸ªå­ç¨‹åºï¼Œå››ä¸ªå­ç¨‹åºåˆ†åˆ«æ˜¯éŸ³é¢‘æ¥æ”¶ç¨‹åºï¼ˆsinwave_store.vï¼‰ï¼ŒéŸ³é¢‘æ’­æ”¾ç¨‹åºï¼ˆsinwave_gen.vï¼‰ï¼ŒWM8731å¯„å­˜å™¨é…ç½®ç¨‹åºï¼ˆreg_config.vï¼‰å’Œå¤ä½å»¶è¿Ÿç¨‹åºï¼ˆreset_delay.vï¼‰ã€‚å¦å¤–å¯„å­˜å™¨é…ç½®ç¨‹åºï¼ˆreg_config.vï¼‰è¿˜è°ƒç”¨äº†iicçš„é€šä¿¡ç¨‹åºi2c_com.vã€‚</p></blockquote><h3 id="ä¸»ç¨‹åº">ä¸»ç¨‹åº</h3><blockquote><p>åœ¨ç¡¬ä»¶ä¸Šç”µç»“æŸåï¼Œå¼€å§‹æŒ‰é”®æ£€æµ‹ã€‚åˆ¤æ–­æœ‰æŒ‰é”®æŒ‰ä¸‹æ—¶ï¼Œå†æ¬¡åˆ¤æ–­æŒ‰é”®æ˜¯å¦æ¾å¼€ã€‚åœ¨æŒ‰é”®æ¾å¼€åå¼€å§‹ddrè¯»å†™æ§åˆ¶ç¨‹åºï¼Œååˆå§‹åŒ–ç®¡è„šé…ç½®ä¸ä½å®½ã€‚å°†æ—¶é’Ÿå¤ä½åï¼Œé…ç½®WM8731å¯„å­˜å™¨ï¼Œå¯åŠ¨éŸ³é¢‘äº§ç”Ÿç¨‹åºï¼Œå‘é€éŸ³é¢‘æ•°æ®ã€‚åœ¨å¦ä¸€ç«¯æ¥æ”¶éŸ³é¢‘æ•°æ®ï¼Œè‡³æ­¤ï¼Œä¸»ç¨‹åºç»“æŸã€‚</p></blockquote><p><img src="/2024/10/28/wm8731-record-audio/stu.png" class="lazyload placeholder" data-srcset="/2024/10/28/wm8731-record-audio/stu.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h3 id="ç¤ºä¾‹ä»£ç ">ç¤ºä¾‹ä»£ç </h3><blockquote><p>åœ¨æŒ‰é”®æ£€æµ‹ç¨‹åºå’Œddrè¯»å†™æ§åˆ¶ç¨‹åºæ‰§è¡Œåï¼Œä¸»ç¨‹åºé¦–å…ˆåˆ†é…ç®¡è„šä¸ä½å®½ã€‚åœ¨æ­¤ä¹‹åä¾æ¬¡è°ƒç”¨å„ä¸ªæ¨¡å—åŠŸèƒ½</p></blockquote><p><img src="/2024/10/28/wm8731-record-audio/main.png" class="lazyload placeholder" data-srcset="/2024/10/28/wm8731-record-audio/main.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h4 id="éŸ³é¢‘æ¥æ”¶">éŸ³é¢‘æ¥æ”¶</h4><blockquote><p>ç¼–å†™éŸ³é¢‘æ¥æ”¶ç¨‹åºï¼šsinwave_store.vï¼Œç¨‹åºé€šè¿‡åˆ¤æ–­bclkè¾“å…¥æ—¶é’Ÿçš„ä¸Šå‡æ²¿æ¥é‡‡æ ·éŸ³é¢‘adcdatè¾“å…¥çš„æ•°æ®ï¼Œä¸²è¡Œè½¬åŒ–ä¸º64bitçš„å¹¶è¡Œæ•°æ®å¹¶äº§ç”Ÿä¸€ä¸ªDDR3æ•°æ®å†™è¯·æ±‚ä¿¡å·</p></blockquote><ul><li>æµç¨‹</li></ul><blockquote><p>åœ¨åˆå§‹åŒ–å˜é‡ç»“æŸåï¼Œç¨‹åºé¦–å…ˆæ£€æµ‹æ˜¯å¦æœ‰bclkã€dacclkä¿¡å·çš„è·³å˜ï¼›åœ¨æ£€æµ‹åˆ°æ—¶é’Ÿä¿¡å·è·³å˜åï¼Œé‡‡é›†ADCæ•°æ®ã€‚å½“blcæ—¶é’Ÿå¤„äºä¸‹é™æ²¿æ—¶ï¼Œå¼€å§‹é‡‡é›†æ•°æ®ã€‚ä¹‹åäº§ç”Ÿddrå†™ä¿¡å·ï¼Œåœ¨åˆ¤æ–­æ»¡è¶³è¾“å‡ºæ¡ä»¶åè¾“å‡ºæ¥æ”¶ç»“æœã€‚</p></blockquote><p><img src="/2024/10/28/wm8731-record-audio/stu2.png" class="lazyload placeholder" data-srcset="/2024/10/28/wm8731-record-audio/stu2.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li>ä»£ç </li></ul><blockquote><p>é¦–å…ˆåˆå§‹åŒ–å˜é‡ï¼Œä¹‹åæ£€æµ‹å¯¹åº”æ—¶é’Ÿä¿¡å·æ˜¯å¦è·³å˜ã€‚ç¡®è®¤æœ‰ä¿¡å·è·³å˜åé‡‡é›†å¯¹åº”ADCæ•°æ®ã€‚åœ¨å¼€å§‹é‡‡é›†å‰ï¼Œåˆ¤æ–­æ—¶é’Ÿä¿¡å·å¤„äºä¸‹é™æ²¿ï¼Œä¹‹åäº§ç”Ÿddrè¯»å†™æ§åˆ¶ä¿¡å·ï¼Œåœ¨æ»¡è¶³è¾“å‡ºç»“æœåè¾“å‡ºéŸ³é¢‘æ¥æ”¶ç»“æœã€‚</p></blockquote><p><img src="/2024/10/28/wm8731-record-audio/code.png" class="lazyload placeholder" data-srcset="/2024/10/28/wm8731-record-audio/code.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h4 id="éŸ³é¢‘æ’­æ”¾">éŸ³é¢‘æ’­æ”¾</h4><ul><li>æµç¨‹</li></ul><blockquote><p>é¢‘æ’­æ”¾ç¨‹åºæµç¨‹ä¸éŸ³é¢‘æ¥æ”¶ç¨‹åºæµç¨‹ç±»ä¼¼ã€‚åœ¨åˆå§‹åŒ–å˜é‡åï¼Œæ£€æµ‹dacclkã€bclkæ—¶é’Ÿä¿¡å·æ˜¯å¦è·³å˜ã€‚å†ç¡®è®¤è·³å˜åï¼Œæ£€æµ‹æ—¶é’Ÿå¤„äºä¸‹é™æ²¿æ—¶å¼€å§‹æ’­æ”¾éŸ³é¢‘æ•°æ®ï¼Œéšåäº§ç”Ÿddrè¯»ä¿¡å·ã€‚åœ¨åˆ¤æ–­æ’­æ”¾å®Œæˆåç»“æŸæµç¨‹ã€‚</p></blockquote><p><img src="/2024/10/28/wm8731-record-audio/stu3.png" class="lazyload placeholder" data-srcset="/2024/10/28/wm8731-record-audio/stu3.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li>ä»£ç </li></ul><blockquote><p>åœ¨åˆå§‹åŒ–å˜é‡å’Œé…ç½®ç®¡è„šå’Œä½å®½åï¼Œæ£€æµ‹dacclkã€bclkæ—¶é’Ÿæ˜¯å¦è·³å˜ï¼Œåœ¨ç¡®è®¤æ—¶é’Ÿè·³å˜åå¼€å§‹æ’­æ”¾å£°éŸ³æ•°æ®ï¼Œé¦–å…ˆåˆ¤æ–­dacclkæ—¶é’Ÿæ˜¯å¦å¤„äºä¸‹é™æ²¿ï¼Œå¤„äºä¸‹é™æ²¿åæ’­æ”¾æ•°æ®ã€‚åŒæ—¶äº§ç”Ÿddrè¯»ä¿¡å·ï¼Œåœ¨åˆ¤æ–­æ’­æ”¾å®Œæˆåç¨‹åºç»“æŸã€‚</p></blockquote><p><img src="/2024/10/28/wm8731-record-audio/code2.png" class="lazyload placeholder" data-srcset="/2024/10/28/wm8731-record-audio/code2.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h4 id="å¯„å­˜å™¨é…ç½®-2">å¯„å­˜å™¨é…ç½®</h4><ul><li>æµç¨‹</li></ul><blockquote><p>åœ¨åˆå§‹åŒ–å˜é‡åï¼Œç¨‹åºå¼€å§‹äº§ç”Ÿi2cæ§åˆ¶æ—¶é’Ÿï¼Œä¹‹åè¿›è¡Œå¯„å­˜å™¨i2cé…ç½®è¿‡ç¨‹æ§åˆ¶ã€‚åœ¨æ­¤ä¹‹ååˆ¤æ–­æ˜¯å¦å¤ä½ï¼Œåœ¨ç¡®è®¤å¤ä½åå¼€å§‹i2cä¼ è¾“æ•°æ®ï¼Œä¹‹ååˆ¤æ–­æ˜¯å¦æ¥æ”¶åˆ°i2cåº”ç­”ä¿¡å·ï¼Œå¦‚æœæ”¶åˆ°ï¼Œåˆ™ç»§ç»­ä¸‹ä¸€ä¸ªå¯„å­˜å™¨é…ç½®ï¼Œå¦åˆ™é…ç½®WM8731å¯„å­˜å™¨èµ‹å€¼ã€‚è‡³æ­¤æµç¨‹ç»“æŸã€‚</p></blockquote><p><img src="/2024/10/28/wm8731-record-audio/stu4.png" class="lazyload placeholder" data-srcset="/2024/10/28/wm8731-record-audio/stu4.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li>ä»£ç </li></ul><blockquote><p>åœ¨åˆå§‹åŒ–å˜é‡åé…ç½®ä½å®½å’Œç®¡è„šï¼Œä¹‹åäº§ç”Ÿé¢‘ç‡ä¸º20khzçš„i2cæ§åˆ¶æ—¶é’Ÿï¼›ä¹‹åè¿›è¡Œå¯„å­˜å™¨IICé…ç½®è¿‡ç¨‹æ§åˆ¶ï¼›åˆ¤æ–­å¤ä½åï¼Œå¼€å§‹æ•°æ®ä¼ è¾“ï¼Œå¦‚æœæ”¶åˆ°i2cåº”ç­”ä¿¡å·ï¼Œåˆ™ç»§ç»­ä¸‹ä¸ªå¯„å­˜å™¨é…ç½®ï¼Œå¦åˆ™å‘é€ç»“æŸã€‚å¼€å§‹WM8731å¯„å­˜å™¨èµ‹å€¼ã€‚</p></blockquote><p><img src="/2024/10/28/wm8731-record-audio/code3.png" class="lazyload placeholder" data-srcset="/2024/10/28/wm8731-record-audio/code3.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h4 id="I2Cé€šä¿¡">I2Cé€šä¿¡</h4><ul><li>æµç¨‹</li></ul><blockquote><p>åœ¨é…ç½®å˜é‡åå¼•è„šåï¼Œé¦–å…ˆi2cå¤„äºç©ºé—²çŠ¶æ€ï¼Œåœ¨åˆ¤æ–­è¾“å…¥ä¿¡å·å¤„äºä½ç”µå¹³åï¼Œå¼€å§‹æ•°æ®ä¼ è¾“ï¼Œåœ¨æ¥å—åˆ°åº”ç­”ä¿¡å·åï¼Œå¼€å§‹ä¸‹æ¬¡ä¼ è¾“ï¼Œåœ¨åˆ¤æ–­ä¼ è¾“ç»“æŸåï¼Œæµç¨‹ç»“æŸã€‚</p></blockquote><p><img src="/2024/10/28/wm8731-record-audio/stu5.png" class="lazyload placeholder" data-srcset="/2024/10/28/wm8731-record-audio/stu5.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li>ä»£ç </li></ul><blockquote><p>åœ¨åˆ¤æ–­å¤„äºä½ç”µå¹³åï¼Œå¼€å§‹æ•°æ®ä¼ è¾“ï¼Œæ¥æ”¶åˆ°åº”ç­”ä¿¡å·åï¼Œå¼€å§‹ä¸‹æ¬¡æ•°æ®ä¼ è¾“ï¼Œç›´è‡³æ•°æ®ä¼ è¾“ç»“æŸã€‚</p></blockquote><p><img src="/2024/10/28/wm8731-record-audio/code4.png" class="lazyload placeholder" data-srcset="/2024/10/28/wm8731-record-audio/code4.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h4 id="å¤ä½å»¶è¿Ÿ">å¤ä½å»¶è¿Ÿ</h4><blockquote><p>å½“å§‹ç»ˆå¤„äºä¸Šå‡æ²¿æ˜¯åˆ¤æ–­cntæ˜¯å¦æ»¡è¶³æ¡ä»¶ï¼Œæ»¡è¶³æŒ‡å®šæ¡ä»¶åï¼Œä½¿å¾—cntè‡ªå¢ã€‚ä¸æ»¡è¶³æ—¶è¿›è¡Œå¤ä½æ“ä½œï¼Œä»¥æ­¤è¾¾åˆ°å¤ä½æ—¶å»¶æ“ä½œã€‚</p></blockquote><p><img src="/2024/10/28/wm8731-record-audio/code5.png" class="lazyload placeholder" data-srcset="/2024/10/28/wm8731-record-audio/code5.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h4 id="æŒ‰é”®æ£€æµ‹">æŒ‰é”®æ£€æµ‹</h4><ul><li>æµç¨‹</li></ul><blockquote><p>åˆå§‹åŒ–å˜é‡ç»“æŸåï¼Œåˆ¤æ–­æŒ‰é”®æ˜¯å¦æŒ‰ä¸‹ï¼Œå¦‚æœæŒ‰é”®æŒ‰ä¸‹ddrå†™åœ°å€å¤ä½ï¼Œå¼€å§‹è®¡æ•°ã€‚åœ¨åˆ¤æ–­è¶…è¿‡æŠ–åŠ¨æ—¶é—´åï¼Œå¼€å§‹å½•éŸ³ã€‚åˆ¤æ–­æŒ‰é”®æ˜¯å¦æ¾å¼€ï¼ŒæŒ‰é”®æ¾å¼€åddrè¯»åœ°å€å¼€å§‹è®¡æ•°ï¼Œè¶…è¿‡æŠ–åŠ¨æ—¶é—´åï¼Œå½•éŸ³ç»“æŸã€‚æŒ‰é”®æ£€æµ‹ç¨‹åºæµç¨‹ç»“æŸã€‚</p></blockquote><p><img src="/2024/10/28/wm8731-record-audio/stu6.png" class="lazyload placeholder" data-srcset="/2024/10/28/wm8731-record-audio/stu6.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li>ä»£ç </li></ul><blockquote><p>ç¬¬ä¸€éƒ¨åˆ†æ£€æµ‹æŒ‰é”®æ˜¯å¦æŒ‰ä¸‹ï¼Œç¬¬äºŒéƒ¨åˆ†æ£€æµ‹æŒ‰é”®æ˜¯å¦æ¾å¼€ã€‚æœ€åæ‰§è¡Œç›¸åº”æ“ä½œã€‚</p></blockquote><p><img src="/2024/10/28/wm8731-record-audio/code6.png" class="lazyload placeholder" data-srcset="/2024/10/28/wm8731-record-audio/code6.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h4 id="é¡¶å±‚æ¨¡å—">é¡¶å±‚æ¨¡å—</h4><ul><li>æµç¨‹</li></ul><blockquote><p>ä¾æ¬¡è°ƒç”¨ï¼šWM8731é©±åŠ¨ç¨‹åºã€æŒ‰é”®æ£€æµ‹ç¨‹åºã€DDRè¯»å†™æ§åˆ¶ç¨‹åºã€‚</p></blockquote><ul><li>ä»£ç </li></ul><p><img src="/2024/10/28/wm8731-record-audio/code7.png" class="lazyload placeholder" data-srcset="/2024/10/28/wm8731-record-audio/code7.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="æ•ˆæœ">æ•ˆæœ</h2><blockquote><p>å¦‚å›¾</p></blockquote><p><img src="/2024/10/28/wm8731-record-audio/res.png" class="lazyload placeholder" data-srcset="/2024/10/28/wm8731-record-audio/res.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h3 id="ç¼–è¯‘ä¸æ“ä½œ">ç¼–è¯‘ä¸æ“ä½œ</h3><blockquote><p>åœ¨éŸ³é¢‘æ¨¡å—ä¸Šæœ‰ä¸‰ä¸ªä¸åŒé¢œè‰²çš„éŸ³é¢‘è¿æ¥å™¨ï¼Œè“è‰²çš„æ¥å£æ˜¯éŸ³é¢‘è¾“å…¥æ¥å£ï¼›ç²‰è‰²çš„æ¥å£æ˜¯éº¦å…‹é£çš„è¾“å…¥æ¥å£ï¼›ç»¿è‰²çš„æ¥å£åˆ™ä¸ºéº¦å…‹é£çš„è¾“å‡ºæ¥å£ã€‚</p></blockquote><blockquote><p>åœ¨è¿æ¥è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯ä¸è¦å°†æ’å¤´ä¸æ¥å£æ’é”™ï¼Œè€³æœºçš„ç²‰è‰²æ’å¤´è¦æ’åˆ°éŸ³é¢‘æ¨¡å—çš„ç²‰è‰²æ¥å£ä¸Šï¼Œè€³æœºçš„ç»¿è‰²æ’å¤´åˆ™è¦æ’åˆ°éŸ³é¢‘æ¨¡å—çš„ç»¿è‰²æ¥å£ä¸Šã€‚</p></blockquote><blockquote><p>ç¼–è¯‘å·¥ç¨‹ç”Ÿæˆæ–‡ä»¶ï¼Œç„¶åå†ç”¨Impact å·¥å…·ä¸‹è½½ç”Ÿæˆçš„æ–‡ä»¶åˆ°FPGAé‡Œï¼Œè¿™æ ·å°±å®Œæˆäº†æˆ‘ä»¬FPGAç‰ˆçš„å½•éŸ³æœºäº†ã€‚</p></blockquote><blockquote><p>æƒ³è¦å®ç°å½•éŸ³ä¸æ’­æ”¾åŠŸèƒ½å¾ˆç®€å•ï¼Œå°±åƒåœ¨å¾®ä¿¡å‘è¯­éŸ³ä¸€æ ·ï¼ŒæŒ‰ä½å½•éŸ³é”®è¯´è¯ï¼Œè¯´å®Œè¯åå†æ¾å¼€å½•éŸ³å°±å¯ä»¥äº†ã€‚æˆ‘ä»¬éœ€è¦æŒ‰ä½å¼€å‘æ¿ä¸Šçš„KEY1é”®ï¼Œå¯¹ç€è€³æœºçš„éº¦å…‹é£è¯´ä¸Šä¸€æ®µè¯ï¼Œç„¶åé‡Šæ”¾KEY1é”®ï¼Œä¹‹åæˆ‘ä»¬å°±èƒ½åœ¨è€³æœºä¸­å¬åˆ°æˆ‘ä»¬è‡ªå·±è¯´çš„è¯äº†ï¼Œéå¸¸ç®€å•ï¼Œæ–¹ä¾¿å¿«æ·ã€‚</p></blockquote><h2 id="See">See</h2><ul><li><ol><li>é»‘é‡‘AX516å¼€å‘æ¿ç”¨æˆ·æ‰‹å†Œ</li></ol></li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> fpga </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäºESP32æ™ºèƒ½ç©ºæ°”ç«™å®ç°</title>
      <link href="/2024/10/27/air-station/"/>
      <url>/2024/10/27/air-station/</url>
      
        <content type="html"><![CDATA[<h1>åŸºäºESP32æ™ºèƒ½ç©ºæ°”ç«™å®ç°</h1><h2 id="ç®€ä»‹">ç®€ä»‹</h2><blockquote><p>é‡‡ç”¨D1 miniæ¨¡å—ï¼Œé¢—ç²’ç‰©ä¼ æ„Ÿå™¨ï¼ŒäºŒæ°§åŒ–ç¢³ä¼ æ„Ÿå™¨ï¼Œå…‰çº¿ä¼ æ„Ÿå™¨ï¼Œæ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨ï¼Œå±å¹•ç­‰é€šè¿‡ä¸²å£è¯­è¨€è¿›è¡Œå¼€å‘,å¯æ£€æµ‹ç©ºæ°”ä¸­ä¸»è¦æœ‰å®³ç‰©è´¨â€“pM2.5,PM10çš„ä»ªå™¨ï¼Œå¹¶å®ç°å®æ—¶ç›‘æµ‹åŠŸèƒ½</p></blockquote><h3 id="å®ç°åŠŸèƒ½">å®ç°åŠŸèƒ½</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1.äºŒæ°§åŒ–ç¢³ç›‘æµ‹</span><br><span class="line">2.ç¯å¢ƒå…‰æ£€æµ‹</span><br><span class="line">3.å¯å¸å…¥é¢—ç²’ç‰©æ£€æµ‹</span><br><span class="line">4.æ¸©æ¹¿åº¦æ£€æµ‹</span><br><span class="line">5.å¤©æ°”é¢„æŠ¥</span><br><span class="line">6.æ—¶é’ŸåŠŸèƒ½</span><br><span class="line">7.æ˜¾ç¤ºç›‘æµ‹æ•°æ®åŠ¨æ€åˆ‡æ¢</span><br><span class="line">8.ä¾¿æºã€ä½åŠŸè€—</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨ç¡¬ä»¶">ä½¿ç”¨ç¡¬ä»¶</h3><blockquote><p>ç¡¬ä»¶ä¸­é€šè¿‡ESP8266ä¸PMS5003å¯å¸å…¥ç‰©é¢—ç²’ç‰©ä¼ æ„Ÿå™¨ã€BME280æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨ã€BH1750å…‰çº¿ä¼ æ„Ÿå™¨ã€UsartGPU26Bä¸²å£å±ã€Sense air s8äºŒæ°§åŒ–ç¢³ä¼ æ„Ÿå™¨ä½¿ç”¨æœé‚¦çº¿è¿æ¥ï¼Œç”¨ç”µæºçº¿è¿›è¡Œä¾›ç”µ</p></blockquote><h3 id="åŸç†å›¾">åŸç†å›¾</h3><blockquote><p>å¦‚å›¾ï¼Œ åˆ†ä¸ºä»¥ä¸‹æ¨¡å—ï¼šBH1750ï¼ˆå…‰çº¿ä¼ æ„Ÿå™¨ï¼‰ã€BME280ï¼ˆæ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨ï¼‰ã€Switchï¼ˆå¼€å…³ï¼‰ã€PMS5003ï¼ˆé¢—ç²’ç‰©ä¼ æ„Ÿå™¨ï¼‰ã€UsartGPU26Bï¼ˆä¸²å£å±ï¼‰ã€Sense air s8ï¼ˆäºŒæ°§åŒ–ç¢³ä¼ æ„Ÿå™¨ï¼‰ã€D1MINIï¼ˆä¸»æ§æ¿ï¼‰ã€‚</p></blockquote><p><img src="/2024/10/27/air-station/map.png" class="lazyload placeholder" data-srcset="/2024/10/27/air-station/map.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="æŠ€æœ¯">æŠ€æœ¯</h2><ul><li><p>ardunio</p></li><li><p>python</p></li><li><p>esp32ç­‰ç¡¬ä»¶</p></li><li><p>mqtt</p></li><li><p>requests</p></li><li><p>GPUMarker</p></li></ul><h2 id="æ•°æ®æŒ‡æ ‡">æ•°æ®æŒ‡æ ‡</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">åŠŸèƒ½               æŒ‡æ ‡</span><br><span class="line">é¢—ç²’ç‰©æµ“åº¦æ£€æµ‹        0~1000pm</span><br><span class="line">å®¤å†…æ¸©æ¹¿åº¦æ£€æµ‹        æ¸©åº¦é‡ç¨‹ï¼š-40åº¦~85åº¦ æ¹¿åº¦é‡ç¨‹ï¼š0~100RH</span><br><span class="line">äºŒæ°§åŒ–ç¢³æµ“åº¦æ£€æµ‹    é‡ç¨‹ï¼š0~10000ppmï¼ˆæ­£å¸¸çš„äºŒæ°§åŒ–ç¢³é‡ç¨‹ä¸º0~2000ppmï¼‰</span><br><span class="line">æ—¶é’ŸåŠŸèƒ½           åŒ—äº¬æ—¶é—´</span><br><span class="line">è‡ªåŠ¨è°ƒèŠ‚å…‰çº¿äº®åº¦åŠŸèƒ½1-65535lx(å…‰çº¿äº®åº¦é‡ç¨‹)</span><br></pre></td></tr></table></figure><h2 id="åŠŸèƒ½å®ç°">åŠŸèƒ½å®ç°</h2><blockquote><p>æ€»ä½“ç»“æ„å¦‚å›¾</p></blockquote><p><img src="/2024/10/27/air-station/struct.png" class="lazyload placeholder" data-srcset="/2024/10/27/air-station/struct.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h3 id="å¤©æ°”æ•°æ®è·å–">å¤©æ°”æ•°æ®è·å–</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># @FileName  :server.py</span></span><br><span class="line"><span class="comment"># @Time      :2021/3/24 21:26</span></span><br><span class="line"><span class="comment"># @Author    :czq</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> paho.mqtt.publish <span class="keyword">as</span> publish</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">import</span> gzip</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">parameter</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">location = <span class="string">&#x27;117.22,39.0&#x27;</span></span><br><span class="line">key = <span class="string">&#x27;8d7a3e69f9644bb5bf9ed5da19209e67&#x27;</span></span><br><span class="line">client_id = time.strftime(<span class="string">&#x27;%Y%m%d%H%M%S&#x27;</span>, time.localtime(time.time()))</span><br><span class="line">host = <span class="string">&#x27;121.43.238.135&#x27;</span></span><br><span class="line">port = <span class="number">18083</span></span><br><span class="line">user = <span class="string">&#x27;admin&#x27;</span></span><br><span class="line">password = <span class="string">&#x27;public&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">weather_url = <span class="string">&quot;https://devapi.heweather.net/v7/weather/now?location=&quot;</span>+location+<span class="string">&quot;&amp;key=&quot;</span>+key</span><br><span class="line">weather_response = urllib.request.urlopen(weather_url)</span><br><span class="line">weather_responsebyte = weather_response.read()</span><br><span class="line">buff = BytesIO(weather_responsebyte)</span><br><span class="line">f = gzip.GzipFile(fileobj=buff)</span><br><span class="line">weather_result = f.read().decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">data2 = json.loads(weather_result)</span><br><span class="line">real = data2[<span class="string">&quot;now&quot;</span>][<span class="string">&quot;temp&quot;</span>]</span><br><span class="line">hum = data2[<span class="string">&quot;now&quot;</span>][<span class="string">&quot;humidity&quot;</span>]</span><br><span class="line">tempfl = data2[<span class="string">&quot;now&quot;</span>][<span class="string">&quot;feelsLike&quot;</span>]</span><br><span class="line">code = data2[<span class="string">&quot;now&quot;</span>][<span class="string">&quot;icon&quot;</span>]</span><br><span class="line"><span class="keyword">if</span> code == <span class="string">&#x27;100&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;150&#x27;</span>:</span><br><span class="line">    code = <span class="number">1</span></span><br><span class="line"><span class="keyword">elif</span> code == <span class="string">&#x27;104&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;154&#x27;</span>:</span><br><span class="line">    code = <span class="number">2</span></span><br><span class="line"><span class="keyword">elif</span> code == <span class="string">&#x27;101&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;103&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;102&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;153&#x27;</span>:</span><br><span class="line">    code = <span class="number">3</span></span><br><span class="line"><span class="keyword">elif</span> code == <span class="string">&#x27;300&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;301&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;350&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;351&#x27;</span>:</span><br><span class="line">    code = <span class="number">4</span></span><br><span class="line"><span class="keyword">elif</span> code == <span class="string">&#x27;302&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;303&#x27;</span>:</span><br><span class="line">    code = <span class="number">5</span></span><br><span class="line"><span class="keyword">elif</span> code == <span class="string">&#x27;304&#x27;</span>:</span><br><span class="line">    code = <span class="number">6</span></span><br><span class="line"><span class="keyword">elif</span> code == <span class="string">&#x27;305&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;309&#x27;</span>:</span><br><span class="line">    code = <span class="number">7</span></span><br><span class="line"><span class="keyword">elif</span> code == <span class="string">&#x27;306&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;307&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;308&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;310&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;311&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;312&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;313&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;314&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;315&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;316&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;317&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;318&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;399&#x27;</span>:</span><br><span class="line">    code = <span class="number">8</span></span><br><span class="line"><span class="keyword">elif</span> code == <span class="string">&#x27;404&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;405&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;406&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;456&#x27;</span>:</span><br><span class="line">    code = <span class="number">9</span></span><br><span class="line"><span class="keyword">elif</span> code == <span class="string">&#x27;400&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;408&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;407&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;457&#x27;</span>:</span><br><span class="line">    code = <span class="number">10</span></span><br><span class="line"><span class="keyword">elif</span> code == <span class="string">&#x27;401&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;402&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;403&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;499&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;410&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;409&#x27;</span>:</span><br><span class="line">    code = <span class="number">11</span></span><br><span class="line"><span class="keyword">elif</span> code == <span class="string">&#x27;503&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;504&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;507&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;508&#x27;</span>:</span><br><span class="line">    code = <span class="number">12</span></span><br><span class="line"><span class="keyword">elif</span> code == <span class="string">&#x27;500&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;509&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;510&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;514&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;515&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;501&#x27;</span>:</span><br><span class="line">    code = <span class="number">13</span></span><br><span class="line"><span class="keyword">elif</span> code == <span class="string">&#x27;511&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;512&#x27;</span> <span class="keyword">or</span> code == <span class="string">&#x27;513&#x27;</span>:</span><br><span class="line">    code = <span class="number">14</span></span><br><span class="line"><span class="keyword">elif</span> code == <span class="string">&#x27;900&#x27;</span>:</span><br><span class="line">    code = <span class="number">16</span></span><br><span class="line"><span class="keyword">elif</span> code == <span class="string">&#x27;901&#x27;</span>:</span><br><span class="line">    code = <span class="number">17</span></span><br><span class="line"><span class="keyword">elif</span> code == <span class="string">&#x27;999&#x27;</span>:</span><br><span class="line">    code = <span class="number">18</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(real)</span><br><span class="line"><span class="built_in">print</span>(hum)</span><br><span class="line"><span class="built_in">print</span>(tempfl)</span><br><span class="line"><span class="built_in">print</span>(code)</span><br><span class="line"></span><br><span class="line">fweather_url = <span class="string">&quot;https://devapi.heweather.net/v7/weather/3d?location=&quot;</span>+location+<span class="string">&quot;&amp;key=&quot;</span>+key</span><br><span class="line">fweather_response = urllib.request.urlopen(fweather_url)</span><br><span class="line">fweather_responsebyte = fweather_response.read()</span><br><span class="line">bufff = BytesIO(fweather_responsebyte)</span><br><span class="line">ff = gzip.GzipFile(fileobj=bufff)</span><br><span class="line">fweather_result = ff.read().decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">data3 = json.loads(fweather_result)</span><br><span class="line">high = data3[<span class="string">&quot;daily&quot;</span>][<span class="number">0</span>][<span class="string">&quot;tempMax&quot;</span>]</span><br><span class="line">low = data3[<span class="string">&quot;daily&quot;</span>][<span class="number">0</span>][<span class="string">&quot;tempMin&quot;</span>]</span><br><span class="line">fcode = data3[<span class="string">&quot;daily&quot;</span>][<span class="number">0</span>][<span class="string">&quot;iconDay&quot;</span>]</span><br><span class="line">thigh = data3[<span class="string">&quot;daily&quot;</span>][<span class="number">1</span>][<span class="string">&quot;tempMax&quot;</span>]</span><br><span class="line">tlow = data3[<span class="string">&quot;daily&quot;</span>][<span class="number">1</span>][<span class="string">&quot;tempMin&quot;</span>]</span><br><span class="line">tcode = data3[<span class="string">&quot;daily&quot;</span>][<span class="number">1</span>][<span class="string">&quot;iconDay&quot;</span>]</span><br><span class="line"><span class="keyword">if</span> fcode == <span class="string">&#x27;100&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;150&#x27;</span>:</span><br><span class="line">    fcode = <span class="number">19</span></span><br><span class="line"><span class="keyword">elif</span> fcode == <span class="string">&#x27;104&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;154&#x27;</span>:</span><br><span class="line">    fcode = <span class="number">20</span></span><br><span class="line"><span class="keyword">elif</span> fcode == <span class="string">&#x27;101&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;103&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;102&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;153&#x27;</span>:</span><br><span class="line">    fcode = <span class="number">21</span></span><br><span class="line"><span class="keyword">elif</span> fcode == <span class="string">&#x27;300&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;301&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;350&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;351&#x27;</span>:</span><br><span class="line">    fcode = <span class="number">22</span></span><br><span class="line"><span class="keyword">elif</span> fcode == <span class="string">&#x27;302&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;303&#x27;</span>:</span><br><span class="line">    fcode = <span class="number">23</span></span><br><span class="line"><span class="keyword">elif</span> fcode == <span class="string">&#x27;304&#x27;</span>:</span><br><span class="line">    fcode = <span class="number">24</span></span><br><span class="line"><span class="keyword">elif</span> fcode == <span class="string">&#x27;305&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;309&#x27;</span>:</span><br><span class="line">    fcode = <span class="number">25</span></span><br><span class="line"><span class="keyword">elif</span> fcode == <span class="string">&#x27;306&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;307&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;308&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;310&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;311&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;312&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;313&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;314&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;315&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;316&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;317&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;318&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;399&#x27;</span>:</span><br><span class="line">    fcode = <span class="number">26</span></span><br><span class="line"><span class="keyword">elif</span> fcode == <span class="string">&#x27;404&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;405&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;406&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;456&#x27;</span>:</span><br><span class="line">    fcode = <span class="number">27</span></span><br><span class="line"><span class="keyword">elif</span> fcode == <span class="string">&#x27;400&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;408&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;407&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;457&#x27;</span>:</span><br><span class="line">    fcode = <span class="number">28</span></span><br><span class="line"><span class="keyword">elif</span> fcode == <span class="string">&#x27;401&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;402&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;403&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;499&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;410&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;409&#x27;</span>:</span><br><span class="line">    fcode = <span class="number">29</span></span><br><span class="line"><span class="keyword">elif</span> fcode == <span class="string">&#x27;503&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;504&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;507&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;508&#x27;</span>:</span><br><span class="line">    fcode = <span class="number">30</span></span><br><span class="line"><span class="keyword">elif</span> fcode == <span class="string">&#x27;500&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;509&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;510&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;514&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;515&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;501&#x27;</span>:</span><br><span class="line">    fcode = <span class="number">31</span></span><br><span class="line"><span class="keyword">elif</span> fcode == <span class="string">&#x27;511&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;512&#x27;</span> <span class="keyword">or</span> fcode == <span class="string">&#x27;513&#x27;</span>:</span><br><span class="line">    fcode = <span class="number">32</span></span><br><span class="line"><span class="keyword">elif</span> fcode == <span class="string">&#x27;900&#x27;</span>:</span><br><span class="line">    fcode = <span class="number">33</span></span><br><span class="line"><span class="keyword">elif</span> fcode == <span class="string">&#x27;901&#x27;</span>:</span><br><span class="line">    fcode = <span class="number">34</span></span><br><span class="line"><span class="keyword">elif</span> fcode == <span class="string">&#x27;999&#x27;</span>:</span><br><span class="line">    fcode = <span class="number">35</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> tcode == <span class="string">&#x27;100&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;150&#x27;</span>:</span><br><span class="line">    tcode = <span class="number">19</span></span><br><span class="line"><span class="keyword">elif</span> tcode == <span class="string">&#x27;104&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;154&#x27;</span>:</span><br><span class="line">    tcode = <span class="number">20</span></span><br><span class="line"><span class="keyword">elif</span> tcode == <span class="string">&#x27;101&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;103&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;102&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;153&#x27;</span>:</span><br><span class="line">    tcode = <span class="number">21</span></span><br><span class="line"><span class="keyword">elif</span> tcode == <span class="string">&#x27;300&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;301&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;350&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;351&#x27;</span>:</span><br><span class="line">    tcode = <span class="number">22</span></span><br><span class="line"><span class="keyword">elif</span> tcode == <span class="string">&#x27;302&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;303&#x27;</span>:</span><br><span class="line">    tcode = <span class="number">23</span></span><br><span class="line"><span class="keyword">elif</span> tcode == <span class="string">&#x27;304&#x27;</span>:</span><br><span class="line">    tcode = <span class="number">24</span></span><br><span class="line"><span class="keyword">elif</span> tcode == <span class="string">&#x27;305&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;309&#x27;</span>:</span><br><span class="line">    tcode = <span class="number">25</span></span><br><span class="line"><span class="keyword">elif</span> tcode == <span class="string">&#x27;306&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;307&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;308&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;310&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;311&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;312&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;313&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;314&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;315&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;316&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;317&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;318&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;399&#x27;</span>:</span><br><span class="line">    tcode = <span class="number">26</span></span><br><span class="line"><span class="keyword">elif</span> tcode == <span class="string">&#x27;404&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;405&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;406&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;456&#x27;</span>:</span><br><span class="line">    tcode = <span class="number">27</span></span><br><span class="line"><span class="keyword">elif</span> tcode == <span class="string">&#x27;400&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;408&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;407&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;457&#x27;</span>:</span><br><span class="line">    tcode = <span class="number">28</span></span><br><span class="line"><span class="keyword">elif</span> tcode == <span class="string">&#x27;401&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;402&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;403&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;499&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;410&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;409&#x27;</span>:</span><br><span class="line">    tcode = <span class="number">29</span></span><br><span class="line"><span class="keyword">elif</span> tcode == <span class="string">&#x27;503&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;504&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;507&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;508&#x27;</span>:</span><br><span class="line">    tcode = <span class="number">30</span></span><br><span class="line"><span class="keyword">elif</span> tcode == <span class="string">&#x27;500&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;509&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;510&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;514&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;515&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;501&#x27;</span>:</span><br><span class="line">    tcode = <span class="number">31</span></span><br><span class="line"><span class="keyword">elif</span> tcode == <span class="string">&#x27;511&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;512&#x27;</span> <span class="keyword">or</span> tcode == <span class="string">&#x27;513&#x27;</span>:</span><br><span class="line">    tcode = <span class="number">32</span></span><br><span class="line"><span class="keyword">elif</span> tcode == <span class="string">&#x27;900&#x27;</span>:</span><br><span class="line">    tcode = <span class="number">33</span></span><br><span class="line"><span class="keyword">elif</span> tcode == <span class="string">&#x27;901&#x27;</span>:</span><br><span class="line">    tcode = <span class="number">34</span></span><br><span class="line"><span class="keyword">elif</span> tcode == <span class="string">&#x27;999&#x27;</span>:</span><br><span class="line">    tcode = <span class="number">35</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(high)</span><br><span class="line"><span class="built_in">print</span>(low)</span><br><span class="line"><span class="built_in">print</span>(fcode)</span><br><span class="line"><span class="built_in">print</span>(thigh)</span><br><span class="line"><span class="built_in">print</span>(tlow)</span><br><span class="line"><span class="built_in">print</span>(tcode)</span><br><span class="line"></span><br><span class="line">aqiindex_url = <span class="string">&quot;http://219.233.250.38:8087/AQI/PatrolHandler.do?provider=SEMCShare.ChildWeb&amp;method=RegionData&amp;groupID=213&amp;tdsourcetag=s_pctim_aiomsg&quot;</span></span><br><span class="line">aqiindex_response = requests.get(aqiindex_url)</span><br><span class="line">aqiindex_result = aqiindex_response.text</span><br><span class="line">result = json.loads(aqiindex_result)</span><br><span class="line"></span><br><span class="line">PM25 = <span class="built_in">str</span>(result[<span class="number">1</span>][<span class="string">&#x27;pm25Value&#x27;</span>])</span><br><span class="line">PM10 = <span class="built_in">str</span>(result[<span class="number">1</span>][<span class="string">&#x27;pm10Value&#x27;</span>])</span><br><span class="line">aqi = <span class="built_in">str</span>(result[<span class="number">1</span>][<span class="string">&#x27;primaryPollutantAQI&#x27;</span>])</span><br><span class="line">o3 = <span class="built_in">str</span>(result[<span class="number">1</span>][<span class="string">&#x27;o3Value&#x27;</span>])</span><br><span class="line">primary = <span class="built_in">str</span>(result[<span class="number">1</span>][<span class="string">&#x27;primaryPollutantType&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(PM25)</span><br><span class="line"><span class="built_in">print</span>(PM10)</span><br><span class="line"><span class="built_in">print</span>(aqi)</span><br><span class="line"><span class="built_in">print</span>(o3)</span><br><span class="line"></span><br><span class="line">publish.single(<span class="string">&quot;casatift/weather/shanghai/tempfl&quot;</span>, tempfl, qos=<span class="number">1</span>, hostname=host, port=port, client_id=client_id,</span><br><span class="line">               auth=&#123;<span class="string">&#x27;username&#x27;</span>: user, <span class="string">&#x27;password&#x27;</span>: password&#125;)</span><br><span class="line">publish.single(<span class="string">&quot;casatift/weather/shanghai/real&quot;</span>, real, qos=<span class="number">1</span>, hostname=host, port=port, client_id=client_id,</span><br><span class="line">               auth=&#123;<span class="string">&#x27;username&#x27;</span>: user, <span class="string">&#x27;password&#x27;</span>: password&#125;)</span><br><span class="line">publish.single(<span class="string">&quot;casatift/weather/shanghai/hum&quot;</span>, hum, qos=<span class="number">1</span>, hostname=host, port=port, client_id=client_id,</span><br><span class="line">               auth=&#123;<span class="string">&#x27;username&#x27;</span>: user, <span class="string">&#x27;password&#x27;</span>: password&#125;)</span><br><span class="line">publish.single(<span class="string">&quot;casatift/weather/shanghai/code&quot;</span>, code, qos=<span class="number">1</span>, hostname=host, port=port, client_id=client_id,</span><br><span class="line">               auth=&#123;<span class="string">&#x27;username&#x27;</span>: user, <span class="string">&#x27;password&#x27;</span>: password&#125;)</span><br><span class="line">publish.single(<span class="string">&quot;casatift/weather/shanghai/high&quot;</span>, high, qos=<span class="number">1</span>, hostname=host, port=port, client_id=client_id,</span><br><span class="line">               auth=&#123;<span class="string">&#x27;username&#x27;</span>: user, <span class="string">&#x27;password&#x27;</span>: password&#125;)</span><br><span class="line">publish.single(<span class="string">&quot;casatift/weather/shanghai/low&quot;</span>, low, qos=<span class="number">1</span>, hostname=host, port=port, client_id=client_id,</span><br><span class="line">               auth=&#123;<span class="string">&#x27;username&#x27;</span>: user, <span class="string">&#x27;password&#x27;</span>: password&#125;)</span><br><span class="line">publish.single(<span class="string">&quot;casatift/weather/shanghai/fcode&quot;</span>, fcode, qos=<span class="number">1</span>, hostname=host, port=port, client_id=client_id,</span><br><span class="line">               auth=&#123;<span class="string">&#x27;username&#x27;</span>: user, <span class="string">&#x27;password&#x27;</span>: password&#125;)</span><br><span class="line">publish.single(<span class="string">&quot;casatift/weather/shanghai/tcode&quot;</span>, tcode, qos=<span class="number">1</span>, hostname=host, port=port, client_id=client_id,</span><br><span class="line">               auth=&#123;<span class="string">&#x27;username&#x27;</span>: user, <span class="string">&#x27;password&#x27;</span>: password&#125;)</span><br><span class="line">publish.single(<span class="string">&quot;casatift/weather/shanghai/thigh&quot;</span>, thigh, qos=<span class="number">1</span>, hostname=host, port=port, client_id=client_id,</span><br><span class="line">               auth=&#123;<span class="string">&#x27;username&#x27;</span>: user, <span class="string">&#x27;password&#x27;</span>: password&#125;)</span><br><span class="line">publish.single(<span class="string">&quot;casatift/weather/shanghai/tlow&quot;</span>, tlow, qos=<span class="number">1</span>, hostname=host, port=port, client_id=client_id,</span><br><span class="line">               auth=&#123;<span class="string">&#x27;username&#x27;</span>: user, <span class="string">&#x27;password&#x27;</span>: password&#125;)</span><br><span class="line">publish.single(<span class="string">&quot;casatift/weather/shanghai/pm25&quot;</span>, PM25, qos=<span class="number">1</span>, hostname=host, port=port, client_id=client_id,</span><br><span class="line">               auth=&#123;<span class="string">&#x27;username&#x27;</span>: user, <span class="string">&#x27;password&#x27;</span>: password&#125;)</span><br><span class="line">publish.single(<span class="string">&quot;casatift/weather/shanghai/pm10&quot;</span>, PM10, qos=<span class="number">1</span>, hostname=host, port=port, client_id=client_id,</span><br><span class="line">               auth=&#123;<span class="string">&#x27;username&#x27;</span>: user, <span class="string">&#x27;password&#x27;</span>: password&#125;)</span><br><span class="line">publish.single(<span class="string">&quot;casatift/weather/shanghai/aqi&quot;</span>, aqi, qos=<span class="number">1</span>, hostname=host, port=port, client_id=client_id,</span><br><span class="line">               auth=&#123;<span class="string">&#x27;username&#x27;</span>: user, <span class="string">&#x27;password&#x27;</span>: password&#125;)</span><br><span class="line">publish.single(<span class="string">&quot;casatift/weather/shanghai/o3&quot;</span>, o3, qos=<span class="number">1</span>, hostname=host, port=port, client_id=client_id,</span><br><span class="line">               auth=&#123;<span class="string">&#x27;username&#x27;</span>: user, <span class="string">&#x27;password&#x27;</span>: password&#125;)</span><br><span class="line"><span class="keyword">if</span> primary == <span class="string">&#x27;PM2.5&#x27;</span>:</span><br><span class="line">    primary = <span class="number">1</span></span><br><span class="line"><span class="keyword">elif</span> primary == <span class="string">&#x27;PM10&#x27;</span>:</span><br><span class="line">    primary = <span class="number">2</span></span><br><span class="line"><span class="keyword">elif</span> primary == <span class="string">&#x27;O3&#x27;</span>:</span><br><span class="line">    primary = <span class="number">3</span></span><br><span class="line"><span class="keyword">elif</span> primary == <span class="string">&#x27;CO&#x27;</span>:</span><br><span class="line">    primary = <span class="number">4</span></span><br><span class="line"><span class="keyword">elif</span> primary == <span class="string">&#x27;SO2&#x27;</span>:</span><br><span class="line">    primary = <span class="number">5</span></span><br><span class="line"><span class="keyword">elif</span> primary == <span class="string">&#x27;NO2&#x27;</span>:</span><br><span class="line">    primary = <span class="number">6</span></span><br><span class="line">publish.single(<span class="string">&quot;casatift/weather/shanghai/primary&quot;</span>, primary, qos=<span class="number">1</span>, hostname=host, port=port,</span><br><span class="line">               client_id=client_id, auth=&#123;<span class="string">&#x27;username&#x27;</span>: user, <span class="string">&#x27;password&#x27;</span>: password&#125;)</span><br></pre></td></tr></table></figure><h3 id="mqtt-æ•°æ®ä¸Šä¼ ä¸ä¼ æ„Ÿå™¨æ•°æ®å¤„ç†">mqtt æ•°æ®ä¸Šä¼ ä¸ä¼ æ„Ÿå™¨æ•°æ®å¤„ç†</h3><ul><li>BME280ä¼ æ„Ÿå™¨å®ç‰© æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨</li></ul><blockquote><p>æ¿€å…‰ç…§å°„åœ¨ç©ºæ°”ä¸­ï¼Œé‡åˆ°é¢—ç²’ç‰©åç”±äºå…‰çš„æŠ˜å°„ä½¿æ¿€å…‰å½¢æˆæ•£å°„å…‰ï¼Œå†é€šè¿‡æ•£å°„å…‰æ”¶é›†è£…ç½®ï¼Œå°†ç©ºæ°”ä¸­åå°„å›æ¥çš„æ•£å°„å…‰æ”¶é›†èµ·æ¥ï¼ŒæŒç»­ä¸€æ®µæ—¶é—´ä¹‹åï¼Œä¼ æ„Ÿå™¨å°†ä¼šæŠŠå•ä½ä½“ç§¯å†…è¿ç»­æ”¶é›†çš„ä¸åŒçš„æ•£å°„å…‰è¿›è¡Œæ•´ç†ï¼Œè®¡ç®—ä¸åˆ†æï¼Œå…¶ä¼˜ç‚¹åœ¨äºä½“ç§¯å°ï¼Œå·¥ä½œæ— å™ªéŸ³ï¼Œæµ‹é‡ç²¾åº¦é«˜ã€‚</p></blockquote><p><img src="/2024/10/27/air-station/wd.png" class="lazyload placeholder" data-srcset="/2024/10/27/air-station/wd.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><blockquote><p>pm10 pm2.5 humï¼ˆæ¸©åº¦ï¼Œæ¹¿åº¦ï¼‰æ•°æ®è·å–ä¸å‘é€</p></blockquote><figure class="highlight vb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">on</span> System#Boot <span class="keyword">do</span></span><br><span class="line">GPIO,<span class="number">0</span>,<span class="number">0</span></span><br><span class="line">timerSet,<span class="number">1</span>,<span class="number">60</span></span><br><span class="line">SerialSend SPG(<span class="number">1</span>);</span><br><span class="line">endon</span><br><span class="line"></span><br><span class="line"><span class="keyword">On</span> Rules#Timer=<span class="number">1</span> <span class="keyword">do</span></span><br><span class="line">GPIO,<span class="number">0</span>,<span class="number">1</span></span><br><span class="line">timerSet,<span class="number">2</span>,<span class="number">10</span></span><br><span class="line">endon</span><br><span class="line"></span><br><span class="line"><span class="keyword">On</span> PMS#pm10 <span class="keyword">do</span></span><br><span class="line">Publish domoticzc/<span class="keyword">in</span>,<span class="comment">&#x27;&#123;&quot;idx&quot;:152,&quot;nvalue&quot;:0,&quot;svalue&quot;:&quot;[PMS#pm2.5]&quot;&#125;&#x27; â€œè¿™ä¸€æ®µæ˜¯mqttå‘é€pm2.5æ•°å€¼ï¼Œè¯·è‡ªè¡Œæ›´æ”¹topicå’Œpayloadï¼Œå¹¶å°†æ­¤å¥è¯´æ˜åˆ é™¤â€</span></span><br><span class="line">Publish domoticzc/<span class="keyword">in</span>,<span class="comment">&#x27;&#123;&quot;idx&quot;:151,&quot;nvalue&quot;:0,&quot;svalue&quot;:&quot;[PMS#pm10]&quot;&#125;&#x27;â€œè¿™ä¸€æ®µæ˜¯mqttå‘é€pm10æ•°å€¼ï¼Œè¯·è‡ªè¡Œæ›´æ”¹topicå’Œpayloadï¼Œå¹¶å°†æ­¤å¥è¯´æ˜åˆ é™¤â€</span></span><br><span class="line">Publish domoticzc/<span class="keyword">in</span>,<span class="comment">&#x27;&#123;&quot;idx&quot;:313,&quot;nvalue&quot;:0,&quot;svalue&quot;:&quot;[PMS#temp];[PMS#hum];0&quot;&#125;&#x27;â€œè¿™ä¸€æ®µæ˜¯mqttå‘é€æ¸©æ¹¿åº¦ï¼Œè¯·è‡ªè¡Œæ›´æ”¹topicå’Œpayloadï¼Œå¹¶å°†æ­¤å¥è¯´æ˜åˆ é™¤â€</span></span><br><span class="line">SerialSend DS16(<span class="number">214</span>,<span class="number">104</span>,<span class="comment">&#x27;indoor: [PMS#temp]/[PMS#hum]%   &#x27;,15,0);</span></span><br><span class="line">Delay <span class="number">20</span></span><br><span class="line">SerialSend DS16(<span class="number">214</span>,<span class="number">120</span>,<span class="comment">&#x27;pm2.5: [PMS#pm2.5]ug/m3   &#x27;,18,0);</span></span><br><span class="line">Delay <span class="number">20</span></span><br><span class="line"><span class="keyword">if</span> [PMS#pm10] &gt; <span class="number">50</span></span><br><span class="line">timerSet,<span class="number">2</span>,<span class="number">30</span></span><br><span class="line">endif</span><br><span class="line">endon</span><br><span class="line"></span><br><span class="line"><span class="keyword">On</span> Rules#Timer=<span class="number">2</span> <span class="keyword">do</span></span><br><span class="line"><span class="keyword">if</span> [PMS#pm10] &gt; <span class="number">35</span></span><br><span class="line">GPIO,<span class="number">0</span>,<span class="number">0</span></span><br><span class="line">timerSet,<span class="number">1</span>,<span class="number">60</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">GPIO,<span class="number">0</span>,<span class="number">0</span></span><br><span class="line">timerSet,<span class="number">1</span>,<span class="number">120</span></span><br><span class="line">endif</span><br><span class="line">endon</span><br></pre></td></tr></table></figure><ul><li>PMS5003Sç³»åˆ—ä¼ æ„Ÿå™¨å®ç‰©å›¾</li></ul><p><img src="/2024/10/27/air-station/pm.png" class="lazyload placeholder" data-srcset="/2024/10/27/air-station/pm.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li>co2 äºŒæ°§åŒ–ç¢³ä¼ æ„Ÿå™¨ Sense air s8</li></ul><blockquote><p>æ°§åŒ–ç¢³ä¼ æ„Ÿå™¨çš„å·¥ä½œåŸç†æ˜¯éè‰²æ•£çº¢å¤–ï¼šæµ‹é‡è¢«çº¢å¤–ä¼ æ„Ÿå™¨å¸æ”¶çš„çº¢å¤–å…‰ï¼Œæ¥åˆ¤æ–­è¢«æµ‹äºŒæ°§åŒ–ç¢³çš„æµ“åº¦ï¼Œå†é€šè¿‡æ•°å­—æ¨¡æ‹Ÿï¼Œä»ªå™¨ä»ªè¡¨å°±èƒ½å¤Ÿè®¡ç®—å‡ºè¢«æµ‹æ°”ä½“çš„æµ“åº¦ã€‚<br><img src="/2024/10/27/air-station/co2.png" class="lazyload placeholder" data-srcset="/2024/10/27/air-station/co2.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p></blockquote><ul><li>å…‰çº¿ä¼ æ„Ÿå™¨ BH1750</li></ul><p><img src="/2024/10/27/air-station/gx.png" class="lazyload placeholder" data-srcset="/2024/10/27/air-station/gx.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><blockquote><p>temp,co2ï¼ˆæ¸©åº¦  äºŒæ°§åŒ–ç¢³ï¼‰æ•°æ®è·å–ä¸è½¬å‘</p></blockquote><figure class="highlight vb"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">on</span> MQTTCODE#PCODE <span class="keyword">do</span></span><br><span class="line"><span class="keyword">If</span> %systime% &gt; <span class="number">07</span>:<span class="number">00</span>:<span class="number">00</span> <span class="built_in">and</span>  %systime% &lt; <span class="number">21</span>:<span class="number">00</span>:<span class="number">00</span> </span><br><span class="line">SerialSend SEBL(<span class="number">100</span>);</span><br><span class="line">Delay <span class="number">20</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">SerialSend SEBL(<span class="number">5</span>);</span><br><span class="line">Endif</span><br><span class="line">SerialSend BPIC(<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,[MQTTNOW#CODE]);</span><br><span class="line">Delay <span class="number">20</span></span><br><span class="line">SerialSend DS64(<span class="number">210</span>,<span class="number">45</span>,<span class="comment">&#x27;[MQTTNOW#NOW]/[MQTTNOW#TEMPFL]   &#x27;,15,0);</span></span><br><span class="line">Delay <span class="number">20</span></span><br><span class="line">SerialSend DS16(<span class="number">214</span>,<span class="number">104</span>,<span class="comment">&#x27;indoor: [PMS#temp]/[PMS#hum]%&#x27;,15,0);</span></span><br><span class="line">Delay <span class="number">20</span></span><br><span class="line">SerialSend DS16(<span class="number">214</span>,<span class="number">120</span>,<span class="comment">&#x27;pm2.5: [PMS#pm2.5]ug/m3   &#x27;,18,0);</span></span><br><span class="line">Delay <span class="number">20</span></span><br><span class="line">SerialSend DS16(<span class="number">214</span>,<span class="number">136</span>,<span class="comment">&#x27;co2: [CO2#ppm] ppm   &#x27;,16,0);</span></span><br><span class="line">Delay <span class="number">20</span></span><br><span class="line"><span class="keyword">if</span> [MQTTCODE#PCODE] = <span class="number">1</span></span><br><span class="line">SerialSend DS16(<span class="number">214</span>,<span class="number">153</span>,<span class="comment">&#x27;aqi: [MQTTAQI#AQI](PM2.5)  &#x27;,15,0);</span></span><br><span class="line">endif</span><br><span class="line"><span class="keyword">if</span> [MQTTCODE#PCODE] = <span class="number">2</span></span><br><span class="line">SerialSend DS16(<span class="number">214</span>,<span class="number">153</span>,<span class="comment">&#x27;aqi: [MQTTAQI#AQI](PM10)  &#x27;,15,0);</span></span><br><span class="line">endif</span><br><span class="line"><span class="keyword">if</span> [MQTTCODE#PCODE] = <span class="number">3</span></span><br><span class="line">SerialSend DS16(<span class="number">214</span>,<span class="number">153</span>,<span class="comment">&#x27;aqi: [MQTTAQI#AQI](O3)  &#x27;,15,0);</span></span><br><span class="line">endif</span><br><span class="line"><span class="keyword">if</span> [MQTTCODE#PCODE] = <span class="number">4</span></span><br><span class="line">SerialSend DS16(<span class="number">214</span>,<span class="number">153</span>,<span class="comment">&#x27;aqi: [MQTTAQI#AQI](CO)  &#x27;,15,0);</span></span><br><span class="line">endif</span><br><span class="line"><span class="keyword">if</span> [MQTTCODE#PCODE] = <span class="number">5</span></span><br><span class="line">SerialSend DS16(<span class="number">214</span>,<span class="number">153</span>,<span class="comment">&#x27;aqi: [MQTTAQI#AQI](SO2)  &#x27;,15,0);</span></span><br><span class="line">endif</span><br><span class="line"><span class="keyword">if</span> [MQTTCODE#PCODE] = <span class="number">6</span></span><br><span class="line">SerialSend DS16(<span class="number">214</span>,<span class="number">153</span>,<span class="comment">&#x27;aqi: [MQTTAQI#AQI](NO2)  &#x27;,15,0);</span></span><br><span class="line">endif</span><br><span class="line">Delay <span class="number">20</span></span><br><span class="line">SerialSend BPIC(<span class="number">1</span>,<span class="number">340</span>,<span class="number">52</span>,<span class="number">35</span>);</span><br><span class="line">Delay <span class="number">20</span></span><br><span class="line">SerialSend DS24(<span class="number">20</span>,<span class="number">204</span>,<span class="comment">&#x27;%syshour_0%:%sysmin_0%  &#x27;,15,0);;</span></span><br><span class="line">Delay <span class="number">20</span></span><br><span class="line">SerialSend BPIC(<span class="number">1</span>,<span class="number">207</span>,<span class="number">200</span>,[MQTTCODE#FCODE]);</span><br><span class="line">Delay <span class="number">20</span></span><br><span class="line">SerialSend DS24(<span class="number">239</span>,<span class="number">204</span>,<span class="comment">&#x27;[MQTTTEMP#HIGH]/[MQTTTEMP#LOW]  &#x27;,15,0);</span></span><br><span class="line">Delay <span class="number">20</span></span><br><span class="line">SerialSend BPIC(<span class="number">1</span>,<span class="number">300</span>,<span class="number">200</span>,[MQTTCODE#TCODE]);</span><br><span class="line">Delay <span class="number">20</span></span><br><span class="line">SerialSend DS24(<span class="number">332</span>,<span class="number">204</span>,<span class="comment">&#x27;[MQTTTEMP#THIGH]/[MQTTTEMP#TLOW]  &#x27;,15,0);</span></span><br><span class="line">Delay <span class="number">20</span></span><br><span class="line">endon</span><br><span class="line"></span><br><span class="line"><span class="keyword">on</span> CO2#ppm <span class="keyword">do</span></span><br><span class="line">Publish domoticzc/<span class="keyword">in</span>,<span class="comment">&#x27;&#123;&quot;idx&quot;:25,&quot;nvalue&quot;:[CO2#ppm]&#125;&#x27;â€œè¿™ä¸€æ®µæ˜¯mqttå‘é€CO2æ•°å€¼ï¼Œè¯·è‡ªè¡Œæ›´æ”¹topicå’Œpayloadï¼Œå¹¶å°†æ­¤å¥è¯´æ˜åˆ é™¤â€</span></span><br><span class="line">SerialSend DS16(<span class="number">214</span>,<span class="number">136</span>,<span class="comment">&#x27;co2: [CO2#ppm] ppm&#x27;,16,0);</span></span><br><span class="line">Delay <span class="number">20</span></span><br><span class="line">endon</span><br><span class="line"></span><br><span class="line"><span class="keyword">on</span> Clock#Time=All,**:** <span class="keyword">do</span></span><br><span class="line">SerialSend DS24(<span class="number">20</span>,<span class="number">204</span>,<span class="comment">&#x27;%syshour_0%:%sysmin_0%  &#x27;,15,0);;</span></span><br><span class="line">endon</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>æ˜¾ç¤ºå±UsartGPU26B</li></ul><p><img src="/2024/10/27/air-station/xs.png" class="lazyload placeholder" data-srcset="/2024/10/27/air-station/xs.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="ç¡¬ä»¶è¿æ¥">ç¡¬ä»¶è¿æ¥</h2><blockquote><p>å¦‚å›¾</p></blockquote><p><img src="/2024/10/27/air-station/air.png" class="lazyload placeholder" data-srcset="/2024/10/27/air-station/air.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h3 id="è¿æ¥å‰æ•°æ®çº¿æ”¹è£…">è¿æ¥å‰æ•°æ®çº¿æ”¹è£…</h3><blockquote><p>æˆ‘ä»¬éœ€è¦æ”¹è£…ä¸€ä¸ªä¸€è½¬å…­çš„æœé‚¦çº¿æ¥ä¾›ä½¿ç”¨ï¼Œç”±äºå„ä¸ªä¼ æ„Ÿå™¨ä¹‹é—´æ‰€éœ€è¦çš„å·¥ä½œç”µå‹ä¹Ÿä¸å°½ç›¸åŒï¼ŒåŒ…å«5vå’Œ3.3çš„å·¥ä½œç”µå‹ï¼Œå› è€Œè¿˜éœ€è¦åˆ¶ä½œä¸¤æ ¹ä¸€è½¬4çš„æœé‚¦çº¿ä»¥ä¾›ä½¿ç”¨ï¼Œè€Œå…‰çº¿ä¼ æ„Ÿå™¨å’Œæ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨ï¼Œè€ƒè™‘åˆ°å®ƒä»¬æ˜¯I2Cçš„æ¥å£ï¼Œå¯ä»¥ç”¨å¹¶è”çš„æ–¹å¼è¿æ¥ï¼Œä¾¿è¿˜éœ€è¦2æ ¹1è½¬2çš„æœé‚¦çº¿ï¼Œå…¶ä½™éœ€è¦å‡†å¤‡è‹¥å¹²å•æ ¹çš„æœé‚¦çº¿å»å•ç‹¬è¿æ¥å¼€å…³ï¼ŒäºŒæ°§åŒ–ç¢³ä¼ æ„Ÿå™¨ï¼Œå±å¹•</p></blockquote><p><img src="/2024/10/27/air-station/line.png" class="lazyload placeholder" data-srcset="/2024/10/27/air-station/line.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h3 id="å±å¹•ç¨‹åºå†™å…¥">å±å¹•ç¨‹åºå†™å…¥</h3><blockquote><p>ä¸²å£å±å¹•çš„VCCæ¥å£æ¥USB -TTLçš„5Vï¼Œä¸¤è€…çš„GNDæ¥GNDï¼Œå½¢æˆå›è·¯ï¼Œå·¥å…·çš„RXæ¥æ”¶ç«¯å£æ¥å±å¹•çš„TXå‘é€ç«¯å£ï¼Œå·¥å…·çš„å‘é€TXç«¯å£æ¥å±å¹•çš„RXæ¥å—ç«¯å£</p></blockquote><blockquote><p>åœ¨æ§åˆ¶é¢æ¿ä¸­æ‰¾åˆ°ç”µè„‘ç«¯å£ï¼Œé€‰æ‹©ç«¯å£ä¸ºUSB-TTLçš„ç«¯å£ï¼Œé¼ æ ‡å³é”®ç‚¹å‡»ï¼Œå°†æ³¢ç‰¹ç‡è®¾ç½®ä¸º115200</p></blockquote><blockquote><p>ä¸‹è½½GpuMakerï¼Œæ‰“å¼€é¦–é¡µï¼Œä½¿ç”¨ä¸²å£å‘½ä»¤å°†æˆ‘ä»¬æ‰€éœ€è¦å¼€æœºå±å¹•æ¬¢è¿ç•Œé¢ä¿¡æ¯ï¼Œæ—¶é—´æ˜¾ç¤ºä¿¡æ¯ï¼Œæ¸©æ¹¿åº¦æ˜¾ç¤ºä¿¡æ¯ï¼ŒPM2.5ï¼ŒPM10ï¼Œä»¥åŠäºŒæ°§åŒ–ç¢³ç•Œé¢æ˜¾ç¤ºä¿¡æ¯å¯¼å…¥ã€‚</p></blockquote><ul><li>ä¸¾ä¾‹</li></ul><p><img src="/2024/10/27/air-station/sc.png" class="lazyload placeholder" data-srcset="/2024/10/27/air-station/sc.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h3 id="çº¿è·¯è¿æ¥">çº¿è·¯è¿æ¥</h3><blockquote><p>ä»¥DI miniä¸ºè¿æ¥èµ·ç‚¹ï¼Œç”¨æ”¹è£…çš„ä¸€è½¬å…­æœé‚¦çº¿è¿æ¥æ‰€æœ‰å…¶ä»–è®¾å¤‡çš„GNï¼Œæˆ‘ä»¬éœ€æ‹¿å‡ºä¸€æ ¹ä¸€è½¬å››çš„æœé‚¦çº¿ï¼Œæœé‚¦çº¿çš„å…¶ä¸­ä¸€å¤´è¿æ¥D1 miniçš„5vï¼Œå¦å¤–å‡ å¤´åˆ†åˆ«è¿æ¥é¢—ç²’ç‰©ä¼ æ„Ÿå™¨ï¼ŒäºŒæ°§åŒ–ç¢³ä¼ æ„Ÿå™¨åŠä¸²å£å±å¹•çš„VCCç«¯ï¼Œä¿è¯æœ‰è¶³å¤Ÿçš„ç”µå‹è¾“å…¥ç»™æˆ‘ä»¬çš„è®¾å¤‡</p></blockquote><blockquote><p>ä½¿ç”¨ä¸€æ ¹ä¸€è½¬å››çš„æœé‚¦çº¿è¿æ¥D1 miniçš„3.3vç«¯ï¼Œå…¶ä½™çº¿å£åˆ†åˆ«å»è¿æ¥å¼€å…³ï¼Œå…‰çº¿ä¼ æ„Ÿå™¨ï¼Œæ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨ç­‰é¢å®šç”µå‹ä¸º3.3vçš„ä¼ æ„Ÿå™¨</p></blockquote><p><img src="/2024/10/27/air-station/scene.png" class="lazyload placeholder" data-srcset="/2024/10/27/air-station/scene.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><blockquote><p>ä½¿ç”¨ä¸¤æ ¹ä¸€è½¬äºŒçš„æœé‚¦çº¿ä½¿æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨çš„SDAä¸å…‰çº¿ä¼ æ„Ÿå™¨çš„SDAç›¸è¿ï¼ŒSCLä¸SCLç›¸è¿ï¼Œå…¶ä¸­SDAè¡¨ç¤ºæ•°æ®ä¼ é€çº¿ï¼ŒSCLè¡¨ç¤ºæ•°æ®æ•°æ®æ§åˆ¶çº¿ï¼Œ</p></blockquote><blockquote><p>D1 miniçš„D6ç«¯ï¼Œéœ€è¦ç”¨å•çº¿å»è¿æ¥é¢—ç²’ç‰©ä¼ æ„Ÿå™¨çš„TXDæ§åˆ¶çº¿ï¼ŒäºŒæ°§åŒ–ç¢³ä¼ æ„Ÿå™¨çš„UART OX/OT ç«¯æ¥MCUçš„D3ã€D4ç«¯.å¼€å…³çš„outputæ¥DI miniçš„D5ç«¯</p></blockquote><p><img src="/2024/10/27/air-station/d1.png" class="lazyload placeholder" data-srcset="/2024/10/27/air-station/d1.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h3 id="D1-mini-esp32-æµ‹è¯•-é¡µé¢é…ç½®">D1 mini(esp32) æµ‹è¯• é¡µé¢é…ç½®</h3><blockquote><p>å°†D1 miniä¸ç”µè„‘è¿æ¥,å»GitHubä¸‹è½½ESPEASYå›ºä»¶ï¼Œç‚¹å¼€æ–‡ä»¶å¤¹è¿è¡ŒFlashESP.exeï¼Œåœ¨è®¾å¤‡ç®¡ç†å™¨ä¸­é€‰æ‹©D1 miniç«¯å£å·ï¼Œé€‰æ‹©test_ESP8266_4096.binçš„å³å¯</p></blockquote><blockquote><p>ç§»æ¤ä¹‹åç¿»çœ‹æ¿å­èƒŒé¢ï¼Œè½»æŒ‰ä¸‹resetä½¿MCUé‡å¯ï¼Œç„¶åæœ€å¥½é€šè¿‡ç”µè„‘æœç´¢WIFIï¼Œä¹‹åå°±èƒ½æœç´¢åˆ°ä¸€ä¸ªåä¸ºESP-Easy_0çš„WIFIã€‚WIFIè¿æ¥å¯†ç ä¸ºconfigureï¼Œè¿å…¥åä¼šåœ¨é¡µé¢çœ‹åˆ°æ­¤æ—¶ä½ ç”µè„‘æ‰€ç›‘æµ‹åˆ°çš„æ‰€æœ‰WiFiç½‘ç»œåç§°</p></blockquote><blockquote><p>æ‰¾åˆ°ä½ è‡ªå·±çš„WiFiç½‘ç»œï¼Œç‚¹å‡»è¿æ¥ï¼Œç½‘ç«™ä¼šæé†’ä½ éœ€è¦ç­‰å¾…20ç§’ï¼Œä¹‹åä¼šå‘ŠçŸ¥IPçš„åœ°å€ï¼Œæµè§ˆå™¨ä¸­è¾“å…¥è¿™ä¸ªIPåœ°å€ï¼Œç­‰å¾…æ•°ç§’ä¹‹åå°±èƒ½è¿›å…¥ESPEASYçš„é…ç½®é¡µé¢ï¼Œå‡ºç°IPåœ°å€å³è¡¨ç¤ºé…ç½®æˆåŠŸ</p></blockquote><p><img src="/2024/10/27/air-station/conf.png" class="lazyload placeholder" data-srcset="/2024/10/27/air-station/conf.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="ç¡¬ä»¶é…ç½®">ç¡¬ä»¶é…ç½®</h2><h3 id="web-æ£€æµ‹ç‰©é…ç½®">web æ£€æµ‹ç‰©é…ç½®</h3><ul><li>æ‰“å¼€D1 miniï¼Œè¿›å…¥ESPEASYçš„ç½‘ç»œé…ç½®ç•Œé¢ï¼Œæ‰¾åˆ°toolsç•Œé¢ï¼Œé…ç½®å„é¡¹åŠŸèƒ½ï¼š</li></ul><blockquote><p>å…¶ä¸­rulesçš„å‹¾é€‰æ˜¯ä¸ºäº†ç»™æŒ‰é”®è®¾ç½®åˆ‡æ¢è§„åˆ™åŠå»¶è¿Ÿæ—¶é—´ï¼Œå‹¾é€‰NTPå¯ä»¥è‡ªåŠ¨è¾¾æˆç½‘ç»œæ—¶é—´åŒæ­¥åè®®</p></blockquote><p><img src="/2024/10/27/air-station/airconf.png" class="lazyload placeholder" data-srcset="/2024/10/27/air-station/airconf.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li>æ£€æµ‹å€¼</li></ul><blockquote><p>ä»¥äºŒæ°§åŒ–ç¢³ä¼ æ„Ÿå™¨ä¸ºä¾‹ï¼Œåœ¨Deviceå¤„é€‰æ‹©å¥½è®¾å¤‡å‹å·ï¼ŒNameå¤„å¡«å†™å¥½è®¾å¤‡åç§°ï¼Œç‚¹å‡»Enabledæ·»åŠ åï¼Œä¸€å®šæ³¨æ„ç«¯å£çš„è®¾ç½®ä¸è®¾å¤‡è¿æ¥æ—¶å¯¹åº”ï¼Œç”±äºä¸D1 miniæ¨¡å—è¿æ¥æ—¶äºŒæ°§åŒ–ç¢³è¿æ¥5vç”µå‹ï¼Œä¸ºä¿è¯è®¾å¤‡æ­£å¸¸è¿è¡Œï¼Œéœ€è¦è¿æ¥ä¸Šæ‹‰ç”µé˜»å¼•è„šã€‚å› æ­¤æ­¤å¤„ GPIOå¤„é€‰æ‹©D3,D4ï¼ŒSensorå¤„é€‰æ‹©äºŒæ°§åŒ–ç¢³Carbon Dioxideï¼Œæ£€æµ‹åˆ·æ–°æ—¶é—´å®šä¸º60ç§’ï¼Œè€Œåå°†è¾“å‡ºå•ä½è®¾ç½®ä¸ºPPMã€‚</p></blockquote><p><img src="/2024/10/27/air-station/co2c.png" class="lazyload placeholder" data-srcset="/2024/10/27/air-station/co2c.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h3 id="å‘½ä»¤é…ç½®">å‘½ä»¤é…ç½®</h3><blockquote><p>å½“æ‰€æœ‰è®¾å¤‡æ·»åŠ è®¾ç½®å®Œæ¯•åï¼Œç‚¹å‡»Rulesé€‰é¡¹ï¼Œå¦‚å›¾æ‰€ç¤ºï¼Œè®¾ç½®æŒ‰é’®å“åº”ï¼Œå…¶ä¸­delayæŒ‡ä»¤ä»£è¡¨å»¶è¿Ÿï¼Œon Button#Switch=1 do è¿™ä¸€è¡Œè¡¨ç¤ºï¼Œå½“å¼€å…³çš„çŠ¶æ€ä¸ºå¼€æ—¶ï¼Œæ‰§è¡Œdoä¹‹åçš„ ifé€»è¾‘å‘½ä»¤ï¼Œå…¶ä¸­å‘½ä»¤SPGè¡¨ç¤ºæ˜¾ç¤ºç¬¬å‡ ç•Œé¢ï¼Œå…·ä½“æƒ…å†µçœ‹æ•°æ®æ˜¾ç¤ºï¼ŒCIRï¼ˆ156ï¼Œ120ï¼Œ119ï¼Œ[Dummy#cc]ï¼‰å‘½ä»¤è¡¨ç¤ºåœ¨å±å¹•ä¸­åæ ‡ä¸ºï¼ˆ156ï¼Œ120ï¼‰çš„ä½ç½®ç”¨#ccçš„é¢œè‰²ç”»ä¸€ä¸ªåŠå¾„ä¸º180çš„åœ†å½¢ã€‚BOXFå‘½ä»¤å¯ä»¥åœ¨å±å¹•ä¸Šå‘ˆç°ä¸€ä¸ªæ–¹æ¡†ï¼Œè€ŒDS64ï¼ˆ98ï¼Œ65ï¼Œâ€˜[PMS#pm10]â€™ï¼Œ15ï¼‰å‘½ä»¤è¡¨ç¤ºåœ¨ï¼ˆ98ï¼Œ65ï¼‰åæ ‡å¤„ç”¨15å·é¢œè‰²æ˜¾ç¤ºé¢—ç²’ç‰©ä¼ æ„Ÿå™¨ä¸­PM10çš„æ•°æ®ã€‚</p></blockquote><p><img src="/2024/10/27/air-station/w.png" class="lazyload placeholder" data-srcset="/2024/10/27/air-station/w.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h3 id="æ•ˆæœ">æ•ˆæœ</h3><p><img src="/2024/10/27/air-station/air_value.png" class="lazyload placeholder" data-srcset="/2024/10/27/air-station/air_value.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="æœ€ç»ˆæ•ˆæœ">æœ€ç»ˆæ•ˆæœ</h2><h3 id="å¦‚å›¾">å¦‚å›¾</h3><p><img src="/2024/10/27/air-station/re.png" class="lazyload placeholder" data-srcset="/2024/10/27/air-station/re.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><p><img src="/2024/10/27/air-station/re2.png" class="lazyload placeholder" data-srcset="/2024/10/27/air-station/re2.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><p><img src="/2024/10/27/air-station/re3.png" class="lazyload placeholder" data-srcset="/2024/10/27/air-station/re3.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><p><img src="/2024/10/27/air-station/re4.png" class="lazyload placeholder" data-srcset="/2024/10/27/air-station/re4.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><!-- ![img](ohos-pixiv-image/log.png) --><h2 id="See">See</h2><ul><li>1.<a href="https://post.smzdm.com/p/768952/">https://post.smzdm.com/p/768952/</a></li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> esp32 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäºESP32-CAMçš„æ™ºèƒ½çŒ«çœ¼å®ç°</title>
      <link href="/2024/10/27/cat-camera/"/>
      <url>/2024/10/27/cat-camera/</url>
      
        <content type="html"><![CDATA[<h1>åŸºäºESP32-CAMçš„æ™ºèƒ½çŒ«çœ¼å®ç°</h1><h2 id="ç®€ä»‹">ç®€ä»‹</h2><ul><li>é¡¹ç›®ç®€ä»‹</li></ul><blockquote><p>ç”¨pythonå’ŒTensor Flowè¿›è¡Œäººè„¸è¯†åˆ«ï¼Œé€šè¿‡è¯­éŸ³è¯†åˆ«æ¨¡å—è¿›è¡Œè¯­éŸ³è¯†åˆ«</p></blockquote><p><img src="/2024/10/27/cat-camera/my.png" class="lazyload placeholder" data-srcset="/2024/10/27/cat-camera/my.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li>ç¡¬ä»¶ç®€ä»‹</li></ul><p><img src="/2024/10/27/cat-camera/esp32.png" class="lazyload placeholder" data-srcset="/2024/10/27/cat-camera/esp32.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><blockquote><p>å¦‚å›¾ï¼Œæ¨¡å—åŒ…å«ä¸€å—ESP32-CAMçš„MCUå’Œä¸€ä¸ªOV2640çš„200Wåƒç´ æ‘„åƒå¤´ï¼ŒESP32-CAMé™¤äº†æ”¯æŒOV2640å¤–è¿˜æ”¯æŒOV7670æ‘„åƒå¤´</p></blockquote><p><img src="/2024/10/27/cat-camera/esp32cam.png" class="lazyload placeholder" data-srcset="/2024/10/27/cat-camera/esp32cam.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li>ç¡¬ä»¶ç»“æ„</li></ul><p><img src="/2024/10/27/cat-camera/esps.png" class="lazyload placeholder" data-srcset="/2024/10/27/cat-camera/esps.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><blockquote><p>é’ˆè„šå®šä¹‰</p></blockquote><p><img src="/2024/10/27/cat-camera/esppin.png" class="lazyload placeholder" data-srcset="/2024/10/27/cat-camera/esppin.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><blockquote><p>å¦‚ä½•çƒ§å½•ç¨‹åºï¼Œä½¿ç”¨ä»¥ä¸‹æ–¹å¼</p></blockquote><p><img src="/2024/10/27/cat-camera/espwri.png" class="lazyload placeholder" data-srcset="/2024/10/27/cat-camera/espwri.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li>æœ€ç»ˆæ•ˆæœ</li></ul><p><img src="/2024/10/27/cat-camera/espend.png" class="lazyload placeholder" data-srcset="/2024/10/27/cat-camera/espend.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="æŠ€æœ¯">æŠ€æœ¯</h2><ul><li><p>esp32</p></li><li><p>http</p></li><li><p>html</p></li><li><p>pyqt5</p></li><li><p>opencv</p></li><li><p>mysql</p></li><li><p>ov2640</p></li><li><p>ardunio IDE and PyCharm IDE</p></li><li><p>äº‘æœåŠ¡ï¼ˆå·´æ³•äº‘ï¼‰</p></li><li><p>ubuntu</p></li><li><p>otherï¼ˆpythonç¬¬ä¸‰æ–¹åº“ï¼‰</p></li></ul><h2 id="ç¨‹åºå†™å…¥æ–¹å¼">ç¨‹åºå†™å…¥æ–¹å¼</h2><h3 id="ardunio-IDEè®¾ç½®">ardunio IDEè®¾ç½®</h3><blockquote><p>è®¾ç½®æ–¹å¼å¦‚ä¸‹</p></blockquote><p><img src="/2024/10/27/cat-camera/espdeconfig.png" class="lazyload placeholder" data-srcset="/2024/10/27/cat-camera/espdeconfig.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><blockquote><p>æ·»åŠ èŠ¯ç‰‡é©±åŠ¨æ”¯æŒï¼šåœ¨é™„åŠ å¼€å‘æ¿ç®¡ç†å™¨ç½‘å€é‡Œå¡«ä¸Šï¼š<a href="https://dl.espressif.com/dl/package_esp32_index.json">https://dl.espressif.com/dl/package_esp32_index.json</a>Â ç„¶åå•å‡»å¥½</p></blockquote><p><img src="/2024/10/27/cat-camera/conf.png" class="lazyload placeholder" data-srcset="/2024/10/27/cat-camera/conf.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><blockquote><p>å¼€å‘æ¿ç®¡ç†</p></blockquote><p><img src="/2024/10/27/cat-camera/hac.png" class="lazyload placeholder" data-srcset="/2024/10/27/cat-camera/hac.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><blockquote><p>ä»£ç ä¸‹è½½ (<a href="https://github.com/RuiSantosdotme/arduino-esp32-CameraWebServer">https://github.com/RuiSantosdotme/arduino-esp32-CameraWebServer</a>)</p></blockquote><p><img src="/2024/10/27/cat-camera/codedwoanlod.png" class="lazyload placeholder" data-srcset="/2024/10/27/cat-camera/codedwoanlod.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><blockquote><p>åŸºç¡€é…ç½®</p></blockquote><p><img src="/2024/10/27/cat-camera/ideconfigf.png" class="lazyload placeholder" data-srcset="/2024/10/27/cat-camera/ideconfigf.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="ESP32-CAM-å†…ç½®æ¥å£">ESP32-CAM å†…ç½®æ¥å£</h2><h3 id="æ¥å£å®šä¹‰">æ¥å£å®šä¹‰</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">ip            ç«¯å£åç¼€æ–¹å¼å“åº”è¯´æ˜</span><br><span class="line"><span class="number">192.168</span><span class="number">.2</span><span class="number">.151</span><span class="number">80</span>/statusget<span class="punctuation">&#123;</span><span class="punctuation">&#123;</span></span><br><span class="line">            /controlgetÂ Â Â Â <span class="attr">&quot;framesize&quot;</span><span class="punctuation">:</span>Â <span class="number">4</span><span class="punctuation">,</span>Â Â Â Â <span class="attr">&quot;framesize&quot;</span><span class="punctuation">:</span>Â <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">        <span class="number">81</span>/streamgetÂ Â Â Â <span class="attr">&quot;quality&quot;</span><span class="punctuation">:</span>Â <span class="number">10</span><span class="punctuation">,</span>è§†é¢‘æµÂ Â <span class="comment">//Â Â &quot;quality&quot;:Â 10,</span></span><br><span class="line">            /capturegetÂ Â Â Â <span class="attr">&quot;brightness&quot;</span><span class="punctuation">:</span>Â <span class="number">0</span><span class="punctuation">,</span>å›¾åƒæµÂ Â Â Â <span class="attr">&quot;brightness&quot;</span><span class="punctuation">:</span>Â <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            /getÂ Â Â Â <span class="attr">&quot;contrast&quot;</span><span class="punctuation">:</span>Â <span class="number">0</span><span class="punctuation">,</span>ä¸»é¡µÂ Â Â Â <span class="comment">//&quot;contrast&quot;:Â 0,Â //å¯¹æ¯”åº¦</span></span><br><span class="line">                    Â Â Â Â <span class="attr">&quot;saturation&quot;</span><span class="punctuation">:</span>Â <span class="number">0</span><span class="punctuation">,</span>Â <span class="comment">//Â Â Â &quot;saturation&quot;:Â 0,//é¥±å’Œåº¦</span></span><br><span class="line">                    Â Â Â Â <span class="attr">&quot;special_effect&quot;</span><span class="punctuation">:</span>Â <span class="number">0</span><span class="punctuation">,</span>Â Â Â Â <span class="attr">&quot;special_effect&quot;</span><span class="punctuation">:</span>Â <span class="number">0</span><span class="punctuation">,</span><span class="comment">//ç‰¹æ®Šæ•ˆæœ</span></span><br><span class="line">                    Â Â Â Â <span class="attr">&quot;wb_mode&quot;</span><span class="punctuation">:</span>Â <span class="number">0</span><span class="punctuation">,</span><span class="comment">//Â Â Â Â &quot;wb_mode&quot;:Â 0,//æ¨¡å¼</span></span><br><span class="line">                    Â Â Â Â <span class="attr">&quot;awb&quot;</span><span class="punctuation">:</span>Â <span class="number">1</span><span class="punctuation">,</span>Â Â <span class="comment">//Â Â &quot;awb&quot;:Â 1,//è‡ªåŠ¨ç™½å¹³è¡¡</span></span><br><span class="line">                    Â Â Â Â <span class="attr">&quot;awb_gain&quot;</span><span class="punctuation">:</span>Â <span class="number">1</span><span class="punctuation">,</span><span class="comment">//Â Â Â Â &quot;awb_gain&quot;:Â 1,//è‡ªåŠ¨ç™½å¹³è¡¡å¢ç›Š</span></span><br><span class="line">                    Â Â Â Â <span class="attr">&quot;aec&quot;</span><span class="punctuation">:</span>Â <span class="number">1</span><span class="punctuation">,</span>Â <span class="comment">//Â Â Â &quot;aec&quot;:Â 1,//å›å£°æ¶ˆé™¤</span></span><br><span class="line">                    Â Â Â Â <span class="attr">&quot;aec2&quot;</span><span class="punctuation">:</span>Â <span class="number">0</span><span class="punctuation">,</span>Â <span class="comment">//Â Â Â &quot;aec2&quot;:Â 0,//</span></span><br><span class="line">                    Â Â Â Â <span class="attr">&quot;ae_level&quot;</span><span class="punctuation">:</span>Â <span class="number">0</span><span class="punctuation">,</span>Â <span class="comment">//Â Â Â &quot;ae_level&quot;:Â 0,//aeÂ ç­‰çº§</span></span><br><span class="line">                    Â Â Â Â <span class="attr">&quot;aec_value&quot;</span><span class="punctuation">:</span>Â <span class="number">168</span><span class="punctuation">,</span>Â Â Â Â <span class="attr">&quot;aec_value&quot;</span><span class="punctuation">:</span>Â <span class="number">168</span><span class="punctuation">,</span><span class="comment">//å›å£°æ¶ˆé™¤æ•°å€¼</span></span><br><span class="line">                    Â Â Â Â <span class="attr">&quot;agc&quot;</span><span class="punctuation">:</span>Â <span class="number">1</span><span class="punctuation">,</span>Â Â <span class="comment">//Â Â &quot;agc&quot;:Â 1,//è‡ªåŠ¨å¢ç›Šæ§åˆ¶</span></span><br><span class="line">                    Â Â Â Â <span class="attr">&quot;agc_gain&quot;</span><span class="punctuation">:</span>Â <span class="number">0</span><span class="punctuation">,</span>Â <span class="comment">//Â Â Â &quot;agc_gain&quot;:Â 0,//è‡ªåŠ¨æ§åˆ¶å¢ç›ŠÂ å¢ç›Š</span></span><br><span class="line">                    Â Â Â Â <span class="attr">&quot;gainceiling&quot;</span><span class="punctuation">:</span>Â <span class="number">0</span><span class="punctuation">,</span>Â Â Â Â <span class="attr">&quot;gainceiling&quot;</span><span class="punctuation">:</span>Â <span class="number">0</span><span class="punctuation">,</span><span class="comment">//å¢ç›Šä¸Šé™</span></span><br><span class="line">                    Â Â Â Â <span class="attr">&quot;bpc&quot;</span><span class="punctuation">:</span>Â <span class="number">0</span><span class="punctuation">,</span>Â Â Â <span class="comment">//Â &quot;bpc&quot;:Â 0,//è´å¶æ–¯é¢„æµ‹è¡¥å¿</span></span><br><span class="line">                    Â Â Â Â <span class="attr">&quot;wpc&quot;</span><span class="punctuation">:</span>Â <span class="number">1</span><span class="punctuation">,</span>Â Â Â <span class="comment">//Â &quot;wpc&quot;:Â 1,//ç“¦ç‰¹è„‰å†²é€šä¿¡</span></span><br><span class="line">                    Â Â Â Â <span class="attr">&quot;raw_gma&quot;</span><span class="punctuation">:</span>Â <span class="number">1</span><span class="punctuation">,</span><span class="comment">//Â Â Â Â &quot;raw_gma&quot;:Â 1,//rawç”Ÿæˆ</span></span><br><span class="line">                    Â Â Â Â <span class="attr">&quot;lenc&quot;</span><span class="punctuation">:</span>Â <span class="number">1</span><span class="punctuation">,</span>Â Â <span class="comment">//Â Â &quot;lenc&quot;:Â 1,//é•œå¤´æ ¡æ­£</span></span><br><span class="line">                    Â Â Â Â <span class="attr">&quot;vflip&quot;</span><span class="punctuation">:</span>Â <span class="number">0</span><span class="punctuation">,</span>Â Â <span class="comment">//Â Â &quot;vflip&quot;:Â 0,//å‚ç›´æ—‹è½¬</span></span><br><span class="line">                    Â Â Â Â <span class="attr">&quot;hmirror&quot;</span><span class="punctuation">:</span>Â <span class="number">0</span><span class="punctuation">,</span><span class="comment">//Â Â Â Â &quot;hmirror&quot;:Â 0,//æ°´å¹³é•œåƒ</span></span><br><span class="line">                    Â Â Â Â <span class="attr">&quot;dcw&quot;</span><span class="punctuation">:</span>Â <span class="number">1</span><span class="punctuation">,</span>Â Â Â <span class="comment">//Â &quot;dcw&quot;:Â 1,//</span></span><br><span class="line">                    Â Â Â Â <span class="attr">&quot;colorbar&quot;</span><span class="punctuation">:</span>Â <span class="number">0</span><span class="punctuation">,</span><span class="comment">//Â Â Â Â &quot;colorbar&quot;:Â 0,//è‰²æ¡</span></span><br><span class="line">                    Â Â Â Â <span class="attr">&quot;face_detect&quot;</span><span class="punctuation">:</span>Â <span class="number">0</span><span class="punctuation">,</span>Â Â Â Â <span class="attr">&quot;face_detect&quot;</span><span class="punctuation">:</span>Â <span class="number">0</span><span class="punctuation">,</span><span class="comment">//äººè„¸æ³¨å†Œ</span></span><br><span class="line">                    Â Â Â Â <span class="attr">&quot;face_enroll&quot;</span><span class="punctuation">:</span>Â <span class="number">1</span><span class="punctuation">,</span>Â Â Â Â <span class="attr">&quot;face_enroll&quot;</span><span class="punctuation">:</span>Â <span class="number">1</span><span class="punctuation">,</span><span class="comment">//äººè„¸æ³¨å†Œ</span></span><br><span class="line">                    Â Â Â Â <span class="attr">&quot;face_recognize&quot;</span><span class="punctuation">:</span>Â <span class="number">0</span>Â Â Â Â <span class="attr">&quot;face_recognize&quot;</span><span class="punctuation">:</span>Â <span class="number">0</span><span class="comment">//äººè„¸è¯†åˆ«</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">                                  </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="httpæ¥å£">httpæ¥å£</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">å‚æ•°æ–¹æ³•å«ä¹‰ä½ç½®ç±»å‹ra</span><br><span class="line">ra_filter_tä½¿ç”¨çš„è¿‡æ»¤å€¼37-43ç»“æ„ä½“æ˜¾è‰²æŒ‡æ•°</span><br><span class="line">jpg_chunking_t45-58ç»“æ„ä½“</span><br><span class="line">face_id_listäººè„¸è¯†åˆ«åˆ—è¡¨63æ•°ç»„</span><br><span class="line">ra_filter_initraè¿‡æ»¤æ–¹æ³•åˆå§‹åŒ–65æ–¹æ³•</span><br><span class="line">ra_filter_runraè¿‡æ»¤æ–¹æ³•è¿è¡Œ78æ–¹æ³•</span><br><span class="line">rgb_printRGBè¾“å‡º93æ–¹æ³•</span><br><span class="line">rgb_printfRGBæ ¼å¼åŒ–è¾“å‡º103æ–¹æ³•</span><br><span class="line">draw_face_boxesç»˜åˆ¶è¯†åˆ«æ¡†128æ–¹æ³•</span><br><span class="line">run_face_recognitionè¿è¡Œè„¸éƒ¨è¯†åˆ«ç¨‹åº164æ–¹æ³•</span><br><span class="line">jpg_encode_streamJPGè§£ç 206æ–¹æ³•</span><br><span class="line">capture_handlerç»˜å›¾çº¿ç¨‹218æ–¹æ³•</span><br><span class="line">stream_handleræ•°æ®æµçº¿ç¨‹303æ–¹æ³•</span><br><span class="line">cmd_handleræ§åˆ¶çº¿ç¨‹453æ–¹æ³•</span><br><span class="line">status_handlerçŠ¶æ€çº¿ç¨‹540æ–¹æ³•</span><br><span class="line">index_handlerä¸»é¡µ581æ–¹æ³•</span><br><span class="line">startCameraServerå¯åŠ¨ç…§ç›¸æœºæœåŠ¡578æ–¹æ³•</span><br><span class="line">                                                </span><br><span class="line">                                                </span><br><span class="line">                                                </span><br><span class="line">                                                </span><br><span class="line">1234</span><br><span class="line">startCameraServerra_filter_initface_id_inithttpd_register_uri_handler</span><br><span class="line">                                                </span><br><span class="line">1index handlerindex handler/get</span><br><span class="line">                                                </span><br><span class="line">3status handlerstatus handler/statusgetesp_camera_sensor_gethttpd_resp_sendjson data</span><br><span class="line">                                                </span><br><span class="line">2cmd handlercmd handler/controlget</span><br><span class="line">    192.168.2.151</span><br><span class="line"></span><br><span class="line">4capture handlercapture handler/captureget</span><br><span class="line">                                                </span><br><span class="line">5stream handlerstream handler/streamgetface_detectrun_face_recognition</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="ç¨‹åºè®¾è®¡">ç¨‹åºè®¾è®¡</h2><h3 id="æµç¨‹è®¾è®¡">æµç¨‹è®¾è®¡</h3><blockquote><p>åŠŸèƒ½æµç¨‹</p></blockquote><p><img src="/2024/10/27/cat-camera/st.png" class="lazyload placeholder" data-srcset="/2024/10/27/cat-camera/st.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h3 id="ä¸»è¦åŠŸèƒ½">ä¸»è¦åŠŸèƒ½</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1.é€šè¿‡è¯­éŸ³è¯†åˆ«è®¿å®¢èº«ä»½</span><br><span class="line">2.é€šè¿‡äººè„¸è¯†åˆ«è®¿é—®è€…</span><br><span class="line">3.é€šè¿‡æ‘„åƒè¿›è¡Œç§»åŠ¨ä¾¦æµ‹</span><br><span class="line">4.å…¥ä¾µè€…æŠ¥è­¦</span><br><span class="line">5.å½•åƒã€æ‹ç…§æ•°æ®ä¿å­˜ï¼ˆäº‘å­˜å‚¨ï¼‰</span><br><span class="line">6.è®¿å®¢è¿‘è·ç¦»ä¾¦æµ‹åäº®ç¯</span><br><span class="line">7.é€šè¯å˜å£°</span><br><span class="line">8.è§†é¢‘é€šè¯</span><br><span class="line">9.WIFI+4Gè”ç½‘</span><br><span class="line">10.è¿æ¥å°åº¦æ™ºèƒ½åŠ©æ‰‹</span><br></pre></td></tr></table></figure><h2 id="åŠŸèƒ½å®ç°">åŠŸèƒ½å®ç°</h2><h3 id="äººè„¸è¯†åˆ«">äººè„¸è¯†åˆ«</h3><blockquote><p>è„¸éƒ¨ä¿¡æ¯å¯¹æ¯”</p></blockquote><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># # -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æµ‹äººè„¸</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detect_face</span>(<span class="params">img</span>):</span><br><span class="line">    <span class="comment">#å°†æµ‹è¯•å›¾åƒè½¬æ¢ä¸ºç°åº¦å›¾åƒï¼Œå› ä¸ºopencväººè„¸æ£€æµ‹å™¨éœ€è¦ç°åº¦å›¾åƒ</span></span><br><span class="line">    gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)</span><br><span class="line">    <span class="comment">#åŠ è½½OpenCVäººè„¸æ£€æµ‹åˆ†ç±»å™¨Haar</span></span><br><span class="line">    face_cascade = cv2.CascadeClassifier(<span class="string">&#x27;C:/Users/Administrator/Downloads/opencv-python-4.4.0.40/opencv-python-4.4.0.40/opencv/data/haarcascades_cuda/haarcascade_frontalface_default.xml&#x27;</span>)</span><br><span class="line">    <span class="comment">#æ£€æµ‹å¤šå°ºåº¦å›¾åƒï¼Œè¿”å›å€¼æ˜¯ä¸€å¼ è„¸éƒ¨åŒºåŸŸä¿¡æ¯çš„åˆ—è¡¨ï¼ˆx,y,å®½,é«˜ï¼‰</span></span><br><span class="line">    faces = face_cascade.detectMultiScale(gray, scaleFactor=<span class="number">1.2</span>, minNeighbors=<span class="number">5</span>)</span><br><span class="line">    <span class="comment"># å¦‚æœæœªæ£€æµ‹åˆ°é¢éƒ¨ï¼Œåˆ™è¿”å›åŸå§‹å›¾åƒ</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">len</span>(faces) == <span class="number">0</span>):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;errorï¼ æœªæ£€æµ‹åˆ°é¢éƒ¨å›¾åƒ&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">    <span class="comment">#ç›®å‰å‡è®¾åªæœ‰ä¸€å¼ è„¸ï¼Œxyä¸ºå·¦ä¸Šè§’åæ ‡ï¼Œwhä¸ºçŸ©å½¢çš„å®½é«˜</span></span><br><span class="line">    (x, y, w, h) = faces[<span class="number">0</span>]</span><br><span class="line">    <span class="comment">#è¿”å›å›¾åƒçš„æ­£é¢éƒ¨åˆ†</span></span><br><span class="line">    <span class="keyword">return</span> gray[y:y + w, x:x + h], faces[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯¥å‡½æ•°å°†è¯»å–æ‰€æœ‰çš„è®­ç»ƒå›¾åƒï¼Œä»æ¯ä¸ªå›¾åƒæ£€æµ‹äººè„¸å¹¶å°†è¿”å›ä¸¤ä¸ªç›¸åŒå¤§å°çš„åˆ—è¡¨ï¼Œåˆ†åˆ«ä¸ºè„¸éƒ¨ä¿¡æ¯å’Œæ ‡ç­¾</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">prepare_training_data</span>(<span class="params">data_folder_path</span>):</span><br><span class="line">    <span class="comment"># è·å–æ•°æ®æ–‡ä»¶å¤¹ä¸­çš„ç›®å½•ï¼ˆæ¯ä¸ªä¸»é¢˜çš„ä¸€ä¸ªç›®å½•ï¼‰</span></span><br><span class="line">    dirs = os.listdir(data_folder_path)</span><br><span class="line">    <span class="comment"># ä¸¤ä¸ªåˆ—è¡¨åˆ†åˆ«ä¿å­˜æ‰€æœ‰çš„è„¸éƒ¨å’Œæ ‡ç­¾</span></span><br><span class="line">    faces = []</span><br><span class="line">    labels = []</span><br><span class="line">    <span class="comment"># æµè§ˆæ¯ä¸ªç›®å½•å¹¶è®¿é—®å…¶ä¸­çš„å›¾åƒ</span></span><br><span class="line">    <span class="keyword">for</span> dir_name <span class="keyword">in</span> dirs:</span><br><span class="line">        <span class="comment"># dir_name(strç±»å‹)å³æ ‡ç­¾</span></span><br><span class="line">        label = <span class="built_in">int</span>(dir_name)</span><br><span class="line">        <span class="comment"># å»ºç«‹åŒ…å«å½“å‰ä¸»é¢˜ä¸»é¢˜å›¾åƒçš„ç›®å½•è·¯å¾„</span></span><br><span class="line">        subject_dir_path = data_folder_path + <span class="string">&quot;/&quot;</span> + dir_name</span><br><span class="line">        <span class="comment"># è·å–ç»™å®šä¸»é¢˜ç›®å½•å†…çš„å›¾åƒåç§°</span></span><br><span class="line">        subject_images_names = os.listdir(subject_dir_path)</span><br><span class="line">        <span class="comment"># æµè§ˆæ¯å¼ å›¾ç‰‡å¹¶æ£€æµ‹è„¸éƒ¨ï¼Œç„¶åå°†è„¸éƒ¨ä¿¡æ¯æ·»åŠ åˆ°è„¸éƒ¨åˆ—è¡¨faces[]</span></span><br><span class="line">    <span class="keyword">for</span> image_name <span class="keyword">in</span> subject_images_names:</span><br><span class="line">        <span class="comment"># å»ºç«‹å›¾åƒè·¯å¾„</span></span><br><span class="line">        image_path = subject_dir_path + <span class="string">&quot;/&quot;</span> + image_name</span><br><span class="line">        <span class="comment"># è¯»å–å›¾åƒ</span></span><br><span class="line">        image = cv2.imread(image_path)</span><br><span class="line">        <span class="comment"># æ˜¾ç¤ºå›¾åƒ0.1s</span></span><br><span class="line">        cv2.imshow(<span class="string">&quot;Training on image...&quot;</span>, image)</span><br><span class="line">        cv2.waitKey(<span class="number">100</span>)</span><br><span class="line">        <span class="comment"># æ£€æµ‹è„¸éƒ¨</span></span><br><span class="line">        face, rect = detect_face(image)</span><br><span class="line">        <span class="comment"># æˆ‘ä»¬å¿½ç•¥æœªæ£€æµ‹åˆ°çš„è„¸éƒ¨</span></span><br><span class="line">    <span class="keyword">if</span> face <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment">#å°†è„¸æ·»åŠ åˆ°è„¸éƒ¨åˆ—è¡¨å¹¶æ·»åŠ ç›¸åº”çš„æ ‡ç­¾</span></span><br><span class="line">        faces.append(face)</span><br><span class="line">        labels.append(label)</span><br><span class="line">        cv2.waitKey(<span class="number">1</span>)</span><br><span class="line">        cv2.destroyAllWindows()</span><br><span class="line">        <span class="comment">#æœ€ç»ˆè¿”å›å€¼ä¸ºäººè„¸å’Œæ ‡ç­¾åˆ—è¡¨</span></span><br><span class="line">        <span class="keyword">return</span> faces, labels</span><br><span class="line">    <span class="comment">#è°ƒç”¨prepare_training_dataï¼ˆï¼‰å‡½æ•°</span></span><br><span class="line">    faces, labels = prepare_training_data(<span class="string">&quot;training_data&quot;</span>)</span><br><span class="line">    <span class="comment">#åˆ›å»ºLBPHè¯†åˆ«å™¨å¹¶å¼€å§‹è®­ç»ƒï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€‰æ‹©Eigenæˆ–è€…Fisherè¯†åˆ«å™¨</span></span><br><span class="line">    face_recognizer = cv2.face.LBPHFaceRecognizer_create()</span><br><span class="line">    face_recognizer.train(faces, np.array(labels))</span><br><span class="line"><span class="comment">#æ ¹æ®ç»™å®šçš„ï¼ˆxï¼Œyï¼‰åæ ‡å’Œå®½åº¦é«˜åº¦åœ¨å›¾åƒä¸Šç»˜åˆ¶çŸ©å½¢</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">draw_rectangle</span>(<span class="params">img, rect</span>):</span><br><span class="line">    (x, y, w, h) = rect</span><br><span class="line">    cv2.rectangle(img, (x, y), (x + w, y + h), (<span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>), <span class="number">2</span>)</span><br><span class="line">    <span class="comment"># æ ¹æ®ç»™å®šçš„ï¼ˆxï¼Œyï¼‰åæ ‡æ ‡è¯†å‡ºäººå</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">draw_text</span>(<span class="params">img, text, x, y</span>):</span><br><span class="line">    cv2.putText(img, text, (x, y), cv2.FONT_HERSHEY_COMPLEX, <span class="number">1</span>, (<span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>), <span class="number">2</span>)</span><br><span class="line">    <span class="comment">#å»ºç«‹æ ‡ç­¾ä¸äººåçš„æ˜ å°„åˆ—è¡¨ï¼ˆæ ‡ç­¾åªèƒ½ä¸ºæ•´æ•°ï¼‰</span></span><br><span class="line">    subjects = [<span class="string">&quot;czq&quot;</span>, <span class="string">&quot;other&quot;</span>]</span><br><span class="line">    <span class="comment"># æ­¤å‡½æ•°è¯†åˆ«ä¼ é€’çš„å›¾åƒä¸­çš„äººç‰©å¹¶åœ¨æ£€æµ‹åˆ°çš„è„¸éƒ¨å‘¨å›´ç»˜åˆ¶ä¸€ä¸ªçŸ©å½¢åŠå…¶åç§°</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">predict</span>(<span class="params">test_img</span>):</span><br><span class="line">    <span class="comment">#ç”Ÿæˆå›¾åƒçš„å‰¯æœ¬ï¼Œè¿™æ ·å°±èƒ½ä¿ç•™åŸå§‹å›¾åƒ</span></span><br><span class="line">    img = test_img.copy()</span><br><span class="line">    <span class="comment">#æ£€æµ‹äººè„¸</span></span><br><span class="line">    face, rect = detect_face(img)</span><br><span class="line">    <span class="comment">#é¢„æµ‹äººè„¸</span></span><br><span class="line">    label = predict(face)</span><br><span class="line">    <span class="comment"># è·å–ç”±äººè„¸è¯†åˆ«å™¨è¿”å›çš„ç›¸åº”æ ‡ç­¾çš„åç§°</span></span><br><span class="line">    label_text = subjects[label[<span class="number">0</span>]]</span><br><span class="line">    <span class="comment"># åœ¨æ£€æµ‹åˆ°çš„è„¸éƒ¨å‘¨å›´ç”»ä¸€ä¸ªçŸ©å½¢</span></span><br><span class="line">    draw_rectangle(img, rect)</span><br><span class="line">    <span class="comment"># æ ‡å‡ºé¢„æµ‹çš„åå­—</span></span><br><span class="line">    draw_text(img, label_text, rect[<span class="number">0</span>], rect[<span class="number">1</span>] - <span class="number">5</span>)</span><br><span class="line">    <span class="comment">#è¿”å›é¢„æµ‹çš„å›¾åƒ</span></span><br><span class="line">    <span class="keyword">return</span> img</span><br><span class="line"><span class="comment">#åŠ è½½æµ‹è¯•å›¾åƒ</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">test_img1 = cv2.imread(<span class="string">&quot;../images/face_img/face9.png&quot;</span>)</span><br><span class="line">test_img2 = cv2.imread(<span class="string">&quot;../images/face_img/face1.png&quot;</span>)</span><br><span class="line"><span class="comment">#æ‰§è¡Œé¢„æµ‹</span></span><br><span class="line">predicted_img1 = predict(test_img1)</span><br><span class="line">predicted_img2 = predict(test_img2)</span><br><span class="line"><span class="comment">#æ˜¾ç¤ºä¸¤ä¸ªå›¾åƒ</span></span><br><span class="line">cv2.imshow(subjects[<span class="number">0</span>], predicted_img1)</span><br><span class="line">cv2.imshow(subjects[<span class="number">1</span>], predicted_img2)</span><br><span class="line">cv2.waitKey(<span class="number">0</span>)</span><br><span class="line">cv2.destroyAllWindows()</span><br></pre></td></tr></table></figure><h4 id="ä¸²å£æ•°æ®è·å–">ä¸²å£æ•°æ®è·å–</h4><blockquote><p>æ•°æ®æµè·å–</p></blockquote><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># /usr/bin/env/python3</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;use opencv3 to capture video frame, show and save its stream.&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stream_processing</span>():</span><br><span class="line">    <span class="comment"># è·å–VideoCaptureç±»å®ä¾‹ï¼Œè¯»å–è§†é¢‘æ–‡ä»¶</span></span><br><span class="line">    fcap = cv2.VideoCapture(<span class="string">&#x27;http://192.168.1.104:81/stream&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®æ‘„åƒå¤´åˆ†è¾¨ç‡çš„é«˜</span></span><br><span class="line">    fcap.<span class="built_in">set</span>(cv2.CAP_PROP_FRAME_HEIGHT, <span class="number">1080</span>)</span><br><span class="line">    <span class="comment"># è®¾ç½®æ‘„åƒå¤´åˆ†è¾¨ç‡çš„å®½</span></span><br><span class="line">    fcap.<span class="built_in">set</span>(cv2.CAP_PROP_FRAME_WIDTH, <span class="number">1920</span>)</span><br><span class="line">    <span class="comment"># è·³åˆ°æŸä¸€æ„Ÿå…´è¶£å¸§å¹¶ä»æ­¤å¸§å¼€å§‹è¯»å–,å¦‚ä»ç¬¬360å¸§å¼€å§‹è¯»å–</span></span><br><span class="line">    fcap.<span class="built_in">set</span>(cv2.CAP_PROP_POS_FRAMES, <span class="number">360</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å–è§†é¢‘å¸§çš„å®½</span></span><br><span class="line">    w = fcap.get(cv2.CAP_PROP_FRAME_WIDTH)</span><br><span class="line">    <span class="comment"># è·å–è§†é¢‘å¸§çš„é«˜</span></span><br><span class="line">    h = fcap.get(cv2.CAP_PROP_FRAME_HEIGHT)</span><br><span class="line">    <span class="comment"># è·å–è§†é¢‘å¸§çš„å¸§ç‡</span></span><br><span class="line">    fps = fcap.get(cv2.CAP_PROP_FPS)</span><br><span class="line">    <span class="comment"># è·å–è§†é¢‘æµçš„æ€»å¸§æ•°</span></span><br><span class="line">    fcount = fcap.get(cv2.CAP_PROP_FRAME_COUNT)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å–VideoWriterç±»å®ä¾‹</span></span><br><span class="line">    writer = cv2.VideoWriter(<span class="string">&#x27;http://192.168.1.104:81/stream&#x27;</span>, cv2.VideoWriter_fourcc(<span class="string">&#x27;X&#x27;</span>, <span class="string">&#x27;V&#x27;</span>, <span class="string">&#x27;I&#x27;</span>, <span class="string">&#x27;D&#x27;</span>), <span class="built_in">int</span>(fps), (<span class="built_in">int</span>(w), <span class="built_in">int</span>(h)))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ¤æ–­æ˜¯å¦æ­£ç¡®è·å–VideoCaptureç±»å®ä¾‹</span></span><br><span class="line">    <span class="keyword">while</span> fcap.isOpened():</span><br><span class="line">        <span class="comment"># è·å–å¸§ç”»é¢</span></span><br><span class="line">        success, frame = fcap.read()</span><br><span class="line">        <span class="keyword">while</span> success:</span><br><span class="line">            cv2.imshow(<span class="string">&quot;demo&quot;</span>, frame)  <span class="comment">## æ˜¾ç¤ºç”»é¢</span></span><br><span class="line">            <span class="comment"># è·å–å¸§ç”»é¢</span></span><br><span class="line">            success, frame = fcap.read()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># ä¿å­˜å¸§æ•°æ®</span></span><br><span class="line">            writer.write(frame)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cv2.waitKey(<span class="number">20</span>) &amp; <span class="number">0xff</span>) == <span class="built_in">ord</span>(<span class="string">&#x27;q&#x27;</span>):  <span class="comment">## ç­‰å¾…20mså¹¶åˆ¤æ–­æ˜¯æŒ‰â€œqâ€é€€å‡ºï¼Œç›¸å½“äºå¸§ç‡æ˜¯50hzï¼Œæ³¨æ„waitKeyåªèƒ½ä¼ å…¥æ•´æ•°ï¼Œ</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="comment"># é‡Šæ”¾VideoCaptureèµ„æº</span></span><br><span class="line">        fcap.release()</span><br><span class="line">    <span class="comment"># é‡Šæ”¾VideoWriterèµ„æº</span></span><br><span class="line">    writer.release()</span><br><span class="line">    cv2.destroyAllWindows()  <span class="comment">## é”€æ¯æ‰€æœ‰opencvæ˜¾ç¤ºçª—å£</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    stream_processing()</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>è§†é¢‘ç”Ÿæˆcå­˜å‚¨</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env python</span></span><br><span class="line">import cv2</span><br><span class="line">from cv2 import VideoWriter, VideoWriter_fourcc, imread, resize</span><br><span class="line">import os</span><br><span class="line">import time</span><br><span class="line">import readSql</span><br><span class="line">import datetime</span><br><span class="line"><span class="string">&#x27;&#x27;</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@theme è§†é¢‘å­˜å‚¨å¤„ç†</span></span><br><span class="line"><span class="string">@author czq</span></span><br><span class="line"><span class="string">@date 2021 01 12</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;</span><span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def pic_save_video():</span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">    å›¾ç‰‡è½¬è§†é¢‘</span></span><br><span class="line"><span class="string">    &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    img_root = <span class="string">&quot;E:/czq/personFile/catCamera/src/server/data/video_img/&quot;</span></span><br><span class="line">    <span class="comment"># Edit each frame&#x27;s appearing time! E:\czq\personFile\catCamera\src\server\data\video_img src\server\data\video_img</span></span><br><span class="line">    fps = 5</span><br><span class="line">    <span class="comment"># fourcc=VideoWriter_fourcc(*&quot;MJPG&quot;)</span></span><br><span class="line">    <span class="comment"># videoWriter=cv2.VideoWriter(&quot;./Vid.avi&quot;,fourcc,fps,(720,720))</span></span><br><span class="line">    localtime = datetime.datetime.now()</span><br><span class="line">    <span class="built_in">date</span> = str(localtime.year) + <span class="string">&quot; &quot;</span> + str(localtime.month) + <span class="string">&quot; &quot;</span> + str(localtime.day)</span><br><span class="line">    <span class="built_in">times</span> = str(localtime.hour) + <span class="string">&quot;:&quot;</span> + str(localtime.minute) + <span class="string">&quot;:&quot;</span> + str(localtime.minute)</span><br><span class="line">    video_src = <span class="string">&#x27;E:/czq/personFile/catCamera/src/server/data/video/catEye&#x27;</span> + <span class="built_in">date</span> +<span class="string">&#x27;.avi&#x27;</span></span><br><span class="line">    <span class="built_in">print</span>(video_src)</span><br><span class="line">    videoWriter = cv2.VideoWriter(video_src, cv2.VideoWriter_fourcc(<span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;P&#x27;</span>, <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;G&#x27;</span>), fps, (720, 720))</span><br><span class="line">    im_names = os.listdir(img_root)</span><br><span class="line">    <span class="comment"># for im_name in range(len(im_names)):</span></span><br><span class="line">    <span class="keyword">for</span> filename <span class="keyword">in</span> im_names:</span><br><span class="line">        <span class="comment"># frame=cv2.imread(img_root+str(im_name)+&#x27;.jpg&#x27;)</span></span><br><span class="line">        imgname = <span class="string">&quot;E:/czq/personFile/catCamera/src/server/data/video_img/&quot;</span> + filename</span><br><span class="line">        frame = cv2.imread(imgname)</span><br><span class="line">        try:</span><br><span class="line">            frame = cv2.resize(frame, (720, 720))</span><br><span class="line">            cv2.imshow(<span class="string">&quot;çŒ«çœ¼è§†é¢‘(catEye video)&quot;</span>, frame)</span><br><span class="line">        except cv2.error as ce:</span><br><span class="line">            <span class="built_in">print</span>(ce)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;cv2.error å›¾ç‰‡æ—‹è½¬é”™è¯¯&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(imgname)</span><br><span class="line"></span><br><span class="line">        time.sleep(0.02)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;saving video .....&#x27;</span>)</span><br><span class="line">        videoWriter.write(frame)</span><br><span class="line">        cv2.waitKey(1)</span><br><span class="line">    videoWriter.release()</span><br><span class="line">    readSql.catchVideo(video_src, <span class="string">&#x27;catEye01&#x27;</span> + <span class="built_in">date</span> + <span class="built_in">times</span>, 1000)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;saving video .....successful ,please close frame&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pic_save_video()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="äººè„¸è¯†åˆ«-2">äººè„¸è¯†åˆ«</h4><blockquote><p>ç§»åŠ¨ä¾¦æµ‹</p></blockquote><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> dlib  <span class="comment"># äººè„¸è¯†åˆ«çš„åº“dlib</span></span><br><span class="line"><span class="keyword">import</span> numpy</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np  <span class="comment"># æ•°æ®å¤„ç†çš„åº“numpy</span></span><br><span class="line"><span class="keyword">import</span> cv2  <span class="comment"># å›¾åƒå¤„ç†çš„åº“OpenCv</span></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd  <span class="comment"># æ•°æ®å¤„ç†çš„åº“Pandas</span></span><br><span class="line"><span class="keyword">import</span> wx</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> _thread</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Sub_Client</span><br><span class="line"><span class="keyword">import</span> readSql</span><br><span class="line"><span class="keyword">import</span> win32api,win32con</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ç§»åŠ¨ä¾¦æµ‹ </span></span><br><span class="line"><span class="string">@author czq</span></span><br><span class="line"><span class="string">@date 2020 12 28</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># face recognition model, the object maps human faces into 128D vectors</span></span><br><span class="line">facerec = dlib.face_recognition_model_v1(<span class="string">&quot;model/dlib_face_recognition_resnet_model_v1.dat&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Dlib é¢„æµ‹å™¨</span></span><br><span class="line">detector = dlib.get_frontal_face_detector()</span><br><span class="line">predictor = dlib.shape_predictor(<span class="string">&#x27;model/shape_predictor_68_face_landmarks.dat&#x27;</span>)</span><br><span class="line"></span><br><span class="line">loading = <span class="string">&#x27;icon/loading.png&#x27;</span></span><br><span class="line">pun_fail = <span class="string">&#x27;icon/pun_fail.png&#x27;</span></span><br><span class="line">pun_repeat = <span class="string">&#x27;icon/pun_repeat.png&#x27;</span></span><br><span class="line">pun_success = <span class="string">&#x27;icon/pun_success.png&#x27;</span></span><br><span class="line"></span><br><span class="line">path_logcat_csv = <span class="string">&quot;data/logcat.csv&quot;</span></span><br><span class="line">user_flag = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_csv_to_recoders</span>():</span><br><span class="line">    recodes = []</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(path_logcat_csv):</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(path_logcat_csv, <span class="string">&quot;r&quot;</span>, newline=<span class="string">&quot;&quot;</span>) <span class="keyword">as</span> csvfiler:</span><br><span class="line">            reader = csv.reader(csvfiler)</span><br><span class="line">            <span class="keyword">for</span> row <span class="keyword">in</span> reader:</span><br><span class="line">                recodes.append(row)  <span class="comment"># åŒ…æ‹¬header</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(path_logcat_csv, <span class="string">&quot;w&quot;</span>, newline=<span class="string">&quot;&quot;</span>) <span class="keyword">as</span> csvfilew:</span><br><span class="line">            writer = csv.writer(csvfilew)</span><br><span class="line">            header = [<span class="string">&quot;å§“å&quot;</span>, <span class="string">&quot;æ—¥æœŸ&quot;</span>, <span class="string">&quot;æ—¶é—´&quot;</span>]</span><br><span class="line">            writer.writerow(header)</span><br><span class="line">    <span class="keyword">return</span> recodes</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¡ç®—ä¸¤ä¸ªå‘é‡é—´çš„æ¬§å¼è·ç¦»</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">return_euclidean_distance</span>(<span class="params">feature_1, feature_2</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param feature_1: å‘é‡ä¸€</span></span><br><span class="line"><span class="string">    :param feature_2: å‘é‡äºŒ</span></span><br><span class="line"><span class="string">    :return: diff or same</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    feature_1 = np.array(feature_1)</span><br><span class="line">    feature_2 = np.array(feature_2)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        dist = np.sqrt(np.<span class="built_in">sum</span>(np.square(feature_1 - feature_2)))</span><br><span class="line">        <span class="keyword">if</span> dist &gt; <span class="number">0.4</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;diff&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;same&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;æ¬§å¼è·ç¦»: &quot;</span>, dist)</span><br><span class="line">    <span class="keyword">except</span> numpy.core._exceptions.UFuncTypeError <span class="keyword">as</span> ne:</span><br><span class="line">        <span class="built_in">print</span>(ne)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤„ç†å­˜æ”¾æ‰€æœ‰äººè„¸ç‰¹å¾çš„csv</span></span><br><span class="line">path_feature_known_csv = <span class="string">&quot;data/feature_all.csv&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># path_features_known_csv= &quot;/media/con/data/code/python/P_dlib_face_reco/data/csvs/features_all.csv&quot;</span></span><br><span class="line">csv_rd = pd.read_csv(path_feature_known_csv, header=<span class="literal">None</span>, encoding=<span class="string">&#x27;gbk&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å­˜å‚¨çš„ç‰¹å¾äººè„¸ä¸ªæ•°</span></span><br><span class="line"><span class="comment"># print(csv_rd.shape)</span></span><br><span class="line"><span class="comment"># ï¼ˆ2ï¼Œ129ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”¨æ¥å­˜æ”¾æ‰€æœ‰å½•å…¥äººè„¸ç‰¹å¾çš„æ•°ç»„</span></span><br><span class="line">features_known_arr = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(&quot;s0&quot;,csv_rd.shape[0],&quot;s1&quot;,csv_rd.shape[1])</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(csv_rd.shape[<span class="number">0</span>]):</span><br><span class="line">    features_someone_arr = []</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(csv_rd.iloc[i, :])):</span><br><span class="line">        features_someone_arr.append(csv_rd.iloc[i, :][j])</span><br><span class="line">    <span class="comment">#    print(features_someone_arr)</span></span><br><span class="line">    features_known_arr.append(features_someone_arr)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;æ•°æ®åº“äººè„¸æ•°:&quot;</span>, <span class="built_in">len</span>(features_known_arr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿”å›ä¸€å¼ å›¾åƒå¤šå¼ äººè„¸çš„128Dç‰¹å¾  åªè¿”å›ä¸€å¼ äººè„¸</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_128d_features</span>(<span class="params">img_gray</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param img_gray: ç°åº¦å›¾</span></span><br><span class="line"><span class="string">    :return: äººè„¸</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    dets = detector(img_gray, <span class="number">1</span>)</span><br><span class="line">    shape = predictor(img_gray, dets[<span class="number">0</span>])</span><br><span class="line">    face_des = facerec.compute_face_descriptor(img_gray, shape)</span><br><span class="line">    <span class="keyword">return</span> face_des</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PunchcardUi</span>(wx.Frame):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">     ç§»åŠ¨ä¾¦æµ‹ä¸»ç•Œé¢</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, superion</span>):</span><br><span class="line">        wx.Frame.__init__(<span class="variable language_">self</span>, parent=superion, title=<span class="string">&quot;catEye&quot;</span>, size=(<span class="number">800</span>, <span class="number">590</span>),</span><br><span class="line">                          style=wx.DEFAULT_FRAME_STYLE | wx.STAY_ON_TOP)</span><br><span class="line">        <span class="variable language_">self</span>.SetBackgroundColour(<span class="string">&#x27;white&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.Center()</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.OpenCapButton = wx.Button(parent=<span class="variable language_">self</span>, pos=(<span class="number">50</span>, <span class="number">120</span>), size=(<span class="number">90</span>, <span class="number">60</span>), label=<span class="string">&#x27;å¼€å§‹æ£€æµ‹&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.resultText = wx.StaticText(parent=<span class="variable language_">self</span>, style=wx.ALIGN_CENTER_VERTICAL, pos=(<span class="number">50</span>, <span class="number">320</span>), size=(<span class="number">90</span>, <span class="number">60</span>),</span><br><span class="line">                                        label=<span class="string">&quot;æœªçŸ¥ç”¨æˆ·æŠ¥è­¦&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.resultText.SetBackgroundColour(<span class="string">&#x27;white&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.resultText.SetForegroundColour(<span class="string">&#x27;blue&#x27;</span>)</span><br><span class="line">        font = wx.Font(<span class="number">14</span>, wx.DECORATIVE, wx.ITALIC, wx.NORMAL)</span><br><span class="line">        <span class="variable language_">self</span>.resultText.SetFont(font)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.pun_day_num = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># å°é¢å›¾ç‰‡</span></span><br><span class="line">        <span class="variable language_">self</span>.image_loading = wx.Image(loading, wx.BITMAP_TYPE_ANY).Scale(<span class="number">600</span>, <span class="number">480</span>)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.image_fail = wx.Image(pun_fail, wx.BITMAP_TYPE_ANY).Scale(<span class="number">600</span>, <span class="number">480</span>)</span><br><span class="line">        <span class="variable language_">self</span>.image_repeat = wx.Image(pun_repeat, wx.BITMAP_TYPE_ANY).Scale(<span class="number">600</span>, <span class="number">480</span>)</span><br><span class="line">        <span class="variable language_">self</span>.image_success = wx.Image(pun_success, wx.BITMAP_TYPE_ANY).Scale(<span class="number">600</span>, <span class="number">480</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ˜¾ç¤ºå›¾ç‰‡</span></span><br><span class="line">        <span class="variable language_">self</span>.bmp = wx.StaticBitmap(parent=<span class="variable language_">self</span>, pos=(<span class="number">180</span>, <span class="number">20</span>), bitmap=wx.Bitmap(<span class="variable language_">self</span>.image_loading))</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.Bind(wx.EVT_BUTTON, <span class="variable language_">self</span>.OnOpenCapButtonClicked, <span class="variable language_">self</span>.OpenCapButton)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">OnOpenCapButtonClicked</span>(<span class="params">self, event</span>):</span><br><span class="line"></span><br><span class="line">        <span class="string">&quot;&quot;&quot;ä½¿ç”¨å¤šçº¿ç¨‹ï¼Œå­çº¿ç¨‹è¿è¡Œåå°çš„ç¨‹åºï¼Œä¸»çº¿ç¨‹æ›´æ–°å‰å°çš„UIï¼Œè¿™æ ·ä¸ä¼šäº’ç›¸å½±å“&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># åˆ›å»ºå­çº¿ç¨‹ï¼ŒæŒ‰é’®è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œ</span></span><br><span class="line">        _thread.start_new_thread(<span class="variable language_">self</span>._open_cap, (event,))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_open_cap</span>(<span class="params">self, event</span>):</span><br><span class="line">        <span class="comment"># åˆ›å»º cv2 æ‘„åƒå¤´å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">global</span> dets</span><br><span class="line">        urlc = <span class="string">&#x27;http://192.168.1.104:81/stream&#x27;</span></span><br><span class="line">        localtime = datetime.datetime.now()</span><br><span class="line">        date = <span class="built_in">str</span>(localtime.year) + <span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(localtime.month) + <span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(localtime.day)</span><br><span class="line">        time = <span class="built_in">str</span>(localtime.hour) + <span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(localtime.minute) + <span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(localtime.minute)</span><br><span class="line">        video_src = <span class="string">&#x27;E:/czq/personFile/catCamera/src/server/data/video/catEye&#x27;</span> + date + <span class="string">&#x27;.avi&#x27;</span></span><br><span class="line"></span><br><span class="line">        a = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.cap = cv2.VideoCapture(video_src)</span><br><span class="line">        <span class="comment"># cap.set(propId, value)</span></span><br><span class="line">        <span class="comment"># è®¾ç½®è§†é¢‘å‚æ•°ï¼ŒpropIdè®¾ç½®çš„è§†é¢‘å‚æ•°ï¼Œvalueè®¾ç½®çš„å‚æ•°å€¼</span></span><br><span class="line">        <span class="variable language_">self</span>.cap.<span class="built_in">set</span>(<span class="number">3</span>, <span class="number">480</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># capæ˜¯å¦åˆå§‹åŒ–æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">while</span> <span class="variable language_">self</span>.cap.isOpened():</span><br><span class="line"></span><br><span class="line">            <span class="comment"># cap.read()</span></span><br><span class="line">            <span class="comment"># è¿”å›ä¸¤ä¸ªå€¼ï¼š</span></span><br><span class="line">            <span class="comment">#    ä¸€ä¸ªå¸ƒå°”å€¼true/falseï¼Œç”¨æ¥åˆ¤æ–­è¯»å–è§†é¢‘æ˜¯å¦æˆåŠŸ/æ˜¯å¦åˆ°è§†é¢‘æœ«å°¾</span></span><br><span class="line">            <span class="comment">#    å›¾åƒå¯¹è±¡ï¼Œå›¾åƒçš„ä¸‰ç»´çŸ©é˜µ</span></span><br><span class="line">            flag, im_rd = <span class="variable language_">self</span>.cap.read()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># æ¯å¸§æ•°æ®å»¶æ—¶1msï¼Œå»¶æ—¶ä¸º0è¯»å–çš„æ˜¯é™æ€å¸§</span></span><br><span class="line">            kk = cv2.waitKey(<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># äººè„¸æ•° dets</span></span><br><span class="line">                dets = detector(im_rd, <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">except</span> TypeError <span class="keyword">as</span> te:</span><br><span class="line">                <span class="built_in">print</span>(te)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;äººè„¸æ•°ç›®è·å–é”™è¯¯ï¼&#x27;</span>)</span><br><span class="line">            <span class="comment"># å¾…ä¼šè¦å†™çš„å­—ä½“</span></span><br><span class="line">            font = cv2.FONT_HERSHEY_SIMPLEX</span><br><span class="line"></span><br><span class="line">            <span class="comment"># å­˜å‚¨äººè„¸åå­—å’Œä½ç½®çš„ä¸¤ä¸ª list</span></span><br><span class="line">            <span class="comment"># list 1 (dets): store the name of faces                Jack    unknown unknown Mary</span></span><br><span class="line">            <span class="comment"># list 2 (pos_namelist): store the positions of faces   12,1    1,21    1,13    31,1</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># äººè„¸çš„åå­—</span></span><br><span class="line">            name = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            pos = <span class="string">&#x27;&#x27;</span></span><br><span class="line">            <span class="comment"># pos_namelist = []</span></span><br><span class="line">            <span class="comment"># name_namelist = []</span></span><br><span class="line">            count = <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(dets) != <span class="number">0</span>:</span><br><span class="line">                <span class="comment"># æ£€æµ‹åˆ°äººè„¸</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># è·å–å½“å‰æ•è·åˆ°çš„å›¾åƒçš„æ‰€æœ‰äººè„¸çš„ç‰¹å¾ï¼Œå­˜å‚¨åˆ° features_cap_arr</span></span><br><span class="line">                features_cap = <span class="string">&#x27;&#x27;</span></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    shape = predictor(im_rd, dets[<span class="number">0</span>])</span><br><span class="line">                <span class="keyword">except</span> TypeError <span class="keyword">as</span> te:</span><br><span class="line">                    <span class="built_in">print</span>(te)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;error!&#x27;</span>)</span><br><span class="line">                features_cap = facerec.compute_face_descriptor(im_rd, shape)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># éå†æ•è·åˆ°çš„å›¾åƒä¸­æ‰€æœ‰çš„äººè„¸</span></span><br><span class="line">                <span class="comment"># è®©äººåè·Ÿéšåœ¨çŸ©å½¢æ¡†çš„ä¸‹æ–¹</span></span><br><span class="line">                <span class="comment"># ç¡®å®šäººåçš„ä½ç½®åæ ‡</span></span><br><span class="line">                <span class="comment"># å…ˆé»˜è®¤æ‰€æœ‰äººä¸è®¤è¯†ï¼Œæ˜¯ unknown</span></span><br><span class="line">                name = <span class="string">&quot;unrecognized face&quot;</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># æ¯ä¸ªæ•è·äººè„¸çš„åå­—åæ ‡</span></span><br><span class="line">                pos = <span class="built_in">tuple</span>([(<span class="built_in">int</span>)((dets[<span class="number">0</span>].left() + dets[<span class="number">0</span>].right()) / <span class="number">2</span>) - <span class="number">50</span></span><br><span class="line">                                , dets[<span class="number">0</span>].bottom() + <span class="number">20</span>])</span><br><span class="line"></span><br><span class="line">                <span class="comment"># å¯¹äºæŸå¼ äººè„¸ï¼Œéå†æ‰€æœ‰å­˜å‚¨çš„äººè„¸ç‰¹å¾</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(features_known_arr)):</span><br><span class="line">                    <span class="comment"># å°†æŸå¼ äººè„¸ä¸å­˜å‚¨çš„æ‰€æœ‰äººè„¸æ•°æ®è¿›è¡Œæ¯”å¯¹</span></span><br><span class="line">                    <span class="variable language_">self</span>.pun_day_num = <span class="number">0</span></span><br><span class="line">                    compare = return_euclidean_distance(features_cap, features_known_arr[i][<span class="number">0</span>:-<span class="number">1</span>])</span><br><span class="line">                    <span class="keyword">if</span> compare == <span class="string">&quot;same&quot;</span>:  <span class="comment"># æ‰¾åˆ°äº†ç›¸ä¼¼è„¸</span></span><br><span class="line">                        name = features_known_arr[i][-<span class="number">1</span>]</span><br><span class="line">                        recoder = []</span><br><span class="line">                        recoder.append(name)</span><br><span class="line">                        localtime = datetime.datetime.now()</span><br><span class="line">                        date = <span class="built_in">str</span>(localtime.year) + <span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(localtime.month) + <span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(localtime.day)+ <span class="string">&#x27; &#x27;</span></span><br><span class="line">                        time = <span class="built_in">str</span>(localtime.hour) + <span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(localtime.minute) + <span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(localtime.minute)</span><br><span class="line">                        recoder.append(date)</span><br><span class="line">                        recoder.append(time)</span><br><span class="line">                        recoders = read_csv_to_recoders()</span><br><span class="line">                        filename = <span class="string">&#x27;data/move_test_img/&#x27;</span> + name + date + time + <span class="string">&quot;.png&quot;</span></span><br><span class="line">                        <span class="built_in">print</span>(filename)</span><br><span class="line">                        cv2.imwrite(filename, im_rd)</span><br><span class="line">                        user_flag = <span class="number">1</span>  <span class="comment"># å·²çŸ¥äººè„¸</span></span><br><span class="line">                        <span class="built_in">print</span>(recoders)</span><br><span class="line">                        Sub_Client.upload_image(filename, <span class="string">&#x27;faceImgRegister&#x27;</span>, <span class="string">&#x27;face image register successful&#x27;</span>)</span><br><span class="line">                        readSql.move_test_save_data(name, filename, user_flag)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># ç»˜åˆ¶çŸ©å½¢æ¡†</span></span><br><span class="line">                cv2.rectangle(im_rd, <span class="built_in">tuple</span>([dets[<span class="number">0</span>].left(), dets[<span class="number">0</span>].top()]), <span class="built_in">tuple</span>([dets[<span class="number">0</span>].right(), dets[<span class="number">0</span>].bottom()]),</span><br><span class="line">                              (<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># å†™äººè„¸åå­—</span></span><br><span class="line">                cv2.putText(im_rd, name, pos, font, <span class="number">0.8</span>, (<span class="number">255</span>, <span class="number">0</span>, <span class="number">255</span>), <span class="number">1</span>, cv2.LINE_AA)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> name == <span class="string">&quot;unrecognized face&quot;</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;danger\r\n&quot;</span>)</span><br><span class="line">                    <span class="keyword">import</span> time</span><br><span class="line">                    <span class="keyword">import</span> ctypes</span><br><span class="line">                    player = ctypes.windll.kernel32</span><br><span class="line">                    player.Beep(<span class="number">1000</span>, <span class="number">200</span>)</span><br><span class="line">                    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">                        time.sleep(<span class="number">1</span>)</span><br><span class="line">                        player.Beep(<span class="number">1000</span>, <span class="number">200</span>)</span><br><span class="line">                  <span class="comment">#  try:</span></span><br><span class="line">                       <span class="comment"># wx.MessageBox(message=&quot;æœ‰äººå…¥ä¾µäº†&quot;, caption=&quot;å¯æ€•çš„æ¶ˆæ¯&quot;)</span></span><br><span class="line">                        <span class="comment">#win32api.MessageBox(0, &quot;æœ‰äººå…¥ä¾µäº†&quot;, &quot;warning&quot;, win32con.MB_ICONWARNING)</span></span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&#x27;wx.MessageBox(message=&quot;æœ‰äººå…¥ä¾µäº†&quot;, caption=&quot;å¯æ€•çš„æ¶ˆæ¯&quot;)&#x27;</span>)</span><br><span class="line">                    <span class="comment"># except wx._core.PyNoAppError as wpnae:</span></span><br><span class="line">                    <span class="comment">#     print(wpnae)</span></span><br><span class="line">                    <span class="comment">#     print(&#x27;æœªçŸ¥é”™è¯¯&#x27;)</span></span><br><span class="line">                    <span class="comment">#     print(&#x27;&#x27;)</span></span><br><span class="line">                    localtime = datetime.datetime.now()</span><br><span class="line">                    date = <span class="built_in">str</span>(localtime.year) + <span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(localtime.month) + <span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(localtime.day) + <span class="string">&#x27; &#x27;</span></span><br><span class="line">                    time = <span class="built_in">str</span>(localtime.hour) + <span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(localtime.minute) + <span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(localtime.minute)</span><br><span class="line">                    user_flag = <span class="number">0</span>  <span class="comment"># æœªçŸ¥äººè„¸</span></span><br><span class="line"></span><br><span class="line">                    filename = <span class="string">&#x27;data/move_test_img/&#x27;</span> + name + date + time + <span class="string">&quot;.png&quot;</span></span><br><span class="line">                    <span class="built_in">print</span>(filename)</span><br><span class="line">                    cv2.imwrite(filename, im_rd)</span><br><span class="line">                    <span class="comment"># print(recoders)</span></span><br><span class="line">                    Sub_Client.upload_image(filename, <span class="string">&#x27;faceRecognizeImage&#x27;</span>, <span class="string">&#x27;face recognize successful&#x27;</span>)</span><br><span class="line">                    readSql.move_test_save_data(name, filename, user_flag)</span><br><span class="line">                    <span class="comment"># _thread.exit()</span></span><br><span class="line"></span><br><span class="line">            cv2.putText(im_rd, <span class="string">&quot;Faces: &quot;</span> + <span class="built_in">str</span>(<span class="built_in">len</span>(dets)), (<span class="number">50</span>, <span class="number">80</span>), font, <span class="number">1</span>, (<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="number">1</span>, cv2.LINE_AA)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                height, width = im_rd.shape[:<span class="number">2</span>]</span><br><span class="line">                image1 = cv2.cvtColor(im_rd, cv2.COLOR_BGR2RGB)</span><br><span class="line">                pic = wx.Bitmap.FromBuffer(width, height, image1)</span><br><span class="line">                <span class="comment"># æ˜¾ç¤ºå›¾ç‰‡åœ¨panelä¸Š</span></span><br><span class="line">                <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                bug 001 </span></span><br><span class="line"><span class="string">                2020 01 16</span></span><br><span class="line"><span class="string">                &#x27;&#x27;&#x27;</span></span><br><span class="line">                <span class="variable language_">self</span>.bmp.SetBitmap(pic)</span><br><span class="line">            <span class="keyword">except</span> AttributeError <span class="keyword">as</span> ae:</span><br><span class="line">                <span class="built_in">print</span>(ae)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;äººè„¸å›¾ç‰‡åˆ‡å‰²é”™è¯¯&#x27;</span>)</span><br><span class="line">            <span class="comment"># pic = None</span></span><br><span class="line">            <span class="keyword">except</span> cv2.error <span class="keyword">as</span> ce:</span><br><span class="line">                <span class="built_in">print</span>(ce)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;å›¾ç‰‡ç°åº¦åŒ–é”™è¯¯ï¼&#x27;</span>)</span><br><span class="line">            <span class="keyword">except</span> RuntimeError <span class="keyword">as</span> re:</span><br><span class="line">                <span class="built_in">print</span>(re)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;è¿è¡Œä¸­ç¨‹åºå‡ºé”™&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="äººè„¸æ³¨å†Œ">äººè„¸æ³¨å†Œ</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np  <span class="comment"># æ•°æ®å¤„ç†çš„åº“ Numpy</span></span><br><span class="line"><span class="keyword">import</span> cv2  <span class="comment"># å›¾åƒå¤„ç†çš„åº“ OpenCv</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> _thread</span><br><span class="line"><span class="keyword">import</span> wx</span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">from</span> importlib <span class="keyword">import</span> reload</span><br><span class="line"><span class="keyword">from</span> skimage <span class="keyword">import</span> io <span class="keyword">as</span> iio</span><br><span class="line"><span class="keyword">import</span> face_recognize_punchcard</span><br><span class="line"><span class="keyword">import</span> readSql</span><br><span class="line"><span class="keyword">import</span> tkinter</span><br><span class="line"><span class="keyword">from</span> tkinter <span class="keyword">import</span> Checkbutton, IntVar</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> src.server.myapp <span class="keyword">import</span> MainApp</span><br><span class="line"><span class="keyword">import</span> Sub_Client</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@theme äººè„¸æ£€æµ‹</span></span><br><span class="line"><span class="string">@author czq</span></span><br><span class="line"><span class="string">@date 2021 01 05</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># åˆ›å»º cv2 æ‘„åƒå¤´å¯¹è±¡</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿å­˜</span></span><br><span class="line">path_make_dir = <span class="string">&quot;data/face_img_database/&quot;</span></span><br><span class="line"></span><br><span class="line">path_feature_all = <span class="string">&quot;data/feature_all.csv&quot;</span></span><br><span class="line"></span><br><span class="line">info = <span class="string">&#x27;icon/info.png&#x27;</span></span><br><span class="line">name = [<span class="number">10</span>]</span><br><span class="line">imgSrc = [<span class="number">10</span>]</span><br><span class="line">sex = [<span class="number">10</span>]</span><br><span class="line">user_id = [<span class="number">10</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># register ui</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    @:param self</span></span><br><span class="line"><span class="string">    @:param event </span></span><br><span class="line"><span class="string">    æŒ‰é’®å•å‡»äº‹ä»¶</span></span><br><span class="line"><span class="string">    åˆ›å»ºæ–‡ä»¶å¤¹æŒ‰é’®äº‹ä»¶</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">OnNewButtonClicked</span>(<span class="params">self, event</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        æŒ‰é’®å•å‡»äº‹ä»¶</span></span><br><span class="line"><span class="string">        :param event:  å½•å…¥äººè„¸äº‹ä»¶</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> <span class="variable language_">self</span>.name == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">            <span class="variable language_">self</span>.name = wx.GetTextFromUser(message=<span class="string">&quot;è¯·å…ˆè¾“å…¥å½•å…¥è€…çš„å§“å,ç”¨äºåˆ›å»ºå§“åæ–‡ä»¶å¤¹&quot;</span>, caption=<span class="string">&quot;æ¸©é¦¨æç¤º&quot;</span>,</span><br><span class="line">                                           default_value=<span class="string">&quot;&quot;</span>, parent=<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># ç›‘æµ‹æ˜¯å¦é‡å</span></span><br><span class="line">            <span class="keyword">for</span> exsit_name <span class="keyword">in</span> (os.listdir(path_make_dir)):</span><br><span class="line">                <span class="keyword">if</span> <span class="variable language_">self</span>.name == exsit_name:</span><br><span class="line">                    wx.MessageBox(message=<span class="string">&quot;å§“åå·²å­˜åœ¨ï¼Œè¯·é‡æ–°è¾“å…¥&quot;</span>, caption=<span class="string">&quot;è­¦å‘Š&quot;</span>)</span><br><span class="line">                    <span class="variable language_">self</span>.name = <span class="string">&#x27;&#x27;</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        os.makedirs(path_make_dir + <span class="variable language_">self</span>.name)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;æ–°å»ºçš„äººè„¸æ–‡ä»¶å¤¹: &quot;</span>, path_make_dir + <span class="variable language_">self</span>.name)</span><br><span class="line">        name[<span class="number">0</span>] = <span class="variable language_">self</span>.name</span><br><span class="line">        user_id[<span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">        <span class="variable language_">self</span>.NewButton.Enable(enable=<span class="literal">False</span>)</span><br><span class="line">        <span class="variable language_">self</span>.ShortCutButton.Enable(enable=<span class="literal">True</span>)  <span class="comment"># å¯ç”¨æˆªå›¾æŒ‰é’®</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;ä½¿ç”¨å¤šçº¿ç¨‹ï¼Œå­çº¿ç¨‹è¿è¡Œåå°çš„ç¨‹åºï¼Œä¸»çº¿ç¨‹æ›´æ–°å‰å°çš„UIï¼Œè¿™æ ·ä¸ä¼šäº’ç›¸å½±å“&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># åˆ›å»ºå­çº¿ç¨‹ï¼ŒæŒ‰é’®è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œ</span></span><br><span class="line">        _thread.start_new_thread(<span class="variable language_">self</span>._open_cap, (event,))</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    æˆªå›¾æŒ‰é’®äº‹ä»¶</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">OnShortCutButtonClicked</span>(<span class="params">self, event</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param event: æˆªå›¾äº‹ä»¶</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.SaveButton.Enable(<span class="literal">True</span>)  <span class="comment"># å¯ç”¨ä¿å­˜æŒ‰é’®</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.rects) != <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># è®¡ç®—çŸ©å½¢æ¡†å¤§å°,ä¿è¯åŒæ­¥</span></span><br><span class="line">            height = <span class="variable language_">self</span>.rects[<span class="number">0</span>].bottom() - <span class="variable language_">self</span>.rects[<span class="number">0</span>].top()</span><br><span class="line">            width = <span class="variable language_">self</span>.rects[<span class="number">0</span>].right() - <span class="variable language_">self</span>.rects[<span class="number">0</span>].left()</span><br><span class="line">            <span class="variable language_">self</span>.sc_number += <span class="number">1</span></span><br><span class="line">            im_blank = np.zeros((height, width, <span class="number">3</span>), np.uint8)</span><br><span class="line">            <span class="keyword">for</span> ii <span class="keyword">in</span> <span class="built_in">range</span>(height):</span><br><span class="line">                <span class="keyword">for</span> jj <span class="keyword">in</span> <span class="built_in">range</span>(width):</span><br><span class="line">                    im_blank[ii][jj] = <span class="variable language_">self</span>.im_rd[<span class="variable language_">self</span>.rects[<span class="number">0</span>].top() + ii][<span class="variable language_">self</span>.rects[<span class="number">0</span>].left() + jj]</span><br><span class="line"></span><br><span class="line">            cv2.imencode(<span class="string">&#x27;.jpg&#x27;</span>, im_blank)[<span class="number">1</span>].tofile(</span><br><span class="line">                path_make_dir + <span class="variable language_">self</span>.name + <span class="string">&quot;/img_face_&quot;</span> + <span class="built_in">str</span>(<span class="variable language_">self</span>.sc_number) + <span class="string">&quot;.jpg&quot;</span>)  <span class="comment"># æ­£ç¡®æ–¹æ³•</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;å†™å…¥æœ¬åœ°ï¼š&quot;</span>, <span class="built_in">str</span>(path_make_dir + <span class="variable language_">self</span>.name) + <span class="string">&quot;/img_face_&quot;</span> + <span class="built_in">str</span>(<span class="variable language_">self</span>.sc_number) + <span class="string">&quot;.jpg&quot;</span>)</span><br><span class="line">            imgSrc[<span class="number">0</span>] = <span class="built_in">str</span>(path_make_dir + <span class="variable language_">self</span>.name) + <span class="string">&quot;/img_face_&quot;</span> + <span class="built_in">str</span>(<span class="variable language_">self</span>.sc_number) + <span class="string">&quot;.jpg&quot;</span></span><br><span class="line">            <span class="comment"># readSql.saveData(name, imgSrc, user_id, sex)</span></span><br><span class="line">            Sub_Client.upload_image(imgSrc[<span class="number">0</span>], <span class="string">&#x27;faceImgRegister&#x27;</span>, <span class="string">&#x27;face image register successful&#x27;</span>)</span><br><span class="line">            readSql.saveUserData(name, sex)</span><br><span class="line">            readSql.save_face_table(name, imgSrc[<span class="number">0</span>])</span><br><span class="line">            readSql.save_img_data(name, imgSrc[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;æœªæ£€æµ‹åˆ°äººè„¸ï¼Œè¯†åˆ«æ— æ•ˆï¼Œæœªå†™å…¥æœ¬åœ°&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    ä¿å­˜å›¾ç‰‡æŒ‰é’®äº‹ä»¶</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">OnSaveButtonClicked</span>(<span class="params">self, event</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param event: ä¿å­˜æŒ‰é’®äº‹ä»¶</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.bmp.SetBitmap(wx.Bitmap(<span class="variable language_">self</span>.image_info))</span><br><span class="line">        <span class="variable language_">self</span>.NewButton.Enable(<span class="literal">True</span>)  <span class="comment"># å¯ç”¨æ–°å»ºäººè„¸äº‹ä»¶</span></span><br><span class="line">        <span class="variable language_">self</span>.SaveButton.Enable(<span class="literal">False</span>)</span><br><span class="line">        <span class="variable language_">self</span>.ShortCutButton.Enable(<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># é‡Šæ”¾æ‘„åƒå¤´</span></span><br><span class="line">        <span class="variable language_">self</span>.cap.release()</span><br><span class="line">        <span class="comment"># åˆ é™¤å»ºç«‹çš„çª—å£</span></span><br><span class="line">        <span class="comment"># cv2.destroyAllWindows()</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.register_flag == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">if</span> os.path.exists(path_make_dir + <span class="variable language_">self</span>.name):</span><br><span class="line">                shutil.rmtree(path_make_dir + <span class="variable language_">self</span>.name)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;é‡å¤å½•å…¥ï¼Œå·²åˆ é™¤å§“åæ–‡ä»¶å¤¹&quot;</span>, path_make_dir + <span class="variable language_">self</span>.name)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.sc_number == <span class="number">0</span> <span class="keyword">and</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.name) &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> os.path.exists(path_make_dir + <span class="variable language_">self</span>.name):</span><br><span class="line">                shutil.rmtree(path_make_dir + <span class="variable language_">self</span>.name)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;æ‚¨æœªä¿å­˜æˆªå›¾ï¼Œå·²åˆ é™¤å§“åæ–‡ä»¶å¤¹&quot;</span>, path_make_dir + <span class="variable language_">self</span>.name)</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.register_flag == <span class="number">0</span> <span class="keyword">and</span> <span class="variable language_">self</span>.sc_number != <span class="number">0</span>:</span><br><span class="line">            pics = os.listdir(path_make_dir + <span class="variable language_">self</span>.name)</span><br><span class="line">            feature_list = []</span><br><span class="line">            feature_average = []</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(pics)):</span><br><span class="line">                pic_path = path_make_dir + <span class="variable language_">self</span>.name + <span class="string">&quot;/&quot;</span> + pics[i]</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;æ­£åœ¨è¯»çš„äººè„¸å›¾åƒï¼š&quot;</span>, pic_path)</span><br><span class="line">                img = iio.imread(pic_path)</span><br><span class="line">                img_gray = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)</span><br><span class="line">                dets = face_recognize_punchcard.detector(img_gray, <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(dets) != <span class="number">0</span>:</span><br><span class="line">                    shape = face_recognize_punchcard.predictor(img_gray, dets[<span class="number">0</span>])</span><br><span class="line">                    face_descriptor = face_recognize_punchcard.facerec.compute_face_descriptor(img_gray, shape)</span><br><span class="line">                    feature_list.append(face_descriptor)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    face_descriptor = <span class="number">0</span></span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;æœªåœ¨ç…§ç‰‡ä¸­è¯†åˆ«åˆ°äººè„¸&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(feature_list) &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>):</span><br><span class="line">                    feature_average.append(<span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(feature_list)):</span><br><span class="line">                        feature_average[j] += feature_list[i][j]</span><br><span class="line">                    feature_average[j] = (feature_average[j]) / <span class="built_in">len</span>(feature_list)</span><br><span class="line">                feature_average.append(<span class="variable language_">self</span>.name)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(path_feature_all, <span class="string">&quot;a+&quot;</span>, newline=<span class="string">&quot;&quot;</span>) <span class="keyword">as</span> csvfile:</span><br><span class="line">                    writer = csv.writer(csvfile)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;å†™å…¥ä¸€æ¡ç‰¹å¾äººè„¸å…¥åº“&#x27;</span>, feature_average)</span><br><span class="line">                    writer.writerow(feature_average)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.name = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.register_flag = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.sc_number = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    æ‰“å¼€æ‘„åƒå¤´</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_open_cap</span>(<span class="params">self, event</span>):</span><br><span class="line">        <span class="comment"># reload(facerec)</span></span><br><span class="line">        reload(face_recognize_punchcard)</span><br><span class="line">        <span class="comment"># reload(predictor)</span></span><br><span class="line">        <span class="comment"># reload(detector)</span></span><br><span class="line">        <span class="comment"># reload(return_euclidean_distance())</span></span><br><span class="line"></span><br><span class="line">        urlc = <span class="string">&#x27;http://192.168.1.104:81/stream&#x27;</span></span><br><span class="line">        a = <span class="number">0</span></span><br><span class="line">        localtime = datetime.datetime.now()</span><br><span class="line">        date = <span class="built_in">str</span>(localtime.year) + <span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(localtime.month) + <span class="string">&quot; &quot;</span> + <span class="built_in">str</span>(localtime.day)</span><br><span class="line">        video_src = <span class="string">&#x27;E:/czq/personFile/catCamera/src/server/data/video/catEye&#x27;</span> + date + <span class="string">&#x27;.avi&#x27;</span></span><br><span class="line">        <span class="variable language_">self</span>.cap = cv2.VideoCapture(video_src)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># cap.set(propId, value)</span></span><br><span class="line">        <span class="comment"># è®¾ç½®è§†é¢‘å‚æ•°ï¼ŒpropId è®¾ç½®çš„è§†é¢‘å‚æ•°ï¼Œvalue è®¾ç½®çš„å‚æ•°å€¼</span></span><br><span class="line">        <span class="variable language_">self</span>.cap.<span class="built_in">set</span>(<span class="number">3</span>, <span class="number">480</span>)</span><br><span class="line">        <span class="comment"># self.cap.set(cv2.CAP_PROP_FPS,5)</span></span><br><span class="line">        <span class="keyword">while</span> <span class="variable language_">self</span>.cap.isOpened():</span><br><span class="line">            <span class="comment"># cap.read()</span></span><br><span class="line">            <span class="comment"># è¿”å›ä¸¤ä¸ªå€¼ï¼š</span></span><br><span class="line">            <span class="comment">#    ä¸€ä¸ªå¸ƒå°”å€¼ true/falseï¼Œç”¨æ¥åˆ¤æ–­è¯»å–è§†é¢‘æ˜¯å¦æˆåŠŸ/æ˜¯å¦åˆ°è§†é¢‘æœ«å°¾</span></span><br><span class="line">            <span class="comment">#    å›¾åƒå¯¹è±¡ï¼Œå›¾åƒçš„ä¸‰ç»´çŸ©é˜µq</span></span><br><span class="line">            flag, <span class="variable language_">self</span>.im_rd = <span class="variable language_">self</span>.cap.read()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># äººè„¸æ•° rects</span></span><br><span class="line">                <span class="variable language_">self</span>.rects = face_recognize_punchcard.detector(<span class="variable language_">self</span>.im_rd, <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">except</span> TypeError <span class="keyword">as</span> te:</span><br><span class="line">                <span class="built_in">print</span>(te)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;äººè„¸æœªè¯†åˆ«åˆ° äººè„¸è¯†åˆ«å¤±è´¥ï¼&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            cv2.waitKey(<span class="number">1</span>)  <span class="comment"># å¿…ä¸å¯å°‘</span></span><br><span class="line">            <span class="comment"># å¾…ä¼šè¦å†™çš„å­—ä½“</span></span><br><span class="line">            font = cv2.FONT_HERSHEY_SIMPLEX</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.rects) != <span class="number">0</span>:</span><br><span class="line">                <span class="comment"># æ£€æµ‹åˆ°äººè„¸</span></span><br><span class="line">                <span class="comment"># çŸ©å½¢æ¡†#dæ˜¯äººè„¸</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># æŸ¥é‡</span></span><br><span class="line">                features_cap = face_recognize_punchcard.facerec.compute_face_descriptor(<span class="variable language_">self</span>.im_rd,</span><br><span class="line">                                                                                        face_recognize_punchcard.predictor(</span><br><span class="line">                                                                                            <span class="variable language_">self</span>.im_rd, <span class="variable language_">self</span>.rects[<span class="number">0</span>]))</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(face_recognize_punchcard.features_known_arr)):</span><br><span class="line">                    <span class="comment"># å°†æŸå¼ äººè„¸ä¸å­˜å‚¨çš„æ‰€æœ‰äººè„¸æ•°æ®è¿›è¡Œæ¯”å¯¹</span></span><br><span class="line">                    compare = face_recognize_punchcard.return_euclidean_distance(features_cap,</span><br><span class="line">                                                                                 face_recognize_punchcard.features_known_arr[</span><br><span class="line">                                                                                     i][<span class="number">0</span>:-<span class="number">1</span>])</span><br><span class="line">                    <span class="keyword">if</span> compare == <span class="string">&quot;same&quot;</span>:  <span class="comment"># æ‰¾åˆ°äº†ç›¸ä¼¼è„¸</span></span><br><span class="line">                        face_name = face_recognize_punchcard.features_known_arr[i][-<span class="number">1</span>]</span><br><span class="line">                        <span class="built_in">print</span>(face_name)</span><br><span class="line">                        wx.MessageBox(message=face_name + <span class="string">&quot;ï¼Œæ‚¨å·²å½•è¿‡äººè„¸ï¼Œæ¸…æˆªå›¾ä¿å­˜ä¸‹ä¸€ä¸ªäººç‰©&quot;</span>, caption=<span class="string">&quot;è­¦å‘Š&quot;</span>)</span><br><span class="line">                        <span class="variable language_">self</span>.NewButton.Enable(<span class="literal">False</span>)</span><br><span class="line">                        <span class="variable language_">self</span>.ShortCutButton.Enable(<span class="literal">False</span>)</span><br><span class="line">                        <span class="variable language_">self</span>.SaveButton.Enable(<span class="literal">True</span>)</span><br><span class="line">                        <span class="variable language_">self</span>.register_flag = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> k, d <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="variable language_">self</span>.rects):</span><br><span class="line">                    <span class="comment"># æ ¹æ®äººè„¸å¤§å°ç”Ÿæˆç©ºçš„å›¾åƒ</span></span><br><span class="line">                    <span class="comment"># æœ€åä¸€ä¸ªå‚æ•°æ˜¯çº¿å®½</span></span><br><span class="line">                    cv2.rectangle(<span class="variable language_">self</span>.im_rd, <span class="built_in">tuple</span>([d.left(), d.top()]), <span class="built_in">tuple</span>([d.right(), d.bottom()]), (<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>),</span><br><span class="line">                                  <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># æ˜¾ç¤ºäººè„¸æ•°</span></span><br><span class="line">            cv2.putText(<span class="variable language_">self</span>.im_rd, <span class="string">&quot;Faces: &quot;</span> + <span class="built_in">str</span>(<span class="built_in">len</span>(<span class="variable language_">self</span>.rects)), (<span class="number">50</span>, <span class="number">80</span>), font, <span class="number">0.8</span>, (<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="number">1</span>, cv2.LINE_AA)</span><br><span class="line">            cv2.putText(<span class="variable language_">self</span>.im_rd, <span class="string">&quot;Warning: please shortcut having rectangle&quot;</span>, (<span class="number">50</span>, <span class="number">140</span>), font, <span class="number">0.8</span>, (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), <span class="number">1</span>,</span><br><span class="line">                        cv2.LINE_AA)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># print(im_rd.shape)</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                height, width = <span class="variable language_">self</span>.im_rd.shape[:<span class="number">2</span>]</span><br><span class="line">            <span class="keyword">except</span> AttributeError <span class="keyword">as</span> ae:</span><br><span class="line">                <span class="built_in">print</span>(ae)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;äººè„¸ç…§ç‰‡åˆ‡å‰²é”™è¯¯ï¼&#x27;</span>)</span><br><span class="line">            image1 = cv2.cvtColor(<span class="variable language_">self</span>.im_rd, cv2.COLOR_BGR2RGB)</span><br><span class="line">            pic = wx.Bitmap.FromBuffer(width, height, image1)</span><br><span class="line">            <span class="comment"># æ˜¾ç¤ºå›¾ç‰‡åœ¨panelä¸Š</span></span><br><span class="line">            <span class="variable language_">self</span>.bmp.SetBitmap(pic)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># ç›´æ¥åœ¨sbclickedé‡Œè®¾ç½®self.bmp.SetBitmap(wx.Bitmap(self.image_cover))ï¼Œå­çº¿ç¨‹è¿˜åœ¨è¿è¡Œ</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.NewButton.IsEnabled() == <span class="literal">True</span> <span class="keyword">and</span> <span class="variable language_">self</span>.ShortCutButton.IsEnabled() == <span class="literal">False</span> <span class="keyword">and</span> <span class="variable language_">self</span>.SaveButton.IsEnabled() == <span class="literal">False</span>:</span><br><span class="line">                <span class="variable language_">self</span>.bmp.SetBitmap(wx.Bitmap(<span class="variable language_">self</span>.image_info))</span><br><span class="line">                _thread.exit()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="ç›¸æœºæˆªå›¾">ç›¸æœºæˆªå›¾</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getTrainingData</span>(<span class="params">window_name, camera_id, path_name, max_num</span>): <span class="comment"># path_nameæ˜¯å›¾ç‰‡å­˜å‚¨ç›®å½•ï¼Œmax_numæ˜¯éœ€è¦æ•æ‰çš„å›¾ç‰‡æ•°é‡</span></span><br><span class="line">    cv2.namedWindow(window_name) <span class="comment"># åˆ›å»ºçª—å£</span></span><br><span class="line">    cap = cv2.VideoCapture(camera_id) <span class="comment"># æ‰“å¼€æ‘„åƒå¤´</span></span><br><span class="line">    classifier = cv2.CascadeClassifier(<span class="string">&#x27;haarcascade_frontalface_alt2.xml&#x27;</span>) <span class="comment"># åŠ è½½åˆ†ç±»å™¨</span></span><br><span class="line">    color = (<span class="number">0</span>,<span class="number">255</span>,<span class="number">0</span>) <span class="comment"># äººè„¸çŸ©å½¢æ¡†çš„é¢œè‰²</span></span><br><span class="line">    num = <span class="number">0</span> <span class="comment"># è®°å½•å­˜å‚¨çš„å›¾ç‰‡æ•°é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> cap.isOpened():</span><br><span class="line">        ok, frame = cap.read()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ok:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY) <span class="comment"># ç°åº¦åŒ–</span></span><br><span class="line">        faceRects=classifier.detectMultiScale(gray,scaleFactor=<span class="number">1.2</span>,minNeighbors=<span class="number">3</span>,minSize=(<span class="number">32</span>,<span class="number">32</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(faceRects) &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">for</span> faceRect <span class="keyword">in</span> faceRects:</span><br><span class="line">                x,y,w,h = faceRect</span><br><span class="line">                <span class="comment"># æ•æ‰åˆ°çš„å›¾ç‰‡çš„åå­—ï¼Œè¿™é‡Œç”¨åˆ°äº†æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„è¾“å‡º</span></span><br><span class="line">                image_name = <span class="string">&#x27;%s%d.jpg&#x27;</span> % (path_name, num) <span class="comment"># æ³¨æ„è¿™é‡Œå›¾ç‰‡åä¸€å®šè¦åŠ ä¸Šæ‰©å±•åï¼Œå¦åˆ™åé¢imwriteçš„æ—¶å€™ä¼šæŠ¥é”™ï¼šcould not find a writer for the specified extension in function cv::imwrite_ å‚è€ƒï¼šhttps://stackoverflow.com/questions/9868963/cvimwrite-could-not-find-a-writer-for-the-specified-extension</span></span><br><span class="line">                image = frame[y:y+h, x:x+w] <span class="comment"># å°†å½“å‰å¸§å«äººè„¸éƒ¨åˆ†ä¿å­˜ä¸ºå›¾ç‰‡ï¼Œæ³¨æ„è¿™é‡Œå­˜çš„è¿˜æ˜¯å½©è‰²å›¾ç‰‡ï¼Œå‰é¢æ£€æµ‹æ—¶ç°åº¦åŒ–æ˜¯ä¸ºäº†é™ä½è®¡ç®—é‡ï¼›è¿™é‡Œè®¿é—®çš„æ˜¯ä»yä½å¼€å§‹åˆ°y+h-1ä½</span></span><br><span class="line">                cv2.imwrite(image_name, image)</span><br><span class="line"></span><br><span class="line">                num += <span class="number">1</span></span><br><span class="line">                <span class="comment"># è¶…è¿‡æŒ‡å®šæœ€å¤§ä¿å­˜æ•°é‡åˆ™é€€å‡ºå¾ªç¯</span></span><br><span class="line">                <span class="keyword">if</span> num &gt; max_num:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                cv2.rectangle(frame, (x,y), (x+w,y+h), color, <span class="number">2</span>) <span class="comment"># ç”»å‡ºçŸ©å½¢æ¡†</span></span><br><span class="line">                font = cv2.FONT_HERSHEY_SIMPLEX <span class="comment"># è·å–å†…ç½®å­—ä½“</span></span><br><span class="line">                cv2.putText(frame, (<span class="string">&#x27;%d&#x27;</span>%num), (x+<span class="number">30</span>, y+<span class="number">30</span>), font, <span class="number">1</span>, (<span class="number">255</span>,<span class="number">0</span>,<span class="number">255</span>), <span class="number">4</span>) <span class="comment"># è°ƒç”¨å‡½æ•°ï¼Œå¯¹äººè„¸åæ ‡ä½ç½®ï¼Œæ·»åŠ ä¸€ä¸ª(x+30,y+30ï¼‰çš„çŸ©å½¢æ¡†ç”¨äºæ˜¾ç¤ºå½“å‰æ•æ‰åˆ°äº†å¤šå°‘äººè„¸å›¾ç‰‡</span></span><br><span class="line">        <span class="keyword">if</span> num &gt; max_num:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        cv2.imshow(window_name, frame)</span><br><span class="line">        c = cv2.waitKey(<span class="number">10</span>)</span><br><span class="line">        <span class="keyword">if</span> c &amp; <span class="number">0xFF</span> == <span class="built_in">ord</span>(<span class="string">&#x27;q&#x27;</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    cap.release()<span class="comment">#é‡Šæ”¾æ‘„åƒå¤´å¹¶é”€æ¯æ‰€æœ‰çª—å£</span></span><br><span class="line">    cv2.destroyAllWindows()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Finished.&#x27;</span>)</span><br><span class="line"><span class="comment">#ä¸»å‡½æ•°</span></span><br><span class="line"><span class="keyword">if</span> __name__ ==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span> (<span class="string">&#x27;catching your face and writting into disk...&#x27;</span>)</span><br><span class="line">    getTrainingData(<span class="string">&#x27;getTrainData&#x27;</span>,<span class="number">0</span>,<span class="string">&#x27;training_data_me/&#x27;</span>,<span class="number">100</span>) <span class="comment"># æ³¨æ„è¿™é‡Œçš„training_data_xx æ–‡ä»¶å¤¹å°±åœ¨ç¨‹åºå·¥ä½œç›®å½•ä¸‹</span></span><br></pre></td></tr></table></figure><h3 id="è§†é¢‘æ•°æ®æ¥å—-socket-client">è§†é¢‘æ•°æ®æ¥å—(socket client)</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">usoc = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)  <span class="comment"># å»ºä¸€ä¸ªUDP socket</span></span><br><span class="line">usoc.bind((<span class="string">&#x27;&#x27;</span>, <span class="number">10000</span>))  <span class="comment"># ç›‘å¬ç«¯å£å·</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Start!&quot;</span>)</span><br><span class="line">frameIdNow = <span class="number">0</span>  <span class="comment"># å½“å‰å¸§å¸§å·</span></span><br><span class="line">frameSizeNow = <span class="number">0</span>  <span class="comment"># å½“å‰æ¥æ”¶åˆ°çš„å¸§ä½“ç§¯</span></span><br><span class="line">packetIdNow = <span class="number">0</span>  <span class="comment"># æœ€æ–°å·²æ¥æ”¶çš„æ•°æ®åŒ…å·</span></span><br><span class="line">packetCount = <span class="number">0</span>  <span class="comment"># å½“å‰å¸§åŒ…çš„æ•°é‡</span></span><br><span class="line">packetLen = <span class="number">0</span>  <span class="comment"># æ ‡å‡†æ•°æ®åŒ…å¤§å°</span></span><br><span class="line">frameSizeOk = <span class="number">0</span>  <span class="comment"># å½“å‰å¸§å·²æ¥æ”¶æ•°æ®é‡</span></span><br><span class="line">jpgBuff = <span class="built_in">bytes</span>(<span class="string">&#x27;ix&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>)  <span class="comment"># å›¾ç‰‡æ•°æ®ç¼“å­˜</span></span><br><span class="line"><span class="built_in">print</span>(usoc)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    udpbuff, address = usoc.recvfrom(<span class="number">10240</span>)  <span class="comment"># é˜»å¡æ¥æ”¶æ•°æ®ï¼Œæœ€å¤šä¸€æ¬¡æ¥æ”¶10240å­—èŠ‚</span></span><br><span class="line">    <span class="built_in">print</span>(address)</span><br><span class="line">    <span class="built_in">print</span>(udpbuff)</span><br><span class="line">    <span class="comment"># è§£ææ•°æ®</span></span><br><span class="line">    frameId = (udpbuff[<span class="number">1</span>] &lt;&lt; <span class="number">24</span>) + (udpbuff[<span class="number">2</span>] &lt;&lt; <span class="number">16</span>) + (udpbuff[<span class="number">3</span>] &lt;&lt; <span class="number">8</span>) + udpbuff[<span class="number">4</span>]  <span class="comment"># è·å–å¸§å·</span></span><br><span class="line">    frameSize = (udpbuff[<span class="number">5</span>] &lt;&lt; <span class="number">24</span>) + (udpbuff[<span class="number">6</span>] &lt;&lt; <span class="number">16</span>) + (udpbuff[<span class="number">7</span>] &lt;&lt; <span class="number">8</span>) + udpbuff[<span class="number">8</span>]  <span class="comment"># è·å–å¸§ä½“ç§¯</span></span><br><span class="line">    packetId = udpbuff[<span class="number">10</span>]  <span class="comment"># è·å–åŒ…å·</span></span><br><span class="line">    packetSize = (udpbuff[<span class="number">13</span>] &lt;&lt; <span class="number">8</span>) + udpbuff[<span class="number">14</span>]  <span class="comment"># è·å–åŒ…ä½“ç§¯</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> frameIdNow != frameId:  <span class="comment"># æ¢å¸§ï¼Œè®°å½•æ–°ä¸€å¸§çš„æ•°æ®ä¿¡æ¯</span></span><br><span class="line">        frameIdNow = frameId  <span class="comment"># æ›´æ–°å¸§å·</span></span><br><span class="line">        frameSizeNow = frameSize  <span class="comment"># æ›´æ–°å¸§ä½“ç§¯</span></span><br><span class="line">        packetCount = udpbuff[<span class="number">9</span>]  <span class="comment"># æ›´æ–°æ•°æ®åŒ…æ•°é‡</span></span><br><span class="line">        packetLen = (udpbuff[<span class="number">11</span>] &lt;&lt; <span class="number">8</span>) + udpbuff[<span class="number">12</span>]  <span class="comment"># æ›´æ–°æ•°æ®åŒ…é•¿åº¦</span></span><br><span class="line">        frameSizeOk = <span class="number">0</span>  <span class="comment"># æ¸…é™¤å½“å‰å¸§å·²æ¥æ”¶æ•°æ®é‡</span></span><br><span class="line">        packetIdNow = <span class="number">0</span>  <span class="comment"># æœ€æ–°å·²æ¥æ”¶æ•°æ®åŒ…å·æ¸…é›¶</span></span><br><span class="line">        jpgBuff = <span class="built_in">bytes</span>(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>)  <span class="comment"># æ¸…ç©ºå›¾ç‰‡æ•°æ®ç¼“å­˜</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¤åˆ¶è‡³ç¼“å†²åŒºï¼Œå¹¶åªæ¥æ”¶å®‰å…¨èŒƒå›´å†…çš„æ•°æ®åŒ…</span></span><br><span class="line">    <span class="keyword">if</span> (packetId &lt;= packetCount) <span class="keyword">and</span> (packetId &gt; packetIdNow):  <span class="comment"># æ–°æ•°æ®åŒ…åŒ…å·ä¸è¶…è¿‡æ€»æ•°æ®åŒ…æ•°é‡ï¼Œä¸”åŒ…å·åˆšå¥½æ¯”å‰ä¸€åŒ…å¤š1</span></span><br><span class="line">        <span class="keyword">if</span> packetSize == (<span class="built_in">len</span>(udpbuff) - <span class="number">15</span>):  <span class="comment"># æ•°æ®åŒ…å‡å»åŒ…å¤´ç­‰äºåŒ…ä½“ç§¯</span></span><br><span class="line">            <span class="keyword">if</span> (packetSize == packetLen) <span class="keyword">or</span> (packetId == packetCount):  <span class="comment"># æ ‡å‡†åŒ…æˆ–æœ€åä¸€åŒ…</span></span><br><span class="line">                jpgBuff = jpgBuff + udpbuff[<span class="number">15</span>:]  <span class="comment"># æ‹¼æ¥æ•°æ®åŒ…</span></span><br><span class="line">                frameSizeOk = frameSizeOk + <span class="built_in">len</span>(udpbuff) - <span class="number">15</span>  <span class="comment"># å¸§æ•°æ®æ€»é‡ç´¯åŠ </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> frameSizeNow == frameSizeOk:  <span class="comment"># å½“å‰å¸§æ¥æ”¶å®Œæˆ</span></span><br><span class="line">        nparr = np.frombuffer(jpgBuff, dtype=np.uint8)  <span class="comment"># å°†å›¾ç‰‡æ•°ç»„è½¬ä¸ºnumpyæ•°ç»„</span></span><br><span class="line">        image = cv2.imdecode(nparr, cv2.IMREAD_COLOR)  <span class="comment"># è§£ç å›¾ç‰‡</span></span><br><span class="line">        cv2.imshow(<span class="string">&#x27;ESP&#x27;</span>, image)  <span class="comment"># å°†å›¾ç‰‡æ˜¾ç¤ºå‡ºæ¥</span></span><br><span class="line">        <span class="keyword">if</span> cv2.waitKey(<span class="number">1</span>) == <span class="number">27</span>:  <span class="comment"># æŒ‰ä¸‹ESCé”®é€€å‡º</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">usoc.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="å…¶ä»–APIè°ƒç”¨">å…¶ä»–APIè°ƒç”¨</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">@author czq</span></span><br><span class="line"><span class="string">@date 2020 12 23</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># encoding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> cv2 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> cv2 <span class="keyword">as</span> cv</span><br><span class="line"><span class="keyword">import</span> dlib  <span class="comment"># äººè„¸è¯†åˆ«çš„åº“dlib</span></span><br><span class="line"><span class="keyword">import</span> requests <span class="keyword">as</span> re</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">img_src = <span class="string">&#x27;http://192.168.2.151/capture&#x27;</span></span><br><span class="line">video_src = <span class="string">&#x27;http://192.168.2.151:81/stream&#x27;</span></span><br><span class="line">CAM_SRC = <span class="string">&#x27;http://192.168.2.151&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############</span></span><br><span class="line"><span class="comment">#   opencv   #</span></span><br><span class="line"><span class="comment">#   loadimg  #</span></span><br><span class="line"><span class="comment">##############</span></span><br><span class="line"><span class="comment"># opencvä¸èƒ½ç›´æ¥ä»ç½‘ç»œè·å–å›¾ç‰‡ï¼Œä½†æ˜¯opencvçš„VideoCaptureç±»å¯ä»¥ä»urlåŠ è½½è§†é¢‘</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">loadImg</span>():</span><br><span class="line">    cap = VideoCapture(img_src)</span><br><span class="line">    <span class="keyword">if</span> (cap.isOpened()):</span><br><span class="line">        ret, img = cap.read()</span><br><span class="line">    img = resize(img, (<span class="number">800</span>, <span class="number">600</span>))</span><br><span class="line">    imshow(<span class="string">&quot;image&quot;</span>, img)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;load image successful&#x27;</span>, img)</span><br><span class="line">    waitKey(<span class="number">10</span>)</span><br><span class="line">    cv.destroyAllWindows()</span><br><span class="line">    <span class="comment"># img = cv.imread(img_src,cv.IMREAD_COLOR )</span></span><br><span class="line">    <span class="built_in">print</span>(img)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">        cv.imwrite(<span class="string">&#x27;./images/face_img/face&#x27;</span> + <span class="built_in">str</span>(i) + <span class="string">&#x27;.png&#x27;</span>, img)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############</span></span><br><span class="line"><span class="comment">#   opencv   #</span></span><br><span class="line"><span class="comment">#   saveimg  #</span></span><br><span class="line"><span class="comment">##############</span></span><br><span class="line"><span class="comment"># ä¿å­˜æ‰€è·å–çš„å›¾ç‰‡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">saveImg</span>():</span><br><span class="line">    cap = VideoCapture(img_src)</span><br><span class="line">    <span class="keyword">if</span> cap.isOpened():</span><br><span class="line">        ret, img = cap.read()</span><br><span class="line">    sav_img = resize(img, (<span class="number">800</span>, <span class="number">600</span>))</span><br><span class="line">    height = <span class="number">800</span></span><br><span class="line">    width = <span class="number">600</span></span><br><span class="line">    top = <span class="number">10</span></span><br><span class="line">    left = <span class="number">10</span></span><br><span class="line">    cv.destroyAllWindows()</span><br><span class="line">    <span class="comment"># img = cv.imread(img_src,cv.IMREAD_COLOR )</span></span><br><span class="line">    <span class="built_in">print</span>(sav_img)</span><br><span class="line">    cv.imwrite(<span class="string">&#x27;./images/face_img/face.png&#x27;</span>, sav_img)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">loadVideo</span>():</span><br><span class="line">    cap = VideoCapture(video_src)</span><br><span class="line">    <span class="keyword">if</span> cap.isOpened():</span><br><span class="line">        ret, img = cap.read()</span><br><span class="line">        img = resize(img, (<span class="number">800</span>, <span class="number">600</span>))</span><br><span class="line">        imshow(<span class="string">&quot;image&quot;</span>, img)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;load image successful&#x27;</span>)</span><br><span class="line">        waitKey(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">@methods</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">call face recognized api</span></span><br><span class="line"><span class="string">@return null</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">call_face_api</span>():</span><br><span class="line">    r = re.get(<span class="string">&#x27;http://192.168.2.151/status&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(r)</span><br><span class="line">    <span class="built_in">print</span>(r.status_code)</span><br><span class="line">    <span class="built_in">print</span>(r.text)</span><br><span class="line">    user_dic = json.loads(r.text)</span><br><span class="line">    face_detect = user_dic[<span class="string">&#x27;face_detect&#x27;</span>]</span><br><span class="line">    face_enroll = user_dic[<span class="string">&#x27;face_enroll&#x27;</span>]</span><br><span class="line">    <span class="comment"># r = re.get(&#x27;http://192.168.2.151/control?var=face_detect&amp;val=1&#x27;)</span></span><br><span class="line">    <span class="keyword">if</span> face_enroll == <span class="number">1</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;äººè„¸æ³¨å†Œå¼€å§‹ï¼&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> face_detect == <span class="number">1</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;äººè„¸å·²æ³¨å†Œï¼&#x27;</span>)</span><br><span class="line">            saveImg()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;è¿˜æœªæ³¨å†Œäººè„¸ï¼&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;è¯·ç‚¹å‡» enroll å¼€å§‹äººè„¸æ³¨å†Œï¼&#x27;</span>)</span><br><span class="line">    face_recognize = user_dic[<span class="string">&#x27;face_recognize&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> face_recognize == <span class="number">1</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;äººè„¸è¯†åˆ«å¼€å§‹&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;ç‚¹å‡»face_recognizeå¼€å§‹äººè„¸è¯†åˆ«&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">CatchUsbVideo</span>(<span class="params">window_name, camera_idx</span>):</span><br><span class="line">    cv2.namedWindow(window_name)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è§†é¢‘æ¥æºï¼Œå¯ä»¥æ¥è‡ªä¸€æ®µå·²å­˜å¥½çš„è§†é¢‘ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ¥è‡ªUSBæ‘„åƒå¤´</span></span><br><span class="line">    cap = cv2.VideoCapture(camera_idx)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> cap.isOpened():</span><br><span class="line">        ok, frame = cap.read()  <span class="comment"># è¯»å–ä¸€å¸§æ•°æ®</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ok:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ˜¾ç¤ºå›¾åƒå¹¶ç­‰å¾…10æ¯«ç§’æŒ‰é”®è¾“å…¥ï¼Œè¾“å…¥â€˜qâ€™é€€å‡ºç¨‹åº</span></span><br><span class="line">        cv2.imshow(window_name, frame)</span><br><span class="line">        c = cv2.waitKey(<span class="number">100</span>)</span><br><span class="line">        <span class="keyword">if</span> c &amp; <span class="number">0xFF</span> == <span class="built_in">ord</span>(<span class="string">&#x27;q&#x27;</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># é‡Šæ”¾æ‘„åƒå¤´å¹¶é”€æ¯æ‰€æœ‰çª—å£</span></span><br><span class="line">    cap.release()</span><br><span class="line">    cv2.destroyAllWindows()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_face_remove</span>(<span class="params">cam</span>):</span><br><span class="line">    <span class="comment"># ä½¿ç”¨ç‰¹å¾æå–å™¨get_frontal_face_detector</span></span><br><span class="line">    detector = dlib.get_frontal_face_detector()</span><br><span class="line">    <span class="comment"># è¯»å…¥è§†é¢‘æ–‡ä»¶</span></span><br><span class="line">    <span class="comment"># cap = cv2.VideoCapture(&quot;row.MP4&quot;)</span></span><br><span class="line">    <span class="comment"># å»ºcv2æ‘„åƒå¤´å¯¹è±¡ï¼Œè¿™é‡Œä½¿ç”¨ç”µè„‘è‡ªå¸¦æ‘„åƒå¤´ï¼Œå¦‚æœæ¥äº†å¤–éƒ¨æ‘„åƒå¤´ï¼Œåˆ™è‡ªåŠ¨åˆ‡æ¢åˆ°å¤–éƒ¨æ‘„åƒå¤´</span></span><br><span class="line"></span><br><span class="line">    cap = cv2.VideoCapture(cam)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®è§†é¢‘å‚æ•°ï¼ŒpropIdè®¾ç½®çš„è§†é¢‘å‚æ•°ï¼Œvalueè®¾ç½®çš„å‚æ•°å€¼</span></span><br><span class="line">    cap.<span class="built_in">set</span>(<span class="number">3</span>, <span class="number">480</span>)</span><br><span class="line">    <span class="comment"># æˆªå›¾screenshootçš„è®¡æ•°å™¨</span></span><br><span class="line">    cnt = <span class="number">0</span></span><br><span class="line">    <span class="comment"># è¿”å›true/false æ£€æŸ¥åˆå§‹åŒ–æ˜¯å¦æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">True</span>):</span><br><span class="line"></span><br><span class="line">        <span class="comment"># cap.read()</span></span><br><span class="line">        <span class="comment"># è¿”å›ä¸¤ä¸ªå€¼ï¼š</span></span><br><span class="line">        <span class="comment">#  ä¸€ä¸ªå¸ƒå°”å€¼true/falseï¼Œç”¨æ¥åˆ¤æ–­è¯»å–è§†é¢‘æ˜¯å¦æˆåŠŸ/æ˜¯å¦åˆ°è§†é¢‘æœ«å°¾</span></span><br><span class="line">        <span class="comment">#  å›¾åƒå¯¹è±¡ï¼Œå›¾åƒçš„ä¸‰ç»´çŸ©é˜µ</span></span><br><span class="line">        flag, im_rd = cap.read()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ¯å¸§æ•°æ®å»¶æ—¶1msï¼Œå»¶æ—¶ä¸º0è¯»å–çš„æ˜¯é™æ€å¸§</span></span><br><span class="line">        cv2.waitKey(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å–ç°åº¦</span></span><br><span class="line">        img_gray = cv2.cvtColor(im_rd, cv2.COLOR_RGB2GRAY)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä½¿ç”¨äººè„¸æ£€æµ‹å™¨æ£€æµ‹æ¯ä¸€å¸§å›¾åƒä¸­çš„äººè„¸ã€‚å¹¶è¿”å›äººè„¸æ•°rects</span></span><br><span class="line">        faces = detector(img_gray, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å¾…ä¼šè¦æ˜¾ç¤ºåœ¨å±å¹•ä¸Šçš„å­—ä½“</span></span><br><span class="line">        font = cv2.FONT_HERSHEY_SIMPLEX</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å¦‚æœæ£€æµ‹åˆ°äººè„¸</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">len</span>(faces) != <span class="number">0</span>):</span><br><span class="line"></span><br><span class="line">            <span class="comment"># å¯¹æ¯ä¸ªäººè„¸éƒ½ç”»å‡ºæ¡†æ¡†</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(faces)):</span><br><span class="line">                <span class="comment"># enumerateæ–¹æ³•åŒæ—¶è¿”å›æ•°æ®å¯¹è±¡çš„ç´¢å¼•å’Œæ•°æ®ï¼Œkä¸ºç´¢å¼•ï¼Œdä¸ºfacesä¸­çš„å¯¹è±¡</span></span><br><span class="line">                <span class="keyword">for</span> k, d <span class="keyword">in</span> <span class="built_in">enumerate</span>(faces):</span><br><span class="line">                    <span class="comment"># ç”¨çº¢è‰²çŸ©å½¢æ¡†å‡ºäººè„¸</span></span><br><span class="line">                    cv2.rectangle(im_rd, (d.left(), d.top()), (d.right(), d.bottom()), (<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>), <span class="number">2</span>)</span><br><span class="line">                    <span class="comment"># è®¡ç®—äººè„¸çƒ­åˆ«æ¡†è¾¹é•¿</span></span><br><span class="line">                    face_width = d.right() - d.left()</span><br><span class="line">                    <span class="comment"># åœ¨ä¸Šæ–¹æ˜¾ç¤ºæ–‡å­—</span></span><br><span class="line">                    cv2.putText(im_rd, <span class="built_in">str</span>(face_width), (d.left(), d.top() - <span class="number">20</span>), font, <span class="number">0.5</span>, (<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="number">1</span>)</span><br><span class="line">            <span class="comment"># æ ‡å‡ºäººè„¸æ•°</span></span><br><span class="line">            cv2.putText(im_rd, <span class="string">&quot;Faces: &quot;</span> + <span class="built_in">str</span>(<span class="built_in">len</span>(faces)), (<span class="number">20</span>, <span class="number">50</span>), font, <span class="number">1</span>, (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), <span class="number">1</span>, cv2.LINE_AA)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># æ²¡æœ‰æ£€æµ‹åˆ°äººè„¸</span></span><br><span class="line">            cv2.putText(im_rd, <span class="string">&quot;No Face&quot;</span>, (<span class="number">20</span>, <span class="number">50</span>), font, <span class="number">1</span>, (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), <span class="number">1</span>, cv2.LINE_AA)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ·»åŠ è¯´æ˜</span></span><br><span class="line">        im_rd = cv2.putText(im_rd, <span class="string">&quot;S: screenshot&quot;</span>, (<span class="number">20</span>, <span class="number">400</span>), font, <span class="number">0.8</span>, (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), <span class="number">1</span>, cv2.LINE_AA)</span><br><span class="line">        im_rd = cv2.putText(im_rd, <span class="string">&quot;Q: quit&quot;</span>, (<span class="number">20</span>, <span class="number">450</span>), font, <span class="number">0.8</span>, (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), <span class="number">1</span>, cv2.LINE_AA)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ£€æµ‹æŒ‰é”®</span></span><br><span class="line">        k = cv2.waitKey(<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># æŒ‰ä¸‹sé”®æˆªå›¾ä¿å­˜</span></span><br><span class="line">        <span class="keyword">if</span> (k == <span class="built_in">ord</span>(<span class="string">&#x27;s&#x27;</span>)):</span><br><span class="line">            cnt += <span class="number">1</span></span><br><span class="line">            cv2.imwrite(<span class="string">&quot;screenshoot&quot;</span> + <span class="built_in">str</span>(cnt) + <span class="string">&quot;.jpg&quot;</span>, im_rd)</span><br><span class="line">        <span class="comment"># æŒ‰ä¸‹qé”®é€€å‡º</span></span><br><span class="line">        <span class="keyword">if</span> (k == <span class="built_in">ord</span>(<span class="string">&#x27;q&#x27;</span>)):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># çª—å£æ˜¾ç¤º</span></span><br><span class="line">        cv2.imshow(<span class="string">&quot;camera&quot;</span>, im_rd)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># é‡Šæ”¾æ‘„åƒå¤´</span></span><br><span class="line">    cap.release()</span><br><span class="line">    <span class="comment"># åˆ é™¤å»ºç«‹çš„çª—å£</span></span><br><span class="line">    cv2.destroyAllWindows()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># cam = urllib2.urlopenï¼ˆvideo_srcï¼‰.readï¼ˆï¼‰</span></span><br><span class="line">    load_face_remove(video_src)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="ESP-CAM-ç¨‹åºåŠŸèƒ½å®ç°">ESP-CAM ç¨‹åºåŠŸèƒ½å®ç°</h2><h3 id="ç›¸æœºæ•°æ®è½¬å‘">ç›¸æœºæ•°æ®è½¬å‘</h3><h4 id="httpæœåŠ¡å™¨æœåŠ¡ç«¯">httpæœåŠ¡å™¨æœåŠ¡ç«¯</h4><blockquote><p>webæœåŠ¡ç«¯å»ºç«‹</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  Serial.setDebugOutput(<span class="literal">true</span>);</span><br><span class="line">  Serial.println();</span><br><span class="line"></span><br><span class="line">  <span class="comment">//drop down frame size for higher initial frame rate</span></span><br><span class="line">  <span class="type">sensor_t</span> * s = esp_camera_sensor_get();</span><br><span class="line">  s-&gt;set_framesize(s, FRAMESIZE_QVGA);</span><br><span class="line"></span><br><span class="line">  WiFi.begin(ssid, password);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//ov2640.initialize();</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (WiFi.status() != WL_CONNECTED) &#123;</span><br><span class="line">    delay(<span class="number">500</span>);</span><br><span class="line">    Serial.print(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  Serial.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;WiFi connected&quot;</span>);</span><br><span class="line">  internet_connected = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  startCameraServer();</span><br><span class="line"> <span class="comment">// ov2640.startCameraServer();</span></span><br><span class="line">  Serial.print(<span class="string">&quot;Camera Ready! Use &#x27;http://&quot;</span>);</span><br><span class="line">  Serial.print(WiFi.localIP());</span><br><span class="line">  Serial.println(<span class="string">&quot;&#x27; to connect&quot;</span>);</span><br><span class="line"> <span class="comment">// server.begin();</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="å›¾ç‰‡æ•°æ®æŠ“å–">å›¾ç‰‡æ•°æ®æŠ“å–</h4><blockquote><p>å°†å›¾ç‰‡æ•°æ®æ¨é€è‡³æŒ‡å®šæœåŠ¡å™¨ï¼Œå¯æ¨é€è‡³å¾®ä¿¡å…¬ä¼—å·</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CAMERA_MODEL_AI_THINKER</span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* ssid = <span class="string">&quot;TP-LINK_3551&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* password = <span class="string">&quot;H2503...&quot;</span>;</span><br><span class="line"></span><br><span class="line"> WiFiServer <span class="title function_">server</span><span class="params">(<span class="number">81</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// // OV2640 camera</span></span><br><span class="line"><span class="comment">// Camera ov2640;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//WIFIåç§°</span></span><br><span class="line"><span class="comment">//WIFIå¯†ç </span></span><br><span class="line"><span class="type">int</span> capture_interval = <span class="number">20</span> * <span class="number">1000</span>;      <span class="comment">// é»˜è®¤20ç§’ä¸Šä¼ ä¸€æ¬¡ï¼Œå¯æ›´æ”¹ï¼ˆæœ¬é¡¹ç›®æ˜¯è‡ªåŠ¨ä¸Šä¼ ï¼Œå¦‚éœ€æ¡ä»¶è§¦å‘ä¸Šä¼ ï¼Œåœ¨éœ€è¦ä¸Šä¼ çš„æ—¶å€™ï¼Œè°ƒç”¨take_send_photo()å³å¯ï¼‰</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>*  post_url = <span class="string">&quot;http://images.bemfa.com/upload/v1/upimages.php&quot;</span>; <span class="comment">// é»˜è®¤ä¸Šä¼ åœ°å€</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>*  uid = <span class="string">&quot;dbd6e715ad7ef039488b390a898a4221&quot;</span>;    <span class="comment">//ç”¨æˆ·ç§é’¥ï¼Œå·´æ³•äº‘æ§åˆ¶å°è·å–</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>*  topic = <span class="string">&quot;mypicture&quot;</span>;     <span class="comment">//ä¸»é¢˜åå­—ï¼Œå¯åœ¨æ§åˆ¶å°æ–°å»º</span></span><br><span class="line"><span class="type">bool</span> sentWechat = <span class="literal">true</span>;               <span class="comment">//æ˜¯å¦æ¨é€åˆ°å¾®ä¿¡ï¼Œé»˜è®¤ä¸æ¨é€ï¼Œtrue ä¸ºæ¨é€ã€‚éœ€è¦åœ¨æ§åˆ¶å°å…ˆç»‘å®šå¾®ä¿¡ï¼Œä¸ç„¶æ¨é€ä¸åˆ°</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>*  wechatMsg = <span class="string">&quot;è‡ªå®šä¹‰æ¶ˆæ¯ æŸ¥çœ‹å›¾ç‰‡&quot;</span>;     <span class="comment">//æ¨é€åˆ°å¾®ä¿¡çš„æ¶ˆæ¯ï¼Œå¯éšæ„ä¿®æ”¹ï¼Œä¿®æ”¹ä¸ºè‡ªå·±éœ€è¦å‘é€çš„æ¶ˆæ¯</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/********æ¨é€å›¾ç‰‡*********/</span></span><br><span class="line"><span class="type">static</span> <span class="type">esp_err_t</span> <span class="title function_">take_send_photo</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//åˆå§‹åŒ–ç›¸æœºå¹¶æ‹ç…§</span></span><br><span class="line">  Serial.println(<span class="string">&quot;Taking picture...&quot;</span>);</span><br><span class="line">  <span class="type">camera_fb_t</span> * fb = <span class="literal">NULL</span>;</span><br><span class="line">  fb = esp_camera_fb_get();</span><br><span class="line">  <span class="keyword">if</span> (!fb) &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;Camera capture failed&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> ESP_FAIL;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  HTTPClient http;</span><br><span class="line">  <span class="comment">//è®¾ç½®è¯·æ±‚url</span></span><br><span class="line">  http.begin(post_url);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//è®¾ç½® http è¯·æ±‚å¤´éƒ¨ä¿¡æ¯</span></span><br><span class="line">  http.addHeader(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;image/jpg&quot;</span>); <span class="comment">//è®¾ç½®ä¼ è¾“ç±»å‹ä¸ºå›¾ç‰‡</span></span><br><span class="line">  http.addHeader(<span class="string">&quot;Authorization&quot;</span>, uid); <span class="comment">//è®¾ç½®ç”¨æˆ·UIDç§é’¥</span></span><br><span class="line">  http.addHeader(<span class="string">&quot;Authtopic&quot;</span>, topic);  <span class="comment">//è®¾ç½®ä¸»é¢˜åç§°</span></span><br><span class="line">  <span class="keyword">if</span> (sentWechat) &#123; <span class="comment">//åˆ¤æ–­æ˜¯å¦éœ€è¦æ¨é€åˆ°å¾®ä¿¡</span></span><br><span class="line">    http.addHeader(<span class="string">&quot;Wechatmsg&quot;</span>, wechatMsg);  <span class="comment">//è®¾ç½® http è¯·æ±‚å¤´éƒ¨ä¿¡æ¯</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//å‘èµ·è¯·æ±‚ï¼Œå¹¶è·å–çŠ¶æ€ç </span></span><br><span class="line">  <span class="type">int</span> httpResponseCode = http.POST((<span class="type">uint8_t</span> *)fb-&gt;buf, fb-&gt;len);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (httpResponseCode == <span class="number">200</span>) &#123;</span><br><span class="line">    String response = http.getString();  <span class="comment">//Get the response to the request</span></span><br><span class="line">    Serial.println(response);           <span class="comment">//Print request answer</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Serial.print(<span class="string">&quot;Error on sending POST: &quot;</span>);</span><br><span class="line">    Serial.println(httpResponseCode);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Serial.print(<span class="string">&quot;HTTP Response code: &quot;</span>);</span><br><span class="line">  Serial.println(httpResponseCode);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//æ¸…ç©ºæ•°æ®</span></span><br><span class="line">  esp_camera_fb_return(fb);</span><br><span class="line">  <span class="comment">//å›æ”¶ä¸‹æ¬¡å†ç”¨</span></span><br><span class="line">  http.end();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="äººè„¸è¯†åˆ«-3">äººè„¸è¯†åˆ«</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">run_face_recognition</span><span class="params">(<span class="type">dl_matrix3du_t</span> *image_matrix, <span class="type">box_array_t</span> *net_boxes)</span>&#123;</span><br><span class="line">    <span class="type">dl_matrix3du_t</span> *aligned_face = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> matched_id = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    aligned_face = dl_matrix3du_alloc(<span class="number">1</span>, FACE_WIDTH, FACE_HEIGHT, <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">if</span>(!aligned_face)&#123;</span><br><span class="line">        Serial.println(<span class="string">&quot;Could not allocate face recognition buffer&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> matched_id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (align_face(net_boxes, image_matrix, aligned_face) == ESP_OK)&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_enrolling == <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="type">int8_t</span> left_sample_face = enroll_face(&amp;id_list, aligned_face);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(left_sample_face == (ENROLL_CONFIRM_TIMES - <span class="number">1</span>))&#123;</span><br><span class="line">                Serial.<span class="built_in">printf</span>(<span class="string">&quot;Enrolling Face ID: %d\n&quot;</span>, id_list.tail);</span><br><span class="line">            &#125;</span><br><span class="line">            Serial.<span class="built_in">printf</span>(<span class="string">&quot;Enrolling Face ID: %d sample %d\n&quot;</span>, id_list.tail, ENROLL_CONFIRM_TIMES - left_sample_face);</span><br><span class="line">            rgb_printf(image_matrix, FACE_COLOR_CYAN, <span class="string">&quot;ID[%u] Sample[%u]&quot;</span>, id_list.tail, ENROLL_CONFIRM_TIMES - left_sample_face);</span><br><span class="line">            <span class="keyword">if</span> (left_sample_face == <span class="number">0</span>)&#123;</span><br><span class="line">                is_enrolling = <span class="number">0</span>;</span><br><span class="line">                Serial.<span class="built_in">printf</span>(<span class="string">&quot;Enrolled Face ID: %d\n&quot;</span>, id_list.tail);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            matched_id = recognize_face(&amp;id_list, aligned_face);</span><br><span class="line">            <span class="keyword">if</span> (matched_id &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                Serial.<span class="built_in">printf</span>(<span class="string">&quot;Match Face ID: %u\n&quot;</span>, matched_id);</span><br><span class="line">                rgb_printf(image_matrix, FACE_COLOR_GREEN, <span class="string">&quot;Hello Subject %u&quot;</span>, matched_id);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Serial.println(<span class="string">&quot;No Match Found&quot;</span>);</span><br><span class="line">                rgb_print(image_matrix, FACE_COLOR_RED, <span class="string">&quot;Intruder Alert!&quot;</span>);</span><br><span class="line">                matched_id = <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Serial.println(<span class="string">&quot;Face Not Aligned&quot;</span>);</span><br><span class="line">        <span class="comment">//rgb_print(image_matrix, FACE_COLOR_YELLOW, &quot;Human Detected&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dl_matrix3du_free(aligned_face);</span><br><span class="line">    <span class="keyword">return</span> matched_id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="å¤–éƒ¨è°ƒç”¨æ¥å£å®šä¹‰">å¤–éƒ¨è°ƒç”¨æ¥å£å®šä¹‰</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">httpd_config_t</span> config = HTTPD_DEFAULT_CONFIG();</span><br><span class="line"></span><br><span class="line">    <span class="type">httpd_uri_t</span> index_uri = &#123;</span><br><span class="line">        .uri       = <span class="string">&quot;/&quot;</span>,</span><br><span class="line">        .method    = HTTP_GET,</span><br><span class="line">        .handler   = index_handler,</span><br><span class="line">        .user_ctx  = <span class="literal">NULL</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">httpd_uri_t</span> status_uri = &#123;</span><br><span class="line">        .uri       = <span class="string">&quot;/status&quot;</span>,</span><br><span class="line">        .method    = HTTP_GET,</span><br><span class="line">        .handler   = status_handler,</span><br><span class="line">        .user_ctx  = <span class="literal">NULL</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">httpd_uri_t</span> cmd_uri = &#123;</span><br><span class="line">        .uri       = <span class="string">&quot;/control&quot;</span>,</span><br><span class="line">        .method    = HTTP_GET,</span><br><span class="line">        .handler   = cmd_handler,</span><br><span class="line">        .user_ctx  = <span class="literal">NULL</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">httpd_uri_t</span> capture_uri = &#123;</span><br><span class="line">        .uri       = <span class="string">&quot;/capture&quot;</span>,</span><br><span class="line">        .method    = HTTP_GET,</span><br><span class="line">        .handler   = capture_handler,</span><br><span class="line">        .user_ctx  = <span class="literal">NULL</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">   <span class="type">httpd_uri_t</span> stream_uri = &#123;</span><br><span class="line">        .uri       = <span class="string">&quot;/stream&quot;</span>,</span><br><span class="line">        .method    = HTTP_GET,</span><br><span class="line">        .handler   = stream_handler,</span><br><span class="line">        .user_ctx  = <span class="literal">NULL</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ra_filter_init(&amp;ra_filter, <span class="number">20</span>);</span><br><span class="line">    </span><br><span class="line">    mtmn_config.min_face = <span class="number">80</span>;</span><br><span class="line">    mtmn_config.pyramid = <span class="number">0.7</span>;</span><br><span class="line">    mtmn_config.p_threshold.score = <span class="number">0.6</span>;</span><br><span class="line">    mtmn_config.p_threshold.nms = <span class="number">0.7</span>;</span><br><span class="line">    mtmn_config.r_threshold.score = <span class="number">0.7</span>;</span><br><span class="line">    mtmn_config.r_threshold.nms = <span class="number">0.7</span>;</span><br><span class="line">    mtmn_config.r_threshold.candidate_number = <span class="number">4</span>;</span><br><span class="line">    mtmn_config.o_threshold.score = <span class="number">0.7</span>;</span><br><span class="line">    mtmn_config.o_threshold.nms = <span class="number">0.4</span>;</span><br><span class="line">    mtmn_config.o_threshold.candidate_number = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    face_id_init(&amp;id_list, FACE_ID_SAVE_NUMBER, ENROLL_CONFIRM_TIMES);</span><br><span class="line">    </span><br><span class="line">    Serial.<span class="built_in">printf</span>(<span class="string">&quot;Starting web server on port: &#x27;%d&#x27;\n&quot;</span>, config.server_port);</span><br><span class="line">    <span class="keyword">if</span> (httpd_start(&amp;camera_httpd, &amp;config) == ESP_OK) &#123;</span><br><span class="line">        httpd_register_uri_handler(camera_httpd, &amp;index_uri);</span><br><span class="line">        httpd_register_uri_handler(camera_httpd, &amp;cmd_uri);</span><br><span class="line">        httpd_register_uri_handler(camera_httpd, &amp;status_uri);</span><br><span class="line">        httpd_register_uri_handler(camera_httpd, &amp;capture_uri);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    config.server_port += <span class="number">1</span>;</span><br><span class="line">    config.ctrl_port += <span class="number">1</span>;</span><br><span class="line">    Serial.<span class="built_in">printf</span>(<span class="string">&quot;Starting stream server on port: &#x27;%d&#x27;\n&quot;</span>, config.server_port);</span><br><span class="line">    <span class="keyword">if</span> (httpd_start(&amp;stream_httpd, &amp;config) == ESP_OK) &#123;</span><br><span class="line">        httpd_register_uri_handler(stream_httpd, &amp;stream_uri);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="webç•Œé¢å®šä¹‰">webç•Œé¢å®šä¹‰</h3><blockquote><p>é¡µé¢å®šä¹‰ä¸æ¸²æŸ“ ä¸¾ä¾‹ çŠ¶æ€é¡µé¢</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰</span></span><br><span class="line"><span class="type">static</span> <span class="type">esp_err_t</span> <span class="title function_">status_handler</span><span class="params">(<span class="type">httpd_req_t</span> *req)</span>&#123;</span><br><span class="line"> <span class="type">static</span> <span class="type">char</span> json_response[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">    <span class="type">sensor_t</span> * s = esp_camera_sensor_get();</span><br><span class="line">    <span class="type">char</span> * p = json_response;</span><br><span class="line">    *p++ = <span class="string">&#x27;&#123;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    p+=<span class="built_in">sprintf</span>(p, <span class="string">&quot;\&quot;framesize\&quot;:%u,&quot;</span>, s-&gt;status.framesize);</span><br><span class="line">    p+=<span class="built_in">sprintf</span>(p, <span class="string">&quot;\&quot;quality\&quot;:%u,&quot;</span>, s-&gt;status.quality);</span><br><span class="line">    p+=<span class="built_in">sprintf</span>(p, <span class="string">&quot;\&quot;brightness\&quot;:%d,&quot;</span>, s-&gt;status.brightness);</span><br><span class="line">    p+=<span class="built_in">sprintf</span>(p, <span class="string">&quot;\&quot;contrast\&quot;:%d,&quot;</span>, s-&gt;status.contrast);</span><br><span class="line">    p+=<span class="built_in">sprintf</span>(p, <span class="string">&quot;\&quot;saturation\&quot;:%d,&quot;</span>, s-&gt;status.saturation);</span><br><span class="line">    p+=<span class="built_in">sprintf</span>(p, <span class="string">&quot;\&quot;special_effect\&quot;:%u,&quot;</span>, s-&gt;status.special_effect);</span><br><span class="line">    p+=<span class="built_in">sprintf</span>(p, <span class="string">&quot;\&quot;wb_mode\&quot;:%u,&quot;</span>, s-&gt;status.wb_mode);</span><br><span class="line">    p+=<span class="built_in">sprintf</span>(p, <span class="string">&quot;\&quot;awb\&quot;:%u,&quot;</span>, s-&gt;status.awb);</span><br><span class="line">    p+=<span class="built_in">sprintf</span>(p, <span class="string">&quot;\&quot;awb_gain\&quot;:%u,&quot;</span>, s-&gt;status.awb_gain);</span><br><span class="line">    p+=<span class="built_in">sprintf</span>(p, <span class="string">&quot;\&quot;aec\&quot;:%u,&quot;</span>, s-&gt;status.aec);</span><br><span class="line">    p+=<span class="built_in">sprintf</span>(p, <span class="string">&quot;\&quot;aec2\&quot;:%u,&quot;</span>, s-&gt;status.aec2);</span><br><span class="line">    p+=<span class="built_in">sprintf</span>(p, <span class="string">&quot;\&quot;ae_level\&quot;:%d,&quot;</span>, s-&gt;status.ae_level);</span><br><span class="line">    p+=<span class="built_in">sprintf</span>(p, <span class="string">&quot;\&quot;aec_value\&quot;:%u,&quot;</span>, s-&gt;status.aec_value);</span><br><span class="line">    p+=<span class="built_in">sprintf</span>(p, <span class="string">&quot;\&quot;agc\&quot;:%u,&quot;</span>, s-&gt;status.agc);</span><br><span class="line">    p+=<span class="built_in">sprintf</span>(p, <span class="string">&quot;\&quot;agc_gain\&quot;:%u,&quot;</span>, s-&gt;status.agc_gain);</span><br><span class="line">    p+=<span class="built_in">sprintf</span>(p, <span class="string">&quot;\&quot;gainceiling\&quot;:%u,&quot;</span>, s-&gt;status.gainceiling);</span><br><span class="line">    p+=<span class="built_in">sprintf</span>(p, <span class="string">&quot;\&quot;bpc\&quot;:%u,&quot;</span>, s-&gt;status.bpc);</span><br><span class="line">    p+=<span class="built_in">sprintf</span>(p, <span class="string">&quot;\&quot;wpc\&quot;:%u,&quot;</span>, s-&gt;status.wpc);</span><br><span class="line">    p+=<span class="built_in">sprintf</span>(p, <span class="string">&quot;\&quot;raw_gma\&quot;:%u,&quot;</span>, s-&gt;status.raw_gma);</span><br><span class="line">    p+=<span class="built_in">sprintf</span>(p, <span class="string">&quot;\&quot;lenc\&quot;:%u,&quot;</span>, s-&gt;status.lenc);</span><br><span class="line">    p+=<span class="built_in">sprintf</span>(p, <span class="string">&quot;\&quot;vflip\&quot;:%u,&quot;</span>, s-&gt;status.vflip);</span><br><span class="line">    p+=<span class="built_in">sprintf</span>(p, <span class="string">&quot;\&quot;hmirror\&quot;:%u,&quot;</span>, s-&gt;status.hmirror);</span><br><span class="line">    p+=<span class="built_in">sprintf</span>(p, <span class="string">&quot;\&quot;dcw\&quot;:%u,&quot;</span>, s-&gt;status.dcw);</span><br><span class="line">    p+=<span class="built_in">sprintf</span>(p, <span class="string">&quot;\&quot;colorbar\&quot;:%u,&quot;</span>, s-&gt;status.colorbar);</span><br><span class="line">    p+=<span class="built_in">sprintf</span>(p, <span class="string">&quot;\&quot;face_detect\&quot;:%u,&quot;</span>, detection_enabled);</span><br><span class="line">    p+=<span class="built_in">sprintf</span>(p, <span class="string">&quot;\&quot;face_enroll\&quot;:%u,&quot;</span>, is_enrolling);</span><br><span class="line">    p+=<span class="built_in">sprintf</span>(p, <span class="string">&quot;\&quot;face_recognize\&quot;:%u&quot;</span>, recognition_enabled);</span><br><span class="line">    *p++ = <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    *p++ = <span class="number">0</span>;</span><br><span class="line">    httpd_resp_set_type(req, <span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">    httpd_resp_set_hdr(req, <span class="string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="string">&quot;*&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> httpd_resp_send(req, json_response, <span class="built_in">strlen</span>(json_response));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ¸²æŸ“</span></span><br><span class="line"><span class="type">static</span> <span class="type">esp_err_t</span> <span class="title function_">index_handler</span><span class="params">(<span class="type">httpd_req_t</span> *req)</span>&#123;</span><br><span class="line">    httpd_resp_set_type(req, <span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">    httpd_resp_set_hdr(req, <span class="string">&quot;Content-Encoding&quot;</span>, <span class="string">&quot;gzip&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> httpd_resp_send(req, (<span class="type">const</span> <span class="type">char</span> *)index_html_gz, index_html_gz_len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æœ€ç»ˆæ•ˆæœ">æœ€ç»ˆæ•ˆæœ</h2><h3 id="esp32-cam-webç•Œé¢æ˜¾ç¤º">esp32-cam webç•Œé¢æ˜¾ç¤º</h3><blockquote><p>å¦‚å›¾</p></blockquote><p><img src="/2024/10/27/cat-camera/cateye.png" class="lazyload placeholder" data-srcset="/2024/10/27/cat-camera/cateye.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h3 id="pyè¯†åˆ«æ•ˆæœ">pyè¯†åˆ«æ•ˆæœ</h3><blockquote><p>æ•ˆæœå¦‚ä»¥ä¸‹é“¾æ¥</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://v.youku.com/v_show/id_XNTE2MTUwNjA1Ng==.html</span><br></pre></td></tr></table></figure><h2 id="See">See</h2><ul><li>1.<a href="https://github.com/espressif/arduino-esp32">https://github.com/espressif/arduino-esp32</a></li><li>2.<a href="https://makeradvisor.com/tools/esp32-cam/">https://makeradvisor.com/tools/esp32-cam/</a></li><li>3.<a href="https://randomnerdtutorials.com/esp32-cam-video-streaming-face-recognition-arduino-ide/">https://randomnerdtutorials.com/esp32-cam-video-streaming-face-recognition-arduino-ide/</a></li><li>4.<a href="http://pepy.tech/badge/opencv-python">http://pepy.tech/badge/opencv-python</a></li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> esp32 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäºHarmonyOS Next(5.0.0) ç®€å•demo appå®ç°</title>
      <link href="/2024/10/25/ohos-pixiv-image/"/>
      <url>/2024/10/25/ohos-pixiv-image/</url>
      
        <content type="html"><![CDATA[<h1>åŸºäºHarmonyOS Next(5.0.0) ç®€å•demo appå®ç°</h1><h2 id="ç®€ä»‹">ç®€ä»‹</h2><h3 id="OpenHarmonyï¼šï¼ˆå¼€æºï¼‰">OpenHarmonyï¼šï¼ˆå¼€æºï¼‰</h3><p>é¸¿è’™åº•å±‚å†…æ ¸ç³»ç»Ÿï¼Œé›†æˆLinuxå†…æ ¸+LiteOSï¼Œå…·å¤‡åº•å±‚é€šä¿¡èƒ½åŠ›ï¼Œå±äºé¸¿è’™åº•å±‚çš„æ¶æ„å±‚ã€‚</p><h3 id="HarmonyOSï¼šï¼ˆé—­æºï¼‰">HarmonyOSï¼šï¼ˆé—­æºï¼‰</h3><blockquote><p>åŸºäºOpenHarmonyå’Œå®‰å“ï¼ˆAOSPï¼‰æ‰“é€ çš„æ‰‹æœºç³»ç»Ÿï¼ŒåŒ…å«UIç•Œé¢ï¼Œåº”ç”¨ç”Ÿæ€ç»‘å®šå®‰å“ï¼Œè¿™æ˜¯ç›®å‰é¸¿è’™çš„ä¸»å½¢æ€ã€‚</p></blockquote><h3 id="Harmony-OS-NEXTï¼šï¼ˆé—­æºï¼‰">Harmony OS NEXTï¼šï¼ˆé—­æºï¼‰</h3><blockquote><p>åœ¨HarmonyOSåŸºç¡€ä¸Šå‰”é™¤å®‰å“ï¼ˆAOSPï¼‰åçš„äº§å“ï¼Œå±äºå…¨æ–°çš„æ‰‹æœºç³»ç»Ÿï¼Œæ˜¯é¸¿è’™ç³»ç»Ÿçš„æœªæ¥å½¢æ€ã€‚<br>Harmony OS NEXTï¼Œä¹Ÿè¢«ç§°ä¸ºçº¯è¡€é¸¿è’™ã€‚è¿™ä¸ªç³»ç»Ÿå°±ä¸å†å…¼å®¹å®‰å“ç”Ÿæ€ã€‚</p></blockquote><h2 id="å¼€å‘ç®€è¿°">å¼€å‘ç®€è¿°</h2><blockquote><p>!!!éƒ¨åˆ†ç½‘ç«™éœ€ç™»å½•åä¸ºå¼€å‘è€…è´¦å·æŸ¥çœ‹!!!</p></blockquote><h3 id="IDE-ä¸‹è½½é“¾æ¥">IDE ä¸‹è½½é“¾æ¥</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://developer.huawei.com/consumer/cn/deveco-studio/</span><br></pre></td></tr></table></figure><h3 id="ArkTSå­¦ä¹ æ–‡æ¡£">ArkTSå­¦ä¹ æ–‡æ¡£</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-commonlibrary-overview-V5</span><br></pre></td></tr></table></figure><h3 id="HarmonyOS-NEXT-å¼€å‘æ–‡æ¡£">HarmonyOS NEXT å¼€å‘æ–‡æ¡£</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ARKUI</span></span><br><span class="line">https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkui-V5</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">API</span></span><br><span class="line">https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/arkui-api-V5?catalogVersion=V5</span><br></pre></td></tr></table></figure><h3 id="åŸºç¡€æ¦‚å¿µ">åŸºç¡€æ¦‚å¿µ</h3><h4 id="åº”ç”¨æ¨¡å‹">åº”ç”¨æ¨¡å‹</h4><blockquote><p>åº”ç”¨æ¨¡å‹æ˜¯HarmonyOSä¸ºå¼€å‘è€…æä¾›çš„åº”ç”¨ç¨‹åºæ‰€éœ€èƒ½åŠ›çš„æŠ½è±¡æç‚¼ï¼Œå®ƒæä¾›äº†åº”ç”¨ç¨‹åºå¿…å¤‡çš„ç»„ä»¶å’Œè¿è¡Œæœºåˆ¶ã€‚æœ‰äº†åº”ç”¨æ¨¡å‹ï¼Œå¼€å‘è€…å¯ä»¥åŸºäºä¸€å¥—ç»Ÿä¸€çš„æ¨¡å‹è¿›è¡Œåº”ç”¨å¼€å‘ï¼Œä½¿åº”ç”¨å¼€å‘æ›´ç®€å•ã€é«˜æ•ˆã€‚<br>éšç€ç³»ç»Ÿçš„æ¼”è¿›å‘å±•ï¼ŒHarmonyOSå…ˆåæä¾›äº†ä¸¤ç§åº”ç”¨æ¨¡å‹ï¼š</p></blockquote><blockquote><p>FAï¼ˆFeature Abilityï¼‰æ¨¡å‹ï¼š HarmonyOS API 7å¼€å§‹æ”¯æŒçš„æ¨¡å‹ï¼Œå·²ç»ä¸å†ä¸»æ¨ã€‚</p></blockquote><blockquote><p>Stageæ¨¡å‹ï¼š HarmonyOS API 9å¼€å§‹æ–°å¢çš„æ¨¡å‹ï¼Œæ˜¯ç›®å‰ä¸»æ¨ä¸”ä¼šé•¿æœŸæ¼”è¿›çš„æ¨¡å‹ã€‚åœ¨è¯¥æ¨¡å‹ä¸­ï¼Œç”±äºæä¾›äº†AbilityStageã€WindowStageç­‰ç±»ä½œä¸ºåº”ç”¨ç»„ä»¶å’ŒWindowçª—å£çš„â€œèˆå°â€ï¼Œå› æ­¤ç§°è¿™ç§åº”ç”¨æ¨¡å‹ä¸ºStageæ¨¡å‹ã€‚Stageæ¨¡å‹å¼€å‘å¯è§Stageæ¨¡å‹å¼€å‘æ¦‚è¿°ã€‚å¿«é€Ÿå…¥é—¨ä»¥æ­¤ä¸ºä¾‹æä¾›å¼€å‘æŒ‡å¯¼ã€‚</p></blockquote><blockquote><p>é¡¹ç›®åŸºæœ¬æ¡†æ¶å¦‚ä¸‹</p></blockquote><p><img src="/2024/10/25/ohos-pixiv-image/prj_struct.png" class="lazyload placeholder" data-srcset="/2024/10/25/ohos-pixiv-image/prj_struct.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h4 id="å…¥é—¨æŒ‡å¯¼é“¾æ¥">å…¥é—¨æŒ‡å¯¼é“¾æ¥</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/start-with-ets-stage-V5</span><br></pre></td></tr></table></figure><h3 id="hdcå·¥å…·ï¼ˆç±»åˆ«adbï¼‰">hdcå·¥å…·ï¼ˆç±»åˆ«adbï¼‰</h3><blockquote><p>é€šè¿‡HarmonyOS SDKè·å–ï¼Œåœ¨SDKçš„toolchainsç›®å½•, ç›´æ¥ä½¿ç”¨hdcå®‰è£…ã€æ›´æ–°HAPã€‚</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// å®‰è£…ã€æ›´æ–°ï¼Œå¤šHAPå¯ä»¥æŒ‡å®šå¤šä¸ªæ–‡ä»¶è·¯å¾„</span><br><span class="line">hdc install entry.hap feature.hap</span><br><span class="line">// æ‰§è¡Œç»“æœ</span><br><span class="line">install bundle successfully.</span><br><span class="line">// å¸è½½</span><br><span class="line">hdc uninstall com.example.myapplication</span><br><span class="line">// æ‰§è¡Œç»“æœ</span><br><span class="line">uninstall bundle successfully.</span><br></pre></td></tr></table></figure><h2 id="å¼€å‘æµç¨‹">å¼€å‘æµç¨‹</h2><ul><li>æ³¨å†Œæˆä¸ºå¼€å‘è€…</li></ul><blockquote><p>åœ¨åä¸ºå¼€å‘è€…è”ç›Ÿç½‘ç«™ï¼ˆ<a href="https://developer.huawei.com/consumer/cn/%EF%BC%89%E4%B8%8A%EF%BC%8C%E6%B3%A8%E5%86%8C%E6%88%90%E4%B8%BA%E5%BC%80%E5%8F%91%E8%80%85%EF%BC%8C%E5%B9%B6%E5%AE%8C%E6%88%90%E5%AE%9E%E5%90%8D%E8%AE%A4%E8%AF%81%EF%BC%8C%E4%BB%8E%E8%80%8C%E4%BA%AB%E5%8F%97%E8%81%94%E7%9B%9F%E5%BC%80%E6%94%BE%E7%9A%84%E5%90%84%E7%B1%BB%E8%83%BD%E5%8A%9B%E5%92%8C%E6%9C%8D%E5%8A%A1%E3%80%82">https://developer.huawei.com/consumer/cn/ï¼‰ä¸Šï¼Œæ³¨å†Œæˆä¸ºå¼€å‘è€…ï¼Œå¹¶å®Œæˆå®åè®¤è¯ï¼Œä»è€Œäº«å—è”ç›Ÿå¼€æ”¾çš„å„ç±»èƒ½åŠ›å’ŒæœåŠ¡ã€‚</a></p></blockquote><ul><li>åˆ›å»ºåº”ç”¨</li></ul><blockquote><p>åœ¨AppGallery Connectï¼ˆç®€ç§°AGCï¼‰ä¸Šï¼Œå‚è€ƒåˆ›å»ºé¡¹ç›®å’Œåˆ›å»ºåº”ç”¨å®ŒæˆHarmonyOSåº”ç”¨çš„åˆ›å»ºï¼Œä»è€Œä½¿ç”¨å„ç±»æœåŠ¡ã€‚</p></blockquote><ul><li>é…ç½®å®‰è£…DevEco Studio</li></ul><blockquote><p>å®‰è£…æœ€æ–°ç‰ˆDevEco Studioã€‚<a href="https://developer.huawei.com/consumer/cn/deveco-studio/">https://developer.huawei.com/consumer/cn/deveco-studio/</a></p></blockquote><ul><li><p>ä½¿ç”¨DevEco Studioåˆ›å»ºåº”ç”¨å·¥ç¨‹</p></li><li><p>é…ç½®ç­¾åä¿¡æ¯</p></li></ul><blockquote><p>ä½¿ç”¨æ¨¡æ‹Ÿå™¨å’Œé¢„è§ˆå™¨è°ƒè¯•æ— éœ€é…ç½®ç­¾åä¿¡æ¯ï¼Œä½¿ç”¨çœŸæœºè®¾å¤‡è°ƒè¯•åˆ™éœ€è¦å¯¹HAPè¿›è¡Œç­¾åã€‚</p></blockquote><h2 id="å®ç°åŠŸèƒ½">å®ç°åŠŸèƒ½</h2><h3 id="åŸºæœ¬åŠŸèƒ½">åŸºæœ¬åŠŸèƒ½</h3><ul><li><p>åŸºç¡€é¡µé¢å±•ç¤º</p></li><li><p>åŸºç¡€ç»„ä»¶ä½¿ç”¨</p></li><li><p>ç½‘ç»œè¯·æ±‚ä¸å¤„ç†</p></li><li><p>logå¤„ç†</p></li></ul><h3 id="ä½¿ç”¨æŠ€æœ¯">ä½¿ç”¨æŠ€æœ¯</h3><ul><li><p>axio</p></li><li><p>log4a(<a href="https://ericple.atomgit.net/log4a-docs/guide/getting-started">https://ericple.atomgit.net/log4a-docs/guide/getting-started</a>)</p></li><li><p>ArkUI</p></li><li><p>ArkTs</p></li><li><p>PreferencesManager</p></li></ul><h2 id="å®ç°è¿‡ç¨‹">å®ç°è¿‡ç¨‹</h2><h3 id="page-é¡µé¢ä»£ç ç¼–å†™">page é¡µé¢ä»£ç ç¼–å†™</h3><h4 id="main-page-ets">main page.ets</h4><blockquote><p>ä»¥ä¸‹é¡µé¢å®šä¹‰äº†æ–‡æœ¬æ˜¾ç¤ºã€æ–‡æœ¬è¾“å…¥ã€å•é€‰æ¡†ã€æŒ‰é’®ç­‰ç»„ä»¶ï¼›ç”¨æˆ·è¾“å…¥æŒ‡å®šä¿¡æ¯ï¼Œé€šè¿‡PreferencesManagerä¿å­˜æ•°æ®ï¼Œå¾…éœ€è¦æ—¶é‡æ–°è¯»å–ï¼›å®šä¹‰æŒ‰é’®è·³è½¬è‡³ä¸‹ä¸€ä¸ªé¡µé¢ã€‚</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PageClass</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../model/PageModel&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">BusinessError</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@kit.BasicServicesKit&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">PreferencesManager</span> <span class="keyword">from</span> <span class="string">&#x27;../data/PreferencesManager&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Logger</span>, <span class="title class_">LogManager</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@pie/log4a&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; fileAppender_a &#125; <span class="keyword">from</span> <span class="string">&#x27;../logs/log_const&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">IndexBuilder</span>(<span class="params"><span class="attr">name</span>: <span class="built_in">string</span>, <span class="attr">param</span>: <span class="title class_">Object</span></span>) &#123;</span><br><span class="line">  <span class="title class_">Index</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">Index</span> &#123;</span><br><span class="line">  <span class="comment">// @State logger: Logger = LogManager.getLogger(this);// æ­¤å¤„ç›´æ¥è·å–Loggerå³å¯</span></span><br><span class="line">  <span class="meta">@State</span> <span class="attr">logger</span>: <span class="title class_">Logger</span> = <span class="title class_">LogManager</span>.<span class="title function_">getLogger</span>(<span class="variable language_">this</span>)</span><br><span class="line">    .<span class="title function_">bindAppender</span>(fileAppender_a)</span><br><span class="line">  <span class="comment">// .bindAppender(socketAppender);</span></span><br><span class="line">  <span class="meta">@State</span> <span class="attr">text</span>: <span class="built_in">string</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="meta">@State</span> <span class="attr">positionInfo</span>: <span class="title class_">CaretOffset</span> = &#123; <span class="attr">index</span>: <span class="number">0</span>, <span class="attr">x</span>: <span class="number">0</span>, <span class="attr">y</span>: <span class="number">0</span> &#125;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">passwordState</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span><br><span class="line">  <span class="attr">controller</span>: <span class="title class_">TextInputController</span> = <span class="keyword">new</span> <span class="title class_">TextInputController</span>()</span><br><span class="line">  <span class="attr">pageInfos</span>: <span class="title class_">NavPathStack</span> = <span class="keyword">new</span> <span class="title class_">NavPathStack</span>()</span><br><span class="line">  tmp = <span class="keyword">new</span> <span class="title class_">PageClass</span>();</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Navigation</span>(<span class="variable language_">this</span>.<span class="property">pageInfos</span>) &#123;</span><br><span class="line">      <span class="title class_">Column</span>(&#123; <span class="attr">space</span>: <span class="number">5</span> &#125;) &#123;</span><br><span class="line">        <span class="title class_">Row</span>(&#123; <span class="attr">space</span>: <span class="number">5</span> &#125;) &#123;</span><br><span class="line">          <span class="title class_">Text</span>(<span class="string">&quot;é“¾æ¥: &quot;</span>)</span><br><span class="line">            .<span class="title function_">fontSize</span>(<span class="number">10</span>)</span><br><span class="line">            .<span class="title function_">fontColor</span>(<span class="title class_">Color</span>.<span class="property">Blue</span>)</span><br><span class="line">          <span class="title class_">TextInput</span>(&#123; <span class="attr">text</span>: <span class="string">&quot;https://image.anosu.top/pixiv/&quot;</span>, <span class="attr">placeholder</span>: <span class="string">&#x27;input your link...&#x27;</span>, <span class="attr">controller</span>: <span class="variable language_">this</span>.<span class="property">controller</span> &#125;)</span><br><span class="line">            .<span class="title function_">placeholderColor</span>(<span class="title class_">Color</span>.<span class="property">Grey</span>)</span><br><span class="line">            .<span class="title function_">placeholderFont</span>(&#123; <span class="attr">size</span>: <span class="number">14</span>, <span class="attr">weight</span>: <span class="number">400</span> &#125;)</span><br><span class="line">            .<span class="title function_">caretColor</span>(<span class="title class_">Color</span>.<span class="property">Blue</span>)</span><br><span class="line">            .<span class="title function_">width</span>(<span class="string">&#x27;95%&#x27;</span>)</span><br><span class="line">            .<span class="title function_">height</span>(<span class="number">40</span>)</span><br><span class="line">            .<span class="title function_">margin</span>(<span class="number">20</span>)</span><br><span class="line">            .<span class="title function_">fontSize</span>(<span class="number">14</span>)</span><br><span class="line">            .<span class="title function_">fontColor</span>(<span class="title class_">Color</span>.<span class="property">Black</span>)<span class="comment">// .inputFilter(&#x27;[a-z]&#x27;, (e) =&gt; &#123;</span></span><br><span class="line">              <span class="comment">//    this.logger.info(JSON.stringify(e))</span></span><br><span class="line">              <span class="comment">// &#125;)</span></span><br><span class="line">            .<span class="title function_">onChange</span>(<span class="function">(<span class="params"><span class="attr">value</span>: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">tmp</span>.<span class="property">link</span> = value</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;.<span class="title function_">margin</span>(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Row</span>(&#123; <span class="attr">space</span>: <span class="number">5</span> &#125;) &#123;</span><br><span class="line">          <span class="title class_">Text</span>(<span class="string">&quot;å…³é”®å­—: &quot;</span>)</span><br><span class="line">            .<span class="title function_">fontSize</span>(<span class="number">10</span>)</span><br><span class="line">            .<span class="title function_">fontColor</span>(<span class="title class_">Color</span>.<span class="property">Blue</span>)</span><br><span class="line">          <span class="title class_">TextInput</span>(&#123; <span class="attr">text</span>: <span class="variable language_">this</span>.<span class="property">text</span>, <span class="attr">placeholder</span>: <span class="string">&#x27;input your keyword...&#x27;</span>, <span class="attr">controller</span>: <span class="variable language_">this</span>.<span class="property">controller</span> &#125;)</span><br><span class="line">            .<span class="title function_">placeholderColor</span>(<span class="title class_">Color</span>.<span class="property">Grey</span>)</span><br><span class="line">            .<span class="title function_">placeholderFont</span>(&#123; <span class="attr">size</span>: <span class="number">14</span>, <span class="attr">weight</span>: <span class="number">400</span> &#125;)</span><br><span class="line">            .<span class="title function_">caretColor</span>(<span class="title class_">Color</span>.<span class="property">Blue</span>)</span><br><span class="line">            .<span class="title function_">width</span>(<span class="string">&#x27;95%&#x27;</span>)</span><br><span class="line">            .<span class="title function_">height</span>(<span class="number">40</span>)</span><br><span class="line">            .<span class="title function_">margin</span>(<span class="number">20</span>)</span><br><span class="line">            .<span class="title function_">fontSize</span>(<span class="number">14</span>)</span><br><span class="line">            .<span class="title function_">fontColor</span>(<span class="title class_">Color</span>.<span class="property">Black</span>)<span class="comment">// .inputFilter(&#x27;[a-z]&#x27;, (e) =&gt; &#123;</span></span><br><span class="line">              <span class="comment">//    this.logger.info(JSON.stringify(e))</span></span><br><span class="line">              <span class="comment">// &#125;)</span></span><br><span class="line">            .<span class="title function_">onChange</span>(<span class="function">(<span class="params"><span class="attr">value</span>: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">tmp</span>.<span class="property">keyword</span> = value</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;.<span class="title function_">margin</span>(<span class="number">5</span>)</span><br><span class="line">        <span class="title class_">Row</span>(&#123; <span class="attr">space</span>: <span class="number">12</span> &#125;) &#123;</span><br><span class="line">          <span class="title class_">Button</span>(<span class="string">&#x27;start explore&#x27;</span>)</span><br><span class="line">            .<span class="title function_">onClick</span>(<span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">              <span class="title class_">PreferencesManager</span>.<span class="property">shared</span>.<span class="title function_">set</span>(<span class="string">&quot;keyword&quot;</span>, <span class="variable language_">this</span>.<span class="property">tmp</span>.<span class="property">keyword</span>)<span class="comment">//ä¿å­˜æ•°æ®</span></span><br><span class="line">              <span class="title class_">PreferencesManager</span>.<span class="property">shared</span>.<span class="title function_">set</span>(<span class="string">&quot;link&quot;</span>, <span class="variable language_">this</span>.<span class="property">tmp</span>.<span class="property">link</span>)</span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">pageInfos</span>.<span class="title function_">pushPathByName</span>(<span class="string">&#x27;PixivImage&#x27;</span>, <span class="string">&quot;this.tmp&quot;</span>)</span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">info</span>(<span class="string">&quot;jump next page&quot;</span>)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;.<span class="title function_">margin</span>(<span class="number">5</span>)</span><br><span class="line">      &#125;.<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">      .<span class="title function_">margin</span>(<span class="number">5</span>)</span><br><span class="line">    &#125;.<span class="title function_">title</span>(<span class="string">&#x27;é¦–é¡µ&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="PixivImage-ets">PixivImage.ets</h4><blockquote><p>æœ¬é¡µé¢é€šè¿‡PreferencesManagerè·å–ä¸Šä¸ªé¡µé¢ç”¨æˆ·è¾“å…¥æ•°æ®é€šè¿‡axioï¼ˆæˆ–ç³»ç»Ÿç½‘ç»œAPIï¼‰å‘èµ·httpè¯·æ±‚å¹¶è·å–ç»“æœï¼Œæœ€ç»ˆå°†ç»“æœæ¸²æŸ“è‡³é¡µé¢ï¼Œå±•ç¤ºä¸ºè½®æ’­å›¾ä¸­Imageã€‚</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; hilog &#125; <span class="keyword">from</span> <span class="string">&#x27;@kit.PerformanceAnalysisKit&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> getHttpData, &#123; httpRequestGet &#125; <span class="keyword">from</span> <span class="string">&#x27;../http/HttpRequest&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">JSON</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@kit.ArkTS&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ListDataSource</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../model/ImagegModel&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; promptAction &#125; <span class="keyword">from</span> <span class="string">&#x27;@kit.ArkUI&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PageClass</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../model/PageModel&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">PreferencesManager</span> <span class="keyword">from</span> <span class="string">&#x27;../data/PreferencesManager&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Logger</span>, <span class="title class_">LogManager</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@pie/log4a&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; fileAppender_a, socketAppender &#125; <span class="keyword">from</span> <span class="string">&#x27;../logs/log_const&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">PixivImageBuilder</span>(<span class="params"><span class="attr">name</span>: <span class="built_in">string</span>, <span class="attr">param</span>: <span class="title class_">Object</span></span>) &#123;</span><br><span class="line">  <span class="title class_">PixivImage</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">PixivImage</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">logger</span>: <span class="title class_">Logger</span> = <span class="title class_">LogManager</span>.<span class="title function_">getLogger</span>(<span class="variable language_">this</span>)</span><br><span class="line">    .<span class="title function_">bindAppender</span>(fileAppender_a)</span><br><span class="line">  <span class="attr">swiperController</span>: <span class="title class_">SwiperController</span> = <span class="keyword">new</span> <span class="title class_">SwiperController</span>();</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">pixelMapImg</span>: <span class="title class_">PixelMap</span> | <span class="literal">undefined</span> = <span class="literal">undefined</span>;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">data</span>: <span class="title class_">ListDataSource</span>&lt;<span class="built_in">string</span>&gt; = <span class="keyword">new</span> <span class="title class_">ListDataSource</span>&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">  tmp = <span class="keyword">new</span> <span class="title class_">PageClass</span>();</span><br><span class="line">  <span class="attr">keyword</span>: <span class="built_in">string</span> = <span class="string">&quot;klee&quot;</span> ;</span><br><span class="line">  <span class="attr">link</span>: <span class="built_in">string</span> = <span class="string">&#x27;https://image.anosu.top/pixiv/&#x27;</span>;</span><br><span class="line">  <span class="comment">// pathStack: NavPathStack = new NavPathStack()</span></span><br><span class="line">  <span class="meta">@Provide</span>(<span class="string">&#x27;NavPathStack&#x27;</span>) <span class="attr">pageStack</span>: <span class="title class_">NavPathStack</span> = <span class="keyword">new</span> <span class="title class_">NavPathStack</span>()</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Builder</span></span><br><span class="line">  <span class="title class_">PagesMap</span>(<span class="attr">name</span>: <span class="built_in">string</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="string">&#x27;PixivImage&#x27;</span>) &#123;</span><br><span class="line">      <span class="title class_">PixivImage</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">menuItems</span>: <span class="title class_">Array</span>&lt;<span class="title class_">NavigationMenuItem</span>&gt; = [</span><br><span class="line"></span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">aboutToAppear</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// this.requestImageUrl(this.src_pix);// è¯·å¡«å†™ä¸€ä¸ªå…·ä½“çš„ç½‘ç»œå›¾ç‰‡åœ°å€</span></span><br><span class="line">    hilog.<span class="title function_">warn</span>(<span class="number">0x0000</span>, <span class="string">&#x27;testTag&#x27;</span>, <span class="string">&#x27;%&#123;public&#125;s&#x27;</span>, <span class="string">&#x27;start load image&#x27;</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">keyword</span> = <span class="title class_">PreferencesManager</span>.<span class="property">shared</span>.<span class="title function_">get</span>(<span class="string">&quot;keyword&quot;</span>)?.<span class="title function_">toString</span>() || <span class="string">&quot;klee&quot;</span>;<span class="comment">//è¯»å–å­˜å‚¨æ•°æ®</span></span><br><span class="line">    <span class="comment">// å¦‚æœç»“æœä¸ºfalsyå€¼ï¼ˆåŒ…æ‹¬nullã€undefinedã€&#x27;&#x27;ã€0ã€NaNã€falseï¼‰ï¼Œåˆ™é»˜è®¤ä¸ºç©ºå­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">link</span> = <span class="title class_">PreferencesManager</span>.<span class="property">shared</span>.<span class="title function_">get</span>(<span class="string">&quot;link&quot;</span>)?.<span class="title function_">toString</span>() || <span class="string">&quot;https://image.anosu.top/pixiv/&quot;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">info</span>(<span class="string">&quot;result get page :  &quot;</span> + <span class="variable language_">this</span>.<span class="property">keyword</span> +<span class="string">&quot; , link &quot;</span> + <span class="variable language_">this</span>.<span class="property">link</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">data</span>.<span class="title function_">pushData</span>(<span class="keyword">await</span> <span class="title function_">getHttpData</span>(<span class="variable language_">this</span>.<span class="property">keyword</span>, <span class="variable language_">this</span>.<span class="property">link</span>))</span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">info</span>(<span class="variable language_">this</span>.<span class="property">data</span>.<span class="title function_">getData</span>(<span class="number">0</span>))</span><br><span class="line">    promptAction.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&quot;load result: &quot;</span> + <span class="variable language_">this</span>.<span class="property">data</span>.<span class="title function_">getData</span>(<span class="number">0</span>),</span><br><span class="line">      <span class="attr">duration</span>: <span class="number">2000</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line">    <span class="comment">// this.list.push(await getHttpData());</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">NavDestination</span>() &#123;</span><br><span class="line">      <span class="title class_">Column</span>(&#123; <span class="attr">space</span>: <span class="number">5</span> &#125;) &#123;</span><br><span class="line">        <span class="title class_">Swiper</span>(<span class="variable language_">this</span>.<span class="property">swiperController</span>) &#123;</span><br><span class="line">          <span class="title class_">LazyForEach</span>(<span class="variable language_">this</span>.<span class="property">data</span>, <span class="function">(<span class="params"><span class="attr">item</span>: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="title class_">Image</span>(item)</span><br><span class="line">              .<span class="title function_">alt</span>($r(<span class="string">&#x27;app.media.startIcon&#x27;</span>))</span><br><span class="line">              .<span class="title function_">objectFit</span>(<span class="title class_">ImageFit</span>.<span class="property">None</span>)</span><br><span class="line">              .<span class="title function_">width</span>(<span class="string">&#x27;95%&#x27;</span>)</span><br><span class="line">              .<span class="title function_">height</span>(<span class="string">&#x27;95%&#x27;</span>)</span><br><span class="line"></span><br><span class="line">          &#125;, <span class="function">(<span class="params"><span class="attr">item</span>: <span class="built_in">string</span></span>) =&gt;</span> item)</span><br><span class="line">        &#125;</span><br><span class="line">        .<span class="title function_">indicator</span>(<span class="literal">true</span>)</span><br><span class="line">        .<span class="title function_">autoPlay</span>(<span class="literal">true</span>)</span><br><span class="line">        .<span class="title function_">loop</span>(<span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Row</span>(&#123; <span class="attr">space</span>: <span class="number">12</span> &#125;) &#123;</span><br><span class="line">          <span class="title class_">Button</span>(<span class="string">&#x27;show next&#x27;</span>)</span><br><span class="line">            .<span class="title function_">onClick</span>(<span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">              <span class="comment">// this.data.pushData()</span></span><br><span class="line">              <span class="comment">// this.aboutToAppear();</span></span><br><span class="line">              <span class="comment">// this.list.push(await getHttpData());</span></span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">data</span>.<span class="title function_">pushData</span>(<span class="keyword">await</span> <span class="title function_">getHttpData</span>(<span class="variable language_">this</span>.<span class="property">keyword</span>, <span class="variable language_">this</span>.<span class="property">link</span>))</span><br><span class="line"></span><br><span class="line">              <span class="comment">//  this.logger.info(&quot;list  msg length: &quot; + this.list.length)</span></span><br><span class="line">               <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">info</span>(<span class="string">&quot;data  msg length: &quot;</span> + <span class="variable language_">this</span>.<span class="property">data</span>.<span class="title function_">totalCount</span>())</span><br><span class="line">              promptAction.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&quot;load result: &quot;</span> + <span class="variable language_">this</span>.<span class="property">data</span>.<span class="title function_">getData</span>(<span class="number">0</span>),</span><br><span class="line">                <span class="attr">duration</span>: <span class="number">2000</span></span><br><span class="line">              &#125;);</span><br><span class="line"></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;.<span class="title function_">margin</span>(<span class="number">5</span>)</span><br><span class="line">      &#125;.<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">      .<span class="title function_">margin</span>(&#123; <span class="attr">top</span>: <span class="number">5</span> &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">title</span>(<span class="string">&#x27;PixivImage&#x27;</span>)</span><br><span class="line">    .<span class="title function_">menus</span>(<span class="variable language_">this</span>.<span class="property">menuItems</span>)</span><br><span class="line">    .<span class="title function_">onBackPressed</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">pageStack</span>.<span class="title function_">pop</span>()</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">onReady</span>(<span class="function">(<span class="params"><span class="attr">context</span>: <span class="title class_">NavDestinationContext</span></span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">pageStack</span> = context.<span class="property">pathStack</span>;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">info</span>(<span class="string">&quot;current page config info is &quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(context.<span class="title function_">getConfigInRouteMap</span>()))</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="httpè¯·æ±‚å‘èµ·">httpè¯·æ±‚å‘èµ·</h4><blockquote><p>ä»¥ä¸‹æ–¹æ³•ä½¿ç”¨ç³»ç»Ÿ@kit.NetworkKitå‘èµ·http get è¯·æ±‚</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; http &#125; <span class="keyword">from</span> <span class="string">&quot;@kit.NetworkKit&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">JSON</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@kit.ArkTS&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getHttpData</span>(<span class="params"> <span class="attr">keyword</span>: <span class="built_in">string</span>, <span class="attr">link</span>: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> httpRequest = http.<span class="title function_">createHttp</span>();</span><br><span class="line">  <span class="keyword">if</span> (link) &#123;</span><br><span class="line">    <span class="variable constant_">BASE_URL</span> = link;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;BASE_URL &quot;</span> + <span class="variable constant_">BASE_URL</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> response = httpRequest.<span class="title function_">request</span>(</span><br><span class="line">    <span class="comment">// å¡«å†™HTTPè¯·æ±‚çš„URLåœ°å€ï¼Œå¯ä»¥å¸¦å‚æ•°ä¹Ÿå¯ä»¥ä¸å¸¦å‚æ•°ã€‚URLåœ°å€éœ€è¦å¼€å‘è€…è‡ªå®šä¹‰ã€‚è¯·æ±‚çš„å‚æ•°å¯ä»¥åœ¨extraDataä¸­æŒ‡å®š</span></span><br><span class="line">    <span class="variable constant_">BASE_URL</span> + <span class="string">&quot;direct&quot;</span> +<span class="string">&quot;&amp;keyword=&quot;</span> + keyword,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">method</span>: http.<span class="property">RequestMethod</span>.<span class="property">GET</span>, <span class="comment">// å¯é€‰ï¼Œé»˜è®¤ä¸ºhttp.RequestMethod.GET</span></span><br><span class="line">      <span class="comment">// å¼€å‘è€…æ ¹æ®è‡ªèº«ä¸šåŠ¡éœ€è¦æ·»åŠ headerå­—æ®µ</span></span><br><span class="line">      <span class="attr">header</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">expectDataType</span>: http.<span class="property">HttpDataType</span>.<span class="property">STRING</span>, <span class="comment">// å¯é€‰ï¼ŒæŒ‡å®šè¿”å›æ•°æ®çš„ç±»å‹</span></span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// ä½¿ç”¨awaitå’Œasyncï¼Œç­‰å¾…è¯·æ±‚å®Œæˆå¤„ç†æ•°æ®åè¿”å›</span></span><br><span class="line">  <span class="keyword">await</span> response.<span class="title function_">then</span>(<span class="function">(<span class="params"><span class="attr">data</span>: <span class="built_in">object</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (data[<span class="string">&quot;responseCode&quot;</span>] = <span class="number">200</span>) &#123;</span><br><span class="line">      <span class="comment">// å¤„ç†è¿”å›ç»“æœ</span></span><br><span class="line">      res = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data[<span class="string">&quot;header&quot;</span>][<span class="string">&quot;location&quot;</span>]);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;output image src: &quot;</span> + res);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// todo è¯·æ±‚å¤±è´¥ï¼Œè¿›è¡Œå¤±è´¥é€»è¾‘å¤„ç†</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params"><span class="attr">err</span>: <span class="built_in">object</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// todo è¯·æ±‚å¤±è´¥ï¼Œè¿›è¡Œå¤±è´¥é€»è¾‘å¤„ç†</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">&#x27;error:&#x27;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(err));</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> res.<span class="title function_">replace</span>(<span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;&#x27;</span>).<span class="title function_">replace</span>(<span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="logå¤„ç†">logå¤„ç†</h3><h4 id="logåˆå§‹åŒ–">logåˆå§‹åŒ–</h4><blockquote><p>åœ¨EntryAbilityä¸­onCreate()å‘¨æœŸå‡½æ•°ç¼–å†™ä»¥ä¸‹ä»£ç </p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onCreate</span>(<span class="attr">want</span>: <span class="title class_">Want</span>, <span class="attr">launchParam</span>: <span class="title class_">AbilityConstant</span>.<span class="property">LaunchParam</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  hilog.<span class="title function_">info</span>(<span class="number">0x0000</span>, <span class="string">&#x27;testTag&#x27;</span>, <span class="string">&#x27;%&#123;public&#125;s&#x27;</span>, <span class="string">&#x27;Ability onCreate&#x27;</span>);</span><br><span class="line">  <span class="title class_">LogManager</span>.<span class="title function_">setLogFilePath</span>(<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">filesDir</span>);</span><br><span class="line">  <span class="title class_">LogManager</span>.<span class="title function_">interceptConsole</span>(); <span class="comment">//å¼€å¯consoleæ‹¦æˆª</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="log-åŸºç¡€å®šä¹‰">log åŸºç¡€å®šä¹‰</h4><blockquote><p>ä»¥ä¸‹ä»£ç å®šä¹‰äº†logåŸºç¡€ä¿¡æ¯ï¼šæ–‡ä»¶åï¼Œå¤šçº¿ç¨‹æ—¥å¿—è®°å½•ï¼Œå•ä¸ªlogæœ€å¤§å¤§å°ï¼Œlogç¼“å­˜æ•°ç›®ï¼Œlogä¸ŠæŠ¥ä¿¡æ¯</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AbstractAppender</span>, <span class="title class_">FileAppender</span>, <span class="title class_">Level</span>, <span class="title class_">TCPSocketAppender</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@pie/log4a&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; systemDateTime &#125; <span class="keyword">from</span> <span class="string">&quot;@kit.BasicServicesKit&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getSysTime, getTimeToYYYYDDMMHHMMSS &#125; <span class="keyword">from</span> <span class="string">&quot;../utils/time&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">socketAppender</span>: <span class="title class_">AbstractAppender</span> = <span class="keyword">new</span> <span class="title class_">TCPSocketAppender</span>(&#123;</span><br><span class="line">  <span class="attr">address</span>: <span class="string">&#x27;114.xxx.xxx.xxx&#x27;</span>,</span><br><span class="line">  <span class="attr">port</span>: <span class="number">1234</span>,</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;socket&#x27;</span>,</span><br><span class="line">  <span class="attr">level</span>: <span class="title class_">Level</span>.<span class="property">ALL</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">fileAppender_a</span>: <span class="title class_">AbstractAppender</span> =</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">FileAppender</span>(<span class="string">&#x27;OHOS_PIXIV_log_&#x27;</span> + <span class="title function_">getSysTime</span>()+ <span class="string">&#x27;.log&#x27;</span>, <span class="string">&#x27;main&#x27;</span>,</span><br><span class="line">    <span class="title class_">Level</span>.<span class="property">ALL</span>, &#123;</span><br><span class="line">      <span class="attr">useWorker</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">maxFileSize</span>: <span class="number">1024</span> * <span class="number">20</span>, <span class="comment">//kb å­˜å‚¨å•ä¸ªæ–‡ä»¶å¤§å° è¶…è¿‡ä¼šå­˜å…¥ç¼“å­˜</span></span><br><span class="line">      <span class="attr">maxCacheCount</span>: <span class="number">10</span> <span class="comment">//æ—¥å¿—æ–‡ä»¶ç¼“å­˜æ•°é‡</span></span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br></pre></td></tr></table></figure><h4 id="log-ä½¿ç”¨">log ä½¿ç”¨</h4><blockquote><p>åœ¨pageé¡µé¢ä½¿ç”¨å¦‚ä¸‹</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@State</span> <span class="attr">logger</span>: <span class="title class_">Logger</span> = <span class="title class_">LogManager</span>.<span class="title function_">getLogger</span>(<span class="variable language_">this</span>)</span><br><span class="line">    .<span class="title function_">bindAppender</span>(fileAppender_a)</span><br><span class="line">  <span class="comment">// .bindAppender(socketAppender); //æ—¥å¿—ä¸ŠæŠ¥append</span></span><br><span class="line"><span class="comment">// æ‰“å°log</span></span><br><span class="line"> <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">info</span>(<span class="string">&#x27;Radio1 status is &#x27;</span> + isChecked)</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>log è¾“å‡ºç¤ºä¾‹</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10-25 21:41:55.491   2317-2317     A03d00/JSAPP                    com.examp...lication  I     [INFO ]2024-10-25 21:41:55,488[PixivImage:2]current page config info is &#123;&quot;name&quot;:&quot;PixivImage&quot;,&quot;pageSourceFile&quot;:&quot;src/main/ets/pages/PixivImage.ets&quot;,&quot;data&quot;:&#123;&quot;description&quot;:&quot;this is PixivImage&quot;&#125;&#125;</span><br></pre></td></tr></table></figure><h3 id="æ•°æ®å­˜å‚¨">æ•°æ®å­˜å‚¨</h3><ul><li>å·¥å…·ç±»å®šä¹‰</li></ul><blockquote><p>ä½¿ç”¨PreferencesManagerä¿å­˜è¯»å–æ•°æ®ï¼Œç¤ºä¾‹å¦‚ä¸‹</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯¼å…¥åŒ…</span></span><br><span class="line"><span class="keyword">import</span> dataPreferences <span class="keyword">from</span> <span class="string">&#x27;@ohos.data.preferences&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–context</span></span><br><span class="line"><span class="keyword">let</span> context = <span class="title function_">getContext</span>(<span class="variable language_">this</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">PreferencesManager</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> shared = <span class="keyword">new</span> <span class="title class_">PreferencesManager</span>();</span><br><span class="line">  preferences?: dataPreferences.<span class="property">Preferences</span>;</span><br><span class="line">  <span class="attr">preferencesName</span>: <span class="built_in">string</span> = <span class="string">&#x27;CommonPreferences&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–preferenceså®ä¾‹</span></span><br><span class="line">  <span class="title function_">initPreferences</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">preferences</span> = dataPreferences.<span class="title function_">getPreferencesSync</span>(context, &#123; <span class="attr">name</span>: <span class="variable language_">this</span>.<span class="property">preferencesName</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®æ•°æ®</span></span><br><span class="line">  <span class="title function_">set</span>(<span class="params"><span class="attr">key</span>: <span class="built_in">string</span>, <span class="attr">value</span>: dataPreferences.<span class="title class_">ValueType</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">preferences</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">initPreferences</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">preferences</span>?.<span class="title function_">putSync</span>(key, value);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">preferences</span>?.<span class="title function_">flush</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–æ•°æ®</span></span><br><span class="line">  <span class="title function_">get</span>(<span class="attr">key</span>: <span class="built_in">string</span>): dataPreferences.<span class="property">ValueType</span> | <span class="literal">null</span> | <span class="literal">undefined</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">preferences</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">initPreferences</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> value = <span class="variable language_">this</span>.<span class="property">preferences</span>?.<span class="title function_">getSync</span>(key, <span class="literal">null</span>);;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ é™¤æ•°æ®</span></span><br><span class="line">  <span class="title function_">delete</span>(<span class="params"><span class="attr">key</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">preferences</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">initPreferences</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">preferences</span>?.<span class="title function_">hasSync</span>(key)) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">preferences</span>.<span class="title function_">deleteSync</span>(key);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">preferences</span>.<span class="title function_">flush</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>å·¥å…·ç±»ä½¿ç”¨</li></ul><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å†™å…¥æ•°æ®</span></span><br><span class="line">      <span class="title class_">PreferencesManager</span>.<span class="property">shared</span>.<span class="title function_">set</span>(<span class="string">&quot;keyword&quot;</span>, <span class="variable language_">this</span>.<span class="property">tmp</span>.<span class="property">keyword</span>)</span><br><span class="line">    <span class="comment">//   è¯»å–æ•°æ®</span></span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">keyword</span> = <span class="title class_">PreferencesManager</span>.<span class="property">shared</span>.<span class="title function_">get</span>(<span class="string">&quot;keyword&quot;</span>)?.<span class="title function_">toString</span>() || <span class="string">&quot;klee&quot;</span>;</span><br></pre></td></tr></table></figure><h3 id="è½®æ’­å›¾æ•°æ®å¤„ç†">è½®æ’­å›¾æ•°æ®å¤„ç†</h3><blockquote><p>åŸºç¡€æ•°æ®ç±»çš„å®šä¹‰</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Basic implementation of IDataSource to handle data listener</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">BasicDataSource</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">IDataSource</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">listeners</span>: <span class="title class_">DataChangeListener</span>[] = [];</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">originDataArray</span>: T[] = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">totalCount</span>(): <span class="built_in">number</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">getData</span>(<span class="attr">index</span>: <span class="built_in">number</span>): T &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">originDataArray</span>[index];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¯¥æ–¹æ³•ä¸ºæ¡†æ¶ä¾§è°ƒç”¨ï¼Œä¸ºLazyForEachç»„ä»¶å‘å…¶æ•°æ®æºå¤„æ·»åŠ listenerç›‘å¬</span></span><br><span class="line">  <span class="title function_">registerDataChangeListener</span>(<span class="attr">listener</span>: <span class="title class_">DataChangeListener</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">indexOf</span>(listener) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">&#x27;add listener&#x27;</span>);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">push</span>(listener);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¯¥æ–¹æ³•ä¸ºæ¡†æ¶ä¾§è°ƒç”¨ï¼Œä¸ºå¯¹åº”çš„LazyForEachç»„ä»¶åœ¨æ•°æ®æºå¤„å»é™¤listenerç›‘å¬</span></span><br><span class="line">  <span class="title function_">unregisterDataChangeListener</span>(<span class="attr">listener</span>: <span class="title class_">DataChangeListener</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> pos = <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">indexOf</span>(listener);</span><br><span class="line">    <span class="keyword">if</span> (pos &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">&#x27;remove listener&#x27;</span>);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">splice</span>(pos, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é€šçŸ¥LazyForEachç»„ä»¶éœ€è¦é‡è½½æ‰€æœ‰å­ç»„ä»¶</span></span><br><span class="line">  <span class="title function_">notifyDataReload</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">listener</span> =&gt;</span> &#123;</span><br><span class="line">      listener.<span class="title function_">onDataReloaded</span>();</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é€šçŸ¥LazyForEachç»„ä»¶éœ€è¦åœ¨indexå¯¹åº”ç´¢å¼•å¤„æ·»åŠ å­ç»„ä»¶</span></span><br><span class="line">  <span class="title function_">notifyDataAdd</span>(<span class="attr">index</span>: <span class="built_in">number</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">listener</span> =&gt;</span> &#123;</span><br><span class="line">      listener.<span class="title function_">onDataAdd</span>(index);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é€šçŸ¥LazyForEachç»„ä»¶åœ¨indexå¯¹åº”ç´¢å¼•å¤„æ•°æ®æœ‰å˜åŒ–ï¼Œéœ€è¦é‡å»ºè¯¥å­ç»„ä»¶</span></span><br><span class="line">  <span class="title function_">notifyDataChange</span>(<span class="attr">index</span>: <span class="built_in">number</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">listener</span> =&gt;</span> &#123;</span><br><span class="line">      listener.<span class="title function_">onDataChange</span>(index);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é€šçŸ¥LazyForEachç»„ä»¶éœ€è¦åœ¨indexå¯¹åº”ç´¢å¼•å¤„åˆ é™¤è¯¥å­ç»„ä»¶</span></span><br><span class="line">  <span class="title function_">notifyDataDelete</span>(<span class="attr">index</span>: <span class="built_in">number</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">listener</span> =&gt;</span> &#123;</span><br><span class="line">      listener.<span class="title function_">onDataDelete</span>(index);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é€šçŸ¥LazyForEachç»„ä»¶å°†fromç´¢å¼•å’Œtoç´¢å¼•å¤„çš„å­ç»„ä»¶è¿›è¡Œäº¤æ¢</span></span><br><span class="line">  <span class="title function_">notifyDataMove</span>(<span class="attr">from</span>: <span class="built_in">number</span>, <span class="attr">to</span>: <span class="built_in">number</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">listener</span> =&gt;</span> &#123;</span><br><span class="line">      listener.<span class="title function_">onDataMove</span>(<span class="keyword">from</span>, to);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>æ•°æ®æ¨¡å‹ç±»</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">BasicDataSource</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./BasicDataSource&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ListDataSource</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">BasicDataSource</span>&lt;T&gt; &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">dataArray</span>: T[] = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">totalCount</span>(): <span class="built_in">number</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">dataArray</span>.<span class="property">length</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">getData</span>(<span class="attr">index</span>: <span class="built_in">number</span>): T &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">dataArray</span>[index];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">addData</span>(<span class="attr">index</span>: <span class="built_in">number</span>, <span class="attr">data</span>: T): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dataArray</span>.<span class="title function_">splice</span>(index, <span class="number">0</span>, data);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">notifyDataAdd</span>(index);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">pushData</span>(<span class="attr">data</span>: T): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dataArray</span>.<span class="title function_">push</span>(data);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">notifyDataAdd</span>(<span class="variable language_">this</span>.<span class="property">dataArray</span>.<span class="property">length</span> - <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>é€šè¿‡ä»¥ä¸‹æ–¹æ³•ä½¿ç”¨</p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ•°æ®åˆå§‹åŒ–</span></span><br><span class="line">  <span class="meta">@State</span> <span class="attr">data</span>: <span class="title class_">ListDataSource</span>&lt;<span class="built_in">string</span>&gt; = <span class="keyword">new</span> <span class="title class_">ListDataSource</span>&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line"><span class="comment">//  æ•°æ®å­˜å‚¨</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">data</span>.<span class="title function_">pushData</span>(<span class="keyword">await</span> <span class="title function_">getHttpData</span>(<span class="variable language_">this</span>.<span class="property">keyword</span>, <span class="variable language_">this</span>.<span class="property">link</span>))</span><br><span class="line"><span class="comment">//  æ•°æ®è·å–</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">data</span>.<span class="title function_">getData</span>(index)</span><br></pre></td></tr></table></figure><h3 id="å…¶ä»–">å…¶ä»–</h3><h4 id="toast">toast</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">promptAction.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">           <span class="attr">message</span>: <span class="string">&quot;load result: &quot;</span> + <span class="variable language_">this</span>.<span class="property">data</span>.<span class="title function_">getData</span>(<span class="number">0</span>),</span><br><span class="line">           <span class="attr">duration</span>: <span class="number">2000</span></span><br><span class="line">         &#125;);</span><br></pre></td></tr></table></figure><h4 id="é¡µé¢è·³è½¬">é¡µé¢è·³è½¬</h4><blockquote><p>é…ç½®é—®ä»·module.json5æ›´æ”¹</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;module&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;entry&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;entry&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$string:module_desc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mainElement&quot;</span><span class="punctuation">:</span> <span class="string">&quot;EntryAbility&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;routerMap&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$profile:route_map&quot;</span><span class="punctuation">,</span><span class="comment">//è·¯ç”±æ›´æ”¹</span></span><br><span class="line">    <span class="attr">&quot;deviceTypes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;phone&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;tablet&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;2in1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;car&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;requestPermissions&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ohos.permission.INTERNET&quot;</span><span class="punctuation">,</span><span class="comment">//ç½‘ç»œæƒé™ç”³è¯·</span></span><br><span class="line">        <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$string:permission_reason&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;usedScene&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;abilities&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;FormAbility&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;when&quot;</span><span class="punctuation">:</span><span class="string">&quot;inuse&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;deliveryWithInstall&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;installationFree&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;pages&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$profile:main_pages&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;abilities&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;EntryAbility&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;srcEntry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./ets/entryability/EntryAbility.ets&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$string:EntryAbility_desc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;icon&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$media:layered_image&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$string:EntryAbility_label&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;startWindowIcon&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$media:startIcon&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;startWindowBackground&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$color:start_window_background&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;exported&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;skills&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;entities&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="string">&quot;entity.system.home&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="string">&quot;action.system.home&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;extensionAbilities&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;EntryBackupAbility&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;srcEntry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./ets/entrybackupability/EntryBackupAbility.ets&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;backup&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;exported&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ohos.extension.backup&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$profile:backup_config&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>åœ¨entry/src/main/resources/base/profileå¤„æ–°å»ºroute_map.jsonå¹¶å†™å…¥ä»¥ä¸‹ä»£ç </p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;routerMap&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Index&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pageSourceFile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;src/main/ets/pages/Index.ets&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;buildFunction&quot;</span><span class="punctuation">:</span> <span class="string">&quot;IndexBuilder&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;this is Index&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;PixivImage&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pageSourceFile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;src/main/ets/pages/PixivImage.ets&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;buildFunction&quot;</span><span class="punctuation">:</span> <span class="string">&quot;PixivImageBuilder&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;this is PixivImage&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SaveImagge&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pageSourceFile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;src/main/ets/pages/SaveImagge.ets&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;buildFunction&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SaveAlbumBuilder&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;this is Save Image page&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>è·³è½¬ä»£ç </p></blockquote><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">pageInfos</span>.<span class="title function_">pushPathByName</span>(<span class="string">&#x27;PixivImage&#x27;</span>, <span class="string">&quot;this.tmp&quot;</span>)</span><br></pre></td></tr></table></figure><h2 id="æµ‹è¯•æ•ˆæœ">æµ‹è¯•æ•ˆæœ</h2><blockquote><p>å®‰è£…åæ•ˆæœå¦‚ä¸‹ï¼š</p></blockquote><p><img src="/2024/10/25/ohos-pixiv-image/emluator.png" class="lazyload placeholder" data-srcset="/2024/10/25/ohos-pixiv-image/emluator.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><blockquote><p>logç”Ÿæˆè·¯å¾„å¦‚ä¸‹ï¼š</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/app/el2/100/base/com.example.myapplication/haps/entry/files</span><br></pre></td></tr></table></figure><p><img src="/2024/10/25/ohos-pixiv-image/log.png" class="lazyload placeholder" data-srcset="/2024/10/25/ohos-pixiv-image/log.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="See">See</h2><h3 id="demo-åœ°å€">demo åœ°å€</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://gitee.com/caozhaoqi/ohos_-pixiv_-image</span><br></pre></td></tr></table></figure><h3 id="å‚è€ƒç½‘å€">å‚è€ƒç½‘å€</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5</span><br></pre></td></tr></table></figure><h3 id="blog">blog</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://caozhaoqi.github.io/</span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> harmonyos </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pyqt5ä¿¡å·æ§½æœºåˆ¶åº”ç”¨</title>
      <link href="/2024/08/21/pyqt5-singal-thread/"/>
      <url>/2024/08/21/pyqt5-singal-thread/</url>
      
        <content type="html"><![CDATA[<h1>pyqt5ä¿¡å·æ§½æœºåˆ¶åº”ç”¨</h1><h2 id="ç®€ä»‹">ç®€ä»‹</h2><blockquote><p>PyQt5ä¸­çš„ä¿¡å·å’Œæ§½æ˜¯ç”¨äºå¯¹è±¡ä¹‹é—´çš„äº‹ä»¶å¤„ç†å’Œé€šä¿¡çš„ä¸€ç§æœºåˆ¶ã€‚ä¿¡å·åœ¨æŸä¸ªç‰¹å®šäº‹ä»¶å‘ç”Ÿæ—¶å‘å‡ºï¼Œæ§½æ˜¯ç”¨æ¥å“åº”è¿™äº›ä¿¡å·çš„å‡½æ•°ã€‚ä¿¡å·(Signal)ä¸æ§½(Slot)æ˜¯Qtä¸­çš„æ ¸å¿ƒæœºåˆ¶ï¼Œä¹Ÿæ˜¯åœ¨PyQtç¼–ç¨‹ä¸­å¯¹è±¡ä¹‹é—´è¿›è¡Œé€šä¿¡çš„æœºåˆ¶; åœ¨Qtä¸­ï¼Œæ¯ä¸€ä¸ªQObjectå¯¹è±¡å’ŒPyQtä¸­æ‰€æœ‰ç»§æ‰¿è‡ªQWidgetçš„æ§ä»¶ï¼ˆè¿™äº›éƒ½æ˜¯QObjectçš„å­å¯¹è±¡ï¼‰éƒ½æ”¯æŒä¿¡å·ä¸æ§½æœºåˆ¶ã€‚å½“ä¿¡å·å‘å°„æ—¶ï¼Œè¿æ¥çš„æ§½å‡½æ•°å°†ä¼šè‡ªåŠ¨æ‰§è¡Œã€‚åœ¨PyQt 5ä¸­ä¿¡å·ä¸æ§½é€šè¿‡object.signal.connect()æ–¹æ³•è¿æ¥ã€‚</p></blockquote><ul><li>ç±»å›¾</li></ul><p><img src="/2024/08/21/pyqt5-singal-thread/pyqt5-signal.png" class="lazyload placeholder" data-srcset="/2024/08/21/pyqt5-singal-thread/pyqt5-signal.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h3 id="ç®€æ˜“è¯´æ˜demo">ç®€æ˜“è¯´æ˜demo</h3><blockquote><p>é€šè¿‡æŒ‰é’®è§¦å‘äº‹ä»¶ï¼ŒæŒ‰é’®è¿æ¥æ§½å‡½æ•°ï¼Œå½“æŒ‰é’®ç‚¹å‡»æ—¶è§¦å‘äº‹ä»¶ï¼Œäº‹ä»¶å‘é€ä¿¡å·ï¼›æ§½å‡½æ•°æ”¶åˆ°ä¿¡å·æ—¶è¾“å‡ºä¿¡æ¯ã€‚</p></blockquote><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> QApplication, QPushButton</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> QObject, pyqtSlot</span><br><span class="line"> </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyButton</span>(<span class="title class_ inherited__">QPushButton</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, text</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(text)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">mouseReleaseEvent</span>(<span class="params">self, event</span>):</span><br><span class="line">        <span class="variable language_">self</span>.clicked.emit()  <span class="comment"># å‘å°„ä¿¡å·</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyWindow</span>(<span class="title class_ inherited__">QObject</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="variable language_">self</span>.button = MyButton(<span class="string">&quot;Click Me&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.button.clicked.connect(<span class="variable language_">self</span>.on_button_clicked)  <span class="comment"># è¿æ¥ä¿¡å·æ§½</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">    @pyqtSlot()</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_button_clicked</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Button clicked!&quot;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    app = QApplication(sys.argv)</span><br><span class="line">    window = MyWindow()</span><br><span class="line">    window.button.show()</span><br><span class="line">    sys.exit(app.exec_())</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><h3 id="ä¿¡å·ä¸æ§½çš„ç‰¹ç‚¹">ä¿¡å·ä¸æ§½çš„ç‰¹ç‚¹</h3><ul><li>ä¸€ä¸ªä¿¡å·å¯ä»¥è¿æ¥å¤šä¸ªæ§½ã€‚</li><li>ä¸€ä¸ªä¿¡å·å¯ä»¥è¿æ¥å¦ä¸€ä¸ªä¿¡å·ã€‚</li><li>ä¿¡å·å‚æ•°å¯ä»¥ä½¿ä»»ä½•Pythonç±»å‹ã€‚</li><li>ä¸€ä¸ªæ§½å¯ä»¥è¿æ¥åˆ°å¤šä¸ªä¿¡å·ã€‚</li><li>ä¿¡å·ä¸æ§½çš„è¿æ¥æ–¹å¼å¯ä»¥æ˜¯åŒæ­¥è¿æ¥ï¼Œä¹Ÿå¯ä»¥æ˜¯å¼‚æ­¥è¿æ¥ã€‚</li><li>ä¿¡å·ä¸æ§½çš„è¿æ¥å¯èƒ½ä¼šè·¨çº¿ç¨‹ã€‚</li><li>ä¿¡å·å¯ä»¥æ–­å¼€è¿æ¥ã€‚</li></ul><h2 id="æœºåˆ¶ä½¿ç”¨">æœºåˆ¶ä½¿ç”¨</h2><h3 id="è‡ªå®šä¹‰ä¿¡å·ä¸æ§½">è‡ªå®šä¹‰ä¿¡å·ä¸æ§½</h3><ul><li>è‡ªå®šä¹‰ä¿¡å·</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyWidget</span>(<span class="title class_ inherited__">QWidget</span>): </span><br><span class="line">  <span class="comment"># æ— å‚æ•°çš„ä¿¡å·</span></span><br><span class="line">  Signal_NoParameters = pyqtSignal()   </span><br><span class="line">  <span class="comment"># å¸¦ä¸€ä¸ªå‚æ•°(æ•´æ•°)çš„ä¿¡å·   </span></span><br><span class="line">  Signal_OneParameter = pyqtSignal(<span class="built_in">int</span>)     </span><br><span class="line">  <span class="comment"># å¸¦ä¸€ä¸ªå‚æ•°(æ•´æ•°æˆ–è€…å­—ç¬¦ä¸²)çš„é‡è½½ç‰ˆæœ¬çš„ä¿¡å·    </span></span><br><span class="line">  Signal_OneParameter_Overload = pyqtSignal([<span class="built_in">int</span>],[<span class="built_in">str</span>]) </span><br><span class="line">  <span class="comment"># å¸¦ä¸¤ä¸ªå‚æ•°(æ•´æ•°,å­—ç¬¦ä¸²)çš„ä¿¡å·   </span></span><br><span class="line">  Signal_TwoParameters = pyqtSignal(<span class="built_in">int</span>,<span class="built_in">str</span>)  </span><br><span class="line">  <span class="comment"># å¸¦ä¸¤ä¸ªå‚æ•°([æ•´æ•°,æ•´æ•°]æˆ–è€…[æ•´æ•°,å­—ç¬¦ä¸²])çš„é‡è½½ç‰ˆæœ¬çš„ä¿¡å·   </span></span><br><span class="line">  Signal_TwoParameters_Overload = pyqtSignal([<span class="built_in">int</span>,<span class="built_in">int</span>],[<span class="built_in">int</span>,<span class="built_in">str</span>]) </span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>è‡ªå®šä¹‰æ§½å‡½æ•°</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyWidget</span>(<span class="title class_ inherited__">QWidget</span>): </span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">setValue_NoParameters</span>(<span class="params">self</span>):  </span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;æ— å‚æ•°çš„æ§½å‡½æ•°&#x27;&#x27;&#x27;</span> </span><br><span class="line">    <span class="keyword">pass</span> </span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">setValue_OneParameter</span>(<span class="params">self,nIndex</span>):  </span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;å¸¦ä¸€ä¸ªå‚æ•°(æ•´æ•°)çš„æ§½å‡½æ•°&#x27;&#x27;&#x27;</span> </span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setValue_OneParameter_String</span>(<span class="params">self,szIndex</span>):  </span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;å¸¦ä¸€ä¸ªå‚æ•°(å­—ç¬¦ä¸²)çš„æ§½å‡½æ•°&#x27;&#x27;&#x27;</span> </span><br><span class="line">    <span class="keyword">pass</span> </span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">setValue_TwoParameters</span>(<span class="params">self,x,y</span>):  </span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;å¸¦ä¸¤ä¸ªå‚æ•°(æ•´æ•°,æ•´æ•°)çš„æ§½å‡½æ•°&#x27;&#x27;&#x27;</span> </span><br><span class="line">    <span class="keyword">pass</span> </span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">setValue_TwoParameters_String</span>(<span class="params">self,x,szY</span>):  </span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;å¸¦ä¸¤ä¸ªå‚æ•°(æ•´æ•°,å­—ç¬¦ä¸²)æ§½å‡½æ•°&#x27;&#x27;&#x27;</span> </span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><ul><li>ä¿¡å·æ§½ä¸æ§½å‡½æ•°è¿æ¥</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">app = QApplication(sys.argv)  </span><br><span class="line">widget = MyWidget()  </span><br><span class="line"><span class="comment"># è¿æ¥æ— å‚æ•°çš„ä¿¡å·</span></span><br><span class="line">widget.Signal_NoParameters.connect(<span class="variable language_">self</span>.setValue_NoParameters )                     </span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿æ¥å¸¦ä¸€ä¸ªæ•´æ•°å‚æ•°çš„ä¿¡å·</span></span><br><span class="line">widget.Signal_OneParameter.connect(<span class="variable language_">self</span>.setValue_OneParameter)                     </span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿æ¥å¸¦ä¸€ä¸ªæ•´æ•°å‚æ•°ï¼Œç»è¿‡é‡è½½çš„ä¿¡å·</span></span><br><span class="line">widget.Signal_OneParameter_Overload[<span class="built_in">int</span>].</span><br><span class="line">  connect(<span class="variable language_">self</span>.setValue_OneParameter)               </span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿æ¥å¸¦ä¸€ä¸ªæ•´æ•°å‚æ•°ï¼Œç»è¿‡é‡è½½çš„ä¿¡å·</span></span><br><span class="line">widget.Signal_OneParameter_Overload[<span class="built_in">str</span>].</span><br><span class="line">  connect(<span class="variable language_">self</span>.setValue_OneParameter_String )           </span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿æ¥ä¸€ä¸ªä¿¡å·ï¼Œå®ƒæœ‰ä¸¤ä¸ªæ•´æ•°å‚æ•°</span></span><br><span class="line">widget.Signal_TwoParameters.connect(<span class="variable language_">self</span>.setValue_TwoParameters )                    </span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿æ¥å¸¦ä¸¤ä¸ªå‚æ•°(æ•´æ•°,æ•´æ•°)çš„é‡è½½ç‰ˆæœ¬çš„ä¿¡å·</span></span><br><span class="line">widget.Signal_TwoParameters_Overload[<span class="built_in">int</span>,<span class="built_in">int</span>].</span><br><span class="line">  connect(<span class="variable language_">self</span>.setValue_TwoParameters )           </span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿æ¥å¸¦ä¸¤ä¸ªå‚æ•°(æ•´æ•°,å­—ç¬¦ä¸²)çš„é‡è½½ç‰ˆæœ¬çš„ä¿¡å·</span></span><br><span class="line">widget.Signal_TwoParameters_Overload[<span class="built_in">int</span>,<span class="built_in">str</span>].</span><br><span class="line">  connect(<span class="variable language_">self</span>.setValue_TwoParameters_String )       </span><br><span class="line">widget.show() </span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>ä¿¡å·å‘é€</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyWidget</span>(<span class="title class_ inherited__">QWidget</span>): </span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">mousePressEvent</span>(<span class="params">self, event</span>): </span><br><span class="line">    <span class="comment"># å‘å°„æ— å‚æ•°çš„ä¿¡å·</span></span><br><span class="line">    <span class="variable language_">self</span>.Signal_NoParameters.emit() </span><br><span class="line">    <span class="comment"># å‘å°„å¸¦ä¸€ä¸ªå‚æ•°(æ•´æ•°)çš„ä¿¡å·</span></span><br><span class="line">    <span class="variable language_">self</span>.Signal_OneParameter.emit(<span class="number">1</span>) </span><br><span class="line">    <span class="comment"># å‘å°„å¸¦ä¸€ä¸ªå‚æ•°(æ•´æ•°)çš„é‡è½½ç‰ˆæœ¬çš„ä¿¡å·</span></span><br><span class="line">    <span class="variable language_">self</span>.Signal_OneParameter_Overload.emit(<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># å‘å°„å¸¦ä¸€ä¸ªå‚æ•°(å­—ç¬¦ä¸²)çš„é‡è½½ç‰ˆæœ¬çš„ä¿¡å·</span></span><br><span class="line">    <span class="variable language_">self</span>.Signal_OneParameter_Overload.emit(<span class="string">&quot;abc&quot;</span>)</span><br><span class="line">    <span class="comment"># å‘å°„å¸¦ä¸¤ä¸ªå‚æ•°(æ•´æ•°,å­—ç¬¦ä¸²)çš„ä¿¡å·</span></span><br><span class="line">    <span class="variable language_">self</span>.Signal_TwoParameters.emit(<span class="number">1</span>,<span class="string">&quot;abc&quot;</span>)</span><br><span class="line">    <span class="comment"># å‘å°„å¸¦ä¸¤ä¸ªå‚æ•°(æ•´æ•°,æ•´æ•°)çš„é‡è½½ç‰ˆæœ¬çš„ä¿¡å·</span></span><br><span class="line">    <span class="variable language_">self</span>.Signal_TwoParameters_Overload.emit(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line">    <span class="comment"># å‘å°„å¸¦ä¸¤ä¸ªå‚æ•°(æ•´æ•°,å­—ç¬¦ä¸²)çš„é‡è½½ç‰ˆæœ¬çš„ä¿¡å·</span></span><br><span class="line">    <span class="variable language_">self</span>.Signal_TwoParameters_Overload.emit (<span class="number">1</span>,<span class="string">&quot;abc&quot;</span>) </span><br></pre></td></tr></table></figure><ul><li>all code</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> QObject , pyqtSignal</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustSignal</span>(<span class="title class_ inherited__">QObject</span>):</span><br><span class="line"></span><br><span class="line">  <span class="comment">#å£°æ˜æ— å‚æ•°çš„ä¿¡å·</span></span><br><span class="line">  signal1 = pyqtSignal()</span><br><span class="line"></span><br><span class="line">  <span class="comment">#å£°æ˜å¸¦ä¸€ä¸ªintç±»å‹å‚æ•°çš„ä¿¡å·</span></span><br><span class="line">  signal2 = pyqtSignal(<span class="built_in">int</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">#å£°æ˜å¸¦intå’Œstrç±»å‹å‚æ•°çš„ä¿¡å·</span></span><br><span class="line">  signal3 = pyqtSignal(<span class="built_in">int</span>,<span class="built_in">str</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">#å£°æ˜å¸¦ä¸€ä¸ªåˆ—è¡¨ç±»å‹å‚æ•°çš„ä¿¡å·</span></span><br><span class="line">  signal4 = pyqtSignal(<span class="built_in">list</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">#å£°æ˜å¸¦ä¸€ä¸ªå­—å…¸ç±»å‹å‚æ•°çš„ä¿¡å·</span></span><br><span class="line">  signal5 = pyqtSignal(<span class="built_in">dict</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">#å£°æ˜ä¸€ä¸ªå¤šé‡è½½ç‰ˆæœ¬çš„ä¿¡å·ï¼ŒåŒ…æ‹¬å¸¦intå’Œstrç±»å‹å‚æ•°çš„ä¿¡å·å’Œå¸¦strç±»å‹å‚æ•°çš„ä¿¡å·</span></span><br><span class="line">  signal6 = pyqtSignal([<span class="built_in">int</span>,<span class="built_in">str</span>], [<span class="built_in">str</span>])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,parent=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="built_in">super</span>(CustSignal,<span class="variable language_">self</span>).__init__(parent)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#å°†ä¿¡å·è¿æ¥åˆ°æŒ‡å®šæ§½å‡½æ•°</span></span><br><span class="line">    <span class="variable language_">self</span>.signal1.connect(<span class="variable language_">self</span>.signalCall1)</span><br><span class="line">    <span class="variable language_">self</span>.signal2.connect(<span class="variable language_">self</span>.signalCall2)</span><br><span class="line">    <span class="variable language_">self</span>.signal3.connect(<span class="variable language_">self</span>.signalCall3)</span><br><span class="line">    <span class="variable language_">self</span>.signal4.connect(<span class="variable language_">self</span>.signalCall4)</span><br><span class="line">    <span class="variable language_">self</span>.signal5.connect(<span class="variable language_">self</span>.signalCall5)</span><br><span class="line">    <span class="variable language_">self</span>.signal6[<span class="built_in">int</span>,<span class="built_in">str</span>].connect(<span class="variable language_">self</span>.signalCall6)</span><br><span class="line">    <span class="variable language_">self</span>.signal6[<span class="built_in">str</span>].connect(<span class="variable language_">self</span>.signalCall6OverLoad)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#å‘å°„ä¿¡å·</span></span><br><span class="line">    <span class="variable language_">self</span>.signal1.emit()</span><br><span class="line">    <span class="variable language_">self</span>.signal2.emit(<span class="number">1</span>)</span><br><span class="line">    <span class="variable language_">self</span>.signal3.emit(<span class="number">1</span>,<span class="string">&quot;text&quot;</span>)</span><br><span class="line">    <span class="variable language_">self</span>.signal4.emit([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>])</span><br><span class="line">    <span class="variable language_">self</span>.signal5.emit(&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;wangwu&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="string">&quot;25&quot;</span>&#125;)</span><br><span class="line">    <span class="variable language_">self</span>.signal6[<span class="built_in">int</span>,<span class="built_in">str</span>].emit(<span class="number">1</span>,<span class="string">&quot;text&quot;</span>)</span><br><span class="line">    <span class="variable language_">self</span>.signal6[<span class="built_in">str</span>].emit(<span class="string">&quot;text&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">signalCall1</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;signal1 emit&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">signalCall2</span>(<span class="params">self,val</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;signal2 emit,value:&quot;</span>,val)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">signalCall3</span>(<span class="params">self,val,text</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;signal3 emit,value:&quot;</span>,val,text)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">signalCall4</span>(<span class="params">self,val</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;signal4 emit,value:&quot;</span>,val)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">signalCall5</span>(<span class="params">self,val</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;signal5 emit,value:&quot;</span>,val)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">signalCall6</span>(<span class="params">self,val,text</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;signal6 emit,value:&quot;</span>,val,text)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">signalCall6OverLoad</span>(<span class="params">self,val</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;signal6 overload emit,value:&quot;</span>,val)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>: </span><br><span class="line">  custSignal = CustSignal()</span><br></pre></td></tr></table></figure><ul><li>ä¿¡å·ä¸æ§½ä¼ é€’è‡ªå®šä¹‰å‚æ•°</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> QMainWindow, QPushButton , QWidget , QMessageBox, QApplication, QHBoxLayout</span><br><span class="line"><span class="keyword">import</span> sys </span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WinForm</span>(<span class="title class_ inherited__">QMainWindow</span>): </span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, parent=<span class="literal">None</span></span>): </span><br><span class="line">    <span class="built_in">super</span>(WinForm, <span class="variable language_">self</span>).__init__(parent) </span><br><span class="line">    button1 = QPushButton(<span class="string">&#x27;Button 1&#x27;</span>) </span><br><span class="line">    button2 = QPushButton(<span class="string">&#x27;Button 2&#x27;</span>) </span><br><span class="line"></span><br><span class="line">    button1.clicked.connect(<span class="keyword">lambda</span>: <span class="variable language_">self</span>.onButtonClick(<span class="number">1</span>)) </span><br><span class="line">    button2.clicked.connect(<span class="keyword">lambda</span>: <span class="variable language_">self</span>.onButtonClick(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">    layout = QHBoxLayout() </span><br><span class="line">    layout.addWidget(button1) </span><br><span class="line">    layout.addWidget(button2) </span><br><span class="line"></span><br><span class="line">    main_frame = QWidget() </span><br><span class="line">    main_frame.setLayout(layout)    </span><br><span class="line">    <span class="variable language_">self</span>.setCentralWidget(main_frame) </span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">onButtonClick</span>(<span class="params">self, n</span>): </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Button &#123;0&#125; è¢«æŒ‰ä¸‹äº†&#x27;</span>.<span class="built_in">format</span>(n)) </span><br><span class="line">    QMessageBox.information(<span class="variable language_">self</span>, <span class="string">&quot;ä¿¡æ¯æç¤ºæ¡†&quot;</span>, <span class="string">&#x27;Button &#123;0&#125; clicked&#x27;</span>.<span class="built_in">format</span>(n))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>: </span><br><span class="line">  app = QApplication(sys.argv) </span><br><span class="line">  form = WinForm() </span><br><span class="line">  form.show() </span><br><span class="line">  sys.exit(app.exec_())</span><br></pre></td></tr></table></figure><h3 id="è£…é¥°å™¨å®šä¹‰ä¿¡å·ä¸æ§½">è£…é¥°å™¨å®šä¹‰ä¿¡å·ä¸æ§½</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PyQt5 <span class="keyword">import</span> QtCore </span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> QApplication ,QWidget ,QHBoxLayout , QPushButton</span><br><span class="line"><span class="keyword">import</span> sys  </span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustWidget</span>( <span class="title class_ inherited__">QWidget</span> ):</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, parent=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="built_in">super</span>(CustWidget, <span class="variable language_">self</span>).__init__(parent)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">self</span>.okButton = QPushButton(<span class="string">&quot;OK&quot;</span>, <span class="variable language_">self</span>)</span><br><span class="line">    <span class="comment">#ä½¿ç”¨setObjectNameè®¾ç½®å¯¹è±¡åç§°</span></span><br><span class="line">    <span class="variable language_">self</span>.okButton.setObjectName(<span class="string">&quot;okButton&quot;</span>)</span><br><span class="line">    layout = QHBoxLayout()</span><br><span class="line">    layout.addWidget(<span class="variable language_">self</span>.okButton)</span><br><span class="line">    <span class="variable language_">self</span>.setLayout(layout)</span><br><span class="line">    QtCore.QMetaObject.connectSlotsByName(<span class="variable language_">self</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">  @QtCore.pyqtSlot()  </span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">on_okButton_clicked</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="built_in">print</span>( <span class="string">&quot;å•å‡»äº†OKæŒ‰é’®&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:    </span><br><span class="line">  app = QApplication(sys.argv)</span><br><span class="line">  win = CustWidget()</span><br><span class="line">  win.show()</span><br><span class="line">  app.exec_()</span><br></pre></td></tr></table></figure><h3 id="ä¿¡å·ä¸æ§½çš„æ–­å¼€è¿æ¥">ä¿¡å·ä¸æ§½çš„æ–­å¼€è¿æ¥</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> QObject , pyqtSignal</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SignalClass</span>(<span class="title class_ inherited__">QObject</span>):</span><br><span class="line"></span><br><span class="line">   <span class="comment"># å£°æ˜æ— å‚æ•°çš„ä¿¡å·</span></span><br><span class="line">  signal1 = pyqtSignal()</span><br><span class="line"></span><br><span class="line">  <span class="comment"># å£°æ˜å¸¦ä¸€ä¸ªintç±»å‹å‚æ•°çš„ä¿¡å·</span></span><br><span class="line">  signal2 = pyqtSignal(<span class="built_in">int</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,parent=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="built_in">super</span>(SignalClass,<span class="variable language_">self</span>).__init__(parent)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å°†ä¿¡å·signal1è¿æ¥åˆ°sin1Callå’Œsin2Callè¿™ä¸¤ä¸ªæ§½å‡½æ•°</span></span><br><span class="line">    <span class="variable language_">self</span>.signal1.connect(<span class="variable language_">self</span>.sin1Call)</span><br><span class="line">    <span class="variable language_">self</span>.signal1.connect(<span class="variable language_">self</span>.sin2Call)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å°†ä¿¡å·signal2è¿æ¥åˆ°ä¿¡å·signal1</span></span><br><span class="line">    <span class="variable language_">self</span>.signal2.connect(<span class="variable language_">self</span>.signal1)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å‘å°„ä¿¡å·</span></span><br><span class="line">    <span class="variable language_">self</span>.signal1.emit()</span><br><span class="line">    <span class="variable language_">self</span>.signal2.emit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ–­å¼€signal1ã€signal2ä¿¡å·ä¸å„æ§½å‡½æ•°çš„è¿æ¥</span></span><br><span class="line">    <span class="variable language_">self</span>.signal1.disconnect(<span class="variable language_">self</span>.sin1Call)</span><br><span class="line">    <span class="variable language_">self</span>.signal1.disconnect(<span class="variable language_">self</span>.sin2Call)</span><br><span class="line">    <span class="variable language_">self</span>.signal2.disconnect(<span class="variable language_">self</span>.signal1)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å°†ä¿¡å·signal1å’Œsignal2è¿æ¥åˆ°åŒä¸€ä¸ªæ§½å‡½æ•°sin1Call</span></span><br><span class="line">    <span class="variable language_">self</span>.signal1.connect(<span class="variable language_">self</span>.sin1Call)</span><br><span class="line">    <span class="variable language_">self</span>.signal2.connect(<span class="variable language_">self</span>.sin1Call)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å†æ¬¡å‘å°„ä¿¡å·</span></span><br><span class="line">    <span class="variable language_">self</span>.signal1.emit()</span><br><span class="line">    <span class="variable language_">self</span>.signal2.emit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">sin1Call</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;signal-1 emit&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">sin2Call</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;signal-2 emit&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>: </span><br><span class="line">  signal = SignalClass()</span><br></pre></td></tr></table></figure><h3 id="å¤šçº¿ç¨‹ä½¿ç”¨">å¤šçº¿ç¨‹ä½¿ç”¨</h3><ul><li>QThreadå‡½æ•°å’Œä¿¡å·ä¸æ§½ç®€å•çš„ç»“åˆ</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> QApplication ,QWidget</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> QThread , pyqtSignal</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Main</span>(<span class="title class_ inherited__">QWidget</span>):</span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, parent = <span class="literal">None</span></span>):</span><br><span class="line">    <span class="built_in">super</span>(Main,<span class="variable language_">self</span>).__init__(parent)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å®ä¾‹å¹¶è®¾ç½®åç§°ã€å˜é‡ã€ä¿¡å·ä¸æ§½</span></span><br><span class="line">    <span class="variable language_">self</span>.thread = MyThread()</span><br><span class="line">    <span class="variable language_">self</span>.thread.setIdentity(<span class="string">&quot;thread1&quot;</span>)</span><br><span class="line">    <span class="variable language_">self</span>.thread.sinOut.connect(<span class="variable language_">self</span>.outText)</span><br><span class="line">    <span class="variable language_">self</span>.thread.setVal(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">outText</span>(<span class="params">self,text</span>):</span><br><span class="line">    <span class="built_in">print</span>(text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyThread</span>(<span class="title class_ inherited__">QThread</span>):</span><br><span class="line">  sinOut = pyqtSignal(<span class="built_in">str</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,parent=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="built_in">super</span>(MyThread,<span class="variable language_">self</span>).__init__(parent)</span><br><span class="line">    <span class="variable language_">self</span>.identity = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">setIdentity</span>(<span class="params">self,text</span>):</span><br><span class="line">    <span class="variable language_">self</span>.identity = text</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">setVal</span>(<span class="params">self,val</span>):</span><br><span class="line">    <span class="variable language_">self</span>.times = <span class="built_in">int</span>(val)</span><br><span class="line">    <span class="comment"># æ‰§è¡Œçº¿ç¨‹çš„runæ–¹æ³•</span></span><br><span class="line">    <span class="variable language_">self</span>.start()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="variable language_">self</span>.times   <span class="number">0</span> <span class="keyword">and</span> <span class="variable language_">self</span>.identity:</span><br><span class="line">      <span class="comment"># å‘å°„ä¿¡å·</span></span><br><span class="line">      <span class="variable language_">self</span>.sinOut.emit(<span class="variable language_">self</span>.identity+<span class="string">&quot;== &quot;</span>+<span class="built_in">str</span>(<span class="variable language_">self</span>.times))</span><br><span class="line">      <span class="variable language_">self</span>.times -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>: </span><br><span class="line">  app = QApplication(sys.argv)</span><br><span class="line">  main = Main()</span><br><span class="line">  main.show()</span><br><span class="line">  sys.exit(app.exec_())</span><br></pre></td></tr></table></figure><ul><li>åå°çº¿ç¨‹å†…å®¹å®æ—¶æ›´æ–°åˆ°UIçº¿ç¨‹</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> QThread , pyqtSignal, QDateTime </span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> QApplication, QDialog, QLineEdit</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BackendThread</span>(<span class="title class_ inherited__">QThread</span>):</span><br><span class="line">  <span class="comment"># é€šè¿‡ç±»æˆå‘˜å¯¹è±¡å®šä¹‰ä¿¡å·</span></span><br><span class="line">  update_date = pyqtSignal(<span class="built_in">str</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># å¤„ç†ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">      data = QDateTime.currentDateTime()</span><br><span class="line">      currTime = data.toString(<span class="string">&quot;yyyy-MM-dd hh:mm:ss&quot;</span>)</span><br><span class="line">      <span class="variable language_">self</span>.update_date.emit( <span class="built_in">str</span>(currTime) )</span><br><span class="line">      time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Window</span>(<span class="title class_ inherited__">QDialog</span>):</span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">    QDialog.__init__(<span class="variable language_">self</span>)</span><br><span class="line">    <span class="variable language_">self</span>.setWindowTitle(<span class="string">&#x27;PyQt5ç•Œé¢å®æ—¶æ›´æ–°ä¾‹å­&#x27;</span>)</span><br><span class="line">    <span class="variable language_">self</span>.resize(<span class="number">400</span>, <span class="number">100</span>)</span><br><span class="line">    <span class="variable language_">self</span>.<span class="built_in">input</span> = QLineEdit(<span class="variable language_">self</span>)</span><br><span class="line">    <span class="variable language_">self</span>.<span class="built_in">input</span>.resize(<span class="number">400</span>, <span class="number">100</span>)</span><br><span class="line">    <span class="variable language_">self</span>.initUI()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">initUI</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="comment"># åˆ›å»ºçº¿ç¨‹</span></span><br><span class="line">    <span class="variable language_">self</span>.backend = BackendThread()</span><br><span class="line">    <span class="comment"># è¿æ¥ä¿¡å·</span></span><br><span class="line">    <span class="variable language_">self</span>.backend.update_date.connect(<span class="variable language_">self</span>.handleDisplay)</span><br><span class="line">    <span class="comment"># å¼€å§‹çº¿ç¨‹</span></span><br><span class="line">    <span class="variable language_">self</span>.backend.start()</span><br><span class="line"></span><br><span class="line">  <span class="comment"># å°†å½“å‰æ—¶é—´è¾“å‡ºåˆ°æ–‡æœ¬æ¡†</span></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">handleDisplay</span>(<span class="params">self, data</span>):</span><br><span class="line">    <span class="variable language_">self</span>.<span class="built_in">input</span>.setText(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  app = QApplication(sys.argv)</span><br><span class="line">  win = Window()</span><br><span class="line">  win.show() </span><br><span class="line">  sys.exit(app.exec_())</span><br></pre></td></tr></table></figure><h2 id="æ¡ˆä¾‹">æ¡ˆä¾‹</h2><blockquote><p>æœºåˆ¶å›é¡¾</p></blockquote><p><img src="/2024/08/21/pyqt5-singal-thread/pyqt5-slot.png" class="lazyload placeholder" data-srcset="/2024/08/21/pyqt5-singal-thread/pyqt5-slot.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h3 id="è·¨çº¿ç¨‹ä¿¡å·ä¸æ§½åº”ç”¨">è·¨çº¿ç¨‹ä¿¡å·ä¸æ§½åº”ç”¨</h3><ul><li>å®šä¹‰ä¿¡å·ä¸æ§½å‡½æ•°ç±»</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> QApplication, QMainWindow, QLineEdit, QPushButton</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> QThread, pyqtSignal, pyqtSlot, QObject, QRunnable</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">pyqt5 ä¿¡å·æ§½</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WorkerSignals</span>(<span class="title class_ inherited__">QObject</span>):</span><br><span class="line">    finished = pyqtSignal(<span class="built_in">str</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Worker</span>(<span class="title class_ inherited__">QRunnable</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, text</span>):</span><br><span class="line">        <span class="built_in">super</span>(Worker, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="variable language_">self</span>.text = text</span><br><span class="line">        <span class="variable language_">self</span>.signals = WorkerSignals()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @pyqtSlot()</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># æ¨¡æ‹Ÿé•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡</span></span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line">        <span class="comment"># å®Œæˆä»»åŠ¡åå‘å‡ºä¿¡å·</span></span><br><span class="line">        <span class="variable language_">self</span>.signals.finished.emit(<span class="variable language_">self</span>.text)</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>ä¿¡å·ç»‘å®šä¸äº‹ä»¶è§¦å‘</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    ...</span><br><span class="line">    worker = Worker(constants.detect_dsa_version_msg)</span><br><span class="line">    worker.signals.finished.connect(<span class="variable language_">self</span>.on_hex_changed)</span><br><span class="line">    QThreadPool.globalInstance().start(worker)</span><br><span class="line">    worker.run()</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>äº‹ä»¶å¤„ç†</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_hex_changed</span>(<span class="params">self, msg=<span class="literal">None</span>, _=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param text:</span></span><br><span class="line"><span class="string">    :param _:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># bool</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span> msg:</span><br><span class="line">            logger.debug(<span class="string">f&quot;detect signal to msg: <span class="subst">&#123;msg&#125;</span>]&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.input_box_hex.setPlaceholderText(msg)</span><br><span class="line">            input_str = msg.replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="See">See</h2><ul><li>1.<a href="https://cloud.tencent.com/developer/article/1742531">https://cloud.tencent.com/developer/article/1742531</a></li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python ä½¿ç”¨tesseractå®ç°å®æ—¶ç›‘æ§æ¡Œé¢</title>
      <link href="/2024/08/21/pytesseract-ocr-demo/"/>
      <url>/2024/08/21/pytesseract-ocr-demo/</url>
      
        <content type="html"><![CDATA[<h1>python ä½¿ç”¨tesseractå®ç°å®æ—¶ç›‘æ§æ¡Œé¢</h1><h2 id="æŠ€æœ¯ä»‹ç»">æŠ€æœ¯ä»‹ç»</h2><blockquote><p>Tesseractæ˜¯ä¸€ä¸ª ç”±HPå®éªŒå®¤å¼€å‘ ç”±Googleç»´æŠ¤çš„å¼€æºçš„å…‰å­¦å­—ç¬¦è¯†åˆ«ï¼ˆOCRï¼‰å¼•æ“ï¼Œå¯ä»¥åœ¨ Apache 2.0 è®¸å¯ä¸‹è·å¾—ã€‚å®ƒå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œæˆ–è€…ï¼ˆå¯¹äºç¨‹åºå‘˜ï¼‰ä½¿ç”¨ APIâ€‹â€‹ ä»å›¾åƒä¸­æå–è¾“å…¥ï¼ŒåŒ…æ‹¬æ‰‹å†™çš„æˆ–æ‰“å°çš„æ–‡æœ¬ã€‚ä¸Microsoft Office Document Imagingï¼ˆMODIï¼‰ç›¸æ¯”ï¼Œæˆ‘ä»¬å¯ä»¥ä¸æ–­çš„è®­ç»ƒè¯­è¨€ï¼Œæé«˜å›¾åƒè½¬æ¢æ–‡æœ¬çš„èƒ½åŠ›</p></blockquote><h2 id="ä¸‹è½½åœ°å€">ä¸‹è½½åœ°å€</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://digi.bib.uni-mannheim.de/tesseract/</span><br></pre></td></tr></table></figure><h2 id="ç¬¬ä¸‰æ–¹åº“å®‰è£…">ç¬¬ä¸‰æ–¹åº“å®‰è£…</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip install pytesseract -i https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line">pip install pillow -i https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line">pip install pywin32 PyAutoGUI pygetwindow loguru</span><br></pre></td></tr></table></figure><h2 id="demo">demo</h2><h3 id="æµ‹è¯•ä»£ç ">æµ‹è¯•ä»£ç </h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> pytesseract</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¡®ä¿Tesseractçš„è·¯å¾„å·²æ·»åŠ åˆ°ç¯å¢ƒå˜é‡æˆ–åœ¨æ­¤å¤„æŒ‡å®š</span></span><br><span class="line">pytesseract.pytesseract.tesseract_cmd = <span class="string">r&#x27;C:\Program Files\Tesseract-OCR\tesseract.exe&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯†åˆ«å›ºå®šå›¾ç‰‡å†…æ–‡å­—</span></span><br><span class="line">img_path = <span class="string">&quot;../chi.PNG&quot;</span></span><br><span class="line">result = pytesseract.image_to_string(image=img_path, lang=<span class="string">&quot;chi_sim&quot;</span>, config=<span class="string">&quot;--psm 1&quot;</span>)   <span class="comment">#è·¯å¾„ï¼›è¯­è¨€ï¼›é…ç½®</span></span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="æ¡ˆä¾‹">æ¡ˆä¾‹</h2><h3 id="å®ç°æ€è·¯">å®ç°æ€è·¯</h3><blockquote><p>é€šè¿‡pillowåŠ¨æ€æŠ“å–å±å¹•æˆªå›¾ï¼ŒtesseractåŠ¨æ€è¯†åˆ«å›¾ç‰‡å†…å®¹ï¼Œè¿‡æ»¤æ‰€éœ€ä¿¡æ¯ï¼Œå³å¯å®ç°å¯¹æ¡Œé¢ï¼ˆä¸»å±ï¼‰çš„åŠ¨æ€ç›‘æ§</p></blockquote><h3 id="demo-ä»£ç ">demo ä»£ç </h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pygetwindow <span class="keyword">as</span> gw</span><br><span class="line"><span class="keyword">import</span> pyautogui</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–çª—å£å¥æŸ„</span></span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> run <span class="keyword">import</span> constants</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pytesseract</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> ImageGrab, Image</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¡®ä¿Tesseractçš„è·¯å¾„å·²æ·»åŠ åˆ°ç¯å¢ƒå˜é‡æˆ–åœ¨æ­¤å¤„æŒ‡å®š</span></span><br><span class="line">pytesseract.pytesseract.tesseract_cmd = <span class="string">r&#x27;C:\Program Files\Tesseract-OCR\tesseract.exe&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># tesseract_cmd = r&#x27;D:\Program Files\tesseract\tesseract.exe&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ocr_screenshot</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># æ•è·å…¨å±æˆªå›¾</span></span><br><span class="line">    screenshot = ImageGrab.grab()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶ï¼ˆæˆ–ç›´æ¥åœ¨å†…å­˜ä¸­å¤„ç†ï¼Œä½†pytesseractå¯èƒ½éœ€è¦æ–‡ä»¶è·¯å¾„ï¼‰</span></span><br><span class="line">    temp_file = <span class="string">&quot;screenshot.png&quot;</span></span><br><span class="line">    screenshot.save(temp_file)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä½¿ç”¨Tesseractè¿›è¡ŒOCR</span></span><br><span class="line">    text = pytesseract.image_to_string(Image.<span class="built_in">open</span>(temp_file))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ é™¤ä¸´æ—¶æ–‡ä»¶ï¼ˆå¦‚æœéœ€è¦ï¼‰</span></span><br><span class="line">    os.remove(temp_file)</span><br><span class="line">    <span class="keyword">return</span> text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_msg</span>(<span class="params">process_result</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param process_result:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    result_list = []</span><br><span class="line">    <span class="keyword">for</span> version_msg <span class="keyword">in</span> version_pre_list:</span><br><span class="line">        complete_str = success_result_pre + ecu_head + version_msg</span><br><span class="line">        <span class="comment"># logger.debug(complete_str)</span></span><br><span class="line">        ret = extract_after_string(process_result, complete_str)</span><br><span class="line">        <span class="comment"># replace ocr error detect code</span></span><br><span class="line">        ret = ret.replace(<span class="string">&quot;S&quot;</span>, <span class="string">&quot;5&quot;</span>).replace(<span class="string">&quot;o&quot;</span>, <span class="string">&quot;0&quot;</span>).replace(<span class="string">&quot;l&quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> ret != <span class="string">&quot;&quot;</span>:</span><br><span class="line">            logger.success(<span class="string">f&quot;find version msg: <span class="subst">&#123;ret&#125;</span>&quot;</span>)</span><br><span class="line">            result_list.append(ret)</span><br><span class="line">    <span class="keyword">return</span> result_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_after_string</span>(<span class="params">source_str, search_str</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æå–source_strä¸­search_strä¹‹åçš„å†…å®¹ï¼Œâ€Œç›´åˆ°é‡åˆ°æ¢è¡Œç¬¦ä¸ºæ­¢ã€‚â€Œ</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param source_str: åŸå§‹å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="string">    :param search_str: è¦æœç´¢çš„å­å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="string">    :return: search_strä¹‹åçš„å†…å®¹ï¼Œâ€Œç›´åˆ°æ¢è¡Œç¬¦ä¸ºæ­¢</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    index = source_str.find(search_str)</span><br><span class="line">    <span class="keyword">if</span> index != -<span class="number">1</span>:</span><br><span class="line">        <span class="comment"># ä»search_strä¹‹åå¼€å§‹ï¼Œâ€Œç›´åˆ°é‡åˆ°æ¢è¡Œç¬¦</span></span><br><span class="line">        end_index = source_str.find(<span class="string">&#x27;\n&#x27;</span>, index + <span class="built_in">len</span>(search_str))</span><br><span class="line">        <span class="keyword">if</span> end_index != -<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> source_str[index + <span class="built_in">len</span>(search_str):end_index]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ¢è¡Œç¬¦ï¼Œâ€Œåˆ™è¿”å›search_strä¹‹åçš„æ‰€æœ‰å†…å®¹</span></span><br><span class="line">            <span class="keyword">return</span> source_str[index + <span class="built_in">len</span>(search_str):]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detect_status_dsa</span>(<span class="params">ocr_result</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param ocr_result:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> test_pre <span class="keyword">in</span> ocr_result:</span><br><span class="line">            <span class="comment"># logger.debug(&quot;test ing...&quot;)</span></span><br><span class="line">            <span class="keyword">if</span> fail_msg_head <span class="keyword">in</span> ocr_result:</span><br><span class="line">                fail_result = extract_after_string(ocr_result, fail_msg_head)</span><br><span class="line">                logger.warning(<span class="string">f&quot;catch error: <span class="subst">&#123;fail_result&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">elif</span> success_result_pre <span class="keyword">in</span> ocr_result:</span><br><span class="line">                <span class="comment"># logger.success(&quot;success catch result&quot;)</span></span><br><span class="line">                process_msg(ocr_result)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            no_result = extract_after_string(ocr_result, test_pre)</span><br><span class="line">            logger.debug(<span class="string">f&quot;current not found result: <span class="subst">&#123;no_result&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Unknown error, detail:<span class="subst">&#123;e&#125;</span>]&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    constants.detect_dsa_flag = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">while</span> constants.detect_dsa_flag:</span><br><span class="line">        time.sleep(<span class="number">1</span> / <span class="number">10</span>)</span><br><span class="line">        result = ocr_screenshot()</span><br><span class="line">        <span class="comment"># logger.debug(result)</span></span><br><span class="line">        detect_ret_list = detect_status_dsa(result)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> detect_ret_list:</span><br><span class="line">            logger.warning(<span class="string">&quot;no result, start next loop detect.&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            constants.detect_dsa_version_msg = <span class="string">&quot;\n&quot;</span>.join(detect_ret_list)</span><br><span class="line">            logger.debug(<span class="string">f&quot;result: <span class="subst">&#123;constants.detect_dsa_version_msg&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="å®ç°æ•ˆæœ">å®ç°æ•ˆæœ</h3><ul><li>å¦‚å›¾<br><img src="/2024/08/21/pytesseract-ocr-demo/ocr_result.png" class="lazyload placeholder" data-srcset="/2024/08/21/pytesseract-ocr-demo/ocr_result.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> tesseract </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨pythonå®ç°ç®€æ˜“æˆªå›¾åŠŸèƒ½</title>
      <link href="/2024/08/19/py-screenshot-demo/"/>
      <url>/2024/08/19/py-screenshot-demo/</url>
      
        <content type="html"><![CDATA[<h1>ä½¿ç”¨pythonå®ç°ç®€æ˜“æˆªå›¾åŠŸèƒ½</h1><h2 id="æŠ€æœ¯æ–¹æ¡ˆ">æŠ€æœ¯æ–¹æ¡ˆ</h2><h3 id="pyautogui">pyautogui</h3><blockquote><p>pyautogui æ¨¡å—ï¼Œä½¿ç”¨screenshot() å‡½æ•°å’Œsave() å‡½æ•°å®ç°</p></blockquote><h4 id="åŸºç¡€demo">åŸºç¡€demo</h4><ul><li>éœ€è¦å…ˆå®‰è£…pyautoguiåº“</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pyautogui</span><br></pre></td></tr></table></figure><ul><li>ä»£ç å¦‚ä¸‹</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pyautogui</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–æˆªå›¾</span></span><br><span class="line">image = pyautogui.screenshot()</span><br><span class="line"><span class="comment">#ä¿å­˜å›¾ç‰‡</span></span><br><span class="line">image.save(<span class="string">&quot;test.jpg&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="pyautoguiå’Œopencv">pyautoguiå’Œopencv</h3><h4 id="åŸºç¡€demo-2">åŸºç¡€demo</h4><blockquote><p>pyautoguiæˆªå–å›¾ç‰‡ï¼Œopencvä¿å­˜å›¾ç‰‡</p></blockquote><ul><li>éœ€è¦å…ˆå®‰è£…pyautoguiã€opencvåº“</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install pyautogui </span><br><span class="line">pip install opencv-python</span><br></pre></td></tr></table></figure><ul><li>ä»£ç å¦‚ä¸‹</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pyautogui</span><br><span class="line"><span class="keyword">import</span> numpy</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–å±å¹•æˆªå›¾</span></span><br><span class="line">image = pyautogui.screenshot()</span><br><span class="line"><span class="comment"># è½¬æ¢å›¾ç‰‡</span></span><br><span class="line">image = cv2.cvtColor(x.array(demo_image),cv2.COLOG_RGB2BGR)</span><br><span class="line"><span class="comment"># å†™å…¥å›¾ç‰‡</span></span><br><span class="line">cv2.imwrite(<span class="string">&quot;test.png&quot;</span>, image)</span><br><span class="line"><span class="comment"># æ˜¾ç¤ºå›¾ç‰‡</span></span><br><span class="line">cv2.imshow(<span class="string">&quot;test&quot;</span>, image)</span><br></pre></td></tr></table></figure><h3 id="pillow">pillow</h3><blockquote><p>ä½¿ç”¨ImageGrapæ•è·æ•æ‰å±å¹•çš„ä¸€éƒ¨åˆ†</p></blockquote><h4 id="åŸºç¡€demo-3">åŸºç¡€demo</h4><ul><li>éœ€è¦å…ˆå®‰è£…pillowåº“</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pillow</span><br></pre></td></tr></table></figure><ul><li>ä»£ç å¦‚ä¸‹</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> ImageGrab</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®è·å–çš„æˆªå›¾åæ ‡</span></span><br><span class="line">location = (<span class="number">60</span>,<span class="number">60</span>,<span class="number">60</span>,<span class="number">60</span>)</span><br><span class="line"><span class="comment"># è·å–æˆªå›¾</span></span><br><span class="line">screenshot = ImageGrab.grab(location)</span><br><span class="line"><span class="comment"># ä¿å­˜å›¾ç‰‡åˆ°æœ¬åœ°</span></span><br><span class="line">screenshot.save(<span class="string">&quot;result.png&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="pyscreenshot">pyscreenshot</h3><blockquote><p>è¾ƒå°‘ä½¿ç”¨</p></blockquote><h4 id="åŸºç¡€demo-4">åŸºç¡€demo</h4><ul><li>éœ€è¦å…ˆå®‰è£…pyscreenshotåº“</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pyscreenshot</span><br></pre></td></tr></table></figure><ul><li>ä»£ç å¦‚ä¸‹</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pyscreenshot</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–æˆªå›¾</span></span><br><span class="line">demo = pyscreen.grab(location)</span><br><span class="line"><span class="comment"># ä¿å­˜å›¾ç‰‡åˆ°æœ¬åœ°</span></span><br><span class="line">demo.save(<span class="string">&quot;result.png&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="å›¾ç‰‡æ•°æ®è½¬ç§»åˆ°å‰ªè´´æ¿">å›¾ç‰‡æ•°æ®è½¬ç§»åˆ°å‰ªè´´æ¿</h3><blockquote><p>ä½¿ç”¨windowsç³»ç»ŸAPI pywin32åº“</p></blockquote><h2 id="å®ç°æ–¹æ³•">å®ç°æ–¹æ³•</h2><h3 id="å®‰è£…pywin32åº“">å®‰è£…pywin32åº“</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pywin32</span><br></pre></td></tr></table></figure><ul><li>ä»£ç å¦‚ä¸‹</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> win32clipboard <span class="keyword">as</span> w</span><br><span class="line"><span class="keyword">import</span> win32con</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“å¼€å‰ªè´´</span></span><br><span class="line">w.OpenClipboard()</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¸…ç©ºå‰ªåˆ‡æ¿</span></span><br><span class="line">w.EmptyClipboard()</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†å›¾ç‰‡æ•°æ®è®¾ç½®åˆ°å‰ªè´´æ¿</span></span><br><span class="line">w.SetClipboardData(win32con.CF_DIB, data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–å‰ªè´´æ¿å†…å®¹</span></span><br><span class="line">result = w.GetClipboardData(win32con.CF_TEXT)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£ç æ•°æ®</span></span><br><span class="line">clipboard_content = d.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­å‰ªè´´æ¿</span></span><br><span class="line">w.CloseClipboard()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="å®é™…åº”ç”¨">å®é™…åº”ç”¨</h2><h3 id="ç®€ä»‹">ç®€ä»‹</h3><blockquote><p>æœ¬æ¡ˆä¾‹é€šè¿‡æŒ‰é’®æˆªå–æŒ‡å®šçª—å£å†…å®¹å¹¶å†™å…¥å‰ªè´´æ¿ï¼Œé€šè¿‡å¿«æ·é”®ctrl+vå¯ç²˜è´´åˆ°å¾®ä¿¡ã€qqã€officeç­‰è½¯ä»¶ä¸­ã€‚</p></blockquote><h3 id="ä»£ç ">ä»£ç </h3><ul><li>æˆªå›¾è‡³å‰ªè´´æ¿åŠŸèƒ½å®ç°</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pygetwindow <span class="keyword">as</span> gw</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> ImageGrab</span><br><span class="line"><span class="keyword">import</span> win32clipboard <span class="keyword">as</span> w</span><br><span class="line"><span class="keyword">import</span> win32con</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_win_screenshot</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    get screenshot</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># è·å–å½“å‰æ¿€æ´»çš„çª—å£</span></span><br><span class="line">        active_window = gw.getActiveWindow()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è·å–çª—å£çš„è¾¹ç•Œæ¡†</span></span><br><span class="line">        box = active_window._getWindowRect()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ ¹æ®è¾¹ç•Œæ¡†æˆªå–å±å¹•æˆªå›¾</span></span><br><span class="line">        screenshot = ImageGrab.grab(box)</span><br><span class="line"></span><br><span class="line">        size = screenshot.size</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å°†Imageè½¬æ¢ä¸ºå­—èŠ‚æµï¼Œä»¥ä¾¿å­˜å‚¨åˆ°å‰ªè´´æ¿</span></span><br><span class="line">        img_bytes = io.BytesIO()</span><br><span class="line">        screenshot.convert(<span class="string">&quot;RGB&quot;</span>).save(img_bytes, <span class="string">&quot;BMP&quot;</span>)</span><br><span class="line">        <span class="comment"># image.convert(&quot;RGB&quot;).save(output_buffer, &#x27;BMP&#x27;)</span></span><br><span class="line">        data = img_bytes.getvalue()[<span class="number">14</span>:]</span><br><span class="line">        img_bytes.seek(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ‰“å¼€å‰ªè´´</span></span><br><span class="line">        w.OpenClipboard()</span><br><span class="line">        w.EmptyClipboard()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å°†å›¾ç‰‡æ•°æ®è®¾ç½®åˆ°å‰ªè´´æ¿</span></span><br><span class="line">        w.SetClipboardData(win32con.CF_DIB, data)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å…³é—­å‰ªè´´æ¿</span></span><br><span class="line">        w.CloseClipboard()</span><br><span class="line">        logger.success(<span class="string">f&quot;Screenshot success, image size: <span class="subst">&#123;size&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Screen shot error, detail: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>æŒ‰é’®è§¦å‘äº‹ä»¶</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> Qt</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> QApplication, QWidget, QVBoxLayout, QLineEdit, QTextEdit, QPushButton, QMenu, \</span><br><span class="line">    QMenuBar, QTabWidget, QMainWindow, QAction, QHBoxLayout, QLabel</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ui_init</span>(<span class="params">self, _=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param self:</span></span><br><span class="line"><span class="string">    :param _:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    layout_main = QVBoxLayout()</span><br><span class="line">    layout_hon = QHBoxLayout()</span><br><span class="line">    <span class="variable language_">self</span>.screenshot_btn = QPushButton(<span class="string">&quot;screenshot&quot;</span>, <span class="variable language_">self</span>)</span><br><span class="line">    layout_hon.addWidget(<span class="variable language_">self</span>.screenshot_btn)</span><br><span class="line">    <span class="variable language_">self</span>.screenshot_btn.clicked.connect(<span class="variable language_">self</span>.screenshot_method)</span><br></pre></td></tr></table></figure><h2 id="è¿›é˜¶ä½¿ç”¨-è‡ªç”±é€‰æ‹©æˆªå›¾åŒºåŸŸ">è¿›é˜¶ä½¿ç”¨-è‡ªç”±é€‰æ‹©æˆªå›¾åŒºåŸŸ</h2><h3 id="ç®€è¿°">ç®€è¿°</h3><blockquote><p>é€šè¿‡ç»“åˆpyqt5ä¸pillowå¯å®ç°è‡ªç”±é€‰æ‹©æˆªå›¾åŒºåŸŸï¼Œé€‰æ‹©å®Œæˆåé€šè¿‡enteré”®ä¿å­˜å›¾ç‰‡è‡³å‰ªè´´æ¿ï¼ŒæŠ‘æˆ–ä½¿ç”¨escé”®å–æ¶ˆæˆªå›¾ï¼Œè‡ªç”±åº¦è¾ƒé«˜</p></blockquote><h3 id="å®ç°">å®ç°</h3><ul><li>code</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="comment"># import keyboard</span></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> win32con</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> ImageGrab</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> QApplication, QWidget, QDialog</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> Qt, qAbs, QRect</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtGui <span class="keyword">import</span> QPen, QPainter, QColor, QGuiApplication</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">import</span> win32clipboard <span class="keyword">as</span> w</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> run <span class="keyword">import</span> constants</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># from utils.image_process import screenshot_img_save</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CaptureScreen</span>(<span class="title class_ inherited__">QDialog</span>):</span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–å˜é‡</span></span><br><span class="line">    beginPosition = <span class="literal">None</span></span><br><span class="line">    endPosition = <span class="literal">None</span></span><br><span class="line">    fullScreenImage = <span class="literal">None</span></span><br><span class="line">    captureImage = <span class="literal">None</span></span><br><span class="line">    isMousePressLeft = <span class="literal">None</span></span><br><span class="line">    painter = QPainter()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(QWidget, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="variable language_">self</span>.initWindow()  <span class="comment"># åˆå§‹åŒ–çª—å£</span></span><br><span class="line">        <span class="variable language_">self</span>.captureFullScreen()  <span class="comment"># è·å–å…¨å±</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">initWindow</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.setMouseTracking(<span class="literal">True</span>)  <span class="comment"># é¼ æ ‡è¿½è¸ª</span></span><br><span class="line">        <span class="variable language_">self</span>.setCursor(Qt.CrossCursor)  <span class="comment"># è®¾ç½®å…‰æ ‡</span></span><br><span class="line">        <span class="variable language_">self</span>.setWindowFlag(Qt.FramelessWindowHint)  <span class="comment"># çª—å£æ— è¾¹æ¡†</span></span><br><span class="line">        <span class="variable language_">self</span>.setWindowState(Qt.WindowFullScreen)  <span class="comment"># çª—å£å…¨å±</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">captureFullScreen</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.fullScreenImage = QGuiApplication.primaryScreen().grabWindow(QApplication.desktop().winId())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">mousePressEvent</span>(<span class="params">self, event</span>):</span><br><span class="line">        <span class="keyword">if</span> event.button() == Qt.LeftButton:</span><br><span class="line">            <span class="variable language_">self</span>.beginPosition = event.pos()</span><br><span class="line">            <span class="variable language_">self</span>.isMousePressLeft = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> event.button() == Qt.RightButton:</span><br><span class="line">            <span class="comment"># å¦‚æœé€‰å–äº†å›¾ç‰‡,åˆ™æŒ‰ä¸€æ¬¡å³é”®å¼€å§‹é‡æ–°æˆªå›¾</span></span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.captureImage <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="variable language_">self</span>.captureImage = <span class="literal">None</span></span><br><span class="line">                <span class="variable language_">self</span>.paintBackgroundImage()</span><br><span class="line">                <span class="variable language_">self</span>.update()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="variable language_">self</span>.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">mouseMoveEvent</span>(<span class="params">self, event</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.isMousePressLeft <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="variable language_">self</span>.endPosition = event.pos()</span><br><span class="line">            <span class="variable language_">self</span>.update()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">mouseReleaseEvent</span>(<span class="params">self, event</span>):</span><br><span class="line">        <span class="variable language_">self</span>.endPosition = event.pos()</span><br><span class="line">        <span class="variable language_">self</span>.isMousePressLeft = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">mouseDoubleClickEvent</span>(<span class="params">self, event</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.captureImage <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="variable language_">self</span>.saveImage()</span><br><span class="line">            <span class="variable language_">self</span>.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">keyPressEvent</span>(<span class="params">self, event</span>):</span><br><span class="line">        <span class="keyword">if</span> event.key() == Qt.Key_Escape:</span><br><span class="line">            constants.select_screenshot_flag = <span class="literal">False</span></span><br><span class="line">            logger.debug(<span class="string">&quot;Screenshot cancel.&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.close()</span><br><span class="line">        <span class="keyword">if</span> event.key() == Qt.Key_Enter <span class="keyword">or</span> event.key() == Qt.Key_Return:</span><br><span class="line">            <span class="keyword">if</span> <span class="variable language_">self</span>.captureImage <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="variable language_">self</span>.saveImage()</span><br><span class="line">                <span class="variable language_">self</span>.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">paintBackgroundImage</span>(<span class="params">self</span>):</span><br><span class="line">        shadowColor = QColor(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>)  <span class="comment"># é»‘è‰²åŠé€æ˜</span></span><br><span class="line">        <span class="variable language_">self</span>.painter.drawPixmap(<span class="number">0</span>, <span class="number">0</span>, <span class="variable language_">self</span>.fullScreenImage)</span><br><span class="line">        <span class="variable language_">self</span>.painter.fillRect(<span class="variable language_">self</span>.fullScreenImage.rect(), shadowColor)  <span class="comment"># å¡«å……çŸ©å½¢é˜´å½±</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">paintEvent</span>(<span class="params">self, event</span>):</span><br><span class="line">        <span class="variable language_">self</span>.painter.begin(<span class="variable language_">self</span>)  <span class="comment"># å¼€å§‹é‡ç»˜</span></span><br><span class="line">        <span class="variable language_">self</span>.paintBackgroundImage()</span><br><span class="line">        penColor = QColor(<span class="number">30</span>, <span class="number">144</span>, <span class="number">245</span>)  <span class="comment"># ç”»ç¬”é¢œè‰²</span></span><br><span class="line">        <span class="variable language_">self</span>.painter.setPen(QPen(penColor, <span class="number">1</span>, Qt.SolidLine, Qt.RoundCap))  <span class="comment"># è®¾ç½®ç”»ç¬”,è“è‰²,1pxå¤§å°,å®çº¿,åœ†å½¢ç¬”å¸½</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.isMousePressLeft <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">            pickRect = <span class="variable language_">self</span>.getRectangle(<span class="variable language_">self</span>.beginPosition, <span class="variable language_">self</span>.endPosition)  <span class="comment"># è·å¾—è¦æˆªå›¾çš„çŸ©å½¢æ¡†</span></span><br><span class="line">            <span class="variable language_">self</span>.captureImage = <span class="variable language_">self</span>.fullScreenImage.copy(pickRect)  <span class="comment"># æ•è·æˆªå›¾çŸ©å½¢æ¡†å†…çš„å›¾ç‰‡</span></span><br><span class="line">            <span class="variable language_">self</span>.painter.drawPixmap(pickRect.topLeft(), <span class="variable language_">self</span>.captureImage)  <span class="comment"># å¡«å……æˆªå›¾çš„å›¾ç‰‡</span></span><br><span class="line">            <span class="variable language_">self</span>.painter.drawRect(pickRect)  <span class="comment"># ç”»çŸ©å½¢è¾¹æ¡†</span></span><br><span class="line">        <span class="variable language_">self</span>.painter.end()  <span class="comment"># ç»“æŸé‡ç»˜</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">getRectangle</span>(<span class="params">self, beginPoint, endPoint</span>):</span><br><span class="line">        pickRectWidth = <span class="built_in">int</span>(qAbs(beginPoint.x() - endPoint.x()))</span><br><span class="line">        pickRectHeight = <span class="built_in">int</span>(qAbs(beginPoint.y() - endPoint.y()))</span><br><span class="line">        pickRectTop = beginPoint.x() <span class="keyword">if</span> beginPoint.x() &lt; endPoint.x() <span class="keyword">else</span> endPoint.x()</span><br><span class="line">        pickRectLeft = beginPoint.y() <span class="keyword">if</span> beginPoint.y() &lt; endPoint.y() <span class="keyword">else</span> endPoint.y()</span><br><span class="line">        pickRect = QRect(pickRectTop, pickRectLeft, pickRectWidth, pickRectHeight)</span><br><span class="line">        <span class="comment"># é¿å…é«˜åº¦å®½åº¦ä¸º0æ—¶å€™æŠ¥é”™</span></span><br><span class="line">        <span class="keyword">if</span> pickRectWidth == <span class="number">0</span>:</span><br><span class="line">            pickRect.setWidth(<span class="number">2</span>)</span><br><span class="line">        <span class="keyword">if</span> pickRectHeight == <span class="number">0</span>:</span><br><span class="line">            pickRect.setHeight(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> pickRect</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">saveImage</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># self.captureImage.save(&#x27;picture.png&#x27;, quality=95)  # ä¿å­˜å›¾ç‰‡åˆ°å½“å‰æ–‡ä»¶å¤¹ä¸­</span></span><br><span class="line">        <span class="comment"># self.captureImage.save</span></span><br><span class="line">        <span class="keyword">if</span> constants.select_screenshot_flag:</span><br><span class="line">            <span class="comment"># constants.select_screenshot_flag = True</span></span><br><span class="line">            save_img_threading_obj = threading.Thread(</span><br><span class="line">                target=screenshot_img_save,</span><br><span class="line">                args=(<span class="variable language_">self</span>,))</span><br><span class="line">            save_img_threading_obj.start()</span><br><span class="line">            <span class="comment"># logger.info(f&quot;Start save screenshot, &#123;constants.select_screenshot_flag&#125;&quot;)</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logger.error(<span class="string">&quot;save screenshot ing, please wait.&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">screenshot_img_save</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param self:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># logger.debug(&quot;3424234&quot;)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.beginPosition.x() &lt; <span class="variable language_">self</span>.endPosition.x():</span><br><span class="line">            x1 = <span class="variable language_">self</span>.beginPosition.x()</span><br><span class="line">            x2 = <span class="variable language_">self</span>.endPosition.x()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            x2 = <span class="variable language_">self</span>.beginPosition.x() + <span class="number">2</span></span><br><span class="line">            x1 = <span class="variable language_">self</span>.endPosition.x()</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.beginPosition.y() &lt; <span class="variable language_">self</span>.endPosition.y():</span><br><span class="line">            y1 = <span class="variable language_">self</span>.beginPosition.y()</span><br><span class="line">            y2 = <span class="variable language_">self</span>.endPosition.y()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            y2 = <span class="variable language_">self</span>.beginPosition.y() + <span class="number">2</span></span><br><span class="line">            y1 = <span class="variable language_">self</span>.endPosition.y()</span><br><span class="line">        box = [x1, y1, x2, y2]</span><br><span class="line">        screenshot = ImageGrab.grab(box)</span><br><span class="line">        <span class="comment"># size = screenshot.size</span></span><br><span class="line"></span><br><span class="line">        img_bytes = io.BytesIO()</span><br><span class="line">        screenshot.convert(<span class="string">&quot;RGB&quot;</span>).save(img_bytes, <span class="string">&quot;BMP&quot;</span>)</span><br><span class="line">        <span class="comment"># image.convert(&quot;RGB&quot;).save(output_buffer, &#x27;BMP&#x27;)</span></span><br><span class="line">        data = img_bytes.getvalue()[<span class="number">14</span>:]</span><br><span class="line">        img_bytes.seek(<span class="number">0</span>)</span><br><span class="line">        <span class="comment"># logger.debug(&quot;3133131&quot;)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ‰“å¼€å‰ªè´´</span></span><br><span class="line">        w.OpenClipboard()</span><br><span class="line">        w.EmptyClipboard()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å°†å›¾ç‰‡æ•°æ®è®¾ç½®åˆ°å‰ªè´´æ¿</span></span><br><span class="line">        w.SetClipboardData(win32con.CF_DIB, data)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å…³é—­å‰ªè´´æ¿</span></span><br><span class="line">        w.CloseClipboard()</span><br><span class="line">        logger.success(<span class="string">f&quot;Screenshot success, image select region: <span class="subst">&#123;self.beginPosition&#125;</span> : <span class="subst">&#123;self.endPosition&#125;</span>&quot;</span>)</span><br><span class="line">        constants.select_screenshot_flag = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Unknown error, detail: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        constants.select_screenshot_flag = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">screenshot_select</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># keyboard.wait(hotkey=&#x27;f4&#x27;)  # æŒ‰F4å¼€å§‹æˆªå›¾</span></span><br><span class="line">    <span class="comment"># app = QApplication(sys.argv)</span></span><br><span class="line">    windows = CaptureScreen()</span><br><span class="line">    windows.show()</span><br><span class="line">    windows.<span class="built_in">exec</span>()</span><br><span class="line">    <span class="comment"># sys.exit(app.exec_())</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="æ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š">æ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</h3><ul><li>æ•ˆæœå›¾</li></ul><p><img src="/2024/08/19/py-screenshot-demo/select_region_shot_img.jpg" class="lazyload placeholder" data-srcset="/2024/08/19/py-screenshot-demo/select_region_shot_img.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨clionå·¥å…·ç¼–å†™cpp qt demoç¨‹åº</title>
      <link href="/2024/08/09/cpp-qt-demo/"/>
      <url>/2024/08/09/cpp-qt-demo/</url>
      
        <content type="html"><![CDATA[<h1>ä½¿ç”¨clionå·¥å…·ç¼–å†™cpp qt demoç¨‹åº</h1><h2 id="qt-install-windows-å¹³å°">qt install (windows å¹³å°)</h2><ul><li>website</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://doc.qt.io/qt-5/windows.html</span><br></pre></td></tr></table></figure><ul><li>mirror config</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://mirrors.tuna.tsinghua.edu.cn/qt/official_releases/online_installers/</span><br></pre></td></tr></table></figure><blockquote><p>use tools install all components</p></blockquote><h2 id="é…ç½®æ–‡ä»¶">é…ç½®æ–‡ä»¶</h2><h3 id="CmakeList-txt">CmakeList.txt</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.26)</span><br><span class="line">project(untitled2)</span><br><span class="line"></span><br><span class="line">set(CMAKE_CXX_STANDARD 17)</span><br><span class="line">set(CMAKE_AUTOMOC ON)</span><br><span class="line">set(CMAKE_AUTORCC ON)</span><br><span class="line">set(CMAKE_AUTOUIC ON)</span><br><span class="line"></span><br><span class="line">set(CMAKE_PREFIX_PATH &quot;C:/Qt/6.7.2/mingw_64/lib/cmake&quot;)</span><br><span class="line"></span><br><span class="line">find_package(Qt6 COMPONENTS</span><br><span class="line">        Core</span><br><span class="line">        Gui</span><br><span class="line">        Widgets</span><br><span class="line">        REQUIRED)</span><br><span class="line"></span><br><span class="line">add_executable(untitled2 main.cpp)</span><br><span class="line">target_link_libraries(untitled2</span><br><span class="line">        Qt::Core</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">if (WIN32 AND NOT DEFINED CMAKE_TOOLCHAIN_FILE)</span><br><span class="line">    set(DEBUG_SUFFIX)</span><br><span class="line">    if (MSVC AND CMAKE_BUILD_TYPE MATCHES &quot;Debug&quot;)</span><br><span class="line">        set(DEBUG_SUFFIX &quot;d&quot;)</span><br><span class="line">    endif ()</span><br><span class="line">    set(QT_INSTALL_PATH &quot;$&#123;CMAKE_PREFIX_PATH&#125;&quot;)</span><br><span class="line">    if (NOT EXISTS &quot;$&#123;QT_INSTALL_PATH&#125;/bin&quot;)</span><br><span class="line">        set(QT_INSTALL_PATH &quot;$&#123;QT_INSTALL_PATH&#125;/..&quot;)</span><br><span class="line">        if (NOT EXISTS &quot;$&#123;QT_INSTALL_PATH&#125;/bin&quot;)</span><br><span class="line">            set(QT_INSTALL_PATH &quot;$&#123;QT_INSTALL_PATH&#125;/..&quot;)</span><br><span class="line">        endif ()</span><br><span class="line">    endif ()</span><br><span class="line">    if (EXISTS &quot;$&#123;QT_INSTALL_PATH&#125;/plugins/platforms/qwindows$&#123;DEBUG_SUFFIX&#125;.dll&quot;)</span><br><span class="line">        add_custom_command(TARGET $&#123;PROJECT_NAME&#125; POST_BUILD</span><br><span class="line">                COMMAND $&#123;CMAKE_COMMAND&#125; -E make_directory</span><br><span class="line">                &quot;$&lt;TARGET_FILE_DIR:$&#123;PROJECT_NAME&#125;&gt;/plugins/platforms/&quot;)</span><br><span class="line">        add_custom_command(TARGET $&#123;PROJECT_NAME&#125; POST_BUILD</span><br><span class="line">                COMMAND $&#123;CMAKE_COMMAND&#125; -E copy</span><br><span class="line">                &quot;$&#123;QT_INSTALL_PATH&#125;/plugins/platforms/qwindows$&#123;DEBUG_SUFFIX&#125;.dll&quot;</span><br><span class="line">                &quot;$&lt;TARGET_FILE_DIR:$&#123;PROJECT_NAME&#125;&gt;/plugins/platforms/&quot;)</span><br><span class="line">    endif ()</span><br><span class="line">    foreach (QT_LIB Core)</span><br><span class="line">        add_custom_command(TARGET $&#123;PROJECT_NAME&#125; POST_BUILD</span><br><span class="line">                COMMAND $&#123;CMAKE_COMMAND&#125; -E copy</span><br><span class="line">                &quot;$&#123;QT_INSTALL_PATH&#125;/bin/Qt6$&#123;QT_LIB&#125;$&#123;DEBUG_SUFFIX&#125;.dll&quot;</span><br><span class="line">                &quot;$&lt;TARGET_FILE_DIR:$&#123;PROJECT_NAME&#125;&gt;&quot;)</span><br><span class="line">    endforeach (QT_LIB)</span><br><span class="line">endif ()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="cpp-code">cpp code</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QCoreApplication&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QDebug&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="function">QCoreApplication <span class="title">a</span><span class="params">(argc, argv)</span></span>;</span><br><span class="line">    <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> QCoreApplication::<span class="built_in">exec</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>If exists problem, add follow environment to path</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Qt\6.7.2\mingw_64</span><br><span class="line">C:\Qt\Tools\QtCreator\bin</span><br></pre></td></tr></table></figure><h2 id="other-demo">other demo</h2><h3 id="clion-create-cpp-qt-demo">clion create cpp qt demo</h3><blockquote><p>follow pic<br><img src="/2024/08/09/cpp-qt-demo/clion-qt-create.png" class="lazyload placeholder" data-srcset="/2024/08/09/cpp-qt-demo/clion-qt-create.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p></blockquote><ul><li>é€šè¿‡uicåˆ›å»ºui_file.hå¤´æ–‡ä»¶, é…ç½®å¦‚å›¾<br><img src="/2024/08/09/cpp-qt-demo/uic_demo_cliion.png" class="lazyload placeholder" data-srcset="/2024/08/09/cpp-qt-demo/uic_demo_cliion.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></li></ul><h3 id="qt-ui-cpp-demo">qt ui cpp demo</h3><ul><li>cpp ui(main_ui.cpp)</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by Administrator on 2024/8/16 0016.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// You may need to build the project (run Qt uic code generator) to get &quot;ui_main_ui.h&quot; resolved</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;main_ui.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ui_main_ui.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">main_ui::<span class="built_in">main_ui</span>(QWidget *parent) :</span><br><span class="line">        <span class="built_in">QMainWindow</span>(parent), <span class="built_in">ui</span>(<span class="keyword">new</span> Ui::main_ui) &#123;</span><br><span class="line">    ui-&gt;<span class="built_in">setupUi</span>(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main_ui::~<span class="built_in">main_ui</span>() &#123;</span><br><span class="line">    <span class="keyword">delete</span> ui;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>main_ui.h</li></ul><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by Administrator on 2024/8/16 0016.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CPP_SOCKET_SERVE_MAIN_UI_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CPP_SOCKET_SERVE_MAIN_UI_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QMainWindow&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">QT_BEGIN_NAMESPACE</span><br><span class="line">namespace Ui &#123; <span class="class"><span class="keyword">class</span> <span class="title">main_ui</span>;</span> &#125;</span><br><span class="line">QT_END_NAMESPACE</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">main_ui</span> :</span> public QMainWindow &#123;</span><br><span class="line"><span class="comment">//Q_OBJECT å¦‚æœæ³¨é‡Šä¼šæŠ¥é”™</span></span><br><span class="line"></span><br><span class="line">public:</span><br><span class="line">    explicit <span class="title function_">main_ui</span><span class="params">(QWidget *parent = nullptr)</span>;</span><br><span class="line"></span><br><span class="line">    ~main_ui() override;</span><br><span class="line"></span><br><span class="line">private:</span><br><span class="line">    Ui::main_ui *ui;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//CPP_SOCKET_SERVE_MAIN_UI_H</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>main_ui.ui (qt ui)</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ui</span> <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">author</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">comment</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exportmacro</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">class</span>&gt;</span>main_ui<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">widget</span> <span class="attr">class</span>=<span class="string">&quot;QMainWindow&quot;</span> <span class="attr">name</span>=<span class="string">&quot;main_ui&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;geometry&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">rect</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">x</span>&gt;</span>0<span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">y</span>&gt;</span>0<span class="tag">&lt;/<span class="name">y</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">width</span>&gt;</span>400<span class="tag">&lt;/<span class="name">width</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">height</span>&gt;</span>300<span class="tag">&lt;/<span class="name">height</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">rect</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;windowTitle&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">string</span>&gt;</span>main_ui<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">widget</span> <span class="attr">class</span>=<span class="string">&quot;QWidget&quot;</span> <span class="attr">name</span>=<span class="string">&quot;centralwidget&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">widget</span> <span class="attr">class</span>=<span class="string">&quot;QMenuBar&quot;</span> <span class="attr">name</span>=<span class="string">&quot;menubar&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;geometry&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">rect</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">x</span>&gt;</span>0<span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">y</span>&gt;</span>0<span class="tag">&lt;/<span class="name">y</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">width</span>&gt;</span>400<span class="tag">&lt;/<span class="name">width</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">height</span>&gt;</span>17<span class="tag">&lt;/<span class="name">height</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">rect</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">widget</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">widget</span> <span class="attr">class</span>=<span class="string">&quot;QStatusBar&quot;</span> <span class="attr">name</span>=<span class="string">&quot;statusbar&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">widget</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pixmapfunction</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">connections</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ui</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>uic generate code (ui_main_ui.h)</li></ul><figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/********************************************************************************</span></span><br><span class="line"><span class="comment">** Form generated from reading UI file &#x27;main_ui.ui&#x27;</span></span><br><span class="line"><span class="comment">**</span></span><br><span class="line"><span class="comment">** Created by: Qt User Interface Compiler version 6.7.2</span></span><br><span class="line"><span class="comment">**</span></span><br><span class="line"><span class="comment">** WARNING! All changes made in this file will be lost when recompiling UI file!</span></span><br><span class="line"><span class="comment">********************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> UI_MAIN_UI_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UI_MAIN_UI_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QtCore/QVariant&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QtWidgets/QApplication&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QtWidgets/QMainWindow&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QtWidgets/QMenuBar&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QtWidgets/QStatusBar&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QtWidgets/QWidget&gt;</span></span></span><br><span class="line"></span><br><span class="line">QT_BEGIN_NAMESPACE</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ui_main_ui</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">public:</span><br><span class="line">    QWidget *centralwidget;</span><br><span class="line">    QMenuBar *menubar;</span><br><span class="line">    QStatusBar *statusbar;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> <span class="title function_">setupUi</span><span class="params">(QMainWindow *main_ui)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (main_ui-&gt;objectName().isEmpty())</span><br><span class="line">            main_ui-&gt;setObjectName(<span class="string">&quot;main_ui&quot;</span>);</span><br><span class="line">        main_ui-&gt;resize(<span class="number">400</span>, <span class="number">300</span>);</span><br><span class="line">        centralwidget = new QWidget(main_ui);</span><br><span class="line">        centralwidget-&gt;setObjectName(<span class="string">&quot;centralwidget&quot;</span>);</span><br><span class="line">        main_ui-&gt;setCentralWidget(centralwidget);</span><br><span class="line">        menubar = new QMenuBar(main_ui);</span><br><span class="line">        menubar-&gt;setObjectName(<span class="string">&quot;menubar&quot;</span>);</span><br><span class="line">        menubar-&gt;setGeometry(QRect(<span class="number">0</span>, <span class="number">0</span>, <span class="number">400</span>, <span class="number">17</span>));</span><br><span class="line">        main_ui-&gt;setMenuBar(menubar);</span><br><span class="line">        statusbar = new QStatusBar(main_ui);</span><br><span class="line">        statusbar-&gt;setObjectName(<span class="string">&quot;statusbar&quot;</span>);</span><br><span class="line">        main_ui-&gt;setStatusBar(statusbar);</span><br><span class="line"></span><br><span class="line">        retranslateUi(main_ui);</span><br><span class="line"></span><br><span class="line">        QMetaObject::connectSlotsByName(main_ui);</span><br><span class="line">    &#125; <span class="comment">// setupUi</span></span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> <span class="title function_">retranslateUi</span><span class="params">(QMainWindow *main_ui)</span></span><br><span class="line">    &#123;</span><br><span class="line">        main_ui-&gt;setWindowTitle(QCoreApplication::translate(<span class="string">&quot;main_ui&quot;</span>, <span class="string">&quot;main_ui&quot;</span>, nullptr));</span><br><span class="line">    &#125; <span class="comment">// retranslateUi</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">namespace Ui &#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">main_ui</span>:</span> public Ui_main_ui &#123;&#125;;</span><br><span class="line">&#125; <span class="comment">// namespace Ui</span></span><br><span class="line"></span><br><span class="line">QT_END_NAMESPACE</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// UI_MAIN_UI_H</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> cpp </tag>
            
            <tag> qt </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OpenCV build and install on ubuntu</title>
      <link href="/2024/07/09/opencv-build-use/"/>
      <url>/2024/07/09/opencv-build-use/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸‹è½½æ‰€éœ€åº“">ä¸‹è½½æ‰€éœ€åº“</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½ä¾èµ–åº“</span></span><br><span class="line"><span class="built_in">sudo</span> apt install -y build-essential cmake libopencv-dev git-lfs clang-format</span><br><span class="line"><span class="built_in">sudo</span> apt install g++ vim</span><br><span class="line"><span class="built_in">sudo</span> apt  install make unzip wget </span><br><span class="line">git lfs install</span><br><span class="line"><span class="built_in">sudo</span> apt-get install build-essential libgtk2.0-dev libgtk-3devlibavcodec-dev libavformat-dev libjpeg-dev libswscale-dev libtiff5-dev</span><br><span class="line"><span class="built_in">sudo</span> apt install git</span><br><span class="line"><span class="built_in">sudo</span> apt install libgtk2.0-dev  pkg-config</span><br><span class="line"><span class="built_in">sudo</span> apt install libcanberra-gtk-module</span><br></pre></td></tr></table></figure><h2 id="make-gui">make gui</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install cmake-qt-gui</span><br><span class="line">cmake-gui ..</span><br></pre></td></tr></table></figure><h2 id="ä¸‹è½½opencvå®‰è£…åŒ…">ä¸‹è½½opencvå®‰è£…åŒ…</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> git <span class="built_in">clone</span> https://codeload.github.com/opencv/opencv</span><br><span class="line">unzip opencv-4.10.0</span><br><span class="line"><span class="built_in">mkdir</span> build </span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line"><span class="comment"># remove old file</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">rm</span> -rf ./*</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> 777 -R ./*</span><br><span class="line"><span class="comment"># æ‰“å¼€opencv_contrib-3.4\modules\xfeatures2d \include\opencv2</span></span><br><span class="line"><span class="comment">#  å°†æ­¤å¤„æ–‡ä»¶å¤åˆ¶åˆ°opencvçš„å®‰è£…ä½ç½®opencv\build\include\opencv2</span></span><br><span class="line"><span class="comment">#  åœ¨æ­¤å¤„åˆ›å»ºæ–‡ä»¶å¤¹xfeatures2dï¼Œå°†xfeatures2d.hppå’Œxfeatures2dé‡Œçš„ä¸¤ä¸ªæ–‡ä»¶éƒ½å¤åˆ¶è¿‡å»ï¼Œé¿å…ä»¥åå› æ²¡æœ‰nonfree.hppæ–‡ä»¶å‡ºç°é”™è¯¯ã€‚</span></span><br><span class="line"><span class="comment"># mkdir ./opencv/build/include/opencv2/xfeatures2d</span></span><br><span class="line"><span class="comment"># cp ./opencv-contrib-3.4.16/modules/xfeatures2d/include/opencv2 ./build/include/opencv/</span></span><br><span class="line"><span class="comment">#   å¼•ç”¨#include&lt;opencv2/xfeatures2d/xfeatures2d.hpp&gt; å¦‚æœæ²¡æœ‰åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œå°†xfeatures2d.hppç›´æ¥æ”¾åœ¨opencv2ä¸‹ï¼Œå¼•ç”¨æ—¶ç›´æ¥å†™ä¸º#include&lt;opencv2/xfeatures2.hpp&gt;</span></span><br><span class="line"><span class="comment"># sudo cp -r ./* /usr/local/include/opencv2/</span></span><br><span class="line"><span class="built_in">cd</span> ~/Desktop/calib/calib/third_party/opencv/include/opencv2/</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> -r ./xfeatures2d.hpp /usr/local/include/opencv2/</span><br></pre></td></tr></table></figure><h2 id="ç¼–è¯‘">ç¼–è¯‘</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cmake ../opencv-4.10.0 -DCMAKE_BUILD_TYPE=RELEASE -DCMAKE_INSTALL_PREFIX=/usr/local <span class="comment"># new</span></span><br><span class="line">make </span><br><span class="line"><span class="built_in">sudo</span> make install</span><br><span class="line"><span class="comment"># cmake ../opencv-version -DCMAKE_BUILD_TYPE=RELEASE -DCMAKE_INSTALL_PREFIX=/usr/local </span></span><br></pre></td></tr></table></figure><h2 id="build-success">build success</h2><p><img src="/2024/07/09/opencv-build-use/opencv-build-success.png" class="lazyload placeholder" data-srcset="/2024/07/09/opencv-build-use/opencv-build-success.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="å®‰è£…">å®‰è£…</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  ç¼–è¯‘å®‰è£…</span></span><br><span class="line"><span class="built_in">sudo</span> make install</span><br><span class="line"><span class="comment"># ç¼–è¯‘</span></span><br><span class="line">make -j</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æµ‹opencvæ˜¯å¦å®‰è£… ä»¥åŠæŸ¥è¯¢å¯¹åº”ç‰ˆæœ¬å·</span></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç‰ˆæœ¬,æœ‰è¾“å‡º4.5.2å°±æˆåŠŸ</span></span><br><span class="line">pkg-config --modversion opencv4</span><br><span class="line"><span class="comment"># æŸ¥çœ‹åº“</span></span><br><span class="line">pkg-config --libs opencv4</span><br></pre></td></tr></table></figure><h2 id="æˆåŠŸæ•ˆæœ">æˆåŠŸæ•ˆæœ</h2><p><img src="/2024/07/09/opencv-build-use/opencv-install-success.png" class="lazyload placeholder" data-srcset="/2024/07/09/opencv-build-use/opencv-install-success.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="other">other</h2><ul><li>1.cmake</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">wget https://cmake.org/files/v3.22/cmake-3.22.1.tar.gz</span><br><span class="line"><span class="built_in">sudo</span> apt-get install libssl-dev</span><br><span class="line">tar -xvzf cmake-3.22.1.tar.gz</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> 777 ./configure</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line"><span class="built_in">sudo</span> make install</span><br><span class="line"><span class="built_in">sudo</span> update-alternatives --install /usr/bin/cmake cmake /usr/local/bin/cmake 1 --force</span><br><span class="line">cmake --version</span><br></pre></td></tr></table></figure><ul><li>2.Eigen3</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://gitlab.com/libeigen/eigen/-/releases/3.4.0</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> 777 -R ./*</span><br><span class="line"><span class="built_in">sudo</span> apt-get install libeigen3-dev</span><br><span class="line"><span class="built_in">mkdir</span> build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake ../</span><br><span class="line"><span class="built_in">sudo</span> make install</span><br></pre></td></tr></table></figure><ul><li>3.Sophus</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> git <span class="built_in">clone</span> https://github.com/strasdat/Sophus.git</span><br><span class="line"><span class="comment"># https://gitee.com/SimonLeung/Sophus</span></span><br><span class="line">unzip Sophus.zip</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> 777 -R ./*</span><br><span class="line"><span class="built_in">cd</span> Sophus</span><br><span class="line">git checkout a621ff    <span class="comment">#åˆ‡æ¢ä¸ºéæ¨¡æ¿ç±»çš„å†å²ç‰ˆæœ¬</span></span><br><span class="line"><span class="comment"># git config --global --add safe.directory /home/czq/Desktop/calib/lib/Sophus</span></span><br><span class="line"><span class="built_in">cd</span> Sophus</span><br><span class="line"><span class="built_in">mkdir</span> build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">vim ../sophus/so2.cpp</span><br><span class="line"><span class="comment"># unit_complex_.real() = 1.; -&gt; unit_complex_.real(1.);</span></span><br><span class="line"><span class="comment"># unit_complex_.imag() = 0.; -&gt; unit_complex_.imag(0.);</span></span><br><span class="line">cmake ..  </span><br><span class="line">make</span><br><span class="line"><span class="built_in">sudo</span> make install</span><br></pre></td></tr></table></figure><ul><li><ol start="4"><li>g2o</li></ol></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> git <span class="built_in">clone</span> https://github.com/RainerKuemmerle/g2o/archive/refs/tags/20230223_git.zip</span><br><span class="line">unzip 20230223_git.zip</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> 777 -R ./*</span><br><span class="line"><span class="built_in">cd</span> 20230223_git</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake ..  </span><br><span class="line">make</span><br><span class="line"><span class="built_in">sudo</span> make install</span><br></pre></td></tr></table></figure><h2 id="other-2">other</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vim ./include/file.cpp</span></span><br><span class="line"><span class="comment">// from:</span></span><br><span class="line">  cv::Ptr&lt;cv::FeatureDetector&gt;     pDetector   = cv::xfeatures2d::SIFT::<span class="built_in">create</span>();</span><br><span class="line">  cv::Ptr&lt;cv::DescriptorExtractor&gt; pDescriptor = cv::xfeatures2d::SIFT::<span class="built_in">create</span>();</span><br><span class="line"><span class="comment">// to:</span></span><br><span class="line">  cv::Ptr&lt;cv::FeatureDetector&gt;     pDetector   = cv::SIFT::<span class="built_in">create</span>();</span><br><span class="line">  cv::Ptr&lt;cv::DescriptorExtractor&gt; pDescriptor = cv::SIFT::<span class="built_in">create</span>();</span><br></pre></td></tr></table></figure><h2 id="debug-model-lib">debug model lib</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install libgtk2.0-dev  pkg-config</span><br><span class="line"><span class="comment"># rebuild opencv</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install libgoogle-glog-dev</span><br></pre></td></tr></table></figure><h2 id="build-win-exe-on-unbuntu">build win exe on unbuntu</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># CMake</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install cmake</span><br><span class="line"><span class="comment"># google-glog + gflags</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install libgoogle-glog-dev libgflags-dev</span><br><span class="line"><span class="comment"># Use ATLAS for BLAS &amp; LAPACK</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install libatlas-base-dev</span><br><span class="line"><span class="comment"># Eigen3</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install libeigen3-dev</span><br><span class="line"><span class="comment"># SuiteSparse (optional)</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install libsuitesparse-dev</span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">ln</span> -s /usr/include/eigen3/Eigen /usr/include/Eigen</span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> -r /usr/include/eigen3/Eigen /usr/include</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> -r /usr/include/eigen3/signature_of_eigen3_matrix_library /usr/include</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> -r /usr/include/eigen3/unsupported /usr/include</span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> apt install liblapack-dev libsuitesparse-dev libcxsparse3 libgflags-dev libgoogle-glog-dev libgtest-dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># ceres</span></span><br><span class="line"><span class="built_in">sudo</span> git <span class="built_in">clone</span> https://github.com/ceres-solver/ceres-solver</span><br><span class="line"><span class="comment"># use follow link tag or release package</span></span><br><span class="line"><span class="comment"># https://github.com/ceres-solver/ceres-solver/archive/refs/tags/2.2.0.zip</span></span><br><span class="line"><span class="built_in">mkdir</span> build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake ..</span><br><span class="line">make -j8</span><br><span class="line"><span class="built_in">sudo</span> make install</span><br></pre></td></tr></table></figure><h1>open gui on ubuntu</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nautilus /path/to/directory</span><br></pre></td></tr></table></figure><h2 id="See">See</h2><ul><li><ol><li><a href="https://blog.csdn.net/weixin_40649372/article/details/124979958">https://blog.csdn.net/weixin_40649372/article/details/124979958</a></li></ol></li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> cpp </tag>
            
            <tag> opencv </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>npmå®‰è£…æ—¶å‡ºç°æ‹‰å–gitä»“åº“é”™è¯¯é—®é¢˜ä¿®å¤æªæ–½ç ”ç©¶</title>
      <link href="/2024/07/05/git-respority-error/"/>
      <url>/2024/07/05/git-respority-error/</url>
      
        <content type="html"><![CDATA[<h1>é”™è¯¯å†…å®¹</h1><h2 id="é”™è¯¯è¯¦æƒ…">é”™è¯¯è¯¦æƒ…</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">czq@czq-virtual-machine:~/Desktop/blog/hexo-bamboo-blog$ sudo npm install</span><br><span class="line">npm error code 128</span><br><span class="line">npm error An unknown git error occurred</span><br><span class="line">npm error command git --no-replace-objects ls-remote ssh://git@github.com/CodeFalling/hexo-asset-image.git</span><br><span class="line">npm error git@github.com: Permission denied (publickey).</span><br><span class="line">npm error fatal: Could not read from remote repository.</span><br><span class="line">npm error</span><br><span class="line">npm error Please make sure you have the correct access rights</span><br><span class="line">npm error and the repository exists.</span><br><span class="line"></span><br><span class="line">npm error A complete log of this run can be found in: /root/.npm/_logs/2024-07-05T01_37_00_386Z-debug-0.log</span><br></pre></td></tr></table></figure><h2 id="How-to-fix-the-prolem">How to fix the prolem</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C mail@qq.com</span><br><span class="line"><span class="built_in">cat</span> ~/.ssh/id_res.pub</span><br><span class="line"><span class="comment"># add rsa to github.com </span></span><br></pre></td></tr></table></figure><h2 id="switch-node-version-to-point">switch node version to point</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install npm</span><br><span class="line"><span class="built_in">sudo</span> npm install n -g</span><br><span class="line"><span class="built_in">sudo</span> n lts</span><br><span class="line"><span class="built_in">sudo</span> node -v</span><br></pre></td></tr></table></figure><h2 id="switch-mirror-to-tb-mirror">switch mirror to tb mirror</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm config <span class="built_in">set</span> registry http://registry.npm.taobao.org/</span><br><span class="line">npm config get registry</span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> git </tag>
            
            <tag> nodejs </tag>
            
            <tag> npm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ¯•ä¸šè®¾è®¡é¢„è§ˆ</title>
      <link href="/2024/06/25/graduate-design/"/>
      <url>/2024/06/25/graduate-design/</url>
      
        <content type="html"><![CDATA[<h2 id="åŸæ–‡å¦‚ä¸‹">åŸæ–‡å¦‚ä¸‹:</h2><br><!-- <div class="row">    <embed src="https://caozhaoqi.github.io/2024/06/25/graduate-design/gd_final.pdf" width="100%" height="550" type="application/pdf"></div> -->æš‚æ—¶å¤±æ•ˆï¼Œåœæ­¢è®¿é—®ï¼ï¼ï¼<br>---2024/08/21---<br><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> doc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è½¯ä»¶æµ‹è¯•æŠ¥å‘Š</title>
      <link href="/2024/06/25/test-case-result/"/>
      <url>/2024/06/25/test-case-result/</url>
      
        <content type="html"><![CDATA[<h2 id="ç”¨æˆ·">ç”¨æˆ·</h2><p>æœ¬æ–‡æ¡£ç”¨äºæµ‹è¯•ã€å¼€å‘äººå‘˜å¡«å†™æµ‹è¯•è¿‡ç¨‹ç»“æœã€‚</p><h2 id="å®šä¹‰">å®šä¹‰</h2><blockquote><p>è½¯ä»¶æµ‹è¯•ï¼šåœ¨è§„å®šçš„æ¡ä»¶ä¸‹å¯¹ç¨‹åºè¿›è¡Œæ“ä½œï¼Œä»¥å‘ç°ç¨‹åºé”™è¯¯ï¼Œè¡¡é‡è½¯ä»¶è´¨é‡ï¼Œå¹¶å¯¹å…¶æ˜¯å¦èƒ½æ»¡è¶³è®¾è®¡è¦æ±‚è¿›è¡Œè¯„ä¼°çš„è¿‡ç¨‹</p></blockquote><h2 id="æµ‹è¯•å¯¹è±¡">æµ‹è¯•å¯¹è±¡</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">åŠŸèƒ½ç‚¹å­åŠŸèƒ½å†…å®¹æè¿°</span><br><span class="line">ç‰©æ–™ç»´æŠ¤ç‰©æ–™æ¸…å•ç‰©æ–™æ¸…å•çš„ç®¡ç†</span><br></pre></td></tr></table></figure><h2 id="æµ‹è¯•é˜¶æ®µ">æµ‹è¯•é˜¶æ®µ</h2><ul><li>å•å…ƒæµ‹è¯•</li><li>é›†æˆæµ‹è¯•</li><li>ç³»ç»Ÿæµ‹è¯•</li><li>å›å½’æµ‹è¯•</li></ul><h2 id="æµ‹è¯•å·¥å…·">æµ‹è¯•å·¥å…·</h2><p>åŸºäºç”¨å‹yonBuilderå¹³å°è¿›è¡Œæµ‹è¯•ã€‚</p><h1>æµ‹è¯•æ¦‚è¦</h1><h2 id="è¿›åº¦å›é¡¾">è¿›åº¦å›é¡¾</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æµ‹è¯•é¡¹ç›®æµ‹è¯•å†…å®¹æˆåŠŸæ¬¡æ•°æµ‹è¯•æ¬¡æ•°æµ‹è¯•æ—¶é—´å›å½’æµ‹è¯•æ˜¯å¦æ­£å¸¸æ˜¯å¦ç¬¦åˆé¢„æœŸå¤‡æ³¨</span><br><span class="line">åŸæ–™æ•°æ®ç®¡ç†åŠŸèƒ½æ•°æ®æ’å…¥352021/8/25æ˜¯æ˜¯å¼•ç”¨é”™è¯¯</span><br></pre></td></tr></table></figure><h2 id="æµ‹è¯•æ‰§è¡Œ">æµ‹è¯•æ‰§è¡Œ</h2><blockquote><p>æ­¤æ¬¡æµ‹è¯•ä¸¥æ ¼æŒ‰ç…§é¡¹ç›®è®¡åˆ’å’Œæµ‹è¯•è®¡åˆ’æ‰§è¡Œï¼ŒæŒ‰æ—¶å®Œæˆäº†æµ‹è¯•è®¡åˆ’è§„å®šçš„æµ‹è¯•å¯¹è±¡çš„æµ‹è¯•ã€‚é’ˆå¯¹æµ‹è¯•è®¡åˆ’è§„å®šçš„æµ‹è¯•ç­–ç•¥ï¼Œåœ¨æµ‹è¯•æ‰§è¡Œä¸­éƒ½æœ‰ä½“ç°ï¼Œåœ¨æµ‹è¯•æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¾æ®æµ‹è¯•è®¡åˆ’å’Œæµ‹è¯•ç”¨ä¾‹ï¼Œå¯¹ç³»ç»Ÿè¿›è¡Œäº†å®Œæ•´çš„æµ‹è¯•</p></blockquote><h2 id="æµ‹è¯•ç”¨ä¾‹">æµ‹è¯•ç”¨ä¾‹</h2><h3 id="åŠŸèƒ½æ€§">åŠŸèƒ½æ€§</h3><blockquote><p>æµ‹è¯•ç³»ç»Ÿä¸­æ¯ä¸ªåŠŸèƒ½ï¼Œç¡®ä¿ç³»ç»ŸåŠŸèƒ½è¿è¡Œå®Œæ•´ï¼Œç•Œé¢æ˜¾ç¤ºæ— è¯¯ï¼Œæ•°æ®æ“ä½œæ­£å¸¸ã€‚</p></blockquote><h3 id="æ˜“ç”¨æ€§">æ˜“ç”¨æ€§</h3><blockquote><p>æ“ä½œæŒ‰é’®æç¤ºä¿¡æ¯æ­£ç¡®æ€§ï¼Œä¸€è‡´æ€§ï¼Œå¯ç†è§£æ€§</p></blockquote><h2 id="æµ‹è¯•ç¯å¢ƒ">æµ‹è¯•ç¯å¢ƒ</h2><h3 id="è½¯ç¡¬ä»¶ç¯å¢ƒ">è½¯ç¡¬ä»¶ç¯å¢ƒ</h3><h4 id="è½¯ä»¶ç¯å¢ƒ">è½¯ä»¶ç¯å¢ƒ</h4><blockquote><p>åŸºäºyonBuilderå¹³å°æ‰‹åŠ¨æµ‹è¯•ã€‚</p></blockquote><h4 id="ç¡¬ä»¶ç¯å¢ƒ">ç¡¬ä»¶ç¯å¢ƒ</h4><p>pcÃ—1</p><h2 id="æµ‹è¯•ç»“æœ">æµ‹è¯•ç»“æœ</h2><h3 id="Bugè¶‹åŠ¿å›¾">Bugè¶‹åŠ¿å›¾</h3><blockquote><p>å¦‚å›¾æ‰€ç¤º</p></blockquote><p><img src="/2024/06/25/test-case-result/a.png" class="lazyload placeholder" data-srcset="/2024/06/25/test-case-result/a.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="Bugä¼˜å…ˆçº§åˆ†å¸ƒ">Bugä¼˜å…ˆçº§åˆ†å¸ƒ</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">æµ‹è¯•é¡¹ç›®æµ‹è¯•å†…å®¹å¤‡æ³¨ä¼˜å…ˆçº§å…·ä½“æè¿°</span><br><span class="line">åŸæ–™æ•°æ®ç®¡ç†åŠŸèƒ½æ•°æ®æ’å…¥å¼•ç”¨é”™è¯¯P0åŠŸèƒ½å®ç°é”™è¯¯</span><br><span class="line">æ¯ä»¶ç»“æ„ç®¡ç†åŠŸèƒ½æ•°æ®æ’å…¥å¼•ç”¨é”™è¯¯P0åŠŸèƒ½å®ç°é”™è¯¯</span><br><span class="line">æ•°æ®æŸ¥è¯¢æ•°æ®æ ¼å¼æ˜¾ç¤ºå¼‚å¸¸P1æœªè¾¾åˆ°é¢„æœŸç›®çš„</span><br><span class="line">è®¢å•ç®¡ç†åŠŸèƒ½æ•°æ®æ’å…¥æ—¥æœŸæ— æ³•æ’å…¥P0åŠŸèƒ½å®ç°é”™è¯¯</span><br><span class="line">æ•°æ®æŸ¥è¯¢æ—¥æœŸæ˜¾ç¤ºå¼‚å¸¸P2éœ€æ±‚ä¸ç¬¦</span><br><span class="line">è®¡åˆ’è¯„ä¼°åŠŸèƒ½æ•°æ®æ’å…¥æ—¶é—´æ— æ³•æ’å…¥P0åŠŸèƒ½å®ç°é”™è¯¯</span><br><span class="line">æ•°æ®æŸ¥è¯¢åˆ—è¡¨é¡µé¢å’Œä¸»é¡µé¢æ•°æ®æœªå…³è”P0åŠŸèƒ½é—®é¢˜</span><br><span class="line">ç‰©æ–™æ¸…å•ç®¡ç†åŠŸèƒ½æ•°æ®æ’å…¥å‚è€ƒé…ç½®é”™è¯¯P0åŠŸèƒ½å®ç°é”™è¯¯</span><br><span class="line">æ•°æ®æŸ¥è¯¢ç§»åŠ¨ç«¯æ˜¾ç¤ºé”™è¯¯P1æœªè¾¾åˆ°é¢„æœŸç›®çš„</span><br></pre></td></tr></table></figure><h2 id="é—®é¢˜ç±»å‹åˆ†å¸ƒ">é—®é¢˜ç±»å‹åˆ†å¸ƒ</h2><blockquote><p>é—®é¢˜ç±»å‹åˆ†å¸ƒå¦‚ä¸‹æ‰€ç¤ºï¼š</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">æ—¶é—´é¡¹ç›®bugæ•°ç›®</span><br><span class="line">8æœˆ25æ—¥åŸæ–™ç®¡ç†1</span><br><span class="line">8æœˆ25æ—¥æ¯ä»¶ç»“æ„ç®¡ç†2</span><br><span class="line">8æœˆ25æ—¥éœ€æ±‚ç®¡ç†0</span><br><span class="line">8æœˆ26æ—¥è®¢å•ç®¡ç†3</span><br><span class="line">8æœˆ26æ—¥ç»„ç»‡ä¿¡æ¯ç®¡ç†0</span><br><span class="line">8æœˆ26æ—¥è®¡åˆ’è¯„ä¼°2</span><br><span class="line">8æœˆ26æ—¥è®¡åˆ’æ–¹æ¡ˆ0</span><br><span class="line">8æœˆ26æ—¥è®¡åˆ’ç­–ç•¥1</span><br><span class="line">8æœˆ27æ—¥ç‰©æ–™æ¸…å•2</span><br><span class="line">8æœˆ27æ—¥å­ä»¶ç”¨é€”2</span><br><span class="line">8æœˆ27æ—¥å®¢æˆ·ä¿¡æ¯ç®¡ç†0</span><br></pre></td></tr></table></figure><h2 id="æµ‹è¯•ç»“è®º">æµ‹è¯•ç»“è®º</h2><h3 id="åŠŸèƒ½æ€§-2">åŠŸèƒ½æ€§</h3><blockquote><p>æµ‹è¯•çš„è½¯ä»¶åŠŸèƒ½åŸºæœ¬ç¬¦åˆé¢„æœŸã€‚</p></blockquote><h3 id="æ˜“ç”¨æ€§-2">æ˜“ç”¨æ€§</h3><blockquote><p>è½¯ä»¶æ“ä½œé€»è¾‘ç¬¦åˆæ™®éç”¨æˆ·ç›´è§‰ï¼Œå…·æœ‰ç®€å•ã€æ˜“ç”¨ç­‰ç‰¹ç‚¹ã€‚</p></blockquote><h3 id="å¯é æ€§">å¯é æ€§</h3><blockquote><p>æš‚æ— </p></blockquote><h3 id="å…¼å®¹æ€§">å…¼å®¹æ€§</h3><blockquote><p>è½¯ä»¶é€‚é…å¤šä¸ªå¹³å°ï¼ŒåŒ…æ‹¬appï¼Œwebå…·æœ‰ä¸€å®šå…¼å®¹æ€§ã€‚</p></blockquote><h3 id="å®‰å…¨æ€§">å®‰å…¨æ€§</h3><blockquote><p>å¯¹äºç”¨æˆ·ä¿¡æ¯è¿›è¡ŒåŠ å¯†å­˜å‚¨ï¼Œå…·æœ‰ä¸€å®šå®‰å…¨æ€§ã€‚</p></blockquote><h2 id="æµ‹è¯•åˆ†æ">æµ‹è¯•åˆ†æ</h2><h3 id="è¦†ç›–ç‡">è¦†ç›–ç‡</h3><blockquote><p>æœ¬è½¯ä»¶æµ‹è¯•åŒ…å«å·²å®ç°çš„æ‰€æœ‰åŠŸèƒ½ã€‚</p></blockquote><h3 id="é—ç•™ç¼ºé™·çš„å½±å“">é—ç•™ç¼ºé™·çš„å½±å“</h3><blockquote><p>é—ç•™bugåŸºæœ¬ä¸ºP4çº§åˆ«çš„å½±å“ï¼Œä¸å½±å“ç”¨æˆ·çš„åŸºæœ¬ä½¿ç”¨ã€‚</p></blockquote><h3 id="å»ºè®®">å»ºè®®</h3><blockquote><p>å¢åŠ æ–°çš„åŠŸèƒ½ï¼Œå®Œå–„è½¯ä»¶ã€‚</p></blockquote><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> doc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è½¯ä»¶æµ‹è¯•ç”¨ä¾‹</title>
      <link href="/2024/06/25/test-case/"/>
      <url>/2024/06/25/test-case/</url>
      
        <content type="html"><![CDATA[<h2 id="å®šä¹‰">å®šä¹‰</h2><blockquote><p>æµ‹è¯•ç”¨ä¾‹ï¼šæŒ‡å¯¹ä¸€é¡¹ç‰¹å®šçš„è½¯ä»¶äº§å“è¿›è¡Œæµ‹è¯•ä»»åŠ¡çš„æè¿°ï¼Œä½“ç°æµ‹è¯•æ–¹æ¡ˆã€æ–¹æ³•ã€æŠ€æœ¯å’Œç­–ç•¥ã€‚å…¶å†…å®¹åŒ…æ‹¬æµ‹è¯•ç›®æ ‡ã€æµ‹è¯•ç¯å¢ƒã€è¾“å…¥æ•°æ®ã€æµ‹è¯•æ­¥éª¤ã€é¢„æœŸç»“æœã€æµ‹è¯•è„šæœ¬ç­‰ï¼Œæœ€ç»ˆå½¢æˆæ–‡æ¡£ã€‚</p></blockquote><h2 id="æµ‹è¯•åˆ†ç±»">æµ‹è¯•åˆ†ç±»</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ä¸»è¦åˆ†ä¸ºï¼š</span><br><span class="line">æµ‹è¯•æ–¹æ³•åˆ†ç±»ï¼šç™½ç›’æµ‹è¯•ã€é»‘ç›’æµ‹è¯•ã€‚</span><br><span class="line">æµ‹è¯•è¿‡ç¨‹ï¼š</span><br></pre></td></tr></table></figure><ul><li>å•å…ƒæµ‹è¯•</li><li>é›†æˆæµ‹è¯•</li><li>ç³»ç»Ÿæµ‹è¯•</li><li>å›å½’æµ‹è¯•</li></ul><h3 id="æµ‹è¯•ç”¨ä¾‹åˆ†ç±»">æµ‹è¯•ç”¨ä¾‹åˆ†ç±»</h3><blockquote><p>åŒ…æ‹¬ä»¥ä¸‹éƒ¨åˆ†ï¼š</p></blockquote><ul><li>æœ‰æ•ˆç­‰ä»·ç±»</li><li>æ— æ•ˆç­‰ä»·ç±»</li></ul><h3 id="æµ‹è¯•ç”¨ä¾‹ç¼–å†™æ–¹æ¡ˆ">æµ‹è¯•ç”¨ä¾‹ç¼–å†™æ–¹æ¡ˆ</h3><h4 id="ç¼–å†™åŸåˆ™">ç¼–å†™åŸåˆ™</h4><blockquote><p>å¿…é¡»å…·æœ‰ä»¥ä¸‹å±æ€§</p></blockquote><ul><li>æµ‹è¯•é¡¹æè¿°</li><li>è¾“å…¥å€¼</li><li>è¾“å‡ºå€¼</li></ul><h4 id="æ³¨æ„é—®é¢˜">æ³¨æ„é—®é¢˜</h4><blockquote><p>æ³¨æ„ä»¥ä¸‹é—®é¢˜ï¼š</p></blockquote><ul><li>å¯¹äºä¸€ä¸ªåŠŸèƒ½ç‚¹æ‰§è¡Œå¤šä¸ªæµ‹è¯•ç”¨ä¾‹ï¼›</li><li>åŠæ—¶æ€»ç»“å­˜åœ¨çš„é—®é¢˜ã€‚</li></ul><h2 id="æµ‹è¯•ç”¨ä¾‹">æµ‹è¯•ç”¨ä¾‹</h2><h3 id="åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹">åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹</h3><blockquote><p>åŠŸèƒ½æµ‹è¯•è´Ÿè´£æœ¬ç³»ç»Ÿæ‰€æœ‰åŠŸèƒ½çš„æµ‹è¯•ã€‚</p></blockquote><h4 id="è¢«æµ‹å•å…ƒä»‹ç»">è¢«æµ‹å•å…ƒä»‹ç»</h4><blockquote><p>ä¸»è¦æµ‹è¯•å•å…ƒå¦‚ä¸‹æ‰€ç¤ºã€‚</p></blockquote><p>åŠŸèƒ½ç‚¹å­åŠŸèƒ½å†…å®¹æè¿°<br>ç‰©æ–™ç»´æŠ¤ç‰©æ–™æ¸…å•ç‰©æ–™æ¸…å•çš„ç®¡ç†</p><h3 id="æµ‹è¯•èŒƒå›´ä¸ç›®çš„">æµ‹è¯•èŒƒå›´ä¸ç›®çš„</h3><ul><li>æµ‹è¯•èŒƒå›´ï¼šåŒ…æ‹¬ä½†ä¸é™äºè¡¨æ‰€ç¤ºçš„åŠŸèƒ½ç‚¹ï¼›</li><li>æµ‹è¯•ç›®çš„ï¼šç¡®ä¿è½¯ä»¶è¿è¡Œæ›´åŠ ç¨³å¥ï¼Œæœ€ç»ˆç¬¦åˆå®¢æˆ·è¦æ±‚ã€‚</li></ul><h4 id="æµ‹è¯•ç¯å¢ƒåŠå·¥å…·æè¿°">æµ‹è¯•ç¯å¢ƒåŠå·¥å…·æè¿°</h4><blockquote><p>æœ¬è½¯ä»¶åŸºäºç”¨å‹yonBuilderå¹³å°æµ‹è¯•ï¼Œé‡‡å–æ‰‹å·¥ç‚¹å‡»è¾“å…¥æ•°æ®æ–¹å¼è¿›è¡Œæµ‹è¯•ã€‚</p></blockquote><h4 id="æµ‹è¯•é©±åŠ¨ç¨‹åºè®¾è®¡">æµ‹è¯•é©±åŠ¨ç¨‹åºè®¾è®¡</h4><blockquote><p>postmanã€apifoxç­‰</p></blockquote><h2 id="æ€§èƒ½æµ‹è¯•ç”¨ä¾‹">æ€§èƒ½æµ‹è¯•ç”¨ä¾‹</h2><blockquote><p>æ€§èƒ½æµ‹è¯•ï¼Œä¸»è¦ç”¨äºæµ‹è¯•è½¯ä»¶æ€§èƒ½æ˜¯å¦è¾¾åˆ°é¢„å®šè¦æ±‚ã€‚</p></blockquote><h2 id="å¹¶å‘æµ‹è¯•ç”¨ä¾‹">å¹¶å‘æµ‹è¯•ç”¨ä¾‹</h2><h3 id="è¢«æµ‹å•å…ƒä»‹ç»-2">è¢«æµ‹å•å…ƒä»‹ç»</h3><blockquote><p>å¯¹äºåŠŸèƒ½çš„æ¯ä¸ªé¡µé¢è¿›è¡Œå¹¶å‘æ€§æµ‹è¯•ï¼Œç¡®ä¿ç³»ç»Ÿä¸å´©æºƒã€‚</p></blockquote><h4 id="æµ‹è¯•èŒƒå›´ä¸ç›®çš„-2">æµ‹è¯•èŒƒå›´ä¸ç›®çš„</h4><ul><li>æµ‹è¯•èŒƒå›´ï¼šåŒ…æ‹¬è¡¨2-1æ‰€ç¤ºæ‰€æœ‰å†…å®¹ã€‚</li><li>æµ‹è¯•ç›®çš„ï¼šç¡®ä¿å¤šä¸ªç”¨æˆ·è®¿é—®æ—¶ç³»ç»Ÿä¸å´©æºƒã€‚</li></ul><h4 id="æµ‹è¯•ç¯å¢ƒåŠå·¥å…·æè¿°-2">æµ‹è¯•ç¯å¢ƒåŠå·¥å…·æè¿°</h4><blockquote><p>é€šè¿‡å¤šä¸ªè´¦å·åŒæ—¶è®¿é—®ä¸€ä¸ªé¡µé¢æµ‹è¯•ç³»ç»Ÿå¹¶å‘æ€§</p></blockquote><h4 id="æµ‹è¯•é©±åŠ¨ç¨‹åºè®¾è®¡-2">æµ‹è¯•é©±åŠ¨ç¨‹åºè®¾è®¡</h4><h2 id="é›†æˆæµ‹è¯•ç”¨ä¾‹">é›†æˆæµ‹è¯•ç”¨ä¾‹</h2><blockquote><p>ç³»ç»ŸåŠŸèƒ½æµ‹è¯•</p></blockquote><h2 id="æµ‹è¯•æ€»ç»“">æµ‹è¯•æ€»ç»“</h2><h3 id="æµ‹è¯•ç»“è®º">æµ‹è¯•ç»“è®º</h3><p>æµ‹è¯•è¾¾åˆ°äº†é¢„æœŸç›®çš„ï¼ŒåŒæ—¶è½¯ä»¶ä¹Ÿæš´éœ²å‡ºäº†ä¸€äº›é—®é¢˜ã€‚</p><h3 id="é—ç•™é—®é¢˜">é—ç•™é—®é¢˜</h3><blockquote><p>æ€»ç»“æš‚æ—¶æœªè§£å†³é—®é¢˜</p></blockquote><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> doc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ¦‚è¦è®¾è®¡</title>
      <link href="/2024/06/25/Conceptual-design/"/>
      <url>/2024/06/25/Conceptual-design/</url>
      
        <content type="html"><![CDATA[<h2 id="åŸºç¡€å®šä¹‰">åŸºç¡€å®šä¹‰</h2><ul><li>æ•°æ®ç»“æ„ï¼šç‰¹æŒ‡ç»“æ„æ€§æ•°æ®å…ƒç´ çš„é›†åˆï¼›</li><li>é€»è¾‘ç»“æ„ï¼šç‰¹æŒ‡æ•°æ®çš„é€»è¾‘ç»“æ„åœ¨è®¡ç®—æœºå­˜å‚¨ç©ºé—´çš„å­˜å‚¨å½¢å¼ï¼Œå¦‚ï¼šé“¾å¼å­˜å‚¨ã€å“ˆå¸Œå­˜å‚¨ï¼›</li><li>ç‰©ç†ç»“æ„ï¼šç‰¹æŒ‡æ•°æ®ç»“æ„ä¸­çš„ç‰©ç†ç»“æ„ï¼Œå…¶è¿‡ç¨‹ä¸ºå°†æ¦‚å¿µæ¨¡å‹è½¬æ¢ä¸ºæ•°æ®åº“æ”¯æŒçš„æ•°æ®æ¨¡å‹ï¼›</li></ul><h2 id="æ€»ä½“è®¾è®¡">æ€»ä½“è®¾è®¡</h2><h3 id="éœ€æ±‚è§„å®š">éœ€æ±‚è§„å®š</h3><p>éœ€æ»¡è¶³ä»¥ä¸‹éœ€æ±‚ï¼š</p><ul><li>é¡µé¢å“åº”æ—¶é—´å°äº5ç§’ï¼›</li><li>æ•°æ®å­˜å‚¨å®‰å…¨ã€ç³»ç»Ÿå¯é æ€§é«˜ã€‚</li></ul><h3 id="è¿è¡Œç¯å¢ƒ">è¿è¡Œç¯å¢ƒ</h3><blockquote><p>ç³»ç»Ÿè¿è¡Œç¯å¢ƒå¦‚ä¸‹æ‰€ç¤ºï¼š</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">æ“ä½œç³»ç»ŸAndroid 6.0åŠä»¥ä¸Šæˆ–IOS 9åŠä»¥ä¸Š</span><br><span class="line">CPUä¸»é¢‘2.0GHz</span><br><span class="line">å†…å­˜å¤§äº2GB</span><br><span class="line">æµè§ˆå™¨Chromeã€Edgeç­‰</span><br><span class="line">å¤–éƒ¨å­˜å‚¨å‰©ä½™ç©ºé—´å¤§äº1GB</span><br></pre></td></tr></table></figure><h3 id="å¤„ç†æµç¨‹">å¤„ç†æµç¨‹</h3><blockquote><p>æœ¬ç³»ç»Ÿå¤§è‡´å¤„ç†æµç¨‹å¦‚å›¾æ‰€ç¤º</p></blockquote><p><img src="/2024/06/25/Conceptual-design/lc.png" class="lazyload placeholder" data-srcset="/2024/06/25/Conceptual-design/lc.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h3 id="ç³»ç»Ÿç»“æ„">ç³»ç»Ÿç»“æ„</h3><p>æœ¬ç³»ç»Ÿç»“æ„å¦‚å›¾æ‰€ç¤ºã€‚</p><p><img src="/2024/06/25/Conceptual-design/struct.png" class="lazyload placeholder" data-srcset="/2024/06/25/Conceptual-design/struct.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h3 id="åŠŸèƒ½éœ€æ±‚ä¸æ¨¡å—åˆ’åˆ†">åŠŸèƒ½éœ€æ±‚ä¸æ¨¡å—åˆ’åˆ†</h3><blockquote><p>æ¨¡å—åˆ’åˆ†å¦‚ä¸‹æ‰€ç¤º</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">åŠŸèƒ½ç‚¹å­åŠŸèƒ½éœ€æ±‚ç¼–å·</span><br><span class="line">ç‰©æ–™ç»´æŠ¤ç‰©æ–™æ¸…å•3.2.1.1</span><br></pre></td></tr></table></figure><h2 id="æ¥å£è®¾è®¡">æ¥å£è®¾è®¡</h2><h3 id="ç”¨æˆ·æ¥å£">ç”¨æˆ·æ¥å£</h3><blockquote><p>ç”¨æˆ·æ¥å£å¦‚ä¸‹æ‰€ç¤º</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æ¨¡å—åç§°è¾“å…¥ä¿¡æ¯ç•Œé¢æ“ä½œè¾“å‡ºä¿¡æ¯</span><br><span class="line">ç‰©æ–™ç»´æŠ¤ç‰©æµæ¸…å•æŸ¥è¯¢/ä¿å­˜/ä¿®æ”¹/åˆ é™¤æ˜¾ç¤ºæ“ä½œæ˜¯å¦æˆåŠŸä¿¡æ¯</span><br></pre></td></tr></table></figure><h3 id="å¤–éƒ¨æ¥å£">å¤–éƒ¨æ¥å£</h3><h3 id="å†…éƒ¨æ¥å£">å†…éƒ¨æ¥å£</h3><h2 id="é€»è¾‘ç»“æ„è®¾è®¡">é€»è¾‘ç»“æ„è®¾è®¡</h2><h3 id="E-Rå›¾">E-Rå›¾</h3><blockquote><p>å…·ä½“å¦‚å›¾æ‰€ç¤º</p></blockquote><p><img src="/2024/06/25/Conceptual-design/er.png" class="lazyload placeholder" data-srcset="/2024/06/25/Conceptual-design/er.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="è¡¨å®šä¹‰">è¡¨å®šä¹‰</h2><blockquote><p>è¡¨ç»“æ„å¦‚ä¸‹ï¼š</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">åç§°æè¿°ç±»å‹é•¿åº¦å°æ•°ç‚¹éç©ºä¸»é”®</span><br><span class="line">idç‰©æ–™idvarchar320âˆšâˆš</span><br><span class="line">nameç‰©æ–™åvarchar320âˆšÃ—</span><br><span class="line">categoryç‰©æ–™ç§ç±»varchar320Ã—Ã—</span><br><span class="line">sourceåŸæ–™åvarchar320Ã—Ã—</span><br><span class="line">semi-finished_productåŠæˆå“åvarchar320Ã—Ã—</span><br><span class="line">son-productå­ä»¶idvarchar320âˆšÃ—</span><br><span class="line">mother-productæ¯ä»¶idvarchar320âˆšÃ—</span><br><span class="line">stageæ‰€å±é˜¶æ®µvarchar320Ã—Ã—</span><br><span class="line">save_timeä¿å­˜æ—¶é—´time10Ã—Ã—</span><br><span class="line">update_timeä¿®æ”¹æ—¶é—´time 10Ã—Ã—</span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> doc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è¯¦ç»†è®¾è®¡è¯´æ˜</title>
      <link href="/2024/06/25/Detail-designed/"/>
      <url>/2024/06/25/Detail-designed/</url>
      
        <content type="html"><![CDATA[<h1>è¯¦ç»†è®¾è®¡</h1><h2 id="æ€»ä½“è®¾è®¡">æ€»ä½“è®¾è®¡</h2><h3 id="éœ€æ±‚æ¦‚è¿°">éœ€æ±‚æ¦‚è¿°</h3><blockquote><p>ä¸»è¦åŒ…å«ä¸¤æ–¹é¢éœ€æ±‚</p></blockquote><ul><li>1.åŠŸèƒ½éœ€æ±‚ï¼š</li><li>2.éåŠŸèƒ½æ€§éœ€æ±‚<br>æ€§èƒ½éœ€æ±‚ï¼šæ•°æ®å‡†ç¡®ã€å“åº”æ—¶é—´å°ã€å…¼å®¹æ€§å¼ºï¼›<br>å®‰å…¨éœ€æ±‚ï¼šæ•°æ®å­˜å‚¨å®‰å…¨ã€æ•°æ®å®Œæ•´ï¼›<br>å¯æ¢å¤æ€§ï¼šé­é‡æ•…éšœæ—¶å¿«é€Ÿå¯æ¢å¤ï¼›</li></ul><h4 id="è½¯ä»¶ç»“æ„">è½¯ä»¶ç»“æ„</h4><blockquote><p>ç»˜åˆ¶è½¯ä»¶ä¸»è¦ç»“æ„ï¼ˆæ¨¡å—ï¼‰</p></blockquote><p><img src="/2024/06/25/Detail-designed/struct.png" class="lazyload placeholder" data-srcset="/2024/06/25/Detail-designed/struct.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h3 id="æ¨¡å—æè¿°">æ¨¡å—æè¿°</h3><ul><li>æ¨¡å—åŸºæœ¬ä¿¡æ¯</li></ul><blockquote><p>æè¿°æ¨¡å—åŸºæœ¬åŠŸèƒ½<br>åŠŸèƒ½ç‚¹å­åŠŸèƒ½</p></blockquote><h3 id="æ¨¡å—åŠŸèƒ½æ¦‚è¿°">æ¨¡å—åŠŸèƒ½æ¦‚è¿°</h3><blockquote><p>ç®€è¿°æ¨¡å—åŸºæœ¬åŠŸèƒ½</p></blockquote><h2 id="ç®—æ³•">ç®—æ³•</h2><h3 id="æ•°æ®åŠ å¯†ç®—æ³•">æ•°æ®åŠ å¯†ç®—æ³•</h3><blockquote><p>AESç®—æ³•å…·ä½“æµç¨‹å¦‚å›¾</p></blockquote><p><img src="/2024/06/25/Detail-designed/decode.png" class="lazyload placeholder" data-srcset="/2024/06/25/Detail-designed/decode.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h4 id="æ¨¡å—å¤„ç†é€»è¾‘">æ¨¡å—å¤„ç†é€»è¾‘</h4><blockquote><p>é˜è¿°æ¨¡å—å¤„ç†åŸºæœ¬é€»è¾‘ä¸æµç¨‹ï¼Œä¸¾ä¾‹ï¼š</p></blockquote><p><img src="/2024/06/25/Detail-designed/example.png" class="lazyload placeholder" data-srcset="/2024/06/25/Detail-designed/example.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="æ¥å£">æ¥å£</h2><p>æ¥å£å¦‚ä¸‹æ‰€ç¤ºï¼š<br>æ¨¡å—åç§°è¾“å…¥ä¿¡æ¯ç•Œé¢æ“ä½œè¾“å‡ºä¿¡æ¯</p><h2 id="æ€§èƒ½">æ€§èƒ½</h2><ul><li>1ã€æ•°æ®å‡†ç¡®ï¼šç”¨æˆ·ä½¿ç”¨è½¯ä»¶å±•ç°çš„æ•ˆæœç¬¦åˆåŸºæœ¬é¢„æœŸï¼Œè¿è¡Œä¸å‡ºé”™ï¼›</li><li>2ã€å“åº”æ—¶é—´ï¼šæ•°æ®è·å–ã€é¡µé¢è¯·æ±‚çš„å“åº”æ—¶é—´åœ¨ä¸€å®šèŒƒå›´å†…ï¼Œä¸è®©ç”¨æˆ·ç­‰å¾…æ—¶é—´è¿‡é•¿ï¼›</li><li>3ã€å…¼å®¹æ€§ï¼šç½‘ç«™å…¼å®¹å¤šä¸ªä¸»æµæµè§ˆå™¨ã€‚</li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> doc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>éœ€æ±‚åˆ†æè¯´æ˜</title>
      <link href="/2024/06/25/requirements-analysis/"/>
      <url>/2024/06/25/requirements-analysis/</url>
      
        <content type="html"><![CDATA[<h1>éœ€æ±‚æè¿°çº¦å®š</h1><h2 id="éœ€æ±‚å±‚æ¬¡åˆ’åˆ†">éœ€æ±‚å±‚æ¬¡åˆ’åˆ†</h2><blockquote><p>è½¯ä»¶éœ€æ±‚ä¸»è¦åˆ’åˆ†ä¸ºä»¥ä¸‹ä¸‰ä¸ªå±‚æ¬¡ï¼šä¸šåŠ¡éœ€æ±‚ã€ç”¨æˆ·éœ€æ±‚ã€åŠŸèƒ½éœ€æ±‚ã€‚è¿˜åŒ…æ‹¬åŠŸèƒ½æ€§éœ€æ±‚ã€éåŠŸèƒ½æ€§éœ€æ±‚ç­‰ã€‚</p></blockquote><h3 id="éœ€æ±‚è·Ÿè¸ªç²’åº¦">éœ€æ±‚è·Ÿè¸ªç²’åº¦</h3><blockquote><p>æ­¤å¤„ç²’åº¦ç‰¹æŒ‡éœ€æ±‚åˆ†è§£ç²’åº¦ï¼Œæœ¬ç³»ç»Ÿè·Ÿè¸ªè‡³ç³»ç»ŸåŠŸèƒ½æ€§éœ€æ±‚ã€‚</p></blockquote><h3 id="åŠŸèƒ½æè¿°æ–¹æ³•">åŠŸèƒ½æè¿°æ–¹æ³•</h3><blockquote><p>ä»ä»¥ä¸‹æ–¹é¢è®ºè¿°ç³»ç»Ÿéœ€æ±‚ï¼š</p></blockquote><ul><li>ä¸šåŠ¡æè¿°</li><li>ç”¨æˆ·è¾“å…¥</li><li>ç”¨æˆ·è¾“å‡º</li><li>ä¸šåŠ¡æµç¨‹</li></ul><h3 id="ä¸šåŠ¡æè¿°">ä¸šåŠ¡æè¿°</h3><blockquote><p>ä¸»è¦è§£å†³çš„é—®é¢˜(ä¸¾ä¾‹)</p></blockquote><ul><li>1 è½¯ä»¶å·¥ç¨‹æ–¹é¢<ul><li>ä¸šåŠ¡è®¾è®¡<br>ä»¥APPèƒŒæ™¯ä¸ºå‰æï¼Œå¯¹ä¸šåŠ¡éœ€æ±‚è¿›è¡Œè°ƒç”¨ã€è®¾è®¡åˆ†æ</li><li>åº”ç”¨è®¾è®¡<br>åœ¨ä¸šåŠ¡åˆ†æåŸºç¡€ä¸Šï¼Œå¯¹ä¸šåŠ¡å¯¹è±¡ã€é¡µé¢ã€æµç¨‹ç­‰é€šç”¨ä¸šåŠ¡APPåŠŸèƒ½è¿›è¡Œåº”ç”¨è®¾è®¡</li><li>å¼€å‘å®ç°<br>åœ¨åº”ç”¨è®¾è®¡åŸºç¡€ä¸Šï¼Œä»¥å·¥ä¸šåœºæ™¯åº”ç”¨ä¸ºæ¡ˆä¾‹ï¼Œå¼€å‘ç°å®å®Œæ•´çš„ã€å¯å‘å¸ƒçš„å·¥ä¸šAPP</li><li>è¿ç»´å®æ–½<br>æ”¯æ’‘å·¥ä¸šAPPè¿è¡Œç¯å¢ƒã€è¿›è¡Œç¼–è¯‘éƒ¨ç½²ï¼Œå¯¹åœ¨çº¿è¿è¡Œçš„APPè¿›è¡Œæ—¥å¿—é‡‡é›†ã€ç›‘æ§ã€è¡Œä¸ºåˆ†æ</li></ul></li><li>2 æŠ€æœ¯ä½“ç³»æ–¹é¢<ul><li>åŸºç¡€å…±æ€§<br>å¯¹å„è¡Œä¸šå…±åŒéœ€è¦çš„å…±æ€§çŸ¥è¯†å’Œç»éªŒè¿›è¡Œè½¯ä»¶åŒ–</li><li>è¡Œä¸šé€šç”¨<br>å¯¹ç‰¹å®šè¡Œä¸šéœ€è¦çš„å…±æ€§çŸ¥è¯†å’Œç»éªŒè¿›è¡Œè½¯ä»¶åŒ–</li><li>å·¥ç¨‹ä¸“ç”¨<br>å¯¹ç‰¹å®šçš„è¡Œä¸šçš„ç‰¹å®šå·¥ç¨‹éœ€è¦çš„å…±æ€§çŸ¥è¯†å’Œç»éªŒè¿›è¡Œè½¯ä»¶åŒ–</li></ul></li><li>3 å·¥ä¸šåœºæ™¯æ–¹é¢<ul><li>ç ”å‘è®¾è®¡<br>æœåŠ¡äºå·¥ä¸šäº§å“ç ”å‘æ¶‰åŠé¢†åŸŸçš„ä¸šåŠ¡åœºæ™¯</li><li>ç”Ÿäº§åˆ¶é€ <br>æœåŠ¡äºå·¥ä¸šäº§å“ç”Ÿäº§åˆ¶é€ é¢†åŸŸçš„ä¸šåŠ¡åœºæ™¯</li><li>è¿è¥ç»´æŠ¤<br>æœåŠ¡äºå·¥ä¸šäº§å“è¿è¥ç»´æŠ¤é¢†åŸŸçš„ä¸šåŠ¡åœºæ™¯</li><li>ç»è¥ç®¡ç†<br>æœåŠ¡äºå·¥ä¸šäº§å“ç»è¥ç®¡ç†é¢†åŸŸçš„ä¸šåŠ¡åœºæ™¯</li></ul></li></ul><h1>ç”¨æˆ·ç‰¹ç‚¹</h1><ul><li>ç³»ç»Ÿç®¡ç†å‘˜ï¼šåå°ç»´æŠ¤äººå‘˜</li><li>ç”¨æˆ·ï¼šå¯¹æ•°æ®çš„ç®¡ç†</li></ul><h1>è¿è¡Œç¯å¢ƒ</h1><h2 id="å¼€å‘ç¯å¢ƒ">å¼€å‘ç¯å¢ƒ</h2><p>è®¾å¤‡åç§°æ•°é‡é…ç½®ã€å‹å·å¤‡æ³¨<br>pc         x1       â€¦</p><h2 id="ç³»ç»ŸåŠŸèƒ½éœ€æ±‚">ç³»ç»ŸåŠŸèƒ½éœ€æ±‚</h2><blockquote><p>å…·ä½“ä¸šåŠ¡æè¿°ä¸æµç¨‹å¦‚ä¸‹ï¼š</p></blockquote><p><img src="/2024/06/25/requirements-analysis/struct.png" class="lazyload placeholder" data-srcset="/2024/06/25/requirements-analysis/struct.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h3 id="æ€»ä½“åŠŸèƒ½éœ€æ±‚">æ€»ä½“åŠŸèƒ½éœ€æ±‚</h3><blockquote><p>ä¸¾ä¾‹</p></blockquote><ul><li>ç‰©æ–™ç®¡ç†ï¼šè´Ÿè´£å®Œæˆå·¥ç¨‹æ•°æ®åŠŸèƒ½çš„å¼€å‘ï¼›</li><li>è®¡åˆ’ç®¡ç†ï¼šå®Œæˆå¯¹äºè®¡åˆ’ç­–ç•¥ã€è®¡åˆ’æ–¹æ¡ˆã€é•¿å‘¨æœŸè®¡åˆ’åŠŸèƒ½ï¼›</li><li>ç”Ÿäº§è®¢å•ç®¡ç†ï¼šå®Œæˆè®¢å•ç»´æŠ¤ã€è®¢å•å˜æ›´ç­‰ç”Ÿäº§è¿‡ç¨‹ç®¡ç†ã€‚</li></ul><h3 id="å„ä¸ªæ¨¡å—åŠŸèƒ½éœ€æ±‚">å„ä¸ªæ¨¡å—åŠŸèƒ½éœ€æ±‚</h3><blockquote><p>ä¸¾ä¾‹</p></blockquote><ul><li>ç‰©æ–™ç®¡ç†æ¨¡å—</li></ul><blockquote><p>æ­¤æ¨¡å—ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ä»¥ä¸‹å‡ éƒ¨åˆ†ï¼š<br>1.ç‰©æ–™æ¸…å•å…¨é˜¶ç»´æŠ¤ï¼šåœ¨æ­¤åŠŸèƒ½ä¸­ç‰©æ–™æ¸…å•çš„ç»´æŠ¤åŒ…æ‹¬ä½†ä¸é™äºï¼šå­è£…é…ä»¶ã€ä¸­é—´ä»¶ã€é›¶ä»¶ã€åŸææ–™ç­‰æ¸…å•çš„ä»“åº“å‘æ–™ã€è½¦é—´ç”Ÿäº§ã€é‡‡è´­æ•°é‡ç§ç±»çš„ç»´æŠ¤ï¼›<br>2.æ¯ä»¶ç»“æ„æŸ¥è¯¢ï¼šè´Ÿè´£æŸ¥è¯¢æ¯ä»¶ç»“æ„ï¼›<br>3.å­ä»¶ç”¨é€”æŸ¥è¯¢ï¼šè´Ÿè´£æŸ¥è¯¢å­ä»¶å…·ä½“ç”¨é€”ã€‚</p></blockquote><ul><li>è®¡åˆ’ç®¡ç†åŠŸèƒ½</li></ul><blockquote><p>æ­¤æ¨¡å—ä¸»è¦åˆ†ä¸ºä»¥ä¸‹åŠŸèƒ½<br>1. è®¡åˆ’ç­–ç•¥ï¼šä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªæ–¹é¢ï¼šæˆå“ç­–ç•¥å’Œèµ„æºç­–ç•¥ã€‚å…¶ä¸­æˆå“ç­–ç•¥æ˜¯æŒ‡é¢å¯¹äº§å“éœ€æ±‚æ—¶æ˜¯é‡‡ç”¨è‡ªå·±åˆ¶é€ è¿˜æ˜¯å¤–åŒ…ï¼›èµ„æºç­–ç•¥åˆ†ä¸ºäº§èƒ½ç­–ç•¥å’ŒåŸæ–™ç­–ç•¥ï¼Œäº§èƒ½ç­–ç•¥æ˜¯æŒ‡ä¸ºæŸç§ç”Ÿäº§æ‰€åˆ†é…äº§èƒ½ç­–ç•¥ï¼ŒåŸæ–™ç­–ç•¥æ˜¯æŒ‰ç…§åŸæ–™æƒ…å†µå¯¹é‡‡è´­ã€å¤‡åº“å­˜ç­‰æ“ä½œè¿›è¡Œå®‰æ’ã€‚æœ¬æ–‡ä¸»è¦å®ç°ä¸Šè¿°ç­–ç•¥ï¼›<br>2. è®¡åˆ’æ–¹æ¡ˆï¼šåŒ…æ‹¬è®¡åˆ’æ–¹æ¡ˆçš„æ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤ç­‰æ“ä½œï¼›<br>3. è®¡åˆ’ç»“æœè¯„ä¼°ï¼šå¯¹äºè®¡åˆ’æ–¹æ¡ˆçš„æ‰§è¡Œç»“æœè¿›è¡Œè¯„ä¼°ï¼›<br>4. éœ€æ±‚ç®¡ç†ï¼šå¯¹ç”¨æˆ·éœ€æ±‚çš„å¢åˆ æ”¹æŸ¥ï¼›<br>5. ç‰©æ–™éœ€æ±‚è®¡åˆ’ï¼šå¯¹ç‰©æ–™éœ€æ±‚åšå‡ºåˆç†è®¡åˆ’ï¼Œåœ¨è®¡åˆ’æ”¹å˜æ—¶å¯ä»¥ä¿®æ”¹æˆ–è€…åˆ é™¤ï¼›<br>6. é•¿å‘¨æœŸè®¡åˆ’ï¼šé€šè¿‡æ­¤åŠŸèƒ½å¯ä»¥è¿›è¡Œé•¿å‘¨æœŸçš„éœ€æ±‚è®¡åˆ’çš„å‘å¸ƒï¼Œå˜æ›´ç­‰æ“ä½œï¼›<br>7. æ‰¹æ¬¡éœ€æ±‚è®¡åˆ’ï¼šå¯¹äºæŸä¸€æ‰¹æ¬¡äº§å“éœ€æ±‚è®¡åˆ’è¿›è¡Œç®¡ç†ã€‚</p></blockquote><ul><li>è®¢å•ç®¡ç†åŠŸèƒ½</li></ul><blockquote><p>æ­¤æ¨¡å—ä¸»è¦åˆ†ä¸ºä»¥ä¸‹åŠŸèƒ½ï¼š<br>1.è®¢å•ç»´æŠ¤ï¼šè´Ÿè´£ç”¨æˆ·è®¢å•çš„æ—¥å¸¸ç»´æŠ¤ï¼›<br>2.è®¢å•å˜æ›´ï¼šè´Ÿè´£è®¢å•å†…å®¹çš„ä¿®æ”¹æ“ä½œï¼›<br>3.é¢†æ–™é€€æ–™ï¼šè´Ÿè´£è®°å½•åŸæ–™çš„ä½¿ç”¨æ˜ç»†ï¼›<br>4.å®Œå·¥å…¥åº“ï¼šåœ¨äº§å“å®Œå·¥åï¼Œå¯¹å…¥åº“äº§å“è¿›è¡Œè®°å½•ï¼›<br>5.è·¨ç»„ç»‡é¢†æ–™å…¥åº“ï¼šè´Ÿè´£åœ¨ä¸åŒéƒ¨é—¨é—´è®°å½•åŸæ–™çš„å…¥åº“è¯¦æƒ…ï¼›<br>6.åœ¨åº“å“æ”¹åˆ¶è¿”ä¿®ï¼šå¯¹äºéœ€è¦è¿”ä¿®çš„å•†å“è¿›è¡Œè®°å½•ï¼›<br>7.ç¼ºæ–™åˆ†æï¼šè®°å½•æœªå®Œæˆè®¢å•çš„ææ–™ç¼ºå¤±è¿›è¡Œåˆ†æï¼›<br>8.å®Œå·¥é½å¥—æ£€æŸ¥ï¼šå¯¹äºå®Œå·¥åçš„ç‰©æ–™æ¸…å•è¿›è¡Œæ£€æŸ¥ã€‚</p></blockquote><h2 id="éåŠŸèƒ½æ€§éœ€æ±‚">éåŠŸèƒ½æ€§éœ€æ±‚</h2><h3 id="ç³»ç»Ÿæ€§èƒ½è¦æ±‚">ç³»ç»Ÿæ€§èƒ½è¦æ±‚</h3><blockquote><p>æœ¬è½¯ä»¶å¯¹æ€§èƒ½çš„è¦æ±‚ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p></blockquote><ul><li>1ã€æ•°æ®å‡†ç¡®ï¼šç”¨æˆ·ä½¿ç”¨è½¯ä»¶å±•ç°çš„æ•ˆæœç¬¦åˆåŸºæœ¬é¢„æœŸï¼Œè¿è¡Œä¸å‡ºé”™ï¼›</li><li>2ã€å“åº”æ—¶é—´ï¼šæ•°æ®è·å–ã€é¡µé¢è¯·æ±‚çš„å“åº”æ—¶é—´åœ¨ä¸€å®šèŒƒå›´å†…ï¼Œä¸è®©ç”¨æˆ·ç­‰å¾…æ—¶é—´è¿‡é•¿ï¼›</li><li>3ã€å…¼å®¹æ€§ï¼šç½‘ç«™å…¼å®¹å¤šä¸ªä¸»æµæµè§ˆå™¨ã€‚</li></ul><h3 id="ç³»ç»Ÿå®‰å…¨éœ€æ±‚">ç³»ç»Ÿå®‰å…¨éœ€æ±‚</h3><ul><li>1ã€èº«ä»½éªŒè¯ï¼šå¯¹äºè®¿é—®çš„ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯ï¼›</li><li>2ã€æˆæƒè®¿é—®ï¼šå¯¹äºæ¯ä¸ªé¡µé¢/åŠŸèƒ½è¿›è¡Œç»†ç²’åº¦åŒ–ç®¡ç†ï¼Œé€šè¿‡æˆäºˆæƒé™è¿›è¡Œè®¿é—®ï¼›</li><li>3ã€ä¿¡æ¯åŠ å¯†å­˜å‚¨ï¼šå¯¹äºç”¨æˆ·ä¿¡æ¯è¿›è¡ŒåŠ å¯†å­˜å‚¨ï¼Œç¡®ä¿å­˜å‚¨å®‰å…¨ï¼›</li><li>4ã€æ•°æ®å®Œæ•´æ€§ï¼šå¯¹äºä¸Šä¼ æ–‡ä»¶å®Œæ•´æ€§è¿›è¡Œæ ¡éªŒï¼Œå¯¹äºæ•°æ®ä¼ è¾“å®Œæ•´æ€§è¿›è¡Œæ£€éªŒã€‚</li></ul><h3 id="ç³»ç»Ÿå¯æ¢å¤æ€§éœ€æ±‚">ç³»ç»Ÿå¯æ¢å¤æ€§éœ€æ±‚</h3><blockquote><p>ç³»ç»Ÿå¯æ¢å¤æ€§æ˜¯æŒ‡åœ¨ç³»ç»Ÿå‘ç”Ÿæ•…éšœæ—¶å¯ä»¥å¿«é€Ÿæ¢å¤è‡³æ•…éšœå‘ç”Ÿå‰æ°´å¹³çš„èƒ½åŠ›ã€‚æœ¬ç³»ç»Ÿçš„å¯æ¢å¤æ€§è¦æ±‚å¿…é¡»ä¸‹åœ¨æŒ‡å®šæ—¶é—´å†…æ¢å¤ç³»ç»Ÿæ€§èƒ½æ°´å¹³ã€‚</p></blockquote><h1>ç³»ç»Ÿæ¥å£</h1><h2 id="ç”¨æˆ·æ¥å£">ç”¨æˆ·æ¥å£</h2><blockquote><p>æœ¬è½¯ä»¶é‡‡ç”¨Webå’ŒAppç«¯ç•Œé¢åŒ–æ“ä½œæ–¹å¼æ§åˆ¶æ•°æ®çš„å½•å…¥ã€å­˜å‚¨æ“ä½œã€‚å…·ä½“æ¥å£å¦‚è¡¨5-1æ‰€ç¤ºã€‚<br>è¡¨5-1 æ¥å£è¡¨</p></blockquote><h2 id="å¤–éƒ¨æ¥å£">å¤–éƒ¨æ¥å£</h2><blockquote><p>ä¸€èˆ¬ä¸ºrestful apiæ ¼å¼ï¼Œé€šè¿‡httpè°ƒç”¨</p></blockquote><h2 id="å†…éƒ¨æ¥å£">å†…éƒ¨æ¥å£</h2><blockquote><p>controller api</p></blockquote><h1>åŠŸèƒ½åˆ—è¡¨</h1><blockquote><p>åˆ—ä¸¾ç³»ç»ŸåŠŸèƒ½è¦ç‚¹</p></blockquote><ul><li>åŠŸèƒ½ç‚¹å­åŠŸèƒ½éœ€æ±‚ç¼–å·ä¼˜å…ˆçº§å†…å®¹æè¿°</li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> doc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LCDï¼ˆLow-Code Developmentï¼‰Overview ä½ä»£ç å¼€å‘æ¦‚è¿°</title>
      <link href="/2024/06/25/LCD-Overview/"/>
      <url>/2024/06/25/LCD-Overview/</url>
      
        <content type="html"><![CDATA[<h1>ä½ä»£ç å¼€å‘å¹³å°ä»‹ç»</h1><blockquote><p>ä¸€ç§åº”ç”¨ç¨‹åºå¼€å‘æ–¹æ³•ï¼Œå…è®¸å¼€å‘è€…é€šè¿‡å›¾å½¢åŒ–ç”¨æˆ·ç•Œé¢ï¼Œä½¿ç”¨é¢„æ„å»ºçš„æ¨¡å—å’Œé…ç½®é€‰é¡¹ï¼Œè€Œä¸æ˜¯ä¼ ç»Ÿçš„æ‰‹åŠ¨ç¼–ç ï¼Œæ¥åˆ›å»ºåº”ç”¨ç¨‹åºã€‚è¿™ç§æ–¹æ³•å¯ä»¥æ˜¾è‘—æé«˜å¼€å‘é€Ÿåº¦ï¼Œé™ä½æŠ€æœ¯é—¨æ§›ï¼Œä½¿æ›´å¤šçš„éä¸“ä¸šå¼€å‘è€…ä¹Ÿèƒ½å‚ä¸åˆ°åº”ç”¨å¼€å‘ä¸­ã€‚</p></blockquote><h2 id="ç®€ä»‹">ç®€ä»‹</h2><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ä½ä»£ç å¼€å‘æ˜¯æŒ‡å¼€å‘äººå‘˜é€šè¿‡æ— ä»£ç æˆ–æ˜¯å°‘é‡ä»£ç å¼€å‘çš„å½¢å¼ã€‚</span><br><span class="line">ç›®å‰å›½å†…ä¸»è¦æ˜¯ä¸¤ç§ï¼šä¸€ç§æ˜¯æ— ä»£ç å¼€å‘ï¼Œå³é€šè¿‡ç®€å•çš„æ‹–æ‹½å½¢å¼ï¼Œå®ç°ç³»ç»Ÿçš„æ­å»ºã€‚ä½†è¿™æ ·æ­å»ºå‡ºç°çš„ç³»ç»ŸåŠŸèƒ½ç®€å•ï¼Œä¸é€‚åˆä¼ä¸šçš„é¢å…¨è¿è¥ã€‚å¦ä¸€ç§æ˜¯ä½ä»£ç å¼€å‘ï¼Œå¤§éƒ¨åˆ†åŠŸèƒ½å¯ä»¥é€šè¿‡æ— ä»£ç å¼çš„æ‹–æ‹½å½¢å¼æ­å»ºå¥½ï¼Œå¦å¤–ä¸€äº›æ ¸å¿ƒçš„ç‰¹æ®ŠåŠŸèƒ½éœ€è¦é€šè¿‡å°‘é‡ä»£ç æ‰èƒ½å¼€å‘å®Œæˆã€‚è¿™ç§æ¨¡å¼å¼€å‘å‡ºç°çš„ç³»ç»Ÿæ¯”ä»£ç ç æ¨¡å¼å¼€å‘å‡ºæ¥çš„ç³»ç»ŸåŠŸèƒ½æ›´ä¸ºå¼ºå¤§ï¼Œä¹Ÿæ›´å…¨é¢äº›ï¼Œæ¯”è¾ƒé€‚åˆä¼ä¸šçš„æ•´ä½“æ•°å­—åŒ–è¿è¥ã€‚ç®—æ˜¯æ— ä»£ç å¹³å°å‘å±•çš„å»¶æ·±å“ã€‚åœ¨è¿™ç§æ–¹å¼ä¸­ç¬¬äºŒç§æ–¹å¼åº”ç”¨è¾ƒå¤šï¼Œå…¶ä¸­ç”¨å‹yonBuilderå¹³å°ä½¿ç”¨äººæ•°è¾ƒå¤šã€‚</span><br></pre></td></tr></table></figure><h2 id="ç›¸å…³å¹³å°ä»‹ç»">ç›¸å…³å¹³å°ä»‹ç»</h2><h3 id="ç”¨å‹YonBuilderå¹³å°">ç”¨å‹YonBuilderå¹³å°</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="quote">&gt; ç”¨å‹YonBuilderå¹³å°æ˜¯ç”¨å‹é’ˆå¯¹ä½ä»£ç ä¼ä¸šå¼€å‘è¶‹åŠ¿æ‰“é€ çš„ä¸€æ¬¾é«˜æ°´å¹³çš„ä½ä»£ç å¼€å‘å¹³å°ã€‚é›†æˆäº†å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€åº”ç”¨æ¨¡å‹ã€éƒ¨ç½²/é›†æˆ/äº¤ä»˜ã€AIä¸æ™ºèƒ½åº”ç”¨ã€ç¤¾äº¤ä¸åä½œç­‰è¯¸å¤šæ¨¡å—ï¼Œå¯ä¸ºéä¸“ä¸šå¼€å‘äººå‘˜ã€ITäººå‘˜å’Œä¸šåŠ¡äººå‘˜å¸¦æ¥è½»æ¾ä¾¿æ·çš„ä¸“ä¸šåŒ–ä¼ä¸šåº”ç”¨å¼€å‘ä½“éªŒã€‚</span></span><br><span class="line"><span class="bullet">-</span> YouBuilderä¸ä»…æ”¯æŒå…¬æ°‘å¼€å‘è€…æ— ä»£ç å¯è§†åŒ–åº”ç”¨æ„å»ºï¼Œä¹Ÿæ”¯æŒä¸“ä¸šå¼€å‘äººå‘˜ä½ä»£ç é«˜æ•ˆç‡åº”ç”¨å¼€å‘ï¼š</span><br><span class="line"><span class="bullet">-</span> å¯¹äºä¸æ‡‚ç¼–ç¨‹çš„ä¸šåŠ¡äººå‘˜ï¼ŒYonBuilderæ”¯æŒé›¶ä»£ç æ‹–æ‹½å¼åº”ç”¨å¼€å‘ã€‚</span><br><span class="line"><span class="bullet">-</span> å¯¹äºæœ‰ç»éªŒçš„å¼€å‘å·¥ç¨‹å¸ˆï¼ŒYonBuilderçš„å…¨ç»„ä»¶åŠŸèƒ½å’Œå¯è§†åŒ–åº”ç”¨æ„å»ºæå¤§æå‡äº†åŠŸèƒ½è°ƒæ•´ã€ä»£ç ç»´æŠ¤å’Œå¼€å‘çš„æ•ˆç‡ï¼Œäº‘åŸç”Ÿå¼€å‘æ”¯æŒèµ„æºç®¡ç†ã€éƒ¨ç½²è¿ç»´ä¸€ç«™å¼æœåŠ¡ã€‚</span><br><span class="line"><span class="bullet">-</span> å¯¹äºä¼ä¸šæ¥è¯´ï¼ŒYonBuilderçš„ä½ä»£ç é«˜æ•ˆå¼€å‘å¯æå‡å›¢é˜Ÿæˆå‘˜å‚ä¸åº¦ã€ç®€åŒ–é¡¹ç›®ç®¡ç†å·¥ä½œï¼Œå…¶äº‘åŸç”Ÿæ¶æ„æ›´èƒ½å¤§å¹…é™ä½ç¡¬ä»¶æŠ•å…¥å’Œè¿ç»´æˆæœ¬ã€‚</span><br><span class="line"><span class="bullet">-</span> YonBuilderæä¾›äº†è¶…è¿‡1000ä¸ªä¼ä¸šçº§APIä¾›ç”¨æˆ·ä»»æ„è°ƒç”¨ï¼Œå¯ä¸ç”¨å‹äº§å“æ·±åº¦èåˆã€‚</span><br><span class="line"><span class="bullet">-</span> YouBuilderæ›´æ˜¯æ²‰æ·€äº†ç”¨å‹é•¿è¾¾32å¹´çš„ä¼ä¸šè½¯ä»¶æŠ€æœ¯ç»éªŒï¼Œå¯é€‚ç”¨äºå¤šç§å¤šæ ·çš„åº”ç”¨åœºæ™¯ï¼Œå¸®åŠ©ä¼ä¸šåœ¨æ•°å­—åŒ–æ—¶ä»£ç ´æµªå‰è¡Œã€‚</span><br><span class="line"><span class="code">```markdown</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">### æ··åˆå¼€å‘ä»‹ç»</span></span><br><span class="line"><span class="code"></span></span><br></pre></td></tr></table></figure><p>äº‘æ—¶ä»£çš„æ¥ä¸´æ­£åœ¨æ”¹å˜Appå’Œè¿è¥å›¢é˜Ÿä¹‹é—´çš„å…³ç³»ï¼Œä¸€åœºä¸èƒ½é¿å…çš„å˜é©æ­£åœ¨è¿›è¡Œã€‚é‰´äºç§»åŠ¨ç»ˆç«¯çš„å±€é™æ€§ï¼Œç§»åŠ¨ç»ˆç«¯ä¸Šçš„APPç”±æœ¬åœ°åŒ–åº”ç”¨(Native App)ï¼Œåˆ°åŸºäºWEBçš„åº”ç”¨Web Appï¼Œå†åˆ°æ··åˆå‹åº”ç”¨ï¼ˆHybrid APPï¼‰ï¼Œè¿™ä¸€è¿ä¸²çš„å˜åŒ–éƒ½æºäºæŠ€æœ¯çš„æ›´æ–°å’Œå¸‚åœºçš„éœ€è¦ã€‚<br>Hybrid Appæ˜¯æŒ‡ä»‹äºweb-appã€native-appè¿™ä¸¤è€…ä¹‹é—´çš„app,å®ƒè™½ç„¶çœ‹ä¸Šå»æ˜¯ä¸€ä¸ªNative Appï¼Œä½†åªæœ‰ä¸€ä¸ªUI WebViewï¼Œé‡Œé¢è®¿é—®çš„æ˜¯ä¸€ä¸ªWeb Appï¼Œæ¯”å¦‚è¡—æ—ç½‘æœ€å¼€å§‹çš„åº”ç”¨å°±æ˜¯åŒ…äº†ä¸ªå®¢æˆ·ç«¯çš„å£³ï¼Œå…¶å®é‡Œé¢æ˜¯HTML5çš„ç½‘é¡µï¼Œåæ¥æ‰æ¨å‡ºçœŸæ­£çš„åŸç”Ÿåº”ç”¨ã€‚å†å½»åº•ä¸€ç‚¹çš„ï¼Œå¦‚æŒä¸Šç™¾åº¦å’Œæ·˜å®å®¢æˆ·ç«¯Androidç‰ˆï¼Œèµ°çš„ä¹Ÿæ˜¯Hybrid Appçš„è·¯çº¿ï¼Œä¸è¿‡æŒä¸Šç™¾åº¦é‡Œé¢å°è£…çš„ä¸æ˜¯WebViewï¼Œè€Œæ˜¯è‡ªå·±çš„æµè§ˆå†…æ ¸ï¼Œæ‰€ä»¥ä½“éªŒä¸Šæ›´åƒå®¢æˆ·ç«¯ï¼Œæ›´é«˜æ•ˆã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">### å·¥ä¸šå¾®æœåŠ¡</span><br><span class="line"></span><br><span class="line">```markdown</span><br><span class="line"> å¾®æœåŠ¡æ˜¯ç³»ç»Ÿæ¶æ„ä¸Šçš„ä¸€ç§è®¾è®¡é£æ ¼ï¼Œ å®ƒçš„ä¸»æ—¨æ˜¯å°†ä¸€ä¸ªåŸæœ¬ç‹¬ç«‹çš„ç³»ç»Ÿæ‹†åˆ†æˆå¤šä¸ªå°å‹æœåŠ¡ï¼Œè¿™äº›å°å‹æœåŠ¡éƒ½åœ¨å„è‡ªç‹¬ç«‹çš„è¿›ç¨‹ä¸­è¿è¡Œï¼ŒæœåŠ¡ä¹‹é—´é€šè¿‡åŸºäºHTTPçš„RESTful APIè¿›è¡Œé€šä¿¡åä½œã€‚è¢«æ‹†åˆ†æˆçš„æ¯ä¸€ä¸ªå°å‹æœåŠ¡éƒ½å›´ç»•ç€ç³»ç»Ÿä¸­çš„æŸä¸€é¡¹æˆ–ä¸€äº›è€¦åˆåº¦è¾ƒé«˜çš„ä¸šåŠ¡åŠŸèƒ½è¿›è¡Œæ„å»ºï¼Œ å¹¶ä¸”æ¯ä¸ªæœåŠ¡éƒ½ç»´æŠ¤ç€è‡ªèº«çš„æ•°æ®å­˜å‚¨ã€ä¸šåŠ¡å¼€å‘ã€è‡ªåŠ¨åŒ–æµ‹è¯•æ¡ˆä¾‹ä»¥åŠç‹¬ç«‹éƒ¨ç½²æœºåˆ¶ã€‚</span><br></pre></td></tr></table></figure><h2 id="ç›ˆåˆ©æ¨¡å¼">ç›ˆåˆ©æ¨¡å¼</h2><h3 id="è¥é”€æ¨¡å¼">è¥é”€æ¨¡å¼</h3><p>ä¸åŒçš„åº”ç”¨ç±»åˆ«éœ€è¦ä¸åŒçš„æ¨¡å¼ï¼Œä¸»è¦çš„è¥é”€æ¨¡å¼æœ‰æ¤å…¥å¹¿å‘Šæ¨¡å¼ã€ç”¨æˆ·å‚ä¸æ¨¡å¼å’Œè´­ç‰©appç§»æ¤æ¨¡å¼ã€‚</p><ul><li>1ï¼‰æ¤å…¥å¹¿å‘Šæ¨¡å¼</li></ul><blockquote><p>åªè¦å°†å¹¿å‘ŠæŠ•æ”¾åˆ°é‚£äº›çƒ­é—¨çš„ã€ä¸è‡ªå·±äº§å“å—ä¼—ç›¸å…³çš„åº”ç”¨ä¸Šå°±èƒ½è¾¾åˆ°è‰¯å¥½çš„ä¼ æ’­æ•ˆæœã€‚</p></blockquote><ul><li>1ã€æ¨å¹¿ç›®æ ‡ï¼šæé«˜å“ç‰ŒçŸ¥ååº¦å’Œå¸å¼•æ›´å¤šç”¨æˆ·æ³¨å†Œ</li><li>2ã€æµç¨‹ï¼š</li></ul><ul><li>aã€è·å–å—ä¼—ï¼Œé‡‡ç”¨â€œé“ºé¢â€+â€œæ‰“ç‚¹â€çš„å½¢å¼ï¼Œé€šè¿‡å†…å®¹å®šå‘â€œé“ºé¢â€å’Œæœºå‹å®šå‘â€œæ‰“ç‚¹â€æ¥è¿›è¡Œå—ä¼—å®šä½ã€‚</li><li>bã€å¸å¼•å—ä¼—ï¼Œæ‰‹æœºä¸Šçš„â€œéœ‡æ’¼â€ï¼Œé«˜å†²å‡»åŠ¨æ€å¹¿å‘Šæ ï¼Œå¸å¼•å—ä¼—çœ¼çƒï¼Œå¼•èµ·å—ä¼—å¥½å¥‡å¿ƒç†ã€‚</li><li>cã€è½¬åŒ–å—ä¼—ï¼Œâ€œå³ç‚¹å‡»ï¼Œå³æ³¨å†Œâ€ï¼Œç”¨æˆ·ç‚¹å‡»å¹¿å‘Šæ ï¼Œè¿›å…¥å¹¿å‘Šäº†è§£è¯¦æƒ…ï¼Œæ³¨å†Œå‚ä¸æ´»åŠ¨ï¼Œå¹¿å‘Šä¸»å®æ—¶æ‰‹æœºç”¨æˆ·æ•°æ®ã€‚</li><li>2ï¼‰ç”¨æˆ·å‚ä¸æ¨¡å¼<br>è¿™ç§è¥é”€æ¨¡å¼æ˜¯ä¸»è¦çš„åº”ç”¨ç±»å‹æ˜¯appç§»æ¤ç±»å’Œå“ç‰Œåº”ç”¨ç±»ï¼Œä¼ä¸šæŠŠç¬¦åˆè‡ªå·±å®šä½çš„åº”ç”¨å‘å¸ƒåˆ°åº”ç”¨å•†åº—å†…ï¼Œä¾›æ™ºèƒ½æ‰‹æœºç”¨æˆ·ä¸‹è½½ï¼Œç‰¹å®šç”¨æˆ·åˆ©ç”¨è¿™ç§åº”ç”¨å¯ä»¥å¾ˆç›´è§‚çš„äº†è§£ä¼ä¸šçš„ä¿¡æ¯ï¼Œç”¨æˆ·æ˜¯åº”ç”¨çš„ä½¿ç”¨è€…ï¼Œæ‰‹æœºåº”ç”¨æˆä¸ºç”¨æˆ·çš„ä¸€ç§å·¥å…·ï¼Œèƒ½å¤Ÿä¸ºç”¨æˆ·çš„ç”Ÿæ´»æä¾›ä¾¿åˆ©æ€§ã€‚åœ¨ç»™ç›®æ ‡å®¢æˆ·æä¾›æœ‰ç”¨çš„èµ„è®¯çš„åŒæ—¶ï¼Œæ¸—é€è‡ªèº«çš„å•†å“ä¿¡æ¯ã€‚</li></ul><h3 id="æ¨å¹¿ç­–ç•¥ï¼š">æ¨å¹¿ç­–ç•¥ï¼š</h3><blockquote><p>é’ˆå¯¹ä¸­å›½ç”¨æˆ·APPä¸‹è½½ç¢ç‰‡åŒ–çš„ç‰¹ç‚¹ï¼Œæ•´åˆç§»åŠ¨äº’è”ç½‘å’ŒPCäº’è”ç½‘å››å¤§æ¸ é“ï¼Œè¦†ç›–æ‰‹æœºç”¨æˆ·ä¸‹è½½APPçš„ä¸»è¦é€šé“ï¼Œé«˜æ•ˆæ¨å¹¿APPã€‚</p></blockquote><ul><li>1.ç§»åŠ¨äº’è”ç½‘ï¼šåˆ©ç”¨ä¼˜è´¨æ‰‹æœºWAPå’ŒAPPåª’ä½“èµ„æºç›´æ¥æ¨å¹¿APPä¸‹è½½ã€‚</li><li>2.PCäº’è”ç½‘ï¼šæ•´åˆäº’è”ç½‘ITappä¸‹è½½é¢‘é“å’ŒiPhoneã€androidåº”ç”¨å•†åº—ï¼Œè¦†ç›–ä¸»æµä¸‹è½½æ¸ é“ï¼Œç¡¬æ€§å¹¿å‘Šå’Œè½¯æ€§æ¨èç»“åˆæ¨å¹¿APPã€‚<br>ä»webç«¯çš„å„ä¸ªä¸æ™ºèƒ½åˆ¶é€ è¿™ä¸ªå…³é”®è¯æœ‰å…³çš„ç½‘ç«™ä»¥åŠæ¨é€ä¸‹ï¼Œè¿›è¡Œæœ¬äº§å“çš„æ¨å¹¿ï¼Œè¿˜å¯ä»¥é€šè¿‡å¹³å°åˆä½œæ¨å¹¿ã€‚åŒ…æ‹¬å†…ç½®ä»˜è´¹æ¨å¹¿ã€æŒ‰é‡ä»˜è´¹ã€å¹¿å‘Šè”ç›Ÿä»˜è´¹æ¨å¹¿ç­‰æ¨¡å¼ã€‚</li><li>3.çº¿ä¸‹æ¨å¹¿</li></ul><blockquote><p>ä¸»è¦åˆ†ä¸ºåœ°æ¨ä»¥åŠçº¿ä¸‹å¹¿å‘ŠæŠ•æ”¾ï¼Œçº¿ä¸‹æ¨å¹¿éå¸¸é€‚åˆO2Oç±»éœ€è¦å­¦ä¹ æˆæœ¬çš„APPæ¨å¹¿ï¼Œåœ¨å¦‚ä»Šçº¿ä¸Šæµé‡æˆæœ¬è¶Šæ¥è¶Šé«˜ã€çœŸå®æ€§éš¾ä»¥ä¿éšœçš„æƒ…å†µä¸‹ï¼Œçº¿ä¸‹æ¨å¹¿ä¸å¤±ä¸ºä¸€ä¸ªåˆç†çš„é€‰é¡¹ã€‚</p></blockquote><blockquote><p>åœ°æ¨å¯¹é¡¹ç›®è½åœ°çš„æ‰§è¡ŒåŠ›æœ‰æ¯”è¾ƒé«˜çš„è¦æ±‚ï¼Œåœ¨é˜¶æ®µæ€§çš„çŸ­æœŸå°è¯•é˜¶æ®µï¼Œæˆ‘ä»¬è‡ªå·±è¿›è¡Œæ¨å¹¿ï¼Œç›¸å¯¹è€Œè¨€æˆæœ¬ä¸ä¼šå¤ªé«˜ã€‚æŠŠåœ°æ¨å½“æˆé•¿æœŸçš„æ ¸å¿ƒç«äº‰åŠ›ï¼Œå’Œç¬¬ä¸‰æ–¹åœ°æ¨å…¬å¸åˆä½œï¼Œä»–ä»¬ä¼šæ¯”è¾ƒä¸“ä¸šã€æœ‰è§„åˆ’æ€§ã€‚<br>çº¿ä¸‹å¹¿å‘ŠæŠ•æ”¾åœºæ™¯ä¸»è¦é›†ä¸­åœ¨äººæµé‡å¤§çš„åœ°åŒºï¼Œæ¯”å¦‚åœ°é“ã€å…¬äº¤ã€ç”µæ¢¯ã€é«˜é“ç­‰ï¼Œæˆ‘ä»¬åœ°æ¨çš„ä¸»è¦æ–¹å‘å°±æ˜¯å‘å·¥å‚ç­‰å„ä¸ªä¼ä¸šï¼Œä»¥åŠå‘å·¥å‚å†…çš„å·¥äººç¾¤ä½“è¿›è¡Œæ¨å¹¿ï¼Œé€šè¿‡æœ¬äº§å“å¯¹å·¥äººè¿›è¡Œçš„æ™ºèƒ½åŒ–ç®¡ç†ï¼Œä½¿å¾—å…¬è®¤çš„å·¥ä½œæ•ˆç‡ä¹Ÿèƒ½å¤Ÿä¸æ–­çš„ä¸Šå‡ï¼Œå®ç°åŒæ–¹çš„å…±èµ¢ã€‚</p></blockquote><h3 id="ä¸šåŠ¡ä½“ç³»">ä¸šåŠ¡ä½“ç³»</h3><blockquote><p>åŸºç¡€ä½“ç³»å¦‚å›¾</p></blockquote><p><img src="/2024/06/25/LCD-Overview/p1.png" class="lazyload placeholder" data-srcset="/2024/06/25/LCD-Overview/p1.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="See">See</h2><ul><li>1.<a href="https://baike.baidu.com/item/YonBuilder/61310931?fr=ge_ala">https://baike.baidu.com/item/YonBuilder/61310931?fr=ge_ala</a></li><li>2.<a href="https://developer.yonyou.com/product/appdevelopment/appdriven">https://developer.yonyou.com/product/appdevelopment/appdriven</a></li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> LCD </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nsfwæ¨¡å‹åœ¨pythonã€nodejsã€javaç­‰å¹³å°çš„AIé‰´å›¾åº”ç”¨</title>
      <link href="/2024/06/05/nsfw-model-use/"/>
      <url>/2024/06/05/nsfw-model-use/</url>
      
        <content type="html"><![CDATA[<h1>ç®€ä»‹</h1><blockquote><p>Detecting Not-Suitable-For-Work (NSFW) content is a high demand task in computer vision. While there are many types of NSFW content, here we focus on the pornographic images and videos.</p></blockquote><blockquote><p>The Yahoo Open-NSFW model originally developed with the Caffe framework has been a favourite choice, but the work is now discontinued and Caffe is also becoming less popular. Please see the description on the Yahoo project page for the context, definitions, and model training details.</p></blockquote><blockquote><p>This Open-NSFW 2 project provides a Keras implementation of the Yahoo model, with references to its previous third-party TensorFlow 1 implementation. Note that Keras 3 is compatible with TensorFlow, JAX, and PyTorch. However, currently this model is only guaranteed to work with TensorFlow and JAX.</p></blockquote><blockquote><p>A simple API is provided for making predictions on images and videos.</p></blockquote><h1>ç›¸å…³æŠ€æœ¯</h1><ul><li>TensorFlow</li><li>fastapi</li><li>loguru</li><li>pillow</li><li>requests</li><li>nodejs</li><li>express</li><li>tfjs-node</li><li>body-parser</li><li>multiparty</li><li>nsfwjs</li></ul><h2 id="pythonç‰ˆæœ¬">pythonç‰ˆæœ¬</h2><h3 id="usage-æ¨¡å‹ä½¿ç”¨">usage(æ¨¡å‹ä½¿ç”¨)</h3><h4 id="load-image">load image</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">load_image</span>(<span class="params">image_path</span>):</span><br><span class="line">    img = Image.<span class="built_in">open</span>(image_path)</span><br><span class="line">    img = img.resize((_IMAGE_SIZE, _IMAGE_SIZE))</span><br><span class="line">    img.load()</span><br><span class="line">    data = np.asarray(img, dtype=<span class="string">&quot;float32&quot;</span>)</span><br><span class="line">    data = standardize(data)</span><br><span class="line">    data = data.astype(np.float16, copy=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure><h4 id="predict-image">predict image</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">predict</span>(<span class="params">image_path</span>):</span><br><span class="line">    <span class="keyword">with</span> tf.compat.v1.Session() <span class="keyword">as</span> sess:</span><br><span class="line">        <span class="comment"># type</span></span><br><span class="line">        graph = tf.compat.v1.get_default_graph()</span><br><span class="line">        <span class="comment"># è·å–é»˜è®¤çš„ TensorFlow å›¾ï¼ŒåŠ è½½ä¸€ä¸ªé¢„å…ˆä¿å­˜çš„æ¨¡å‹</span></span><br><span class="line">        tf.compat.v1.saved_model.loader.load(sess, [tf.compat.v1.saved_model.tag_constants.SERVING], _MODEL_DIR)</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        inputsï¼šæ¨¡å‹çš„è¾“å…¥å¼ é‡ï¼Œç”¨äºæ¥æ”¶å›¾åƒæ•°æ®ã€‚</span></span><br><span class="line"><span class="string">        probabilities_opï¼šç»è¿‡ softmax å‡½æ•°åçš„è¾“å‡ºå¼ é‡ï¼ŒåŒ…å«æ¯ä¸ªç±»åˆ«çš„æ¦‚ç‡ã€‚</span></span><br><span class="line"><span class="string">        class_index_opï¼šé€šè¿‡ ArgMax æ“ä½œå¾—åˆ°çš„æœ€å¤§æ¦‚ç‡å¯¹åº”çš„ç±»åˆ«ç´¢å¼•ã€‚</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        inputs = graph.get_tensor_by_name(<span class="string">&quot;input_tensor:0&quot;</span>)</span><br><span class="line">        probabilities_op = graph.get_tensor_by_name(<span class="string">&#x27;softmax_tensor:0&#x27;</span>)</span><br><span class="line">        class_index_op = graph.get_tensor_by_name(<span class="string">&#x27;ArgMax:0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        image_data = load_image(image_path)</span><br><span class="line">        probabilities, class_index = sess.run([probabilities_op, class_index_op],</span><br><span class="line">                                              feed_dict=&#123;inputs: [image_data] * _BATCH_SIZE&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        * `probabilities_dict`ï¼šå°†æ¦‚ç‡æ•°ç»„è½¬æ¢ä¸ºä¸€ä¸ªå­—å…¸ï¼Œå…¶ä¸­é”®æ˜¯ç±»åˆ«çš„æ ‡ç­¾ï¼ˆé€šè¿‡ `_LABEL_MAP` æ˜ å°„ï¼‰ï¼Œå€¼æ˜¯å¯¹åº”çš„æ¦‚ç‡ã€‚</span></span><br><span class="line"><span class="string">        * `pre_label`ï¼šè·å–æœ€å¤§æ¦‚ç‡å¯¹åº”çš„ç±»åˆ«æ ‡ç­¾ã€‚</span></span><br><span class="line"><span class="string">        * `result`ï¼šå°†é¢„æµ‹ç»“æœç»„ç»‡æˆä¸€ä¸ªå­—å…¸ï¼ŒåŒ…å«é¢„æµ‹çš„ç±»åˆ«æ ‡ç­¾å’Œæ¯ä¸ªç±»åˆ«çš„æ¦‚ç‡ã€‚</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        probabilities_dict = &#123;_LABEL_MAP.get(i): l <span class="keyword">for</span> i, l <span class="keyword">in</span> <span class="built_in">enumerate</span>(probabilities[<span class="number">0</span>])&#125;</span><br><span class="line">        pre_label = _LABEL_MAP.get(class_index[<span class="number">0</span>])</span><br><span class="line">        result = &#123;<span class="string">&quot;class&quot;</span>: pre_label, <span class="string">&quot;probability&quot;</span>: probabilities_dict&#125;</span><br><span class="line">        <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure><blockquote><p>ä¸Šè¿°ä»£ç ä¸»è¦ç”¨äºé¢„æµ‹ç»™å®šå›¾åƒè·¯å¾„å¯¹åº”çš„å›¾åƒçš„åˆ†ç±»æ ‡ç­¾åŠå…¶æ¦‚ç‡ã€‚</p></blockquote><h2 id="jsç‰ˆæœ¬">jsç‰ˆæœ¬</h2><h3 id="å¯¼å…¥lib">å¯¼å…¥lib</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯¼å…¥experssæ¨¡å—</span></span><br><span class="line"><span class="keyword">const</span> express=<span class="built_in">require</span>(<span class="string">&quot;express&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="comment">// åˆ›å»ºæœåŠ¡å™¨å¯¹è±¡</span></span><br><span class="line"><span class="keyword">let</span> app = <span class="title function_">express</span>();</span><br><span class="line"><span class="comment">// å¯¼å…¥body-parseræ’ä»¶</span></span><br><span class="line"><span class="keyword">const</span> bodyparser = <span class="built_in">require</span>(<span class="string">&quot;body-parser&quot;</span>);;</span><br><span class="line"> <span class="comment">// é…ç½®body-parseræ¨¡å—</span></span><br><span class="line"> app.<span class="title function_">use</span>(bodyparser.<span class="title function_">urlencoded</span>(&#123;<span class="attr">extended</span>:<span class="literal">false</span>&#125;));</span><br><span class="line"> app.<span class="title function_">use</span>(bodyparser.<span class="title function_">json</span>());</span><br><span class="line"><span class="comment">// å¯¼å…¥ç³»ç»Ÿæ¨¡å—path</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> afs = <span class="built_in">require</span>(<span class="string">&#x27;fs-extra&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> multiparty = <span class="built_in">require</span>(<span class="string">&#x27;multiparty&#x27;</span>);</span><br><span class="line"><span class="keyword">let</span> imgJS = <span class="built_in">require</span>(<span class="string">&quot;image-js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> nsfw = <span class="built_in">require</span>(<span class="string">&#x27;nsfwjs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> tf = <span class="built_in">require</span>(<span class="string">&#x27;@tensorflow/tfjs-node&#x27;</span>);</span><br><span class="line"><span class="comment">// const tf = require(&#x27;@tensorflow/tfjs&#x27;);</span></span><br><span class="line"><span class="comment">// require(&#x27;@tensorflow/tfjs-node&#x27;);</span></span><br><span class="line"><span class="keyword">const</span> safeContent = [<span class="string">&#x27;Drawing&#x27;</span>, <span class="string">&#x27;Neutral&#x27;</span>]; <span class="comment">// è®¾ç½®å›¾ç‰‡å†…å®¹å®‰å…¨çš„ç±»å‹</span></span><br><span class="line"><span class="comment">// const baseUrl = path.join(__dirname, &#x27;./model/&#x27;)</span></span><br></pre></td></tr></table></figure><h3 id="é€šè¿‡æ¥å£æ¥æ”¶æ•°æ®">é€šè¿‡æ¥å£æ¥æ”¶æ•°æ®</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/checkImg&#x27;</span>,<span class="title function_">async</span> (req, res) =&gt; &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> form = <span class="keyword">new</span> multiparty.<span class="title class_">Form</span>();</span><br><span class="line">        <span class="comment">// è®¾ç½®æ–‡ä»¶å­˜å‚¨è·¯å¾„ï¼Œä»¥å½“å‰ç¼–è¾‘çš„æ–‡ä»¶ä¸ºç›¸å¯¹è·¯å¾„</span></span><br><span class="line">        form.<span class="property">uploadDir</span> = <span class="string">&#x27;./tempImgs&#x27;</span>;</span><br><span class="line">        form.<span class="title function_">parse</span>(req, <span class="title function_">async</span> (err, fields, files) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (!files || !files.<span class="property">file</span>[<span class="number">0</span>]) &#123;</span><br><span class="line">              <span class="variable language_">console</span>.<span class="title function_">log</span>(files)</span><br><span class="line">              <span class="variable language_">console</span>.<span class="title function_">log</span>(fields)</span><br><span class="line">                <span class="keyword">return</span> res.<span class="title function_">send</span>(&#123;</span><br><span class="line">                    <span class="attr">code</span>: -<span class="number">1</span>,</span><br><span class="line">                    <span class="attr">msg</span>: <span class="string">&#x27;è¯·ä¸Šä¼ fileå›¾ç‰‡èµ„æº(form-dataæ ¼å¼)&#x27;</span>,</span><br><span class="line">                    <span class="attr">data</span>: &#123;&#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;files.file[0]:&#x27;</span>, files.<span class="property">file</span>[<span class="number">0</span>]);</span><br><span class="line">            <span class="comment">// å›¾ç‰‡æœ€å¤§å°ºå¯¸</span></span><br><span class="line">            <span class="keyword">if</span> (files.<span class="property">file</span>[<span class="number">0</span>].<span class="property">size</span> &gt; <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">3</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> res.<span class="title function_">send</span>(&#123;</span><br><span class="line">                    <span class="attr">code</span>: -<span class="number">2</span>,</span><br><span class="line">                    <span class="attr">msg</span>: <span class="string">&#x27;è¢«æ£€æµ‹å›¾ç‰‡æœ€å¤§3M&#x27;</span>,</span><br><span class="line">                    <span class="attr">data</span>: &#123;&#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="comment">// æ”¯æŒçš„å›¾ç‰‡ç±»å‹</span></span><br><span class="line">            <span class="keyword">let</span> imgReg = <span class="regexp">/\S+\.(png|jpeg|jpg)$/g</span>;</span><br><span class="line">            <span class="keyword">let</span> originImgName = files.<span class="property">file</span>[<span class="number">0</span>].<span class="property">originalFilename</span> || files.<span class="property">file</span>[<span class="number">0</span>].<span class="property">path</span>;</span><br><span class="line">            <span class="keyword">if</span> (!imgReg.<span class="title function_">test</span>(originImgName)) &#123;</span><br><span class="line">                <span class="keyword">return</span> res.<span class="title function_">send</span>(&#123;</span><br><span class="line">                    <span class="attr">code</span>: -<span class="number">3</span>,</span><br><span class="line">                    <span class="attr">msg</span>: <span class="string">&#x27;ä»…ä»…æ”¯æŒï¼ˆpngã€jpegã€jpgï¼‰ç±»å‹å›¾ç‰‡æ£€æµ‹&#x27;</span>,</span><br><span class="line">                    <span class="attr">data</span>: &#123;&#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">let</span> img = <span class="keyword">await</span> <span class="title function_">convert</span>(files.<span class="property">file</span>[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">let</span> model;</span><br><span class="line">            <span class="comment">// åŠ è½½æ¨¡å‹ ä¼ å…¥æ¨¡å‹è·¯å¾„</span></span><br><span class="line">            model_fp = <span class="string">&#x27;file://&#x27;</span> + path.<span class="title function_">join</span>(<span class="string">&quot;./&quot;</span>, <span class="string">&#x27;model/model.json&#x27;</span>);</span><br><span class="line">            tf.<span class="title function_">loadGraphModel</span>(model_fp</span><br><span class="line">            ).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">loadedModel</span>) &#123;</span><br><span class="line">                model = loadedModel;</span><br><span class="line">                <span class="keyword">let</span> img =  <span class="title function_">convert</span>(files.<span class="property">file</span>[<span class="number">0</span>]);</span><br><span class="line">                nsfw1 = <span class="keyword">new</span> nsfw.<span class="title function_">NSFWJS</span>(<span class="number">0</span>, &#123;</span><br><span class="line">                  <span class="attr">size</span>: <span class="number">224</span></span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(nsfw1.<span class="property">classify</span>);                </span><br><span class="line">                <span class="keyword">let</span> predictions =  nsfw1.<span class="title function_">classify</span>(img);</span><br><span class="line">                <span class="keyword">const</span> &#123;isSafe, imgType&#125; = <span class="title function_">isSafeContent</span>(predictions);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ˜¯å¦å®‰å…¨ï¼š&#x27;</span>, predictions, isSafe);</span><br><span class="line">                res.<span class="title function_">send</span>(&#123;</span><br><span class="line">                    <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">msg</span>: isSafe ? <span class="string">&#x27;å›¾ç‰‡åˆè§„&#x27;</span> : <span class="string">&#x27;å›¾ç‰‡å¯èƒ½å­˜åœ¨ä¸åˆè§„çš„é£é™©,è¯·æ ¸æŸ¥&#x27;</span>,</span><br><span class="line">                    <span class="attr">data</span>: &#123;</span><br><span class="line">                        isSafe,</span><br><span class="line">                        imgType,</span><br><span class="line">                        predictions,</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;).<span class="title function_">catch</span>(<span class="keyword">function</span>(<span class="params">error</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;åŠ è½½æ¨¡å‹æ—¶å‡ºé”™ï¼š&#x27;</span>, error);</span><br><span class="line">            &#125;);</span><br><span class="line">           </span><br><span class="line">        &#125;);</span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        res.<span class="title function_">send</span>(&#123;</span><br><span class="line">            <span class="attr">code</span>: -<span class="number">9</span>,</span><br><span class="line">            <span class="attr">msg</span>: <span class="string">&#x27;å›¾ç‰‡æ ¸æŸ¥å¤±è´¥ï¼Œè¯·é‡è¯•&#x27;</span>,</span><br><span class="line">            <span class="attr">data</span>: &#123;&#125;</span><br><span class="line">        &#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘å¬ç«¯å£</span></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3006</span>,<span class="function">()=&gt;</span>&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;å›¾ç‰‡é‰´é»„æœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼portï¼š3006&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="å›¾ç‰‡æ•°æ®å½’ä¸€åŒ–">å›¾ç‰‡æ•°æ®å½’ä¸€åŒ–</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> imgTypeoObj = &#123;</span><br><span class="line">    <span class="title class_">Drawing</span>: <span class="string">&#x27;è‰ºæœ¯æ€§çš„&#x27;</span>,</span><br><span class="line">    <span class="title class_">Neutral</span>: <span class="string">&#x27;ä¸­æ€§çš„&#x27;</span>,</span><br><span class="line">    <span class="title class_">Sexy</span>: <span class="string">&#x27;æ€§æ„Ÿçš„&#x27;</span>,</span><br><span class="line">    <span class="title class_">Porn</span>: <span class="string">&#x27;è‰²æƒ…çš„&#x27;</span>,</span><br><span class="line">    <span class="title class_">Hentai</span>: <span class="string">&#x27;å˜æ€çš„&#x27;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è½¬æ¢å›¾ç‰‡æ ¼å¼</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">convert</span> = <span class="keyword">async</span> file =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> image = <span class="keyword">await</span> imgJS.<span class="property">Image</span>.<span class="title function_">load</span>(file.<span class="property">path</span>);</span><br><span class="line">  <span class="keyword">const</span> numChannels = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">const</span> numPixels = image.<span class="property">width</span> * image.<span class="property">height</span>;</span><br><span class="line">  <span class="keyword">const</span> values = <span class="keyword">new</span> <span class="title class_">Int32Array</span>(numPixels * numChannels);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; numPixels; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> c = <span class="number">0</span>; c &lt; numChannels; ++c) &#123;</span><br><span class="line">      values[i * numChannels + c] = image.<span class="property">data</span>[i * <span class="number">4</span> + c];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> tf.<span class="title function_">tensor3d</span>(values, [image.<span class="property">height</span>, image.<span class="property">width</span>, numChannels], <span class="string">&#x27;int32&#x27;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="åºŸå¼ƒæ•°æ®æ¸…ç©º">åºŸå¼ƒæ•°æ®æ¸…ç©º</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é€’å½’åˆ é™¤ç›®å½•ä¸­çš„æ–‡ä»¶å’Œå­ç›®å½•</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">emptyDirSync</span>(<span class="params">dirPath</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!fs.<span class="title function_">existsSync</span>(dirPath)) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœç›®å½•ä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¯»å–ç›®å½•ä¸­çš„æ–‡ä»¶å’Œå­ç›®å½•</span></span><br><span class="line">  fs.<span class="title function_">readdirSync</span>(dirPath).<span class="title function_">forEach</span>(<span class="function"><span class="params">file</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> curPath = path.<span class="title function_">join</span>(dirPath, file);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯æ–‡ä»¶è¿˜æ˜¯ç›®å½•</span></span><br><span class="line">    <span class="keyword">const</span> stats = fs.<span class="title function_">lstatSync</span>(curPath);</span><br><span class="line">    <span class="keyword">if</span> (stats.<span class="title function_">isDirectory</span>()) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœæ˜¯ç›®å½•ï¼Œé€’å½’åˆ é™¤</span></span><br><span class="line">      <span class="title function_">emptyDirSync</span>(curPath);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœæ˜¯æ–‡ä»¶ï¼Œç›´æ¥åˆ é™¤</span></span><br><span class="line">      fs.<span class="title function_">unlinkSync</span>(curPath);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å°è¯•åˆ é™¤ç©ºç›®å½•</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    fs.<span class="title function_">rmdirSync</span>(dirPath);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœç›®å½•ä¸ä¸ºç©ºï¼ˆä¾‹å¦‚æœ‰å…¶ä»–è¿›ç¨‹æ­£åœ¨å†™å…¥ï¼‰ï¼Œåˆ™å¿½ç•¥é”™è¯¯</span></span><br><span class="line">    <span class="keyword">if</span> (err.<span class="property">code</span> !== <span class="string">&#x27;ENOTEMPTY&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å†…å®¹æ£€æµ‹">å†…å®¹æ£€æµ‹</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">isSafeContent</span> = predictions =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> safeProbability = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> imgTypeValArr = [];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> index = <span class="number">0</span>; index &lt; predictions.<span class="property">length</span>; index++) &#123;</span><br><span class="line">    <span class="keyword">const</span> item = predictions[index];</span><br><span class="line">    <span class="keyword">const</span> className = item.<span class="property">className</span>;</span><br><span class="line">    <span class="keyword">const</span> probability = item.<span class="property">probability</span>;</span><br><span class="line">    <span class="keyword">if</span> (safeContent.<span class="title function_">includes</span>(className)) &#123;</span><br><span class="line">      safeProbability += probability;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  imgTypeValArr = predictions.<span class="title function_">sort</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> b.<span class="property">probability</span> - a.<span class="property">probability</span>);</span><br><span class="line"><span class="comment">//   console.log(&#x27;imgTypeValArr:&#x27;, imgTypeValArr);</span></span><br><span class="line">  <span class="keyword">let</span> myimgType = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="keyword">if</span> (imgTypeValArr.<span class="property">length</span> &amp;&amp; imgTypeValArr[<span class="number">0</span>]) &#123;</span><br><span class="line">    myimgType = imgTypeoObj[imgTypeValArr[<span class="number">0</span>].<span class="property">className</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">isSafe</span>: safeProbability &gt; <span class="number">0.5</span>,</span><br><span class="line">    <span class="attr">imgType</span>: myimgType</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨åº“">ä½¿ç”¨åº“</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;main&quot;</span><span class="punctuation">:</span> <span class="string">&quot;app.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="string">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node app.js&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;keywords&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;license&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ISC&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@tensorflow/tfjs-node&quot;</span><span class="punctuation">:</span> <span class="string">&quot;latest&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;body-parser&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.20.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;express&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4.18.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fs-extra&quot;</span><span class="punctuation">:</span> <span class="string">&quot;11.1.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;image-js&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.35.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;multiparty&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4.2.3&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;nsfwjs&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.4.2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="ç¨‹åºä½¿ç”¨">ç¨‹åºä½¿ç”¨</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install nodejs</span></span><br><span class="line">npm install <span class="comment"># yarn install</span></span><br><span class="line">npm run start <span class="comment"># yarn run start</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#    // æŸ¥è¯¢æº</span></span><br><span class="line">    yarn config get registry</span><br><span class="line"></span><br><span class="line"><span class="comment">#    // æ›´æ¢å›½å†…æº</span></span><br><span class="line">    yarn config <span class="built_in">set</span> registry https://registry.npmmirror.com</span><br><span class="line"></span><br><span class="line"><span class="comment">#    // æ¢å¤å®˜æ–¹æº</span></span><br><span class="line">    yarn config <span class="built_in">set</span> registry https://registry.yarnpkg.com</span><br><span class="line"></span><br><span class="line"><span class="comment">#    // åˆ é™¤æ³¨å†Œè¡¨</span></span><br><span class="line">    yarn config delete registry</span><br><span class="line"><span class="comment">#æœ€æ–°åœ°å€ æ·˜å® NPM é•œåƒç«™å–Šä½ åˆ‡æ¢æ–°åŸŸåå•¦!</span></span><br><span class="line">    npm config <span class="built_in">set</span> registry https://registry.npmmirror.com</span><br><span class="line">    </span><br><span class="line">    npm install -g cnpm --registry=https://registry.npmmirror.com</span><br><span class="line">     </span><br><span class="line">     <span class="comment"># æ³¨å†Œæ¨¡å—é•œåƒ</span></span><br><span class="line">    npm <span class="built_in">set</span> registry https://registry.npmmirror.com  </span><br><span class="line">     </span><br><span class="line">     // node-gyp ç¼–è¯‘ä¾èµ–çš„ node æºç é•œåƒ  </span><br><span class="line">    npm <span class="built_in">set</span> disturl https://npmmirror.com/dist </span><br><span class="line">     </span><br><span class="line">     // æ¸…ç©ºç¼“å­˜  </span><br><span class="line">    npm cache clean --force  </span><br><span class="line">     </span><br><span class="line">     // å®‰è£…cnpm  </span><br><span class="line">    npm install -g cnpm --registry=https://registry.npmmirror.com  </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> <span class="comment"># mirror config</span></span><br><span class="line">    sharp_binary_host = https://npmmirror.com/mirrors/sharp</span><br><span class="line">    sharp_libvips_binary_host = https://npmmirror.com/mirrors/sharp-libvips</span><br><span class="line">    profiler_binary_host_mirror = https://npmmirror.com/mirrors/node-inspector/</span><br><span class="line">    fse_binary_host_mirror = https://npmmirror.com/mirrors/fsevents</span><br><span class="line">    node_sqlite3_binary_host_mirror = https://npmmirror.com/mirrors</span><br><span class="line">    sqlite3_binary_host_mirror = https://npmmirror.com/mirrors</span><br><span class="line">    sqlite3_binary_site = https://npmmirror.com/mirrors/sqlite3</span><br><span class="line">    sass_binary_site = https://npmmirror.com/mirrors/node-sass</span><br><span class="line">    electron_mirror = https://npmmirror.com/mirrors/electron/</span><br><span class="line">    puppeteer_download_host = https://npmmirror.com/mirrors</span><br><span class="line">    chromedriver_cdnurl = https://npmmirror.com/mirrors/chromedriver</span><br><span class="line">    operadriver_cdnurl = https://npmmirror.com/mirrors/operadriver</span><br><span class="line">    phantomjs_cdnurl = https://npmmirror.com/mirrors/phantomjs</span><br><span class="line">    python_mirror = https://npmmirror.com/mirrors/python</span><br><span class="line">    registry = https://registry.npmmirror.com</span><br><span class="line">    disturl = https://npmmirror.com/dist</span><br><span class="line"><span class="comment">#  å…³é—­é˜²ç«å¢™</span></span><br><span class="line">systemctl stop firewalld.service</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="javaç‰ˆæœ¬">javaç‰ˆæœ¬</h2><h3 id="åŸºç¡€è½¯ä»¶å®‰è£…">åŸºç¡€è½¯ä»¶å®‰è£…</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nvm install</span><br><span class="line">nvm clean</span><br></pre></td></tr></table></figure><ul><li>pom.xmlå¼•å…¥åº“</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hserver-nsfw<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hserver-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hserver<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--    æ ¸å¿ƒä¾èµ–--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hserver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hserver<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--    webæ¡†æ¶ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hserver-plugin-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hserver<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.tensorflow<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tensorflow-core-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.tensorflow<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tensorflow-core-platform<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--    æ‰“åŒ…jar --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- é…ç½®æ‰“åŒ…æ’ä»¶ï¼ˆè®¾ç½®ä¸»ç±»ï¼Œå¹¶æ‰“åŒ…æˆèƒ–åŒ…ï¼‰ --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">appendAssemblyId</span>&gt;</span>false<span class="tag">&lt;/<span class="name">appendAssemblyId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- æ­¤å¤„ï¼Œè¦æ”¹æˆè‡ªå·±çš„ç¨‹åºå…¥å£ï¼ˆå³ main å‡½æ•°ç±»ï¼‰ --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>net.hserver.Main<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assembly<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="å®ä½“ç±»å®šä¹‰">å®ä½“ç±»å®šä¹‰</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> net.hserver.bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NsfwRes</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> drawings;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> hentai;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> neutral;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> porn;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> sexy;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NsfwRes</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NsfwRes</span><span class="params">(<span class="type">float</span>[] all)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.drawings = all[<span class="number">0</span>];</span><br><span class="line">        <span class="built_in">this</span>.hentai = all[<span class="number">1</span>];</span><br><span class="line">        <span class="built_in">this</span>.neutral = all[<span class="number">2</span>];</span><br><span class="line">        <span class="built_in">this</span>.porn = all[<span class="number">3</span>];</span><br><span class="line">        <span class="built_in">this</span>.sexy = all[<span class="number">4</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">stringBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        stringBuilder.append(<span class="string">&quot;Drawings-ç»˜ç”»:&quot;</span>).append(String.format(<span class="string">&quot;%.2f&quot;</span>, <span class="built_in">this</span>.drawings * <span class="number">100</span>)).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        stringBuilder.append(<span class="string">&quot;Hentai-18ç¦:&quot;</span>).append(String.format(<span class="string">&quot;%.2f&quot;</span>, <span class="built_in">this</span>.hentai * <span class="number">100</span>)).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        stringBuilder.append(<span class="string">&quot;Neutral-ä¸­æ€§:&quot;</span>).append(String.format(<span class="string">&quot;%.2f&quot;</span>, <span class="built_in">this</span>.neutral * <span class="number">100</span>)).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        stringBuilder.append(<span class="string">&quot;Porn-è‰²æƒ…:&quot;</span>).append(String.format(<span class="string">&quot;%.2f&quot;</span>, <span class="built_in">this</span>.porn * <span class="number">100</span>)).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        stringBuilder.append(<span class="string">&quot;Sexy-æ€§æ„Ÿ:&quot;</span>).append(String.format(<span class="string">&quot;%.2f&quot;</span>, <span class="built_in">this</span>.sexy * <span class="number">100</span>));</span><br><span class="line">        <span class="keyword">return</span> stringBuilder.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getDrawings</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> drawings;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDrawings</span><span class="params">(<span class="type">float</span> drawings)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.drawings = drawings;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getHentai</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> hentai;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setHentai</span><span class="params">(<span class="type">float</span> hentai)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.hentai = hentai;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getNeutral</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> neutral;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNeutral</span><span class="params">(<span class="type">float</span> neutral)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.neutral = neutral;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getPorn</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> porn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPorn</span><span class="params">(<span class="type">float</span> porn)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.porn = porn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getSexy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sexy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSexy</span><span class="params">(<span class="type">float</span> sexy)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sexy = sexy;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Controllerå®šä¹‰">Controllerå®šä¹‰</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.hserver.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hserver.core.ioc.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> cn.hserver.core.server.util.JsonResult;</span><br><span class="line"><span class="keyword">import</span> cn.hserver.plugin.web.annotation.Controller;</span><br><span class="line"><span class="keyword">import</span> cn.hserver.plugin.web.annotation.POST;</span><br><span class="line"><span class="keyword">import</span> cn.hserver.plugin.web.context.PartFile;</span><br><span class="line"><span class="keyword">import</span> cn.hserver.plugin.web.interfaces.HttpRequest;</span><br><span class="line"><span class="keyword">import</span> net.hserver.bean.NsfwRes;</span><br><span class="line"><span class="keyword">import</span> net.hserver.service.Nsfw;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@POST(&quot;/check&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> JsonResult <span class="title function_">check</span><span class="params">(HttpRequest request)</span> &#123;</span><br><span class="line">        <span class="type">PartFile</span> <span class="variable">file</span> <span class="operator">=</span> request.queryFile(<span class="string">&quot;file&quot;</span>);</span><br><span class="line">        <span class="type">Nsfw</span> <span class="variable">instance</span> <span class="operator">=</span> Nsfw.getInstance();</span><br><span class="line">        <span class="type">NsfwRes</span> <span class="variable">score</span> <span class="operator">=</span> instance.getScore(file.getData());</span><br><span class="line">        file.deleteTempCacheFile();</span><br><span class="line">        <span class="keyword">return</span> JsonResult.ok().put(<span class="string">&quot;score&quot;</span>, score);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="è¾“å…¥å›¾ç‰‡å¤„ç†ä¸æ¨¡å‹è°ƒç”¨">è¾“å…¥å›¾ç‰‡å¤„ç†ä¸æ¨¡å‹è°ƒç”¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.hserver.service;</span><br><span class="line"><span class="keyword">import</span> org.tensorflow.ndarray.Shape;</span><br><span class="line"><span class="keyword">import</span> org.tensorflow.ndarray.buffer.DataBuffers;</span><br><span class="line"><span class="keyword">import</span> org.tensorflow.types.TFloat32;</span><br><span class="line"><span class="keyword">import</span> java.awt.*;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.BufferedImage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ImagePreprocessingHelper</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> TFloat32 <span class="title function_">preprocessImage</span><span class="params">(BufferedImage image)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">H</span> <span class="operator">=</span> <span class="number">224</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">W</span> <span class="operator">=</span> <span class="number">224</span>;</span><br><span class="line">        <span class="type">BufferedImage</span> <span class="variable">bufferedImage</span> <span class="operator">=</span> resizeImage(image, H, W);</span><br><span class="line">        org.tensorflow.ndarray.<span class="type">Shape</span> <span class="variable">shape</span> <span class="operator">=</span> Shape.of(<span class="number">1</span>, H, W, <span class="number">3</span>);</span><br><span class="line">        <span class="keyword">return</span> TFloat32.tensorOf(shape, DataBuffers.of(imageToFloatArray(bufferedImage, H, W)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> BufferedImage <span class="title function_">resizeImage</span><span class="params">(BufferedImage originalImage, <span class="type">int</span> targetWidth, <span class="type">int</span> targetHeight)</span> &#123;</span><br><span class="line">        <span class="type">BufferedImage</span> <span class="variable">resizedImg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedImage</span>(targetWidth, targetHeight, BufferedImage.TRANSLUCENT);</span><br><span class="line">        <span class="type">Graphics2D</span> <span class="variable">g2</span> <span class="operator">=</span> resizedImg.createGraphics();</span><br><span class="line">        g2.setRenderingHint(RenderingHints.KEY_INTERPOLATION,</span><br><span class="line">                RenderingHints.VALUE_INTERPOLATION_BILINEAR);</span><br><span class="line">        g2.drawImage(originalImage, <span class="number">0</span>, <span class="number">0</span>, targetWidth, targetHeight, <span class="literal">null</span>);</span><br><span class="line">        g2.dispose();</span><br><span class="line">        originalImage.flush();</span><br><span class="line">        <span class="keyword">return</span> resizedImg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">float</span>[] imageToFloatArray(BufferedImage image, <span class="type">int</span> H, <span class="type">int</span> W) &#123;</span><br><span class="line">        <span class="keyword">if</span> (image == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Input image is null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">float</span>[] floatArray = <span class="keyword">new</span> <span class="title class_">float</span>[H * W * <span class="number">3</span>]; <span class="comment">// 3 channels: R, G, B</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> <span class="number">0</span>; y &lt; H; y++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0</span>; x &lt; W; x++) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">rgb</span> <span class="operator">=</span> image.getRGB(x, y);</span><br><span class="line">                <span class="comment">// æå–RGBé€šé“çš„å€¼</span></span><br><span class="line">                <span class="type">float</span> <span class="variable">r</span> <span class="operator">=</span> (rgb &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">                <span class="type">float</span> <span class="variable">g</span> <span class="operator">=</span> (rgb &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">                <span class="type">float</span> <span class="variable">b</span> <span class="operator">=</span> rgb &amp; <span class="number">0xFF</span>;</span><br><span class="line">                <span class="comment">// å°†RGBé€šé“çš„å€¼å½’ä¸€åŒ–åˆ°[0, 1]èŒƒå›´å†…</span></span><br><span class="line">                floatArray[index++] = r / <span class="number">255.0f</span>;</span><br><span class="line">                floatArray[index++] = g / <span class="number">255.0f</span>;</span><br><span class="line">                floatArray[index++] = b / <span class="number">255.0f</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        image.flush();</span><br><span class="line">        <span class="keyword">return</span> floatArray;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="nsfwæ¨¡å‹è¾“å‡ºæ£€æµ‹ç»“æœ">nsfwæ¨¡å‹è¾“å‡ºæ£€æµ‹ç»“æœ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.hserver.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hserver.HServerApplication;</span><br><span class="line"><span class="keyword">import</span> net.hserver.bean.NsfwRes;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.tensorflow.*;</span><br><span class="line"><span class="keyword">import</span> org.tensorflow.ndarray.buffer.DataBuffers;</span><br><span class="line"><span class="keyword">import</span> org.tensorflow.ndarray.buffer.FloatDataBuffer;</span><br><span class="line"><span class="keyword">import</span> org.tensorflow.types.TFloat32;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.imageio.ImageIO;</span><br><span class="line"><span class="keyword">import</span> java.awt.image.BufferedImage;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Nsfw</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(Nsfw.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Nsfw</span> <span class="variable">nsfw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Nsfw</span>();</span><br><span class="line">    <span class="keyword">private</span> SavedModelBundle model;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> NsfwRes <span class="title function_">getScore</span><span class="params">(String path)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getScore(<span class="keyword">new</span> <span class="title class_">File</span>(path));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> NsfwRes <span class="title function_">getScore</span><span class="params">(File file)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">BufferedImage</span> <span class="variable">image</span> <span class="operator">=</span> ImageIO.read(file);</span><br><span class="line">            <span class="keyword">return</span> getScore(image);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> NsfwRes <span class="title function_">getScore</span><span class="params">(<span class="type">byte</span>[] file)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(file);</span><br><span class="line">            <span class="type">BufferedImage</span> <span class="variable">image</span> <span class="operator">=</span> ImageIO.read(bis);</span><br><span class="line">            bis.close();</span><br><span class="line">            <span class="keyword">return</span> getScore(image);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> NsfwRes <span class="title function_">getScore</span><span class="params">(BufferedImage file)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">TFloat32</span> <span class="variable">tFloat32</span> <span class="operator">=</span> ImagePreprocessingHelper.preprocessImage(file)) &#123;</span><br><span class="line">                Map&lt;String, Tensor&gt; data = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                data.put(<span class="string">&quot;input&quot;</span>, tFloat32);</span><br><span class="line">                Map&lt;String, Tensor&gt; call = model.call(data);</span><br><span class="line">                <span class="type">float</span>[] embeddingArray = <span class="keyword">new</span> <span class="title class_">float</span>[<span class="number">5</span>];</span><br><span class="line">                <span class="type">FloatDataBuffer</span> <span class="variable">floatBuffer</span> <span class="operator">=</span> DataBuffers.of(embeddingArray);</span><br><span class="line">                <span class="keyword">try</span> (<span class="type">TFloat32</span> <span class="variable">prediction</span> <span class="operator">=</span> (TFloat32) call.get(<span class="string">&quot;prediction&quot;</span>)) &#123;</span><br><span class="line">                    prediction.read(floatBuffer);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">NsfwRes</span>(embeddingArray);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Nsfw <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (nsfw.model == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//æ³¨æ„é…ç½®è‡ªå·±æ¨¡å‹æ–‡ä»¶ä½ç½®,å¯ä»¥è‡ªå·±æ”¾Resourceä¸ºzipï¼Œå¯åŠ¨æ—¶è§£å‹åˆ°æŸä¸ªè·¯å¾„åœ¨åŠ è½½ã€‚</span></span><br><span class="line">            <span class="comment">//å¼€æºåœ°å€ï¼šhttps://github.com/gantman/nsfw_model</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">linux_path</span> <span class="operator">=</span> <span class="string">&quot;./mobilenet_v2_140_224/&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">win_path</span> <span class="operator">=</span><span class="string">&quot;C:\\Users\\rces\\mobilenet_v2_140_224\\&quot;</span>;</span><br><span class="line">            nsfw.model = SavedModelBundle.load(linux_path);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> nsfw;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•ç»“æœ">æµ‹è¯•ç»“æœ</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2023-04-21 15:54:54.312 DEBUG --- [server_business@1] c.h.p.web.handlers.DispatcherHandler     [ 390] [c0a80107-lgq9ak0z-9143-1] : åœ°å€ï¼š/check æ–¹æ³•ï¼šPOST è€—æ—¶ï¼š1294/ms æ¥æº:127.0.0.1</span><br><span class="line">2023-04-21 16:01:43.481  INFO --- [server_business@2] net.hserver.service.NsfwServiceImpl      [  39] [c0a80107-lgq9jc0r-9143-2] : time-consuming : 915 ms</span><br><span class="line">2023-04-21 16:01:43.483 DEBUG --- [server_business@2] c.h.p.web.handlers.DispatcherHandler     [ 390] [c0a80107-lgq9jc0r-9143-2] : åœ°å€ï¼š/check æ–¹æ³•ï¼šPOST è€—æ—¶ï¼š928/ms æ¥æº:127.0.0.1</span><br></pre></td></tr></table></figure><ul><li>result json</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>&#x27;msg&#x27;<span class="punctuation">:</span> &#x27;æ“ä½œæˆåŠŸ&#x27;<span class="punctuation">,</span> &#x27;score&#x27;<span class="punctuation">:</span> <span class="punctuation">&#123;</span>&#x27;drawings&#x27;<span class="punctuation">:</span> <span class="number">0.86819315</span><span class="punctuation">,</span> &#x27;hentai&#x27;<span class="punctuation">:</span> <span class="number">0.13177933</span><span class="punctuation">,</span> &#x27;neutral&#x27;<span class="punctuation">:</span> <span class="number">1.712211e-06</span><span class="punctuation">,</span> &#x27;porn&#x27;<span class="punctuation">:</span> <span class="number">1.654509e-05</span><span class="punctuation">,</span> &#x27;sexy&#x27;<span class="punctuation">:</span> <span class="number">9.231081e-06</span><span class="punctuation">&#125;</span><span class="punctuation">,</span> &#x27;code&#x27;<span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åœ¨Pythonä¸­ä½¿ç”¨loguruåº“æ•è·å¼‚å¸¸å‡ºç°bugçš„ä¿®æ­£æ–¹æ³•</title>
      <link href="/2024/05/16/loguru-catch-bug-fix/"/>
      <url>/2024/05/16/loguru-catch-bug-fix/</url>
      
        <content type="html"><![CDATA[<h1>åœ¨Pythonä¸­ä½¿ç”¨loguruåº“æ•è·å¼‚å¸¸å‡ºç°bugçš„ä¿®æ­£æ–¹æ³•</h1><h2 id="èƒŒæ™¯">èƒŒæ™¯</h2><blockquote><p>Loguru is a library which aims to bring enjoyable logging in Python.</p></blockquote><blockquote><p>Did you ever feel lazy about configuring a logger and used print() instead?â€¦ I did, yet logging is fundamental to every application and eases the process of debugging. Using Loguru you have no excuse not to use logging from the start, this is as simple as from loguru import logger.</p></blockquote><blockquote><p>Also, this library is intended to make Python logging less painful by adding a bunch of useful functionalities that solve caveats of the standard loggers. Using logs in your application should be an automatism, Loguru tries to make it both pleasant and powerful.</p></blockquote><h2 id="bugæè¿°">bugæè¿°</h2><ul><li>å½“ä½¿ç”¨qt5æ§½å‡½æ•°è°ƒç”¨æŸç±»ä¸­è¢«@logger.catchåŒ…è£¹çš„æ–¹æ³•æ—¶æŠ¥å¦‚ä¸‹å¼‚å¸¸:</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">2024-05-16 11:17:09.406 | ERROR    | __main__:ui_paint:27 - An error has been caught in function &#x27;ui_paint&#x27;, process &#x27;MainProcess&#x27; (9856), thread &#x27;MainThread&#x27; (9108):</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line"></span><br><span class="line">  File &quot;C:\Users\Administrator\PycharmProjects\ss\src\run\ui_main.py&quot;, line 54, in &lt;module&gt;</span><br><span class="line">    run_main_py()</span><br><span class="line">    â”” &lt;function run_main_py at 0x0000027A3F4E9A60&gt;</span><br><span class="line"></span><br><span class="line">  File &quot;C:\Users\Administrator\PycharmProjects\ss\src\run\ui_main.py&quot;, line 50, in run_main_py</span><br><span class="line">    ui_paint()</span><br><span class="line">    â”” &lt;function ui_paint at 0x0000027A3F4A09D0&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">File <span class="string">&quot;C:\Users\Administrator\PycharmProjects\ss\src\run\ui_main.py&quot;</span>, line 27, <span class="keyword">in</span> ui_paint</span></span><br><span class="line">    app.exec_()</span><br><span class="line">    â”‚   â”” &lt;built-in method exec_&gt;</span><br><span class="line">    â”” &lt;PyQt5.QtWidgets.QApplication object at 0x0000027A3F4F3E50&gt;</span><br><span class="line"></span><br><span class="line">TypeError: next_img() takes 1 positional argument but 2 were given</span><br></pre></td></tr></table></figure><h2 id="bugå¤ç°">bugå¤ç°</h2><ul><li>ä»£ç å¦‚ä¸‹ï¼š</li></ul><blockquote><p>class code</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span>(<span class="title class_ inherited__">QWidget</span>): </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, parent=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(MyClass, <span class="variable language_">self</span>).__init__(parent)</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"><span class="meta">    @logger.catch()</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">next_img</span>(<span class="params">self</span>): </span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        è·³è½¬ä¸‹ä¸€é¡µ</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># ä½ çš„ä»£ç é€»è¾‘</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><blockquote><p>è°ƒç”¨ä»£ç </p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">self</span>.next_button.clicked.connect(<span class="variable language_">self</span>.next_img)</span><br></pre></td></tr></table></figure><blockquote><p>è¿è¡Œä¸Šè¿°ä»£ç ï¼Œå³å¯å‡ºç°ä¸Šè¿°bug</p></blockquote><h2 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h2><blockquote><p>Qt (æˆ–è€… PyQtã€PySide ç­‰ Qt çš„ Python ç»‘å®š) ä¸­ï¼Œå½“ä½ ä½¿ç”¨ä¿¡å·å’Œæ§½æœºåˆ¶ï¼ˆå³ clicked.connect()ï¼‰æ—¶ï¼Œæ§½å‡½æ•°ï¼ˆå³ä½ è¿æ¥åˆ°çš„å‡½æ•°æˆ–æ–¹æ³•ï¼‰é€šå¸¸ä¼šæ¥æ”¶ä¸€ä¸ªé¢å¤–çš„å‚æ•°ï¼Œè¿™ä¸ªå‚æ•°ä»£è¡¨äº†è§¦å‘ä¿¡å·çš„å‘é€è€…ï¼ˆsenderï¼‰ã€‚å› æ­¤ï¼Œå³ä½¿ä½ çš„ next_img æ–¹æ³•åœ¨ç±»å®šä¹‰ä¸­åªæ¥å—ä¸€ä¸ªå‚æ•°ï¼ˆselfï¼‰ï¼Œå½“å®ƒè¢«ç”¨ä½œä¸€ä¸ªæ§½æ—¶ï¼ŒQt ä¼šè‡ªåŠ¨ä¼ é€’ä¸€ä¸ªé¢å¤–çš„å‚æ•°ï¼Œé€šå¸¸æ˜¯å‘å‡ºä¿¡å·çš„å¯¹è±¡çš„å¼•ç”¨ã€‚ ä¸ºäº†è§£å†³è¿™ä¸ª TypeErrorï¼Œä½ éœ€è¦ä¿®æ”¹ä½ çš„ next_img æ–¹æ³•ï¼Œè®©å®ƒèƒ½å¤Ÿæ¥å—è¿™ä¸ªé¢å¤–çš„å‚æ•°ã€‚</p></blockquote><h3 id="ä¿®æ­£ä»£ç ">ä¿®æ­£ä»£ç </h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span>(<span class="title class_ inherited__">QWidget</span>):  <span class="comment"># å‡è®¾ MyClass ç»§æ‰¿è‡ª QWidget æˆ–å…¶ä»– Qt æ§ä»¶</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, parent=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(MyClass, <span class="variable language_">self</span>).__init__(parent)</span><br><span class="line">        <span class="comment"># å‡è®¾ next_button æ˜¯ä¸€ä¸ª QPushButton çš„å®ä¾‹</span></span><br><span class="line">        <span class="variable language_">self</span>.next_button = QPushButton(<span class="string">&#x27;Next&#x27;</span>, <span class="variable language_">self</span>)</span><br><span class="line">        <span class="variable language_">self</span>.next_button.clicked.connect(<span class="variable language_">self</span>.next_img)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @logger.catch()</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">next_img</span>(<span class="params">self, _=<span class="literal">None</span></span>):  <span class="comment"># æ·»åŠ ä¸€ä¸ªé¢å¤–çš„å‚æ•° _ æ¥æ¥æ”¶å‘é€è€…</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        è·³è½¬ä¸‹ä¸€é¡µ</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># ä½ çš„ä»£ç é€»è¾‘</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><h3 id="ä¿®æ­£æ€è·¯">ä¿®æ­£æ€è·¯</h3><blockquote><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œnext_img æ–¹æ³•ç°åœ¨æ¥å—ä¸€ä¸ªé¢å¤–çš„å‚æ•° _ã€‚è¿™ä¸ªå‚æ•°å _ æ˜¯ä¸€ä¸ªå¸¸è§çš„çº¦å®šï¼Œç”¨äºè¡¨ç¤ºè¿™ä¸ªå‚æ•°åœ¨æ–¹æ³•ä½“å†…ä¸ä¼šè¢«ä½¿ç”¨ã€‚å½“ç„¶ï¼Œä½ å¯ä»¥é€‰æ‹©å…¶ä»–åç§°ï¼Œä½† _ æ˜¯ä¸€ä¸ªé€šç”¨çš„å ä½ç¬¦ï¼Œè¡¨æ˜è¿™ä¸ªå‚æ•°æ˜¯â€œä¸éœ€è¦çš„â€ã€‚</p></blockquote><blockquote><p>ç°åœ¨ï¼Œå½“ next_button è¢«ç‚¹å‡»æ—¶ï¼Œnext_img æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œå¹¶ä¸” Qt ä¼šè‡ªåŠ¨ä¼ é€’ä¸€ä¸ªå‚æ•°ï¼ˆé€šå¸¸æ˜¯ next_button çš„å¼•ç”¨ï¼‰ç»™è¿™ä¸ªæ–¹æ³•ã€‚ç”±äºæˆ‘ä»¬å·²ç»åœ¨æ–¹æ³•å®šä¹‰ä¸­åŒ…å«äº†è¿™ä¸ªé¢å¤–çš„å‚æ•°ï¼Œæ‰€ä»¥ä¸ä¼šå†å‡ºç° TypeErrorã€‚</p></blockquote><blockquote><p>å¦‚æœä½ ç¡®å®éœ€è¦åœ¨æ–¹æ³•ä½“å†…ä½¿ç”¨è¿™ä¸ªå‘é€è€…å¯¹è±¡ï¼ˆæ¯”å¦‚æ£€æŸ¥æ˜¯å“ªä¸ªæŒ‰é’®è¢«ç‚¹å‡»äº†ï¼‰ï¼Œä½ å¯ä»¥ç»™è¿™ä¸ªå‚æ•°ä¸€ä¸ªæ›´æœ‰æ„ä¹‰çš„åç§°ï¼Œå¹¶åœ¨æ–¹æ³•ä½“å†…ä½¿ç”¨å®ƒã€‚ä½†åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œçœ‹èµ·æ¥æˆ‘ä»¬å¹¶ä¸éœ€è¦è¿™ä¸ªå‘é€è€…å¯¹è±¡ï¼Œæ‰€ä»¥ä½¿ç”¨ _ ä½œä¸ºå‚æ•°åæ˜¯ä¸€ä¸ªåˆé€‚çš„è§£å†³æ–¹æ¡ˆã€‚</p></blockquote><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pythonä¸­ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹</title>
      <link href="/2024/05/07/self-threading-use/"/>
      <url>/2024/05/07/self-threading-use/</url>
      
        <content type="html"><![CDATA[<h1>pythonä¸­ä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹</h1><h2 id="èƒŒæ™¯">èƒŒæ™¯</h2><blockquote><p>Pythonä¸­çš„å¤šçº¿ç¨‹æ˜¯ä¸€ç§ç¼–ç¨‹æ¨¡å‹ï¼Œå®ƒå…è®¸åœ¨å•ä¸ªè¿›ç¨‹ä¸­åŒæ—¶æ‰§è¡Œå¤šä¸ªçº¿ç¨‹ã€‚çº¿ç¨‹æ˜¯ç¨‹åºæ‰§è¡Œæµçš„æœ€å°å•å…ƒï¼Œæ˜¯è¿›ç¨‹å†…çš„ä¸€æ¡æ‰§è¡Œè·¯å¾„ã€‚Pythonä¸­çš„å¤šçº¿ç¨‹ä¸»è¦æ˜¯åˆ©ç”¨threadingæ¨¡å—æ¥å®ç°çš„ã€‚</p></blockquote><blockquote><p>å…¨å±€è§£é‡Šå™¨é”ï¼ˆGILï¼‰ï¼šè¿™æ˜¯Pythonå¤šçº¿ç¨‹æ¨¡å‹ä¸­æœ€é‡è¦çš„ä¸€éƒ¨åˆ†ã€‚ç”±äºPythonçš„è®¾è®¡ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡ŒPythonå­—èŠ‚ç ã€‚è¿™æ„å‘³ç€å³ä½¿ä½¿ç”¨å¤šçº¿ç¨‹ï¼ŒCPUå¯†é›†å‹ä»»åŠ¡çš„æ‰§è¡Œé€Ÿåº¦ä¹Ÿå¯èƒ½ä¸ä¼šæ˜¾è‘—æé«˜ã€‚ä½†æ˜¯ï¼Œå¤šçº¿ç¨‹åœ¨è¿›è¡ŒI/Oå¯†é›†å‹æ“ä½œæ—¶ï¼ˆå¦‚æ–‡ä»¶è¯»å†™ã€ç½‘ç»œé€šä¿¡ç­‰ï¼‰ä»ç„¶éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒä»¬å¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…I/Oæ“ä½œå®Œæˆæ—¶è®©å¦ä¸€ä¸ªçº¿ç¨‹ç»§ç»­æ‰§è¡Œã€‚<br>çº¿ç¨‹åˆ›å»ºä¸é”€æ¯ï¼šåœ¨Pythonä¸­ï¼Œåˆ›å»ºå’Œé”€æ¯çº¿ç¨‹çš„å¼€é”€ç›¸å¯¹è¾ƒå°ï¼Œå› æ­¤å¯ä»¥åˆ›å»ºå¤§é‡çš„çº¿ç¨‹æ¥å¤„ç†å¹¶å‘ä»»åŠ¡ã€‚<br>çº¿ç¨‹åŒæ­¥ï¼šä¸ºäº†åè°ƒå¤šä¸ªçº¿ç¨‹çš„æ‰§è¡Œï¼ŒPythonæä¾›äº†å‡ ç§çº¿ç¨‹åŒæ­¥æœºåˆ¶ï¼ŒåŒ…æ‹¬é”ï¼ˆLockï¼‰ã€æ¡ä»¶å˜é‡ï¼ˆConditionï¼‰ã€ä¿¡å·é‡ï¼ˆSemaphoreï¼‰ç­‰ã€‚</p></blockquote><blockquote><p>å®ˆæŠ¤çº¿ç¨‹ï¼ˆDaemon Threadsï¼‰ï¼šPythonä¸­çš„çº¿ç¨‹å¯ä»¥è¢«è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹ã€‚å½“ä¸»çº¿ç¨‹ç»“æŸæ—¶ï¼Œå®ˆæŠ¤çº¿ç¨‹ä¹Ÿä¼šéšä¹‹ç»“æŸï¼Œå³ä½¿å®ƒä»¬è¿˜æ²¡æœ‰å®Œæˆæ‰§è¡Œã€‚</p></blockquote><h2 id="è‡ªå®šä¹‰pythonçº¿ç¨‹">è‡ªå®šä¹‰pythonçº¿ç¨‹</h2><ul><li>ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> run <span class="keyword">import</span> constants</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SISThreading</span>(threading.Thread):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, target, args=(<span class="params"></span>), kwargs=<span class="literal">None</span>, *args_thread, **kwargs_thread</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param target:</span></span><br><span class="line"><span class="string">        :param args:</span></span><br><span class="line"><span class="string">        :param kwargs:</span></span><br><span class="line"><span class="string">        :param args_thread:</span></span><br><span class="line"><span class="string">        :param kwargs_thread:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">super</span>(SISThreading, <span class="variable language_">self</span>).__init__(*args_thread, **kwargs_thread)</span><br><span class="line">        <span class="keyword">if</span> kwargs <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            kwargs = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.target = target  <span class="comment"># å­˜å‚¨ç›®æ ‡å‡½æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.args = args  <span class="comment"># å­˜å‚¨ä½ç½®å‚æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.kwargs = kwargs  <span class="comment"># å­˜å‚¨å…³é”®å­—å‚æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.__flag = threading.Event()  <span class="comment"># ç”¨äºæš‚åœçº¿ç¨‹çš„æ ‡è¯†</span></span><br><span class="line">        <span class="variable language_">self</span>.__flag.<span class="built_in">set</span>()  <span class="comment"># è®¾ç½®ä¸ºTrue</span></span><br><span class="line">        <span class="variable language_">self</span>.__running = threading.Event()  <span class="comment"># ç”¨äºåœæ­¢çº¿ç¨‹çš„æ ‡è¯†</span></span><br><span class="line">        <span class="variable language_">self</span>.__running.<span class="built_in">set</span>()  <span class="comment"># å°†runningè®¾ç½®ä¸ºTrue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">while</span> <span class="variable language_">self</span>.__running.is_set():</span><br><span class="line">            <span class="keyword">if</span> constants.stop_spider_url_flag:</span><br><span class="line">                logger.warning(<span class="string">&quot;stop spider url in threading run.&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            logger.info(<span class="string">&quot;thread is running!&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.__flag.wait()  <span class="comment"># ä¸ºTrueæ—¶ç«‹å³è¿”å›, ä¸ºFalseæ—¶é˜»å¡ç›´åˆ°self.__flagä¸ºTrueåè¿”å›</span></span><br><span class="line">            <span class="comment"># logger.debug(&quot;run = &quot;, time.strftime(&quot;%Y-%m-%d %H:%M:%S&quot;, time.localtime()))</span></span><br><span class="line">            <span class="comment"># è°ƒç”¨ç›®æ ‡å‡½æ•°å¹¶ä¼ é€’å‚æ•°</span></span><br><span class="line">            <span class="variable language_">self</span>.target(*<span class="variable language_">self</span>.args, **<span class="variable language_">self</span>.kwargs)</span><br><span class="line">            time.sleep(constants.search_delta_time)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">pause</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        logger.error(<span class="string">&quot;thread is pause&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.__flag.clear()  <span class="comment"># è®¾ç½®ä¸ºFalse, è®©çº¿ç¨‹é˜»å¡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">resume</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        logger.warning(<span class="string">&quot;thread is resume&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.__flag.<span class="built_in">set</span>()  <span class="comment"># è®¾ç½®ä¸ºTrue, è®©çº¿ç¨‹åœæ­¢é˜»å¡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stop</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        logger.error(<span class="string">&quot;thread is stop&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.__flag.<span class="built_in">set</span>()  <span class="comment"># å°†çº¿ç¨‹ä»æš‚åœçŠ¶æ€æ¢å¤, å¦‚æœå·²ç»æš‚åœçš„è¯</span></span><br><span class="line">        <span class="variable language_">self</span>.__running.clear()  <span class="comment"># è®¾ç½®ä¸ºFalse</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_running</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æ£€æŸ¥çº¿ç¨‹æ˜¯å¦æ­£åœ¨è¿è¡Œ&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.__running.is_set()</span><br></pre></td></tr></table></figure><ul><li>è°ƒç”¨å®ç°çº¿ç¨‹æš‚åœï¼Œæ¢å¤è¿è¡Œ</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>:</span><br><span class="line">    log_mon_war_thread_obj = threading.Thread(</span><br><span class="line">            target=log_mon_war,</span><br><span class="line">            args=(spider_thread_obj,))</span><br><span class="line">    log_mon_war_thread_obj.start()</span><br><span class="line">    spider_thread_obj.pause()</span><br><span class="line">    spider_thread_obj.resume()</span><br><span class="line">    <span class="keyword">return</span></span><br></pre></td></tr></table></figure><h2 id="çº¿ç¨‹é—´é€šä¿¡">çº¿ç¨‹é—´é€šä¿¡</h2><ul><li>é€šè¿‡é˜Ÿåˆ—å®ç°</li></ul><blockquote><p>demo</p></blockquote><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—</span></span><br><span class="line">q = queue.Queue()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿäº§è€…çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">producer</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;ç”Ÿäº§è€…ç”Ÿäº§äº† <span class="subst">&#123;i&#125;</span>&quot;</span>)</span><br><span class="line">        q.put(i)</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¶ˆè´¹è€…çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">consumer</span>():</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        item = q.get()</span><br><span class="line">        <span class="keyword">if</span> item <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;æ¶ˆè´¹è€…æ¶ˆè´¹äº† <span class="subst">&#123;item&#125;</span>&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºçº¿ç¨‹</span></span><br><span class="line">t1 = threading.Thread(target=producer)</span><br><span class="line">t2 = threading.Thread(target=consumer)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨çº¿ç¨‹</span></span><br><span class="line">t1.start()</span><br><span class="line">t2.start()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç­‰å¾…çº¿ç¨‹ç»“æŸ</span></span><br><span class="line">t1.join()</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‘é˜Ÿåˆ—ä¸­æ·»åŠ ä¸€ä¸ª Noneï¼Œè¡¨ç¤ºç»“æŸä¿¡å·</span></span><br><span class="line">q.put(<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">t2.join()</span><br></pre></td></tr></table></figure><ul><li>test result</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">./test/multi_threading_queue.py</span><br><span class="line">2024-05-07 15:47:04: ç”Ÿäº§è€…ç”Ÿäº§äº† 0</span><br><span class="line">2024-05-07 15:47:04: æ¶ˆè´¹è€…æ¶ˆè´¹äº† 0</span><br><span class="line">2024-05-07 15:47:05: ç”Ÿäº§è€…ç”Ÿäº§äº† 1</span><br><span class="line">2024-05-07 15:47:06: æ¶ˆè´¹è€…æ¶ˆè´¹äº† 1</span><br><span class="line">2024-05-07 15:47:06: ç”Ÿäº§è€…ç”Ÿäº§äº† 2</span><br><span class="line">2024-05-07 15:47:07: ç”Ÿäº§è€…ç”Ÿäº§äº† 3</span><br><span class="line">2024-05-07 15:47:08: æ¶ˆè´¹è€…æ¶ˆè´¹äº† 2</span><br><span class="line">2024-05-07 15:47:08: ç”Ÿäº§è€…ç”Ÿäº§äº† 4</span><br><span class="line">2024-05-07 15:47:10: æ¶ˆè´¹è€…æ¶ˆè´¹äº† 3</span><br><span class="line">2024-05-07 15:47:12: æ¶ˆè´¹è€…æ¶ˆè´¹äº† 4</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pythonä½¿ç”¨setuptoolså’Œnsiså·¥å…·æ‰“åŒ…nuitkaå·¥ç¨‹</title>
      <link href="/2024/04/10/setup-tools-python/"/>
      <url>/2024/04/10/setup-tools-python/</url>
      
        <content type="html"><![CDATA[<h1>pythonä½¿ç”¨setuptoolså’Œnsiså·¥å…·æ‰“åŒ…nuitkaå·¥ç¨‹</h1><h2 id="ç®€ä»‹">ç®€ä»‹</h2><blockquote><p>setuptools æ˜¯å®˜æ–¹æä¾›çš„ä¸€ä¸ªä¸“ä¸šç”¨äºåŒ…åˆ†å‘çš„å·¥å…·ï¼Œè‹¥åªä»å®‰è£…çš„è§’åº¦æ¥çœ‹ï¼Œå®ƒçš„åŠŸèƒ½ç¡®å®ç®€å•ã€‚å®ƒæ›´å¤§çš„æ„ä¹‰æ˜¯å¯¹åŒ…çš„åˆ†å‘å¾ˆæœ‰ç”¨ï¼Œå®šåˆ¶åŒ–ç¨‹åºéå¸¸é«˜ï¼Œå¯ç”¨å®ƒè¿›è¡Œç‰ˆæœ¬åŒ…çš„å‘å¸ƒã€‚</p></blockquote><blockquote><p>Egg æ ¼å¼æ˜¯ç”± setuptools åœ¨ 2004 å¹´å¼•å…¥ï¼Œè€Œ Wheel æ ¼å¼æ˜¯ç”± PEP427 åœ¨ 2012 å¹´å®šä¹‰ã€‚Wheel çš„å‡ºç°æ˜¯ä¸ºäº†æ›¿ä»£ Eggï¼Œå®ƒçš„æœ¬è´¨æ˜¯ä¸€ä¸ªzipåŒ…ï¼Œå…¶ç°åœ¨è¢«è®¤ä¸ºæ˜¯ Python çš„äºŒè¿›åˆ¶åŒ…çš„æ ‡å‡†æ ¼å¼ã€‚</p></blockquote><blockquote><p>åº”ç”¨ç¨‹åºå‘å¸ƒçš„æ—¶å€™ï¼Œå…·å¤‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼š</p></blockquote><blockquote><p>é™æ€ç¼–è¯‘ï¼šæŠŠç›¸å…³è”çš„åº“ä¸€å¹¶å¼•å…¥å¯æ‰§è¡Œç¨‹åºï¼Œè™½ç„¶å‘å¸ƒç®€å•ï¼Œç¼–è¯‘å‡ºæ¥åªæœ‰ä¸€ä¸ªexeæ–‡ä»¶ã€‚ï¼ˆç‰¹åˆ«æ³¨æ„ï¼šç¼–è¯‘æ—¶ï¼Œå…¶ä¾èµ–çš„åº“ä¹Ÿéœ€è¦ä½¿ç”¨é™æ€åŒ…ï¼‰ã€‚<br>åŠ¨æ€ç¼–è¯‘ï¼šæŠŠç›¸å…³è”çš„åº“ä»¥dllçš„å½¢å¼æä¾›ï¼ˆ<a href="http://xn--linux-gi1h455l.so">linuxä¸‹æ˜¯.so</a>ï¼‰å¼•å…¥,ä¸è¢«åŒ…å«è¿›å¯æ‰§è¡Œç¨‹åºï¼Œå‘å¸ƒä¸æ–¹ä¾¿ï¼Œä½†å¯æ‰§è¡Œç¨‹åºè¾ƒå°ã€‚</p></blockquote><h2 id="setuptoolsæ–¹å¼">setuptoolsæ–¹å¼</h2><h3 id="1-ä½¿ç”¨ä»¥ä¸‹ä»£ç ">1.ä½¿ç”¨ä»¥ä¸‹ä»£ç </h3><ul><li>åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> setuptools <span class="keyword">import</span>  setup,find_packages</span><br><span class="line">setup(</span><br><span class="line">    name= <span class="string">&quot;packageName&quot;</span>,   <span class="comment">#ä½ çš„pythoné¡¹ç›®åŒ…å</span></span><br><span class="line">    version = <span class="string">&#x27;1.0.0&#x27;</span>,      </span><br><span class="line">    description=<span class="string">&#x27;No description&#x27;</span>,</span><br><span class="line">    author=<span class="string">&quot;daimashiren&quot;</span>,</span><br><span class="line">    author_email=<span class="string">&#x27;123456@gmail.com&#x27;</span>,</span><br><span class="line">    url=<span class="string">&#x27;xxx.com&#x27;</span>,</span><br><span class="line">    packages = find_packages(),<span class="comment">#find_packages()æ–¹æ³•ä¼šè‡ªåŠ¨å¯»æ‰¾å½“å‰ç›®å½•ä¸‹åä¸ºpackageNameçš„åŒ…</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><h3 id="2-è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š">2. è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python setup.py install </span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•">æµ‹è¯•</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cmdå‘½ä»¤è¡Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤å°è¯•å¯¼å…¥ä½ çš„è‡ªå®šä¹‰åŒ…ï¼Œçœ‹çœ‹èƒ½å¦æˆåŠŸè¢«å¯¼å…¥ï¼Œå¦‚æœï¼Œæ²¡æœ‰æŠ¥è¯´æ˜No module named XXX é”™è¯¯åˆ™è¯´æ˜pythoné¡¹ç›®æ‰“åŒ…æˆåŠŸï¼Œå¦åˆ™åˆ™éœ€è¦é‡æ–°å°è¯•ä»¥ä¸Šæ­¥éª¤ï¼Œé‡æ–°æ‰“åŒ…ç›´åˆ°èƒ½å¤Ÿå¯¼å…¥ä¸ºæ­¢ã€‚ä¸‹å›¾ä¸­è‡ªå®šä¹‰çš„&quot;courseHelper_dev&quot;åŒ…å¯¼å…¥æˆåŠŸè€Œè‡ªå®šä¹‰çš„&quot;packageName&quot;åŒ…åˆ™å¯¼å…¥å¤±è´¥!</span></span><br><span class="line">python</span><br><span class="line">import packageName</span><br></pre></td></tr></table></figure><blockquote><p>æ£€æŸ¥easy_install.pthæ–‡ä»¶ä¸­æœ‰æ²¡æœ‰ä½ çš„é¡¹ç›®åŒ…åï¼Œpthåç¼€çš„æ–‡ä»¶è®°å½•çš„æ˜¯pythonå¯¼å…¥åŒ…æ—¶ä¼šæ£€ç´¢çš„è·¯å¾„æˆ–åŒ…åï¼Œ</p></blockquote><h2 id="NSISè½¯ä»¶">NSISè½¯ä»¶</h2><blockquote><p>Nsiså…¶å®æ˜¯ä½¿ç”¨ä¸€ç§è„šæœ¬è¯­è¨€äº†ï¼Œå­¦ä¹ æˆæœ¬è‚¯å®šæ˜¯ä¸ä½çš„ã€‚<br>é‡‡ç”¨NSIS + QT åˆ¶ä½œå®‰è£…ç¨‹åºå®é™…ä¸Šå°±æ˜¯ä½¿ç”¨QTåˆ¶ä½œå®‰è£…ç¨‹åºï¼Œè€ŒNSISä»…ä»…å°†åˆ¶ä½œçš„å®‰è£…ç¨‹åºæ‰“åŒ…æˆä¸€ä¸ªexeã€‚</p></blockquote><h3 id="ä¸‹è½½å®‰è£…">ä¸‹è½½å®‰è£…</h3><ul><li>ä¸‹è½½åœ°å€</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://nsis.sourceforge.io/Download</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨-method-1">ä½¿ç”¨ method 1</h3><blockquote><p>å¦‚å›¾,å¯åŠ¨nsisè½¯ä»¶<br><img src="/2024/04/10/setup-tools-python/start.png" class="lazyload placeholder" data-srcset="/2024/04/10/setup-tools-python/start.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"><br>é€‰æ‹©æ‰“åŒ…zipï¼Œé€‰æ‹©é€‰é¡¹ç‚¹å‡»generateç”Ÿæˆå®‰è£…åŒ…<br><img src="/2024/04/10/setup-tools-python/generate.png" class="lazyload placeholder" data-srcset="/2024/04/10/setup-tools-python/generate.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"><br>æ ¹æ®æç¤ºæ“ä½œï¼Œç»“æœå¦‚ä¸‹ï¼š</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">MakeNSIS v3.10 - Copyright 1999-2023 Contributors</span><br><span class="line">See the file COPYING <span class="keyword">for</span> license details.</span><br><span class="line">Credits can be found <span class="keyword">in</span> the Users Manual.</span><br><span class="line"></span><br><span class="line">Processing config: C:\Program Files (x86)\NSIS\nsisconf.nsh</span><br><span class="line">Processing script file: <span class="string">&quot;C:\Users\ADMINI~1\AppData\Local\Temp\zne7EA0.tmp&quot;</span> (UTF16LE)</span><br><span class="line"></span><br><span class="line">Processed 1 file, writing output (x86-unicode):</span><br><span class="line"></span><br><span class="line">Output: <span class="string">&quot;C:\Users\Administrator\PycharmProjects\spider_image_system\src\out\ui_main.dist.exe&quot;</span></span><br><span class="line">Install: 2 pages (128 bytes), 1 section (1 required) (2072 bytes), 181 instructions (5068 bytes), 210 strings (6906 bytes), 1 language table (262 bytes).</span><br><span class="line"></span><br><span class="line">Using lzma compression.</span><br><span class="line"></span><br><span class="line">EXE header size:               51200 / 38400 bytes</span><br><span class="line">Install code:                   2779 / 14900 bytes</span><br><span class="line">Install data:               50727899 / 226716719 bytes</span><br><span class="line">CRC (0xE230FDF8):                  4 / 4 bytes</span><br><span class="line"></span><br><span class="line">Total size:                 50781882 / 226770023 bytes (22.3%)</span><br><span class="line">(<span class="built_in">source</span> ZIP size was 75374073 bytes)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨-method-2">ä½¿ç”¨ method 2</h3><h4 id="VNISEdit-å¯è§†åŒ–åˆ¶ä½œå®‰è£…åŒ…å‘å¯¼ä½¿ç”¨">VNISEdit å¯è§†åŒ–åˆ¶ä½œå®‰è£…åŒ…å‘å¯¼ä½¿ç”¨</h4><ul><li>ä¸‹è½½åœ°å€</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://hmne.sourceforge.net</span><br></pre></td></tr></table></figure><ul><li>æŒ‰ç…§æç¤ºæ“ä½œï¼Œç”Ÿæˆä»£ç å¦‚ä¸‹ï¼š</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line">; Script generated by the HM NIS Edit Script Wizard.</span><br><span class="line"></span><br><span class="line">; HM NIS Edit Wizard helper defines</span><br><span class="line">!define PRODUCT_NAME <span class="string">&quot;spider image system&quot;</span></span><br><span class="line">!define PRODUCT_VERSION <span class="string">&quot;1.0&quot;</span></span><br><span class="line">!define PRODUCT_PUBLISHER <span class="string">&quot;zhaoqi.cao&quot;</span></span><br><span class="line">!define PRODUCT_WEB_SITE <span class="string">&quot;http://caozhaoqi.github.io&quot;</span></span><br><span class="line">!define PRODUCT_DIR_REGKEY <span class="string">&quot;Software\Microsoft\Windows\CurrentVersion\App Paths\ui_main.exe&quot;</span></span><br><span class="line">!define PRODUCT_UNINST_KEY <span class="string">&quot;Software\Microsoft\Windows\CurrentVersion\Uninstall\$&#123;PRODUCT_NAME&#125;&quot;</span></span><br><span class="line">!define PRODUCT_UNINST_ROOT_KEY <span class="string">&quot;HKLM&quot;</span></span><br><span class="line">!define PRODUCT_STARTMENU_REGVAL <span class="string">&quot;NSIS:StartMenuDir&quot;</span></span><br><span class="line"></span><br><span class="line">; MUI 1.67 compatible ------</span><br><span class="line">!include <span class="string">&quot;MUI.nsh&quot;</span></span><br><span class="line"></span><br><span class="line">; MUI Settings</span><br><span class="line">!define MUI_ABORTWARNING</span><br><span class="line">!define MUI_ICON <span class="string">&quot;<span class="variable">$&#123;NSISDIR&#125;</span>\Contrib\Graphics\Icons\modern-install.ico&quot;</span></span><br><span class="line">!define MUI_UNICON <span class="string">&quot;<span class="variable">$&#123;NSISDIR&#125;</span>\Contrib\Graphics\Icons\modern-uninstall.ico&quot;</span></span><br><span class="line"></span><br><span class="line">; Welcome page</span><br><span class="line">!insertmacro MUI_PAGE_WELCOME</span><br><span class="line">; License page</span><br><span class="line">!define MUI_LICENSEPAGE_CHECKBOX</span><br><span class="line">!insertmacro MUI_PAGE_LICENSE <span class="string">&quot;C:\Users\Administrator\PycharmProjects\spider_image_system\src\out\ui_main.dist\SISSoftwareLicence.txt&quot;</span></span><br><span class="line">; Directory page</span><br><span class="line">!insertmacro MUI_PAGE_DIRECTORY</span><br><span class="line">; Start menu page</span><br><span class="line">var ICONS_GROUP</span><br><span class="line">!define MUI_STARTMENUPAGE_NODISABLE</span><br><span class="line">!define MUI_STARTMENUPAGE_DEFAULTFOLDER <span class="string">&quot;spider image system&quot;</span></span><br><span class="line">!define MUI_STARTMENUPAGE_REGISTRY_ROOT <span class="string">&quot;<span class="variable">$&#123;PRODUCT_UNINST_ROOT_KEY&#125;</span>&quot;</span></span><br><span class="line">!define MUI_STARTMENUPAGE_REGISTRY_KEY <span class="string">&quot;<span class="variable">$&#123;PRODUCT_UNINST_KEY&#125;</span>&quot;</span></span><br><span class="line">!define MUI_STARTMENUPAGE_REGISTRY_VALUENAME <span class="string">&quot;<span class="variable">$&#123;PRODUCT_STARTMENU_REGVAL&#125;</span>&quot;</span></span><br><span class="line">!insertmacro MUI_PAGE_STARTMENU Application <span class="variable">$ICONS_GROUP</span></span><br><span class="line">; Instfiles page</span><br><span class="line">!insertmacro MUI_PAGE_INSTFILES</span><br><span class="line">; Finish page</span><br><span class="line">!define MUI_FINISHPAGE_RUN <span class="string">&quot;<span class="variable">$INSTDIR</span>\ui_main.exe&quot;</span></span><br><span class="line">!insertmacro MUI_PAGE_FINISH</span><br><span class="line"></span><br><span class="line">; Uninstaller pages</span><br><span class="line">!insertmacro MUI_UNPAGE_INSTFILES</span><br><span class="line"></span><br><span class="line">; Language files</span><br><span class="line">!insertmacro MUI_LANGUAGE <span class="string">&quot;English&quot;</span></span><br><span class="line"></span><br><span class="line">; MUI end ------</span><br><span class="line"></span><br><span class="line">Name <span class="string">&quot;<span class="variable">$&#123;PRODUCT_NAME&#125;</span> <span class="variable">$&#123;PRODUCT_VERSION&#125;</span>&quot;</span></span><br><span class="line">OutFile <span class="string">&quot;Setup.exe&quot;</span></span><br><span class="line">InstallDir <span class="string">&quot;<span class="variable">$PROGRAMFILES</span>\spider image system&quot;</span></span><br><span class="line">InstallDirRegKey HKLM <span class="string">&quot;<span class="variable">$&#123;PRODUCT_DIR_REGKEY&#125;</span>&quot;</span> <span class="string">&quot;&quot;</span></span><br><span class="line">ShowInstDetails show</span><br><span class="line">ShowUnInstDetails show</span><br><span class="line"></span><br><span class="line">Section <span class="string">&quot;MainSection&quot;</span> SEC01</span><br><span class="line">  SetOutPath <span class="string">&quot;<span class="variable">$INSTDIR</span>&quot;</span></span><br><span class="line">  SetOverwrite ifnewer</span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\vcruntime140_1.dll&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\vcruntime140.dll&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\unicodedata.pyd&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\ui_main.exe&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\select.pyd&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\qt5widgets.dll&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\qt5svg.dll&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\qt5gui.dll&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\qt5core.dll&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\qt5charts.dll&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\python39.dll&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\python3.dll&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\pyexpat.pyd&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\msvcp140_1.dll&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\msvcp140.dll&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\libssl-1_1.dll&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\libffi-7.dll&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\libcrypto-1_1.dll&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\_uuid.pyd&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\_ssl.pyd&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\_socket.pyd&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\_queue.pyd&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\_overlapped.pyd&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\_lzma.pyd&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\_hashlib.pyd&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\_elementtree.pyd&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\_decimal.pyd&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\_ctypes.pyd&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\_cffi_backend.pyd&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\_bz2.pyd&quot;</span></span><br><span class="line">  File <span class="string">&quot;..\PycharmProjects\spider_image_system\src\out\ui_main.dist\_asyncio.pyd&quot;</span></span><br><span class="line"></span><br><span class="line">; Shortcuts</span><br><span class="line">  !insertmacro MUI_STARTMENU_WRITE_BEGIN Application</span><br><span class="line">  CreateDirectory <span class="string">&quot;<span class="variable">$SMPROGRAMS</span>\$ICONS_GROUP&quot;</span></span><br><span class="line">  CreateShortCut <span class="string">&quot;<span class="variable">$SMPROGRAMS</span>\$ICONS_GROUP\spider image system.lnk&quot;</span> <span class="string">&quot;<span class="variable">$INSTDIR</span>\ui_main.exe&quot;</span></span><br><span class="line">  CreateShortCut <span class="string">&quot;<span class="variable">$DESKTOP</span>\spider image system.lnk&quot;</span> <span class="string">&quot;<span class="variable">$INSTDIR</span>\ui_main.exe&quot;</span></span><br><span class="line">  !insertmacro MUI_STARTMENU_WRITE_END</span><br><span class="line">SectionEnd</span><br><span class="line"></span><br><span class="line">Section <span class="string">&quot;RegComOcx&quot;</span> SEC02</span><br><span class="line"></span><br><span class="line">   SetOutPath <span class="string">&quot;<span class="variable">$INSTDIR</span>&quot;</span></span><br><span class="line"></span><br><span class="line">   RegDLL <span class="string">&quot;<span class="variable">$INSTDIR</span>\laoheitanActiveX.ocx&quot;</span></span><br><span class="line"></span><br><span class="line">SectionEnd</span><br><span class="line"></span><br><span class="line">Section -AdditionalIcons</span><br><span class="line">  !insertmacro MUI_STARTMENU_WRITE_BEGIN Application</span><br><span class="line">  WriteIniStr <span class="string">&quot;<span class="variable">$INSTDIR</span>\$&#123;PRODUCT_NAME&#125;.url&quot;</span> <span class="string">&quot;InternetShortcut&quot;</span> <span class="string">&quot;URL&quot;</span> <span class="string">&quot;<span class="variable">$&#123;PRODUCT_WEB_SITE&#125;</span>&quot;</span></span><br><span class="line">  CreateShortCut <span class="string">&quot;<span class="variable">$SMPROGRAMS</span>\$ICONS_GROUP\Website.lnk&quot;</span> <span class="string">&quot;<span class="variable">$INSTDIR</span>\$&#123;PRODUCT_NAME&#125;.url&quot;</span></span><br><span class="line">  CreateShortCut <span class="string">&quot;<span class="variable">$SMPROGRAMS</span>\$ICONS_GROUP\Uninstall.lnk&quot;</span> <span class="string">&quot;<span class="variable">$INSTDIR</span>\uninst.exe&quot;</span></span><br><span class="line">  !insertmacro MUI_STARTMENU_WRITE_END</span><br><span class="line">SectionEnd</span><br><span class="line"></span><br><span class="line">Section -Post</span><br><span class="line">  WriteUninstaller <span class="string">&quot;<span class="variable">$INSTDIR</span>\uninst.exe&quot;</span></span><br><span class="line">  WriteRegStr HKLM <span class="string">&quot;<span class="variable">$&#123;PRODUCT_DIR_REGKEY&#125;</span>&quot;</span> <span class="string">&quot;&quot;</span> <span class="string">&quot;<span class="variable">$INSTDIR</span>\ui_main.exe&quot;</span></span><br><span class="line">  WriteRegStr <span class="variable">$&#123;PRODUCT_UNINST_ROOT_KEY&#125;</span> <span class="string">&quot;<span class="variable">$&#123;PRODUCT_UNINST_KEY&#125;</span>&quot;</span> <span class="string">&quot;DisplayName&quot;</span> <span class="string">&quot;<span class="subst">$(^Name)</span>&quot;</span></span><br><span class="line">  WriteRegStr <span class="variable">$&#123;PRODUCT_UNINST_ROOT_KEY&#125;</span> <span class="string">&quot;<span class="variable">$&#123;PRODUCT_UNINST_KEY&#125;</span>&quot;</span> <span class="string">&quot;UninstallString&quot;</span> <span class="string">&quot;<span class="variable">$INSTDIR</span>\uninst.exe&quot;</span></span><br><span class="line">  WriteRegStr <span class="variable">$&#123;PRODUCT_UNINST_ROOT_KEY&#125;</span> <span class="string">&quot;<span class="variable">$&#123;PRODUCT_UNINST_KEY&#125;</span>&quot;</span> <span class="string">&quot;DisplayIcon&quot;</span> <span class="string">&quot;<span class="variable">$INSTDIR</span>\ui_main.exe&quot;</span></span><br><span class="line">  WriteRegStr <span class="variable">$&#123;PRODUCT_UNINST_ROOT_KEY&#125;</span> <span class="string">&quot;<span class="variable">$&#123;PRODUCT_UNINST_KEY&#125;</span>&quot;</span> <span class="string">&quot;DisplayVersion&quot;</span> <span class="string">&quot;<span class="variable">$&#123;PRODUCT_VERSION&#125;</span>&quot;</span></span><br><span class="line">  WriteRegStr <span class="variable">$&#123;PRODUCT_UNINST_ROOT_KEY&#125;</span> <span class="string">&quot;<span class="variable">$&#123;PRODUCT_UNINST_KEY&#125;</span>&quot;</span> <span class="string">&quot;URLInfoAbout&quot;</span> <span class="string">&quot;<span class="variable">$&#123;PRODUCT_WEB_SITE&#125;</span>&quot;</span></span><br><span class="line">  WriteRegStr <span class="variable">$&#123;PRODUCT_UNINST_ROOT_KEY&#125;</span> <span class="string">&quot;<span class="variable">$&#123;PRODUCT_UNINST_KEY&#125;</span>&quot;</span> <span class="string">&quot;Publisher&quot;</span> <span class="string">&quot;<span class="variable">$&#123;PRODUCT_PUBLISHER&#125;</span>&quot;</span></span><br><span class="line">SectionEnd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Function un.onUninstSuccess</span><br><span class="line">  HideWindow</span><br><span class="line">  MessageBox MB_ICONINFORMATION|MB_OK <span class="string">&quot;<span class="subst">$(^Name)</span> å·²æˆåŠŸåœ°ä»ä½ çš„è®¡ç®—æœºç§»é™¤ã€‚&quot;</span></span><br><span class="line">FunctionEnd</span><br><span class="line"></span><br><span class="line">Function un.onInit</span><br><span class="line">  MessageBox MB_ICONQUESTION|MB_YESNO|MB_DEFBUTTON2 <span class="string">&quot;ä½ ç¡®å®è¦å®Œå…¨ç§»é™¤ <span class="subst">$(^Name)</span> ï¼Œå…¶åŠæ‰€æœ‰çš„ç»„ä»¶ï¼Ÿ&quot;</span> IDYES +2</span><br><span class="line">  Abort</span><br><span class="line">FunctionEnd</span><br><span class="line"></span><br><span class="line">Section Uninstall</span><br><span class="line">  !insertmacro MUI_STARTMENU_GETFOLDER <span class="string">&quot;Application&quot;</span> <span class="variable">$ICONS_GROUP</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\$&#123;PRODUCT_NAME&#125;.url&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\uninst.exe&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\_asyncio.pyd&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\_bz2.pyd&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\_cffi_backend.pyd&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\_ctypes.pyd&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\_decimal.pyd&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\_elementtree.pyd&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\_hashlib.pyd&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\_lzma.pyd&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\_overlapped.pyd&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\_queue.pyd&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\_socket.pyd&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\_ssl.pyd&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\_uuid.pyd&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\libcrypto-1_1.dll&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\libffi-7.dll&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\libssl-1_1.dll&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\msvcp140.dll&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\msvcp140_1.dll&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\pyexpat.pyd&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\python3.dll&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\python39.dll&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\qt5charts.dll&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\qt5core.dll&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\qt5gui.dll&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\qt5svg.dll&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\qt5widgets.dll&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\select.pyd&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\ui_main.exe&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\unicodedata.pyd&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\vcruntime140.dll&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$INSTDIR</span>\vcruntime140_1.dll&quot;</span></span><br><span class="line"></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$SMPROGRAMS</span>\$ICONS_GROUP\Uninstall.lnk&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$SMPROGRAMS</span>\$ICONS_GROUP\Website.lnk&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$DESKTOP</span>\spider image system.lnk&quot;</span></span><br><span class="line">  Delete <span class="string">&quot;<span class="variable">$SMPROGRAMS</span>\$ICONS_GROUP\spider image system.lnk&quot;</span></span><br><span class="line"></span><br><span class="line">  RMDir <span class="string">&quot;<span class="variable">$SMPROGRAMS</span>\$ICONS_GROUP&quot;</span></span><br><span class="line">  RMDir <span class="string">&quot;<span class="variable">$INSTDIR</span>&quot;</span></span><br><span class="line"></span><br><span class="line">  DeleteRegKey <span class="variable">$&#123;PRODUCT_UNINST_ROOT_KEY&#125;</span> <span class="string">&quot;<span class="variable">$&#123;PRODUCT_UNINST_KEY&#125;</span>&quot;</span></span><br><span class="line">  DeleteRegKey HKLM <span class="string">&quot;<span class="variable">$&#123;PRODUCT_DIR_REGKEY&#125;</span>&quot;</span></span><br><span class="line">  SetAutoClose <span class="literal">true</span></span><br><span class="line">SectionEnd</span><br></pre></td></tr></table></figure><h4 id="ç¼–è¯‘å¹¶è¿è¡Œç”Ÿæˆexe">ç¼–è¯‘å¹¶è¿è¡Œç”Ÿæˆexe</h4><ul><li>ç‚¹å‡»å¦‚ä¸‹<br><img src="/2024/04/10/setup-tools-python/complier.png" class="lazyload placeholder" data-srcset="/2024/04/10/setup-tools-python/complier.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></li><li>ç”Ÿæˆå®Œæˆåï¼Œåœ¨è„šæœ¬åŒç›®å½•ç‚¹å‡»setup.exeå³å¯å®‰è£…</li></ul><h2 id="See">See</h2><ul><li>[1].<a href="https://blog.csdn.net/daimashiren/article/details/115067313">https://blog.csdn.net/daimashiren/article/details/115067313</a></li><li>[2].<a href="https://www.cnblogs.com/qq21497936/p/14738082.html">https://www.cnblogs.com/qq21497936/p/14738082.html</a></li><li>[3].<a href="https://blog.csdn.net/technologyleader/article/details/125283717">https://blog.csdn.net/technologyleader/article/details/125283717</a></li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨pyinstalleræ‰“åŒ…pythonç¨‹åºå¹¶å‘å¸ƒ</title>
      <link href="/2024/04/09/pyinstaller-publish-python/"/>
      <url>/2024/04/09/pyinstaller-publish-python/</url>
      
        <content type="html"><![CDATA[<h1>ä½¿ç”¨pyinstalleræ‰“åŒ…pythonç¨‹åºå¹¶å‘å¸ƒ</h1><h2 id="ç®€ä»‹">ç®€ä»‹</h2><blockquote><p>PyInstaller å°† Python åº”ç”¨ç¨‹åºåŠå…¶æ‰€æœ‰ä¾èµ–é¡¹æ†ç»‘åˆ°å•ä¸ªè½¯ä»¶åŒ…ä¸­ã€‚ç”¨æˆ·æ— éœ€å®‰è£… Python è§£é‡Šå™¨æˆ–ä»»ä½•æ¨¡å—ï¼Œå³å¯è¿è¡Œæ‰“åŒ…åçš„åº”ç”¨ç¨‹åºã€‚PyInstaller æ”¯æŒ Python 3.8 åŠå…¶æ›´æ–°ç‰ˆæœ¬ï¼Œå¹¶èƒ½æ­£ç¡®æ†ç»‘ numpyã€matplotlibã€PyQtã€wxPython ç­‰è®¸å¤šä¸»æµ Python åŒ…ã€‚</p></blockquote><blockquote><p>PyInstaller å·²ç»è¿‡ Windowsã€MacOS X å’Œ Linux æµ‹è¯•ã€‚ä¸è¿‡ï¼Œå®ƒå¹¶ä¸æ˜¯ä¸€ä¸ªäº¤å‰ç¼–è¯‘å™¨ï¼›è¦åˆ¶ä½œ Windows åº”ç”¨ç¨‹åºå°±éœ€è¦åœ¨ Windows ä¸Šè¿è¡Œ PyInstallerï¼Œè¦åˆ¶ä½œ Linux åº”ç”¨ç¨‹åºå°±éœ€è¦åœ¨ Linux ä¸Šè¿è¡Œå®ƒï¼Œä¾æ­¤ç±»æ¨ã€‚PyInstaller å·²ç»æˆåŠŸåœ°åœ¨ AIXã€Solarisã€FreeBSD å’Œ OpenBSD ä¸Šä½¿ç”¨ï¼Œä½†é’ˆå¯¹è¿™äº›å¹³å°çš„æµ‹è¯•å¹¶ä¸æ˜¯æˆ‘ä»¬æŒç»­é›†æˆæµ‹è¯•çš„ä¸€éƒ¨åˆ†ï¼Œå¼€å‘å›¢é˜Ÿä¹Ÿä¸èƒ½ä¿è¯ï¼ˆè¿™äº›å¹³å°çš„æ‰€æœ‰ä»£ç éƒ½æ¥è‡ªå¤–éƒ¨è´¡çŒ®ï¼‰PyInstaller å°†èƒ½å¤Ÿåœ¨è¿™äº›å¹³å°ä¸Šè¿è¡Œï¼Œæˆ–å¾—åˆ°æŒç»­æ”¯æŒã€‚</p></blockquote><ul><li>upx</li></ul><blockquote><p>UPX æ˜¯ä¸€æ¬¾ç”¨äºå‹ç¼©å¯æ‰§è¡Œæ–‡ä»¶å’Œåº“çš„å…è´¹å·¥å…·ã€‚å®ƒé€‚ç”¨äºå¤§å¤šæ•°æ“ä½œç³»ç»Ÿï¼Œå¯ç”¨å‹ç¼©å¤§é‡å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ã€‚</p></blockquote><blockquote><p>å½“ UPX å¯ç”¨æ—¶ï¼ŒPyInstaller ä¼šç”¨å®ƒæ¥å•ç‹¬å‹ç¼©æ¯ä¸ªæ”¶é›†çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå¯æ‰§è¡Œæ–‡ä»¶ã€å…±äº«åº“æˆ– Python æ‰©å±•ï¼‰ä»¥å‡å°å†»ç»“åº”ç”¨ç¨‹åºï¼ˆå•æ–‡ä»¶å¤¹æ†ç»‘çš„ç›®å½•æˆ–å•æ–‡ä»¶å¯æ‰§è¡Œæ–‡ä»¶ï¼‰çš„æ•´ä½“å¤§å°ã€‚å†»ç»“åº”ç”¨ç¨‹åºçš„å¯æ‰§è¡Œæ–‡ä»¶æœ¬èº«å¹¶æ²¡æœ‰ç»è¿‡ UPX å‹ç¼©ï¼ˆä¸ç®¡æ˜¯å•æ–‡ä»¶å¤¹æ¨¡å¼è¿˜æ˜¯å•æ–‡ä»¶æ¨¡å¼ï¼‰ï¼Œå› ä¸ºå…¶æ–‡ä»¶å¤§å°ä¸­çš„å¤§éƒ¨åˆ†éƒ½å·²ç»æ˜¯ç”±åŒ…å«å•ç‹¬å‹ç¼©æ–‡ä»¶çš„åµŒå…¥å¼å‹ç¼©åŒ…æ„æˆã€‚</p></blockquote><blockquote><p>PyInstaller ä¼šåœ¨æ ‡å‡†å¯æ‰§è¡Œè·¯å¾„ï¼ˆç”± PATH ç¯å¢ƒå˜é‡å®šä¹‰ï¼‰æˆ–é€šè¿‡ --upx-dir å‘½ä»¤è¡Œé€‰é¡¹æŒ‡å®šçš„è·¯å¾„ä¸­æŸ¥æ‰¾ UPXã€‚å¦‚æœæ‰¾åˆ°ï¼Œå°±ä¼šè‡ªåŠ¨ä½¿ç”¨ã€‚ä½¿ç”¨ --noupx å‘½ä»¤è¡Œé€‰é¡¹å¯ç”¨å®Œå…¨ç¦ç”¨ UPXã€‚</p></blockquote><h2 id="å®‰è£…">å®‰è£…</h2><ul><li>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pyinstaller</span><br></pre></td></tr></table></figure><ul><li>ç‰ˆæœ¬å‡çº§</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install --upgrade pyinstaller</span><br></pre></td></tr></table></figure><ul><li>å¸¸ç”¨command  option</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">å‚æ•°è¯´æ˜</span><br><span class="line">-F<span class="comment"># äº§ç”Ÿå•ä¸ªçš„å¯æ‰§è¡Œæ–‡ä»¶</span></span><br><span class="line">-D<span class="comment"># äº§ç”Ÿä¸€ä¸ªç›®å½•ï¼ˆåŒ…å«å¤šä¸ªæ–‡ä»¶ï¼‰ä½œä¸ºå¯æ‰§è¡Œç¨‹åº</span></span><br><span class="line">-a<span class="comment"># ä¸åŒ…å« Unicode å­—ç¬¦é›†æ”¯æŒ</span></span><br><span class="line">-d<span class="comment"># debug ç‰ˆæœ¬çš„å¯æ‰§è¡Œæ–‡ä»¶</span></span><br><span class="line">-w<span class="comment"># æŒ‡å®šç¨‹åºè¿è¡Œæ—¶ä¸æ˜¾ç¤ºå‘½ä»¤è¡Œçª—å£ï¼ˆä»…å¯¹ Windows æœ‰æ•ˆï¼‰</span></span><br><span class="line">-c<span class="comment"># æŒ‡å®šä½¿ç”¨å‘½ä»¤è¡Œçª—å£è¿è¡Œç¨‹åºï¼ˆä»…å¯¹ Windows æœ‰æ•ˆï¼‰</span></span><br><span class="line">-o<span class="comment"># æŒ‡å®š spec æ–‡ä»¶çš„ç”Ÿæˆç›®å½•ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œåˆ™é»˜è®¤ä½¿ç”¨å½“å‰ç›®å½•æ¥ç”Ÿæˆ spec æ–‡ä»¶</span></span><br><span class="line">-p<span class="comment"># è®¾ç½® Python å¯¼å…¥æ¨¡å—çš„è·¯å¾„ï¼ˆå’Œè®¾ç½® PYTHONPATH ç¯å¢ƒå˜é‡çš„ä½œç”¨ç›¸ä¼¼ï¼‰ã€‚ä¹Ÿå¯ä½¿ç”¨è·¯å¾„åˆ†éš”ç¬¦ï¼ˆWindows ä½¿ç”¨åˆ†å·ï¼ŒLinux ä½¿ç”¨å†’å·ï¼‰æ¥åˆ†éš”å¤šä¸ªè·¯å¾„</span></span><br><span class="line">-n<span class="comment"># æŒ‡å®šé¡¹ç›®ï¼ˆäº§ç”Ÿçš„ specï¼‰åå­—ã€‚å¦‚æœçœç•¥è¯¥é€‰é¡¹ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªè„šæœ¬çš„ä¸»æ–‡ä»¶åå°†ä½œä¸º spec çš„åå­—</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="å‘å¸ƒ">å‘å¸ƒ</h2><h3 id="ä¸¾ä¾‹-1">ä¸¾ä¾‹ 1</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyinstaller -F -w -i favicon.ico test.py</span><br></pre></td></tr></table></figure><h3 id="ä¸¾ä¾‹-2-åˆ©ç”¨specé…ç½®æ–‡ä»¶æ‰“åŒ…">ä¸¾ä¾‹ 2(åˆ©ç”¨specé…ç½®æ–‡ä»¶æ‰“åŒ…)</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- mode: python ; coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># test.spec</span></span><br><span class="line"></span><br><span class="line">block_cipher = None</span><br><span class="line"></span><br><span class="line">a = Analysis([<span class="string">&#x27;test.py&#x27;</span>],</span><br><span class="line">             pathex=[<span class="string">&#x27;F:\\PythonCool\\pyinstaller&#x27;</span>],</span><br><span class="line">             binaries=[],</span><br><span class="line">             datas=[], <span class="comment"># è¿™é‡Œå¸¦ä¸Šèµ„æºæ–‡ä»¶åœ°å€</span></span><br><span class="line">            <span class="comment">#  datas=[(&#x27;C:\\Users\\Gdc\\anaconda3\\envs\\env_test\\Lib\\site-packages\\data\\data&#x27;,&#x27;data&#x27;)], # è¿™é‡Œå¸¦ä¸Šèµ„æºæ–‡ä»¶åœ°å€</span></span><br><span class="line">             hiddenimports=[], <span class="comment"># åŠ¨æ€å¼•å…¥çš„åº“æˆ–æ¨¡å—</span></span><br><span class="line">            <span class="comment">#  hiddenimports=[&#x27;palettable&#x27;], # åŠ¨æ€å¼•å…¥çš„åº“æˆ–æ¨¡å—</span></span><br><span class="line">             hookspath=[],</span><br><span class="line">             runtime_hooks=[],</span><br><span class="line">             excludes=[],</span><br><span class="line">             win_no_prefer_redirects=False,</span><br><span class="line">             win_private_assemblies=False,</span><br><span class="line">             cipher=block_cipher,</span><br><span class="line">             noarchive=False)</span><br><span class="line">pyz = PYZ(a.pure, a.zipped_data,</span><br><span class="line">             cipher=block_cipher)</span><br><span class="line">exe = EXE(pyz,</span><br><span class="line">          a.scripts,</span><br><span class="line">          a.binaries,</span><br><span class="line">          a.zipfiles,</span><br><span class="line">          a.datas,</span><br><span class="line">          [],</span><br><span class="line">          name=<span class="string">&#x27;test&#x27;</span>,</span><br><span class="line">          debug=False,</span><br><span class="line">          bootloader_ignore_signals=False,</span><br><span class="line">          strip=False,</span><br><span class="line">          upx=True,</span><br><span class="line">          upx_exclude=[],</span><br><span class="line">          runtime_tmpdir=None,</span><br><span class="line">          console=True , icon=<span class="string">&#x27;icon.ico&#x27;</span>)</span><br></pre></td></tr></table></figure><ul><li>ç¼–å†™ä¸Šè¿°é…ç½®æ–‡ä»¶åï¼Œå‘½åä¸ºtest.spec,ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰“åŒ…ï¼š</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyinstaller -D test.spec  </span><br></pre></td></tr></table></figure><h2 id="åº”ç”¨">åº”ç”¨</h2><h3 id="demoä¸¾ä¾‹">demoä¸¾ä¾‹</h3><ul><li>specæ–‡ä»¶ä¸¾ä¾‹</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- mode: python ; coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">block_cipher = None</span><br><span class="line"></span><br><span class="line">a = Analysis(</span><br><span class="line">    [<span class="string">&#x27;ui_main.py&#x27;</span>],</span><br><span class="line">    pathex=[],</span><br><span class="line">    binaries=[],</span><br><span class="line">    datas=[</span><br><span class="line">    (<span class="string">&#x27;C:\\Users\\ad\\PycharmProjects\\pro\\src\\file&#x27;</span>,<span class="string">&#x27;file&#x27;</span>)</span><br><span class="line">    ],</span><br><span class="line">    hiddenimports=[],</span><br><span class="line">    hookspath=[],</span><br><span class="line">    hooksconfig=&#123;&#125;,</span><br><span class="line">    runtime_hooks=[],</span><br><span class="line">    excludes=[],</span><br><span class="line">    win_no_prefer_redirects=False,</span><br><span class="line">    win_private_assemblies=False,</span><br><span class="line">    cipher=block_cipher,</span><br><span class="line">    noarchive=False,</span><br><span class="line">)</span><br><span class="line">pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)</span><br><span class="line"></span><br><span class="line">exe = EXE(</span><br><span class="line">    pyz,</span><br><span class="line">    a.scripts,</span><br><span class="line">    a.binaries,</span><br><span class="line">    a.zipfiles,</span><br><span class="line">    a.datas,</span><br><span class="line">    [],</span><br><span class="line">    name=<span class="string">&#x27;test&#x27;</span>,</span><br><span class="line">    debug=False,</span><br><span class="line">    bootloader_ignore_signals=False,</span><br><span class="line">    strip=False,</span><br><span class="line">    upx=True,</span><br><span class="line">    upx_exclude=[],</span><br><span class="line">    runtime_tmpdir=None,</span><br><span class="line">    console=True,</span><br><span class="line">    disable_windowed_traceback=False,</span><br><span class="line">    argv_emulation=False,</span><br><span class="line">    target_arch=None,</span><br><span class="line">    codesign_identity=None,</span><br><span class="line">    entitlements_file=None,</span><br><span class="line">    icon=<span class="string">&#x27;test.ico&#x27;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><h3 id="æ‰©å±•">æ‰©å±•</h3><ul><li>å¯é€šè¿‡batæˆ–shè„šæœ¬æ‰§è¡Œæ‰“åŒ…ï¼Œä¸¾ä¾‹å¦‚ä¸‹:</li></ul><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="built_in">setlocal</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">REM åˆ é™¤distå’Œbuildç›®å½•</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">exist</span> &quot;dist&quot; (</span><br><span class="line">    <span class="built_in">rmdir</span> /s /q &quot;dist&quot;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">exist</span> &quot;build&quot; (</span><br><span class="line">    <span class="built_in">rmdir</span> /s /q &quot;build&quot;</span><br><span class="line">)</span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">REM è¿è¡Œpyinstaller main_sis.specè¿›è¡Œæ‰“åŒ…</span></span><br><span class="line">pyinstaller main_sis.spec</span><br><span class="line"></span><br><span class="line"><span class="built_in">endlocal</span></span><br></pre></td></tr></table></figure><ul><li>sh</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyinstaller main_sis.spec</span><br></pre></td></tr></table></figure><h2 id="specè§£æ">specè§£æ</h2><h3 id="è¯¦ç»†å¦‚ä¸‹">è¯¦ç»†å¦‚ä¸‹</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- mode: python ; coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># scriptï¼š å†™æ‰€æœ‰çš„pyæ–‡ä»¶</span></span><br><span class="line"><span class="comment"># pathexï¼šå†™é¡¹ç›®çš„åœ°å€ï¼Œä»¥åŠè‡ªå®šä¹‰åº“çš„åœ°å€</span></span><br><span class="line"><span class="comment"># datasï¼šé™æ€æ–‡ä»¶æ•°æ®çš„åœ°å€</span></span><br><span class="line"><span class="comment"># binariesï¼šäºŒè¿›åˆ¶æ–‡ä»¶åœ°å€ï¼Œå¦‚æœæœ‰æŠ¥é”™ï¼Œæˆ–è€…ï¼Œéœ€è¦ç”¨çš„æ—¶å€™å†æ·»åŠ </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">block_cipher = None</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™ä¸€éƒ¨åˆ†è´Ÿè´£æ”¶é›†ä½ çš„è„šæœ¬éœ€è¦çš„æ‰€æœ‰æ¨¡å—å’Œæ–‡ä»¶ã€‚çš„ï¼›hiddenimports å‚æ•°å¯ä»¥æŒ‡å®šä¸€äº› PyInstaller æ— æ³•è‡ªåŠ¨æ£€æµ‹åˆ°çš„æ¨¡å—ã€‚</span></span><br><span class="line">a = Analysis(</span><br><span class="line">    [<span class="string">&#x27;hello.py&#x27;</span>],       <span class="comment"># æŒ‡å®šè¦æ‰“åŒ…çš„ Python è„šæœ¬çš„è·¯å¾„ï¼ˆå¯ä»¥æ˜¯ç›¸å¯¹è·¯å¾„ï¼‰</span></span><br><span class="line">    pathex=[],          <span class="comment"># ç”¨æ¥æŒ‡å®šæ¨¡å—æœç´¢è·¯å¾„</span></span><br><span class="line">    binaries=[],        <span class="comment"># åŒ…å«äº†åŠ¨æ€é“¾æ¥åº“æˆ–å…±äº«å¯¹è±¡æ–‡ä»¶ï¼Œä¼šåœ¨è¿è¡Œä¹‹åè‡ªåŠ¨æ›´æ–°ï¼ŒåŠ å…¥ä¾èµ–çš„äºŒè¿›åˆ¶æ–‡ä»¶</span></span><br><span class="line">    datas=[],           <span class="comment"># åˆ—è¡¨ï¼Œç”¨äºæŒ‡å®šéœ€è¦åŒ…å«çš„é¢å¤–æ–‡ä»¶ã€‚æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªå…ƒç»„ï¼šï¼ˆæ–‡ä»¶çš„æºè·¯å¾„, åœ¨æ‰“åŒ…æ–‡ä»¶ä¸­çš„è·¯å¾„)</span></span><br><span class="line">    hiddenimports=[],   <span class="comment"># ç”¨äºæŒ‡å®šä¸€äº› PyInstaller æ— æ³•è‡ªåŠ¨æ£€æµ‹åˆ°çš„æ¨¡å—</span></span><br><span class="line">    hookspath=[],       <span class="comment"># æŒ‡å®šæŸ¥æ‰¾ PyInstaller é’©å­çš„è·¯å¾„</span></span><br><span class="line">    hooksconfig=&#123;&#125;,     <span class="comment"># è‡ªå®šä¹‰ hook é…ç½®ï¼Œè¿™æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œä¸€è¡Œæ³¨é‡Šå†™ä¸ä¸‹ï¼Œæ­¤å¤„å…ˆä¸è®²</span></span><br><span class="line">    runtime_hooks=[],   <span class="comment"># æŒ‡å®šè¿è¡Œæ—¶ hookï¼Œæœ¬è´¨æ˜¯ä¸€ä¸ª Python è„šæœ¬ï¼Œhook ä¼šåœ¨ä½ çš„è„šæœ¬è¿è¡Œå‰è¿è¡Œï¼Œå¯ç”¨äºå‡†å¤‡ç¯å¢ƒ</span></span><br><span class="line">    excludes=[],        <span class="comment"># ç”¨äºæŒ‡å®šéœ€è¦æ’é™¤çš„æ¨¡å—</span></span><br><span class="line">    win_no_prefer_redirects=False,</span><br><span class="line">    win_private_assemblies=False,</span><br><span class="line">    cipher=block_cipher,</span><br><span class="line">    noarchive=False,</span><br><span class="line">)</span><br><span class="line"><span class="comment"># é™¤æ­¤ä¹‹å¤–ï¼Œa è¿˜æœ‰ä¸€äº›æ²¡æœ‰åˆ—å‡ºçš„å±æ€§ï¼š</span></span><br><span class="line"><span class="comment">#   pure æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼ŒåŒ…å«äº†æ‰€æœ‰çº¯ Python æ¨¡å—çš„ä¿¡æ¯ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªå…ƒç»„ï¼ŒåŒ…å«äº†ï¼šæ¨¡å—å, pycè·¯å¾„, py è·¯å¾„ï¼Œè¿™äº›æ¨¡å—ä¼šè¢«æ‰“åŒ…åˆ°ä¸€ä¸ª .pyz æ–‡ä»¶ä¸­ã€‚</span></span><br><span class="line"><span class="comment">#   scripts æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼ŒåŒ…å«äº†ä½ çš„ Python è„šæœ¬çš„ä¿¡æ¯ã€‚æ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªå…ƒç»„ï¼Œå…¶ä¸­åŒ…å«äº†è„šæœ¬çš„å†…éƒ¨åï¼Œè„šæœ¬çš„æºè·¯å¾„ï¼Œä»¥åŠä¸€äº›å…ƒæ•°æ®ã€‚è¿™äº›è„šæœ¬ä¼šè¢«æ‰“åŒ…åˆ°ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ä¸­ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pyz æ˜¯æŒ‡ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶çš„åç§°ã€‚å®ƒæ˜¯ç”± PyInstaller ç”¨æ¥æ‰“åŒ… Python ç¨‹åºå’Œä¾èµ–é¡¹çš„ä¸»è¦æ–‡ä»¶ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º pyz æ–‡ä»¶ï¼Œå®ƒåœ¨è¿è¡Œæ—¶ä¼šè¢«è§£å‹ç¼©åˆ°ä¸´æ—¶ç›®å½•ä¸­ï¼Œç„¶åè¢«åŠ è½½å’Œæ‰§è¡Œã€‚å®ƒä¼šè¢«æ‰“åŒ…è¿› exe æ–‡ä»¶</span></span><br><span class="line">pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º exe æ–‡ä»¶</span></span><br><span class="line">exe = EXE(</span><br><span class="line">    pyz,            <span class="comment"># åŒ…å«äº†æ‰€æœ‰çº¯ Python æ¨¡å—</span></span><br><span class="line">    a.scripts,      <span class="comment"># åŒ…å«äº†ä¸»è„šæœ¬åŠå…¶ä¾èµ–</span></span><br><span class="line">    [],             <span class="comment"># æ‰€æœ‰éœ€è¦æ‰“åŒ…åˆ° exe æ–‡ä»¶å†…çš„äºŒè¿›åˆ¶æ–‡ä»¶</span></span><br><span class="line">    exclude_binaries=True,  <span class="comment"># è‹¥ä¸º Trueï¼Œæ‰€æœ‰çš„äºŒè¿›åˆ¶æ–‡ä»¶å°†è¢«æ’é™¤åœ¨ exe ä¹‹å¤–ï¼Œè½¬è€Œè¢« COLLECT å‡½æ•°æ”¶é›†</span></span><br><span class="line">    name=<span class="string">&#x27;hello&#x27;</span>,   <span class="comment"># ç”Ÿæˆçš„ exe æ–‡ä»¶çš„åå­—ã€‚</span></span><br><span class="line">    debug=False,    <span class="comment"># æ‰“åŒ…è¿‡ç¨‹ä¸­æ˜¯å¦æ‰“å°è°ƒè¯•ä¿¡æ¯ï¼Ÿ</span></span><br><span class="line">    bootloader_ignore_signals=False,</span><br><span class="line">    strip=False,    <span class="comment"># æ˜¯å¦ç§»é™¤æ‰€æœ‰çš„ç¬¦å·ä¿¡æ¯ï¼Œä½¿æ‰“åŒ…å‡ºçš„ exe æ–‡ä»¶æ›´å°</span></span><br><span class="line">    upx=True,       <span class="comment"># æ˜¯å¦ç”¨ upx å‹ç¼© exe æ–‡ä»¶</span></span><br><span class="line">    console=True,   <span class="comment"># è‹¥ä¸º True åˆ™åœ¨æ§åˆ¶å°çª—å£ä¸­è¿è¡Œï¼Œå¦åˆ™ä½œä¸ºåå°è¿›ç¨‹è¿è¡Œ</span></span><br><span class="line">    disable_windowed_traceback=False,</span><br><span class="line">    argv_emulation=False,</span><br><span class="line">    target_arch=None,</span><br><span class="line">    codesign_identity=None,</span><br><span class="line">    entitlements_file=None,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™ä¸ªå¯¹è±¡åŒ…å«äº†æ‰€æœ‰éœ€è¦åˆ†å‘çš„æ–‡ä»¶</span></span><br><span class="line"><span class="comment"># åŒ…æ‹¬ EXE å‡½æ•°åˆ›å»ºçš„ exe æ–‡ä»¶ã€æ‰€æœ‰çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€zip æ–‡ä»¶ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰å’Œæ•°æ®æ–‡ä»¶</span></span><br><span class="line">coll = COLLECT(</span><br><span class="line">    exe,</span><br><span class="line">    a.binaries,</span><br><span class="line">    a.zipfiles,</span><br><span class="line">    a.datas,</span><br><span class="line">    strip=False,</span><br><span class="line">    upx=True,</span><br><span class="line">    upx_exclude=[],</span><br><span class="line">    name=<span class="string">&#x27;hello&#x27;</span>,   <span class="comment"># ç”Ÿæˆçš„æ–‡ä»¶å¤¹çš„åå­—</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><h3 id="é—®é¢˜">é—®é¢˜</h3><h4 id="1-pyinstaller-æ‰“åŒ…åæ— æ³•é€šè¿‡åå°„è®¿é—®pyæ–‡ä»¶">1.pyinstaller æ‰“åŒ…åæ— æ³•é€šè¿‡åå°„è®¿é—®pyæ–‡ä»¶</h4><ul><li>è§£å†³æ–¹æ³•</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> crawlers.base <span class="keyword">import</span> BaseCrawler</span><br><span class="line"><span class="keyword">from</span> crawlers.public.daili66 <span class="keyword">import</span> Daili66Crawler</span><br><span class="line"><span class="keyword">from</span> crawlers.public.data5u <span class="keyword">import</span> Data5UCrawler</span><br><span class="line"><span class="keyword">from</span> crawlers.public.docip <span class="keyword">import</span> DocipCrawler</span><br><span class="line"><span class="keyword">from</span> crawlers.public.fatezero <span class="keyword">import</span> FatezeroCrawler</span><br><span class="line"><span class="keyword">from</span> crawlers.public.geonodedaili <span class="keyword">import</span> GeonodeCrawler</span><br><span class="line"><span class="keyword">from</span> crawlers.public.goubanjia <span class="keyword">import</span> GoubanjiaCrawler</span><br><span class="line"><span class="keyword">from</span> crawlers.public.ihuan <span class="keyword">import</span> IhuanCrawler</span><br><span class="line"><span class="keyword">from</span> crawlers.public.ip3366 <span class="keyword">import</span> IP3366Crawler</span><br><span class="line"><span class="keyword">from</span> crawlers.public.iphai <span class="keyword">import</span> IPHaiCrawler</span><br><span class="line"><span class="keyword">from</span> crawlers.public.jiangxianli <span class="keyword">import</span> JiangxianliCrawler</span><br><span class="line"><span class="keyword">from</span> crawlers.public.kuaidaili <span class="keyword">import</span> KuaidailiCrawler</span><br><span class="line"><span class="keyword">from</span> crawlers.public.seofangfa <span class="keyword">import</span> SeoFangFaCrawler</span><br><span class="line"><span class="keyword">from</span> crawlers.public.taiyangdaili <span class="keyword">import</span> TaiyangdailiCrawler</span><br><span class="line"><span class="keyword">from</span> crawlers.public.uqidata <span class="keyword">import</span> UqidataCrawler</span><br><span class="line"><span class="keyword">from</span> crawlers.public.xiaoshudaili <span class="keyword">import</span> XiaoShuCrawler</span><br><span class="line"><span class="keyword">from</span> crawlers.public.xicidaili <span class="keyword">import</span> XicidailiCrawler</span><br><span class="line"><span class="keyword">from</span> crawlers.public.xiladaili <span class="keyword">import</span> XiladailiCrawler</span><br><span class="line"><span class="keyword">from</span> crawlers.public.yqie <span class="keyword">import</span> YqIeCrawler</span><br><span class="line"><span class="keyword">from</span> crawlers.public.zhandaye <span class="keyword">import</span> ZhandayeCrawler</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–æ¨¡å—ä¸­æ‰€æœ‰çš„ç±»</span></span><br><span class="line">crawlers_cls = [</span><br><span class="line">    base,</span><br><span class="line">    Ip89Crawler,</span><br><span class="line">    Daili66Crawler,</span><br><span class="line">    Data5UCrawler,</span><br><span class="line">    DocipCrawler,</span><br><span class="line">    FatezeroCrawler,</span><br><span class="line">    GeonodeCrawler,</span><br><span class="line">    GoubanjiaCrawler,</span><br><span class="line">    IhuanCrawler,</span><br><span class="line">    IP3366Crawler,</span><br><span class="line">    IPHaiCrawler,</span><br><span class="line">    JiangxianliCrawler,</span><br><span class="line">    KuaidailiCrawler,</span><br><span class="line">    SeoFangFaCrawler,</span><br><span class="line">    TaiyangdailiCrawler,</span><br><span class="line">    UqidataCrawler,</span><br><span class="line">    XiaoShuCrawler,</span><br><span class="line">    XicidailiCrawler,</span><br><span class="line">    XiladailiCrawler,</span><br><span class="line">    YqIeCrawler,</span><br><span class="line">    ZhandayeCrawler</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">crawlers_cls = [cls <span class="keyword">for</span> cls <span class="keyword">in</span> crawlers_cls</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(cls, <span class="built_in">type</span>) <span class="keyword">and</span> <span class="built_in">issubclass</span>(cls, BaseCrawler) <span class="keyword">and</span> cls <span class="keyword">is</span> <span class="keyword">not</span> BaseCrawler</span><br><span class="line">    <span class="keyword">and</span> <span class="keyword">not</span> <span class="built_in">getattr</span>(cls, <span class="string">&#x27;ignore&#x27;</span>, <span class="literal">False</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># è°ƒç”¨</span></span><br><span class="line"><span class="variable language_">self</span>.crawlers = [crawler_cls() <span class="keyword">for</span> crawler_cls <span class="keyword">in</span> <span class="variable language_">self</span>.crawlers_cls]</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="2-æ‰“åŒ…åæ— æ³•è®¿é—®æŒ‡å®šæ•°æ®">2.æ‰“åŒ…åæ— æ³•è®¿é—®æŒ‡å®šæ•°æ®</h4><ul><li>è§£å†³åŠæ³•</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_data_file</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    è·å–æ•°æ®æ–‡ä»¶çš„è·¯å¾„ï¼Œæ— è®ºæ˜¯ç›´æ¥è¿è¡Œè¿˜æ˜¯é€šè¿‡ PyInstaller æ‰“åŒ… æŠ‘æˆ–nuitkaæ‰“åŒ…</span></span><br><span class="line"><span class="string">    :param filename</span></span><br><span class="line"><span class="string">    :return</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># pyinstaller æ‰“åŒ…</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">getattr</span>(sys, <span class="string">&#x27;frozen&#x27;</span>, <span class="literal">False</span>):</span><br><span class="line">        <span class="comment"># å¦‚æœç¨‹åºæ˜¯â€œå†·å†»çš„â€ï¼Œå³æ‰“åŒ…åçš„ exe</span></span><br><span class="line">        <span class="comment"># nuitka æ‰“åŒ…</span></span><br><span class="line">        <span class="keyword">if</span> run.__compiled__:</span><br><span class="line">            basedir = os.getcwd()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            basedir = sys._MEIPASS</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># å¦‚æœç¨‹åºæ˜¯ç›´æ¥è¿è¡Œçš„ï¼Œå³æ²¡æœ‰æ‰“åŒ…</span></span><br><span class="line">        basedir = os.path.dirname(__file__)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> os.path.join(basedir, filename)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="See">See</h2><ul><li>[1].<a href="https://www.cnblogs.com/haujet/p/PyInstaller-Perfect-Build.html">https://www.cnblogs.com/haujet/p/PyInstaller-Perfect-Build.html</a></li><li>[2].<a href="https://www.cnblogs.com/bbiu/p/13209612.html">https://www.cnblogs.com/bbiu/p/13209612.html</a></li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨nuitkaæ‰“åŒ…pythonä¸ºexeå¹¶å‘å¸ƒ</title>
      <link href="/2024/04/09/nuitka-publish-python/"/>
      <url>/2024/04/09/nuitka-publish-python/</url>
      
        <content type="html"><![CDATA[<h1>ä½¿ç”¨nuitkaæ‰“åŒ…pythonä¸ºexeå¹¶å‘å¸ƒ</h1><h2 id="ç®€ä»‹">ç®€ä»‹</h2><blockquote><p>Nuitka is the optimizing Python compiler written in Python that creates executables that run without an need for a separate installer. Data files can both be included or put alongside.</p></blockquote><blockquote><p>Nuitka is fully compatible with Python 3 (3.4 â€” 3.11) and Python 2 (2.6, 2.7), works on Windows, macOS, Linux and more, basically where Python works for you already.</p></blockquote><ul><li>ä½¿ç”¨æ­¤åº“å¯è¾¾åˆ°ä»¥ä¸‹ç›®çš„ï¼š</li><li>éšè—æºç ã€‚è¿™é‡Œçš„pyinstalleræ˜¯é€šè¿‡è®¾ç½®keyæ¥å¯¹æºç è¿›è¡ŒåŠ å¯†çš„ï¼›è€Œnuitkaåˆ™æ˜¯å°†pythonæºç è½¬æˆC++ï¼ˆè¿™é‡Œå¾—åˆ°çš„æ˜¯äºŒè¿›åˆ¶çš„pydæ–‡ä»¶ï¼Œé˜²æ­¢äº†åç¼–è¯‘ï¼‰ï¼Œç„¶åå†ç¼–è¯‘æˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚</li><li>æ–¹ä¾¿ç§»æ¤ï¼šè·¨å¹³å°ï¼Œå¯å¤šå¹³å°ä½¿ç”¨ï¼šwinã€macã€linuxç­‰</li></ul><h3 id="ä¼˜åŠ¿">ä¼˜åŠ¿</h3><ul><li>å°ä½“ç§¯</li><li>å¯åŠ¨å¿«é€Ÿ</li><li>ä¸æ˜“é€†å‘è§£æ</li></ul><h3 id="ç¼ºç‚¹">ç¼ºç‚¹</h3><ul><li>æ‰“åŒ…è¾ƒä¸ºç¼“æ…¢</li><li>ä»…æä¾›å‘½ä»¤è¡Œå¼æ‰“åŒ…ï¼ˆæ— é…ç½®æ–‡ä»¶ï¼‰</li></ul><h2 id="å®‰è£…">å®‰è£…</h2><ul><li>nuitkaä¸»è¦é€šè¿‡pipå‘½ä»¤å®‰è£…ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip install Nuitka</span><br><span class="line">pip install ordered-set</span><br><span class="line">pip install zstandard</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœä¸Šè¿°å‘½ä»¤æ‰§è¡Œè¾ƒæ…¢ï¼Œå¯ä½¿ç”¨é•œåƒæºå®‰è£…ï¼š</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line">pip install -i https://pypi.tuna.tsinghua.edu.cn/simple Nuitka</span><br></pre></td></tr></table></figure><h2 id="æ‰“åŒ…å‘å¸ƒ">æ‰“åŒ…å‘å¸ƒ</h2><ul><li>å‘½ä»¤ä¸¾ä¾‹å¦‚ä¸‹ï¼š</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --follow-import-toä¸ºéœ€è¦æ‰“åŒ…çš„æ¨¡å—å </span></span><br><span class="line"><span class="comment"># --output-dir=out ä¸ºæ‰“åŒ…å®Œæˆåè¾“å‡ºçš„exeåœ°å€</span></span><br><span class="line"><span class="comment"># --show-progress æ˜¾ç¤ºæ‰“åŒ…è¿›åº¦</span></span><br><span class="line"><span class="comment"># ./run/run_py.py ç¨‹åºå…¥å£</span></span><br><span class="line"><span class="comment"># --standalone è·¨å¹³å°å’Œä¸åŒè®¡ç®—æœºè¿è¡Œexeå¿…é€‰option</span></span><br><span class="line"><span class="comment"># --mingw64  ä½¿ç”¨mingw64 æ‰“åŒ…</span></span><br><span class="line">python -m nuitka --mingw64 --standalone --follow-import-to=utils,api,<span class="built_in">log</span>,run --output-dir=out --show-progress ./run/run_py.py</span><br></pre></td></tr></table></figure><h2 id="å¸¸è§command-option-è§£æ">å¸¸è§command option è§£æ</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">â€“mingw64 <span class="comment">#é»˜è®¤ä¸ºå·²ç»å®‰è£…çš„vs2017å»ç¼–è¯‘ï¼Œå¦åˆ™å°±æŒ‰æŒ‡å®šçš„æ¯”å¦‚mingw(å®˜æ–¹å»ºè®®)</span></span><br><span class="line">â€“standalone <span class="comment">#ç‹¬ç«‹ç¯å¢ƒï¼Œè¿™æ˜¯å¿…é¡»çš„(å¦åˆ™æ‹·ç»™åˆ«äººæ— æ³•ä½¿ç”¨)</span></span><br><span class="line">â€“windows-disable-console <span class="comment">#æ²¡æœ‰CMDæ§åˆ¶çª—å£</span></span><br><span class="line">â€“output-dir=out <span class="comment">#ç”Ÿæˆexeåˆ°outæ–‡ä»¶å¤¹ä¸‹é¢å»</span></span><br><span class="line">â€“show-progress <span class="comment">#æ˜¾ç¤ºç¼–è¯‘çš„è¿›åº¦ï¼Œå¾ˆç›´è§‚</span></span><br><span class="line">â€“show-memory <span class="comment">#æ˜¾ç¤ºå†…å­˜çš„å ç”¨</span></span><br><span class="line">â€“enable-plugin=pyside6 <span class="comment">#æ‰“åŒ…pyside6æ¨¡å—çš„åˆšéœ€</span></span><br><span class="line">â€“plugin-enable=tk-inter <span class="comment">#æ‰“åŒ…tkinteræ¨¡å—çš„åˆšéœ€</span></span><br><span class="line">â€“plugin-enable=numpy <span class="comment">#æ‰“åŒ…numpy,pandas,matplotlibæ¨¡å—çš„åˆšéœ€</span></span><br><span class="line">â€“plugin-enable=torch <span class="comment">#æ‰“åŒ…pytorchçš„åˆšéœ€</span></span><br><span class="line">â€“plugin-enable=tensorflow <span class="comment">#æ‰“åŒ…tensorflowçš„åˆšéœ€</span></span><br><span class="line">â€“windows-icon-from-ico=ä½ çš„.ico <span class="comment">#è½¯ä»¶çš„å›¾æ ‡</span></span><br><span class="line">â€“windows-company-name=Windowsä¸‹è½¯ä»¶å…¬å¸ä¿¡æ¯</span><br><span class="line">â€“windows-product-name=Windowsä¸‹è½¯ä»¶åç§°</span><br><span class="line">â€“windows-file-version=Windowsä¸‹è½¯ä»¶çš„ä¿¡æ¯</span><br><span class="line">â€“windows-product-version=Windowsä¸‹è½¯ä»¶çš„äº§å“ä¿¡æ¯</span><br><span class="line">â€“windows-file-description=Windowsä¸‹è½¯ä»¶çš„ä½œç”¨æè¿°</span><br><span class="line">â€“windows-uac-admin=Windowsä¸‹ç”¨æˆ·å¯ä»¥ä½¿ç”¨ç®¡ç†å‘˜æƒé™æ¥å®‰è£…</span><br><span class="line">â€“linux-onefile-icon=Linuxä¸‹çš„å›¾æ ‡ä½ç½®</span><br><span class="line">â€“onefile <span class="comment">#åƒpyinstalleræ‰“åŒ…æˆå•ä¸ªexeæ–‡ä»¶</span></span><br><span class="line">â€“include-package=å¤åˆ¶æ¯”å¦‚numpy,PyQt5 <span class="comment">#è¿™äº›å¸¦æ–‡ä»¶å¤¹çš„å«åŒ…æˆ–è€…è½®å­</span></span><br><span class="line">â€“include-module=å¤åˆ¶æ¯”å¦‚when.py <span class="comment">#è¿™äº›ä»¥.pyç»“å°¾çš„å«æ¨¡å—</span></span><br><span class="line">â€“-include-package-data=åŒ…å«ç»™å®šè½¯ä»¶åŒ…åç§°ä¸­çš„æ•°æ®æ–‡ä»¶ï¼Œç­‰å·åè½¯ä»¶åŒ…åç§°ã€‚ <span class="comment">#æœ‰çš„æ—¶å€™Nuitkaå¹¶ä¸èƒ½æ­£ç¡®åˆ†æå‡ºä¸€äº›Pythonè½¯ä»¶åŒ…æ‰€éœ€è¦ä½¿ç”¨çš„æ•°æ®æ–‡ä»¶ï¼Œåœ¨è¿è¡Œç¨‹åºæ—¶æç¤ºFileNotFoundErrorç­‰é”™è¯¯ï¼Œæ­¤æ—¶å°±éœ€è¦ä½¿ç”¨è¯¥é€‰é¡¹ã€‚å¦‚ï¼š</span></span><br><span class="line">â€“include-package-data=ultralytics</span><br><span class="line">â€“-include-data-files= æŒ‰æ–‡ä»¶ååŒ…å«æ•°æ®æ–‡ä»¶ï¼Œ <span class="comment">#ç­‰å·åçš„æ ¼å¼ä¸º&lt;SRC=DEST&gt;ã€‚SRCæŒ‡çš„æ˜¯æ–‡ä»¶å¤¹çš„è·¯å¾„ï¼ŒDESTæŒ‡çš„æ˜¯æ–‡ä»¶å¤¹ç›¸å¯¹äºæ‰“åŒ…ç»“æœçš„è·¯å¾„ï¼Œå…¶ä¸­DESTåªèƒ½ä½¿ç”¨ç›¸å¯¹è·¯å¾„ã€‚å¦‚ï¼šâ€“include-data-files=/Users/admin/Downloads/yolov5n.pt=./yolov5n.pt</span></span><br><span class="line">-â€“include-data-dir= åŒ…å«æ–‡ä»¶å¤¹ä¸­çš„æ•°æ®æ–‡ä»¶ï¼Œ <span class="comment">#ç­‰å·åçš„æ ¼å¼ä¸º&lt;SRC=DEST&gt;ã€‚ä½¿ç”¨æ–¹æ³•ä¸â€“include-data-files=ç›¸åŒã€‚</span></span><br><span class="line">â€“follow-import-to=MODULE/PACKAGE <span class="comment">#å¦‚æœä½¿ç”¨è¯¥æ¨¡å—ï¼Œè¯·éµå¾ªè¯¥æ¨¡å—ï¼›å¦‚æœæ˜¯ä¸€ä¸ªåŒ…ï¼Œè¯·éµå¾ªæ•´ä¸ªåŒ…ã€‚å¯ä»¥å¤šæ¬¡ç»™å®šã€‚é»˜è®¤ä¸ºç©ºã€‚</span></span><br><span class="line"><span class="comment"># æç¤ºï¼šé¦–æ¬¡æ‰“åŒ…å»ºè®®å»æ‰â€“windows-disable-consoleï¼Œä»¥ä¿ç•™æ§åˆ¶å°ä¾¿äºæ’æŸ¥é—®é¢˜ã€‚</span></span><br><span class="line">--enable-plugin<span class="comment">#æŒ‡å®šéœ€è¦åŠ è½½çš„æ’ä»¶ï¼Œæ¯”å¦‚è¯´tk-interã€pyqt5ç­‰</span></span><br><span class="line">--plugin-list<span class="comment">#æŸ¥çœ‹æ”¯æŒçš„æ’ä»¶</span></span><br><span class="line">--remove-output<span class="comment">#æ‰“åŒ…ç»“æŸä¹‹åè‡ªåŠ¨æ¸…ç†buildæ–‡ä»¶å¤¹</span></span><br><span class="line">--windows-icon-from-ico<span class="comment">#æŒ‡å®šç¨‹åºå›¾æ ‡ï¼ˆé’ˆå¯¹Windowsç³»ç»Ÿï¼‰</span></span><br><span class="line">--msvc<span class="comment">#æŒ‡å®šä½¿ç”¨MSVCçš„ç‰ˆæœ¬ï¼Œä¸æŒ‡å®šåˆ™ä½¿ç”¨ç³»ç»Ÿé»˜è®¤ç‰ˆæœ¬</span></span><br><span class="line">--company-name<span class="comment">#å…¬å¸å</span></span><br><span class="line">--product-name<span class="comment">#äº§å“å</span></span><br><span class="line">--file-version<span class="comment">#æ–‡ä»¶ç‰ˆæœ¬ï¼Œæœ€å¤š4ä¸ªæ•°å­—åºåˆ—ï¼Œä¾‹å¦‚1.0ã€1.0.0.0</span></span><br><span class="line">--product-version<span class="comment">#äº§å“ç‰ˆæœ¬ï¼Œè§„åˆ™ä¸â€“file-versionç›¸åŒ</span></span><br><span class="line">--file-description<span class="comment">#æ–‡ä»¶æè¿°</span></span><br></pre></td></tr></table></figure><h3 id="mingw64ä¸‹è½½ç¼“æ…¢">mingw64ä¸‹è½½ç¼“æ…¢</h3><ul><li>åœ¨ä»¥ä¸‹ç›®å½•æ”¾ç½®æ‰‹åŠ¨ä¸‹è½½çš„mingwå®‰è£…åŒ…</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.mingw-w64.org/downloads/</span><br></pre></td></tr></table></figure><blockquote><p>æ–‡ä»¶åå¦‚ä¸‹</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">winlibs-x86_64-posix-seh-gcc-13.2.0-llvm-16.0.6-mingw-w64msvcrt-11.0.1-r1.zip</span><br></pre></td></tr></table></figure><ul><li>éœ€è¦æ‰‹åŠ¨ç§»åŠ¨è‡³ä»¥ä¸‹ç›®å½•(æ— æ³•è‡ªå®šä¹‰ç›®å½•ï¼Œåªèƒ½ä½¿ç”¨é»˜è®¤è·¯å¾„)</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator\AppData\Local\Nuitka\Nuitka\Cache\downloads</span><br></pre></td></tr></table></figure><blockquote><p>æ”¾ç½®å®Œæˆåï¼Œé‡æ–°è¿è¡Œä¸Šè¿°å‘½ä»¤å³å¯æ‰“åŒ…æˆåŠŸï¼<br>å½“æ§åˆ¶å°è¯¢é—®æ˜¯å¦å®‰è£…gccæ—¶ï¼Œ è¾“å…¥yesè¿›è¡Œå®‰è£…</p></blockquote><h3 id="æ‰“åŒ…å®Œæˆåï¼Œæ•ˆæœå¦‚ä¸‹ï¼š">æ‰“åŒ…å®Œæˆåï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</h3><ul><li>å¦‚é¢˜<br><img src="/2024/04/09/nuitka-publish-python/zip_file.png" class="lazyload placeholder" data-srcset="/2024/04/09/nuitka-publish-python/zip_file.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></li></ul><h2 id="pyinstaller-ä¸-nukiaæ‰“åŒ…ç»“æœå¯¹æ¯”">pyinstaller ä¸ nukiaæ‰“åŒ…ç»“æœå¯¹æ¯”</h2><h3 id="å¤§å°å¯¹æ¯”">å¤§å°å¯¹æ¯”</h3><ul><li>å¦‚å›¾<br><img src="/2024/04/09/nuitka-publish-python/size_compare.png" class="lazyload placeholder" data-srcset="/2024/04/09/nuitka-publish-python/size_compare.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></li></ul><h3 id="å¯åŠ¨é€Ÿåº¦å¯¹æ¯”">å¯åŠ¨é€Ÿåº¦å¯¹æ¯”</h3><ul><li>nuitkiaæ¯”pyinstalleræ‰“åŒ…exeå¯åŠ¨åŒä¸€ç¨‹åºå¿«66%</li></ul><h3 id="ç‰¹æ®Šåº“å¼•å…¥">ç‰¹æ®Šåº“å¼•å…¥</h3><ul><li>ä¸¾ä¾‹ï¼špyqt5</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯ç”¨pyqt5æ’ä»¶</span></span><br><span class="line">--plugin-enable=pyqt5</span><br><span class="line"><span class="comment"># ç¦ç”¨æ§åˆ¶å°çª—å£</span></span><br><span class="line">--windows-disable-console</span><br><span class="line"><span class="comment"># å¯ç”¨å›¾æ ‡</span></span><br><span class="line">--windows-icon-from-ico=favicon.ico </span><br></pre></td></tr></table></figure><ul><li>ä¾‹å¦‚æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nuitka --mingw64 --standalone --show-progress --show-memory --output-dir=out   --plugin-enable=pyqt5 --windows-disable-console  --windows-icon-from-ico=favicon.ico xxx.py</span><br></pre></td></tr></table></figure><h2 id="See">See</h2><ul><li>[1]. <a href="https://daobook.github.io/nuitka-doc/zh_CN/developer-manual.html">https://daobook.github.io/nuitka-doc/zh_CN/developer-manual.html</a></li><li>[2]. <a href="https://nuitka.net/">https://nuitka.net/</a></li><li>[3]. <a href="https://blog.csdn.net/a1397852386/article/details/134344107">https://blog.csdn.net/a1397852386/article/details/134344107</a></li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäºopencvä½¿ç”¨pythonå®ç°äººè„¸è¯†åˆ«ä¸è§†é¢‘ç”Ÿæˆ</title>
      <link href="/2024/03/25/opencv-image-video/"/>
      <url>/2024/03/25/opencv-image-video/</url>
      
        <content type="html"><![CDATA[<h1>åŸºäºopencvä½¿ç”¨pythonå®ç°äººè„¸è¯†åˆ«ä¸è§†é¢‘ç”Ÿæˆ</h1><h2 id="æ¦‚è¿°">æ¦‚è¿°</h2><blockquote><p>OpenCVæ˜¯ä¸€ä¸ªåŸºäºApache2.0è®¸å¯ï¼ˆå¼€æºï¼‰å‘è¡Œçš„è·¨å¹³å°è®¡ç®—æœºè§†è§‰å’Œæœºå™¨å­¦ä¹ è½¯ä»¶åº“ï¼Œå¯ä»¥è¿è¡Œåœ¨Linuxã€Windowsã€Androidå’ŒMac OSæ“ä½œç³»ç»Ÿä¸Šã€‚</p></blockquote><blockquote><p>OpenCVç”±ä¸€ç³»åˆ—Cå‡½æ•°å’Œå°‘é‡C++ç±»æ„æˆï¼ŒåŒæ—¶æä¾›äº†Pythonã€Rubyã€MATLABç­‰è¯­è¨€çš„æ¥å£ï¼Œå®ç°äº†å›¾åƒå¤„ç†å’Œè®¡ç®—æœºè§†è§‰æ–¹é¢çš„å¾ˆå¤šé€šç”¨ç®—æ³•ï¼Œä¸»è¦å€¾å‘äºå®æ—¶è§†è§‰åº”ç”¨ã€‚</p></blockquote><h2 id="åŸºç¡€ç”¨æ³•">åŸºç¡€ç”¨æ³•</h2><ul><li><strong>cv2.imread()</strong>ï¼šè¯»å…¥å›¾åƒã€‚ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå›¾åƒè·¯å¾„ï¼Œç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šè¯»å…¥å›¾åƒçš„é¢œè‰²ï¼Œä¾‹å¦‚cv2.IMREAD_COLORè¡¨ç¤ºè¯»å…¥å½©è‰²å›¾åƒï¼Œcv2.IMREAD_GRAYSCALEè¡¨ç¤ºè¯»å…¥ç°åº¦å›¾åƒã€‚</li><li><strong>cv2.imshow()</strong>ï¼šæ˜¾ç¤ºå›¾åƒã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯çª—å£çš„åå­—ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¦æ˜¾ç¤ºçš„å›¾åƒã€‚</li><li><strong>cv2.VideoCapture()</strong>ï¼šè·å–æ‘„åƒå¤´è§†é¢‘æˆ–è€…è¯»å–è§†é¢‘æ–‡ä»¶ã€‚å‚æ•°å¯ä»¥æ˜¯è®¾å¤‡çš„ç´¢å¼•å·ï¼Œä¹Ÿå¯ä»¥æ˜¯è§†é¢‘æ–‡ä»¶çš„è·¯å¾„ã€‚</li><li><strong>cv2.imwrite()</strong>ï¼šä¿å­˜å›¾åƒã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ–‡ä»¶åï¼ŒåŒ…æ‹¬æ–‡ä»¶è·¯å¾„å’Œæ–‡ä»¶æ‰©å±•åï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¦ä¿å­˜çš„å›¾åƒã€‚</li><li><strong>cv2.cvtColor()</strong>ï¼šè½¬æ¢å›¾åƒé¢œè‰²ç©ºé—´ã€‚ä¾‹å¦‚å°†å½©è‰²å›¾åƒè½¬æ¢ä¸ºç°åº¦å›¾åƒã€‚</li></ul><h2 id="å®é™…æ¡ˆä¾‹">å®é™…æ¡ˆä¾‹</h2><h3 id="å›¾åƒè½¬è§†é¢‘">å›¾åƒè½¬è§†é¢‘</h3><h4 id="å›¾åƒå°ºå¯¸ç»Ÿä¸€åŒ–">å›¾åƒå°ºå¯¸ç»Ÿä¸€åŒ–</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">image_fill_black</span>(<span class="params">target_dir, image_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    å¾ªç¯å¤„ç†è¾“å…¥å›¾åƒï¼šå¦‚æœè¾“å…¥å°ºå¯¸å¤§äºè¾“å‡ºå°ºå¯¸åˆ™ï¼šç¼©å°ï¼›å¦‚æœè¾“å…¥å°ºå¯¸å°äºè¾“å‡ºå°ºå¯¸ï¼Œåˆ™ç”¨é»‘è¾¹å¡«å……ã€‚å°ºå¯¸ç›¸ç­‰ è¾“å‡ºå›¾åƒ</span></span><br><span class="line"><span class="string">    :param target_dir:è¾“å‡ºå›¾åƒè·¯å¾„</span></span><br><span class="line"><span class="string">    :param image_path:è¾“å…¥å›¾åƒè·¯å¾„</span></span><br><span class="line"><span class="string">    :return:æ˜¯å¦è½¬æ¢æˆåŠŸ</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># Step 1ï¼š import opencv lib</span></span><br><span class="line">    <span class="keyword">import</span> cv2</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># Step 2: Define the target size</span></span><br><span class="line">        target_size = (output_video_width, output_video_height)</span><br><span class="line">        <span class="comment"># è¯»å–å›¾ç‰‡</span></span><br><span class="line">        img = cv2.imread(image_path)</span><br><span class="line">        <span class="comment"># æ£€æŸ¥å›¾ç‰‡å°ºå¯¸</span></span><br><span class="line">        height, width = img.shape[:<span class="number">2</span>]</span><br><span class="line">        border_width = <span class="number">0</span></span><br><span class="line">        border_height = <span class="number">0</span></span><br><span class="line">        grap_width = <span class="number">0</span></span><br><span class="line">        grap_height = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">if</span> width &lt; target_size[<span class="number">0</span>] <span class="keyword">and</span> height &lt; target_size[<span class="number">1</span>]:</span><br><span class="line">                <span class="keyword">if</span> width &lt; target_size[<span class="number">0</span>]:</span><br><span class="line">                    border_width = <span class="built_in">abs</span>(target_size[<span class="number">0</span>] - width) // <span class="number">2</span></span><br><span class="line">                    grap_width = output_video_width - (border_width * <span class="number">2</span>) - width</span><br><span class="line">                <span class="keyword">elif</span> width == target_size[<span class="number">0</span>]:</span><br><span class="line">                    border_width = <span class="number">0</span></span><br><span class="line">                    grap_width = <span class="number">0</span></span><br><span class="line">                <span class="keyword">if</span> height &lt; target_size[<span class="number">1</span>]:</span><br><span class="line">                    border_height = <span class="built_in">abs</span>(target_size[<span class="number">1</span>] - height) // <span class="number">2</span></span><br><span class="line">                    grap_height = output_video_height - (border_height * <span class="number">2</span>) - height</span><br><span class="line">                <span class="keyword">elif</span> height == target_size[<span class="number">1</span>]:</span><br><span class="line">                    border_height = <span class="number">0</span></span><br><span class="line">                    grap_height = <span class="number">0</span></span><br><span class="line">                border = border_width, border_height</span><br><span class="line">                img = cv2.copyMakeBorder(img, border[<span class="number">1</span>], border[<span class="number">1</span>] + grap_height, border[<span class="number">0</span>], border[<span class="number">0</span>] + grap_width,</span><br><span class="line">                                         cv2.BORDER_CONSTANT, value=[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>])</span><br><span class="line">                out_height, out_width = img.shape[:<span class="number">2</span>]</span><br><span class="line">                <span class="keyword">if</span> out_height == output_video_height <span class="keyword">and</span> out_width == output_video_width:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">elif</span> width &gt; target_size[<span class="number">0</span>] <span class="keyword">or</span> height &gt; target_size[<span class="number">1</span>]:</span><br><span class="line">                img = cv2.resize(img, target_size, interpolation=cv2.INTER_LINEAR)</span><br><span class="line">                out_height, out_width = img.shape[:<span class="number">2</span>]</span><br><span class="line">                <span class="keyword">if</span> out_height == output_video_height <span class="keyword">and</span> out_width == output_video_width:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                logger.info(<span class="string">f&quot;Image size matches the target size: <span class="subst">&#123;image_path&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        file_path, file_name = os.path.split(image_path)</span><br><span class="line">        cv2.imwrite(os.path.join(target_dir, <span class="string">&quot;result_&quot;</span> + file_name), img)</span><br><span class="line">        cv2.waitKey(<span class="number">0</span>)</span><br><span class="line">        cv2.destroyAllWindows()</span><br><span class="line">    <span class="keyword">except</span> AttributeError <span class="keyword">as</span> uie:</span><br><span class="line">        logger.error(<span class="string">&quot;error, AttributeError: &#x27;NoneType&#x27; object has no attribute &#x27;shape&#x27;! detail: &quot;</span> + <span class="built_in">str</span>(uie) +</span><br><span class="line">                     <span class="string">&quot;, &quot;</span><span class="string">&quot;file_name or path: &quot;</span> + <span class="built_in">str</span>(image_path))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">&quot;error, unknown error! detail: &quot;</span> + <span class="built_in">str</span>(e) + <span class="string">&quot;, file_name or path: &quot;</span> + <span class="built_in">str</span>(image_path))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure><blockquote><p>ä¸Šè¿°ä»£ç è®²ä¸åŒå°ºå¯¸å›¾åƒè½¬æ¢ä¸ºç»Ÿä¸€ç›®æ ‡å°ºå¯¸ï¼Œè¿‡å°ç”¨é»‘è¾¹å¡«å……ï¼Œè¿‡å¤§è¿›è¡Œç¼©æ”¾ã€‚</p></blockquote><h4 id="å›¾åƒè½¬ä¸ºè§†é¢‘">å›¾åƒè½¬ä¸ºè§†é¢‘</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_video_from_images</span>(<span class="params">images_input_path, video_out_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    generate video from images list</span></span><br><span class="line"><span class="string">    :param images_input_path:</span></span><br><span class="line"><span class="string">    :param video_out_path:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    image_paths = []</span><br><span class="line">    <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(images_input_path):</span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;square&quot;</span> <span class="keyword">in</span> file <span class="keyword">or</span> <span class="string">&quot;custom&quot;</span> <span class="keyword">in</span> file <span class="keyword">or</span> <span class="string">&quot;error_images&quot;</span> <span class="keyword">in</span> root <span class="keyword">or</span> <span class="string">&quot;small_images&quot;</span> <span class="keyword">in</span> root \</span><br><span class="line">                    <span class="keyword">or</span> <span class="string">&quot;gif_unzip&quot;</span> <span class="keyword">in</span> root:</span><br><span class="line">                logger.warning(<span class="string">f&quot;skip file, because images error or small, name: <span class="subst">&#123;file&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">elif</span> file.endswith(<span class="string">&#x27;.jpg&#x27;</span>) <span class="keyword">or</span> file.endswith(<span class="string">&#x27;.png&#x27;</span>):  <span class="comment"># ä»…å¤„ç†jpgå’Œpngå›¾ç‰‡æ–‡ä»¶</span></span><br><span class="line">                image_paths.append(os.path.join(root, file))</span><br><span class="line">    logger.debug(</span><br><span class="line">        <span class="string">&quot;scan image coule use image length: &quot;</span> + <span class="built_in">str</span>(<span class="built_in">len</span>(image_paths)) + <span class="string">&quot;, scan dir: &quot;</span> + <span class="built_in">str</span>(constants.data_path))</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(image_paths) &lt;= <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    width = <span class="number">0</span></span><br><span class="line">    height = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> image_path <span class="keyword">in</span> image_paths:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            image = cv2.imread(image_path)</span><br><span class="line">            <span class="keyword">if</span> width == <span class="number">0</span>:</span><br><span class="line">                width = image.shape[<span class="number">1</span>]</span><br><span class="line">            height = image.shape[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">&quot;error! detail: &quot;</span> + <span class="string">&quot;file name or path: &quot;</span> + image_path + <span class="string">&quot;, error detail: &quot;</span> + <span class="built_in">str</span>(e))</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ£€æŸ¥è¾“å‡ºè·¯å¾„æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºç›®å½•</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(video_out_path):</span><br><span class="line">        os.makedirs(video_out_path)</span><br><span class="line"></span><br><span class="line">    fourcc = cv2.VideoWriter.fourcc(*<span class="string">&#x27;MJPG&#x27;</span>)</span><br><span class="line">    <span class="comment"># åˆ›å»ºVideoWriterå¯¹è±¡</span></span><br><span class="line">    video_name = video_out_path + id_generate_time() + <span class="string">&quot;test.mp4&quot;</span></span><br><span class="line">    video = cv2.VideoWriter(video_name, fourcc, <span class="built_in">int</span>(output_video_fps), (width, height))  <span class="comment"># è®¾ç½®è§†é¢‘å¸§ç‡ã€è¾“å‡ºè§†é¢‘å¤§å°</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> video.isOpened():</span><br><span class="line">        logger.error(<span class="string">&quot;not open video watch!&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        export_index = <span class="number">0</span></span><br><span class="line">        image_size_len = <span class="built_in">len</span>(image_paths)</span><br><span class="line">        <span class="keyword">for</span> image_path <span class="keyword">in</span> os.listdir(images_input_path):</span><br><span class="line">            export_index += <span class="number">1</span></span><br><span class="line">            percent_cur = <span class="built_in">int</span>((export_index / image_size_len) * <span class="number">100</span>)</span><br><span class="line">            image = cv2.imread(os.path.join(images_input_path, image_path))</span><br><span class="line">            <span class="keyword">if</span> image <span class="keyword">is</span> <span class="literal">None</span>:  <span class="comment"># å¢åŠ å¯¹å›¾åƒæ˜¯å¦æ­£ç¡®è¯»å–çš„æ£€æŸ¥</span></span><br><span class="line">                logger.error(<span class="string">&quot;Image not loaded: &quot;</span> + image_path)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            resized_image = cv2.resize(image, (width, height))  <span class="comment"># å°†å›¾åƒçš„å®½åº¦å’Œé«˜åº¦è®¾ç½®ä¸ºé€‚åˆMPEG-4çš„å°ºå¯¸</span></span><br><span class="line">            <span class="keyword">if</span> image <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                video.write(resized_image)</span><br><span class="line">            <span class="keyword">if</span> percent_cur % <span class="number">100</span> == <span class="number">0</span>:</span><br><span class="line">                logger.info(<span class="string">f&quot;export process to export_index / image_size_len: <span class="subst">&#123;export_index&#125;</span> / <span class="subst">&#123;image_size_len&#125;</span> * &quot;</span></span><br><span class="line">                            <span class="string">f&quot;100%100: <span class="subst">&#123;percent_cur&#125;</span>%&quot;</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        video.release()</span><br><span class="line">    <span class="keyword">return</span> video_name</span><br></pre></td></tr></table></figure><blockquote><p>ä¸Šè¿°ä»£ç ä»listä¸­è¯»å–å›¾åƒï¼Œä½¿ç”¨<code>width = image.shape[1]</code>è·å–å›¾åƒå®½åº¦æˆ–é«˜åº¦ï¼›ä½¿ç”¨ <code> fourcc = cv2.VideoWriter.fourcc(*'MJPG')     # åˆ›å»ºVideoWriterå¯¹è±¡     video_name = video_out_path + id_generate_time() + &quot;test.mp4&quot;     video = cv2.VideoWriter(video_name, fourcc, int(output_video_fps), (width, height))</code>åˆ›å»ºvideowriterå¯¹è±¡,å…¶ä¸­output_video_fpsè§„å®šäº†è§†é¢‘è¾“å‡ºå¸§ç‡ï¼Œ(width, height)è§„å®šäº†è§†é¢‘è¾“å‡ºå®½é«˜åº¦ï¼›åè¾¹ä½¿ç”¨<code> image = cv2.imread(os.path.join(images_input_path, image_path))</code>è¯»å–ä¼ å…¥å›¾ç‰‡å¯¹è±¡ï¼›ä½¿ç”¨<code>resized_image = cv2.resize(image, (width, height))</code>å†æ¬¡è°ƒæ•´å›¾ç‰‡å¤§å°è‡³åˆé€‚å°ºå¯¸ï¼›æœ€åä½¿ç”¨<code>video.write(resized_image)</code>å†™å…¥å›¾åƒåˆ°è§†é¢‘ä¸­ã€‚å†™å…¥å®Œæˆåï¼Œä½¿ç”¨<code>video.release()</code>é‡Šæ”¾å¯¹è±¡ã€‚</p></blockquote><h3 id="äººè„¸ç‰¹å¾æ£€æµ‹">äººè„¸ç‰¹å¾æ£€æµ‹</h3><h4 id="åˆ†ç±»å™¨ä¸‹è½½ä¸ä½¿ç”¨">åˆ†ç±»å™¨ä¸‹è½½ä¸ä½¿ç”¨</h4><ul><li>ä¸‹è½½åœ°å€</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/opencv/opencv/tree/master/data/haarcascadesã€‚</span><br></pre></td></tr></table></figure><ul><li>è¯»å–ä¸ä½¿ç”¨</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_data_file</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    è·å–æ•°æ®æ–‡ä»¶çš„è·¯å¾„ï¼Œæ— è®ºæ˜¯ç›´æ¥è¿è¡Œè¿˜æ˜¯é€šè¿‡ PyInstaller æ‰“åŒ…</span></span><br><span class="line"><span class="string">    :param filename</span></span><br><span class="line"><span class="string">    :return</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">getattr</span>(sys, <span class="string">&#x27;frozen&#x27;</span>, <span class="literal">False</span>):</span><br><span class="line">        <span class="comment"># å¦‚æœç¨‹åºæ˜¯â€œå†·å†»çš„â€ï¼Œå³æ‰“åŒ…åçš„ exe</span></span><br><span class="line">        basedir = sys._MEIPASS</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># å¦‚æœç¨‹åºæ˜¯ç›´æ¥è¿è¡Œçš„ï¼Œå³æ²¡æœ‰æ‰“åŒ…</span></span><br><span class="line">        basedir = os.path.dirname(__file__)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> os.path.join(basedir, filename)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    face_xml_path = get_data_file(<span class="string">&quot;xml_data/haarcascade_frontalface_default.xml&quot;</span>)</span><br><span class="line">    eye_xml_path = get_data_file(<span class="string">&#x27;xml_data/haarcascade_eye.xml&#x27;</span>)</span><br><span class="line">    <span class="comment"># åŠ è½½åˆ†ç±»å™¨</span></span><br><span class="line">    face_cascade = cv2.CascadeClassifier(face_xml_path)</span><br><span class="line">    eye_cascade = cv2.CascadeClassifier(eye_xml_path)</span><br></pre></td></tr></table></figure><h4 id="å®é™…æ¡ˆä¾‹-2">å®é™…æ¡ˆä¾‹</h4><ul><li>å›¾åƒè¯»å–ä¸äººè„¸ç‰¹å¾åˆ†å‰²</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">face_detect</span>(<span class="params">path, image_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ä½¿ç”¨OpenCVè¿›è¡Œäººè„¸å’Œçœ¼ç›æ£€æµ‹ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param path:</span></span><br><span class="line"><span class="string">    :param image_path: å›¾åƒæ–‡ä»¶çš„è·¯å¾„ã€‚</span></span><br><span class="line"><span class="string">    :return: None</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    file_path, file_name = os.path.split(image_path)</span><br><span class="line">    folder_name = find_img_result(image_path)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> folder_name <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        folder_name = <span class="string">&#x27;unknown_name&#x27;</span></span><br><span class="line">        logger.warning(<span class="string">&#x27;folder_name is None, default use unknown_name.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    base_path = os.path.join(path, <span class="string">&quot;face_detect_result&quot;</span>)</span><br><span class="line">    base_path = os.path.join(base_path, folder_name)</span><br><span class="line">    img_file_path = os.path.join(base_path, <span class="string">&quot;split_face&quot;</span>)</span><br><span class="line">    img_file_path_line = os.path.join(base_path, <span class="string">&quot;red_line&quot;</span>)</span><br><span class="line">    img_file_name = os.path.join(img_file_path, file_name)</span><br><span class="line">    img_file_name_line = os.path.join(img_file_path_line, file_name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(img_file_path):</span><br><span class="line">        os.makedirs(img_file_path)</span><br><span class="line">        logger.warning(<span class="string">&quot;face detect split_face dir not exists, create it.&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(img_file_path_line):</span><br><span class="line">        os.makedirs(img_file_path_line)</span><br><span class="line">        logger.warning(<span class="string">f&quot;face detect red_line dir not exists, create it: <span class="subst">&#123;img_file_path&#125;</span>.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åªç”Ÿæˆæ²¡æœ‰çš„</span></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(img_file_name) <span class="keyword">or</span> os.path.exists(img_file_name_line):</span><br><span class="line">        logger.warning(<span class="string">f&quot;<span class="subst">&#123;img_file_name&#125;</span> already exists, will skip!&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        face_xml_path = get_data_file(<span class="string">&quot;xml_data/haarcascade_frontalface_default.xml&quot;</span>)</span><br><span class="line">        eye_xml_path = get_data_file(<span class="string">&#x27;xml_data/haarcascade_eye.xml&#x27;</span>)</span><br><span class="line">        <span class="comment"># åŠ è½½åˆ†ç±»å™¨</span></span><br><span class="line">        face_cascade = cv2.CascadeClassifier(face_xml_path)</span><br><span class="line">        eye_cascade = cv2.CascadeClassifier(eye_xml_path)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¯»å–å›¾åƒ</span></span><br><span class="line">        img = cv2.imread(image_path)</span><br><span class="line">        <span class="keyword">if</span> img <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            logger.error(<span class="string">f&quot;Error: Unable to load image at <span class="subst">&#123;image_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># è½¬æ¢ä¸ºç°åº¦å›¾åƒ</span></span><br><span class="line">        gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ£€æµ‹äººè„¸</span></span><br><span class="line">        faces = face_cascade.detectMultiScale(gray, <span class="number">1.1</span>, <span class="number">5</span>)</span><br><span class="line">        <span class="comment"># eye_cascade.detectMultiScale(gray, 1.1, 5)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(faces) == <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># logger.warning(f&quot;No faces detected:&#123;image_path&#125;&quot;)</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            save_face(img_file_name, img_file_name_line, img, faces, gray, eye_cascade)</span><br><span class="line">        <span class="comment"># æ˜¾ç¤ºç»“æœ</span></span><br><span class="line">        cv2.waitKey(<span class="number">0</span>)</span><br><span class="line">        cv2.destroyAllWindows()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;An error occurred: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>è¯†åˆ«ç»“æœä¿å­˜</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_face</span>(<span class="params">img_file_name, img_file_name_line, img, faces, gray, eye_cascade</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    :param eye_cascade:</span></span><br><span class="line"><span class="string">    :param gray:</span></span><br><span class="line"><span class="string">    :param img_file_name_line:</span></span><br><span class="line"><span class="string">    :param img_file_name:</span></span><br><span class="line"><span class="string">    :param img:</span></span><br><span class="line"><span class="string">    :param faces:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    target_size = (<span class="number">200</span>, <span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Calculate the dimensions of the faces_image based on the number of faces and target size</span></span><br><span class="line">    num_faces = <span class="built_in">len</span>(faces)</span><br><span class="line">    faces_image_height = num_faces * target_size[<span class="number">0</span>]</span><br><span class="line">    faces_image_width = target_size[<span class="number">1</span>]  <span class="comment"># Assuming we want to fit only one face horizontally for simplicity</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># Create a blank image to hold the resized faces</span></span><br><span class="line">        faces_image = np.zeros((faces_image_height, faces_image_width, <span class="number">3</span>), dtype=np.uint8)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (x, y, w, h) <span class="keyword">in</span> faces:</span><br><span class="line">            cv2.rectangle(img, (x, y), (x + w, y + h), (<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="number">2</span>)</span><br><span class="line">            roi_gray = gray[y:y + h, x:x + w]</span><br><span class="line">            roi_color = img[y:y + h, x:x + w]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># åœ¨äººè„¸åŒºåŸŸå†…æ£€æµ‹çœ¼ç›</span></span><br><span class="line">            eyes = eye_cascade.detectMultiScale(roi_gray)</span><br><span class="line">            <span class="keyword">for</span> (ex, ey, ew, eh) <span class="keyword">in</span> eyes:</span><br><span class="line">                cv2.rectangle(roi_color, (ex, ey), (ex + ew, ey + eh), (<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>), <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># å°†ç»˜åˆ¶äº†çœ¼ç›çŸ©å½¢æ¡†çš„äººè„¸åŒºåŸŸæ”¾å›åŸå›¾çš„æ­£ç¡®ä½ç½®</span></span><br><span class="line">            img[y:y + h, x:x + w] = roi_color</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Iterate over the detected faces</span></span><br><span class="line">        <span class="keyword">for</span> i, (x, y, w, h) <span class="keyword">in</span> <span class="built_in">enumerate</span>(faces):</span><br><span class="line">            <span class="comment"># Resize the face to the target size</span></span><br><span class="line">            face_resized = cv2.resize(img[y:y + h, x:x + w], target_size)</span><br><span class="line"></span><br><span class="line">            row = i</span><br><span class="line">            col = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Place the resized face in the faces_image array</span></span><br><span class="line">            faces_image[row * target_size[<span class="number">0</span>]:(row + <span class="number">1</span>) * target_size[<span class="number">0</span>],</span><br><span class="line">            col * target_size[<span class="number">1</span>]:(col + <span class="number">1</span>) * target_size[<span class="number">1</span>]] = face_resized</span><br><span class="line"></span><br><span class="line">        cv2.waitKey(<span class="number">0</span>)</span><br><span class="line">        cv2.destroyAllWindows()</span><br><span class="line"></span><br><span class="line">        cv2.imwrite(img_file_name, faces_image)</span><br><span class="line">        cv2.imwrite(img_file_name_line, img)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;unknown error, detail: <span class="subst">&#123;e&#125;</span>, name: <span class="subst">&#123;img_file_name[-<span class="number">27</span>:]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    logger.success(<span class="string">f&quot;save success, name: <span class="subst">&#123;img_file_name[-<span class="number">27</span>:]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>ä¸Šè¿°ä»£ç ï¼Œåœ¨äººè„¸ä¸­æ£€æµ‹äº†çœ¼ç›ã€è„¸éƒ¨ç‰¹å¾ç‚¹ï¼Œå¹¶ä½¿ç”¨å¯¹åº”é¢œè‰²æ¡†æ¡†é€‰å‡ºæ¥ï¼Œæœ€ç»ˆä¿å­˜è‡³ç›®æ ‡è·¯å¾„ã€‚</p></blockquote><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> opencv </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python_proxy_server</title>
      <link href="/2024/03/22/python-proxy-server/"/>
      <url>/2024/03/22/python-proxy-server/</url>
      
        <content type="html"><![CDATA[<h1>ä½¿ç”¨pythonåˆ›å»ºä¸€ä¸ªé«˜æ•ˆã€å¯ç”¨çš„ä»£ç†æ± æœåŠ¡</h1><h2 id="ä»£ç†">ä»£ç†</h2><blockquote><p>å‘ç›®æ ‡ç½‘ç«™æˆ–æœåŠ¡å™¨éšè—IP,åˆ©ç”¨ä»£ç†æˆ‘ä»¬å¯ä»¥è§£å†³ç›®æ ‡ç½‘ç«™å° IP çš„é—®é¢˜</p></blockquote><ul><li>ç”±ä»£ç†æœåŠ¡å™¨è‡ªå·±å»è®¿é—®ä½ çš„ç›®æ ‡ç½‘ç«™ï¼Œå¹¶åŠ è½½å®ƒçš„å†…å®¹ï¼Œç„¶åå†æŠŠè¿™äº›åŠ è½½è¿‡çš„å†…å®¹ä¼ é€’åˆ°ä½ çš„çª—å£ä¸Šã€‚ç›®æ ‡ç½‘ç«™å°±æ— æ³•è·å–ä½ çš„IPåœ°å€ï¼Œå–è€Œä»£ä¹‹è·å–çš„æ˜¯ä»£ç†æœåŠ¡å™¨çš„IPåœ°å€ã€‚</li></ul><h2 id="è®¾è®¡æ€è·¯">è®¾è®¡æ€è·¯</h2><ul><li>ç³»ç»Ÿåˆ†ä¸ºå››å—ï¼Œè·å–æ¨¡å—ã€å­˜å‚¨æ¨¡å—ã€æ£€æŸ¥æ¨¡å—ã€æ¥å£æ¨¡å—</li><li>è·å–æ¨¡å—éœ€è¦å®šæ—¶å»å„å¤§ä»£ç†ç½‘ç«™æŠ“å–ä»£ç†ï¼Œä»£ç†å¯ä»¥æ˜¯å…è´¹å…¬å¼€ä»£ç†ä¹Ÿå¯ä»¥æ˜¯ä»˜è´¹ä»£ç†ï¼Œä»£ç†çš„å½¢å¼éƒ½æ˜¯ IP åŠ ç«¯å£ï¼Œå°½é‡ä»ä¸åŒæ¥æºè·å–ï¼Œå°½é‡æŠ“å–é«˜åŒ¿ä»£ç†ï¼ŒæŠ“å–å®Œä¹‹åå°†å¯ç”¨ä»£ç†ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚</li><li>å­˜å‚¨æ¨¡å—è´Ÿè´£å­˜å‚¨æŠ“å–ä¸‹æ¥çš„ä»£ç†ã€‚é¦–å…ˆæˆ‘ä»¬éœ€è¦ä¿è¯ä»£ç†ä¸é‡å¤ï¼Œå¦å¤–æˆ‘ä»¬è¿˜éœ€è¦æ ‡è¯†ä»£ç†çš„å¯ç”¨æƒ…å†µï¼Œè€Œä¸”éœ€è¦åŠ¨æ€å®æ—¶å¤„ç†æ¯ä¸ªä»£ç†ï¼Œæ‰€ä»¥è¯´ï¼Œä¸€ç§æ¯”è¾ƒé«˜æ•ˆå’Œæ–¹ä¾¿çš„å­˜å‚¨æ–¹å¼å°±æ˜¯ä½¿ç”¨ Redis çš„ Sorted Setï¼Œä¹Ÿå°±æ˜¯æœ‰åºé›†åˆã€‚</li><li>æ£€æµ‹æ¨¡å—éœ€è¦å®šæ—¶å°†æ•°æ®åº“ä¸­çš„ä»£ç†è¿›è¡Œæ£€æµ‹ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦è®¾ç½®ä¸€ä¸ªæ£€æµ‹é“¾æ¥ï¼Œæœ€å¥½æ˜¯çˆ¬å–å“ªä¸ªç½‘ç«™å°±æ£€æµ‹å“ªä¸ªç½‘ç«™ï¼Œè¿™æ ·æ›´åŠ æœ‰é’ˆå¯¹æ€§ï¼Œå¦‚æœè¦åšä¸€ä¸ªé€šç”¨å‹çš„ä»£ç†ï¼Œé‚£å¯ä»¥è®¾ç½®ç™¾åº¦ç­‰é“¾æ¥æ¥æ£€æµ‹ã€‚å¦å¤–æˆ‘ä»¬éœ€è¦æ ‡è¯†æ¯ä¸€ä¸ªä»£ç†çš„çŠ¶æ€ï¼Œå¦‚è®¾ç½®åˆ†æ•°æ ‡è¯†ï¼Œ100 åˆ†ä»£è¡¨å¯ç”¨ï¼Œåˆ†æ•°è¶Šå°‘ä»£è¡¨è¶Šä¸å¯ç”¨ï¼Œæ£€æµ‹ä¸€æ¬¡å¦‚æœå¯ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶ç«‹å³è®¾ç½®ä¸º 100 æ»¡åˆ†ï¼Œä¹Ÿå¯ä»¥åœ¨åŸåŸºç¡€ä¸ŠåŠ  1 åˆ†ï¼Œå½“ä¸å¯ç”¨ï¼Œå¯ä»¥å°†å…¶å‡ 1 åˆ†ï¼Œå½“å‡åˆ°ä¸€å®šé˜ˆå€¼åå°±ç›´æ¥ä»æ•°æ®åº“ç§»é™¤ã€‚é€šè¿‡è¿™æ ·çš„æ ‡è¯†åˆ†æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥åŒºåˆ†å‡ºä»£ç†çš„å¯ç”¨æƒ…å†µï¼Œé€‰ç”¨çš„æ—¶å€™ä¼šæ›´æœ‰é’ˆå¯¹æ€§ã€‚</li><li>æ¥å£æ¨¡å—éœ€è¦ç”¨ API æ¥æä¾›å¯¹å¤–æœåŠ¡çš„æ¥å£ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥ç›´æ¥è¿æ•°æ®åº“æ¥å–ï¼Œä½†æ˜¯è¿™æ ·å°±éœ€è¦çŸ¥é“æ•°æ®åº“çš„è¿æ¥ä¿¡æ¯ï¼Œä¸å¤ªå®‰å…¨ï¼Œè€Œä¸”éœ€è¦é…ç½®è¿æ¥ï¼Œæ‰€ä»¥ä¸€ä¸ªæ¯”è¾ƒå®‰å…¨å’Œæ–¹ä¾¿çš„æ–¹å¼å°±æ˜¯æä¾›ä¸€ä¸ª Web API æ¥å£ï¼Œé€šè¿‡è®¿é—®æ¥å£å³å¯æ‹¿åˆ°å¯ç”¨ä»£ç†ã€‚å¦å¤–ç”±äºå¯ç”¨ä»£ç†å¯èƒ½æœ‰å¤šä¸ªï¼Œæˆ‘ä»¬å¯ä»¥æä¾›éšæœºè¿”å›ä¸€ä¸ªå¯ç”¨ä»£ç†çš„æ¥å£ï¼Œè¿™æ ·ä¿è¯æ¯ä¸ªå¯ç”¨ä»£ç†éƒ½å¯ä»¥å–åˆ°ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚</li></ul><h2 id="å®ç°æ€è·¯">å®ç°æ€è·¯</h2><ul><li>åŸºäºä¸Šè¿°åˆ†æï¼š</li><li>å­˜å‚¨æ¨¡å—ä½¿ç”¨ Redis çš„æœ‰åºé›†åˆï¼Œç”¨ä»¥ä»£ç†çš„å»é‡å’ŒçŠ¶æ€æ ‡è¯†ï¼ŒåŒæ—¶å®ƒä¹Ÿæ˜¯ä¸­å¿ƒæ¨¡å—å’ŒåŸºç¡€æ¨¡å—ï¼Œå°†å…¶ä»–æ¨¡å—ä¸²è”èµ·æ¥ã€‚</li><li>è·å–æ¨¡å—å®šæ—¶ä»ä»£ç†ç½‘ç«™è·å–ä»£ç†ï¼Œå°†è·å–çš„ä»£ç†ä¼ é€’ç»™å­˜å‚¨æ¨¡å—ï¼Œä¿å­˜åˆ°æ•°æ®åº“ã€‚</li><li>æ£€æµ‹æ¨¡å—å®šæ—¶é€šè¿‡å­˜å‚¨æ¨¡å—è·å–æ‰€æœ‰ä»£ç†ï¼Œå¹¶å¯¹å…¶è¿›è¡Œæ£€æµ‹ï¼Œæ ¹æ®ä¸åŒçš„æ£€æµ‹ç»“æœå¯¹ä»£ç†è®¾ç½®ä¸åŒçš„æ ‡è¯†ã€‚</li><li>æ¥å£æ¨¡å—é€šè¿‡ Web API æä¾›æœåŠ¡æ¥å£ï¼Œå…¶å†…éƒ¨è¿˜æ˜¯è¿æ¥å­˜å‚¨æ¨¡å—ï¼Œè·å–å¯ç”¨çš„ä»£ç†</li></ul><h2 id="æ¨¡å—å®ç°">æ¨¡å—å®ç°</h2><h3 id="ä»£ç†å­˜å‚¨">ä»£ç†å­˜å‚¨</h3><ul><li><p>ä½¿ç”¨ Redis çš„æœ‰åºé›†åˆï¼Œé›†åˆçš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯ä¸é‡å¤çš„ï¼Œå¯¹äºä»£ç†ä»£ç†æ± æ¥è¯´ï¼Œé›†åˆçš„å…ƒç´ å°±å˜æˆäº†ä¸€ä¸ªä¸ªä»£ç†ï¼Œä¹Ÿå°±æ˜¯ IP åŠ ç«¯å£çš„å½¢å¼ï¼Œå¦‚ 60.207.237.111:8888ï¼Œè¿™æ ·çš„ä¸€ä¸ªä»£ç†å°±æ˜¯é›†åˆçš„ä¸€ä¸ªå…ƒç´ ã€‚å¦å¤–æœ‰åºé›†åˆçš„æ¯ä¸€ä¸ªå…ƒç´ è¿˜éƒ½æœ‰ä¸€ä¸ªåˆ†æ•°å­—æ®µï¼Œåˆ†æ•°æ˜¯å¯ä»¥é‡å¤çš„ï¼Œæ˜¯ä¸€ä¸ªæµ®ç‚¹æ•°ç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯æ•´æ•°ç±»å‹ã€‚è¯¥é›†åˆä¼šæ ¹æ®æ¯ä¸€ä¸ªå…ƒç´ çš„åˆ†æ•°å¯¹é›†åˆè¿›è¡Œé™åºæ’åºã€‚ å¯¹äºä»£ç†æ± æ¥è¯´ï¼Œè¿™ä¸ªåˆ†æ•°å¯ä»¥ä½œä¸ºæˆ‘ä»¬åˆ¤æ–­ä¸€ä¸ªä»£ç†å¯ç”¨ä¸å¯ç”¨çš„æ ‡å¿—ï¼Œæˆ‘ä»¬å°† 100 è®¾ä¸ºæœ€é«˜åˆ†ï¼Œä»£è¡¨å¯ç”¨ï¼Œ0 è®¾ä¸ºæœ€ä½åˆ†ï¼Œä»£è¡¨ä¸å¯ç”¨ã€‚ä»ä»£ç†æ± ä¸­è·å–ä»£ç†çš„æ—¶å€™ä¼šéšæœºè·å–åˆ†æ•°æœ€é«˜çš„ä»£ç†ï¼Œæ³¨æ„è¿™é‡Œæ˜¯éšæœºè·å–é«˜åˆ†ä»£ç†ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ¯ä¸ªå¯ç”¨ä»£ç†éƒ½ä¼šè¢«è°ƒç”¨åˆ°ã€‚ åˆ†æ•°æ˜¯æˆ‘ä»¬åˆ¤æ–­ä»£ç†ç¨³å®šæ€§çš„é‡è¦æ ‡å‡†ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬è®¾ç½®åˆ†æ•°è§„åˆ™å¦‚ä¸‹ï¼š</p></li><li><p>åˆ†æ•° 100 ä¸ºå¯ç”¨ï¼Œæ£€æµ‹å™¨ä¼šå®šæ—¶å¾ªç¯æ£€æµ‹æ¯ä¸ªä»£ç†å¯ç”¨æƒ…å†µï¼Œä¸€æ—¦æ£€æµ‹åˆ°æœ‰å¯ç”¨çš„ä»£ç†å°±ç«‹å³ç½®ä¸º 100ï¼Œæ£€æµ‹åˆ°ä¸å¯ç”¨å°±å°†åˆ†æ•°å‡ 1ï¼Œå‡è‡³ 0 åç§»é™¤ã€‚</p></li><li><p>æ–°è·å–çš„ä»£ç†æ·»åŠ æ—¶å°†åˆ†æ•°ç½®ä¸º 10ï¼Œå½“æµ‹è¯•å¯è¡Œç«‹å³ç½® 100ï¼Œä¸å¯è¡Œåˆ†æ•°å‡ 1ï¼Œå‡è‡³ 0 åç§»é™¤ã€‚</p></li></ul><h4 id="å®ç°ä»£ç ">å®ç°ä»£ç </h4><ul><li>å­˜å‚¨ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">MAX_SCORE = <span class="number">100</span></span><br><span class="line">MIN_SCORE = <span class="number">0</span></span><br><span class="line">INITIAL_SCORE = <span class="number">10</span></span><br><span class="line">REDIS_HOST = <span class="string">&#x27;localhost&#x27;</span></span><br><span class="line">REDIS_PORT = <span class="number">6379</span></span><br><span class="line">REDIS_PASSWORD = <span class="literal">None</span></span><br><span class="line">REDIS_KEY = <span class="string">&#x27;proxies&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> choice</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RedisClient</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, host=REDIS_HOST, port=REDIS_PORT, password=REDIS_PASSWORD</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        åˆå§‹åŒ–</span></span><br><span class="line"><span class="string">        :param host: Redis åœ°å€</span></span><br><span class="line"><span class="string">        :param port: Redis ç«¯å£</span></span><br><span class="line"><span class="string">        :param password: Rediså¯†ç </span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.db = redis.StrictRedis(host=host, port=port, password=password, decode_responses=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">self, proxy, score=INITIAL_SCORE</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        æ·»åŠ ä»£ç†ï¼Œè®¾ç½®åˆ†æ•°ä¸ºæœ€é«˜</span></span><br><span class="line"><span class="string">        :param proxy: ä»£ç†</span></span><br><span class="line"><span class="string">        :param score: åˆ†æ•°</span></span><br><span class="line"><span class="string">        :return: æ·»åŠ ç»“æœ</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.db.zscore(REDIS_KEY, proxy):</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.db.zadd(REDIS_KEY, score, proxy)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">random</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        éšæœºè·å–æœ‰æ•ˆä»£ç†ï¼Œé¦–å…ˆå°è¯•è·å–æœ€é«˜åˆ†æ•°ä»£ç†ï¼Œå¦‚æœä¸å­˜åœ¨ï¼ŒæŒ‰ç…§æ’åè·å–ï¼Œå¦åˆ™å¼‚å¸¸</span></span><br><span class="line"><span class="string">        :return: éšæœºä»£ç†</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        result = <span class="variable language_">self</span>.db.zrangebyscore(REDIS_KEY, MAX_SCORE, MAX_SCORE)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(result):</span><br><span class="line">            <span class="keyword">return</span> choice(result)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result = <span class="variable language_">self</span>.db.zrevrange(REDIS_KEY, <span class="number">0</span>, <span class="number">100</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(result):</span><br><span class="line">                <span class="keyword">return</span> choice(result)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> PoolEmptyError</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decrease</span>(<span class="params">self, proxy</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        ä»£ç†å€¼å‡ä¸€åˆ†ï¼Œå°äºæœ€å°å€¼åˆ™åˆ é™¤</span></span><br><span class="line"><span class="string">        :param proxy: ä»£ç†</span></span><br><span class="line"><span class="string">        :return: ä¿®æ”¹åçš„ä»£ç†åˆ†æ•°</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        score = <span class="variable language_">self</span>.db.zscore(REDIS_KEY, proxy)</span><br><span class="line">        <span class="keyword">if</span> score <span class="keyword">and</span> score &gt; MIN_SCORE:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;ä»£ç†&#x27;</span>, proxy, <span class="string">&#x27;å½“å‰åˆ†æ•°&#x27;</span>, score, <span class="string">&#x27;å‡1&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.db.zincrby(REDIS_KEY, proxy, -<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;ä»£ç†&#x27;</span>, proxy, <span class="string">&#x27;å½“å‰åˆ†æ•°&#x27;</span>, score, <span class="string">&#x27;ç§»é™¤&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.db.zrem(REDIS_KEY, proxy)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">exists</span>(<span class="params">self, proxy</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line"><span class="string">        :param proxy: ä»£ç†</span></span><br><span class="line"><span class="string">        :return: æ˜¯å¦å­˜åœ¨</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">not</span> <span class="variable language_">self</span>.db.zscore(REDIS_KEY, proxy) == <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">max</span>(<span class="params">self, proxy</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        å°†ä»£ç†è®¾ç½®ä¸ºMAX_SCORE</span></span><br><span class="line"><span class="string">        :param proxy: ä»£ç†</span></span><br><span class="line"><span class="string">        :return: è®¾ç½®ç»“æœ</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;ä»£ç†&#x27;</span>, proxy, <span class="string">&#x27;å¯ç”¨ï¼Œè®¾ç½®ä¸º&#x27;</span>, MAX_SCORE)</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.db.zadd(REDIS_KEY, MAX_SCORE, proxy)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">count</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        è·å–æ•°é‡</span></span><br><span class="line"><span class="string">        :return: æ•°é‡</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.db.zcard(REDIS_KEY)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">all</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        è·å–å…¨éƒ¨ä»£ç†</span></span><br><span class="line"><span class="string">        :return: å…¨éƒ¨ä»£ç†åˆ—è¡¨</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.db.zrangebyscore(REDIS_KEY, MIN_SCORE, MAX_SCORE)</span><br></pre></td></tr></table></figure><blockquote><p>ä¸Šè¿°ä»£ç ä¸­MAX_SCOREã€MIN_SCOREã€INITIAL_SCORE åˆ†åˆ«ä»£è¡¨æœ€å¤§åˆ†æ•°ã€æœ€å°åˆ†æ•°ã€åˆå§‹åˆ†æ•°ã€‚REDIS_HOSTã€REDIS_PORTã€REDIS_PASSWORD åˆ†åˆ«ä»£è¡¨äº† Redis çš„è¿æ¥ä¿¡æ¯ï¼Œå³åœ°å€ã€ç«¯å£ã€å¯†ç ã€‚REDIS_KEY æ˜¯æœ‰åºé›†åˆçš„é”®å</p></blockquote><h3 id="è·å–ä»£ç†">è·å–ä»£ç†</h3><ul><li>å®šä¹‰ä¸€ä¸ª Crawler æ¥ä»å„å¤§ç½‘ç«™æŠ“å–ä»£ç†,ä»£ç†ç½‘ç«™ç±»ä»£ç å¦‚ä¸‹ï¼š</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> .utils <span class="keyword">import</span> get_page</span><br><span class="line"><span class="keyword">from</span> pyquery <span class="keyword">import</span> PyQuery <span class="keyword">as</span> pq</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProxyMetaclass</span>(<span class="title class_ inherited__">type</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__new__</span>(<span class="params">cls, name, bases, attrs</span>):</span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        attrs[<span class="string">&#x27;__CrawlFunc__&#x27;</span>] = []</span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> attrs.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;crawl_&#x27;</span> <span class="keyword">in</span> k:</span><br><span class="line">                attrs[<span class="string">&#x27;__CrawlFunc__&#x27;</span>].append(k)</span><br><span class="line">                count += <span class="number">1</span></span><br><span class="line">        attrs[<span class="string">&#x27;__CrawlFuncCount__&#x27;</span>] = count</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">type</span>.__new__(cls, name, bases, attrs)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Crawler</span>(<span class="built_in">object</span>, metaclass=ProxyMetaclass):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_proxies</span>(<span class="params">self, callback</span>):</span><br><span class="line">        proxies = []</span><br><span class="line">        <span class="keyword">for</span> proxy <span class="keyword">in</span> <span class="built_in">eval</span>(<span class="string">&quot;self.&#123;&#125;()&quot;</span>.<span class="built_in">format</span>(callback)):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;æˆåŠŸè·å–åˆ°ä»£ç†&#x27;</span>, proxy)</span><br><span class="line">            proxies.append(proxy)</span><br><span class="line">        <span class="keyword">return</span> proxies</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">crawl_daili66</span>(<span class="params">self, page_count=<span class="number">4</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        è·å–ä»£ç†66</span></span><br><span class="line"><span class="string">        :param page_count: é¡µç </span></span><br><span class="line"><span class="string">        :return: ä»£ç†</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        start_url = <span class="string">&#x27;http://www.66ip.cn/&#123;&#125;.html&#x27;</span></span><br><span class="line">        urls = [start_url.<span class="built_in">format</span>(page) <span class="keyword">for</span> page <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, page_count + <span class="number">1</span>)]</span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Crawling&#x27;</span>, url)</span><br><span class="line">            html = get_page(url)</span><br><span class="line">            <span class="keyword">if</span> html:</span><br><span class="line">                doc = pq(html)</span><br><span class="line">                trs = doc(<span class="string">&#x27;.containerbox table tr:gt(0)&#x27;</span>).items()</span><br><span class="line">                <span class="keyword">for</span> tr <span class="keyword">in</span> trs:</span><br><span class="line">                    ip = tr.find(<span class="string">&#x27;td:nth-child(1)&#x27;</span>).text()</span><br><span class="line">                    port = tr.find(<span class="string">&#x27;td:nth-child(2)&#x27;</span>).text()</span><br><span class="line">                    <span class="keyword">yield</span> <span class="string">&#x27;:&#x27;</span>.join([ip, port])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">crawl_proxy360</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        è·å–Proxy360</span></span><br><span class="line"><span class="string">        :return: ä»£ç†</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        start_url = <span class="string">&#x27;http://www.proxy360.cn/Region/China&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Crawling&#x27;</span>, start_url)</span><br><span class="line">        html = get_page(start_url)</span><br><span class="line">        <span class="keyword">if</span> html:</span><br><span class="line">            doc = pq(html)</span><br><span class="line">            lines = doc(<span class="string">&#x27;div[name=&quot;list_proxy_ip&quot;]&#x27;</span>).items()</span><br><span class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">                ip = line.find(<span class="string">&#x27;.tbBottomLine:nth-child(1)&#x27;</span>).text()</span><br><span class="line">                port = line.find(<span class="string">&#x27;.tbBottomLine:nth-child(2)&#x27;</span>).text()</span><br><span class="line">                <span class="keyword">yield</span> <span class="string">&#x27;:&#x27;</span>.join([ip, port])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">crawl_goubanjia</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        è·å–Goubanjia</span></span><br><span class="line"><span class="string">        :return: ä»£ç†</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        start_url = <span class="string">&#x27;http://www.goubanjia.com/free/gngn/index.shtml&#x27;</span></span><br><span class="line">        html = get_page(start_url)</span><br><span class="line">        <span class="keyword">if</span> html:</span><br><span class="line">            doc = pq(html)</span><br><span class="line">            tds = doc(<span class="string">&#x27;td.ip&#x27;</span>).items()</span><br><span class="line">            <span class="keyword">for</span> td <span class="keyword">in</span> tds:</span><br><span class="line">                td.find(<span class="string">&#x27;p&#x27;</span>).remove()</span><br><span class="line">                <span class="keyword">yield</span> td.text().replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure><blockquote><p>ä¸Šè¿°ä»£ç é€šè¿‡ï¼šç»Ÿä¸€å®šä¹‰ä»¥ crawl å¼€å¤´ï¼ŒæŠ“å–ä»£ç† 66ã€Proxy360ã€Goubanjia ä¸‰ä¸ªå…è´¹ä»£ç†ç½‘ç«™ï¼Œæ ¹æ®yield è¿”å›ä¸€ä¸ªä¸ªä»£ç†ã€‚é¦–å…ˆå°†ç½‘é¡µè·å–ï¼Œç„¶åç”¨ PyQuery è§£æï¼Œè§£æå‡º IP åŠ ç«¯å£çš„å½¢å¼çš„ä»£ç†ç„¶åè¿”å›ã€‚ ç„¶åå®šä¹‰äº†ä¸€ä¸ª get_proxies () æ–¹æ³•ï¼Œå°†æ‰€æœ‰ä»¥ crawl å¼€å¤´çš„æ–¹æ³•è°ƒç”¨ä¸€éï¼Œè·å–æ¯ä¸ªæ–¹æ³•è¿”å›çš„ä»£ç†å¹¶ç»„åˆæˆåˆ—è¡¨å½¢å¼è¿”å›ï¼Œé€šè¿‡æ­¤æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥åªéœ€è¦æ·»åŠ ä¸€ä¸ªä»¥ crawl å¼€å¤´çš„æ–¹æ³•ï¼Œä¾‹å¦‚æŠ“å–å¿«ä»£ç†ï¼Œåœ¨ Crawler ç±»ä¸­å¢åŠ  crawl_kuaidaili () æ–¹æ³•ï¼Œä»¿ç…§å…¶ä»–çš„å‡ ä¸ªæ–¹æ³•å°†å…¶å®šä¹‰æˆç”Ÿæˆå™¨ï¼ŒæŠ“å–å…¶ç½‘ç«™çš„ä»£ç†ï¼Œç„¶åé€šè¿‡ yield è¿”å›ä»£ç†å³å¯ã€‚</p></blockquote><ul><li>ç„¶åï¼Œå®šä¹‰ä¸€ä¸ª Getter ç±»ï¼ŒåŠ¨æ€åœ°è°ƒç”¨æ‰€æœ‰ä»¥ crawl å¼€å¤´çš„æ–¹æ³•ï¼Œç„¶åè·å–æŠ“å–åˆ°çš„ä»£ç†ï¼Œå°†å…¶åŠ å…¥åˆ°æ•°æ®åº“å­˜å‚¨èµ·æ¥</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> db <span class="keyword">import</span> RedisClient</span><br><span class="line"><span class="keyword">from</span> crawler <span class="keyword">import</span> Crawler</span><br><span class="line"></span><br><span class="line">POOL_UPPER_THRESHOLD = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–æ¨¡å—ä¸­æ‰€æœ‰çš„ç±»</span></span><br><span class="line">crawlers_cls = [</span><br><span class="line">    base,</span><br><span class="line">    Ip89Crawler,</span><br><span class="line">    Daili66Crawler,</span><br><span class="line">    Data5UCrawler,</span><br><span class="line">    DocipCrawler,</span><br><span class="line">    FatezeroCrawler,</span><br><span class="line">    GeonodeCrawler,</span><br><span class="line">    GoubanjiaCrawler,</span><br><span class="line">    IhuanCrawler,</span><br><span class="line">    IP3366Crawler,</span><br><span class="line">    IPHaiCrawler,</span><br><span class="line">    JiangxianliCrawler,</span><br><span class="line">    KuaidailiCrawler,</span><br><span class="line">    SeoFangFaCrawler,</span><br><span class="line">    TaiyangdailiCrawler,</span><br><span class="line">    UqidataCrawler,</span><br><span class="line">    XiaoShuCrawler,</span><br><span class="line">    XicidailiCrawler,</span><br><span class="line">    XiladailiCrawler,</span><br><span class="line">    YqIeCrawler,</span><br><span class="line">    ZhandayeCrawler</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">crawlers_cls = [cls <span class="keyword">for</span> cls <span class="keyword">in</span> crawlers_cls</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(cls, <span class="built_in">type</span>) <span class="keyword">and</span> <span class="built_in">issubclass</span>(cls, BaseCrawler) <span class="keyword">and</span> cls <span class="keyword">is</span> <span class="keyword">not</span> BaseCrawler</span><br><span class="line">    <span class="keyword">and</span> <span class="keyword">not</span> <span class="built_in">getattr</span>(cls, <span class="string">&#x27;ignore&#x27;</span>, <span class="literal">False</span>)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Getter</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    getter of src</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        init db and crawlers</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.redis = RedisClient()</span><br><span class="line">        <span class="variable language_">self</span>.crawlers_cls = crawlers_cls</span><br><span class="line">        <span class="variable language_">self</span>.crawlers = [crawler_cls() <span class="keyword">for</span> crawler_cls <span class="keyword">in</span> <span class="variable language_">self</span>.crawlers_cls]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_full</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        if src if full</span></span><br><span class="line"><span class="string">        return: bool</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.redis.count() &gt;= PROXY_NUMBER_MAX</span><br><span class="line"></span><br><span class="line"><span class="meta">    @logger.catch</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        run crawlers to get proxy</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        logger.info(<span class="string">&#x27;stating getter...&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.is_full():</span><br><span class="line">            logger.error(<span class="string">&quot;crawler is full!&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">for</span> crawler <span class="keyword">in</span> <span class="variable language_">self</span>.crawlers:</span><br><span class="line">            logger.info(<span class="string">f&#x27;crawler <span class="subst">&#123;crawler&#125;</span> to get proxy&#x27;</span>)</span><br><span class="line">            <span class="keyword">for</span> proxy <span class="keyword">in</span> crawler.crawl():</span><br><span class="line">                <span class="variable language_">self</span>.redis.add(proxy)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.crawlers:</span><br><span class="line">            logger.error(<span class="string">&quot;import crawler error! please check crawler import.&quot;</span>)</span><br></pre></td></tr></table></figure><blockquote><p>Getter ç±»å°±æ˜¯è·å–å™¨ç±»ï¼Œè¿™å…¶ä¸­å®šä¹‰äº†ä¸€ä¸ªå˜é‡ POOL_UPPER_THRESHOLD è¡¨ç¤ºä»£ç†æ± çš„æœ€å¤§æ•°é‡ï¼Œç„¶åå®šä¹‰äº† is_over_threshold () æ–¹æ³•åˆ¤æ–­ä»£ç†æ± æ˜¯å¦å·²ç»è¾¾åˆ°äº†å®¹é‡é˜ˆå€¼ï¼Œå®ƒå°±æ˜¯è°ƒç”¨äº† RedisClient çš„ count () æ–¹æ³•è·å–ä»£ç†çš„æ•°é‡ï¼Œç„¶ååŠ ä»¥åˆ¤æ–­ï¼Œå¦‚æœæ•°é‡è¾¾åˆ°é˜ˆå€¼åˆ™è¿”å› Trueï¼Œå¦åˆ™ Falseã€‚å¦‚æœä¸æƒ³åŠ è¿™ä¸ªé™åˆ¶å¯ä»¥å°†æ­¤æ–¹æ³•æ°¸ä¹…è¿”å› Trueã€‚ æ¥ä¸‹æ¥å®šä¹‰äº† run () æ–¹æ³•ï¼Œé¦–å…ˆåˆ¤æ–­äº†ä»£ç†æ± æ˜¯å¦è¾¾åˆ°é˜ˆå€¼ï¼Œç„¶ååœ¨è¿™é‡Œå°±è°ƒç”¨äº† Crawler ç±»çš„ CrawlFunc å±æ€§ï¼Œè·å–åˆ°æ‰€æœ‰ä»¥ crawl å¼€å¤´çš„æ–¹æ³•åˆ—è¡¨ï¼Œä¾æ¬¡é€šè¿‡ get_proxies () æ–¹æ³•è°ƒç”¨ï¼Œå¾—åˆ°å„ä¸ªæ–¹æ³•æŠ“å–åˆ°çš„ä»£ç†ï¼Œç„¶åå†åˆ©ç”¨ RedisClient çš„ add () æ–¹æ³•åŠ å…¥æ•°æ®åº“.</p></blockquote><h3 id="æ£€æµ‹ä»£ç†">æ£€æµ‹ä»£ç†</h3><blockquote><p>ç”±äºä»£ç†çš„æ•°é‡éå¸¸å¤šï¼Œä¸ºäº†æé«˜ä»£ç†çš„æ£€æµ‹æ•ˆç‡ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨å¼‚æ­¥è¯·æ±‚åº“ Aiohttp æ¥è¿›è¡Œæ£€æµ‹.</p></blockquote><ul><li>æ£€æµ‹ä»£ç å¦‚ä¸‹ï¼š</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">VALID_STATUS_CODES = [<span class="number">200</span>]</span><br><span class="line">TEST_URL = <span class="string">&#x27;http://www.baidu.com&#x27;</span></span><br><span class="line">BATCH_TEST_SIZE = <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Tester</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.redis = RedisClient()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">test_single_proxy</span>(<span class="params">self, proxy</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        æµ‹è¯•å•ä¸ªä»£ç†</span></span><br><span class="line"><span class="string">        :param proxy: å•ä¸ªä»£ç†</span></span><br><span class="line"><span class="string">        :return: None</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        conn = aiohttp.TCPConnector(verify_ssl=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession(connector=conn) <span class="keyword">as</span> session:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">isinstance</span>(proxy, <span class="built_in">bytes</span>):</span><br><span class="line">                    proxy = proxy.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">                real_proxy = <span class="string">&#x27;http://&#x27;</span> + proxy</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;æ­£åœ¨æµ‹è¯•&#x27;</span>, proxy)</span><br><span class="line">                <span class="keyword">async</span> <span class="keyword">with</span> session.get(TEST_URL, proxy=real_proxy, timeout=<span class="number">15</span>) <span class="keyword">as</span> response:</span><br><span class="line">                    <span class="keyword">if</span> response.status <span class="keyword">in</span> VALID_STATUS_CODES:</span><br><span class="line">                        <span class="variable language_">self</span>.redis.<span class="built_in">max</span>(proxy)</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&#x27;ä»£ç†å¯ç”¨&#x27;</span>, proxy)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="variable language_">self</span>.redis.decrease(proxy)</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&#x27;è¯·æ±‚å“åº”ç ä¸åˆæ³•&#x27;</span>, proxy)</span><br><span class="line">            <span class="keyword">except</span> (ClientError, ClientConnectorError, TimeoutError, AttributeError):</span><br><span class="line">                <span class="variable language_">self</span>.redis.decrease(proxy)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;ä»£ç†è¯·æ±‚å¤±è´¥&#x27;</span>, proxy)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        æµ‹è¯•ä¸»å‡½æ•°</span></span><br><span class="line"><span class="string">        :return: None</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;æµ‹è¯•å™¨å¼€å§‹è¿è¡Œ&#x27;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            proxies = <span class="variable language_">self</span>.redis.<span class="built_in">all</span>()</span><br><span class="line">            loop = asyncio.get_event_loop()</span><br><span class="line">            <span class="comment"># æ‰¹é‡æµ‹è¯•</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(proxies), BATCH_TEST_SIZE):</span><br><span class="line">                test_proxies = proxies[i:i + BATCH_TEST_SIZE]</span><br><span class="line">                tasks = [<span class="variable language_">self</span>.test_single_proxy(proxy) <span class="keyword">for</span> proxy <span class="keyword">in</span> test_proxies]</span><br><span class="line">                loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">                time.sleep(<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;æµ‹è¯•å™¨å‘ç”Ÿé”™è¯¯&#x27;</span>, e.args)</span><br></pre></td></tr></table></figure><blockquote><p>ä¸Šè¿°ä»£ç ï¼šå¼‚æ­¥test_single_proxy () æ–¹æ³•ï¼Œç”¨æ¥æ£€æµ‹å•ä¸ªä»£ç†çš„å¯ç”¨æƒ…å†µï¼Œå…¶å‚æ•°å°±æ˜¯è¢«æ£€æµ‹çš„ä»£ç†ï¼›æ‰¹é‡æµ‹è¯•çš„æœ€å¤§å€¼ BATCH_TEST_SIZE ä¸º 100,é¿å…å½“ä»£ç†æ± è¿‡å¤§æ—¶å…¨éƒ¨æµ‹è¯•å¯¼è‡´å†…å­˜å¼€é”€è¿‡å¤§çš„é—®é¢˜, run () æ–¹æ³•é‡Œé¢è·å–äº†æ‰€æœ‰çš„ä»£ç†åˆ—è¡¨ï¼Œä½¿ç”¨ Aiohttp åˆ†é…ä»»åŠ¡ï¼Œå¯åŠ¨è¿è¡Œ</p></blockquote><h3 id="æ¥å£å°è£…">æ¥å£å°è£…</h3><ul><li>ä»¥ Web API çš„å½¢å¼æš´éœ²å¯ç”¨ä»£ç†ï¼Œä½¿ç”¨ä¸€ä¸ªæ¯”è¾ƒè½»é‡çº§çš„åº“ Flask æ¥å®ç°è¿™ä¸ªæ¥å£æ¨¡å—ï¼š</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, g</span><br><span class="line"><span class="keyword">from</span> db <span class="keyword">import</span> RedisClient</span><br><span class="line"></span><br><span class="line">__all__ = [<span class="string">&#x27;app&#x27;</span>]</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_conn</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(g, <span class="string">&#x27;redis&#x27;</span>):</span><br><span class="line">        g.redis = RedisClient()</span><br><span class="line">    <span class="keyword">return</span> g.redis</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&lt;h2&gt;Welcome to Proxy Pool System&lt;/h2&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/random&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_proxy</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è·å–éšæœºå¯ç”¨ä»£ç†</span></span><br><span class="line"><span class="string">    :return: éšæœºä»£ç†</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    conn = get_conn()</span><br><span class="line">    <span class="keyword">return</span> conn.random()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/count&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_counts</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è·å–ä»£ç†æ± æ€»é‡</span></span><br><span class="line"><span class="string">    :return: ä»£ç†æ± æ€»é‡</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    conn = get_conn()</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(conn.count())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure><h3 id="èµ„æºè°ƒåº¦æ¨¡å—">èµ„æºè°ƒåº¦æ¨¡å—</h3><ul><li>è°ƒç”¨ä»¥ä¸Šæ‰€å®šä¹‰çš„ä¸‰ä¸ªæ¨¡å—ï¼Œå°†ä»¥ä¸Šä¸‰ä¸ªæ¨¡å—é€šè¿‡å¤šè¿›ç¨‹çš„å½¢å¼è¿è¡Œï¼Œé«˜æ•ˆåˆ©ç”¨èµ„æº</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">TESTER_CYCLE = <span class="number">20</span></span><br><span class="line">GETTER_CYCLE = <span class="number">20</span></span><br><span class="line">TESTER_ENABLED = <span class="literal">True</span></span><br><span class="line">GETTER_ENABLED = <span class="literal">True</span></span><br><span class="line">API_ENABLED = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process</span><br><span class="line"><span class="keyword">from</span> api <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">from</span> getter <span class="keyword">import</span> Getter</span><br><span class="line"><span class="keyword">from</span> tester <span class="keyword">import</span> Tester</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Scheduler</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">schedule_tester</span>(<span class="params">self, cycle=TESTER_CYCLE</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        å®šæ—¶æµ‹è¯•ä»£ç†</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        tester = Tester()</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;æµ‹è¯•å™¨å¼€å§‹è¿è¡Œ&#x27;</span>)</span><br><span class="line">            tester.run()</span><br><span class="line">            time.sleep(cycle)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">schedule_getter</span>(<span class="params">self, cycle=GETTER_CYCLE</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        å®šæ—¶è·å–ä»£ç†</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        getter = Getter()</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;å¼€å§‹æŠ“å–ä»£ç†&#x27;</span>)</span><br><span class="line">            getter.run()</span><br><span class="line">            time.sleep(cycle)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">schedule_api</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        å¼€å¯API</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        app.run(API_HOST, API_PORT)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;ä»£ç†æ± å¼€å§‹è¿è¡Œ&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> TESTER_ENABLED:</span><br><span class="line">            tester_process = Process(target=<span class="variable language_">self</span>.schedule_tester)</span><br><span class="line">            tester_process.start()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> GETTER_ENABLED:</span><br><span class="line">            getter_process = Process(target=<span class="variable language_">self</span>.schedule_getter)</span><br><span class="line">            getter_process.start()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> API_ENABLED:</span><br><span class="line">            api_process = Process(target=<span class="variable language_">self</span>.schedule_api)</span><br><span class="line">            api_process.start()</span><br></pre></td></tr></table></figure><ul><li>ä»¥ä¸‹ç‰ˆæœ¬å…¼å®¹winå¹³å°æ‰“åŒ…exeï¼š</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> processors.server <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">from</span> processors.getter <span class="keyword">import</span> Getter</span><br><span class="line"><span class="keyword">from</span> processors.tester <span class="keyword">import</span> Tester</span><br><span class="line"><span class="keyword">from</span> run.setting <span class="keyword">import</span> APP_PROD_METHOD_GEVENT, APP_PROD_METHOD_MEINHELD, APP_PROD_METHOD_TORNADO, CYCLE_GETTER, CYCLE_TESTER, API_HOST, \</span><br><span class="line">    API_THREADED, API_PORT, ENABLE_SERVER, IS_PROD, APP_PROD_METHOD, \</span><br><span class="line">    ENABLE_GETTER, ENABLE_TESTER, IS_WINDOWS</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"></span><br><span class="line">tester_process, getter_process, server_process = <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Scheduler</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    scheduler</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run_tester</span>(<span class="params">self, cycle=CYCLE_TESTER</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        run tester</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ENABLE_TESTER:</span><br><span class="line">            logger.info(<span class="string">&#x27;tester not enabled, exit&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        loop = asyncio.new_event_loop()</span><br><span class="line">        asyncio.set_event_loop(loop)</span><br><span class="line">        tester = Tester()</span><br><span class="line">        loop = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            logger.debug(<span class="string">f&#x27;tester loop <span class="subst">&#123;loop&#125;</span> start...&#x27;</span>)</span><br><span class="line">            tester.run()</span><br><span class="line"></span><br><span class="line">            loop += <span class="number">1</span></span><br><span class="line">            time.sleep(cycle)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run_getter</span>(<span class="params">self, cycle=CYCLE_GETTER</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        run getter</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ENABLE_GETTER:</span><br><span class="line">            logger.info(<span class="string">&#x27;getter not enabled, exit&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        loop = asyncio.new_event_loop()</span><br><span class="line">        asyncio.set_event_loop(loop)</span><br><span class="line">        getter = Getter()</span><br><span class="line">        loop = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            logger.debug(<span class="string">f&#x27;getter loop <span class="subst">&#123;loop&#125;</span> start...&#x27;</span>)</span><br><span class="line">            getter.run()</span><br><span class="line">            loop += <span class="number">1</span></span><br><span class="line">            time.sleep(cycle)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run_server</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        run server for api</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ENABLE_SERVER:</span><br><span class="line">            logger.info(<span class="string">&#x27;server not enabled, exit&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> IS_PROD:</span><br><span class="line">            <span class="keyword">if</span> APP_PROD_METHOD == APP_PROD_METHOD_GEVENT:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">from</span> gevent.pywsgi <span class="keyword">import</span> WSGIServer</span><br><span class="line">                <span class="keyword">except</span> ImportError <span class="keyword">as</span> e:</span><br><span class="line">                    logger.exception(e)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    http_server = WSGIServer((API_HOST, API_PORT), app)</span><br><span class="line">                    http_server.serve_forever()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">elif</span> APP_PROD_METHOD == APP_PROD_METHOD_TORNADO:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">from</span> tornado.wsgi <span class="keyword">import</span> WSGIContainer</span><br><span class="line">                    <span class="keyword">from</span> tornado.httpserver <span class="keyword">import</span> HTTPServer</span><br><span class="line">                    <span class="keyword">from</span> tornado.ioloop <span class="keyword">import</span> IOLoop</span><br><span class="line">                <span class="keyword">except</span> ImportError <span class="keyword">as</span> e:</span><br><span class="line">                    logger.exception(e)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    http_server = HTTPServer(WSGIContainer(app))</span><br><span class="line">                    http_server.listen(API_PORT)</span><br><span class="line">                    IOLoop.instance().start()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">elif</span> APP_PROD_METHOD == APP_PROD_METHOD_MEINHELD:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">import</span> meinheld</span><br><span class="line">                <span class="keyword">except</span> ImportError <span class="keyword">as</span> e:</span><br><span class="line">                    logger.exception(e)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    meinheld.listen((API_HOST, API_PORT))</span><br><span class="line">                    meinheld.run(app)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                logger.error(<span class="string">&quot;unsupported APP_PROD_METHOD&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            app.run(host=API_HOST, port=API_PORT, threaded=API_THREADED, use_reloader=<span class="literal">False</span>, debug=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">global</span> tester_process, getter_process, server_process</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            logger.info(<span class="string">&#x27;starting ..&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> ENABLE_TESTER:</span><br><span class="line">                tester_process = threading.Thread(</span><br><span class="line">                    target=<span class="variable language_">self</span>.run_tester)</span><br><span class="line">                logger.info(<span class="string">f&#x27;starting tester, pid <span class="subst">&#123;tester_process.name&#125;</span>...&#x27;</span>)</span><br><span class="line">                tester_process.start()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ENABLE_GETTER:</span><br><span class="line">                getter_process = threading.Thread(</span><br><span class="line">                    target=<span class="variable language_">self</span>.run_getter)</span><br><span class="line">                logger.info(<span class="string">f&#x27;starting getter, pid <span class="subst">&#123;getter_process.name&#125;</span>...&#x27;</span>)</span><br><span class="line">                getter_process.start()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ENABLE_SERVER:</span><br><span class="line">                server_process = threading.Thread(</span><br><span class="line">                    target=<span class="variable language_">self</span>.run_server)</span><br><span class="line">                logger.info(<span class="string">f&#x27;starting server, pid <span class="subst">&#123;server_process.name&#125;</span>...&#x27;</span>)</span><br><span class="line">                server_process.start()</span><br><span class="line"></span><br><span class="line">            tester_process <span class="keyword">and</span> tester_process.join()</span><br><span class="line">            getter_process <span class="keyword">and</span> getter_process.join()</span><br><span class="line">            server_process <span class="keyword">and</span> server_process.join()</span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">            logger.info(<span class="string">&#x27;received keyboard interrupt signal&#x27;</span>)</span><br><span class="line">            <span class="comment"># tester_process and tester_process()</span></span><br><span class="line">            <span class="comment"># getter_process and getter_process.stop()</span></span><br><span class="line">            <span class="comment"># server_process and server_process.terminate()</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="comment"># must call join method before calling is_alive</span></span><br><span class="line">            tester_process <span class="keyword">and</span> tester_process.join()</span><br><span class="line">            getter_process <span class="keyword">and</span> getter_process.join()</span><br><span class="line">            server_process <span class="keyword">and</span> server_process.join()</span><br><span class="line">            logger.info(</span><br><span class="line">                <span class="string">f&#x27;tester is <span class="subst">&#123;<span class="string">&quot;alive&quot;</span> <span class="keyword">if</span> tester_process.is_alive() <span class="keyword">else</span> <span class="string">&quot;dead&quot;</span>&#125;</span>&#x27;</span>)</span><br><span class="line">            logger.info(</span><br><span class="line">                <span class="string">f&#x27;getter is <span class="subst">&#123;<span class="string">&quot;alive&quot;</span> <span class="keyword">if</span> getter_process.is_alive() <span class="keyword">else</span> <span class="string">&quot;dead&quot;</span>&#125;</span>&#x27;</span>)</span><br><span class="line">            logger.info(</span><br><span class="line">                <span class="string">f&#x27;server is <span class="subst">&#123;<span class="string">&quot;alive&quot;</span> <span class="keyword">if</span> server_process.is_alive() <span class="keyword">else</span> <span class="string">&quot;dead&quot;</span>&#125;</span>&#x27;</span>)</span><br><span class="line">            logger.info(<span class="string">&#x27;proxy terminated&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    scheduler = Scheduler()</span><br><span class="line">    scheduler.run()</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>ä¸‰ä¸ªå¸¸é‡ï¼ŒTESTER_ENABLEDã€GETTER_ENABLEDã€API_ENABLED éƒ½æ˜¯å¸ƒå°”ç±»å‹ï¼ŒTrue æˆ–è€… Falseã€‚æ ‡æ˜äº†æµ‹è¯•æ¨¡å—ã€è·å–æ¨¡å—ã€æ¥å£æ¨¡å—çš„å¼€å…³ï¼Œå¦‚æœä¸º Trueï¼Œåˆ™ä»£è¡¨æ¨¡å—å¼€å¯ã€‚ å¯åŠ¨å…¥å£æ˜¯ run () æ–¹æ³•ï¼Œå…¶åˆ†åˆ«åˆ¤æ–­äº†ä¸‰ä¸ªæ¨¡å—çš„å¼€å…³ï¼Œå¦‚æœå¼€å¯çš„è¯ï¼Œå°±æ–°å»ºä¸€ä¸ª Process è¿›ç¨‹ï¼Œè®¾ç½®å¥½å¯åŠ¨ç›®æ ‡ï¼Œç„¶åè°ƒç”¨ start () æ–¹æ³•è¿è¡Œ.</p></blockquote><h2 id="è¿è¡Œä¸æµ‹è¯•">è¿è¡Œä¸æµ‹è¯•</h2><h3 id="è¿è¡Œä»£ç ">è¿è¡Œä»£ç </h3><ul><li>é‡‡ç”¨å¦‚ä¸‹å½¢å¼</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> run.scheduler <span class="keyword">import</span> Scheduler</span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">&#x27;ProxyPool&#x27;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;--processor&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&#x27;processor to run&#x27;</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># if processor set, just run it</span></span><br><span class="line">    <span class="keyword">if</span> args.processor:</span><br><span class="line">        <span class="built_in">getattr</span>(Scheduler(), <span class="string">f&#x27;run_<span class="subst">&#123;args.processor&#125;</span>&#x27;</span>)()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        Scheduler().run()</span><br></pre></td></tr></table></figure><h3 id="ç¼–å†™æµ‹è¯•ä»£ç ">ç¼–å†™æµ‹è¯•ä»£ç </h3><ul><li>requestè¯·æ±‚æµ‹è¯•</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">PROXY_POOL_URL = <span class="string">&#x27;http://localhost:5555/random&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_proxy</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.get(PROXY_POOL_URL)</span><br><span class="line">        <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">            <span class="keyword">return</span> response.text</span><br><span class="line">    <span class="keyword">except</span> ConnectionError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure><h2 id="ä»£ç†ä½¿ç”¨">ä»£ç†ä½¿ç”¨</h2><ul><li>å…·ä½“ç”¨æ³•ä¸ä¸€ï¼Œä¸¾ä¾‹å¦‚ä¸‹ï¼š</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">proxy = get_proxy()</span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;http://&#x27;</span> + proxy,</span><br><span class="line">    <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;https://&#x27;</span> + proxy,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = requests.get(<span class="string">&#x27;http://httpbin.org/get&#x27;</span>, proxies=proxies)</span><br><span class="line">    <span class="built_in">print</span>(response.text)</span><br><span class="line"><span class="keyword">except</span> requests.exceptions.ConnectionError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Error&#x27;</span>, e.args)</span><br></pre></td></tr></table></figure><ul><li>æŠ‘æˆ–</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">proxy = &#123;</span><br><span class="line">    <span class="string">&quot;proxyType&quot;</span>: <span class="string">&quot;manual&quot;</span>,</span><br><span class="line">    <span class="string">&quot;httpProxy&quot;</span>: <span class="string">&quot;http://&quot;</span> + constants.proxy_server_ip + <span class="string">&quot;:&quot;</span> + <span class="built_in">str</span>(constants.proxy_server_port),  <span class="comment"># ä»£ç†æœåŠ¡å™¨åœ°å€å’Œç«¯å£</span></span><br><span class="line">    <span class="string">&quot;ftpProxy&quot;</span>: <span class="string">&quot;ftp://&quot;</span> + constants.proxy_server_ip + <span class="string">&quot;:&quot;</span> + <span class="built_in">str</span>(constants.proxy_server_port),</span><br><span class="line">    <span class="string">&quot;sslProxy&quot;</span>: <span class="string">&quot;https://&quot;</span> + constants.proxy_server_ip + <span class="string">&quot;:&quot;</span> + <span class="built_in">str</span>(constants.proxy_server_port),</span><br><span class="line">    <span class="string">&quot;noProxy&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;proxyAutoconfigUrl&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">options = webdriver.ChromeOptions()</span><br><span class="line"><span class="keyword">if</span> constants.spider_mode == <span class="string">&#x27;auto&#x27;</span>:</span><br><span class="line">    options.add_argument(<span class="string">&#x27;--headless&#x27;</span>)</span><br><span class="line">    options.add_argument(<span class="string">&#x27;--no-sandbox&#x27;</span>)</span><br><span class="line">    options.add_argument(<span class="string">&#x27;--disable-dev-shm-usage&#x27;</span>)</span><br><span class="line">    logger.warning(<span class="string">&quot;current spider mode: auto spider image mode!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># open dev tools</span></span><br><span class="line">options.add_argument(<span class="string">&quot;--auto-open-devtools-for-tabs&quot;</span>)</span><br><span class="line"><span class="comment"># æ¥å—ä¸å®‰å…¨è¯ä¹¦</span></span><br><span class="line">options.add_argument(<span class="string">&quot;--ignore-certificate-errors&quot;</span>)</span><br><span class="line"><span class="comment"># è®¾ç½®æ—¥å¿—åå¥½ï¼Œç¦ç”¨æ‰€æœ‰æ—¥å¿—</span></span><br><span class="line">options = disabled_log_browser(options)</span><br><span class="line"><span class="comment"># å»é™¤ â€œChromeæ­£å—åˆ°è‡ªåŠ¨åŒ–æµ‹è¯•è½¯ä»¶çš„æ§åˆ¶â€</span></span><br><span class="line">options.add_experimental_option(<span class="string">&#x27;excludeSwitches&#x27;</span>, [<span class="string">&#x27;enable-automation&#x27;</span>])</span><br><span class="line"><span class="comment"># æ·»åŠ æµè§ˆå™¨ç‰¹å¾</span></span><br><span class="line">options.add_argument(<span class="string">&quot;--disable-blink-features=AutomationControlled&quot;</span>)</span><br><span class="line"><span class="comment"># æ¨¡æ‹Ÿä¸åŒæµè§ˆå™¨è®¿é—®é¡µé¢ å‡å°‘è¢«å°é£é™©</span></span><br><span class="line">user_agents = read_user_agent()</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> user_agents:</span><br><span class="line">    <span class="comment"># æ²¡æœ‰txt ä½¿ç”¨default value</span></span><br><span class="line">    user_agents = [</span><br><span class="line">        <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.150 &#x27;</span></span><br><span class="line">        <span class="string">&#x27;Safari/537.36 &#x27;</span></span><br><span class="line">    ]</span><br><span class="line">    logger.warning(<span class="string">f&quot;not user-agent, use default user-agent: <span class="subst">&#123;user_agents[<span class="number">0</span>]&#125;</span>&quot;</span>)</span><br><span class="line"><span class="comment"># éšæœºæ·»åŠ user-agent</span></span><br><span class="line">cur_user_agents = random.choice(user_agents).strip()</span><br><span class="line"><span class="comment"># add user-agent</span></span><br><span class="line"><span class="keyword">if</span> cur_user_agents:</span><br><span class="line">    options.add_argument(</span><br><span class="line">        <span class="string">f&quot;user-agent=<span class="subst">&#123;cur_user_agents&#125;</span>&quot;</span>)</span><br><span class="line">    logger.info(<span class="string">f&quot;current use user-agent: <span class="subst">&#123;cur_user_agents&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> proxy_flag == <span class="string">&#x27;True&#x27;</span>:</span><br><span class="line">    <span class="keyword">if</span> constants.proxy_mode == <span class="string">&#x27;auto&#x27;</span>:</span><br><span class="line">        logger.info(<span class="string">&quot;cur spider use proxy is auto select proxy model.&quot;</span>)</span><br><span class="line">        proxy_item = get_proxy_item() <span class="comment"># ç›´æ¥è°ƒç”¨æŸ¥è¯¢proxyæ¥å£å³å¯</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> proxy_item:</span><br><span class="line">            logger.error(<span class="string">&quot;proxy_item None, will quit spider image!&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">        logger.debug(<span class="string">f&quot;use proxy: <span class="subst">&#123;proxy_item&#125;</span>&quot;</span>)</span><br><span class="line">        proxy = &#123;</span><br><span class="line">            <span class="string">&quot;proxyType&quot;</span>: <span class="string">&quot;manual&quot;</span>,</span><br><span class="line">            <span class="string">&quot;httpProxy&quot;</span>: <span class="string">&quot;http://&quot;</span> + proxy_item,  <span class="comment"># ä»£ç†æœåŠ¡å™¨åœ°å€å’Œç«¯å£</span></span><br><span class="line">            <span class="string">&quot;ftpProxy&quot;</span>: <span class="string">&quot;ftp://&quot;</span> + proxy_item,</span><br><span class="line">            <span class="string">&quot;sslProxy&quot;</span>: <span class="string">&quot;https://&quot;</span> + proxy_item,</span><br><span class="line">            <span class="string">&quot;noProxy&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="string">&quot;proxyAutoconfigUrl&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment"># options.set_capability(&quot;proxy&quot;, proxy)</span></span><br><span class="line">    options.add_argument(<span class="string">&quot;--proxy-server=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(proxy[<span class="string">&quot;httpProxy&quot;</span>]))</span><br><span class="line">    logger.info(<span class="string">&quot;current use internal proxy, proxy content: &quot;</span> + <span class="built_in">str</span>(proxy[<span class="string">&#x27;httpProxy&#x27;</span>]))</span><br><span class="line">    <span class="keyword">if</span> constants.chrome_path != <span class="string">&#x27;None&#x27;</span>:</span><br><span class="line">        ser = Service()</span><br><span class="line">        ser.path = constants.chrome_path</span><br><span class="line">        <span class="comment"># è¿æ¥Edgeæµè§ˆå™¨</span></span><br><span class="line">        driver = webdriver.Chrome(service=ser, options=options)</span><br><span class="line">        logger.warning(<span class="string">&quot;user self define chrome driver exe!&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        driver = webdriver.Chrome(options=options)</span><br><span class="line">        logger.info(<span class="string">&quot;use system default web driver!&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="è¡¥å……">è¡¥å……</h2><h3 id="random-è·å–ä»£ç†æœºåˆ¶">random è·å–ä»£ç†æœºåˆ¶</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">select_best_proxy</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param data:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># same_max_value = []</span></span><br><span class="line">    block_split_num = <span class="number">10</span></span><br><span class="line">    <span class="keyword">if</span> block_split_num &lt; <span class="built_in">len</span>(data) - <span class="number">1</span>:</span><br><span class="line">        length_data = <span class="built_in">int</span>(<span class="built_in">len</span>(data) / block_split_num)</span><br><span class="line">        index = <span class="built_in">int</span>(random.random() * length_data) + <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(data) &gt; length_data + <span class="number">2</span>:</span><br><span class="line">            logger.info(<span class="string">f&quot;data length: <span class="subst">&#123;<span class="built_in">len</span>(data)&#125;</span> &gt; <span class="subst">&#123;length_data + <span class="number">2</span>&#125;</span>, use random proxy: <span class="subst">&#123;index&#125;</span>&quot;</span>)</span><br><span class="line">            max_value = data[<span class="built_in">len</span>(data) - index]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logger.info(<span class="string">f&quot;data length: <span class="subst">&#123;<span class="built_in">len</span>(data)&#125;</span> &lt; <span class="subst">&#123;length_data + <span class="number">2</span>&#125;</span>, use max valueï¼&quot;</span>)</span><br><span class="line">            max_value = data[<span class="built_in">len</span>(data) - <span class="number">1</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.info(<span class="string">f&quot;data length: <span class="subst">&#123;<span class="built_in">len</span>(data)&#125;</span> &lt; <span class="subst">&#123;block_split_num&#125;</span>, use max valueï¼&quot;</span>)</span><br><span class="line">        max_value = data[<span class="built_in">len</span>(data) - <span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> max_value.string()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="base-crawel">base crawel</h3><ul><li>åŸºç¡€å®šä¹‰</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BaseCrawler</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    urls = []</span><br><span class="line"></span><br><span class="line"><span class="meta">    @retry(<span class="params">stop_max_attempt_number=<span class="number">3</span>, retry_on_result=<span class="keyword">lambda</span> x: x <span class="keyword">is</span> <span class="literal">None</span>, wait_fixed=<span class="number">2000</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">fetch</span>(<span class="params">self, url, **kwargs</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            headers = Headers(headers=<span class="literal">True</span>).generate()</span><br><span class="line">            kwargs.setdefault(<span class="string">&#x27;timeout&#x27;</span>, GET_TIMEOUT)</span><br><span class="line">            kwargs.setdefault(<span class="string">&#x27;verify&#x27;</span>, <span class="literal">False</span>)</span><br><span class="line">            kwargs.setdefault(<span class="string">&#x27;headers&#x27;</span>, headers)</span><br><span class="line">            response = requests.get(url, **kwargs)</span><br><span class="line">            <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">                response.encoding = <span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">                <span class="keyword">return</span> response.text</span><br><span class="line">        <span class="keyword">except</span> (requests.ConnectionError, requests.ReadTimeout):</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process</span>(<span class="params">self, html, url</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        used for parse html</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> proxy <span class="keyword">in</span> <span class="variable language_">self</span>.parse(html):</span><br><span class="line">            <span class="comment"># logger.info(f&#x27;fetched proxy &#123;proxy.string()&#125; from &#123;url&#125;&#x27;)</span></span><br><span class="line">            <span class="keyword">yield</span> proxy</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">crawl</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        crawl main method</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">for</span> url <span class="keyword">in</span> <span class="variable language_">self</span>.urls:</span><br><span class="line">                logger.info(<span class="string">f&#x27;fetching <span class="subst">&#123;url&#125;</span>&#x27;</span>)</span><br><span class="line">                html = <span class="variable language_">self</span>.fetch(url)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> html:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                time.sleep(<span class="number">.5</span>)</span><br><span class="line">                <span class="keyword">yield</span> <span class="keyword">from</span> <span class="variable language_">self</span>.process(html, url)</span><br><span class="line">        <span class="keyword">except</span> RetryError:</span><br><span class="line">            logger.error(</span><br><span class="line">                <span class="string">f&#x27;crawler <span class="subst">&#123;self&#125;</span> crawled proxy unsuccessfully, &#x27;</span></span><br><span class="line">                <span class="string">&#x27;please check if target url is valid or network issue&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>æ‰©å±•åº”ç”¨</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))</span><br><span class="line"><span class="keyword">from</span> pyquery <span class="keyword">import</span> PyQuery <span class="keyword">as</span> pq</span><br><span class="line"><span class="keyword">from</span> schemas.proxy <span class="keyword">import</span> Proxy</span><br><span class="line"><span class="keyword">from</span> crawlers.base <span class="keyword">import</span> BaseCrawler</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BASE_URL = <span class="string">&#x27;https://www.zdaye.com/dayProxy/&#123;page&#125;.html&#x27;</span></span><br><span class="line">MAX_PAGE = <span class="number">5</span> * <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ZhandayeCrawler</span>(<span class="title class_ inherited__">BaseCrawler</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    zhandaye crawler, https://www.zdaye.com/dayProxy/</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    urls_catalog = [BASE_URL.<span class="built_in">format</span>(page=page) <span class="keyword">for</span> page <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, MAX_PAGE)]</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/537.36 (KHTML, &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;like Gecko) Chrome/83.0.4103.61 Safari/537.36 &#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    urls = []</span><br><span class="line">    ignore = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">crawl</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.crawl_catalog()</span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">from</span> <span class="built_in">super</span>().crawl()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">crawl_catalog</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> <span class="variable language_">self</span>.urls_catalog:</span><br><span class="line">            logger.info(<span class="string">f&#x27;fetching <span class="subst">&#123;url&#125;</span>&#x27;</span>)</span><br><span class="line">            html = <span class="variable language_">self</span>.fetch(url, headers=<span class="variable language_">self</span>.headers)</span><br><span class="line">            <span class="variable language_">self</span>.parse_catalog(html)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parse_catalog</span>(<span class="params">self, html</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        parse html file to get proxies</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        doc = pq(html)</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> doc(<span class="string">&#x27;#J_posts_list .thread_item div div p a&#x27;</span>).items():</span><br><span class="line">            url = <span class="string">&#x27;https://www.zdaye.com&#x27;</span> + item.attr(<span class="string">&#x27;href&#x27;</span>)</span><br><span class="line">            logger.info(<span class="string">f&#x27;get detail url: <span class="subst">&#123;url&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.urls.append(url)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parse</span>(<span class="params">self, html</span>):</span><br><span class="line">        doc = pq(html)</span><br><span class="line">        trs = doc(<span class="string">&#x27;.cont br&#x27;</span>).items()</span><br><span class="line">        <span class="keyword">for</span> tr <span class="keyword">in</span> trs:</span><br><span class="line">            line = tr[<span class="number">0</span>].tail</span><br><span class="line">            <span class="keyword">match</span> = re.search(<span class="string">r&#x27;(\d+\.\d+\.\d+\.\d+):(\d+)&#x27;</span>, line)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">                host = <span class="keyword">match</span>.group(<span class="number">1</span>)</span><br><span class="line">                port = <span class="keyword">match</span>.group(<span class="number">2</span>)</span><br><span class="line">                <span class="keyword">yield</span> Proxy(host=host, port=port)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    crawler = ZhandayeCrawler()</span><br><span class="line">    <span class="keyword">for</span> proxy <span class="keyword">in</span> crawler.crawl():</span><br><span class="line">        <span class="built_in">print</span>(proxy)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>spider_image_system_introduction</title>
      <link href="/2024/03/06/spider-image-system-introduction/"/>
      <url>/2024/03/06/spider-image-system-introduction/</url>
      
        <content type="html"><![CDATA[<h1>Spider Image System User Guide</h1><h2 id="Struct-design">Struct design</h2><ol><li>Spider <a href="http://pixiv.net">pixiv.net</a> img -&gt; search img -&gt; get url.</li><li>Replace domain -&gt; save url to txt.</li><li>According to url download image from txt content.</li><li>Spider gif image generate video.</li><li>Download gofile file.</li></ol><h2 id="Execute-method">Execute method</h2><ol><li>Run sis_v1.0.x.exe(windows platform).</li><li>Run ./src/run/sh/run.bat(windows platform).</li><li>Run ./src/run/sh/run.sh(linux platform).</li></ol><h2 id="Position">Position</h2><ul><li>If not visit <a href="http://pixiv.net">pixiv.net</a> website, could visit sd.2021.host or other url(example: <a href="http://sd.vv50.de">sd.vv50.de</a>) replace.</li><li>Other.</li></ul><h2 id="GUI">GUI</h2><ul><li>Pyqt5 paint main ui.</li></ul><h2 id="Technology-lib">Technology lib</h2><ol><li>selenium.</li><li>loguru.</li><li>requests.</li><li>Other(Read requirements.txt).</li></ol><h2 id="Folder">Folder</h2><ol><li>./data/href_url/ artwork url folder.</li><li>./data/img_url/ img url txt folder.</li><li>./data/*/images/ save img folder.</li><li>./data/video generate video folder.</li><li>./data/according_pid_download_image pid image download folder.</li><li>./data/face_detect_result face detect result folder.</li><li>./data/error_images error images folder.</li><li>./log_dir/ script run log folder.</li><li>Other see ./data/.</li></ol><h2 id="File">File</h2><ol><li>./data/download_final_image.json: final download image info.</li><li>./data/download_finished_txt.txt: already download keyword txt.</li><li>./data/error_image_txt.txt: download fail image save txt.</li><li>./data/spider_finished_keyword.txt: already spider finish keyword txt.</li><li>./data/spider_img_keyword_final.json: final spider keyword image json.</li></ol><h2 id="Other">Other</h2><ol><li>Self config constant val(Done).</li><li>Play all video(Done).</li><li>Autoplay all image(Done).</li><li>Auto spider image(Done).</li><li>System performance monitor(Done).</li><li>Online show image(Done).</li><li>Gif and image process(Done).</li><li>Face detect from downloaded image folder(Done).</li><li>Other small tools(Done).</li><li>Otherâ€¦(to be continuedâ€¦)</li></ol><ul><li>bugs 1 : åœ¨ç±»æ–¹æ³•ä¸­ä¸èƒ½ä½¿ç”¨@logger.catchæ³¨è§£æ–¹æ³•ï¼Œä¼šå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">File <span class="string">&quot;C:\Users\Administrator\PycharmProjects\calmcar_sf_server\src\test\gui\ui_main.py&quot;</span>, line 130, <span class="keyword">in</span> ui_paint</span></span><br><span class="line">    app.exec_()</span><br><span class="line">    â”‚   â”” &lt;built-in method exec_&gt;</span><br><span class="line">    â”” &lt;PyQt5.QtWidgets.QApplication object at 0x000002045EF19AF0&gt;</span><br><span class="line"></span><br><span class="line">TypeError: next_img() takes 1 positional argument but 3 were given</span><br></pre></td></tr></table></figure><ul><li>problem 1 on ubuntu: opencv-pythonä¸pyqt5å†²çª(é—®é¢˜è§£å†³)</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo pip3 uninstall opencv-python</span><br><span class="line">sudo pip3 install opencv-python-headless</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">QObject::moveToThread: Current thread (0x55f29a27e0e0) is not the object&#x27;s thread (0x55f29a946dd0).</span><br><span class="line">Cannot move to target thread (0x55f29a27e0e0)</span><br><span class="line"></span><br><span class="line">qt.qpa.plugin: Could not load the Qt platform plugin &quot;xcb&quot; in &quot;/usr/local/lib/python3.10/dist-packages/cv2/qt/plugins&quot; even though it was found.</span><br><span class="line">This application failed to start because no Qt platform plugin could be initialized. Reinstalling the application may fix this problem.</span><br><span class="line"></span><br><span class="line">Available platform plugins are: xcb, eglfs, linuxfb, minimal, minimalegl, offscreen, vnc, wayland-egl, wayland, wayland-xcomposite-egl, wayland-xcomposite-glx, webgl.</span><br><span class="line"></span><br><span class="line">Aborted</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>Notice: if cannot start spider image, you need install google chrome explore, detail:</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">File &quot;/usr/local/lib/python3.10/dist-packages/selenium/webdriver/chrome/webdriver.py&quot;, line 45, in __init__</span><br><span class="line">    super().__init__(</span><br><span class="line">  File &quot;/usr/local/lib/python3.10/dist-packages/selenium/webdriver/chromium/webdriver.py&quot;, line 49, in __init__</span><br><span class="line">    self.service.path = DriverFinder.get_path(self.service, options)</span><br><span class="line">    â”‚    â”‚       â”‚      â”‚            â”‚        â”‚    â”‚        â”” &lt;selenium.webdriver.chrome.options.Options object at 0x7f816cf3da20&gt;</span><br><span class="line">    â”‚    â”‚       â”‚      â”‚            â”‚        â”‚    â”” &lt;selenium.webdriver.chrome.service.Service object at 0x7f816cf3da80&gt;</span><br><span class="line">    â”‚    â”‚       â”‚      â”‚            â”‚        â”” &lt;unprintable WebDriver object&gt;</span><br><span class="line">    â”‚    â”‚       â”‚      â”‚            â”” &lt;staticmethod(&lt;function DriverFinder.get_path at 0x7f816eb9cb80&gt;)&gt;</span><br><span class="line">    â”‚    â”‚       â”‚      â”” &lt;class &#x27;selenium.webdriver.common.driver_finder.DriverFinder&#x27;&gt;</span><br><span class="line">    â”‚    â”‚       â”” &lt;property object at 0x7f816eb5ebb0&gt;</span><br><span class="line">    â”‚    â”” &lt;selenium.webdriver.chrome.service.Service object at 0x7f816cf3da80&gt;</span><br><span class="line">    â”” &lt;unprintable WebDriver object&gt;</span><br><span class="line">  File &quot;/usr/local/lib/python3.10/dist-packages/selenium/webdriver/common/driver_finder.py&quot;, line 41, in get_path</span><br><span class="line">    raise NoSuchDriverException(msg) from err</span><br><span class="line">          â”‚                     â”” &#x27;Unable to obtain driver for chrome using Selenium Manager.&#x27;</span><br><span class="line">          â”” &lt;class &#x27;selenium.common.exceptions.NoSuchDriverException&#x27;&gt;</span><br><span class="line"></span><br><span class="line">selenium.common.exceptions.NoSuchDriverException: Message: Unable to obtain driver for chrome using Selenium Manager.; For documentation on this error, please visit: https://www.selenium.dev/documentation/webdriver/troubleshooting/errors/driver_location</span><br></pre></td></tr></table></figure><p>~ For solve problem, need install follow package:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">apt install chromium-browser</span><br><span class="line">sudo mkdir -p /home/czq/.local/share/applications</span><br><span class="line">sudo touch /home/czq/.local/share/applications/mimeapps.list</span><br><span class="line">chmod -R 777 /home/czq/</span><br><span class="line">xdg-open https://www.baidu.com</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">re run ./sh/run.sh to solve the problem</span></span><br></pre></td></tr></table></figure><ul><li>For use face detect, you need run follow command on ubuntu:</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install libgtk2.0-dev pkg-config</span><br><span class="line">run ./sh/run_face_detect.sh # (on ubuntu os)</span><br></pre></td></tr></table></figure><ul><li>Install third-party libraries for project</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">recommend use</span></span><br><span class="line">pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">single lib install <span class="built_in">command</span></span></span><br><span class="line">pip install -i https://pypi.tuna.tsinghua.edu.cn/simple opencv-contrib-python</span><br></pre></td></tr></table></figure><ul><li>Build project and publish pack</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Pyinstaller main_test.spec #ä½¿ç”¨specæ–‡ä»¶æ‰“åŒ…exe</span><br></pre></td></tr></table></figure><ul><li>solve not run on HECS(HuaWei ECS) from huawei cloud</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">see</span></span><br><span class="line">https://neucrack.com/p/407</span><br></pre></td></tr></table></figure><blockquote><p>wait a moment, code will open to all people, please visit follow url download exe or source code:<br><a href="https://gitee.com/caozhaoqi/spider_image_system">https://gitee.com/caozhaoqi/spider_image_system</a></p></blockquote><h1>See</h1><ul><li><a href="https://gitee.com/caozhaoqi">https://gitee.com/caozhaoqi</a></li><li><a href="https://gitee.com/caozhaoqi/spider_image_system">https://gitee.com/caozhaoqi/spider_image_system</a></li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pythonä½¿ç”¨seleniumæ¡†æ¶åŠ¨æ€æŠ“å–æŒ‡å®šå†…å®¹</title>
      <link href="/2024/01/25/python-selenium-spider/"/>
      <url>/2024/01/25/python-selenium-spider/</url>
      
        <content type="html"><![CDATA[<h1>æŠ€æœ¯ç®€ä»‹</h1><blockquote><p>Seleniumæ˜¯ä¸€ä¸ªç”¨äºWebåº”ç”¨ç¨‹åºçš„è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶ï¼Œé€šè¿‡æ¨¡æ‹Ÿç”¨æˆ·åœ¨æµè§ˆå™¨ä¸­çš„æ“ä½œï¼Œå¦‚ç‚¹å‡»æŒ‰é’®ã€è¾“å…¥æ–‡æœ¬ç­‰ï¼Œæ¥æ‰§è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•ã€‚å®ƒæ”¯æŒå¤šç§æµè§ˆå™¨å’Œæ“ä½œç³»ç»Ÿï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡å„ç§ç¼–ç¨‹è¯­è¨€ç¼–å†™æµ‹è¯•è„šæœ¬ã€‚Seleniumçš„ä¸»è¦ç‰¹ç‚¹æ˜¯æ˜“äºä½¿ç”¨ã€çµæ´»æ€§å’Œç¨³å®šæ€§ï¼Œå› æ­¤åœ¨Webæµ‹è¯•é¢†åŸŸè¢«å¹¿æ³›ä½¿ç”¨ã€‚</p></blockquote><h1>å®‰è£…ä½¿ç”¨</h1><h2 id="å®‰è£…">å®‰è£…</h2><ul><li>pip</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install selenium</span><br></pre></td></tr></table></figure><h2 id="demo">demo</h2><ul><li>åŠ¨æ€è·å–å†…å®¹</li></ul><blockquote><p>demoä¸­çš„æ¡ˆä¾‹é€šè¿‡seleniumæ¡†æ¶ä¸­çš„ webdriver.Chrome(options=options)æ–¹æ³•è·å–google chromeå¯åŠ¨åçš„é©±åŠ¨ï¼Œé€šè¿‡æ“ä½œdriver.get(url_detail)æ–¹æ³•åŠ¨æ€è·å–å½“å‰ç½‘é¡µå†…å®¹ï¼Œé€šè¿‡ time.sleep(search_delta_time)å¢åŠ å»¶è¿Ÿä»¥ç¡®ä¿å†…å®¹åŠ è½½å®Œæˆã€‚</p></blockquote><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.common <span class="keyword">import</span> NoSuchWindowException</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"></span><br><span class="line"> <span class="comment"># è®¾ç½®ä»£ç†æœåŠ¡å™¨</span></span><br><span class="line">    proxy = &#123;</span><br><span class="line">        <span class="string">&quot;proxyType&quot;</span>: <span class="string">&quot;manual&quot;</span>,</span><br><span class="line">        <span class="string">&quot;httpProxy&quot;</span>: <span class="string">&quot;http://&quot;</span> + constants.proxy_server_ip + <span class="string">&quot;:&quot;</span> + <span class="built_in">str</span>(constants.proxy_server_port),  <span class="comment"># ä»£ç†æœåŠ¡å™¨åœ°å€å’Œç«¯å£</span></span><br><span class="line">        <span class="string">&quot;ftpProxy&quot;</span>: <span class="string">&quot;http://&quot;</span> + constants.proxy_server_ip + <span class="string">&quot;:&quot;</span> + <span class="built_in">str</span>(constants.proxy_server_port),</span><br><span class="line">        <span class="string">&quot;sslProxy&quot;</span>: <span class="string">&quot;http://&quot;</span> + constants.proxy_server_ip + <span class="string">&quot;:&quot;</span> + <span class="built_in">str</span>(constants.proxy_server_port),</span><br><span class="line">        <span class="string">&quot;noProxy&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;proxyAutoconfigUrl&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ›å»ºæµè§ˆå™¨é©±åŠ¨ç¨‹åºå¹¶è®¾ç½®ä»£ç†å‚æ•°</span></span><br><span class="line">    options = webdriver.ChromeOptions()</span><br><span class="line">    <span class="keyword">if</span> proxy_flag == <span class="string">&#x27;True&#x27;</span>:</span><br><span class="line">        options.set_capability(<span class="string">&quot;proxy&quot;</span>, proxy)</span><br><span class="line">        logger.info(<span class="string">&quot;current use internal proxy, proxy content: &quot;</span> + <span class="built_in">str</span>(proxy[<span class="string">&#x27;httpProxy&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">    driver = webdriver.Chrome(options=options)</span><br><span class="line">    mode = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    url = <span class="string">&quot;https://&quot;</span> + visit_url + <span class="string">&quot;/tags/&quot;</span> + key_word + <span class="string">&quot;/artworks?&quot;</span> + mode</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        url_detail = url_process_page(url, current_page=cur_page)</span><br><span class="line">        logger.info(<span class="string">&quot;current use url : &quot;</span> + <span class="built_in">str</span>(url_detail))</span><br><span class="line">        driver.get(url_detail)</span><br><span class="line">        <span class="comment"># ç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆ</span></span><br><span class="line">        time.sleep(search_delta_time)</span><br><span class="line">        logger.debug(<span class="string">&quot;start load href save url to txt.&quot;</span>)</span><br><span class="line">        load_save_flag = load_href_save(driver, key_word)</span><br><span class="line">        <span class="keyword">if</span> load_save_flag:</span><br><span class="line">            <span class="comment"># ä½¿ç”¨å‡½æ•°</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                save_img_url(driver, key_word)</span><br><span class="line">                cur_page += <span class="number">1</span></span><br><span class="line">                logger.success(<span class="string">&quot;save img all finishï¼Œcurrent page:  &quot;</span> + <span class="built_in">str</span>(cur_page))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">except</span> NoSuchWindowException <span class="keyword">as</span> nswe:</span><br><span class="line">                logger.warning(<span class="string">&quot;chrome force exit! detail:&quot;</span> + <span class="built_in">str</span>(nswe))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="comment"># å¾ªç¯æŠ“å–ç»“æŸ æ–­æ‰æµè§ˆå™¨ é‡ç½®æ ‡å¿—ä½ã€</span></span><br><span class="line">    <span class="variable language_">self</span>.success_tips()</span><br><span class="line">    constants.spider_image_flag = <span class="literal">False</span></span><br><span class="line">    logger.warning(<span class="string">&quot;google chrome will exit! &quot;</span>)</span><br><span class="line">    driver.quit()</span><br></pre></td></tr></table></figure><ul><li>è¿‡æ»¤ç­›é€‰æ•°æ®</li></ul><blockquote><p>ä¸‹æ–¹ä»£ç é€šè¿‡driver.find_elements(By.CSS_SELECTOR, â€œaâ€)è·å–æŒ‡å®šhtmlå…ƒç´ å€¼ï¼Œå¹¶å­˜å‚¨å€¼åˆ—è¡¨ï¼ŒåæœŸå¯å¯¹åˆ—è¡¨æ•°æ®è¿›è¡Œç­›é€‰ï¼Œä»¥æ­¤å®Œæˆç›®æ ‡æ•°æ®çš„åŠ¨æ€æŠ“å–</p></blockquote><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">load_href_save</span>(<span class="params">driver, key_word</span>):</span><br><span class="line">    image_urls_list = []</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        image_elements = driver.find_elements(By.CSS_SELECTOR, <span class="string">&quot;a&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> image_element <span class="keyword">in</span> image_elements:</span><br><span class="line">            driver.execute_script(<span class="string">&quot;return arguments[0].href;&quot;</span>, image_element)</span><br><span class="line">            image_urls_list.append(image_url)</span><br><span class="line">            logger.debug(<span class="string">&quot;load href and start save img url: &quot;</span> + image_url)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> un_e:</span><br><span class="line">        logger.error(<span class="string">&quot;Error, unknown error, detail:&quot;</span> + <span class="built_in">str</span>(un_e))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pythonå¤šè„šæœ¬çš„é›†æˆåŒ–ç®¡ç†ï¼ˆå¾®æœåŠ¡ï¼ŒNginxï¼‰</title>
      <link href="/2023/12/29/micro-service-py/"/>
      <url>/2023/12/29/micro-service-py/</url>
      
        <content type="html"><![CDATA[<h1>åŸºæœ¬æ€æƒ³</h1><blockquote><p>é€šè¿‡å¾®æœåŠ¡ã€æˆ–nginxé€šè¿‡æŸç§æ–¹å¼é›†æˆç®¡ç†å„ä¸ªåˆ†æ•£pythonè„šæœ¬</p></blockquote><h2 id="æŠ€æœ¯è·¯çº¿">æŠ€æœ¯è·¯çº¿</h2><h3 id="Nginxä»£ç†è½¬å‘">Nginxä»£ç†è½¬å‘</h3><blockquote><p>é€šè¿‡é…ç½®è„šæœ¬å¾®æœåŠ¡webåŠŸèƒ½ï¼Œé€šè¿‡nginxè½¬å‘APIã€‚åœ¨æ­¤ä¹‹å‰éœ€è¦æ‰‹åŠ¨ç¼–å†™è„šæœ¬webåŠŸèƒ½å’ŒAPIæ¥å£ã€‚</p></blockquote><h3 id="nginx-é…ç½®æ–‡ä»¶ç¼–å†™">nginx é…ç½®æ–‡ä»¶ç¼–å†™</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">   #å¯¹å¤–ç›‘å¬ç«¯å£</span><br><span class="line">       listen       9001;</span><br><span class="line">       #ä¸»æœºåç§°</span><br><span class="line">       server_name  localhost;   </span><br><span class="line">       #è§„åˆ™ï¼šå½“è¯·æ±‚è·¯å¾„åŒ…å«â€˜eduserviceâ€™çš„æ—¶å€™è½¬å‘åˆ°â€œhttp://loclahost:8001â€</span><br><span class="line">       # ~ ä»£è¡¨æ­£åˆ™åŒ¹é…ï¼Œä¸åŠ ~ åˆ™ä¸ºå®Œå…¨åŒ¹é…æ‰èƒ½æ‰§è¡Œ</span><br><span class="line">       #è¯·æ±‚è·¯å¾„</span><br><span class="line">       location ~ /eduservice/ &#123;</span><br><span class="line">       #è½¬å‘åœ°å€</span><br><span class="line">       proxy_pass http://localhost:8001;</span><br><span class="line">       &#125;</span><br><span class="line">       #è§„åˆ™ï¼šå½“è¯·æ±‚è·¯å¾„åŒ…å«â€˜eduossâ€™çš„æ—¶å€™è½¬å‘åˆ°â€œhttp://loclahost:8002â€</span><br><span class="line">       location ~ /eduoss/ &#123;</span><br><span class="line">       proxy_pass http://localhost:8002;</span><br><span class="line">       &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h3 id="åŸpyæ–‡ä»¶æ”¹é€ ">åŸpyæ–‡ä»¶æ”¹é€ </h3><h4 id="ä¸»pyæ–‡ä»¶ç¼–å†™">ä¸»pyæ–‡ä»¶ç¼–å†™</h4><ul><li><a href="http://main.py">main.py</a></li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># from flask import Flask</span></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> nameko.standalone.rpc <span class="keyword">import</span> ClusterRpcProxy</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> app.http_server.log.log_base <span class="keyword">import</span> LOG_DIR</span><br><span class="line"><span class="keyword">from</span> app.http_server.log.log_config <span class="keyword">import</span> InterceptHandler, format_record</span><br><span class="line"><span class="keyword">from</span> app.http_server.router.router <span class="keyword">import</span> api_router</span><br><span class="line"><span class="keyword">from</span> app.run.constant <span class="keyword">import</span> app_port, log_man_input_path, log_man_out_path, publish_date, build_date, py_server_version</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init_app</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    APP init : log router ...</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># fast api app å¯åŠ¨é¡¹é…ç½®ä¸å¯åŠ¨</span></span><br><span class="line">    app = FastAPI(title=<span class="string">&quot;CTS Log Reporter&quot;</span>, version=<span class="string">&quot;0.0.1&quot;</span>,</span><br><span class="line">                  description=<span class="string">&quot;Calmcar Tools System: Log analysis and reporter platform&quot;</span>, debug=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># è·¯ç”±å¼•å…¥</span></span><br><span class="line">    app.include_router(router=api_router, prefix=<span class="string">&quot;/api/v1&quot;</span>)</span><br><span class="line">    <span class="comment"># æ—¥å¿—é…ç½®ä¸æ•è·</span></span><br><span class="line">    logging.getLogger().handlers = [InterceptHandler()]</span><br><span class="line">    logger.configure(</span><br><span class="line">        handlers=[&#123;<span class="string">&quot;sink&quot;</span>: sys.stdout, <span class="string">&quot;level&quot;</span>: logging.DEBUG, <span class="string">&quot;format&quot;</span>: format_record&#125;])</span><br><span class="line">    logger.add(LOG_DIR, encoding=<span class="string">&#x27;utf-8&#x27;</span>, rotation=<span class="string">&quot;12:00&quot;</span>)</span><br><span class="line">    logger.debug(<span class="string">&#x27;æ—¥å¿—ç³»ç»Ÿå·²åŠ è½½... å½“å‰æ—¥å¿—æ‰€åœ¨ç›®å½•ï¼š&#x27;</span> + LOG_DIR)</span><br><span class="line">    logging.getLogger(<span class="string">&quot;uvicorn.access&quot;</span>).handlers = [InterceptHandler()]</span><br><span class="line">    <span class="keyword">return</span> app</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = init_app()</span><br><span class="line"><span class="comment"># MQé…ç½®</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(app=<span class="string">&#x27;main:app&#x27;</span>, host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=app_port, reload=<span class="literal">True</span>, workers=<span class="number">4</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="APIè·¯ç”±å®šä¹‰">APIè·¯ç”±å®šä¹‰</h4><ul><li><a href="http://router.py">router.py</a></li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> APIRouter</span><br><span class="line"><span class="keyword">from</span> app.http_server.view <span class="keyword">import</span> log_process</span><br><span class="line"></span><br><span class="line">api_router = APIRouter()</span><br><span class="line"><span class="comment"># æ¨¡å—è·¯ç”±é…ç½®</span></span><br><span class="line">api_router.include_router(log_process.router, prefix=<span class="string">&quot;/shell&quot;</span>, tags=[<span class="string">&#x27;è„šæœ¬æ“ä½œ&#x27;</span>])</span><br></pre></td></tr></table></figure><h4 id="API-æ¥å£å®šä¹‰">API æ¥å£å®šä¹‰</h4><ul><li>api_manage.py</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> APIRouter</span><br><span class="line"><span class="keyword">from</span> nameko.standalone.rpc <span class="keyword">import</span> ClusterRpcProxy</span><br><span class="line"></span><br><span class="line">config_mq = &#123;<span class="string">&#x27;AMQP_URI&#x27;</span>: <span class="string">&quot;amqp://guest:guest@192.168.163.129:5672&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router = APIRouter()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@router.get(<span class="params"><span class="string">&#x27;/hello_world&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">call_service</span>():</span><br><span class="line">    <span class="keyword">with</span> ClusterRpcProxy(config_mq) <span class="keyword">as</span> rpc:</span><br><span class="line">        <span class="comment"># æ¶ˆè´¹è€…è°ƒç”¨å¾®æœåŠ¡(ç”Ÿäº§è€…)ï¼Œè·å–æœåŠ¡ï¼ˆç”Ÿäº§è€…ï¼‰çš„è¿”å›å€¼</span></span><br><span class="line">        result = rpc.generate_service.hello_world(msg=<span class="string">&quot;xag msg&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¿”å›ç»“æœ</span></span><br><span class="line">        <span class="keyword">return</span> result, <span class="number">200</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="å¾®æœåŠ¡ç½‘å…³è½¬å‘">å¾®æœåŠ¡ç½‘å…³è½¬å‘</h2><blockquote><p>å¦‚å›¾ï¼šä»£ç†ç½‘å…³è½¬å‘æ¥è‡ªwebå‰ç«¯è¯·æ±‚ï¼Œå¹¶æ ¹æ®apiè½¬å‘å¯¹åº”å¾®æœåŠ¡è„šæœ¬ã€‚Gatewayä¸å¾®æœåŠ¡ä¹‹é—´é‡‡ç”¨gRPCï¼Œå¾®æœåŠ¡ä¹‹é—´é‡‡ç”¨httpï¼ˆREST APIï¼‰é€šä¿¡ã€‚</p></blockquote><p><img src="/2023/12/29/micro-service-py/struct_py.png" class="lazyload placeholder" data-srcset="/2023/12/29/micro-service-py/struct_py.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h3 id="nameko">nameko</h3><p><img src="/2023/12/29/micro-service-py/rabbitmq_struct.png" class="lazyload placeholder" data-srcset="/2023/12/29/micro-service-py/rabbitmq_struct.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><blockquote><p>Namekoæ¡†æ¶é‡‡ç”¨ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ã€‚</p></blockquote><h4 id="æ­å»ºnamekoæ¡†æ¶">æ­å»ºnamekoæ¡†æ¶</h4> <figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install nameko</span><br></pre></td></tr></table></figure><h4 id="æ„å»ºç”Ÿäº§è€…æœåŠ¡">æ„å»ºç”Ÿäº§è€…æœåŠ¡</h4> <figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># producer_service.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> nameko.rpc <span class="keyword">import</span> rpc</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GenerateService</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="comment"># å®šä¹‰å¾®æœåŠ¡åç§° æ­¤å¤„è°ƒç”¨æŒ‡å®šè„šæœ¬</span></span><br><span class="line">    name = <span class="string">&quot;generate_service&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @rpc</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">hello_world</span>(<span class="params">self, msg</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;hello,i am been called by customerï¼ˆæ¶ˆè´¹è€…ï¼‰,è¿”å›æ¶ˆæ¯ï¼š&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(msg))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¿”å›ç»“æœ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello World!I Am a msg from producer!&quot;</span></span><br></pre></td></tr></table></figure><h4 id="é€šè¿‡rabbitmqæ³¨å†Œå¾®æœåŠ¡">é€šè¿‡rabbitmqæ³¨å†Œå¾®æœåŠ¡</h4> <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ³¨å†ŒæœåŠ¡</span></span><br><span class="line"><span class="comment"># producer_serviceï¼šç›®æ ‡æ–‡ä»¶</span></span><br><span class="line"><span class="comment"># admin:adminï¼šMQç”¨æˆ·ååŠå¯†ç </span></span><br><span class="line"><span class="comment"># ipåœ°å€:5672ï¼šMQæœåŠ¡å™¨ipåœ°å€åŠåº”ç”¨ç«¯å£å·</span></span><br><span class="line"><span class="comment"># my_vhostï¼šè™šæ‹Ÿæœºå</span></span><br><span class="line">nameko run producer_service --broker amqp://admin:admin@ipåœ°å€:5672/my_vhost</span><br></pre></td></tr></table></figure><h4 id="æ¶ˆè´¹è€…è°ƒç”¨è„šæœ¬å¾®æœåŠ¡">æ¶ˆè´¹è€…è°ƒç”¨è„šæœ¬å¾®æœåŠ¡</h4> <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">config_mq = &#123;<span class="string">&#x27;AMQP_URI&#x27;</span>: <span class="string">&quot;amqp://guest:guest@192.168.163.129:5672&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router = APIRouter()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@router.get(<span class="string">&#x27;/hello_world&#x27;</span>)</span><br><span class="line">def call_service():</span><br><span class="line">    with ClusterRpcProxy(config_mq) as rpc:</span><br><span class="line">        <span class="comment"># æ¶ˆè´¹è€…è°ƒç”¨å¾®æœåŠ¡(ç”Ÿäº§è€…)ï¼Œè·å–æœåŠ¡ï¼ˆç”Ÿäº§è€…ï¼‰çš„è¿”å›å€¼</span></span><br><span class="line">        result = rpc.generate_service.hello_world(msg=<span class="string">&quot;xag msg&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¿”å›ç»“æœ</span></span><br><span class="line">        <span class="built_in">return</span> result, 200</span><br></pre></td></tr></table></figure><h4 id="ç”Ÿäº§è€…æœåŠ¡å¯åŠ¨æ–¹å¼">ç”Ÿäº§è€…æœåŠ¡å¯åŠ¨æ–¹å¼</h4><ul><li>å‘½ä»¤è¡Œå¯åŠ¨</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nameko run generate_service --broker amqp://guest:guest@192.168.163.129:5672/</span><br></pre></td></tr></table></figure><ul><li>é…ç½®æ–‡ä»¶å¯åŠ¨</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># config.yml</span></span><br><span class="line"><span class="attr">AMQP_URI:</span> <span class="string">&#x27;pyamqp://guest:guest@localhost&#x27;</span></span><br><span class="line"><span class="attr">WEB_SERVER_ADDRESS:</span> <span class="string">&#x27;0.0.0.0:8000&#x27;</span></span><br><span class="line"><span class="attr">rpc_exchange:</span> <span class="string">&#x27;nameko-rpc&#x27;</span></span><br><span class="line"><span class="attr">max_workers:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">parent_calls_tracked:</span> <span class="number">10</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">LOGGING:</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">handlers:</span></span><br><span class="line">        <span class="attr">console:</span></span><br><span class="line">            <span class="attr">class:</span> <span class="string">logging.StreamHandler</span></span><br><span class="line">    <span class="attr">root:</span></span><br><span class="line">        <span class="attr">level:</span> <span class="string">DEBUG</span></span><br><span class="line">        <span class="attr">handlers:</span> [<span class="string">console</span>]</span><br><span class="line"><span class="comment"># å¯åŠ¨å‘½ä»¤è¡Œï¼š</span></span><br><span class="line"><span class="comment"># nameko run --config config.yml service1</span></span><br></pre></td></tr></table></figure><ul><li>ç»“æœç¤ºä¾‹ï¼š</li></ul><blockquote><p>è°ƒç”¨è€…<br><img src="/2023/12/29/micro-service-py/result-nginx.png" class="lazyload placeholder" data-srcset="/2023/12/29/micro-service-py/result-nginx.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"><br>è¢«è°ƒç”¨è€…<br><img src="/2023/12/29/micro-service-py/result-pro.png" class="lazyload placeholder" data-srcset="/2023/12/29/micro-service-py/result-pro.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p></blockquote><h4 id="åŸwebæœåŠ¡æ”¹é€ ">åŸwebæœåŠ¡æ”¹é€ </h4><blockquote><p>å°†APIè¿ç§»è‡³æ¶ˆè´¹è€…ä¸­ï¼Œä»…ä¿ç•™å…·ä½“æ‰§è¡Œæ–¹æ³•ï¼›å®‰è£…namekoï¼Œç¼–å†™ç”Ÿäº§è€…é€šè¿‡rpcè°ƒç”¨çš„æ–¹æ³•ã€‚</p></blockquote><h3 id="rabbitmqæœåŠ¡æ„å»º">rabbitmqæœåŠ¡æ„å»º</h3><h4 id="æ„å»ºdockerå®¹å™¨">æ„å»ºdockerå®¹å™¨</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull rabbitmq</span><br><span class="line">docker run -d --hostname localhost --name rabbitmq -p 15672:15672 -p 5672:5672 rabbitmq:management</span><br></pre></td></tr></table></figure><h4 id="webé¡µé¢ç®¡ç†">webé¡µé¢ç®¡ç†</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker ps </span><br><span class="line">docker <span class="built_in">exec</span> -it contain ID /bin/bash</span><br><span class="line">rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management</span><br></pre></td></tr></table></figure><h2 id="Bali">Bali</h2><blockquote><p>Bali is a framework integrate FastAPI and gRPC. If you want to provide both HTTP and RPC, it can improve development efficiency.<br>ä¸šåŠ¡ä»£ç åˆ†å¸ƒä¸ºåœ¨ä¸¤ä¸ªå±‚æ¬¡ï¼šModel å±‚å’Œ Resource å±‚ã€‚Model å±‚æ˜¯ä¸€ä¸ª Fat Model æ¨¡å‹ï¼Œé™¤äº†å­—æ®µå®šä¹‰ï¼Œè¿˜æœ‰ä¸ Model ç›¸å…³çš„ä¸€äº›é€»è¾‘ï¼›Resource å±‚æä¾›åŒæ—¶å…¼å®¹ HTTP/RPC çš„èµ„æºæœåŠ¡ã€‚éµå¾ª RESTful åŠ gRPC çš„å¼€å‘æŒ‡å—å®šä¹‰äº†å‡ ä¸ªæ ‡å‡†æ–¹æ³•ã€‚</p></blockquote><h3 id="install">install</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Bali framework</span></span><br><span class="line">pip install bali-core </span><br><span class="line"></span><br><span class="line"><span class="comment"># Bali command line tool </span></span><br><span class="line">pip install bali-cli </span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="application-create">application create</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> greeter_server</span><br><span class="line"></span><br><span class="line"><span class="comment"># Initialized App </span></span><br><span class="line">app = Bali()</span><br><span class="line"><span class="comment"># Updated settings</span></span><br><span class="line">app.settings(base_settings=&#123;<span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;Bali App&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure><h3 id="app-start">app start</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># With bali-cli </span></span><br><span class="line">bali run http</span><br><span class="line">bali run rpc</span><br><span class="line">bali run event</span><br><span class="line"></span><br><span class="line">python main.py run --http  <span class="comment"># launch HTTP in development mode </span></span><br><span class="line">python main.py run --rpc  <span class="comment"># launch RPC </span></span><br><span class="line">python main.py run --event  <span class="comment"># launch Event </span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="test-demo">test demo</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">åˆ›å»ºgRPC æµ‹è¯•ä»£ç </span><br><span class="line"><span class="keyword">from</span> bali.tests <span class="keyword">import</span> GRPCTestBase</span><br><span class="line"><span class="keyword">from</span> service.demo <span class="keyword">import</span> demo_service, demo_pb2, demo_pb2_grpc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestDemoRPC</span>(<span class="title class_ inherited__">GRPCTestBase</span>):</span><br><span class="line">    server_class = demo_service.DemoService  <span class="comment"># Provided service </span></span><br><span class="line"></span><br><span class="line">    pb2 = demo_pb2  <span class="comment"># Provided pb2</span></span><br><span class="line">    pb2_grpc = demo_pb2_grpc  <span class="comment"># Provided pb2 grpc</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setup_method</span>(<span class="params">self</span>):  <span class="comment"># Pytest setup </span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">teardown_method</span>(<span class="params">self</span>):  <span class="comment"># Pytest teardown</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_demo</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h1>See</h1><ul><li>1.<a href="https://segmentfault.com/a/1190000041230541">https://segmentfault.com/a/1190000041230541</a></li><li>2.<a href="https://github.com/nameko/nameko">https://github.com/nameko/nameko</a></li><li>3.<a href="https://github.com/bali-framework/bali">https://github.com/bali-framework/bali</a></li><li>4.<a href="https://bali-framework.github.io/bali/">https://bali-framework.github.io/bali/</a></li><li>5.<a href="https://www.jianshu.com/p/1979844c6bee">https://www.jianshu.com/p/1979844c6bee</a></li><li>6.<a href="https://www.oschina.net/p/bali">https://www.oschina.net/p/bali</a></li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SMBå…±äº«æœåŠ¡pythonè„šæœ¬æ“ä½œæ–‡ä»¶ä¸Šä¼ ä¸‹è½½</title>
      <link href="/2023/12/29/smb-py-operation/"/>
      <url>/2023/12/29/smb-py-operation/</url>
      
        <content type="html"><![CDATA[<h1>ç®€ä»‹</h1><blockquote><p>NASï¼ˆNetwork Attached Storageï¼šç½‘ç»œé™„å±å­˜å‚¨ï¼‰ï¼Œè¿æ¥åœ¨ç½‘ç»œä¸Šï¼Œå…·å¤‡èµ„æ–™å­˜å‚¨åŠŸèƒ½çš„è£…ç½®ï¼Œå› æ­¤ä¹Ÿç§°ä¸ºâ€œç½‘ç»œå­˜å‚¨å™¨â€ã€‚å®ƒæ˜¯ä¸€ç§ä¸“ç”¨æ•°æ®å­˜å‚¨æœåŠ¡å™¨ã€‚<br>NASè®¾å¤‡ä¸€èˆ¬æ”¯æŒå¤šè®¡ç®—æœºå¹³å°ï¼Œç”¨æˆ·é€šè¿‡ç½‘ç»œæ”¯æŒåè®®å¯è¿›å…¥ç›¸åŒçš„æ–‡æ¡£ï¼Œå› è€ŒNASè®¾å¤‡æ— éœ€æ”¹é€ å³å¯ç”¨äºæ··åˆUnix/Windows NTå±€åŸŸç½‘å†…ã€‚<br>NASæœ¬èº«èƒ½å¤Ÿæ”¯æŒå¤šç§åè®®ï¼ˆå¦‚ NFSã€ CIFSã€ FTPã€ HTTPç­‰ï¼‰ï¼Œè€Œä¸”èƒ½å¤Ÿæ”¯æŒå„ç§æ“ä½œç³»ç»Ÿã€‚é€šè¿‡ä»»ä½•ä¸€å°å·¥ä½œç«™ï¼Œé‡‡ç”¨ IEæˆ– Netscapeæµè§ˆå™¨å°±å¯ä»¥å¯¹NASè®¾å¤‡è¿›è¡Œç›´è§‚æ–¹ä¾¿çš„ç®¡ç†ã€‚<br>SMBæ˜¯ä¸€ä¸ªåè®®åï¼Œå…¨ç§°æ˜¯Server Message Blockï¼ˆæœåŠ¡å™¨æ¶ˆæ¯å¿«åè®®ï¼‰ï¼Œç”¨äºåœ¨è®¡ç®—æœºé—´å…±äº«æ–‡ä»¶ã€æ‰“å°æœºã€ä¸²å£ç­‰ï¼Œç”µè„‘ä¸Šçš„ç½‘ä¸Šé‚»å±…ç”±å®ƒå®ç°ã€‚ç«¯å£445</p></blockquote><ul><li>windows</li></ul><blockquote><p>æ–‡ä»¶å…±äº«æ˜¯æŒ‡ä¸»åŠ¨åœ°åœ¨ç½‘ç»œä¸Šå…±äº«è‡ªå·±çš„è®¡ç®—æœºæ–‡ä»¶ã€‚ä¸€èˆ¬æ–‡ä»¶å…±äº«ä½¿ç”¨P2Pæ¨¡å¼ï¼Œæ–‡ä»¶æœ¬èº«å­˜åœ¨ç”¨æˆ·æœ¬äººçš„ä¸ªäººç”µè„‘ä¸Šã€‚å¤§å¤šæ•°å‚åŠ æ–‡ä»¶å…±äº«çš„äººä¹ŸåŒæ—¶ä¸‹è½½å…¶ä»–ç”¨æˆ·æä¾›çš„å…±äº«æ–‡ä»¶ã€‚æœ‰æ—¶è¿™ä¸¤ä¸ªè¡ŒåŠ¨æ˜¯è¿åœ¨ä¸€èµ·çš„ã€‚åœ¨å¾ˆæ—©æœŸçš„windowsä¸­(windows2000ä»¥ä¸‹)ï¼Œæ–‡ä»¶å…±äº«æœåŠ¡æ˜¯åˆ©ç”¨TCPçš„139ç«¯å£å®ç°çš„ï¼ŒæœåŠ¡åæ˜¯SMBã€‚åæ¥ï¼Œå¾®è½¯åˆæŠŠSMBæ”¹åä¸ºCIFSåè®®ï¼Œå¹¶ä¸”ä½¿ç”¨çš„æ˜¯TCPçš„445ç«¯å£</p></blockquote><h2 id="pyç¬¬ä¸‰æ–¹åº“">pyç¬¬ä¸‰æ–¹åº“</h2><ul><li>pysmbåŒ…ä¸‹è½½</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip install pysmb</span><br><span class="line"><span class="comment"># æˆ–</span></span><br><span class="line">pip3 install pysmb</span><br></pre></td></tr></table></figure><h2 id="å…±äº«æ–‡ä»¶æŒ‚è½½">å…±äº«æ–‡ä»¶æŒ‚è½½</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net use k:  \\10.96.10.59\c$ </span><br></pre></td></tr></table></figure><ul><li>å¸¸ç”¨å‘½ä»¤</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">net share ipc$    /delete               å…³é—­ipcé»˜è®¤å…±äº«</span><br><span class="line">â€¢net share admin$  /delete          å…³é—­adminè´¦æˆ·ç›®å½•å…±äº«</span><br><span class="line">â€¢net share  c$ /delete                   å…³é—­cç›˜é»˜è®¤å…±äº«</span><br><span class="line">â€¢net share  d$ /delete                   å…³é—­dç›˜é»˜è®¤å…±äº«</span><br></pre></td></tr></table></figure><h1>æ¡ˆä¾‹</h1><h2 id="smbæœåŠ¡é…ç½®">smbæœåŠ¡é…ç½®</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> smb.SMBConnection <span class="keyword">import</span> SMBConnection</span><br><span class="line">host=<span class="string">&quot;xxx.xxx.xxx.xxx&quot;</span>  <span class="comment">#ipæˆ–åŸŸåï¼Œæ”¹æˆä½ è‡ªå·±çš„</span></span><br><span class="line">username=<span class="string">&quot;xxxxxx&quot;</span> <span class="comment">#ç”¨æˆ·åï¼Œæ”¹æˆä½ è‡ªå·±çš„</span></span><br><span class="line">password=<span class="string">&quot;xxxxxx&quot;</span> <span class="comment">#å¯†ç ï¼Œæ”¹æˆä½ è‡ªå·±çš„</span></span><br><span class="line">conn=SMBConnection(username,password,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,use_ntlm_v2 = <span class="literal">True</span>)</span><br><span class="line">result = conn.connect(host, <span class="number">445</span>) <span class="comment">#smbåè®®é»˜è®¤ç«¯å£445</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ç™»å½•æˆåŠŸ&quot;</span>)</span><br></pre></td></tr></table></figure><h2 id="smbæœåŠ¡è¿æ¥ä¸æ–‡ä»¶ä¸Šä¼ ä¸‹è½½">smbæœåŠ¡è¿æ¥ä¸æ–‡ä»¶ä¸Šä¼ ä¸‹è½½</h2><ul><li>ä¸Šä¼ </li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">localFile=<span class="built_in">open</span>(<span class="string">&quot;æœ¬åœ°æ–‡ä»¶è·¯å¾„&quot;</span>,<span class="string">&quot;rb&quot;</span>) </span><br><span class="line"><span class="comment">#rbä»£è¡¨read+binaryæ¨¡å¼ï¼Œå³â€œè¯»äºŒè¿›åˆ¶æ–‡ä»¶â€</span></span><br><span class="line"><span class="comment">#æ‰“å¼€æœ¬åœ°æ–‡ä»¶ï¼Œæ³¨æ„å¦‚æœæ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ¯”å¦‚zipåŒ…ï¼Œéœ€è¦åŠ ä¸Šå‚æ•°bï¼Œå³binaryæ¨¡å¼ï¼Œé»˜è®¤æ˜¯tæ¨¡å¼ï¼Œå³textæ–‡æœ¬æ¨¡å¼ã€‚</span></span><br><span class="line"><span class="comment">#ç¤ºä¾‹ï¼šlocalFile=open(&quot;/Users/devnn/Desktop/test.zip&quot;,&quot;rb&quot;) </span></span><br><span class="line"></span><br><span class="line">conn.storeFile(<span class="string">&quot;å…±äº«æ–‡ä»¶å¤¹åç§°&quot;</span>,<span class="string">&quot;å­˜æ”¾è·¯å¾„&quot;</span>,localFile) </span><br><span class="line"><span class="comment">#â€œå…±äº«æ–‡ä»¶å¤¹åç§°â€æ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œå³ä½ ä½¿ç”¨smbå…±äº«çš„é‚£ä¸ªæ–‡ä»¶å¤¹ã€‚â€œå­˜æ”¾è·¯å¾„â€æ˜¯ç›¸å¯¹å…±äº«æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶ã€‚</span></span><br><span class="line"><span class="comment">#ä¸Šä¼ æ–‡ä»¶åˆ°smbæœåŠ¡å™¨,é»˜è®¤è¶…æ—¶30ç§’ï¼Œå¯ä»¥æ·»åŠ å‚æ•°ä¿®æ”¹:timeout=xxã€‚</span></span><br><span class="line"><span class="comment">#ç¤ºä¾‹ï¼šconn.storeFile(&quot;test&quot;,&quot;test1/test2/test3.zip&quot;,localFile) </span></span><br><span class="line"></span><br><span class="line">localFile.close() </span><br><span class="line"><span class="comment">#å…³é—­</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ä¸Šä¼ æˆåŠŸ&quot;</span>)</span><br></pre></td></tr></table></figure><ul><li>ä¸‹è½½</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">localFile=<span class="built_in">open</span>(<span class="string">&quot;ä¸‹è½½åçš„æ–‡ä»¶è·¯å¾„&quot;</span>,<span class="string">&quot;wb&quot;</span>) </span><br><span class="line"><span class="comment">#åˆ›å»ºæœ¬åœ°æ–‡ä»¶ï¼Œæ³¨æ„æ˜¯ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ¯”å¦‚zipåŒ…ï¼Œéœ€è¦åŠ ä¸Šå‚æ•°bï¼Œå³binaryæ¨¡å¼ï¼Œé»˜è®¤æ˜¯tæ¨¡å¼ï¼Œå³textæ–‡æœ¬æ¨¡å¼ã€‚</span></span><br><span class="line"><span class="comment">#ç¤ºä¾‹ï¼šlocalFile=open(&quot;/Users/devnn/Desktop/test.zip&quot;,&quot;wb&quot;) </span></span><br><span class="line"></span><br><span class="line">conn.retrieveFile(<span class="string">&quot;å…±äº«æ–‡ä»¶å¤¹åç§°&quot;</span>,<span class="string">&quot;æ–‡ä»¶æ‰€åœ¨è·¯å¾„&quot;</span>,localFile) </span><br><span class="line"><span class="comment">#ä»smbæœåŠ¡å™¨ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°,é»˜è®¤è¶…æ—¶30ç§’ï¼Œå¯ä»¥ä¿®æ”¹:timeout=xxã€‚â€œæ–‡ä»¶æ‰€åœ¨è·¯å¾„â€æ˜¯ç›¸å¯¹å…±äº«æ–‡ä»¶å¤¹çš„è·¯å¾„ï¼Œä¸éœ€è¦åŠ &quot;/&quot;.</span></span><br><span class="line"><span class="comment">#ç¤ºä¾‹ï¼šconn.retrieveFile(&quot;test&quot;,&quot;test1/test2/test3.zip&quot;,localFile)</span></span><br><span class="line"></span><br><span class="line">localFile.close() </span><br><span class="line"><span class="comment">#å…³é—­</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ä¸‹è½½æˆåŠŸ&quot;</span>)</span><br></pre></td></tr></table></figure><h2 id="ç¤ºä¾‹å¦‚ä¸‹ï¼š">ç¤ºä¾‹å¦‚ä¸‹ï¼š</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">host = <span class="string">&quot;2.2.2.2&quot;</span>  <span class="comment"># ipæˆ–åŸŸåï¼Œæ”¹æˆä½ è‡ªå·±çš„</span></span><br><span class="line">username = <span class="string">&quot;root&quot;</span>  <span class="comment"># ç”¨æˆ·åï¼Œæ”¹æˆä½ è‡ªå·±çš„</span></span><br><span class="line">password = <span class="string">&quot;123134&quot;</span>  <span class="comment"># å¯†ç ï¼Œæ”¹æˆä½ è‡ªå·±çš„</span></span><br><span class="line">my_name = <span class="string">&quot;&quot;</span>  <span class="comment"># è¿™ä¸ªéšä¾¿ï¼Œå¯ä»¥ä¸ºç©ºå­—ç¬¦ä¸²</span></span><br><span class="line">remote_name = <span class="string">&quot;&quot;</span>  <span class="comment"># è¿™ä¸ªæ˜¯å…±äº«ä¸»æœºçš„ä¸»æœºåï¼ŒlistSharesä¼šç”¨åˆ°ï¼Œä¸ç”¨listSharesçš„è¯å¯ä»¥ä¸ºç©ºå­—ç¬¦ä¸²</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_file_smb_server</span>(<span class="params">tad4_mf4_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param tad4_mf4_path:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># path_list = []</span></span><br><span class="line">    <span class="comment"># comment_list = []</span></span><br><span class="line">    <span class="comment"># file_name_list = []</span></span><br><span class="line">    root_path = <span class="string">r&quot;C:\Users\Administrator\Desktop\t\demo\test\mdf&quot;</span></span><br><span class="line">    <span class="comment"># for share in conn.listShares():</span></span><br><span class="line">    <span class="comment">#     logger.info(share.name)</span></span><br><span class="line">    (file_path, file_name) = os.path.split(tad4_mf4_path)</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(root_path + <span class="string">&quot;\\&quot;</span> + file_name):</span><br><span class="line">        logger.warning(<span class="string">&quot;file exists , skip download file&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> root_path + <span class="string">&quot;\\&quot;</span> + file_name</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        conn = SMBConnection(username, password, my_name, remote_name, is_direct_tcp=<span class="literal">True</span>)</span><br><span class="line">        result = conn.connect(host, <span class="number">445</span>)  <span class="comment"># smbåè®®é»˜è®¤ç«¯å£445</span></span><br><span class="line">        logger.success(<span class="string">&quot;login ntfs smb server success !&quot;</span>, result)</span><br><span class="line">        logger.info(<span class="string">&quot; download file .&quot;</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(root_path + <span class="string">&quot;\\&quot;</span> + file_name, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> fw:</span><br><span class="line">            conn.retrieveFile(<span class="string">&quot;shared&quot;</span>, tad4_mf4_path, fw)</span><br><span class="line">        <span class="keyword">return</span> root_path + <span class="string">&quot;\\&quot;</span> + file_name</span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäºCLion IDEçš„CPPé¡¹ç›®æ„å»ºä¸è¿è¡Œ</title>
      <link href="/2023/12/01/cpp-project-build-clion/"/>
      <url>/2023/12/01/cpp-project-build-clion/</url>
      
        <content type="html"><![CDATA[<h1>åŸºäºClion IDEçš„CPPé¡¹ç›®æ„å»ºä¸è¿è¡Œ</h1><h2 id="å·¥å…·åŸºæœ¬ä¿¡æ¯">å·¥å…·åŸºæœ¬ä¿¡æ¯</h2><h3 id="1-CLion">1.CLion</h3><blockquote><p>CLion:<br>A cross-platform IDE for C and C++<br>CLion takes a lot of the toil out of C++, allowing me to concentrate on the interesting part: problem solving.</p></blockquote><ul><li>ä¸‹è½½åœ°å€</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.jetbrains.com/clion/download/#section=windows</span><br></pre></td></tr></table></figure><h3 id="2-MingW">2.MingW</h3><blockquote><p>A complete runtime environment for GCC &amp; LLVMfor 32 and 64 bit Windows</p></blockquote><ul><li>ä¸‹è½½åœ°å€ï¼ˆx64ã€posixã€.sehç‰ˆæœ¬ï¼‰</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://sourceforge.net/projects/mingw-w64/files/mingw-w64/mingw-w64-release/</span><br></pre></td></tr></table></figure><ul><li>å¦‚å›¾<br><img src="/2023/12/01/cpp-project-build-clion/mingw-version.png" class="lazyload placeholder" data-srcset="/2023/12/01/cpp-project-build-clion/mingw-version.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></li></ul><h3 id="3-CMake">3.CMake</h3><blockquote><p>CMakeå…è®¸å¼€å‘è€…ç¼–å†™ä¸€ç§å¹³å°æ— å…³çš„ CMakeList.txt æ–‡ä»¶æ¥å®šåˆ¶æ•´ä¸ªç¼–è¯‘æµç¨‹ï¼Œç„¶åå†æ ¹æ®ç›®æ ‡ç”¨æˆ·çš„å¹³å°è¿›ä¸€æ­¥ç”Ÿæˆæ‰€éœ€çš„æœ¬åœ°åŒ– Makefile å’Œå·¥ç¨‹æ–‡ä»¶</p></blockquote><ul><li>åŸºæœ¬æŒ‡ä»¤</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_requiredï¼šæŒ‡å®šè¿è¡Œæ­¤é…ç½®æ–‡ä»¶æ‰€éœ€çš„ CMake çš„æœ€ä½ç‰ˆæœ¬ï¼›</span><br><span class="line">projectï¼šå‚æ•°å€¼æ˜¯ Demo1ï¼Œè¯¥å‘½ä»¤è¡¨ç¤ºé¡¹ç›®çš„åç§°æ˜¯ Demo1 ã€‚</span><br><span class="line">add_executableï¼šå°†åä¸º main.cc çš„æºæ–‡ä»¶ç¼–è¯‘æˆä¸€ä¸ªåç§°ä¸º Demo çš„å¯æ‰§è¡Œæ–‡ä»¶</span><br><span class="line"><span class="comment"># æŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æºæ–‡ä»¶</span></span><br><span class="line"><span class="comment"># å¹¶å°†åç§°ä¿å­˜åˆ° DIR_LIB_SRCS å˜é‡</span></span><br><span class="line">aux_source_directory(. DIR_LIB_SRCS)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆé“¾æ¥åº“</span></span><br><span class="line">add_library (MathFunctions <span class="variable">$&#123;DIR_LIB_SRCS&#125;</span>)</span><br></pre></td></tr></table></figure><ul><li>ä¸¾ä¾‹</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># CMake æœ€ä½ç‰ˆæœ¬å·è¦æ±‚</span><br><span class="line"><span class="built_in">cmake_minimum_required</span> (VERSION <span class="number">2.8</span>)</span><br><span class="line"></span><br><span class="line"># é¡¹ç›®ä¿¡æ¯</span><br><span class="line"><span class="built_in">project</span> (Demo4)</span><br><span class="line"></span><br><span class="line"># åŠ å…¥ä¸€ä¸ªé…ç½®å¤´æ–‡ä»¶ï¼Œç”¨äºå¤„ç† CMake å¯¹æºç çš„è®¾ç½®</span><br><span class="line"><span class="built_in">configure_file</span> (</span><br><span class="line">  <span class="string">&quot;$&#123;PROJECT_SOURCE_DIR&#125;/config.h.in&quot;</span></span><br><span class="line">  <span class="string">&quot;$&#123;PROJECT_BINARY_DIR&#125;/config.h&quot;</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line"># æ˜¯å¦ä½¿ç”¨è‡ªå·±çš„ MathFunctions åº“</span><br><span class="line"><span class="built_in">option</span> (USE_MYMATH</span><br><span class="line">       <span class="string">&quot;Use provided math implementation&quot;</span> ON)</span><br><span class="line"></span><br><span class="line"># æ˜¯å¦åŠ å…¥ MathFunctions åº“</span><br><span class="line"><span class="keyword">if</span> (USE_MYMATH)</span><br><span class="line">  <span class="built_in">include_directories</span> (<span class="string">&quot;$&#123;PROJECT_SOURCE_DIR&#125;/math&quot;</span>)</span><br><span class="line">  <span class="built_in">add_subdirectory</span> (math)  </span><br><span class="line">  <span class="built_in">set</span> (EXTRA_LIBS $&#123;EXTRA_LIBS&#125; MathFunctions)</span><br><span class="line"><span class="built_in">endif</span> (USE_MYMATH)</span><br><span class="line"></span><br><span class="line"># æŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æºæ–‡ä»¶</span><br><span class="line"># å¹¶å°†åç§°ä¿å­˜åˆ° DIR_SRCS å˜é‡</span><br><span class="line"><span class="built_in">aux_source_directory</span>(. DIR_SRCS)</span><br><span class="line"></span><br><span class="line"># æŒ‡å®šç”Ÿæˆç›®æ ‡</span><br><span class="line"><span class="built_in">add_executable</span>(Demo $&#123;DIR_SRCS&#125;)</span><br><span class="line"><span class="built_in">target_link_libraries</span> (Demo  $&#123;EXTRA_LIBS&#125;)</span><br></pre></td></tr></table></figure><h2 id="å·¥å…·å®‰è£…æ„å»º">å·¥å…·å®‰è£…æ„å»º</h2><h3 id="CLion">CLion</h3><h4 id="1-æ–°å»ºcppé¡¹ç›®">1.æ–°å»ºcppé¡¹ç›®</h4><blockquote><p>å¦‚å›¾<br><img src="/2023/12/01/cpp-project-build-clion/clion_new_project.png" class="lazyload placeholder" data-srcset="/2023/12/01/cpp-project-build-clion/clion_new_project.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p></blockquote><h4 id="2-ç¼–å†™æµ‹è¯•ä»£ç ">2.ç¼–å†™æµ‹è¯•ä»£ç </h4><ul><li>1.src/test.cpp</li></ul><blockquote><p>å®šä¹‰socketå¥—æœºå­—ï¼Œæ„å»ºsocketæœåŠ¡ç«¯ï¼›å®ç°ç™»å½•ã€ç™»å‡ºã€æ•°æ®è½¬å‘ç­‰åŠŸèƒ½</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tcpSocket.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Clog.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tcpSocket/MySocket.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;WebServer.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tinyxml2.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;xmlParser.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®¢æˆ·ï¿½?ä¿¡æ¯ç»“æ„ï¿½?</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">SockInfo</span> &#123;</span><br><span class="line">    sockaddr_in addr;</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç™»å½•çŠ¶æ€è®°å½•</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> UserName[<span class="number">32</span>];</span><br><span class="line">    <span class="type">int</span> SocketID;</span><br><span class="line">&#125;loginPool;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// ç”¨æˆ·ç™»å½•éªŒè¯ä»£ç éƒ¨åˆ†</span></span><br><span class="line"></span><br><span class="line">std::vector&lt;loginPool&gt; login_pool_vect;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥ç”¨æˆ·IDæ˜¯å¦å­˜åœ¨ä¸å®¹å™¨å†…,å¦‚æœå­˜åœ¨åˆ™è¿”å›ç”¨æˆ·å</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">is_login</span><span class="params">(std::vector&lt;loginPool&gt; &amp;ptr, <span class="type">int</span> socket_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp; x : ptr)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (x.SocketID == socket_id)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨æˆ·ç™»å½•éªŒè¯</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">login</span><span class="params">(<span class="type">char</span> *username, <span class="type">char</span> *password, <span class="type">int</span> socket_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="built_in">strcmp</span>(username, <span class="string">&quot;admin&quot;</span>) == <span class="number">0</span>) &amp;&amp; (<span class="built_in">strcmp</span>(password, <span class="string">&quot;123456&quot;</span>) == <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœåœ¨åˆ™å¢åŠ ä¸€ä¸ªsocketç™»å½•æ ‡å¿—</span></span><br><span class="line">        loginPool pool_ptr;</span><br><span class="line">        pool_ptr.SocketID = socket_id;</span><br><span class="line">        <span class="built_in">strcpy</span>(pool_ptr.UserName, <span class="string">&quot;admin&quot;</span>);</span><br><span class="line"></span><br><span class="line">        login_pool_vect.<span class="built_in">push_back</span>(pool_ptr);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="built_in">strcmp</span>(username, <span class="string">&quot;admin&quot;</span>) == <span class="number">0</span>) &amp;&amp; (<span class="built_in">strcmp</span>(password, <span class="string">&quot;123456&quot;</span>) == <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœåœ¨åˆ™å¢åŠ ä¸€ä¸ªsocketç™»å½•æ ‡å¿—</span></span><br><span class="line">        loginPool pool_ptr;</span><br><span class="line">        pool_ptr.SocketID = socket_id;</span><br><span class="line">        <span class="built_in">strcpy</span>(pool_ptr.UserName, <span class="string">&quot;admin&quot;</span>);</span><br><span class="line"></span><br><span class="line">        login_pool_vect.<span class="built_in">push_back</span>(pool_ptr);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®ä¼ å…¥IDä»å®¹å™¨å†…å¼¹å‡ºä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">logout</span><span class="params">(std::vector&lt;loginPool&gt; &amp;ptr, <span class="type">int</span> socket_id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> it = ptr.<span class="built_in">begin</span>(); it != ptr.<span class="built_in">end</span>(); it++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (it-&gt;SocketID == socket_id)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// å¼¹å‡ºæŒ‡å®šç»“æ„ä½“</span></span><br><span class="line">            ptr.<span class="built_in">erase</span>(it);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ClientPro</span><span class="params">(<span class="type">void</span>* ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">auto</span>* pSock = (MySocket*)ptr;</span><br><span class="line">    MySocket server_socket = *pSock;</span><br><span class="line">    server_socket.<span class="built_in">Send</span>((<span class="type">const</span> <span class="type">char</span> *)<span class="string">&quot;Welcome to CPP WebSocket Server!&quot;</span>, <span class="number">31</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å®¢æˆ·ç«¯ä¿¡æ¯</span></span><br><span class="line">    <span class="type">char</span> sIp[<span class="number">20</span>];</span><br><span class="line">    UINT nPort;</span><br><span class="line">    server_socket.<span class="built_in">GetPeerName</span>(sIp, nPort);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> szBuffer[<span class="number">4096</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        <span class="type">int</span> sid = pSock-&gt;<span class="built_in">GetSocketID</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> ref = server_socket.<span class="built_in">Receive</span>(szBuffer, <span class="built_in">sizeof</span>(szBuffer));</span><br><span class="line">        <span class="keyword">if</span> (ref &lt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">logout</span>(login_pool_vect, sid);</span><br><span class="line">            ilog-&gt;<span class="built_in">warn</span>(<span class="string">&quot;client :&#123;0&#125;:&#123;1&#125; , [disconnect]&quot;</span>,sIp,nPort);</span><br><span class="line"><span class="comment">//            std::cout &lt;&lt; &quot;å®¢æˆ·: &quot; &lt;&lt; sIp &lt;&lt; &quot;:&quot; &lt;&lt; nPort &lt;&lt; &quot; [å·²æ–­å¼€]&quot; &lt;&lt; std::endl;</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ilog-&gt;<span class="built_in">info</span>(<span class="string">&quot;address:&#123;0&#125;:&#123;1&#125;,receive command:&#123;2&#125; &quot;</span>,sIp,nPort,szBuffer);</span><br><span class="line"><span class="comment">//        std::cout &lt;&lt; &quot;åœ°å€: &quot; &lt;&lt; sIp &lt;&lt; &quot;:&quot; &lt;&lt; nPort &lt;&lt; &quot; æ¥æ”¶å‘½ä»¤: &quot; &lt;&lt; szBuffer &lt;&lt; std::endl;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç”¨æˆ·ç™»å½•</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(szBuffer, <span class="string">&quot;login\n&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">char</span> recv_username[<span class="number">32</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">            <span class="type">char</span> recv_password[<span class="number">32</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ¥æ”¶ç”¨æˆ·åå’Œå¯†ç </span></span><br><span class="line">            pSock-&gt;<span class="built_in">Receive</span>(recv_username, <span class="number">32</span>, <span class="number">0</span>);</span><br><span class="line">            pSock-&gt;<span class="built_in">Receive</span>(recv_password, <span class="number">32</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            ilog-&gt;<span class="built_in">info</span>(<span class="string">&quot;account :&#123;0&#125;, password : &#123;1&#125;&quot;</span>,recv_username,recv_password);</span><br><span class="line">            <span class="comment">// éªŒè¯ç™»å½•çŠ¶æ€</span></span><br><span class="line">            <span class="type">bool</span> login_flag = <span class="built_in">login</span>(recv_username, recv_password, sid);</span><br><span class="line">            <span class="keyword">if</span> (login_flag == TRUE)</span><br><span class="line">            &#123;</span><br><span class="line">                ilog-&gt;<span class="built_in">info</span>(<span class="string">&quot;user :&#123;0&#125;, login .&quot;</span>,recv_username);</span><br><span class="line"><span class="comment">//                std::cout &lt;&lt; &quot;ç”¨æˆ·: &quot; &lt;&lt; recv_username &lt;&lt; &quot; å·²ç™»å½•&quot; &lt;&lt; std::endl;</span></span><br><span class="line">                pSock-&gt;<span class="built_in">Send</span>(<span class="string">&quot;login&quot;</span>, <span class="built_in">sizeof</span>(<span class="string">&quot;login&quot;</span>), <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                pSock-&gt;<span class="built_in">Send</span>(<span class="string">&quot;account or password incorrect&quot;</span>, <span class="built_in">sizeof</span>(<span class="string">&quot;account or password incorrect&quot;</span>), <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ç”¨æˆ·ç™»å‡º</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(szBuffer, <span class="string">&quot;logout\n&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// éªŒè¯æ˜¯å¦ç™»å½•æˆåŠŸ</span></span><br><span class="line">            <span class="type">int</span> login_flag = <span class="built_in">is_login</span>(login_pool_vect, sid);</span><br><span class="line">            <span class="keyword">if</span> (login_flag == TRUE)</span><br><span class="line">            &#123;</span><br><span class="line">                ilog-&gt;<span class="built_in">info</span>(<span class="string">&quot;user logout.&quot;</span>);</span><br><span class="line"><span class="comment">//                std::cout &lt;&lt; &quot;ç”¨æˆ·å·²ç™»å‡º&quot; &lt;&lt; std::endl;</span></span><br><span class="line">                <span class="built_in">logout</span>(login_pool_vect, sid);</span><br><span class="line">                pSock-&gt;<span class="built_in">Send</span>(<span class="string">&quot;user logout.&quot;</span>, <span class="built_in">sizeof</span>(<span class="string">&quot;user logout.&quot;</span>), <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                ilog-&gt;<span class="built_in">warn</span>(<span class="string">&quot;please login account!&quot;</span>);</span><br><span class="line"><span class="comment">//                std::cout &lt;&lt; &quot;è¯·å…ˆç™»å½•&quot; &lt;&lt; std::endl;</span></span><br><span class="line">                pSock-&gt;<span class="built_in">Send</span>(<span class="string">&quot;please login account!&quot;</span>, <span class="built_in">sizeof</span>(<span class="string">&quot;please login account!&quot;</span>), <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// éå†æœ¬æœºæ–‡ä»¶</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(szBuffer, <span class="string">&quot;list\n&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// éªŒè¯æ˜¯å¦ç™»å½•æˆåŠŸ</span></span><br><span class="line">            <span class="type">int</span> login_flag = <span class="built_in">is_login</span>(login_pool_vect, sid);</span><br><span class="line">            <span class="keyword">if</span> (login_flag == TRUE)</span><br><span class="line">            &#123;</span><br><span class="line">                ilog-&gt;<span class="built_in">info</span>(<span class="string">&quot;user has login , output current pc file &quot;</span>);</span><br><span class="line"><span class="comment">//                std::cout &lt;&lt; &quot;ç”¨æˆ·å·²ç™»å½•,è¾“å‡ºæœ¬æœºæ–‡ä»¶&quot; &lt;&lt; std::endl;</span></span><br><span class="line">                pSock-&gt;<span class="built_in">Send</span>(<span class="string">&quot;auth success!&quot;</span>, <span class="built_in">sizeof</span>(<span class="string">&quot;auth success!&quot;</span>), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å¾ªç¯è¾“å‡ºæ•°æ®åŒ…</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">0</span>; x &lt; <span class="number">10</span>; x++)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="type">char</span> sz[<span class="number">1024</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">                    <span class="built_in">sprintf</span>(sz, <span class="string">&quot;count -&gt; %d&quot;</span>, x);</span><br><span class="line">                    pSock-&gt;<span class="built_in">Send</span>(sz, <span class="built_in">sizeof</span>(sz), <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                ilog-&gt;<span class="built_in">warn</span>(<span class="string">&quot;please login account!&quot;</span>);</span><br><span class="line"><span class="comment">//                std::cout &lt;&lt; &quot;è¯·å…ˆç™»å½•&quot; &lt;&lt; std::endl;</span></span><br><span class="line">                pSock-&gt;<span class="built_in">Send</span>(<span class="string">&quot;please login account!&quot;</span>, <span class="built_in">sizeof</span>(<span class="string">&quot;please login account!&quot;</span>), <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">startSocketServer</span><span class="params">()</span></span>&#123;</span><br><span class="line">    MySocket sock;</span><br><span class="line">    <span class="keyword">if</span> (!sock.<span class="built_in">Create</span>(<span class="number">8233</span>, SOCK_STREAM, <span class="string">&quot;127.0.0.1&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æœ¬æœºä¿¡æ¯</span></span><br><span class="line">    <span class="type">char</span> sSevIp[<span class="number">20</span>];</span><br><span class="line">    UINT nSevPort;</span><br><span class="line">    sock.<span class="built_in">GetSockName</span>(sSevIp, nSevPort);</span><br><span class="line">    ilog-&gt;<span class="built_in">info</span>(<span class="string">&quot;server : &#123;0&#125;,&#123;1&#125; ,server is running!&quot;</span>,sSevIp,nSevPort);</span><br><span class="line"><span class="comment">//    std::cout &lt;&lt; &quot;æœåŠ¡ç«¯: &quot; &lt;&lt; sSevIp &lt;&lt; &quot;:&quot; &lt;&lt; nSevPort &lt;&lt; &quot; æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ&quot; &lt;&lt; std::endl;</span></span><br><span class="line"></span><br><span class="line">    sock.<span class="built_in">Listen</span>(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å®¢æˆ·ç«¯ä¿¡æ¯</span></span><br><span class="line">    <span class="type">char</span> sIp[<span class="number">20</span>];</span><br><span class="line">    UINT nPort;</span><br><span class="line"></span><br><span class="line">    MySocket ptr;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// å½“æœ‰æ–°ç”¨æˆ·è¿›æ¥è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ¥ç»´æŒä¼šè¯</span></span><br><span class="line">        sock.<span class="built_in">Accept</span>(ptr, sIp, &amp;nPort);</span><br><span class="line">        ilog-&gt;<span class="built_in">info</span>(<span class="string">&quot;client : &#123;0&#125; :&#123;1&#125; [login]&quot;</span>,sIp,nPort);</span><br><span class="line"><span class="comment">//        std::cout &lt;&lt; &quot;å®¢æˆ·: &quot; &lt;&lt; sIp &lt;&lt; &quot;:&quot; &lt;&lt; nPort &lt;&lt; &quot; [å·²ç™»å½•]&quot; &lt;&lt; std::endl;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¤šçº¿ç¨‹</span></span><br><span class="line">        _beginthread(ClientPro, <span class="number">0</span>, &amp;ptr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">testR</span><span class="params">(wsProtocol ws)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;asd&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">httpR</span><span class="params">(requestHttp httpRq)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;httpR&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">XmlNodeGetVal</span><span class="params">(std::stringstream stringstream, tinyxml2::XMLElement *pElement, <span class="type">const</span> <span class="type">char</span> *string, <span class="type">const</span> <span class="type">char</span> *ip)</span> </span>&#123;</span><br><span class="line">ip = pElement-&gt;<span class="built_in">Attribute</span>(string);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//    readXMLConfig(&quot;./../config.xml&quot;);</span></span><br><span class="line">    <span class="built_in">startSocketServer</span>();</span><br><span class="line"><span class="comment">//    startWebSocketServer();</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>2.include/test.h</li></ul><blockquote><p>å­˜æ”¾test.cppä¸­æ‰€éœ€å¤´æ–‡ä»¶ä¸å‡½æ•°å®šä¹‰ï¼Œå˜é‡å®šä¹‰.</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MySocket</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    SOCKET m_hSocket;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å¯¹ç«¯Socketç”¨æˆ·IPç«¯å£ç­‰</span></span><br><span class="line">    <span class="function">BOOL <span class="title">GetPeerName</span><span class="params">(<span class="type">char</span>* rSocketAddress, UINT&amp; rSocketPort)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        sockaddr_in name = &#123; AF_INET &#125;;</span><br><span class="line">        <span class="type">int</span> lenname = <span class="built_in">sizeof</span>(name);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">getpeername</span>(m_hSocket, (sockaddr*)&amp;name, &amp;lenname) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">strcpy</span>(rSocketAddress, <span class="built_in">inet_ntoa</span>(name.sin_addr));</span><br><span class="line">        rSocketPort = <span class="built_in">htons</span>(name.sin_port);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æœ¬æœºSocketç”¨æˆ·IPç«¯å£ç­‰</span></span><br><span class="line">    <span class="function">BOOL <span class="title">GetSockName</span><span class="params">(<span class="type">char</span>* rSocketAddress, UINT&amp; rSocketPort)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        sockaddr_in name = &#123; AF_INET &#125;;</span><br><span class="line">        <span class="type">int</span> lenname = <span class="built_in">sizeof</span>(name);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">getsockname</span>(m_hSocket, (sockaddr*)&amp;name, &amp;lenname) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">strcpy</span>(rSocketAddress, <span class="built_in">inet_ntoa</span>(name.sin_addr));</span><br><span class="line">        rSocketPort = <span class="built_in">htons</span>(name.sin_port);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å½“å‰ç”¨æˆ·SocketID</span></span><br><span class="line">    <span class="function">BOOL <span class="title">GetSocketID</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> m_hSocket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºå¥—æ¥å­—</span></span><br><span class="line">    <span class="function">BOOL <span class="title">Create</span><span class="params">(UINT nSocketPort = <span class="number">0</span>, <span class="type">int</span> nSockType = SOCK_STREAM, LPCTSTR lpszSocketAddress = <span class="literal">NULL</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºå¥—æ¥å­—</span></span><br><span class="line">        m_hSocket = <span class="built_in">socket</span>(AF_INET, nSockType, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (m_hSocket == INVALID_SOCKET)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½®IPåœ°å€å’Œç«¯å£</span></span><br><span class="line">        sockaddr_in sa = &#123; AF_INET &#125;;</span><br><span class="line">        sa.sin_port = <span class="built_in">htons</span>(nSocketPort);</span><br><span class="line">        <span class="keyword">if</span> (lpszSocketAddress)</span><br><span class="line">            sa.sin_addr.s_addr = <span class="built_in">inet_addr</span>(lpszSocketAddress);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç»‘å®šå¥—æ¥å­—å’ŒIPåœ°å€ç«¯å£</span></span><br><span class="line">        <span class="keyword">return</span> !<span class="built_in">bind</span>(m_hSocket, (sockaddr*)&amp;sa, <span class="built_in">sizeof</span>(sa));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¥å—å®¢æˆ·è¯·æ±‚</span></span><br><span class="line">    <span class="function">BOOL <span class="title">Accept</span><span class="params">(MySocket&amp; rConnectedSock, LPSTR szIp = <span class="literal">NULL</span>, UINT* nPort = <span class="literal">NULL</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        sockaddr_in sa = &#123; AF_INET &#125;;</span><br><span class="line">        <span class="type">int</span> nLen = <span class="built_in">sizeof</span>(sa);</span><br><span class="line">        rConnectedSock.m_hSocket = <span class="built_in">accept</span>(<span class="keyword">this</span>-&gt;m_hSocket, (sockaddr*)&amp;sa, &amp;nLen);</span><br><span class="line">        <span class="keyword">if</span> (rConnectedSock.m_hSocket == INVALID_SOCKET)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (szIp)</span><br><span class="line">            <span class="built_in">strcpy</span>(szIp, <span class="built_in">inet_ntoa</span>(sa.sin_addr));</span><br><span class="line">        <span class="keyword">if</span> (nPort)</span><br><span class="line">            *nPort = <span class="built_in">htons</span>(sa.sin_port);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿æ¥æœåŠ¡ç«¯</span></span><br><span class="line">    <span class="function">BOOL <span class="title">Connection</span><span class="params">(LPCSTR lpszHostAddress, UINT nPort)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        sockaddr_in sa = &#123; AF_INET &#125;;</span><br><span class="line">        sa.sin_port = <span class="built_in">htons</span>(nPort);</span><br><span class="line">        sa.sin_addr.s_addr = <span class="built_in">inet_addr</span>(lpszHostAddress);</span><br><span class="line">        <span class="keyword">return</span> !<span class="built_in">connect</span>(m_hSocket, (sockaddr*)&amp;sa, <span class="built_in">sizeof</span>(sa));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¾¦å¬</span></span><br><span class="line">    <span class="function">BOOL <span class="title">Listen</span><span class="params">(<span class="type">int</span> nConnectionBacklog = <span class="number">5</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> !<span class="built_in">listen</span>(m_hSocket, nConnectionBacklog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€æ¡å‘é€</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">Send</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* lpBuf, <span class="type">int</span> nBufLen, <span class="type">int</span> nFlags = <span class="number">0</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">send</span>(m_hSocket, (LPCSTR)lpBuf, nBufLen, nFlags);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘é€æ•´ä¸ªç¼“å†²åŒº</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">SendTo</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* lpBuf, <span class="type">int</span> nBufLen, UINT nHostPort, LPCSTR lpszHostAddress = <span class="literal">NULL</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">               <span class="type">int</span> nFlags = <span class="number">0</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        sockaddr_in to = &#123; AF_INET &#125;;</span><br><span class="line">        to.sin_port = <span class="built_in">htons</span>(nHostPort);</span><br><span class="line">        to.sin_addr.s_addr = <span class="built_in">inet_addr</span>(lpszHostAddress);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sendto</span>(m_hSocket, (LPCSTR)lpBuf, nBufLen, nFlags, (sockaddr*)&amp;to, <span class="built_in">sizeof</span>(to));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€æ¡æ¥æ”¶</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">Receive</span><span class="params">(<span class="type">void</span>* lpBuf, <span class="type">int</span> nBufLen, <span class="type">int</span> nFlags = <span class="number">0</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">recv</span>(m_hSocket, (LPTSTR)lpBuf, nBufLen, nFlags);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¥æ”¶æ•´ä¸ªç¼“å†²åŒº</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">ReceiveFrom</span><span class="params">(<span class="type">void</span>* lpBuf, <span class="type">int</span> nBufLen, <span class="type">char</span>* rSocketAddress, UINT&amp; rSocketPort, <span class="type">int</span> nFlags = <span class="number">0</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        sockaddr_in from = &#123; AF_INET &#125;;</span><br><span class="line">        <span class="type">int</span> lenFrom = <span class="built_in">sizeof</span>(from);</span><br><span class="line">        <span class="type">int</span> n = <span class="built_in">recvfrom</span>(m_hSocket, (LPSTR)lpBuf, nBufLen, nFlags, (sockaddr*)&amp;from, &amp;lenFrom);</span><br><span class="line">        <span class="built_in">strcpy</span>(rSocketAddress, <span class="built_in">inet_ntoa</span>(from.sin_addr));</span><br><span class="line">        rSocketPort = <span class="built_in">htons</span>(from.sin_port);</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…³é—­å¥—æ¥å­—</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Close</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">closesocket</span>(m_hSocket);</span><br><span class="line">        m_hSocket = INVALID_SOCKET;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">MySocket</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        WSADATA wsaData;</span><br><span class="line">        <span class="built_in">WSAStartup</span>(<span class="number">0x0202</span>, &amp;wsaData);</span><br><span class="line">        m_hSocket = INVALID_SOCKET;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">MySocket</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">Close</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>3.CMakeLists.txt</li></ul><blockquote><p>é…ç½®CMakeç¼–è¯‘æ‰€éœ€ç¯å¢ƒ</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cmakeæœ€å°ç‰ˆæœ¬</span></span><br><span class="line">cmake_minimum_required(VERSION 3.26)</span><br><span class="line"><span class="comment"># å®šä¹‰é¡¹ç›®å</span></span><br><span class="line">project(cpp_socket_server)</span><br><span class="line"><span class="comment"># cppç‰ˆæœ¬</span></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD 17)</span><br><span class="line"><span class="comment"># è®¾ç½®ç¼–è¯‘å‚æ•°</span></span><br><span class="line"><span class="built_in">set</span>(CMAKE_C_FLAGS   <span class="string">&quot;<span class="variable">$&#123;CMAKE_C_FLAGS&#125;</span>   -s&quot;</span>)</span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_FLAGS <span class="string">&quot;<span class="variable">$&#123;CMAKE_CXX_FLAGS&#125;</span> -s&quot;</span>)</span><br><span class="line"><span class="comment"># å¼•å…¥winå¹³å°socketåº“</span></span><br><span class="line">link_libraries(ws2_32)</span><br><span class="line"><span class="comment"># å¼•å…¥æ‰€éœ€å¤´æ–‡ä»¶åº“</span></span><br><span class="line">include_directories(</span><br><span class="line">        lib/include</span><br><span class="line">        lib/include/spdlog</span><br><span class="line"><span class="comment">#        lib/include/cryptopp</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># å¼•å…¥æ‰€éœ€ç¼–è¯‘æºæ–‡ä»¶ï¼ˆ*.cppï¼‰</span></span><br><span class="line">aux_source_directory(</span><br><span class="line">        src</span><br><span class="line">        SRC_FILES</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ç¼–è¯‘æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">set</span>(main_file</span><br><span class="line">        <span class="variable">$&#123;SRC_FILES&#125;</span></span><br><span class="line">        lib/include/tcpSocket.h</span><br><span class="line">        src/tcpSocket/tcpSocket.cpp</span><br><span class="line">        src/tcpSocket/MySocket.hpp</span><br><span class="line">        lib/include/tinyxml2.h</span><br><span class="line">        src/utils/tinyxml2.cpp</span><br><span class="line">        lib/include/xmlParser.h</span><br><span class="line">        src/utils/xmlParser.cpp</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># é“¾æ¥ç¬¬ä¸‰æ–¹åº“</span></span><br><span class="line"><span class="keyword">if</span>(SPDLOG_BUILD_EXAMPLE_HO)</span><br><span class="line">    target_link_libraries(cpp_socket_server PRIVATE spdlog::spdlog_header_only)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ å¯æ‰§è¡Œæ–‡ä»¶</span></span><br><span class="line"><span class="comment"># Add executable files</span></span><br><span class="line">add_executable(</span><br><span class="line">        <span class="variable">$&#123;PROJECT_NAME&#125;</span></span><br><span class="line">        <span class="variable">$&#123;main_file&#125;</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># é“¾æ¥ç¬¬ä¸‰æ–¹åº“</span></span><br><span class="line">target_link_libraries(</span><br><span class="line">        <span class="variable">$&#123;PROJECT_NAME&#125;</span></span><br><span class="line">        <span class="variable">$&#123;LIBRARY&#125;</span></span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="mingwå·¥å…·">mingwå·¥å…·</h3><ul><li>é…ç½®ç¯å¢ƒ</li></ul><blockquote><p>ä¸‹è½½å®ŒmingwåŒ…åï¼Œåœ¨ç³»ç»Ÿå˜é‡Pathä¸­å¼•å…¥ä»¥ä¸‹è·¯å¾„</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D:\mingw64\bin</span><br></pre></td></tr></table></figure><ul><li>å·¥å…·å¼•å…¥</li></ul><blockquote><p>åœ¨clionä¸­ï¼Œå¯æ·»åŠ mingwå·¥å…·ã€‚ç‚¹å‡»File-&gt;Settings-&gt;Buildã€Executionã€Deployment-&gt;Toolchainsï¼›åœ¨å…¶ä¸­è®¾ç½®å¦‚ä¸‹è·¯å¾„ï¼Œä¹Ÿå¯ä½¿ç”¨clioné»˜è®¤è·¯å¾„</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">toolset: D:\\mingw64\\bin</span><br></pre></td></tr></table></figure><blockquote><p>å¦‚å›¾<br><img src="/2023/12/01/cpp-project-build-clion/clion-mingw.png" class="lazyload placeholder" data-srcset="/2023/12/01/cpp-project-build-clion/clion-mingw.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p></blockquote><ul><li>ç¼–å†™é…ç½®</li></ul><blockquote><p>åœ¨CMakeLists.txtï¼ˆç¤ºä¾‹ï¼‰ä¸­å†™å…¥éœ€å¼•å…¥é…ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½® CMake æœ€ä½ç‰ˆæœ¬è¦æ±‚</span></span><br><span class="line">cmake_minimum_required(VERSION 3.8)</span><br><span class="line"><span class="comment"># å®šä¹‰é¡¹ç›®åç§°å’Œç‰ˆæœ¬</span></span><br><span class="line">project(MyApp VERSION 1.0.0 LANGUAGES CXX)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½® C++ æ ‡å‡†</span></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD 17)</span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD_REQUIRED ON)</span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_EXTENSIONS OFF)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ç”¨æˆ·å¯é…ç½®çš„é€‰é¡¹</span></span><br><span class="line">option(ENABLE_DEBUG <span class="string">&quot;Enable debug output&quot;</span> ON)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(ENABLE_DEBUG)</span><br><span class="line">  add_definitions(-DDEBUG_OUTPUT)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line"><span class="comment"># è‡ªå®šä¹‰å®ï¼šæ·»åŠ  MSVC å¸¸ç”¨ç¼–è¯‘é€‰é¡¹</span></span><br><span class="line">macro(add_msvc_options target)</span><br><span class="line">  <span class="keyword">if</span>(MSVC)</span><br><span class="line">    target_compile_options(<span class="variable">$&#123;target&#125;</span> PRIVATE</span><br><span class="line">    /W4                <span class="comment"># è®¾ç½®è­¦å‘Šçº§åˆ«ä¸º 4</span></span><br><span class="line">    /WX                <span class="comment"># å°†è­¦å‘Šè§†ä¸ºé”™è¯¯</span></span><br><span class="line">    /MP                <span class="comment"># å¯ç”¨å¤šå¤„ç†å™¨ç¼–è¯‘</span></span><br><span class="line">    /permissive-       <span class="comment"># ç¦ç”¨ä¸ä¸¥æ ¼çš„è¯­è¨€ conformance</span></span><br><span class="line">    /Zc:__cplusplus    <span class="comment"># å¯ç”¨æ­£ç¡®çš„ __cplusplus å®å€¼</span></span><br><span class="line">    /Zc:inline         <span class="comment"># ç§»é™¤æœªä½¿ç”¨çš„å‡½æ•°</span></span><br><span class="line">    /Gm-               <span class="comment"># ç¦ç”¨æœ€å°ç”Ÿæˆï¼ˆminimal rebuildï¼‰</span></span><br><span class="line">    /EHsc              <span class="comment"># æŒ‡å®šå¼‚å¸¸å¤„ç†æ¨¡å‹</span></span><br><span class="line">    )</span><br><span class="line">  endif()</span><br><span class="line">endmacro()</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ æºæ–‡ä»¶</span></span><br><span class="line"><span class="built_in">set</span>(SOURCE_FILES src/main.cpp)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶</span></span><br><span class="line">add_executable(MyApp <span class="variable">$&#123;SOURCE_FILES&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è°ƒç”¨è‡ªå®šä¹‰å®ï¼Œä¸º MyApp æ·»åŠ  MSVC å¸¸ç”¨ç¼–è¯‘é€‰é¡¹</span></span><br><span class="line">add_msvc_options(MyApp)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸ºç‰¹å®šç›®æ ‡è®¾ç½®å¤´æ–‡ä»¶ç›®å½•</span></span><br><span class="line">target_include_directories(MyApp PRIVATE include)</span><br><span class="line"></span><br><span class="line"><span class="comment"># é“¾æ¥é™æ€åº“</span></span><br><span class="line">find_library(STATIC_LIB libStatic.lib PATHS <span class="string">&quot;<span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/libs/static&quot;</span>)</span><br><span class="line">target_link_libraries(MyApp PRIVATE <span class="variable">$&#123;STATIC_LIB&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># é“¾æ¥åŠ¨æ€åº“</span></span><br><span class="line">find_library(DYNAMIC_LIB libDynamic.dll PATHS <span class="string">&quot;<span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/libs/dynamic&quot;</span>)</span><br><span class="line">find_library(DYNAMIC_LIB_IMPORT libDynamic.lib PATHS <span class="string">&quot;<span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/libs/dynamic&quot;</span>)</span><br><span class="line">target_link_libraries(MyApp PRIVATE <span class="variable">$&#123;DYNAMIC_LIB_IMPORT&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ Windows çš„ DLL delay-load æœºåˆ¶</span></span><br><span class="line">set_target_properties(MyApp PROPERTIES LINK_FLAGS <span class="string">&quot;/DELAYLOAD:libDynamic.dll&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ ¹æ®ç›®æ ‡æ¶æ„å®šåˆ¶ç¼–è¯‘é€‰é¡¹å’Œé“¾æ¥é€‰é¡¹</span></span><br><span class="line"><span class="keyword">if</span>(CMAKE_GENERATOR_PLATFORM STREQUAL <span class="string">&quot;Win32&quot;</span>)</span><br><span class="line">  message(<span class="string">&quot;Building for Win32 (x86) architecture&quot;</span>)</span><br><span class="line">  target_compile_options(MyApp PRIVATE /arch:SSE2)</span><br><span class="line">elseif(CMAKE_GENERATOR_PLATFORM STREQUAL <span class="string">&quot;x64&quot;</span>)</span><br><span class="line">  message(<span class="string">&quot;Building for x64 architecture&quot;</span>)</span><br><span class="line">  target_compile_options(MyApp PRIVATE /arch:AVX2)</span><br><span class="line"><span class="keyword">else</span>()</span><br><span class="line">  message(WARNING <span class="string">&quot;Unknown architecture&quot;</span>)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ å­é¡¹ç›®</span></span><br><span class="line">add_subdirectory(subproject)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨æ„å»ºæ—¶ç”Ÿæˆé…ç½®æ–‡ä»¶</span></span><br><span class="line">configure_file(config.h.in config.h @ONLY)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šå®‰è£…è§„åˆ™</span></span><br><span class="line">install(TARGETS MyApp RUNTIME DESTINATION bin)</span><br><span class="line">install(FILES <span class="string">&quot;<span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/libs/dynamic/libDynamic.dll&quot;</span> DESTINATION bin)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="CMakeç¼–è¯‘">CMakeç¼–è¯‘</h3><ul><li>ç¼–è¯‘test.exe</li></ul><blockquote><p>ç‚¹å‡»è¿è¡ŒæŒ‰é’®ï¼ŒæŸ¥çœ‹æ•ˆæœ</p></blockquote><ul><li>ç›®å½•ç»“æ„</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">MyApp/</span><br><span class="line">  â”œâ”€ CMakeLists.txt</span><br><span class="line">  â”œâ”€ src/</span><br><span class="line">  â”‚   â””â”€ main.cpp</span><br><span class="line">  â”œâ”€ include/</span><br><span class="line">  â”‚   â”œâ”€ static_lib/</span><br><span class="line">  â”‚   â”‚   â””â”€ StaticLibHeader.h</span><br><span class="line">  â”‚   â””â”€ dynamic_lib/</span><br><span class="line">  â”‚       â””â”€ DynamicLibHeader.h</span><br><span class="line">  â”œâ”€ libs/</span><br><span class="line">  â”‚   â”œâ”€ static/</span><br><span class="line">  â”‚   â”‚   â””â”€ libStatic.lib</span><br><span class="line">  â”‚   â””â”€ dynamic/</span><br><span class="line">  â”‚       â”œâ”€ libDynamic.dll</span><br><span class="line">  â”‚       â””â”€ libDynamic.lib</span><br><span class="line">  â”œâ”€ subproject/</span><br><span class="line">  â”‚   â”œâ”€ CMakeLists.txt</span><br><span class="line">  â”‚   â”œâ”€ src/</span><br><span class="line">  â”‚   â”‚   â””â”€ subproject_main.cpp</span><br><span class="line">  â”‚   â””â”€ include/</span><br><span class="line">  â”‚       â””â”€ subproject/</span><br><span class="line">  â”‚           â””â”€ SubProjectHeader.h</span><br><span class="line">  â””â”€ config.h.in</span><br></pre></td></tr></table></figure><ul><li>cmakeè¿è¡Œ(Visual Studio 2019)</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯¹äº x86 æ¶æ„ï¼š </span></span><br><span class="line">cmake -G <span class="string">&quot;Visual Studio 16 2019&quot;</span> -A Win32 ..</span><br><span class="line"><span class="comment"># å¯¹äº x64 æ¶æ„ï¼š </span></span><br><span class="line">cmake -G <span class="string">&quot;Visual Studio 16 2019&quot;</span> -A x64 ..</span><br></pre></td></tr></table></figure><h2 id="å¼•å…¥ç¬¬ä¸‰æ–¹åº“ï¼ˆä»¥spdlogä¸ºä¾‹ï¼‰">å¼•å…¥ç¬¬ä¸‰æ–¹åº“ï¼ˆä»¥spdlogä¸ºä¾‹ï¼‰</h2><blockquote><p>Very fast, header-only/compiled, C++ logging library.</p></blockquote><h3 id="å·¥å…·ä¸‹è½½">å·¥å…·ä¸‹è½½</h3><blockquote><p>åœ¨ä»¥ä¸‹è·¯å¾„ä¸‹è½½spdlogï¼š</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/gabime/spdlog.git</span><br></pre></td></tr></table></figure><h3 id="cmakeå¼•å…¥">cmakeå¼•å…¥</h3><h4 id="åœ¨é¡¹ç›®include-æ–‡ä»¶å¤¹ä¸­å¤åˆ¶ä»¥ä¸‹æ–‡ä»¶å¤¹å†…å®¹">åœ¨é¡¹ç›®include æ–‡ä»¶å¤¹ä¸­å¤åˆ¶ä»¥ä¸‹æ–‡ä»¶å¤¹å†…å®¹</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include/spdlog/</span><br></pre></td></tr></table></figure><h4 id="åœ¨CMakeLists-txtä¸­å¼•å…¥åº“">åœ¨CMakeLists.txtä¸­å¼•å…¥åº“</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">include_directories(</span><br><span class="line">        lib/include</span><br><span class="line">        lib/include/spdlog</span><br><span class="line"><span class="comment">#        lib/include/cryptopp</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(SPDLOG_BUILD_EXAMPLE_HO)</span><br><span class="line">    target_link_libraries(cpp_socket_server PRIVATE spdlog::spdlog_header_only)</span><br><span class="line">endif()</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•è¿è¡Œ">æµ‹è¯•è¿è¡Œ</h3><h4 id="ç¼–å†™å¦‚ä¸‹ä»£ç ">ç¼–å†™å¦‚ä¸‹ä»£ç </h4><ul><li>1.å°è£…spdlogåº“</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> MY_SPDLOG_LOG_HPP</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MY_SPDLOG_LOG_HPP</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;spdlog/spdlog.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;spdlog/async.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;spdlog/sinks/stdout_color_sinks.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;spdlog/sinks/rotating_file_sink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;spdlog/sinks/daily_file_sink.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;spdlog/sinks/basic_file_sink.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CLog</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> CLog &amp;<span class="title">instance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="type">static</span> CLog m_instance;</span><br><span class="line">        <span class="keyword">return</span> m_instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">auto</span> <span class="title">get_logger</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;logger_;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">CLog</span>() &#123;</span><br><span class="line">        spdlog::<span class="built_in">drop_all</span>(); <span class="comment">// é‡Šæ”¾æ‰€æœ‰logger</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CLog</span>() &#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;<span class="built_in">init</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Log System Init , start record log : &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">this</span>-&gt;<span class="built_in">init_file</span>();</span><br><span class="line">        <span class="keyword">this</span>-&gt;<span class="built_in">init_logger</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">init_file</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;log_root_path = <span class="string">R&quot;(C:\Users\Administrator\CLionProjects\cpp_socket_server\logs\)&quot;</span>;</span><br><span class="line">        <span class="keyword">this</span>-&gt;info_file_path = <span class="string">&quot;info.log&quot;</span>;</span><br><span class="line">        <span class="keyword">this</span>-&gt;error_file_path = <span class="string">&quot;error.log&quot;</span>;</span><br><span class="line">        <span class="keyword">this</span>-&gt;rotation_h = <span class="number">5</span>; <span class="comment">// åˆ†å‰²æ—¶é—´</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;rotation_m = <span class="number">59</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">init_logger</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>-&gt;info_sink_ = std::<span class="built_in">make_shared</span>&lt;spdlog::sinks::daily_file_sink_mt&gt;(</span><br><span class="line">                <span class="keyword">this</span>-&gt;log_root_path + <span class="keyword">this</span>-&gt;info_file_path, <span class="keyword">this</span>-&gt;rotation_h, <span class="keyword">this</span>-&gt;rotation_m);</span><br><span class="line">        <span class="keyword">this</span>-&gt;error_sink_ = std::<span class="built_in">make_shared</span>&lt;spdlog::sinks::daily_file_sink_mt&gt;(</span><br><span class="line">                <span class="keyword">this</span>-&gt;log_root_path + <span class="keyword">this</span>-&gt;error_file_path, <span class="keyword">this</span>-&gt;rotation_h, <span class="keyword">this</span>-&gt;rotation_m);</span><br><span class="line">        <span class="keyword">this</span>-&gt;console_sink_ = std::<span class="built_in">make_shared</span>&lt;spdlog::sinks::stdout_color_sink_mt&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>-&gt;info_sink_-&gt;<span class="built_in">set_level</span>(spdlog::level::info); <span class="comment">// debug&lt; info&lt; warn&lt; error&lt; critical  æ—¥å¿—ä¿¡æ¯ä½äºè®¾ç½®çš„çº§åˆ«æ—¶, ä¸äºˆæ˜¾ç¤º</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;error_sink_-&gt;<span class="built_in">set_level</span>(spdlog::level::err);</span><br><span class="line">        <span class="keyword">this</span>-&gt;console_sink_-&gt;<span class="built_in">set_level</span>(spdlog::level::debug);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>-&gt;sinks_.<span class="built_in">push_back</span>(<span class="keyword">this</span>-&gt;info_sink_); <span class="comment">// info</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;sinks_.<span class="built_in">push_back</span>(<span class="keyword">this</span>-&gt;error_sink_); <span class="comment">// error</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;sinks_.<span class="built_in">push_back</span>(<span class="keyword">this</span>-&gt;console_sink_); <span class="comment">// console</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>-&gt;logger_ = std::<span class="built_in">make_shared</span>&lt;spdlog::logger&gt;(<span class="string">&quot;log_demo&quot;</span>, <span class="built_in">begin</span>(<span class="keyword">this</span>-&gt;sinks_), <span class="built_in">end</span>(<span class="keyword">this</span>-&gt;sinks_));</span><br><span class="line">        <span class="keyword">this</span>-&gt;logger_-&gt;<span class="built_in">set_pattern</span>(<span class="string">&quot;[%l] [%Y-%m-%d %H:%M:%S %e] [Process:%P] - %v&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>-&gt;logger_-&gt;<span class="built_in">flush_on</span>(spdlog::level::info); <span class="comment">// è®¾ç½®å½“è§¦å‘ info æˆ–æ›´ä¸¥é‡çš„é”™è¯¯æ—¶ç«‹åˆ»åˆ·æ–°æ—¥å¿—åˆ° disk</span></span><br><span class="line">        spdlog::<span class="built_in">register_logger</span>(<span class="keyword">this</span>-&gt;logger_); <span class="comment">// æ³¨å†Œlogger</span></span><br><span class="line">        spdlog::<span class="built_in">flush_every</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">10</span>)); <span class="comment">// æ¯éš”10ç§’åˆ·æ–°ä¸€æ¬¡æ—¥å¿—</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::shared_ptr &lt;spdlog::logger&gt; logger_;</span><br><span class="line">    std::shared_ptr &lt;spdlog::sinks::daily_file_sink_mt&gt; info_sink_; <span class="comment">// info</span></span><br><span class="line">    std::shared_ptr &lt;spdlog::sinks::daily_file_sink_mt&gt; error_sink_; <span class="comment">// error</span></span><br><span class="line">    std::shared_ptr &lt;spdlog::sinks::stdout_color_sink_mt&gt; console_sink_; <span class="comment">// console</span></span><br><span class="line">    std::vector &lt;spdlog::sink_ptr&gt; sinks_;</span><br><span class="line">    std::string log_root_path;</span><br><span class="line">    std::string error_file_path;</span><br><span class="line">    std::string info_file_path;</span><br><span class="line">    <span class="type">short</span> <span class="type">int</span> rotation_h&#123;&#125;;</span><br><span class="line">    <span class="type">short</span> <span class="type">int</span> rotation_m&#123;&#125;;</span><br><span class="line"></span><br><span class="line">&#125;; <span class="comment">// CLog</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ilog CLog::instance().get_logger()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//MY_SPDLOG_LOG_HPP</span></span></span><br></pre></td></tr></table></figure><ul><li>2.åœ¨ä¸»cppä¸­å†™å…¥æµ‹è¯•ä»£ç </li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ilog-&gt;<span class="built_in">info</span>(<span class="string">&quot;server : &#123;0&#125;,&#123;1&#125; ,server is running!&quot;</span>,sSevIp,nSevPort);</span><br><span class="line">ilog-&gt;<span class="built_in">warn</span>(<span class="string">&quot;client :&#123;0&#125;:&#123;1&#125; , [disconnect]&quot;</span>,sIp,nPort);</span><br><span class="line">ilog-&gt;<span class="built_in">error</span>(<span class="string">&quot;[VP] load config file error : &#123;0&#125;&quot;</span>,doc_dump.<span class="built_in">LoadFile</span>(path));</span><br></pre></td></tr></table></figure><ul><li>3.è¿è¡Œä¸»cppï¼Œæµ‹è¯•æ•ˆæœ</li></ul><blockquote><p>å¦‚å›¾ï¼š<br><img src="/2023/12/01/cpp-project-build-clion/run-result.png" class="lazyload placeholder" data-srcset="/2023/12/01/cpp-project-build-clion/run-result.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p></blockquote><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> clion </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäºAssammdfç¬¬ä¸‰æ–¹pythonåº“å¤„ç†mdfã€mf4æ–‡ä»¶</title>
      <link href="/2023/11/28/mdf-file-parser/"/>
      <url>/2023/11/28/mdf-file-parser/</url>
      
        <content type="html"><![CDATA[<h1>åŸºäºAssammdfç¬¬ä¸‰æ–¹pythonåº“å¤„ç†mdfã€mf4æ–‡ä»¶</h1><blockquote><p>1.ASAMMDFæ˜¯ASAMï¼ˆè‡ªåŠ¨åŒ–å’Œæµ‹é‡ç³»ç»Ÿæ ‡å‡†åŒ–åä¼šï¼‰MDFï¼ˆæµ‹é‡æ•°æ®æ ¼å¼ï¼‰æ–‡ä»¶çš„å¿«é€Ÿè§£æå™¨å’Œç¼–è¾‘å™¨ã€‚<br>2.asammdfæ”¯æŒMDFç‰ˆæœ¬2ï¼ˆ.datï¼‰ã€3ï¼ˆ.mdfï¼‰å’Œ4ï¼ˆ.mf4ï¼‰ã€‚<br>3.asammdfé€‚ç”¨äºpython&gt;ï¼›=3.6ï¼ˆå¯¹äºpython 2.7ã€3.4å’Œ3.5ï¼Œè¯·å‚é˜…4.x.yç‰ˆæœ¬ï¼‰</p></blockquote><h2 id="ç¬¬ä¸‰æ–¹åº“ä¸»è¦åŠŸèƒ½">ç¬¬ä¸‰æ–¹åº“ä¸»è¦åŠŸèƒ½</h2><ul><li>1.mdfã€mf4æ–‡ä»¶åˆ›å»ºè¯»å–</li><li>2.è¯»å–ã€æå–canæ€»çº¿æ—¥å¿—æ–‡ä»¶ä¿¡æ¯</li><li>3.ä¸åŒç‰ˆæœ¬æ–‡ä»¶è½¬æ¢</li><li>4.åŸå§‹æ•°æ®å¯¼å…¥ã€å¯¼å‡ºï¼ŒåŒ…æ‹¬ï¼šHDF5ã€Matlabï¼ˆv4ã€v5å’Œv7.3ï¼‰ã€CSVå’ŒParquet</li></ul><h2 id="åŸºç¡€ç”¨æ³•">åŸºç¡€ç”¨æ³•</h2><ul><li>å‚è€ƒä»£ç å¦‚ä¸‹ï¼š</li></ul><blockquote><p>åŸºç¡€mdfæ–‡ä»¶å¼•å…¥ã€æ•°æ®è¿‡æ»¤ä¸è§£æã€æ•°æ®è½¬æ¢å­˜å‚¨ã€æ•°æ®å›¾å½¢åŒ–ç»˜åˆ¶</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> asammdf <span class="keyword">import</span> MDF </span><br><span class="line">mdf=MDF(<span class="string">&#x27;sample.mdf&#x27;</span>)</span><br><span class="line">speed=mdf.get(<span class="string">&#x27;WheelSpeed&#x27;</span>)</span><br><span class="line">speed.plot()</span><br><span class="line">important_signals=[<span class="string">&#x27;WheelSpeed&#x27;</span>,<span class="string">&#x27;VehicleSpeed&#x27;</span>,<span class="string">&#x27;VehicleAcceleration&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># get short measurement with a subset of channels from 10s to 12s</span></span><br><span class="line">short=mdf.<span class="built_in">filter</span>(important_signals).cut(start=<span class="number">10</span>,stop=<span class="number">12</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># convert to version 4.10 and save to disk</span></span><br><span class="line">short.convert(<span class="string">&#x27;4.10&#x27;</span>).save(<span class="string">&#x27;important signals.mf4&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># plot some channels from a huge file</span></span><br><span class="line">efficient=MDF(<span class="string">&#x27;huge.mf4&#x27;</span>) </span><br><span class="line"><span class="keyword">for</span> signal <span class="keyword">in</span> efficient.select([<span class="string">&#x27;Sensor1&#x27;</span>,<span class="string">&#x27;Voltage3&#x27;</span>]):</span><br><span class="line">signal.plot()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="ä½¿ç”¨æµç¨‹">ä½¿ç”¨æµç¨‹</h2><h3 id="ç¬¬ä¸‰æ–¹åº“å®‰è£…">ç¬¬ä¸‰æ–¹åº“å®‰è£…</h3><ul><li>1.pipå·¥å…·å®‰è£…</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip install asammdf</span><br><span class="line"><span class="comment"># GUI version install</span></span><br><span class="line">pip install asammdf[gui]</span><br></pre></td></tr></table></figure><ul><li>2.åŸºç¡€æ–‡ä»¶è¯»å–(mf4)</li></ul><blockquote><ol><li>æŸ¥æ‰¾MDFæ–‡ä»¶ä¸­ç‰¹å®šä¿¡å·æœ€å¤§å€¼ï¼›</li><li>è®¡ç®—å¹³å‡è½¦é€Ÿå’Œé‡Œç¨‹ï¼Œä½¿ç”¨matplotlibä½œå›¾ï¼›</li><li>è®¡ç®—ä¸¤ä¿¡å·å·®å€¼ï¼Œè¿›è¡Œæ³¢å³°åˆ¤æ–­å¹¶è®°å½•å³°å€¼ä¸ªæ•°ï¼Œé¿å…ä¿¡å·æ¯›åˆºå¹²æ‰°ï¼Œè®¾å®šå·®å€¼é—¨é™å€¼ï¼Œä½¿ç”¨matplotlibä½œå›¾ï¼ˆå«ä¸»æ¬¡åæ ‡)ï¼›</li><li>ä»¥ä¸Šä¿¡æ¯ç›´æ¥å†™å…¥wordä¿å­˜ã€‚</li></ol></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¤„ç†mf4æ•°æ®</span></span><br><span class="line"><span class="comment"># 20220530 FQF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼•å…¥åº“æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">from</span> asammdf <span class="keyword">import</span> MDF     <span class="comment"># ç”¨äºå¤„ç†MDFæ–‡ä»¶</span></span><br><span class="line"><span class="keyword">import</span> os       <span class="comment"># ç”¨äºè·å–æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np      <span class="comment"># ç”¨äºæ•°å­¦å¤„ç†</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt     <span class="comment"># ç”¨äºç»˜å›¾</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å–mf4</span></span><br><span class="line">path = <span class="string">&#x27;C:/fqf&#x27;</span></span><br><span class="line">os.chdir(path)      <span class="comment"># æ›´æ”¹pythonçš„å·¥ä½œç©ºé—´</span></span><br><span class="line">files = os.listdir(path)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> files:</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;_decoded&#x27;</span> <span class="keyword">in</span> f <span class="keyword">and</span> f.endswith(<span class="string">&#x27;.mf4&#x27;</span>) <span class="keyword">and</span> f.startswith(<span class="string">&#x27;df&#x27;</span>):      <span class="comment"># æŸ¥æ‰¾æ–‡ä»¶åå­—å«æœ‰fishä¸”ä»¥.pngåç¼€çš„æ–‡ä»¶</span></span><br><span class="line">        <span class="comment"># print(&#x27;Find the mf4: &#x27; + f)</span></span><br><span class="line">        <span class="comment"># print(f.title())</span></span><br><span class="line">        mf4_name = f.split()</span><br><span class="line">        mdf = MDF(f)</span><br><span class="line">        <span class="comment"># print(mdf.info())</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å–æ•°æ®</span></span><br><span class="line">        Prompt_info = mdf.get(<span class="string">&quot;InterSysInfoDisp&quot;</span>)</span><br><span class="line">        Prompt_value = ICA_Prompt_info.samples</span><br><span class="line">        Prompt_timestamps = Prompt_info .timestamps</span><br><span class="line"></span><br><span class="line"><span class="comment"># æœç´¢å·¥å†µ</span></span><br><span class="line">        i = <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> i &lt; <span class="built_in">len</span>(Prompt_timestamps )-<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">if</span> Prompt_value [i] != <span class="number">9</span> &amp; Prompt_value [i+<span class="number">1</span>] == <span class="number">9</span>:       <span class="comment"># æœç´¢å·¥å†µ</span></span><br><span class="line">                <span class="built_in">print</span>( <span class="string">&quot;============================&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(f)</span><br><span class="line">                <span class="built_in">print</span>(Prompt_timestamps [i])</span><br><span class="line">            i = i + <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»˜å›¾</span></span><br><span class="line"><span class="comment"># plt.plot(Prompt_timestamps ,Prompt_value )#rè¡¨ç¤ºé¢œè‰²ï¼Œvè¡¨ç¤ºä¸‹ä¸‰è§’çº¿ç±»å‹</span></span><br><span class="line"><span class="comment"># plt.xlabel(&#x27;xlabel&#x27;,fontsize = 25)</span></span><br><span class="line"><span class="comment"># plt.ylabel(&#x27;ylabel&#x27;,fontsize = 16)</span></span><br><span class="line"><span class="comment"># plt.grid()</span></span><br><span class="line"><span class="comment"># plt.show()</span></span><br></pre></td></tr></table></figure><ul><li>3.æ–‡ä»¶è¯»å–å¤„ç†ï¼ˆmdfï¼‰</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span>   asammdf <span class="keyword">import</span> MDF                                    <span class="comment"># ç”¨äºå¤„ç†MDFæ–‡ä»¶</span></span><br><span class="line"><span class="keyword">import</span> os                                                    <span class="comment"># ç”¨äºè·å–æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd                                          <span class="comment"># ç”¨äºæ•°æ®åˆ†æ</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np                                           <span class="comment"># ç”¨äºæ•°ç»„å¤„ç†</span></span><br><span class="line"><span class="keyword">from</span> numpy <span class="keyword">import</span> trapz                                      <span class="comment"># å¯ç”¨äºç§¯åˆ†æ±‚é¢ç§¯</span></span><br><span class="line"><span class="keyword">from</span> matplotlib <span class="keyword">import</span> pyplot <span class="keyword">as</span> plt                         <span class="comment"># ç”¨äºä½œå›¾ </span></span><br><span class="line"><span class="keyword">import</span> datetime <span class="keyword">as</span> dt                                        <span class="comment"># ç”¨äºè°ƒç”¨ç³»ç»Ÿæ—¶é—´</span></span><br><span class="line"><span class="keyword">import</span> docx                                                  <span class="comment"># è°ƒç”¨wordæ–‡æ¡£åº“</span></span><br><span class="line"><span class="keyword">from</span> docx.shared <span class="keyword">import</span> Inches                               <span class="comment"># ç”¨äºè®¾ç½®å›¾ç‰‡å°ºå¯¸</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_MDF</span>(<span class="params">Document_Adress</span>):                              <span class="comment"># å®šä¹‰check_MDFå‡½æ•°</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;æ–‡ä»¶åï¼š &#x27;</span>+Adress_str+<span class="string">&#x27;ï¼Œç›¸å…³ç»Ÿè®¡ä¿¡æ¯å¦‚ä¸‹ï¼š&#x27;</span>)       <span class="comment"># æå–åœ°å€ä¸­æ–‡ä»¶åä¿¡æ¯ï¼Œæ‰“å°</span></span><br><span class="line"></span><br><span class="line">    new_Doc = document.add_paragraph\</span><br><span class="line">        (<span class="string">&#x27;æ–‡ä»¶åï¼š &#x27;</span>+Adress_str+<span class="string">&#x27;ï¼Œç›¸å…³ç»Ÿè®¡ä¿¡æ¯å¦‚ä¸‹ï¼š&#x27;</span>)        <span class="comment"># æ–°å¢æ®µè½æ–‡æœ¬</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    MDF_File=MDF(Document_Adress)                            <span class="comment"># ä½¿ç”¨asammdfç¬¬ä¸‰æ–¹åŒ…è°ƒå–.mdfæ–‡ä»¶å†…å®¹</span></span><br><span class="line">    TCOil= MDF_File.get(<span class="string">&quot;TCOil&quot;</span>)                             <span class="comment"># è°ƒç”¨.mdfä¸­é›¶ä»¶å¤„æ²¹æ¸©Signal   </span></span><br><span class="line">    TOil=MDF_File.get(<span class="string">&quot;TOil&quot;</span>)                                <span class="comment"># è°ƒç”¨.mdfä¸­æ²¹åº•å£³æ¸©åº¦Signal</span></span><br><span class="line">    VehSpd=MDF_File.get(<span class="string">&quot;VehSpd&quot;</span>)                            <span class="comment"># è°ƒç”¨.mdfä¸­è½¦é€ŸSignal</span></span><br><span class="line"></span><br><span class="line">    VehSpdCheck(VehSpd)                                      <span class="comment"># check_MDF()å‡½æ•°è°ƒç”¨VehSpdCheck()å‡½æ•°</span></span><br><span class="line">    Signal_Data_Max(TCOil)                                   <span class="comment"># check_MDF()å‡½æ•°è°ƒç”¨Signal_Data_Max()å‡½æ•°</span></span><br><span class="line">    T_Subtract_Peak(TCOil, TOil, <span class="number">20</span>)                         <span class="comment"># check_MDF()å‡½æ•°è°ƒç”¨T_Subtract_Peak()å‡½æ•°</span></span><br><span class="line"></span><br><span class="line">    document.save(Veh_VIN+<span class="string">&#x27;.docx&#x27;</span>)                           <span class="comment"># è¿è¡Œå®Œç¨‹åºåä¿å­˜wordæ–‡æ¡£</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">timeconvert</span>(<span class="params">second</span>):                                     <span class="comment"># å°†æ—¶é—´ç§’è½¬åŒ–strç±»å‹çš„æ—¶åˆ†ç§’</span></span><br><span class="line">    Timestr =<span class="built_in">str</span>(<span class="built_in">int</span>(second/<span class="number">3600</span>)) + <span class="string">&#x27;h &#x27;</span> + \</span><br><span class="line">             <span class="built_in">str</span>(<span class="built_in">int</span>((second%<span class="number">3600</span>)/ <span class="number">60</span>)) + <span class="string">&#x27;min &#x27;</span> + \</span><br><span class="line">             <span class="built_in">str</span>(<span class="built_in">int</span>((second%<span class="number">3600</span>) % <span class="number">60</span>)) + <span class="string">&#x27;s&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> Timestr</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Signal_Data_Max</span>(<span class="params">Signal</span>):                                 <span class="comment"># å®šä¹‰Signal_Data_Max()å‡½æ•°</span></span><br><span class="line">    x=Signal.timestamps                                      <span class="comment"># æå–Signalä¸­æ‰€æœ‰æ—¶åˆ»å€¼å­˜æ”¾åˆ—è¡¨x()ä¸­</span></span><br><span class="line">    y=Signal.samples                                         <span class="comment"># æå–Signalä¸­æ‰€æœ‰å®æµ‹å€¼å­˜æ”¾åˆ—è¡¨y()ä¸­</span></span><br><span class="line">    T_C_Max=np.<span class="built_in">max</span>(y)                                        <span class="comment"># ä½¿ç”¨Numpyåº“ä¸­max()å‡½æ•°æ±‚yä¸­æ•°æ®çš„æœ€å¤§å€¼</span></span><br><span class="line">    Positon=np.where(y==np.<span class="built_in">max</span>(y))                           <span class="comment"># æ‰¾åˆ°yæœ€å¤§å€¼å¯¹åº”çš„ç´¢å¼•å€¼ï¼ˆå¯ç†è§£ä¸ºåºå·ï¼‰</span></span><br><span class="line">    Time=(x[Positon[<span class="number">0</span>][<span class="number">0</span>]])                                  <span class="comment"># æå–ç´¢å¼•å€¼å¯¹åº”æ—¶åˆ»</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;é›¶ä»¶å¤„æ²¹æ¸©æœ€å¤§å€¼%d&#x27;</span> %T_C_Max+\</span><br><span class="line">          <span class="string">&#x27;æ—¶é—´æ˜¯&#x27;</span>+timeconvert(Time))                        <span class="comment"># æ‰“å°é›¶ä»¶å¤„æ²¹æ¸©æœ€å¤§å€¼åŠå¯¹åº”çš„æ—¶é—´ï¼ˆç§’è½¬åŒ–ä¸ºåˆ†é’Ÿï¼‰</span></span><br><span class="line"></span><br><span class="line">    new_Doc = document.add_paragraph\</span><br><span class="line">        (<span class="string">&#x27;é›¶ä»¶å¤„æ²¹æ¸©æœ€å¤§å€¼ä¸º &#x27;</span>+<span class="built_in">str</span>(T_C_Max)+<span class="string">&#x27; â„ƒï¼Œ&#x27;</span>\</span><br><span class="line">         <span class="string">&#x27;æ—¶é—´æ˜¯&#x27;</span>+timeconvert(Time),style=<span class="string">&#x27;List Bullet&#x27;</span>)     <span class="comment"># æ–°å¢æ®µè½æ–‡æœ¬</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">VehSpdCheck</span>(<span class="params">Singal</span>):                                     <span class="comment"># å®šä¹‰Signal_Data_Max()å‡½æ•°</span></span><br><span class="line">    x=Singal.timestamps                                      <span class="comment"># æå–Signalä¸­æ‰€æœ‰æ—¶åˆ»å€¼å­˜æ”¾åˆ—è¡¨x()ä¸­</span></span><br><span class="line">    <span class="comment">#print(Singal.display_name)</span></span><br><span class="line">    y=Singal.samples                                         <span class="comment"># æå–Signalä¸­æ‰€æœ‰å®æµ‹å€¼å­˜æ”¾åˆ—è¡¨y()ä¸­</span></span><br><span class="line">    Average_Vehspd=np.<span class="built_in">sum</span>(y)/<span class="built_in">len</span>(y)                          <span class="comment"># ä½¿ç”¨Numpyåº“ä¸­sum()å‡½æ•°æ±‚å’Œåé™¤ä»¥ç‚¹çš„ä¸ªæ•°</span></span><br><span class="line">    Drive_Distance=Average_Vehspd*x[-<span class="number">1</span>]/<span class="number">3600</span>                 <span class="comment"># è¡Œé©¶é‡Œç¨‹é€šè¿‡å‡å€¼ä¸æ—¶é—´ä¹˜ç§¯è·å¾—</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;è¯¥æ–‡ä»¶å¹³å‡è½¦é€Ÿ %.2f km/h,&#x27;</span> %Average_Vehspd+\</span><br><span class="line">    <span class="string">&#x27;è¡Œé©¶é‡Œç¨‹ %.2f km&#x27;</span> %Drive_Distance)                      <span class="comment"># æ‰“å°å¹³å‡è½¦é€Ÿå’Œè¡Œé©¶é‡Œç¨‹ï¼ˆä½¿ç”¨æ¢è¡Œ\ï¼‰</span></span><br><span class="line"></span><br><span class="line">    Average_Vehspd_str=<span class="built_in">str</span>(<span class="built_in">round</span>(Average_Vehspd, <span class="number">2</span>))         <span class="comment"># å¹³å‡é€Ÿåº¦ä¿ç•™ä¸¤ä½ï¼Œè½¬åŒ–ä¸ºå­—ç¬¦ä¸²</span></span><br><span class="line">    Drive_Distance_str =<span class="built_in">str</span>(<span class="built_in">round</span>( Drive_Distance, <span class="number">2</span>))       <span class="comment"># è¡Œé©¶é‡Œç¨‹ä¿ç•™ä¸¤ä½ï¼Œè½¬åŒ–ä¸ºå­—ç¬¦ä¸²</span></span><br><span class="line">    new_Doc = document.add_paragraph\</span><br><span class="line">        (<span class="string">&#x27;è¯¥æ–‡ä»¶å¹³å‡è½¦é€Ÿ &#x27;</span>+ Average_Vehspd_str+<span class="string">&#x27; km/hï¼Œ&#x27;</span>+\</span><br><span class="line">         <span class="string">&#x27;è¡Œé©¶é‡Œç¨‹= &#x27;</span>+Drive_Distance_str+<span class="string">&#x27; km&#x27;</span>+<span class="string">&#x27;ï¼Œè§ä¸‹å›¾ï¼š&#x27;</span>,style=<span class="string">&#x27;List Bullet&#x27;</span>)</span><br><span class="line">                                                             <span class="comment"># æ–°å¢æ®µè½æ–‡æœ¬</span></span><br><span class="line"></span><br><span class="line">    plt.figure(Adress_str+<span class="string">&#x27;--&#x27;</span>+Singal.display_name)          <span class="comment"># å›¾è¡¨å‘½åä¸ºæ–‡ä»¶ååŠ ä¿¡å·åç§°</span></span><br><span class="line">    plt.axis([np.<span class="built_in">min</span>(x),np.<span class="built_in">max</span>(x),<span class="number">0</span>,np.<span class="built_in">max</span>(y)])              <span class="comment"># ä½¿ç”¨pyplotå‡½æ•°å®šä¹‰xè½´å’Œyè½´æœ€å¤§åŠæœ€å°å€¼</span></span><br><span class="line">    plt.plot(x,y,label=<span class="string">&#x27;$VehSpd$&#x27;</span>)                           <span class="comment"># ä½¿ç”¨pyplotä½œå›¾ï¼Œå›¾ä¾‹ä¸ºVehSpd</span></span><br><span class="line">    plt.xlabel(<span class="string">&#x27;t (s) &#x27;</span>)                                     <span class="comment"># å¢åŠ Xè½´-åæ ‡è½´æ ‡é¢˜</span></span><br><span class="line">    plt.ylabel(<span class="string">&#x27;VehicleSpeed (km/h) &#x27;</span>)                       <span class="comment"># å¢åŠ yè½´-åæ ‡è½´æ ‡é¢˜</span></span><br><span class="line"></span><br><span class="line">    plt.fill_between(x,y1=y,y2=<span class="number">0</span>,facecolor=<span class="string">&#x27;purple&#x27;</span>,\</span><br><span class="line">                     alpha=<span class="number">0.2</span>)                              <span class="comment"># å¯¹yä¸xå›´æˆé¢ç§¯ç€è‰²ï¼Œå±•ç¤ºé€Ÿåº¦æ±‚ç§¯åˆ†â†’é‡Œç¨‹</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    plt.text(x[-<span class="number">1</span>]/<span class="number">3</span>,np.<span class="built_in">max</span>(y)-<span class="number">3</span>, <span class="string">&#x27;DriveDistance:%.2f km&#x27;</span> \</span><br><span class="line">             %Drive_Distance, \</span><br><span class="line">             fontdict=&#123;<span class="string">&#x27;size&#x27;</span>: <span class="number">10</span>, <span class="string">&#x27;color&#x27;</span>: <span class="string">&#x27;red&#x27;</span>&#125;)          <span class="comment">#  xè½´åæ ‡ï¼Œyè½´åæ ‡,æ˜¾ç¤ºå†…å®¹,å­—ä½“å¤§å°ã€é¢œè‰²</span></span><br><span class="line"></span><br><span class="line">    plt.title(Adress_str)                                    <span class="comment"># å°†å…¨å±€å˜é‡ä¿¡æ¯å¢åŠ å…¥è¡¨å¤´</span></span><br><span class="line">    <span class="comment">#plt.title(Adress_str+&#x27;__&#x27;+&#x27;(DriveDistance: %.2f &#x27;%Drive_Distance+&#x27; km)&#x27;)</span></span><br><span class="line">    plt.legend(loc=<span class="string">&#x27;upper right&#x27;</span>)                            <span class="comment"># å›¾ä¾‹é€‰æ‹©æœ€ä½³ä½ç½®ï¼Œå¯é€‰æ‹©best</span></span><br><span class="line">    <span class="comment">#plt.show()                                              # æ˜¾ç¤ºå›¾ä¾‹</span></span><br><span class="line">    picture_name=Adress_str +<span class="string">&#x27;-&#x27;</span>+ \</span><br><span class="line">                 Singal.display_name+<span class="string">&#x27;.png&#x27;</span>                  <span class="comment"># å›¾ç‰‡ä¿å­˜æ—¶åç§°</span></span><br><span class="line">    plt.savefig(picture_name, dpi=<span class="number">200</span>)                       <span class="comment"># ä¿å­˜å›¾ç‰‡</span></span><br><span class="line"></span><br><span class="line">    new_Doc = document.add_picture(picture_name, width=Inches(<span class="number">5.0</span>))</span><br><span class="line">                                                             <span class="comment"># å›¾ç‰‡å†™å…¥word</span></span><br><span class="line">    os.remove(picture_name)                                  <span class="comment"># åˆ é™¤å›¾ç‰‡æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">T_Subtract_Peak</span>(<span class="params">T1,T2,threshold</span>):</span><br><span class="line">    <span class="comment"># T1.plot()                                              # ä½¿ç”¨ASAMMDFè‡ªå¸¦Plotåˆ¶å›¾</span></span><br><span class="line">    <span class="comment"># T2.plot()</span></span><br><span class="line">    x = T1.timestamps                                        <span class="comment"># æå–ä¿¡å·T1ä¸­æ‰€æœ‰æ—¶åˆ»å€¼çš„ç‚¹å­˜æ”¾åˆ—è¡¨x()ä¸­</span></span><br><span class="line">    y1 = T1.samples                                          <span class="comment"># æå–ä¿¡å·T1ä¸­æ‰€æœ‰ä¿¡å·å€¼çš„ç‚¹å­˜æ”¾åˆ—è¡¨y()ä¸­</span></span><br><span class="line">    y2 = T2.samples                                          <span class="comment"># æå–ä¿¡å·T2ä¸­æ‰€æœ‰ä¿¡å·å€¼çš„ç‚¹å­˜æ”¾åˆ—è¡¨y()ä¸­</span></span><br><span class="line">    k = <span class="built_in">len</span>(x)                                               <span class="comment"># ç»Ÿè®¡æ•°æ®çš„æ€»ä¸ªæ•°</span></span><br><span class="line"></span><br><span class="line">    a = <span class="number">0</span>                                                    <span class="comment"># å®šä¹‰æ•°å­—a</span></span><br><span class="line">    i = <span class="number">0</span>                                                    <span class="comment"># å®šä¹‰æ•°å­—i</span></span><br><span class="line">    m = <span class="number">0</span>                                                    <span class="comment"># å®šä¹‰æ•°å­—m</span></span><br><span class="line"></span><br><span class="line">    T_Up = []                                                <span class="comment"># å®šä¹‰T_Upä¸ºåˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, k):</span><br><span class="line">        T_Up.append(y1[a] - y2[a])                           <span class="comment"># å°†æ‰€æœ‰æ¸©å·®ç‚¹å†™å…¥T_Up</span></span><br><span class="line">    y3 = T_Up</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> i &lt; k - <span class="number">1</span>:                                         <span class="comment"># ä»0åˆ°kï¼Œä½¿ç”¨whileå¾ªç¯ï¼Œæ¡ä»¶æ»¡è¶³ä¸€ç›´æ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">int</span>(T1.samples[i] - T2.samples[i]) &gt;= \</span><br><span class="line">                threshold:                                   <span class="comment"># T1å’ŒT2åœ¨æŸæ—¶åˆ»æ¸©å·®å¤§äºé—¨é™å€¼,æ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line">            j = i                                            <span class="comment"># è¿‡æ»¤ä¿¡å·æ¯›åˆºï¼Œå¯»æ‰¾å¤§äºé—¨é™å€¼æ³¢å³°ä¸ªæ•°</span></span><br><span class="line">            <span class="keyword">while</span> j &lt; k - <span class="number">1</span>:</span><br><span class="line">                j += <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">int</span>(T1.samples[j] - \</span><br><span class="line">                       T2.samples[j]) &lt; threshold - <span class="number">3</span>:        <span class="comment"># è®¾ç½®å·®å€¼ä¸º2ä½œä¸ºè¿‡æ»¤ä¿¡å·</span></span><br><span class="line">                    m = m + <span class="number">1</span>                                 <span class="comment"># è®°å½•æ³¢å³°ä¸ªæ•°</span></span><br><span class="line">                    time = <span class="built_in">int</span>(j / k * T1.timestamps[-<span class="number">1</span>] / <span class="number">60</span>)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&#x27;è¯¥æ–‡ä»¶é›¶ä»¶å¤„æ²¹æ¸©ä¸æ²¹åº•å£³æ¸©å·®å¤§äº&#x27;</span> + <span class="built_in">str</span>(threshold) + <span class="string">&#x27;çš„æ³¢å³°ç¬¬ %d å¤„,&#x27;</span> % m + \</span><br><span class="line">                          <span class="string">&#x27;æ—¶é—´æ˜¯ %d s,&#x27;</span> % time + <span class="string">&#x27;é›¶ä»¶å¤„æ²¹æ¸© %d â„ƒ&#x27;</span> % T1.samples[j])</span><br><span class="line"></span><br><span class="line">                    new_Doc = document.add_paragraph \</span><br><span class="line">                        (<span class="string">&#x27;è¯¥æ–‡ä»¶é›¶ä»¶å¤„æ²¹æ¸©ä¸æ²¹åº•å£³æ¸©å·®å¤§äº&#x27;</span>\</span><br><span class="line">                         + <span class="built_in">str</span>(threshold) + <span class="string">&#x27;â„ƒçš„æ³¢å³°ç¬¬&#x27;</span> +\</span><br><span class="line">                         <span class="built_in">str</span>(m) + <span class="string">&#x27;å¤„ï¼Œæ—¶é—´æ˜¯&#x27;</span> + timeconvert(time))</span><br><span class="line">                                                              <span class="comment"># æ–°å¢æ®µè½æ–‡æœ¬</span></span><br><span class="line"></span><br><span class="line">                    i = j                                     <span class="comment"># å±€éƒ¨å˜é‡iæ›´æ–°ä¸ºj</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">break</span>                                     <span class="comment"># å¾ªç¯é€€å‡º</span></span><br><span class="line">        i = i + <span class="number">1</span>                                             <span class="comment"># ä»¥ä¸Šç¨‹åºä¸æ‰§è¡Œæˆ–è€…é€€å‡ºï¼Œæ‰§è¡Œiè‡ªåŠ </span></span><br><span class="line"></span><br><span class="line">    plt.figure(Adress_str + <span class="string">&#x27;â€”&#x27;</span> + T1.display_name +</span><br><span class="line">               <span class="string">&#x27;-&#x27;</span> + T1.display_name)                         <span class="comment"># å›¾è¡¨å‘½åä¸ºæ–‡ä»¶ååŠ ä¸¤ä¿¡å·åç§°</span></span><br><span class="line"></span><br><span class="line">    fig = plt.figure(num=<span class="number">1</span>, figsize=(<span class="number">15</span>, <span class="number">8</span>), dpi=<span class="number">80</span>)         <span class="comment"># å¼€å¯ä¸€ä¸ªçª—å£ï¼ŒåŒæ—¶è®¾ç½®å¤§å°ï¼Œåˆ†è¾¨ç‡</span></span><br><span class="line">    fig, ax1 = plt.subplots()                                <span class="comment"># ä½œ1ä¸ªå›¾</span></span><br><span class="line">    ax2 = ax1.twinx()                                        <span class="comment"># åæ ‡è½´2ä¸ºæ¬¡è¦åæ ‡</span></span><br><span class="line">    ax1.plot(x, y1, <span class="string">&#x27;-&#x27;</span>, color=<span class="string">&#x27;g&#x27;</span>, label=<span class="string">&#x27;TCOil&#x27;</span>)           <span class="comment"># ç»˜åˆ¶æ›²çº¿y1ï¼Œå«çº¿å‹ã€é¢œè‰²ã€å›¾ä¾‹åç§°</span></span><br><span class="line">    ax1.plot(x, y2, <span class="string">&#x27;-&#x27;</span>, color=<span class="string">&#x27;b&#x27;</span>, label=<span class="string">&#x27;TOil&#x27;</span>)            <span class="comment"># ç»˜åˆ¶æ›²çº¿y2</span></span><br><span class="line">    ax2.plot(x, y3, <span class="string">&#x27;-&#x27;</span>, color=<span class="string">&#x27;r&#x27;</span>, label=<span class="string">&#x27;T_Up&#x27;</span>)            <span class="comment"># ç»˜åˆ¶æ›²çº¿y3</span></span><br><span class="line">    ax1.legend(loc=<span class="string">&#x27;upper left&#x27;</span>)                             <span class="comment"># æ˜¾ç¤ºå›¾ä¾‹ä½ç½®,plt.legend()ï¼Œå·¦ä¸Š</span></span><br><span class="line">    ax2.legend(loc=<span class="string">&#x27;upper right&#x27;</span>)                            <span class="comment"># æ˜¾ç¤ºå›¾ä¾‹ä½ç½®,å³ä¸Š</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ax1.set_xlim(-5,5)</span></span><br><span class="line">    ax1.set_ylim(np.<span class="built_in">min</span>(y2) - <span class="number">5</span>, np.<span class="built_in">max</span>(y1) + <span class="number">5</span>)             <span class="comment"># è®¾å®šy1è½´æœ€å¤§æœ€å°å€¼</span></span><br><span class="line">    ax2.set_ylim(np.<span class="built_in">min</span>(y3) - <span class="number">5</span>, np.<span class="built_in">max</span>(y3) + <span class="number">5</span>)             <span class="comment">#  åŒä¸Š</span></span><br><span class="line"></span><br><span class="line">    ax1.set_title(Adress_str)                                <span class="comment"># å›¾è¡¨è¡¨å¤´</span></span><br><span class="line"></span><br><span class="line">    ax1.set_xlabel(<span class="string">&#x27;time(s)&#x27;</span>)                                <span class="comment"># è®¾å®šxè½´æ ‡é¢˜</span></span><br><span class="line">    ax1.set_ylabel(<span class="string">&quot;TC_Oil &amp; T_Oil (â„ƒ)&quot;</span>, color=<span class="string">&#x27;b&#x27;</span>)         <span class="comment">#  è®¾å®šy1è½´æ ‡é¢˜</span></span><br><span class="line">    ax2.set_ylabel(<span class="string">&quot;T_Up(â„ƒ)&quot;</span>, color=<span class="string">&#x27;r&#x27;</span>)                    <span class="comment"># è®¾å®šy2è½´æ ‡é¢˜</span></span><br><span class="line">    <span class="comment"># plt.show()                                             # å‚è€ƒä¹‹å‰æ³¨é‡Š</span></span><br><span class="line"></span><br><span class="line">    picture_name = Adress_str + <span class="string">&#x27;-&#x27;</span> + T1.display_name + <span class="string">&#x27;-&#x27;</span> + T2.display_name +<span class="string">&#x27;.png&#x27;</span></span><br><span class="line">    plt.savefig(picture_name, dpi=<span class="number">100</span>)                       <span class="comment"># ä¿å­˜å›¾ç‰‡æ–‡ä»¶åˆ°æ–‡ä»¶å¤¹</span></span><br><span class="line"></span><br><span class="line">    new_Doc = document.add_picture(picture_name, width=Inches(<span class="number">6.0</span>))</span><br><span class="line">                                                             <span class="comment"># ä¿å­˜å›¾ç‰‡åˆ°word</span></span><br><span class="line">    os.remove(picture_name)                                  <span class="comment"># åˆ é™¤å›¾ç‰‡æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line">file_path = <span class="string">&#x27;D:\SoftApp\Python\HardWay2StudyPython\MDFData&#x27;</span>  <span class="comment"># æ–‡ä»¶æ‰€åœ¨æ–‡ä»¶å¤¹</span></span><br><span class="line">now_time=dt.datetime.now().strftime(<span class="string">&#x27;%F  %T&#x27;</span>)                <span class="comment"># è°ƒç”¨ç³»ç»Ÿæ—¶é—´</span></span><br><span class="line">Veh_VIN=<span class="built_in">input</span>(<span class="string">&quot;è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ•…éšœæ’æŸ¥è½¦è¾†VINæ•°å­—ç¼–å·åï¼Œå›è½¦ï¼š&quot;</span>) <span class="comment"># æç¤ºè¾“å…¥è½¦è¾†ä¿¡æ¯</span></span><br><span class="line"><span class="built_in">print</span>(Veh_VIN+<span class="string">&quot;è½¦è¾†&quot;</span>+<span class="string">&#x27;æ•°æ®åˆ†ææ—¶é—´ï¼š&#x27;</span>+now_time)               <span class="comment"># æ‰“å°è¾“å‡ºè½¦è¾†å’Œç³»ç»Ÿæ—¶é—´</span></span><br><span class="line"></span><br><span class="line">document = docx.Document()                                  <span class="comment"># åˆ›å»ºwordæ–‡æ¡£å¯¹è±¡</span></span><br><span class="line">document.add_heading(Veh_VIN+<span class="string">&#x27;è½¦æ’æŸ¥ä¿¡æ¯&#x27;</span>, <span class="number">0</span>)                <span class="comment"># æ·»åŠ æ–‡æ¡£æ ‡é¢˜</span></span><br><span class="line">new_Doc= document.add_paragraph \</span><br><span class="line">    (<span class="string">&#x27;ä¸»è¦æ’æŸ¥è¡Œé©¶é‡Œç¨‹ã€æœ€é«˜æ²¹æ¸©ã€\</span></span><br><span class="line"><span class="string">    é›¶ä»¶å¤„ä¸å˜é€Ÿç®±æ²¹æ¸©å·®å€¼å‡ºç°çš„å³°å€¼æ•°ã€‚ &#x27;</span>)                    <span class="comment"># æ–°å¢æ®µè½æ–‡æœ¬ï¼Œå­—ç¬¦\ç”¨äºæ¢è¡Œ</span></span><br><span class="line">new_Doc=document.add_paragraph\</span><br><span class="line">     (Veh_VIN+<span class="string">&quot;è½¦è¾†&quot;</span>+<span class="string">&#x27;æ•°æ®åˆ†ææ—¶é—´ï¼š&#x27;</span>+ now_time)              <span class="comment"># æ–°å¢æ®µè½æ–‡æœ¬</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(file_path):                 <span class="comment"># os.walkè¿”å›ä¸‰ä¸ªå¯¹è±¡: dirpath(ç›®å½•è·¯å¾„ï¼Œstringç±»å‹) ;</span></span><br><span class="line">                                                             <span class="comment"># dirname(å¤šä¸ªå­ç›®å½•åï¼Œåˆ—è¡¨); filename(å¤šä¸ªæ–‡ä»¶åï¼Œåˆ—è¡¨ï¼‰</span></span><br><span class="line">    Documents=[os.path.join(root, name) <span class="keyword">for</span> name <span class="keyword">in</span> files]   <span class="comment"># éå†æ–‡ä»¶åå­˜æ”¾list(åˆ—è¡¨)ç±»å‹çš„Documets</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> Document_Path <span class="keyword">in</span> Documents:                              <span class="comment"># éå†æ–‡ä»¶åå¯¹åº”çš„åœ°å€ï¼ˆå‡è®¾æœ‰3ä¸ªæ–‡ä»¶åœ°å€ï¼‰</span></span><br><span class="line">    <span class="comment"># print(Document_path.info())                            # æ‰“å°MDFæ–‡ä»¶ä¿¡å·ï¼Œä¾‹å¦‚å¯ä»¥çœ‹åˆ°æœ‰å“ªäº›ä¿¡å·</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;-&#x27;</span>*<span class="number">60</span>)                                            <span class="comment"># æ‰“å°åˆ†å‰²è¡Œ</span></span><br><span class="line"></span><br><span class="line">    new_Doc = document.add_paragraph(<span class="string">&#x27;-&#x27;</span>*<span class="number">100</span>)                <span class="comment"># æ–°å¢æ®µè½æ–‡æœ¬ï¼Œå­—ç¬¦\ç”¨äºæ¢è¡Œ</span></span><br><span class="line">    new_Doc = document.add_paragraph(<span class="string">&#x27;-&#x27;</span> * <span class="number">100</span>)              <span class="comment"># æ–°å¢æ®µè½æ–‡æœ¬ï¼Œå­—ç¬¦\ç”¨äºæ¢è¡Œ</span></span><br><span class="line"></span><br><span class="line">    Adress=Document_Path.split(<span class="string">&#x27;\\&#x27;</span>)[-<span class="number">1</span>]                     <span class="comment"># æå–è·¯å¾„ä¸­çš„å«åç¼€çš„æ–‡ä»¶å</span></span><br><span class="line">    Adress_str=Adress.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>]                          <span class="comment"># æå–è·¯å¾„ä¸­çš„æ–‡ä»¶å</span></span><br><span class="line"></span><br><span class="line">    check_MDF(Document_Path)                                 <span class="comment"># è°ƒç”¨def check_MDF()å‡½æ•°</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="å¸¸ç”¨API">å¸¸ç”¨API</h3><ul><li>1.åŸºç¡€æ–‡ä»¶è¯»å–</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> asammdf <span class="keyword">import</span> MDF</span><br><span class="line"> </span><br><span class="line">f = <span class="string">r&quot;xxx.mdf&quot;</span></span><br><span class="line">mdf = MDF(f)</span><br><span class="line">signal = mdf.get(<span class="string">&#x27;ä¿¡å·å&#x27;</span>)</span><br><span class="line">data = signal.samples</span><br><span class="line">timestamps = signal.timestamps</span><br></pre></td></tr></table></figure><ul><li>2.ä¿¡å·æ•°æ®è·å–ä¸æ•°æ®è½¬æ¢</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chn_db = mdf.channels_db</span><br><span class="line"><span class="comment">#ä»£ç æ¥ä¸Š</span></span><br><span class="line">df = mdf.to_dataframe()</span><br></pre></td></tr></table></figure><ul><li>3.channelå’Œchannelgroupè·å–</li></ul><blockquote><p>mdfæ–‡ä»¶ä¸€èˆ¬æ˜¯ç”¨channelå’Œchannel groupç»„ç»‡çš„ï¼Œä¸€ä¸ªæ–‡ä»¶å¯èƒ½åŒ…å«å¤šä¸ªchnannel groupï¼Œä¸€ä¸ªchannel groupä¹Ÿå¯ä»¥åŒ…å«å¤šä¸ªchannelï¼Œchannelå’Œsignalä¸€ä¸€å¯¹åº”ï¼Œchannelä¿å­˜äº†ä¸€äº›æè¿°ä¿¡æ¯ï¼Œæ•°æ®å’Œæ—¶é—´æˆ³ä¿å­˜åœ¨signalé‡Œã€‚</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> group_index, (virtual_group_index, virtual_group) <span class="keyword">in</span> <span class="built_in">enumerate</span>(</span><br><span class="line">            mdf_ins.virtual_groups.items()</span><br><span class="line">        ):</span><br><span class="line">            <span class="keyword">if</span> virtual_group.cycles_nr == <span class="number">0</span> <span class="keyword">and</span> empty_channels == <span class="string">&quot;skip&quot;</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"> </span><br><span class="line">            channels = [</span><br><span class="line">                (<span class="literal">None</span>, gp_index, ch_index)</span><br><span class="line">                <span class="keyword">for</span> gp_index, channel_indexes <span class="keyword">in</span> mdf_ins.included_channels(</span><br><span class="line">                    virtual_group_index</span><br><span class="line">                )[virtual_group_index].items()</span><br><span class="line">                <span class="keyword">for</span> ch_index <span class="keyword">in</span> channel_indexes</span><br><span class="line">                <span class="keyword">if</span> ch_index != mdf_ins.masters_db.get(gp_index, <span class="literal">None</span>)</span><br><span class="line">            ]</span><br></pre></td></tr></table></figure><ul><li>4.åŸºç¡€æ–‡ä»¶åˆ›å»ºï¼ˆmf4ã€mdfï¼‰</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">*asammdf* MDF usage example</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"> </span><br><span class="line"><span class="keyword">from</span> asammdf <span class="keyword">import</span> MDF, Signal</span><br><span class="line"> </span><br><span class="line"><span class="comment"># create 3 Signal objects</span></span><br><span class="line"> </span><br><span class="line">timestamps = np.array([<span class="number">0.1</span>, <span class="number">0.2</span>, <span class="number">0.3</span>, <span class="number">0.4</span>, <span class="number">0.5</span>], dtype=np.float32)</span><br><span class="line"> </span><br><span class="line"><span class="comment"># unit8</span></span><br><span class="line">s_uint8 = Signal(</span><br><span class="line">    samples=np.array([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>], dtype=np.uint8),</span><br><span class="line">    timestamps=timestamps,</span><br><span class="line">    name=<span class="string">&quot;Uint8_Signal&quot;</span>,</span><br><span class="line">    unit=<span class="string">&quot;u1&quot;</span>,</span><br><span class="line">)</span><br><span class="line"><span class="comment"># int32</span></span><br><span class="line">s_int32 = Signal(</span><br><span class="line">    samples=np.array([-<span class="number">20</span>, -<span class="number">10</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">20</span>], dtype=np.int32),</span><br><span class="line">    timestamps=timestamps,</span><br><span class="line">    name=<span class="string">&quot;Int32_Signal&quot;</span>,</span><br><span class="line">    unit=<span class="string">&quot;i4&quot;</span>,</span><br><span class="line">)</span><br><span class="line"> </span><br><span class="line"><span class="comment"># float64</span></span><br><span class="line">s_float64 = Signal(</span><br><span class="line">    samples=np.array([-<span class="number">20</span>, -<span class="number">10</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">20</span>], dtype=np.float64),</span><br><span class="line">    timestamps=timestamps,</span><br><span class="line">    name=<span class="string">&quot;Float64_Signal&quot;</span>,</span><br><span class="line">    unit=<span class="string">&quot;f8&quot;</span>,</span><br><span class="line">)</span><br><span class="line"> </span><br><span class="line"><span class="comment"># create empty MDf version 4.00 file</span></span><br><span class="line"><span class="keyword">with</span> MDF(version=<span class="string">&quot;4.10&quot;</span>) <span class="keyword">as</span> mdf4:</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># append the 3 signals to the new file</span></span><br><span class="line">    signals = [s_uint8, s_int32, s_float64]</span><br><span class="line">    mdf4.append(signals, comment=<span class="string">&quot;Created by Python&quot;</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># save new file</span></span><br><span class="line">    mdf4.save(<span class="string">&quot;my_new_file.mf4&quot;</span>, overwrite=<span class="literal">True</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># convert new file to mdf version 3.10</span></span><br><span class="line">    mdf3 = mdf4.convert(version=<span class="string">&quot;3.10&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(mdf3.version)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># get the float signal</span></span><br><span class="line">    sig = mdf3.get(<span class="string">&quot;Float64_Signal&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(sig)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># cut measurement from 0.3s to end of measurement</span></span><br><span class="line">    mdf4_cut = mdf4.cut(start=<span class="number">0.3</span>)</span><br><span class="line">    mdf4_cut.get(<span class="string">&quot;Float64_Signal&quot;</span>).plot()</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># cut measurement from start of measurement to 0.4s</span></span><br><span class="line">    mdf4_cut = mdf4.cut(stop=<span class="number">0.45</span>)</span><br><span class="line">    mdf4_cut.get(<span class="string">&quot;Float64_Signal&quot;</span>).plot()</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># filter some signals from the file</span></span><br><span class="line">    mdf4 = mdf4.<span class="built_in">filter</span>([<span class="string">&quot;Int32_Signal&quot;</span>, <span class="string">&quot;Uint8_Signal&quot;</span>])</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># save using zipped transpose deflate blocks</span></span><br><span class="line">    mdf4.save(<span class="string">&quot;out.mf4&quot;</span>, compression=<span class="number">2</span>, overwrite=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ">å‚è€ƒ</h2><ul><li>[1].å®˜æ–¹APIæ–‡æ¡£: <a href="https://asammdf.readthedocs.io/en/master/">https://asammdf.readthedocs.io/en/master/</a></li><li>[2].æºä»£ç ï¼š<a href="https://github.com/danielhrisca/asammdf">https://github.com/danielhrisca/asammdf</a></li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨python è¯»å†™ ini config æ–‡ä»¶</title>
      <link href="/2023/11/06/python-ini-file-config/"/>
      <url>/2023/11/06/python-ini-file-config/</url>
      
        <content type="html"><![CDATA[<h1>ä½¿ç”¨python è¯»å†™ ini config æ–‡ä»¶</h1><blockquote><p>ä½¿ç”¨configparser åº“è¯»å†™iniæ–‡ä»¶,inié…ç½®æ–‡ä»¶ç”±èŠ‚ã€é”®ã€å€¼ç»„æˆ;ã€å‚æ•°ã€‘ï¼ˆé”®=å€¼ï¼‰ï¼šINIæ‰€åŒ…å«çš„æœ€åŸºæœ¬çš„â€œå…ƒç´ â€å°±æ˜¯å‚æ•°ï¼ˆparameterï¼‰ï¼Œæ¯ä¸ªå‚æ•°éƒ½æœ‰ä¸€ä¸ªnameå’Œä¸€ä¸ªvalueï¼Œnameå’Œvalueç”±ç­‰å·â€œ=â€éš”å¼€ï¼Œnameåœ¨ç­‰å·çš„å·¦è¾¹</p></blockquote><h2 id="ç¼–å†™">ç¼–å†™</h2><ul><li>iniæ–‡ä»¶åœ¨ç¨‹åºå¼€å‘ä¸­ç»å¸¸ä½¿ç”¨ï¼Œå…·ä½“å½¢å¼å¦‚ä¸‹</li></ul><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[minio_config_selected]</span></span><br><span class="line"><span class="comment">;æ³¨é‡Š section name èŠ‚ name = value</span></span><br><span class="line"><span class="attr">minio_config_id</span> = <span class="number">3245678</span></span><br><span class="line"><span class="attr">minio_server_ip</span> = <span class="number">11.22</span>.<span class="number">10.12</span></span><br><span class="line"><span class="attr">minio_server_port</span> = <span class="number">9000</span></span><br><span class="line"><span class="attr">minio_account</span> = <span class="number">1321</span></span><br><span class="line"><span class="attr">minio_password</span> = <span class="number">12312</span></span><br><span class="line"><span class="attr">mark_msg</span> = wewe</span><br><span class="line"><span class="attr">enable</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure><h2 id="è¯»å†™">è¯»å†™</h2><ul><li>è¯»å–iniæ–‡ä»¶</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_ini_config</span>(<span class="params">file_name, section, value_key</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è¯»å–æŒ‡å®šé…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="string">    :param file_name: ini file name</span></span><br><span class="line"><span class="string">    :param section: ini file section name</span></span><br><span class="line"><span class="string">    :param value_key: ini file content name</span></span><br><span class="line"><span class="string">    :return: select value</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># file_name = &quot;../config/config.ini&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Writing Data</span></span><br><span class="line">    config = configparser.ConfigParser()</span><br><span class="line"></span><br><span class="line">    config.read(file_name, encoding=<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    keys = [</span><br><span class="line">        <span class="string">&quot;host&quot;</span>,</span><br><span class="line">        <span class="string">&quot;user&quot;</span>,</span><br><span class="line">        <span class="string">&quot;port&quot;</span>,</span><br><span class="line">        <span class="string">&quot;password&quot;</span>,</span><br><span class="line">        <span class="string">&quot;port&quot;</span></span><br><span class="line">    ]</span><br><span class="line">    <span class="comment"># for key in keys:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        value = config.get(section, value_key)</span><br><span class="line">        <span class="comment"># logger.info(&quot;read ini file :&quot; + file_name + &quot;, ini file config content : &quot; + config.get(section, value_key))</span></span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    <span class="keyword">except</span> configparser.NoSectionError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># logger.info(&quot;normal&quot;)</span></span><br><span class="line">        logger.error(<span class="string">&quot;Error! section: &quot;</span> + section + <span class="string">&quot;, value_key :&quot;</span> + value_key + <span class="string">&quot;, value error content: &quot;</span> + <span class="built_in">str</span>(e))</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;log_dir&quot;</span></span><br><span class="line">    <span class="keyword">except</span> configparser.NoOptionError:</span><br><span class="line">        logger.error(<span class="string">f&quot;No option &#x27;<span class="subst">&#123;section&#125;</span>&#x27; in section , please re input config key&#x27;&#x27;&quot;</span> + value_key)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>2.å†™å…¥é…ç½®å†…å®¹</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_minio_config_to_file</span>(<span class="params">minio_config</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ini é…ç½®æ–‡ä»¶å†™å…¥</span></span><br><span class="line"><span class="string">    :param minio_config: å…ƒç»„ notice</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    iniPath = os.path.realpath(ini_file_path)  <span class="comment"># è¯»å–ç”Ÿæˆåè¿è¡Œæ—¶çš„ä¸´æ—¶æ–‡ä»¶ç›®å½•</span></span><br><span class="line">    logger.info(<span class="string">&quot;generate file pathï¼š&quot;</span> + iniPath)</span><br><span class="line">    conf = configparser.ConfigParser()</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(iniPath):</span><br><span class="line">        os.remove(iniPath)</span><br><span class="line">    logger.warning(<span class="string">&quot;Not Found config ini file , creating ini file ....&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(ini_path):</span><br><span class="line">        os.makedirs(ini_path)</span><br><span class="line">        logger.debug(<span class="string">&quot;dir not exists ,create dir&quot;</span>)</span><br><span class="line">    <span class="comment"># tes = open(iniPath, &#x27;a+&#x27;)</span></span><br><span class="line">    <span class="comment"># tes.close()</span></span><br><span class="line">    conf.read(iniPath, <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    logger.info(<span class="string">&quot;start generate config ini file :&quot;</span>)</span><br><span class="line"></span><br><span class="line">    conf.add_section(<span class="string">&quot;minio_config_selected&quot;</span>)</span><br><span class="line">    conf.<span class="built_in">set</span>(<span class="string">&quot;minio_config_selected&quot;</span>, <span class="string">&quot;minio_config_id&quot;</span>, minio_config[<span class="string">&#x27;minio_config_id&#x27;</span>])</span><br><span class="line">    conf.<span class="built_in">set</span>(<span class="string">&quot;minio_config_selected&quot;</span>, <span class="string">&quot;minio_server_ip&quot;</span>, minio_config[<span class="string">&#x27;minio_server_ip&#x27;</span>])  <span class="comment"># å†™å…¥é…ç½®å‚æ•°</span></span><br><span class="line">    conf.<span class="built_in">set</span>(<span class="string">&quot;minio_config_selected&quot;</span>, <span class="string">&quot;minio_server_port&quot;</span>, <span class="built_in">str</span>(minio_config[<span class="string">&#x27;minio_server_port&#x27;</span>]))</span><br><span class="line">    conf.<span class="built_in">set</span>(<span class="string">&quot;minio_config_selected&quot;</span>, <span class="string">&quot;minio_account&quot;</span>, minio_config[<span class="string">&#x27;minio_account&#x27;</span>])</span><br><span class="line">    conf.<span class="built_in">set</span>(<span class="string">&quot;minio_config_selected&quot;</span>, <span class="string">&quot;minio_password&quot;</span>, minio_config[<span class="string">&#x27;minio_password&#x27;</span>])</span><br><span class="line">    conf.<span class="built_in">set</span>(<span class="string">&quot;minio_config_selected&quot;</span>, <span class="string">&quot;mark_msg&quot;</span>, minio_config[<span class="string">&#x27;mark_msg&#x27;</span>])</span><br><span class="line">    conf.<span class="built_in">set</span>(<span class="string">&quot;minio_config_selected&quot;</span>, <span class="string">&quot;enable&quot;</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    <span class="comment"># conf.set(minio_config.minio_config_id, &quot;minio_server_ip&quot;, minio_config.minio_server_ip)</span></span><br><span class="line">    <span class="comment"># tes.write(conf.values())</span></span><br><span class="line">    conf.write(<span class="built_in">open</span>(iniPath, <span class="string">&#x27;a+&#x27;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">    conf.read(iniPath, <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    logger.info(<span class="string">&quot;config write finished , read test : &quot;</span> + conf.get(<span class="string">&quot;minio_config_selected&quot;</span>, <span class="string">&quot;minio_server_ip&quot;</span>))</span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäºSpring Cloudåº”ç”¨activitiæµç¨‹æ¡†æ¶</title>
      <link href="/2023/08/29/spring-cloud-activiti/"/>
      <url>/2023/08/29/spring-cloud-activiti/</url>
      
        <content type="html"><![CDATA[<h1>åŸºäºSpring Cloudåº”ç”¨activitiæµç¨‹æ¡†æ¶</h1><h2 id="activitiå·¥ä½œæµç®€ä»‹">activitiå·¥ä½œæµç®€ä»‹</h2><blockquote><p>Activiti æ˜¯ä¸€ä¸ªå¼€æºæ¶æ„çš„å·¥ä½œæµå¼•æ“ï¼ŒåŸºäºbpmn2.0 æ ‡å‡†è¿›è¡Œæµç¨‹å®šä¹‰ã€‚å…¶å‰èº«æ˜¯JBPMï¼ŒActiviti é€šè¿‡åµŒå…¥åˆ°ä¸šåŠ¡ç³»ç»Ÿå¼€å‘ä¸­è¿›è¡Œä½¿ç”¨ã€‚</p></blockquote><h2 id="å¼•å…¥ä¸ä½¿ç”¨">å¼•å…¥ä¸ä½¿ç”¨</h2><ul><li>1.maven pom.xmlæ–‡ä»¶å¼•å…¥</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- å¼•å…¥Activiti7 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.activiti<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activiti-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.1.0.M4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">           <span class="comment">&lt;!-- 7.1.0ç‰ˆæœ¬æ’é™¤mybatis é˜²æ­¢å†²çª --&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.activiti.dependencies<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activiti-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.1.0.M4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- ç”Ÿæˆæµç¨‹å›¾ --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.activiti<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activiti-image-generator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.1.0.M4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>2.ymlé…ç½®æ–‡ä»¶ç¼–å†™</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">16666</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">activity</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://$&#123;MYSQL_HOST:localhost&#125;:$&#123;MYSQL_PORT:3306&#125;/activity?useUnicode=true&amp;characterEncoding=UTF8&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">activity</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">activity</span></span><br><span class="line">    <span class="comment"># ä½¿ç”¨druidæ•°æ®æº</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">filters:</span> <span class="string">stat</span></span><br><span class="line">    <span class="attr">maxActive:</span> <span class="number">20</span></span><br><span class="line">    <span class="attr">initialSize:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">maxWait:</span> <span class="number">60000</span></span><br><span class="line">    <span class="attr">minIdle:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">timeBetweenEvictionRunsMillis:</span> <span class="number">60000</span></span><br><span class="line">    <span class="attr">minEvictableIdleTimeMillis:</span> <span class="number">300000</span></span><br><span class="line">    <span class="attr">validationQuery:</span> <span class="string">select</span> <span class="string">&#x27;x&#x27;</span></span><br><span class="line">    <span class="attr">testWhileIdle:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">testOnBorrow:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">testOnReturn:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">poolPreparedStatements:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">maxOpenPreparedStatements:</span> <span class="number">20</span></span><br><span class="line">  <span class="attr">activiti:</span></span><br><span class="line">    <span class="comment">#å…³é—­activitiè‡ªåŠ¨éƒ¨ç½²ï¼ˆä½¿ç”¨æµç¨‹è®¾è®¡å™¨éƒ¨ç½²ï¼Œä¸ä½¿ç”¨å…·ä½“æ–‡ä»¶è®¿é—®æ–¹å¼ï¼‰</span></span><br><span class="line">    <span class="attr">check-process-definitions:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment">#è®¾ç½®æµç¨‹å¼•æ“å¯åŠ¨å’Œå…³é—­æ—¶æ•°æ®åº“æ‰§è¡Œçš„ç­–ç•¥</span></span><br><span class="line">    <span class="comment">#falseï¼šfalseä¸ºé»˜è®¤å€¼ï¼Œè®¾ç½®ä¸ºè¯¥å€¼åï¼ŒActivitiåœ¨å¯åŠ¨æ—¶ï¼Œä¼šå¯¹æ¯”æ•°æ®åº“è¡¨ä¸­ä¿å­˜çš„ç‰ˆæœ¬ï¼Œå¦‚æœç‰ˆæœ¬ä¸åŒ¹é…æ—¶ï¼Œå°†åœ¨å¯åŠ¨æ—¶æŠ›å‡ºå¼‚å¸¸ã€‚</span></span><br><span class="line">    <span class="comment">#trueï¼šè®¾ç½®ä¸ºè¯¥å€¼åï¼ŒActivitiä¼šå¯¹æ•°æ®åº“ä¸­æ‰€æœ‰çš„è¡¨è¿›è¡Œæ›´æ–°ï¼Œå¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œåˆ™Activitiä¼šè‡ªåŠ¨åˆ›å»ºã€‚</span></span><br><span class="line">    <span class="comment">#create-dropï¼šActivitiå¯åŠ¨æ—¶ï¼Œä¼šæ‰§è¡Œæ•°æ®åº“è¡¨çš„åˆ›å»ºæ“ä½œï¼Œåœ¨Activitiå…³é—­æ—¶ï¼Œæ‰§è¡Œæ•°æ®åº“è¡¨çš„åˆ é™¤æ“ä½œã€‚</span></span><br><span class="line">    <span class="comment">#drop-createï¼šActivitiå¯åŠ¨æ—¶ï¼Œæ‰§è¡Œæ•°æ®åº“è¡¨çš„åˆ é™¤æ“ä½œåœ¨Activitiå…³é—­æ—¶ï¼Œä¼šæ‰§è¡Œæ•°æ®åº“è¡¨çš„åˆ›å»ºæ“ä½œã€‚</span></span><br><span class="line">    <span class="attr">database-schema-update:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment">#ä¿å­˜å†å²æ•°æ®çº§åˆ«è®¾ç½®ä¸ºfullæœ€é«˜çº§åˆ«ï¼Œä¾¿äºå†å²æ•°æ®çš„è¿½æº¯</span></span><br><span class="line">    <span class="comment">#noneï¼šä¸ä¿å­˜ä»»ä½•çš„å†å²æ•°æ®ï¼Œå› æ­¤ï¼Œåœ¨æµç¨‹æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè¿™æ˜¯æœ€é«˜æ•ˆçš„ã€‚</span></span><br><span class="line">    <span class="comment">#activityï¼šçº§åˆ«é«˜äºnoneï¼Œä¿å­˜æµç¨‹å®ä¾‹ä¸æµç¨‹è¡Œä¸ºï¼Œå…¶ä»–æ•°æ®ä¸ä¿å­˜ã€‚</span></span><br><span class="line">    <span class="comment">#auditï¼šé™¤activityçº§åˆ«ä¼šä¿å­˜çš„æ•°æ®å¤–ï¼Œè¿˜ä¼šä¿å­˜å…¨éƒ¨çš„æµç¨‹ä»»åŠ¡åŠå…¶å±æ€§ã€‚auditä¸ºhistoryçš„é»˜è®¤å€¼ã€‚</span></span><br><span class="line">    <span class="comment">#fullï¼šä¿å­˜å†å²æ•°æ®çš„æœ€é«˜çº§åˆ«ï¼Œé™¤äº†ä¼šä¿å­˜auditçº§åˆ«çš„æ•°æ®å¤–ï¼Œè¿˜ä¼šä¿å­˜å…¶ä»–å…¨éƒ¨æµç¨‹ç›¸å…³çš„ç»†èŠ‚æ•°æ®ï¼ŒåŒ…æ‹¬ä¸€äº›æµç¨‹å‚æ•°ç­‰ã€‚</span></span><br><span class="line">    <span class="attr">history-level:</span> <span class="string">full</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">base-path:</span> <span class="string">/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.acti:</span> <span class="string">DEBUG</span></span><br></pre></td></tr></table></figure><ul><li>3.å¯åŠ¨ç±»é…ç½®</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.acti;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.activiti.spring.boot.SecurityAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.annotation.MapperScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Desc</span> activity</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> jx111</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2019/11/29-16:28</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication(exclude = &#123; SecurityAutoConfiguration.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActivityApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(ActivityApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨ï¼š@SpringBootApplication(exclude = { SecurityAutoConfiguration.class}) æ’é™¤æ³¨è§£ï¼Œå–æ¶ˆç™»é™†é™åˆ¶ã€‚<br>å¯åŠ¨æœåŠ¡åï¼Œå¯åœ¨æ•°æ®åº“ä¸­è§‚å¯Ÿåˆ°è¡¨åä»¥act_ä¸ºé¦–çš„25å¼ è¡¨ç”Ÿæˆã€‚</p></blockquote><h2 id="æ•´åˆå‘å¸ƒ">æ•´åˆå‘å¸ƒ</h2><h3 id="spring-cloudæ•´åˆSpringSecurity">spring cloudæ•´åˆSpringSecurity</h3><ul><li>1.æ·»åŠ å·¥å…·ç±»</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.czq.image.util;</span><br><span class="line"></span><br><span class="line"><span class="comment">//import com.czq.image.dao.UserRepository.java;</span></span><br><span class="line"><span class="keyword">import</span> com.czq.image.dao.SysUserRepository;</span><br><span class="line"><span class="comment">//import com.czq.image.service.impl.MyUserD??etailsService;</span></span><br><span class="line"><span class="keyword">import</span> com.czq.model.image.entity.SysUserEntity;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.AuthorizationScope;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.AuthorityUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.security.Permission;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor(onConstructor = @__(@Autowired))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityUtil</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    public SecurityUtil() &#123;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logInAs</span><span class="params">(String username)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">UserDetails</span> <span class="variable">user</span> <span class="operator">=</span> userDetailsService.loadUserByUsername(username);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;User &quot;</span> + username + <span class="string">&quot; doesn&#x27;t exist, please provide a valid user&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        SecurityContextHolder.setContext(<span class="keyword">new</span> <span class="title class_">SecurityContextImpl</span>(<span class="keyword">new</span> <span class="title class_">Authentication</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;</span><br><span class="line">                <span class="keyword">return</span> user.getAuthorities();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Object <span class="title function_">getCredentials</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> user.getPassword();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Object <span class="title function_">getDetails</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> user;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Object <span class="title function_">getPrincipal</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> user;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAuthenticated</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAuthenticated</span><span class="params">(<span class="type">boolean</span> isAuthenticated)</span> <span class="keyword">throws</span> IllegalArgumentException &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> user.getUsername();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line">        org.activiti.engine.impl.identity.Authentication.setAuthenticatedUserId(username);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>2.æ·»åŠ é…ç½®ç±»</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.czq.image.config;</span><br><span class="line"></span><br><span class="line"><span class="comment">//import com.czq.image.service.impl.MyUserDetailsService;</span></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.WebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.provisioning.InMemoryUserDetailsManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.firewall.HttpFirewall;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.firewall.StrictHttpFirewall;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.CorsConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.CorsConfigurationSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.cors.UrlBasedCorsConfigurationSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoApplicationConfiguration</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(DemoApplicationConfiguration.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        auth.userDetailsService(myUserDetailsService());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">myUserDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">InMemoryUserDetailsManager</span> <span class="variable">inMemoryUserDetailsManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line"></span><br><span class="line">        String[][] usersGroupsAndRoles = &#123;</span><br><span class="line">                &#123;<span class="string">&quot;salaboy&quot;</span>, <span class="string">&quot;password&quot;</span>, <span class="string">&quot;ROLE_ACTIVITI_USER&quot;</span>, <span class="string">&quot;GROUP_activitiTeam&quot;</span>&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;ryandawsonuk&quot;</span>, <span class="string">&quot;password&quot;</span>, <span class="string">&quot;ROLE_ACTIVITI_USER&quot;</span>, <span class="string">&quot;GROUP_activitiTeam&quot;</span>&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;erdemedeiros&quot;</span>, <span class="string">&quot;password&quot;</span>, <span class="string">&quot;ROLE_ACTIVITI_USER&quot;</span>, <span class="string">&quot;GROUP_activitiTeam&quot;</span>&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;other&quot;</span>, <span class="string">&quot;password&quot;</span>, <span class="string">&quot;ROLE_ACTIVITI_USER&quot;</span>, <span class="string">&quot;GROUP_otherTeam&quot;</span>&#125;,</span><br><span class="line">                &#123;<span class="string">&quot;admin&quot;</span>, <span class="string">&quot;password&quot;</span>, <span class="string">&quot;ROLE_ACTIVITI_ADMIN&quot;</span>&#125;,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String[] user : usersGroupsAndRoles) &#123;</span><br><span class="line">            List&lt;String&gt; authoritiesStrings = Arrays.asList(Arrays.copyOfRange(user, <span class="number">2</span>, user.length));</span><br><span class="line">            logger.info(<span class="string">&quot;&gt; Registering new user: &quot;</span> + user[<span class="number">0</span>] + <span class="string">&quot; with the following Authorities[&quot;</span> + authoritiesStrings + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">            inMemoryUserDetailsManager.createUser(<span class="keyword">new</span> <span class="title class_">User</span>(user[<span class="number">0</span>], passwordEncoder().encode(user[<span class="number">1</span>]),</span><br><span class="line">                    authoritiesStrings.stream().map(s -&gt; <span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(s)).collect(Collectors.toList())));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> inMemoryUserDetailsManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">                .csrf().disable()</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                .anyRequest().permitAll()</span><br><span class="line"><span class="comment">//                .authenticated()</span></span><br><span class="line">                .and()</span><br><span class="line"><span class="comment">//                .cors()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//                .and().</span></span><br><span class="line">                .httpBasic();</span><br><span class="line"><span class="comment">//                .and()</span></span><br><span class="line"><span class="comment">//                .cors(c -&gt; &#123;</span></span><br><span class="line"><span class="comment">//Â Â Â Â Â Â Â Â Â Â Â              CorsConfigurationSource source = request -&gt; &#123;</span></span><br><span class="line"><span class="comment">//Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â          CorsConfiguration config = new CorsConfiguration();</span></span><br><span class="line"><span class="comment">//Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â          config.setAllowedOrigins(Arrays.asList(&quot;*&quot;));</span></span><br><span class="line"><span class="comment">//Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â          config.setAllowedMethods(Arrays.asList(&quot;*&quot;));</span></span><br><span class="line"><span class="comment">//Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  return config;</span></span><br><span class="line"><span class="comment">//Â Â Â Â Â Â Â Â Â Â Â  &#125;;</span></span><br><span class="line"><span class="comment">//Â Â Â Â Â Â Â Â Â Â Â  c.configurationSource(source);</span></span><br><span class="line"><span class="comment">//Â Â Â Â Â Â Â  &#125;);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        web.ignoring().antMatchers(<span class="string">&quot;/css/**&quot;</span>, <span class="string">&quot;/js/**&quot;</span>,<span class="string">&quot;/resources/**&quot;</span>,<span class="string">&quot;/templates/**&quot;</span>,<span class="string">&quot;/lib/**&quot;</span>,<span class="string">&quot;/file/**&quot;</span>,<span class="string">&quot;/img/**&quot;</span>,<span class="string">&quot;/swagger-ui.html&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    CorsConfigurationSource <span class="title function_">corsConfigurationSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">CorsConfiguration</span> <span class="variable">configuration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsConfiguration</span>();</span><br><span class="line">        configuration.setAllowedOrigins(Arrays.asList(<span class="string">&quot;*&quot;</span>));</span><br><span class="line">        configuration.setAllowedMethods(Arrays.asList(<span class="string">&quot;PUT&quot;</span>, <span class="string">&quot;DELETE&quot;</span>, <span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>, <span class="string">&quot;OPTIONS&quot;</span>, <span class="string">&quot;HEAD&quot;</span>));</span><br><span class="line">        configuration.setAllowCredentials(<span class="literal">true</span>);</span><br><span class="line">        configuration.setExposedHeaders(Arrays.asList( <span class="string">&quot;access-control-allow-headers&quot;</span>,</span><br><span class="line">                <span class="string">&quot;access-control-allow-methods&quot;</span>,</span><br><span class="line">                <span class="string">&quot;access-control-allow-origin&quot;</span>,</span><br><span class="line">                <span class="string">&quot;access-Control-allow-credentials&quot;</span>,</span><br><span class="line">                <span class="string">&quot;access-control-max-age&quot;</span>,</span><br><span class="line">                <span class="string">&quot;X-Frame-Options&quot;</span>));</span><br><span class="line">        configuration.setAllowedHeaders(Arrays.asList(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;X-Requested-With&quot;</span>, <span class="string">&quot;accept&quot;</span>, <span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Origin&quot;</span>, <span class="string">&quot;Access-Control-Request-Method&quot;</span>, <span class="string">&quot;Access-Control-Request-Headers&quot;</span>));</span><br><span class="line">        configuration.setMaxAge(<span class="number">3600L</span>);</span><br><span class="line"><span class="comment">//        configuratio</span></span><br><span class="line">        <span class="type">UrlBasedCorsConfigurationSource</span> <span class="variable">source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlBasedCorsConfigurationSource</span>();</span><br><span class="line">        source.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, configuration);</span><br><span class="line">        <span class="keyword">return</span> source;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> HttpFirewall <span class="title function_">allowUrlEncodedSlashHttpFirewall</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">StrictHttpFirewall</span> <span class="variable">firewall</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StrictHttpFirewall</span>();</span><br><span class="line">        firewall.setAllowUrlEncodedSlash(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> firewall;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="bpnmæ–‡ä»¶ç»˜åˆ¶ç”Ÿæˆ">bpnmæ–‡ä»¶ç»˜åˆ¶ç”Ÿæˆ</h3><ul><li>1.demo.xml</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">definitions</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.omg.org/spec/BPMN/20100524/MODEL&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="attr">xmlns:xsd</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span> <span class="attr">xmlns:activiti</span>=<span class="string">&quot;http://activiti.org/bpmn&quot;</span> <span class="attr">xmlns:bpmndi</span>=<span class="string">&quot;http://www.omg.org/spec/BPMN/20100524/DI&quot;</span> <span class="attr">xmlns:omgdc</span>=<span class="string">&quot;http://www.omg.org/spec/DD/20100524/DC&quot;</span> <span class="attr">xmlns:omgdi</span>=<span class="string">&quot;http://www.omg.org/spec/DD/20100524/DI&quot;</span> <span class="attr">typeLanguage</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span> <span class="attr">expressionLanguage</span>=<span class="string">&quot;http://www.w3.org/1999/XPath&quot;</span> <span class="attr">targetNamespace</span>=<span class="string">&quot;http://www.activiti.org/test&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">&quot;myProcess_1&quot;</span> <span class="attr">name</span>=<span class="string">&quot;My process&quot;</span> <span class="attr">isExecutable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">&quot;startevent1&quot;</span> <span class="attr">name</span>=<span class="string">&quot;Start&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">startEvent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">&quot;usertask1&quot;</span> <span class="attr">name</span>=<span class="string">&quot;one&quot;</span> <span class="attr">activiti:candidateGroups</span>=<span class="string">&quot;activitiTeam&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;flow1&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;startevent1&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;usertask1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">id</span>=<span class="string">&quot;usertask2&quot;</span> <span class="attr">name</span>=<span class="string">&quot;two&quot;</span> <span class="attr">activiti:candidateGroups</span>=<span class="string">&quot;activitiTeam&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">userTask</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;flow2&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;usertask1&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;usertask2&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">&quot;endevent1&quot;</span> <span class="attr">name</span>=<span class="string">&quot;End&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">endEvent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">&quot;flow3&quot;</span> <span class="attr">sourceRef</span>=<span class="string">&quot;usertask2&quot;</span> <span class="attr">targetRef</span>=<span class="string">&quot;endevent1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">process</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bpmndi:BPMNDiagram</span> <span class="attr">id</span>=<span class="string">&quot;BPMNDiagram_myProcess_1&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bpmndi:BPMNPlane</span> <span class="attr">bpmnElement</span>=<span class="string">&quot;myProcess_1&quot;</span> <span class="attr">id</span>=<span class="string">&quot;BPMNPlane_myProcess_1&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNShape</span> <span class="attr">bpmnElement</span>=<span class="string">&quot;startevent1&quot;</span> <span class="attr">id</span>=<span class="string">&quot;BPMNShape_startevent1&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdc:Bounds</span> <span class="attr">height</span>=<span class="string">&quot;35.0&quot;</span> <span class="attr">width</span>=<span class="string">&quot;35.0&quot;</span> <span class="attr">x</span>=<span class="string">&quot;50.0&quot;</span> <span class="attr">y</span>=<span class="string">&quot;160.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdc:Bounds</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNShape</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNShape</span> <span class="attr">bpmnElement</span>=<span class="string">&quot;usertask1&quot;</span> <span class="attr">id</span>=<span class="string">&quot;BPMNShape_usertask1&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdc:Bounds</span> <span class="attr">height</span>=<span class="string">&quot;55.0&quot;</span> <span class="attr">width</span>=<span class="string">&quot;105.0&quot;</span> <span class="attr">x</span>=<span class="string">&quot;130.0&quot;</span> <span class="attr">y</span>=<span class="string">&quot;150.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdc:Bounds</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNShape</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNShape</span> <span class="attr">bpmnElement</span>=<span class="string">&quot;usertask2&quot;</span> <span class="attr">id</span>=<span class="string">&quot;BPMNShape_usertask2&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdc:Bounds</span> <span class="attr">height</span>=<span class="string">&quot;55.0&quot;</span> <span class="attr">width</span>=<span class="string">&quot;105.0&quot;</span> <span class="attr">x</span>=<span class="string">&quot;280.0&quot;</span> <span class="attr">y</span>=<span class="string">&quot;150.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdc:Bounds</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNShape</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNShape</span> <span class="attr">bpmnElement</span>=<span class="string">&quot;endevent1&quot;</span> <span class="attr">id</span>=<span class="string">&quot;BPMNShape_endevent1&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdc:Bounds</span> <span class="attr">height</span>=<span class="string">&quot;35.0&quot;</span> <span class="attr">width</span>=<span class="string">&quot;35.0&quot;</span> <span class="attr">x</span>=<span class="string">&quot;430.0&quot;</span> <span class="attr">y</span>=<span class="string">&quot;160.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdc:Bounds</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNShape</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNEdge</span> <span class="attr">bpmnElement</span>=<span class="string">&quot;flow1&quot;</span> <span class="attr">id</span>=<span class="string">&quot;BPMNEdge_flow1&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">&quot;85.0&quot;</span> <span class="attr">y</span>=<span class="string">&quot;177.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">&quot;130.0&quot;</span> <span class="attr">y</span>=<span class="string">&quot;177.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNEdge</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNEdge</span> <span class="attr">bpmnElement</span>=<span class="string">&quot;flow2&quot;</span> <span class="attr">id</span>=<span class="string">&quot;BPMNEdge_flow2&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">&quot;235.0&quot;</span> <span class="attr">y</span>=<span class="string">&quot;177.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">&quot;280.0&quot;</span> <span class="attr">y</span>=<span class="string">&quot;177.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNEdge</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bpmndi:BPMNEdge</span> <span class="attr">bpmnElement</span>=<span class="string">&quot;flow3&quot;</span> <span class="attr">id</span>=<span class="string">&quot;BPMNEdge_flow3&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">&quot;385.0&quot;</span> <span class="attr">y</span>=<span class="string">&quot;177.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">omgdi:waypoint</span> <span class="attr">x</span>=<span class="string">&quot;430.0&quot;</span> <span class="attr">y</span>=<span class="string">&quot;177.0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">omgdi:waypoint</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNEdge</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bpmndi:BPMNPlane</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bpmndi:BPMNDiagram</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">definitions</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="æ¥å£å®šä¹‰ä¸ä½¿ç”¨">æ¥å£å®šä¹‰ä¸ä½¿ç”¨</h3><ul><li>1.æ¥å£å®šä¹‰</li></ul><blockquote><p>APIæ–‡ä»¶æ¥å£ç¼–å†™</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.czq.api.image;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//import com.czq.common.model.response.Result;</span></span><br><span class="line"><span class="keyword">import</span> com.czq.model.image.entity.Result;</span><br><span class="line"><span class="keyword">import</span> com.czq.model.image.request.AddXMLRequest;</span><br><span class="line"><span class="comment">//import com.czq.model.image.response.Result;</span></span><br><span class="line"><span class="keyword">import</span> com.czq.model.user.UserMessage;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Api(value = &quot;BPMN XMLæ–‡ä»¶å¤„ç†æ¥å£&quot;, description = &quot;BPMN XMLå¤„ç†å…¬å…±æ¥å£&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BPMNControllerApi</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;ä¸Šä¼ BPMNå†…å®¹å­—ç¬¦ä¸²éƒ¨ç½²&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">postBPMNAndDeployment</span><span class="params">(AddXMLRequest addXMLRequest)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;XMLæ–‡ä»¶ä¸Šä¼ éƒ¨ç½²&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">uploadFileAndDeployment</span><span class="params">(</span></span><br><span class="line"><span class="params">            MultipartFile processFile,</span></span><br><span class="line"><span class="params">            String processName)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;è·å–æµç¨‹èµ„æºæ–‡ä»¶&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getProcessDefineXML</span><span class="params">(String deploymentId, String resourceName, HttpServletResponse response)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;å¯åŠ¨æµç¨‹&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">startProcess</span><span class="params">(</span></span><br><span class="line"><span class="params">            String processDefinitionKey,</span></span><br><span class="line"><span class="params">            String instanceName,</span></span><br><span class="line"><span class="params">            UserMessage userDetail)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;æŒ‚èµ·æµç¨‹&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">suspendInstance</span><span class="params">(String instanceId)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;æ¿€æ´»æµç¨‹&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">resumeInstance</span><span class="params">(String instanceId)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;å®Œæˆä»»åŠ¡&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">completeTask</span><span class="params">(String taskId)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;è·å–ä»»åŠ¡&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">getTasks</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;activitiæµç¨‹æµ‹è¯•&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">testActiviti</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>2.controllerä¸­è°ƒç”¨serviceå®ç°åŠŸèƒ½</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.czq.image.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.czq.api.image.BPMNControllerApi;</span><br><span class="line"><span class="comment">//import com.czq.common.model.response.Result;</span></span><br><span class="line"><span class="keyword">import</span> com.czq.image.service.BPMNService;</span><br><span class="line"><span class="keyword">import</span> com.czq.model.image.entity.Result;</span><br><span class="line"><span class="keyword">import</span> com.czq.model.image.request.AddXMLRequest;</span><br><span class="line"><span class="comment">//import com.czq.model.image.response.Result;v/</span></span><br><span class="line"><span class="keyword">import</span> com.czq.model.user.UserMessage;</span><br><span class="line"><span class="keyword">import</span> org.activiti.api.task.model.Task;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/bpmn&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BPMNController</span> <span class="keyword">implements</span> <span class="title class_">BPMNControllerApi</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    BPMNService bpmnService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/postBPMNAndDeployment&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">postBPMNAndDeployment</span><span class="params">(<span class="meta">@RequestBody</span> AddXMLRequest addXMLRequest)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> bpmnService.postBPMNAndDeployment(addXMLRequest);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/uploadFileAndDeployment&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">uploadFileAndDeployment</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;processFile&quot;)</span>MultipartFile processFile,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(value = &quot;processName&quot;,required = false)</span> String processName)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> bpmnService.uploadFileAndDeployment(processFile,processName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getProcessDefineXML&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getProcessDefineXML</span><span class="params">(String deploymentId, String resourceName, HttpServletResponse response)</span> &#123;</span><br><span class="line">         bpmnService.getProcessDefineXML(deploymentId,resourceName,response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/startProcess&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">startProcess</span><span class="params">(String processDefinitionKey, String instanceName, UserMessage userDetail)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> bpmnService.startProcess(processDefinitionKey,instanceName,userDetail);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/suspendInstance/&#123;instanceId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">suspendInstance</span><span class="params">(<span class="meta">@PathVariable</span> String instanceId)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bpmnService.suspendInstance(instanceId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/resumeInstance/&#123;instanceId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">resumeInstance</span><span class="params">(<span class="meta">@PathVariable</span> String instanceId)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bpmnService.resumeInstance(instanceId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/completeTask/&#123;taskId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">completeTask</span><span class="params">(<span class="meta">@PathVariable</span> String taskId)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bpmnService.completeTask(taskId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getTasks&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">getTasks</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> bpmnService.getTasks();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/testActiviti&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">testActiviti</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> bpmnService.testActiviti();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>3.ç¼–å†™Controllerè°ƒç”¨çš„æœåŠ¡ï¼ŒæœåŠ¡é€šè¿‡è°ƒç”¨activitiæ¡†æ¶æä¾›æ¥å£å®Œæˆå„é¡¹åŠŸèƒ½</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.czq.image.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.czq.common.model.response.CommonCode;</span><br><span class="line"><span class="comment">//import com.czq.common.model.response.Result;</span></span><br><span class="line"><span class="keyword">import</span> com.czq.image.service.BPMNService;</span><br><span class="line"><span class="keyword">import</span> com.czq.image.util.SecurityUtil;</span><br><span class="line"><span class="keyword">import</span> com.czq.model.image.entity.Result;</span><br><span class="line"><span class="keyword">import</span> com.czq.model.image.entity.vo.HistoricActivityInstanceVO;</span><br><span class="line"><span class="keyword">import</span> com.czq.model.image.entity.vo.TaskVO;</span><br><span class="line"><span class="keyword">import</span> com.czq.model.image.entity.vo.VOConverter;</span><br><span class="line"><span class="keyword">import</span> com.czq.model.image.request.AddXMLRequest;</span><br><span class="line"><span class="comment">//import com.czq.model.image.response.Result;/</span></span><br><span class="line"><span class="keyword">import</span> com.czq.model.user.UserMessage;</span><br><span class="line"><span class="keyword">import</span> org.activiti.api.process.model.ProcessDefinition;</span><br><span class="line"><span class="keyword">import</span> org.activiti.api.process.model.ProcessInstance;</span><br><span class="line"><span class="keyword">import</span> org.activiti.api.process.model.builders.ProcessPayloadBuilder;</span><br><span class="line"><span class="keyword">import</span> org.activiti.api.process.model.payloads.StartProcessPayload;</span><br><span class="line"><span class="keyword">import</span> org.activiti.api.process.runtime.ProcessRuntime;</span><br><span class="line"><span class="keyword">import</span> org.activiti.api.runtime.shared.query.Page;</span><br><span class="line"><span class="keyword">import</span> org.activiti.api.runtime.shared.query.Pageable;</span><br><span class="line"><span class="keyword">import</span> org.activiti.api.task.model.Task;</span><br><span class="line"><span class="keyword">import</span> org.activiti.api.task.model.builders.TaskPayloadBuilder;</span><br><span class="line"><span class="keyword">import</span> org.activiti.api.task.runtime.TaskRuntime;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.HistoryService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.RepositoryService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.RuntimeService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.history.*;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.repository.Deployment;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.FilenameUtils;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.access.annotation.Secured;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipInputStream;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BPMNServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BPMNService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RepositoryService repositoryService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    ProcessRuntime processRuntime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    TaskRuntime taskRuntime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RuntimeService runtimeService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    HistoryService historyService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(BPMNServiceImpl.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Autowired</span></span><br><span class="line"><span class="comment">//    private ProcessRuntime processRuntime;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Autowired</span></span><br><span class="line"><span class="comment">//    private TaskRuntime taskRuntime;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">postBPMNAndDeployment</span><span class="params">(AddXMLRequest addXMLRequest)</span> &#123;</span><br><span class="line">        <span class="type">Deployment</span> <span class="variable">deploy</span> <span class="operator">=</span> repositoryService.createDeployment()</span><br><span class="line">                <span class="comment">// .addString ç¬¬ä¸€æ¬¡å‚æ•°çš„åå­—å¦‚æœæ²¡æœ‰æ·»åŠ .bpmnçš„è¯ï¼Œä¸ä¼šæ’å…¥åˆ° ACT_RE_DEPLOYMENT è¡¨ä¸­</span></span><br><span class="line">                .addString(addXMLRequest.getProcessName() + <span class="string">&quot;.bpmn&quot;</span>, addXMLRequest.getBpmnContent())</span><br><span class="line">                .name(addXMLRequest.getProcessName())</span><br><span class="line">                .deploy();</span><br><span class="line">        <span class="keyword">return</span> Result.ok(deploy);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">uploadFileAndDeployment</span><span class="params">(MultipartFile processFile,</span></span><br><span class="line"><span class="params">                                          String processName)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">originalFilename</span> <span class="operator">=</span> processFile.getOriginalFilename();</span><br><span class="line">        <span class="type">String</span> <span class="variable">extension</span> <span class="operator">=</span> FilenameUtils.getExtension(originalFilename);</span><br><span class="line">        <span class="keyword">if</span> (processName != <span class="literal">null</span>) &#123;</span><br><span class="line">            processName = originalFilename;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> processFile.getInputStream();</span><br><span class="line">            <span class="type">Deployment</span> <span class="variable">deployment</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;zip&quot;</span>.equals(extension)) &#123;</span><br><span class="line">                <span class="comment">// å‹ç¼©åŒ…éƒ¨ç½²æ–¹å¼</span></span><br><span class="line">                <span class="type">ZipInputStream</span> <span class="variable">zipInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZipInputStream</span>(inputStream);</span><br><span class="line">                deployment = repositoryService.createDeployment().addZipInputStream(zipInputStream).name(processName).deploy();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;bpmn&quot;</span>.equals(extension)) &#123;</span><br><span class="line">                <span class="comment">// bpmnæ–‡ä»¶éƒ¨ç½²æ–¹å¼</span></span><br><span class="line">                deployment = repositoryService.createDeployment().addInputStream(originalFilename, inputStream).name(processName).deploy();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> Result.ok(deployment);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Result.error(<span class="string">&quot;deployment object null !&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getProcessDefineXML</span><span class="params">(String deploymentId, String resourceName, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> repositoryService.getResourceAsStream(deploymentId, resourceName);</span><br><span class="line">            <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> inputStream.available();</span><br><span class="line">            <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[count];</span><br><span class="line">            response.setContentType(<span class="string">&quot;text/xml&quot;</span>);</span><br><span class="line">            <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">            <span class="keyword">while</span> (inputStream.read(bytes) != -<span class="number">1</span>) &#123;</span><br><span class="line">                outputStream.write(bytes);</span><br><span class="line">            &#125;</span><br><span class="line">            inputStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">startProcess</span><span class="params">(String processDefinitionKey, String instanceName, UserMessage userDetail)</span> &#123;</span><br><span class="line">        <span class="type">ProcessInstance</span> <span class="variable">processInstance</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">StartProcessPayload</span> <span class="variable">startProcessPayload</span> <span class="operator">=</span> ProcessPayloadBuilder.start().withProcessDefinitionKey(processDefinitionKey)</span><br><span class="line">                    .withBusinessKey(<span class="string">&quot;businessKey&quot;</span>)</span><br><span class="line">                    .withVariable(<span class="string">&quot;sponsor&quot;</span>, userDetail.getUsername())</span><br><span class="line">                    .withName(instanceName).build();</span><br><span class="line">            processInstance = processRuntime.start(startProcessPayload);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line"><span class="comment">//                System.out.println(e);</span></span><br><span class="line">            <span class="keyword">return</span> Result.error(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(processInstance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">suspendInstance</span><span class="params">(String instanceId)</span> &#123;</span><br><span class="line">        <span class="type">ProcessInstance</span> <span class="variable">processInstance</span> <span class="operator">=</span> processRuntime.suspend(ProcessPayloadBuilder.suspend().withProcessInstanceId(instanceId).build());</span><br><span class="line">        <span class="keyword">return</span> Result.ok(processInstance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">resumeInstance</span><span class="params">(String instanceId)</span> &#123;</span><br><span class="line">        <span class="type">ProcessInstance</span> <span class="variable">processInstance</span> <span class="operator">=</span> processRuntime</span><br><span class="line">                .resume(ProcessPayloadBuilder.resume().withProcessInstanceId(instanceId).build());</span><br><span class="line">        <span class="keyword">return</span> Result.ok(processInstance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">completeTask</span><span class="params">(String taskId)</span> &#123;</span><br><span class="line">        <span class="type">Task</span> <span class="variable">task</span> <span class="operator">=</span> taskRuntime.task(taskId);</span><br><span class="line">        <span class="keyword">if</span> (task.getAssignee() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// è¯´æ˜ä»»åŠ¡éœ€è¦æ‹¾å–</span></span><br><span class="line">            taskRuntime.claim(TaskPayloadBuilder.claim().withTaskId(taskId).build());</span><br><span class="line">        &#125;</span><br><span class="line">        taskRuntime.complete(TaskPayloadBuilder.complete().withTaskId(taskId).build());</span><br><span class="line">        <span class="keyword">return</span> Result.ok(task);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">getTasks</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="comment">//        SecurityUtil securityUtil = new SecurityUtil();</span></span><br><span class="line"><span class="comment">//        securityUtil.logInAs(&quot;jack&quot;);</span></span><br><span class="line"><span class="comment">//        Page&lt;Task&gt; taskPage = runtimeService.(Pageable.of(0,100));</span></span><br><span class="line">        Page&lt;Task&gt; taskPage = taskRuntime.tasks(Pageable.of(<span class="number">0</span>, <span class="number">100</span>));</span><br><span class="line">        List&lt;Task&gt; tasks = taskPage.getContent();</span><br><span class="line">        List&lt;TaskVO&gt; taskVOS = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Task task : tasks) &#123;</span><br><span class="line">            <span class="type">TaskVO</span> <span class="variable">taskVO</span> <span class="operator">=</span> (TaskVO) task;</span><br><span class="line"><span class="comment">//            TaskVO taskVO = TaskVO.o/ftask;</span></span><br><span class="line">            <span class="type">ProcessInstance</span> <span class="variable">instance</span> <span class="operator">=</span> processRuntime.processInstance(task.getProcessInstanceId());</span><br><span class="line">            taskVO.setInstanceName(instance.getName());</span><br><span class="line">            taskVOS.add(taskVO);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(taskVOS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">createLoginUser</span><span class="params">(UserMessage user)</span> &#123;</span><br><span class="line"><span class="comment">//        Set&lt;String&gt; postCode = sysPostService.selectPostCodeByUserId(user.getId());</span></span><br><span class="line"><span class="comment">//        postCode = postCode.parallelStream().map( s -&gt;  &quot;GROUP_&quot; + s).collect(Collectors.toSet());</span></span><br><span class="line"><span class="comment">//        postCode.add(&quot;ROLE_ACTIVITI_USER&quot;);</span></span><br><span class="line"><span class="comment">//        List&lt;SimpleGrantedAuthority&gt; collect = postCode.stream().map(s -&gt; new SimpleGrantedAuthority(s)).collect(Collectors.toList());</span></span><br><span class="line"><span class="comment">//        return new LoginUser(user, permissionService.getMenuPermission(user), collect);</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">testActiviti</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// é¦–å…ˆï¼Œå–å‡ºé¡¹ç›®ä¸­çš„æœ€å¤š 10 ä¸ªæµç¨‹å®šä¹‰</span></span><br><span class="line">        Page&lt;ProcessDefinition&gt; processDefinitionPage = processRuntime.processDefinitions(Pageable.of(<span class="number">0</span>, <span class="number">10</span>));</span><br><span class="line">        <span class="keyword">if</span> (processDefinitionPage.getTotalItems() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ç„¶åï¼Œå¯¹å–å‡ºçš„æµç¨‹è¿›è¡Œå¯åŠ¨</span></span><br><span class="line">            <span class="keyword">for</span> (ProcessDefinition definition : processDefinitionPage.getContent()) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot; æµç¨‹å®šä¹‰ä¿¡æ¯ï¼š&quot;</span> + definition);</span><br><span class="line">                processRuntime.start(ProcessPayloadBuilder</span><br><span class="line">                        .start()</span><br><span class="line">                        .withProcessDefinitionId(definition.getId())</span><br><span class="line">                        .build());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å®Œæˆæµç¨‹å¯åŠ¨åï¼Œç”±äºå½“å‰é¡¹ç›®ä¸­åªæœ‰ other.bpmn ä¸€ä¸ªæµç¨‹ï¼Œä¸”è¯¥æµç¨‹åœ¨è®¾è®¡æ—¶ï¼Œå·²åˆ†é…ç»™activitiTeam ç»„</span></span><br><span class="line">        <span class="comment">// å› æ­¤æˆ‘ä»¬ç™»å½•ä¸€ä¸ª activitiTeam ç»„æˆå‘˜ , è¯¥è´¦å·ä¿¡æ¯ä¼šè¢«è®¾ç½®åˆ° security ä¸Šä¸‹æ–‡ä¸­ï¼Œactivitiä¼šå¯¹å…¶ä¿¡æ¯è¿›è¡Œè¯»å–</span></span><br><span class="line">        <span class="comment">// è·å–å½“å‰ç”¨æˆ·ä»»åŠ¡ï¼Œæœ€å¤š 10 ä¸ª</span></span><br><span class="line">        Page&lt;Task&gt; taskPage = taskRuntime.tasks(Pageable.of(<span class="number">0</span>, <span class="number">10</span>));</span><br><span class="line">        <span class="comment">// ç”±äºç›®å‰åªæœ‰ä¸€ä¸ªæµç¨‹ï¼Œä¸¤ä¸ªä»»åŠ¡ï¼Œæˆ‘ä»¬å°è¯•ä¸€ä¸‹å®Œæˆä¸€ä¸ªï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆå˜åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> (taskPage.getTotalItems() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Task task : taskPage.getContent()) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot; ä»»åŠ¡ä¿¡æ¯1ï¼š&quot;</span> + task);</span><br><span class="line">                <span class="comment">// æ³¨æ„ï¼Œå®Œæˆä»»åŠ¡å‰å¿…é¡»å…ˆå£°æ˜</span></span><br><span class="line">                taskRuntime.claim(TaskPayloadBuilder.claim().withTaskId(task.getId()).build());</span><br><span class="line">                <span class="comment">// å®Œæˆä»»åŠ¡</span></span><br><span class="line">                taskRuntime.complete(TaskPayloadBuilder.complete().withTaskId(task.getId()).build()</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä¸Šä¸€è½®ä»»åŠ¡å®Œæˆï¼Œå†çœ‹ä¸€ä¸‹ï¼Œç°åœ¨æµç¨‹æ˜¯å¦èµ°åˆ°äº† second ï¼Ÿ</span></span><br><span class="line">        taskPage = taskRuntime.tasks(Pageable.of(<span class="number">0</span>, <span class="number">10</span>));</span><br><span class="line">        <span class="keyword">if</span> (taskPage.getTotalItems() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Task task : taskPage.getContent()) &#123;</span><br><span class="line">                logger.info(<span class="string">&quot;ä»»åŠ¡2: &quot;</span> + task);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(taskPage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> businessKey</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@desc</span> æŸ¥è¯¢å†å²è®°å½•</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;HistoricActivityInstanceVO&gt; <span class="title function_">getProcessHistoryByBusinessKey</span><span class="params">(String businessKey)</span> &#123;</span><br><span class="line">        <span class="type">ProcessInstance</span> <span class="variable">instance</span> <span class="operator">=</span> (ProcessInstance) runtimeService.createProcessInstanceQuery().processInstanceBusinessKey(businessKey).singleResult();</span><br><span class="line">        List&lt;HistoricActivityInstance&gt; historicActivityInstanceList = historyService.createHistoricActivityInstanceQuery().processInstanceId(instance.getId())</span><br><span class="line">                .orderByHistoricActivityInstanceStartTime().asc().list();</span><br><span class="line">        List&lt;HistoricActivityInstanceVO&gt; historicActivityInstanceVOList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        historicActivityInstanceList.forEach(historicActivityInstance -&gt; historicActivityInstanceVOList.add(VOConverter.getHistoricActivityInstanceVO(historicActivityInstance)));</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">instanceId</span> <span class="operator">=</span> <span class="string">&quot;111&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">taskId</span> <span class="operator">=</span> <span class="string">&quot;111&quot;</span>;</span><br><span class="line"><span class="comment">//        è¯¦æƒ…æŸ¥è¯¢+</span></span><br><span class="line">        <span class="type">HistoricDetailQuery</span> <span class="variable">historicDetailQuery</span> <span class="operator">=</span> historyService.createHistoricDetailQuery();</span><br><span class="line">        List&lt;HistoricDetail&gt; historicDetails = historicDetailQuery.processInstanceId(instanceId).orderByTime().list();</span><br><span class="line">        <span class="keyword">for</span> (HistoricDetail hd : historicDetails) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;æµç¨‹å®ä¾‹ID:&quot;</span> + hd.getProcessInstanceId());</span><br><span class="line">            System.out.println(<span class="string">&quot;æ´»åŠ¨å®ä¾‹ID:&quot;</span> + hd.getActivityInstanceId());</span><br><span class="line">            System.out.println(<span class="string">&quot;æ‰§è¡ŒID:&quot;</span> + hd.getTaskId());</span><br><span class="line">            System.out.println(<span class="string">&quot;è®°å½•æ—¶é—´:&quot;</span> + hd.getTime());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//        ä»»åŠ¡å†å²æµç¨‹æŸ¥è¯¢</span></span><br><span class="line">        <span class="type">HistoricTaskInstanceQuery</span> <span class="variable">historicTaskInstanceQuery</span> <span class="operator">=</span> historyService.createHistoricTaskInstanceQuery();</span><br><span class="line">        List&lt;HistoricTaskInstance&gt; taskInstances = historicTaskInstanceQuery.taskId(taskId).list();</span><br><span class="line">        <span class="keyword">for</span> (HistoricTaskInstance hti : taskInstances) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å¼€å§‹æ—¶é—´:&quot;</span> + hti.getStartTime());</span><br><span class="line">            System.out.println(<span class="string">&quot;ç»“æŸæ—¶é—´:&quot;</span> + hti.getEndTime());</span><br><span class="line">            System.out.println(<span class="string">&quot;ä»»åŠ¡æ‹¾å–æ—¶é—´:&quot;</span> + hti.getClaimTime());</span><br><span class="line">            System.out.println(<span class="string">&quot;åˆ é™¤åŸå› :&quot;</span> + hti.getDeleteReason());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> historicActivityInstanceVOList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•">æµ‹è¯•</h3><ul><li>1.demo</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -l http://localhost:16666/api/v1.0.1/bpmn/gettask</span><br></pre></td></tr></table></figure><ul><li>2.è¿”å›å€¼</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Success!&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;obj&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäºNginxçš„http_sssl_certåŒå‘è®¤è¯é…ç½®</title>
      <link href="/2023/08/25/https-ssl-cert/"/>
      <url>/2023/08/25/https-ssl-cert/</url>
      
        <content type="html"><![CDATA[<h1>åŸºäºNginxçš„http_sssl_certåŒå‘è®¤è¯é…ç½®</h1><h2 id="èƒŒæ™¯">èƒŒæ™¯</h2><blockquote><p>HTTPSæ˜¯å·¥ä½œäºSSLå±‚ä¹‹ä¸Šçš„HTTPåè®®ï¼ŒSSLï¼ˆå®‰å…¨å¥—æ¥å±‚ï¼‰å·¥ä½œäºTCPå±‚ä¹‹ä¸Šï¼Œå‘åº”ç”¨å±‚æä¾›äº†ä¸¤ä¸ªåŸºæœ¬å®‰å…¨æœåŠ¡ï¼šè®¤è¯å’Œä¿å¯†ã€‚SSLæœ‰ä¸‰ä¸ªå­åè®®ï¼šæ¡æ‰‹åè®®ï¼Œè®°å½•åè®®å’Œè­¦æŠ¥åè®®ã€‚å…¶ä¸­æ¡æ‰‹åè®®å®ç°æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯çš„è®¤è¯ä¸å¯†é’¥äº¤æ¢ï¼Œè®°å½•åè®®è¿›è¡Œæ•°æ®åŠ å¯†å¹¶ä¿è¯æ•°æ®çš„å®Œæ•´æ€§ï¼Œè­¦æŠ¥åè®®åˆ™è§„å®šäº†é”™è¯¯ç±»å‹å’Œå¤„ç†æœºåˆ¶ã€‚</p></blockquote><h2 id="æµç¨‹">æµç¨‹</h2><h3 id="è®¤è¯æµç¨‹">è®¤è¯æµç¨‹</h3><h4 id="å•å‘è®¤è¯">å•å‘è®¤è¯</h4><ul><li><p>å®¢æˆ·ç«¯å‘èµ·å»ºç«‹HTTPSè¿æ¥è¯·æ±‚ï¼Œå°†SSLåè®®ç‰ˆæœ¬çš„ä¿¡æ¯å‘é€ç»™æœåŠ¡å™¨ç«¯ï¼›</p></li><li><p>æœåŠ¡å™¨ç«¯å°†æœ¬æœºçš„å…¬é’¥è¯ä¹¦ï¼ˆserver.crtï¼‰å‘é€ç»™å®¢æˆ·ç«¯ï¼›</p></li><li><p>å®¢æˆ·ç«¯è¯»å–å…¬é’¥è¯ä¹¦ï¼ˆserver.crtï¼‰ï¼Œå–å‡ºäº†æœåŠ¡ç«¯å…¬é’¥ï¼›</p></li><li><p>å®¢æˆ·ç«¯ç”Ÿæˆä¸€ä¸ªéšæœºæ•°ï¼ˆå¯†é’¥Rï¼‰ï¼Œç”¨åˆšæ‰å¾—åˆ°çš„æœåŠ¡å™¨å…¬é’¥å»åŠ å¯†è¿™ä¸ªéšæœºæ•°å½¢æˆå¯†æ–‡ï¼Œå‘é€ç»™æœåŠ¡ç«¯ï¼›</p></li><li><p>æœåŠ¡ç«¯ç”¨è‡ªå·±çš„ç§é’¥ï¼ˆserver.keyï¼‰å»è§£å¯†è¿™ä¸ªå¯†æ–‡ï¼Œå¾—åˆ°äº†å¯†é’¥R</p></li><li><p>æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯åœ¨åç»­é€šè®¯è¿‡ç¨‹ä¸­å°±ä½¿ç”¨è¿™ä¸ªå¯†é’¥Rè¿›è¡Œé€šä¿¡äº†ã€‚</p></li></ul><blockquote><p>å¦‚å›¾ä¸ºå•å‘è®¤è¯æµç¨‹<br><img src="https-ssl-cert/liucheng.png" class="lazyload placeholder" data-srcset="https-ssl-cert/liucheng.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p></blockquote><h4 id="åŒå‘è®¤è¯">åŒå‘è®¤è¯</h4><ul><li>å®¢æˆ·ç«¯å‘èµ·å»ºç«‹HTTPSè¿æ¥è¯·æ±‚ï¼Œå°†SSLåè®®ç‰ˆæœ¬çš„ä¿¡æ¯å‘é€ç»™æœåŠ¡ç«¯ï¼›</li><li>æœåŠ¡å™¨ç«¯å°†æœ¬æœºçš„å…¬é’¥è¯ä¹¦(server.crt)å‘é€ç»™å®¢æˆ·ç«¯ï¼›</li><li>å®¢æˆ·ç«¯è¯»å–å…¬é’¥è¯ä¹¦(server.crt)ï¼Œå–å‡ºäº†æœåŠ¡ç«¯å…¬é’¥ï¼›</li><li>å®¢æˆ·ç«¯å°†å®¢æˆ·ç«¯å…¬é’¥è¯ä¹¦(client.crt)å‘é€ç»™æœåŠ¡å™¨ç«¯ï¼›</li><li>æœåŠ¡å™¨ç«¯ä½¿ç”¨æ ¹è¯ä¹¦(root.crt)è§£å¯†å®¢æˆ·ç«¯å…¬é’¥è¯ä¹¦ï¼Œæ‹¿åˆ°å®¢æˆ·ç«¯å…¬é’¥ï¼›</li><li>å®¢æˆ·ç«¯å‘é€è‡ªå·±æ”¯æŒçš„åŠ å¯†æ–¹æ¡ˆç»™æœåŠ¡å™¨ç«¯ï¼›</li><li>æœåŠ¡å™¨ç«¯æ ¹æ®è‡ªå·±å’Œå®¢æˆ·ç«¯çš„èƒ½åŠ›ï¼Œé€‰æ‹©ä¸€ä¸ªåŒæ–¹éƒ½èƒ½æ¥å—çš„åŠ å¯†æ–¹æ¡ˆï¼Œä½¿ç”¨å®¢æˆ·ç«¯çš„å…¬é’¥åŠ å¯†8. åå‘é€ç»™å®¢æˆ·ç«¯ï¼›</li><li>å®¢æˆ·ç«¯ä½¿ç”¨è‡ªå·±çš„ç§é’¥è§£å¯†åŠ å¯†æ–¹æ¡ˆï¼Œç”Ÿæˆä¸€ä¸ªéšæœºæ•°Rï¼Œä½¿ç”¨æœåŠ¡å™¨å…¬é’¥åŠ å¯†åä¼ ç»™æœåŠ¡å™¨ç«¯ï¼›</li><li>æœåŠ¡ç«¯ç”¨è‡ªå·±çš„ç§é’¥å»è§£å¯†è¿™ä¸ªå¯†æ–‡ï¼Œå¾—åˆ°äº†å¯†é’¥R</li><li>æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯åœ¨åç»­é€šè®¯è¿‡ç¨‹ä¸­å°±ä½¿ç”¨è¿™ä¸ªå¯†é’¥Rè¿›è¡Œé€šä¿¡äº†ã€‚</li></ul><blockquote><p>å¦‚å›¾ä¸ºåŒå‘è®¤è¯æµç¨‹<br><img src="https-ssl-cert/shuangxiang.png" class="lazyload placeholder" data-srcset="https-ssl-cert/shuangxiang.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p></blockquote><h2 id="ç”Ÿæˆ">ç”Ÿæˆ</h2><h3 id="è‡ªç­¾åè¯ä¹¦ç”Ÿæˆ">è‡ªç­¾åè¯ä¹¦ç”Ÿæˆ</h3><ul><li>1.caè¯ä¹¦ç”Ÿæˆ(caç§é’¥)</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /etc/nginx/keys/</span><br><span class="line"><span class="built_in">cd</span> /etc/nginx/keys/</span><br><span class="line">openssl genrsa -out ca.key 4096</span><br></pre></td></tr></table></figure><ul><li>2.caæ•°å­—è¯ä¹¦ç”Ÿæˆ</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -x509 -days 3650 -key ca.key -out ca.crt</span><br></pre></td></tr></table></figure><blockquote><p>ä¿¡æ¯Common name å¡«å†™åŸŸåæˆ–ipåœ°å€ï¼Œå…¶ä½™éšæ„å¡«å†™</p></blockquote><ul><li><ol start="3"><li>ç”¨ CA ç§é’¥ç­¾å‘ server çš„æ•°å­—è¯ä¹¦</li></ol></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -req -<span class="keyword">in</span> server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days 3650</span><br></pre></td></tr></table></figure><ul><li><ol start="4"><li>ç”Ÿæˆå®¢æˆ·ç«¯çš„ç§é’¥ä¸è¯ä¹¦</li></ol></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out client.key 4096</span><br></pre></td></tr></table></figure><ul><li><ol start="5"><li>ç”Ÿæˆå®¢æˆ·ç«¯æ•°å­—è¯ä¹¦</li></ol></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -key client.key -out client.csr</span><br></pre></td></tr></table></figure><blockquote><p>ä¿¡æ¯ä¸caä¿æŒä¸€è‡´</p></blockquote><ul><li><ol start="6"><li>openssl req -new -key client.key -out client.csr</li></ol></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -req -<span class="keyword">in</span> client.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out client.crt -days 3650</span><br></pre></td></tr></table></figure><h2 id="Nginxé…ç½®">Nginxé…ç½®</h2><blockquote><p>å®‰è£…nginxå¹¶å¯ç”¨sslæ¨¡å—</p></blockquote><ul><li>nginxé…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š</li></ul><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">443</span>;</span><br><span class="line">        <span class="attribute">server_name</span> localhost;</span><br><span class="line">        <span class="attribute">ssl</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">ssl_certificate</span> /etc/nginx/keys/server.crt;<span class="comment">#é…ç½®è¯ä¹¦ä½ç½®</span></span><br><span class="line">        <span class="attribute">ssl_certificate_key</span> /etc/nginx/keys/server.key;<span class="comment">#é…ç½®ç§˜é’¥ä½ç½®</span></span><br><span class="line">        <span class="attribute">ssl_client_certificate</span> /etc/nginx/keys/ca.crt;<span class="comment">#åŒå‘è®¤è¯</span></span><br><span class="line">        <span class="attribute">ssl_verify_client</span> <span class="literal">on</span>; <span class="comment">#åŒå‘è®¤è¯</span></span><br><span class="line">        <span class="attribute">ssl_session_timeout</span> <span class="number">5m</span>;</span><br><span class="line">        <span class="attribute">ssl_protocols</span> SSLv2 SSLv3 TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>; <span class="comment">#æŒ‰ç…§è¿™ä¸ªåè®®é…ç½®</span></span><br><span class="line">        <span class="attribute">ssl_ciphers</span> ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE; <span class="comment">#æŒ‰ç…§è¿™ä¸ªå¥—ä»¶é…ç½®</span></span><br><span class="line">        <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">root</span> html;</span><br><span class="line">        <span class="attribute">index</span> index.html;</span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">                <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ =<span class="number">404</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>åœ¨æµ‹è¯•å‰é‡æ–°nginx</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nginx -t</span><br><span class="line">nginx -v</span><br><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure><h2 id="æµ‹è¯•">æµ‹è¯•</h2><h3 id="javaæµ‹è¯•">javaæµ‹è¯•</h3><ul><li>ä»£ç å¦‚ä¸‹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.http.HttpEntity;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.CloseableHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.HttpGet;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.conn.ssl.SSLConnectionSocketFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.CloseableHttpClient;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.HttpClients;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.ssl.SSLContexts;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.util.EntityUtils;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLContext;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyStore;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpClientWithClientCert</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">PFX_PATH</span> <span class="operator">=</span> <span class="string">&quot;/Users/fred/temp/cert5/client.p12&quot;</span>;    <span class="comment">//å®¢æˆ·ç«¯è¯ä¹¦è·¯å¾„</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">PFX_PWD</span> <span class="operator">=</span> <span class="string">&quot;123456&quot;</span>;    <span class="comment">//å®¢æˆ·ç«¯è¯ä¹¦å¯†ç </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">sslRequestGet</span><span class="params">(String url)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">KeyStore</span> <span class="variable">keyStore</span> <span class="operator">=</span> KeyStore.getInstance(<span class="string">&quot;PKCS12&quot;</span>);</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">instream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(PFX_PATH));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            keyStore.load(instream, PFX_PWD.toCharArray());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            instream.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">SSLContext</span> <span class="variable">sslcontext</span> <span class="operator">=</span> SSLContexts.custom().loadKeyMaterial(keyStore, PFX_PWD.toCharArray()).build();</span><br><span class="line">        <span class="type">SSLConnectionSocketFactory</span> <span class="variable">sslsf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SSLConnectionSocketFactory</span>(sslcontext</span><br><span class="line">                , <span class="keyword">new</span> <span class="title class_">String</span>[] &#123; <span class="string">&quot;TLSv1&quot;</span> &#125;    <span class="comment">// supportedProtocols ,è¿™é‡Œå¯ä»¥æŒ‰éœ€è¦è®¾ç½®</span></span><br><span class="line">                , <span class="literal">null</span>    <span class="comment">// supportedCipherSuites</span></span><br><span class="line">                , SSLConnectionSocketFactory.getDefaultHostnameVerifier());</span><br><span class="line">        <span class="type">CloseableHttpClient</span> <span class="variable">httpclient</span> <span class="operator">=</span> HttpClients.custom().setSSLSocketFactory(sslsf).build();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">HttpGet</span> <span class="variable">httpget</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpGet</span>(url);</span><br><span class="line">            <span class="comment">//httpget.addHeader(&quot;host&quot;, &quot;integration-fred2.fredhuang.com&quot;);// è®¾ç½®ä¸€äº›heanderç­‰</span></span><br><span class="line">            <span class="type">CloseableHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> httpclient.execute(httpget);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">HttpEntity</span> <span class="variable">entity</span> <span class="operator">=</span> response.getEntity();</span><br><span class="line">                <span class="type">String</span> <span class="variable">jsonStr</span> <span class="operator">=</span> EntityUtils.toString(response.getEntity(), <span class="string">&quot;UTF-8&quot;</span>);<span class="comment">//è¿”å›ç»“æœ</span></span><br><span class="line">                EntityUtils.consume(entity);</span><br><span class="line">                <span class="keyword">return</span> jsonStr;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                response.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            httpclient.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(System.getProperty(<span class="string">&quot;java.home&quot;</span>));</span><br><span class="line">        System.out.println(sslRequestGet(<span class="string">&quot;https://integration-fred2.fredhuang.com&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æµ‹è¯•æ–¹æ³•å¦‚ä¸‹</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="variable">$JAVA_HOME</span></span><br><span class="line"><span class="built_in">sudo</span> ./bin/keytool -import -<span class="built_in">alias</span> ttt -keystore cacerts -file /Users/fred/temp/cert5/server.crt</span><br></pre></td></tr></table></figure><h3 id="curl-å·¥å…·æµ‹è¯•">curl å·¥å…·æµ‹è¯•</h3><ul><li>demo</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v</span><br></pre></td></tr></table></figure><ul><li>test</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --cacert ca.crt --cert client.crt --key client.key --tlsv1.2 https://192.168.0.162</span><br></pre></td></tr></table></figure><ul><li>detail</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#--certæŒ‡å®šå®¢æˆ·ç«¯å…¬é’¥è¯ä¹¦çš„è·¯å¾„</span></span><br><span class="line"><span class="comment">#--keyæŒ‡å®šå®¢æˆ·ç«¯ç§é’¥æ–‡ä»¶çš„è·¯å¾„</span></span><br><span class="line"><span class="comment">#-k ä½¿ç”¨æœ¬å‚æ•°ä¸æ ¡éªŒè¯ä¹¦çš„åˆæ³•æ€§ï¼Œå› ä¸ºæˆ‘ä»¬ç”¨çš„æ˜¯è‡ªç­¾åè¯ä¹¦</span></span><br><span class="line"><span class="comment">#å¯ä»¥ä½¿ç”¨-væ¥è§‚å¯Ÿå…·ä½“çš„SSLæ¡æ‰‹è¿‡ç¨‹</span></span><br><span class="line">curl --cert ./client.crt --key ./client.key https://integration-fred2.fredhuang.com -k -v</span><br><span class="line">* Rebuilt URL to: https://47.93.XX.XX/</span><br><span class="line">*   Trying 47.93.XX.XX...</span><br><span class="line">* TCP_NODELAY <span class="built_in">set</span></span><br><span class="line">* Connected to 47.93.XX.XX (47.93.XX.XX) port 443 (#0)</span><br><span class="line">* ALPN, offering h2</span><br><span class="line">* ALPN, offering http/1.1</span><br><span class="line">* Cipher selection: ALL:!EXPORT:!EXPORT40:!EXPORT56:!aNULL:!LOW:!RC4:@STRENGTH</span><br><span class="line">* successfully <span class="built_in">set</span> certificate verify locations:</span><br><span class="line">*   CAfile: /etc/ssl/cert.pem</span><br><span class="line">  CApath: none</span><br><span class="line">* TLSv1.2 (OUT), TLS handshake, Client hello (1):</span><br><span class="line">* TLSv1.2 (IN), TLS handshake, Server hello (2):</span><br><span class="line">* TLSv1.2 (IN), TLS handshake, Certificate (11):</span><br><span class="line">* TLSv1.2 (IN), TLS handshake, Server key exchange (12):</span><br><span class="line">* TLSv1.2 (IN), TLS handshake, Request CERT (13):</span><br><span class="line">* TLSv1.2 (IN), TLS handshake, Server finished (14):</span><br><span class="line">* TLSv1.2 (OUT), TLS handshake, Certificate (11):</span><br><span class="line">* TLSv1.2 (OUT), TLS handshake, Client key exchange (16):</span><br><span class="line">* TLSv1.2 (OUT), TLS handshake, CERT verify (15):</span><br><span class="line">* TLSv1.2 (OUT), TLS change cipher, Client hello (1):</span><br><span class="line">* TLSv1.2 (OUT), TLS handshake, Finished (20):</span><br><span class="line">* TLSv1.2 (IN), TLS change cipher, Client hello (1):</span><br><span class="line">* TLSv1.2 (IN), TLS handshake, Finished (20):</span><br><span class="line">* SSL connection using TLSv1.2 / ECDHE-RSA-AES256-GCM-SHA384</span><br><span class="line">* ALPN, server accepted to use http/1.1</span><br><span class="line">* Server certificate:</span><br><span class="line">*  subject: C=CN; ST=BJ; L=BJ; O=Alibaba; OU=Test; CN=integration-fred2.fredhuang.com; emailAddress=a@alibaba.com</span><br><span class="line">*  start <span class="built_in">date</span>: Nov  2 01:01:34 2019 GMT</span><br><span class="line">*  expire <span class="built_in">date</span>: Oct 30 01:01:34 2029 GMT</span><br><span class="line">*  issuer: C=CN; ST=BJ; L=BJ; O=Alibaba; OU=Test; CN=root; emailAddress=a@alibaba.com</span><br><span class="line">*  SSL certificate verify result: unable to get <span class="built_in">local</span> issuer certificate (20), continuing anyway.</span><br><span class="line">&gt; GET / HTTP/1.1</span><br><span class="line">&gt; host:integration-fred2.fredhuang.com</span><br><span class="line">&gt; User-Agent: curl/7.54.0</span><br><span class="line">&gt; Accept: */*</span><br><span class="line">&gt;</span><br><span class="line">&lt; HTTP/1.1 200 OK</span><br><span class="line">&lt; Server: nginx/1.17.5</span><br><span class="line">&lt; Date: Sat, 02 Nov 2019 02:39:43 GMT</span><br><span class="line">&lt; Content-Type: text/html</span><br><span class="line">&lt; Content-Length: 612</span><br><span class="line">&lt; Last-Modified: Wed, 30 Oct 2019 11:29:45 GMT</span><br><span class="line">&lt; Connection: keep-alive</span><br><span class="line">&lt; ETag: <span class="string">&quot;5db97429-264&quot;</span></span><br><span class="line">&lt; Accept-Ranges: bytes</span><br><span class="line">&lt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">* Connection <span class="comment">#0 to host 47.93.XX.XX left intact</span></span><br></pre></td></tr></table></figure><ul><li>test demo</li></ul><blockquote><p>å¦‚å›¾<br><img src="https-ssl-cert/result.png" class="lazyload placeholder" data-srcset="https-ssl-cert/result.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p></blockquote><ul><li>succ demo</li></ul><blockquote><p>å¦‚å›¾<br><img src="https-ssl-cert/succ.png" class="lazyload placeholder" data-srcset="https-ssl-cert/succ.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p></blockquote><h2 id="See">See</h2><p><a href="https://blog.csdn.net/qq_27682773/article/details/104943308">https://blog.csdn.net/qq_27682773/article/details/104943308</a></p><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨python é“¾æ¥ ADCS FTP æœåŠ¡æ‰¹é‡ä¸‹è½½å’Œä¸Šä¼ æ–‡ä»¶</title>
      <link href="/2023/07/31/python-ftp-server/"/>
      <url>/2023/07/31/python-ftp-server/</url>
      
        <content type="html"><![CDATA[<h1>ä½¿ç”¨python é“¾æ¥ ADCS FTP æœåŠ¡æ‰¹é‡ä¸‹è½½å’Œä¸Šä¼ æ–‡ä»¶</h1><h2 id="åŸºç¡€ç¯å¢ƒ">åŸºç¡€ç¯å¢ƒ</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PyCharm IDE</span><br><span class="line">PDCU or ADCU hardware</span><br><span class="line">Python &gt;= 3.8</span><br></pre></td></tr></table></figure><h2 id="å‡†å¤‡å·¥ä½œ">å‡†å¤‡å·¥ä½œ</h2><ul><li>ADCSå¼€å¯FTPæœåŠ¡ï¼Œç«¯å£20æˆ–21</li><li>pythonç¼–å†™ç¨‹åºæ“ä½œ</li></ul><h2 id="æµ‹è¯•ç¯å¢ƒ">æµ‹è¯•ç¯å¢ƒ</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ubuntu &gt;= 22.04</span><br><span class="line">python &gt;= 3.8</span><br><span class="line">PyCharm IDE</span><br></pre></td></tr></table></figure><h2 id="ä»£ç ç¼–å†™">ä»£ç ç¼–å†™</h2><h3 id="FTPæœåŠ¡å¼€å¯">FTPæœåŠ¡å¼€å¯</h3><blockquote><p>åŸºäºubuntu 22.04 ç³»ç»Ÿå¼€å¯ftpæœåŠ¡ï¼Œä½¿ç”¨pythonä»£ç æµ‹è¯•æ˜¯å¦è¿æ¥æˆåŠŸã€‚</p></blockquote><h4 id="FTPæœåŠ¡å¼€å¯-2">FTPæœåŠ¡å¼€å¯</h4><ul><li>sshæœåŠ¡å¼€å¯</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install openssh-server</span><br><span class="line">lsof -i:21</span><br></pre></td></tr></table></figure><ul><li>ftpæœåŠ¡å¼€å¯</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install vsftpd</span><br><span class="line"><span class="comment"># æ›´æ”¹é…ç½®</span></span><br><span class="line"><span class="built_in">sudo</span> vi /etc/vsftpd.conf</span><br><span class="line">local_enable=YES</span><br><span class="line">write_enable=YES</span><br><span class="line"><span class="comment"># é‡å¯æœåŠ¡ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="built_in">sudo</span> service vsftpd restart</span><br></pre></td></tr></table></figure><ul><li>ftpä¸sshæµ‹è¯•</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ftp </span></span><br><span class="line">ftp ip</span><br><span class="line"></span><br><span class="line"><span class="comment"># ssh</span></span><br><span class="line">ssh root@ip </span><br></pre></td></tr></table></figure><h3 id="sfpté“¾æ¥æœåŠ¡å™¨">sfpté“¾æ¥æœåŠ¡å™¨</h3><ul><li>ä»£ç å¦‚ä¸‹:</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ftp_connect</span>(<span class="params">host, port, username, password</span>):</span><br><span class="line">    cnopts = pysftp.CnOpts()</span><br><span class="line">    cnopts.hostkeys = <span class="literal">None</span></span><br><span class="line">    myHostname = host</span><br><span class="line">    myUsername = username</span><br><span class="line">    myPassword = password</span><br><span class="line"></span><br><span class="line">    sftp = pysftp.Connection(host=myHostname, username=myUsername, password=myPassword, cnopts=cnopts)</span><br><span class="line">    logger.debug(<span class="string">&quot;Connection succesfully stablished ... &quot;</span>)</span><br><span class="line">    directory_structure = sftp.listdir_attr()</span><br><span class="line">    <span class="keyword">for</span> attr <span class="keyword">in</span> directory_structure:</span><br><span class="line">        logger.debug(attr.filename, attr)</span><br><span class="line">    <span class="keyword">return</span> sftp, directory_structure</span><br></pre></td></tr></table></figure><h3 id="sftpæ‰¹é‡ä¸‹è½½æ–‡ä»¶">sftpæ‰¹é‡ä¸‹è½½æ–‡ä»¶</h3><ul><li>ä½¿ç”¨sftp.get()æ–¹æ³•ä¸‹è½½æ–‡ä»¶ï¼Œæ„é€ æŒ‡å®šå‡½æ•°ä¸‹è½½</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_file</span>(<span class="params">sftp, LocalFile, RemoteFile</span>):  <span class="comment"># ä¸‹è½½å½“ä¸ªæ–‡ä»¶</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    download point file from remote PDCU</span></span><br><span class="line"><span class="string">    :param sftp:</span></span><br><span class="line"><span class="string">    :param LocalFile: local file dir</span></span><br><span class="line"><span class="string">    :param RemoteFile: remote pdcu file</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    file_handler = <span class="built_in">open</span>(LocalFile, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">    logger.debug(<span class="string">&quot; download file dir : &quot;</span> + LocalFile)</span><br><span class="line">    sftp.get(RemoteFile, LocalFile)  <span class="comment"># ä¸‹è½½ç›®å½•ä¸­æ–‡ä»¶</span></span><br><span class="line">    file_handler.close()</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure><ul><li>æŠ‘æˆ–ç›®å½•ï¼š</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_filetree</span>(<span class="params">sftp, LocalDir, RemoteDir</span>):  <span class="comment"># ä¸‹è½½æ•´ä¸ªç›®å½•ä¸‹çš„æ–‡ä»¶</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    download point file and dir from remote PDCU</span></span><br><span class="line"><span class="string">    :param sftp:</span></span><br><span class="line"><span class="string">    :param LocalDir: local file dir</span></span><br><span class="line"><span class="string">    :param RemoteDir: remote pdcu file</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(LocalDir):</span><br><span class="line">        os.makedirs(LocalDir)</span><br><span class="line">    logger.debug(<span class="string">&quot; download file dir : &quot;</span> + LocalDir)</span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> sftp.listdir(RemoteDir):</span><br><span class="line">        Local = os.path.join(LocalDir, file)</span><br><span class="line">        Remote = RemoteDir + <span class="string">&quot;/&quot;</span> + file</span><br><span class="line">        <span class="keyword">if</span> sftp.isdir(Remote):  <span class="comment"># åˆ¤æ–­æ˜¯å¦æ˜¯æ–‡ä»¶</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(Local):</span><br><span class="line">                os.makedirs(Local)</span><br><span class="line">            download_filetree(sftp, Local, Remote)</span><br><span class="line">        <span class="keyword">elif</span> sftp.isfile(Remote):  <span class="comment"># æ–‡ä»¶</span></span><br><span class="line">            download_file(sftp, Local, Remote)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logger.error(<span class="string">&quot; you input path or file is incorrect!, detail path or file  :&quot;</span> + Remote)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;complete&quot;</span></span><br></pre></td></tr></table></figure><h3 id="sftpä¸Šä¼ æŒ‡å®šæ–‡ä»¶">sftpä¸Šä¼ æŒ‡å®šæ–‡ä»¶</h3><ul><li>å‚è€ƒå¦‚ä¸‹ï¼š</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ¤æ–­sftpæœåŠ¡ç«¯ä¸­æ–‡ä»¶è·¯å¾„æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨åˆ™åˆ›å»º</span></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_dir</span>(<span class="params">sftp, remoteDir</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> stat.S_ISDIR(sftp.stat(remoteDir).st_mode):  <span class="comment"># å¦‚æœremoteDirå­˜åœ¨ä¸”ä¸ºç›®å½•ï¼Œåˆ™è¿”å›True</span></span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        sftp.mkdir(remoteDir)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;åœ¨è¿œç¨‹sftpä¸Šåˆ›å»ºç›®å½•ï¼š&#123;&#125;&quot;</span>.<span class="built_in">format</span>(remoteDir))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸Šä¼ </span></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sftp_upload</span>(<span class="params">sftp, localDir, remoteDir</span>):</span><br><span class="line">    <span class="keyword">if</span> os.path.isdir(localDir):  <span class="comment"># åˆ¤æ–­æœ¬åœ°localDiræ˜¯å¦ä¸ºç›®å½•</span></span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> os.listdir(localDir):</span><br><span class="line">            remoteDirTmp = os.path.join(remoteDir, file)</span><br><span class="line">            localDirTmp = os.path.join(localDir, file)</span><br><span class="line">            <span class="keyword">if</span> os.path.isdir(localDirTmp):  <span class="comment"># å¦‚æœæœ¬åœ°localDirTmpä¸ºç›®å½•ï¼Œåˆ™å¯¹è¿œç¨‹sftpæœåŠ¡å™¨è¿›è¡Œåˆ¤æ–­</span></span><br><span class="line">                create_dir(sftp, remoteDirTmp)  <span class="comment"># åˆ¤æ–­sftpæœåŠ¡ç«¯æ–‡ä»¶ç›®å½•æ˜¯å¦å­˜åœ¨,è‹¥ä¸å­˜åœ¨åˆ™åˆ›å»º</span></span><br><span class="line">            sftp_upload(sftp, localDirTmp, remoteDirTmp)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;upload file:&quot;</span>, localDir)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            sftp.put(localDir, remoteDir)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;upload error:&#x27;</span>, e)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    host = <span class="string">&#x27;192.168.149.153&#x27;</span>  <span class="comment"># sftpä¸»æœº</span></span><br><span class="line">    port = <span class="number">22</span>  <span class="comment"># ç«¯å£</span></span><br><span class="line">    username = <span class="string">&#x27;sftpuser&#x27;</span>  <span class="comment"># sftpç”¨æˆ·å</span></span><br><span class="line">    password = <span class="string">&#x27;passwd&#x27;</span>  <span class="comment"># å¯†ç </span></span><br><span class="line">    localDir = <span class="string">&#x27;/test/sftp&#x27;</span>  <span class="comment"># æœ¬åœ°æ–‡ä»¶æˆ–ç›®å½•</span></span><br><span class="line">    remoteDir = <span class="string">&#x27;/sftp&#x27;</span>  <span class="comment"># è¿œç¨‹æ–‡ä»¶æˆ–ç›®å½•ï¼ˆæ³¨æ„è¿œç¨‹è·¯å¾„è¦å­˜åœ¨ï¼‰</span></span><br><span class="line">    sf = paramiko.Transport((host, port))</span><br><span class="line">    sf.connect(username=username, password=password)</span><br><span class="line">    sftp = paramiko.SFTPClient.from_transport(sf)</span><br><span class="line">    sftp_upload(sftp, localDir, remoteDir)</span><br><span class="line">    sf.close()</span><br></pre></td></tr></table></figure><h3 id="sftpè·å–æ–‡ä»¶çŠ¶æ€">sftpè·å–æ–‡ä»¶çŠ¶æ€</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">clear_dir</span>(<span class="params">path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æ¸…ç©ºæ–‡ä»¶å¤¹ï¼šå¦‚æœæ–‡ä»¶å¤¹ä¸å­˜åœ¨å°±åˆ›å»ºï¼Œå¦‚æœæ–‡ä»¶å­˜åœ¨å°±æ¸…ç©ºï¼</span></span><br><span class="line"><span class="string">    :param path: æ–‡ä»¶å¤¹è·¯å¾„</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">import</span> os</span><br><span class="line">    <span class="keyword">import</span> shutil</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path):</span><br><span class="line">            os.makedirs(path)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            shutil.rmtree(path)</span><br><span class="line">            os.makedirs(path)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">self, sftp, command</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line"><span class="string">    :param command:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># with SSHConnectionManager(**self.ssh_args) as ssh:</span></span><br><span class="line">    <span class="keyword">return</span> sftp.cmd(<span class="string">f&quot;<span class="subst">&#123;command&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exists</span>(<span class="params">self, sftp, path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    åˆ¤æ–­è·¯å¾„æ˜¯å¦å­˜åœ¨</span></span><br><span class="line"><span class="string">    :param path:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    is_exists = <span class="literal">False</span></span><br><span class="line">    <span class="comment"># with SSHConnectionManager(**self.ssh_args) as ssh:</span></span><br><span class="line">    result = sftp.cmd(<span class="string">f&quot;find <span class="subst">&#123;path&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> result:</span><br><span class="line">        is_exists = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> is_exists</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_file</span>(<span class="params">self, sftp, path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    åˆ¤æ–­è·¯å¾„æ˜¯å¦æ˜¯æ–‡ä»¶</span></span><br><span class="line"><span class="string">    :param path:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.exists(path):</span><br><span class="line">        <span class="comment"># with SSHConnectionManager(**self.ssh_args) as ssh:</span></span><br><span class="line">        prefix = sftp.cmd(<span class="string">f&quot;ls -ld <span class="subst">&#123;path&#125;</span>&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> prefix == <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_dir</span>(<span class="params">self, sftp, path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    åˆ¤æ–­è·¯å¾„æ˜¯å¦æ˜¯ç›®å½•</span></span><br><span class="line"><span class="string">    :param path:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.exists(path):</span><br><span class="line">        <span class="comment"># with SSHConnectionManager(**self.ssh_args) as ssh:</span></span><br><span class="line">        prefix = sftp.cmd(<span class="string">f&quot;ls -ld <span class="subst">&#123;path&#125;</span>&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> prefix == <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">makedirs</span>(<span class="params">self, sftp, path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    åˆ›å»ºç›®å½•</span></span><br><span class="line"><span class="string">    :param path: è¿œç¨‹æ–‡ä»¶å¤¹è·¯å¾„</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># with SSHConnectionManager(**self.ssh_args) as ssh:</span></span><br><span class="line">    cmd_str = <span class="string">f&quot;mkdir -p <span class="subst">&#123;path&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(cmd_str)</span><br><span class="line">    sftp.cmd(cmd_str)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="UIç¼–å†™">UIç¼–å†™</h3><blockquote><p>UIç»˜åˆ¶é‡‡ç”¨tkinter ç¬¬ä¸‰æ–¹åº“ç»˜åˆ¶ ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileDownload</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, master</span>):</span><br><span class="line">        <span class="variable language_">self</span>.file_path = StringVar()</span><br><span class="line">        <span class="variable language_">self</span>.file_path.<span class="built_in">set</span>(<span class="string">&#x27;è¯·è¾“å…¥ä¸‹è½½æ–‡ä»¶åœ°å€:&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.src_dir = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="variable language_">self</span>.urls = []</span><br><span class="line">        <span class="comment"># tkinteråˆšå¼€å§‹ä¸ç†Ÿæ‚‰ï¼Œå¸ƒå±€éº»çƒ¦ï¼Œè¿™é‡Œä½¿ç”¨çš„ç½‘æ ¼å¸ƒå±€ï¼Œrowï¼Œcolumn çš„indexï¼Œå®šä½cell</span></span><br><span class="line">        open_btn = Button(master, text=<span class="string">&quot;é“¾æ¥ftpæœåŠ¡&quot;</span>, width=<span class="number">15</span>, height=<span class="number">3</span>, borderwidth=<span class="number">2</span>,</span><br><span class="line">                          command=<span class="variable language_">self</span>.connect_ftp_service)</span><br><span class="line">        download_btn = Button(master, text=<span class="string">&quot;å¼€å§‹ä¸‹è½½æ–‡ä»¶&quot;</span>, width=<span class="number">15</span>, height=<span class="number">3</span>, borderwidth=<span class="number">2</span>,</span><br><span class="line">                              command=<span class="variable language_">self</span>.file_download)</span><br><span class="line">        <span class="comment"># self.file_path = Text(master, width=200, height=3)</span></span><br><span class="line">        <span class="comment"># self.file_path.grid(row=2, column=1, columnspan=2, ipadx=10, ipady=10)</span></span><br><span class="line">        open_btn.grid(row=<span class="number">0</span>, column=<span class="number">0</span>, ipadx=<span class="number">5</span>, ipady=<span class="number">3</span>, padx=<span class="number">10</span>, pady=<span class="number">3</span>)</span><br><span class="line">        download_btn.grid(row=<span class="number">1</span>, column=<span class="number">0</span>, ipadx=<span class="number">5</span>, ipady=<span class="number">3</span>, padx=<span class="number">10</span>, pady=<span class="number">3</span>)</span><br><span class="line">        <span class="comment"># æ–‡ä»¶è¾“å…¥è·¯å¾„è·å–</span></span><br><span class="line">        <span class="variable language_">self</span>.file_label = Entry(master, textvariable=<span class="variable language_">self</span>.file_path, fg=<span class="string">&#x27;green&#x27;</span>, bg=<span class="string">&#x27;white&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.file_label.grid(row=<span class="number">0</span>, column=<span class="number">1</span>, rowspan=<span class="number">2</span>, ipadx=<span class="number">200</span>, ipady=<span class="number">15</span>, padx=<span class="number">10</span>, pady=<span class="number">2</span>)  <span class="comment"># ,padx=20,pady=10,</span></span><br><span class="line">        <span class="comment"># self.console_text = StringVar()</span></span><br><span class="line">        <span class="variable language_">self</span>.text = Text(master, width=<span class="number">200</span>, height=<span class="number">50</span>, bg=<span class="string">&#x27;white&#x27;</span>, fg=<span class="string">&#x27;blue&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.text.grid(row=<span class="number">2</span>, columnspan=<span class="number">2</span>, ipadx=<span class="number">10</span>, ipady=<span class="number">10</span>)</span><br><span class="line">        <span class="comment"># self.file_path.pack()</span></span><br><span class="line">        <span class="comment"># self.text.setvar(&quot;aaaaa&quot;)# self.file_name = StringVar()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">server_msg_input</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :return: ip port username psd</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–å¼¹å‡ºè¾“å…¥å¯¹è¯æ¡†</span></span><br><span class="line">    child = tkinter.Tk()</span><br><span class="line">    <span class="comment"># å¼¹å‡ºå¯¹è¯æ¡†çš„title</span></span><br><span class="line">    child.title(<span class="string">&#x27;æœåŠ¡å™¨è´¦æˆ·ä¿¡æ¯è¾“å…¥&#x27;</span>)</span><br><span class="line">    child[<span class="string">&#x27;height&#x27;</span>] = <span class="number">260</span></span><br><span class="line">    child[<span class="string">&#x27;width&#x27;</span>] = <span class="number">320</span></span><br><span class="line">    child.resizable(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="comment"># è®¾ç½®å¼¹å‡ºå¯¹è¯çš„æ¡†çš„æ ‡ç­¾å€¼</span></span><br><span class="line">    ip_label = tkinter.Label(child, text=<span class="string">&#x27;IP:&#x27;</span>, font=(<span class="string">&#x27;é»‘ä½“&#x27;</span>, <span class="number">12</span>))</span><br><span class="line">    ip_label.place(x=<span class="number">25</span>, y=<span class="number">20</span>)</span><br><span class="line">    <span class="comment"># å¼¹å‡ºè¾“å…¥å¯¹è¯æ¡†è¯·è·å–ç›¸åº”çš„å€¼</span></span><br><span class="line">    ip_str = tkinter.StringVar()</span><br><span class="line">    ip_entry = tkinter.Entry(child, font=(<span class="string">&#x27;é»‘ä½“&#x27;</span>, <span class="number">12</span>), textvariable=ip_str)</span><br><span class="line">    ip_entry.place(x=<span class="number">100</span>, y=<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">    port_label = tkinter.Label(child, text=<span class="string">&#x27;port:&#x27;</span>, font=(<span class="string">&#x27;é»‘ä½“&#x27;</span>, <span class="number">12</span>))</span><br><span class="line">    port_label.place(x=<span class="number">25</span>, y=<span class="number">60</span>)</span><br><span class="line">    <span class="comment"># å¼¹å‡ºè¾“å…¥å¯¹è¯æ¡†è¯·è·å–ç›¸åº”çš„å€¼</span></span><br><span class="line">    port_str = tkinter.StringVar()</span><br><span class="line">    port_entry = tkinter.Entry(child, font=(<span class="string">&#x27;é»‘ä½“&#x27;</span>, <span class="number">12</span>), textvariable=port_str)</span><br><span class="line">    port_entry.place(x=<span class="number">100</span>, y=<span class="number">60</span>)</span><br><span class="line"></span><br><span class="line">    user_name_label = tkinter.Label(child, text=<span class="string">&#x27;UserName:&#x27;</span>, font=(<span class="string">&#x27;é»‘ä½“&#x27;</span>, <span class="number">12</span>))</span><br><span class="line">    user_name_label.place(x=<span class="number">25</span>, y=<span class="number">100</span>)</span><br><span class="line">    <span class="comment"># å¼¹å‡ºè¾“å…¥å¯¹è¯æ¡†è¯·è·å–ç›¸åº”çš„å€¼</span></span><br><span class="line">    user_name_str = tkinter.StringVar()</span><br><span class="line">    user_name_entry = tkinter.Entry(child, font=(<span class="string">&#x27;é»‘ä½“&#x27;</span>, <span class="number">12</span>), textvariable=user_name_str)</span><br><span class="line">    user_name_entry.place(x=<span class="number">100</span>, y=<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">    psd_label = tkinter.Label(child, text=<span class="string">&#x27;PassWord:&#x27;</span>, font=(<span class="string">&#x27;é»‘ä½“&#x27;</span>, <span class="number">12</span>))</span><br><span class="line">    psd_label.place(x=<span class="number">25</span>, y=<span class="number">140</span>)</span><br><span class="line">    <span class="comment"># å¼¹å‡ºè¾“å…¥å¯¹è¯æ¡†è¯·è·å–ç›¸åº”çš„å€¼</span></span><br><span class="line">    psd_str = tkinter.StringVar()</span><br><span class="line">    psd_entry = tkinter.Entry(child, font=(<span class="string">&#x27;é»‘ä½“&#x27;</span>, <span class="number">12</span>), textvariable=psd_str)</span><br><span class="line">    psd_entry.place(x=<span class="number">100</span>, y=<span class="number">140</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç»‘å®šå›è½¦é”®</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Get_key</span>():</span><br><span class="line">        <span class="keyword">global</span> key, edt_ip, edt_port, edt_user_name, edt_pass_word</span><br><span class="line">        key = ip_entry.get()</span><br><span class="line">        edt_ip = ip_entry.get()</span><br><span class="line">        edt_port = port_entry.get()</span><br><span class="line">        edt_user_name = user_name_entry.get()</span><br><span class="line">        edt_pass_word = psd_entry.get()</span><br><span class="line">        <span class="keyword">if</span> edt_ip != <span class="string">&quot;&quot;</span> <span class="keyword">and</span> ip_identify(edt_ip) <span class="keyword">and</span> edt_port != <span class="string">&quot;&quot;</span> <span class="keyword">and</span> edt_user_name != <span class="string">&quot;&quot;</span> <span class="keyword">and</span> edt_pass_word != <span class="string">&quot;&quot;</span>:</span><br><span class="line">            logger.debug(</span><br><span class="line">                <span class="string">&quot; user input server msg , ip : &quot;</span> + edt_ip + <span class="string">&quot;,port:&quot;</span> + edt_port + <span class="string">&quot;.user name :&quot;</span></span><br><span class="line">                + edt_user_name + <span class="string">&quot;, psd : &quot;</span> + edt_pass_word)</span><br><span class="line">            connect_ftp_server(<span class="variable language_">self</span>, edt_ip, edt_port, edt_user_name, edt_pass_word)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logger.error(<span class="string">&quot; you input msg is error , please re input!&quot;</span>)</span><br><span class="line">            showerror(title=<span class="string">&#x27;é”™è¯¯ï¼&#x27;</span>, message=<span class="string">&#x27;æ‚¨è¾“å…¥ä¿¡æ¯æœ‰è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥ï¼&#x27;</span>)</span><br><span class="line">        child.destroy()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æŒ‰ä¸‹å›è½¦é”®è¿”å›ç§˜é’¥</span></span><br><span class="line">    child.bind(<span class="string">&#x27;&lt;Return&gt;&#x27;</span>, Get_key)</span><br><span class="line">    <span class="comment"># ç‚¹å‡»OKæŒ‰é’®è¿”å›ç§˜é’¥</span></span><br><span class="line">    btn_OK = tkinter.Button(child, text=<span class="string">&#x27;ç¡®è®¤&#x27;</span>, font=(<span class="string">&#x27;é»‘ä½“&#x27;</span>, <span class="number">12</span>), height=<span class="number">2</span>, command=Get_key)</span><br><span class="line">    btn_OK.place(x=<span class="number">150</span>, y=<span class="number">200</span>)</span><br><span class="line">    <span class="comment"># edt_ip, edt_port, edt_user_name, edt_pass_word = Get_key()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># if edt_ip != &quot;&quot; and edt_port != &quot;&quot; and edt_user_name \</span></span><br><span class="line">    <span class="comment">#         != &quot;&quot; and edt_pass_word != &quot;&quot;:</span></span><br><span class="line">    <span class="comment"># return edt_ip, edt_port, edt_user_name, edt_pass_word</span></span><br><span class="line">    <span class="comment"># return child</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="å…¶ä»–éƒ¨åˆ†">å…¶ä»–éƒ¨åˆ†</h3><blockquote><p>linuxç³»ç»Ÿç›®å½•æ— æ³•æ‰¾åˆ°è§£å†³åŠæ³•</p></blockquote><ul><li>åœ¨ä»£ç é¦–éƒ¨æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</li></ul> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding:utf-8</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="comment"># å¯¼å…¥OSæ¨¡å—</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŠŠå½“å‰æ–‡ä»¶æ‰€åœ¨æ–‡ä»¶å¤¹çš„çˆ¶æ–‡ä»¶å¤¹è·¯å¾„åŠ å…¥åˆ°PYTHONPATH</span></span><br><span class="line">sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>uvicorn æ¡†æ¶è½¯ä»¶ç¼–å†™åå‘å¸ƒè‡³ubuntuæœåŠ¡å™¨</title>
      <link href="/2023/06/20/uvicorn-publish/"/>
      <url>/2023/06/20/uvicorn-publish/</url>
      
        <content type="html"><![CDATA[<h1>uvicorn æ¡†æ¶è½¯ä»¶ç¼–å†™åå‘å¸ƒè‡³ubuntuæœåŠ¡å™¨</h1><h2 id="uvicornå®‰è£…ä½¿ç”¨">uvicornå®‰è£…ä½¿ç”¨</h2><ul><li>1.å®‰è£…</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install uvicorn</span><br></pre></td></tr></table></figure><ul><li>2.main.pyç¼–å†™</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastApi</span><br><span class="line"></span><br><span class="line">app = FastApi()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&#x27;/hello&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;hello World&#x27;</span>&#125;</span><br></pre></td></tr></table></figure><ul><li>3.å¼€å‘ç¯å¢ƒè¿è¡Œ</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, host=<span class="string">&quot;127.0.0.1&quot;</span>, port=<span class="number">8000</span>, log_level=<span class="string">&quot;info&quot;</span>)</span><br></pre></td></tr></table></figure><h2 id="å‘å¸ƒç¯å¢ƒéƒ¨ç½²">å‘å¸ƒç¯å¢ƒéƒ¨ç½²</h2><ul><li>1.gunicornå®‰è£…</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install uvicorn</span><br><span class="line">pip install gunicorn</span><br></pre></td></tr></table></figure><ul><li>2.gunicorn.pyé…ç½®æ–‡ä»¶ç¼–å†™</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å®ˆæŠ¤è¿›ç¨‹</span></span><br><span class="line">daemon=<span class="literal">True</span></span><br><span class="line"><span class="comment"># ç›‘å¬å†…ç½‘ç«¯å£8000</span></span><br><span class="line">bind=<span class="string">&#x27;0.0.0.0:8000&#x27;</span></span><br><span class="line"><span class="comment"># è®¾ç½®è¿›ç¨‹æ–‡ä»¶ç›®å½•</span></span><br><span class="line">pidfile=<span class="string">&#x27;./gunicorn.pid&#x27;</span></span><br><span class="line">chdir=<span class="string">&#x27;./&#x27;</span> <span class="comment"># å·¥ä½œç›®å½•</span></span><br><span class="line"><span class="comment"># å·¥ä½œæ¨¡å¼</span></span><br><span class="line">worker_class=<span class="string">&#x27;uvicorn.workers.UvicornWorker&#x27;</span></span><br><span class="line"><span class="comment"># å¹¶è¡Œå·¥ä½œè¿›ç¨‹æ•° æ ¸å¿ƒæ•°*2+1ä¸ª</span></span><br><span class="line">workers=<span class="number">3</span>  <span class="comment">#multiprocessing.cpu_count()+1</span></span><br><span class="line"><span class="comment"># æŒ‡å®šæ¯ä¸ªå·¥ä½œè€…çš„çº¿ç¨‹æ•°</span></span><br><span class="line">threads=<span class="number">2</span></span><br><span class="line"><span class="comment"># è®¾ç½®æœ€å¤§å¹¶å‘é‡</span></span><br><span class="line">worker_connections = <span class="number">2000</span></span><br><span class="line">loglevel=<span class="string">&#x27;debug&#x27;</span> <span class="comment"># é”™è¯¯æ—¥å¿—çš„æ—¥å¿—çº§åˆ«</span></span><br><span class="line">access_log_format = <span class="string">&#x27;%(t)s %(p)s %(h)s &quot;%(r)s&quot; %(s)s %(L)s %(b)s %(f)s&quot; &quot;%(a)s&quot;&#x27;</span></span><br><span class="line"><span class="comment"># è®¾ç½®è®¿é—®æ—¥å¿—å’Œé”™è¯¯ä¿¡æ¯æ—¥å¿—è·¯å¾„</span></span><br><span class="line">log_dir = <span class="string">&quot;./log&quot;</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(log_dir):</span><br><span class="line">    os.makedirs(log_dir)</span><br><span class="line">accesslog = <span class="string">&quot;./log/gunicorn_access.log&quot;</span></span><br><span class="line">errorlog = <span class="string">&quot;./log/gunicorn_error.log&quot;</span></span><br></pre></td></tr></table></figure><ul><li>3.pyæ–‡ä»¶ç‰¹æ®Šå¤„ç†</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯¼å…¥OSæ¨¡å—</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŠŠå½“å‰æ–‡ä»¶æ‰€åœ¨æ–‡ä»¶å¤¹çš„çˆ¶æ–‡ä»¶å¤¹è·¯å¾„åŠ å…¥åˆ°PYTHONPATH</span></span><br><span class="line">sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))</span><br></pre></td></tr></table></figure><ul><li>4.æœåŠ¡å™¨è¿è¡Œ</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gunicorn main:app -c gunicorn.py</span><br></pre></td></tr></table></figure><blockquote><p>æŠ‘æˆ–</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gunicorn main:app -b 0.0.0.0:8000 -w 4 -k uvicorn.workers.UvicornWorker --daemon</span><br></pre></td></tr></table></figure><h3 id="é¡¹ç›®åœæ­¢è¿è¡Œ">é¡¹ç›®åœæ­¢è¿è¡Œ</h3><ul><li>1.è·å–gunicornè¿›ç¨‹æ ‘</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pstree -ap | grep gunicorn</span><br></pre></td></tr></table></figure><ul><li>2.ç»ˆæ­¢gunicornä»»åŠ¡</li></ul><p>kill -HUP è¿›ç¨‹pid</p><ul><li>3.å¦‚æœä½¿ç”¨äº†å¤šè¿›ç¨‹ï¼Œé‚£ä¹ˆæ‰§è¡Œäº†ä¸Šè¿°å‘½ä»¤åè¿˜ä¼šæœ‰å­è¿›ç¨‹åœ¨è¿è¡Œï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ€æ­»</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -9 è¿›ç¨‹pid</span><br></pre></td></tr></table></figure><h4 id="è¿›ç¨‹è„šæœ¬æ€æ­»">è¿›ç¨‹è„šæœ¬æ€æ­»</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">â€‹</span><br><span class="line"><span class="comment"># æŸ¥æ‰¾ gunicorn ä¸»è¿›ç¨‹ PID</span></span><br><span class="line">gunicorn_pid=$(ps aux | grep <span class="string">&#x27;gunicorn&#x27;</span> | grep -v <span class="string">&#x27;grep&#x27;</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)</span><br><span class="line">â€‹</span><br><span class="line"><span class="comment"># å¦‚æœæ‰¾åˆ°äº†ä¸»è¿›ç¨‹ PID</span></span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$gunicorn_pid</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;Found gunicorn process: <span class="variable">$gunicorn_pid</span>&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># ç»™ä¸»è¿›ç¨‹å‘ SIGINT ä¿¡å·ï¼Œè¯·æ±‚æ­£å¸¸åœæ­¢è¿›ç¨‹</span></span><br><span class="line">  <span class="built_in">kill</span> -INT <span class="variable">$gunicorn_pid</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># ç¡çœ  5 ç§’ç­‰å¾…ä¸»è¿›ç¨‹ç»“æŸ </span></span><br><span class="line">  <span class="built_in">sleep</span> 5</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># æŸ¥æ‰¾æ‰€æœ‰ gunicorn å­è¿›ç¨‹ PID</span></span><br><span class="line">  gunicorn_child_pids=$(pstree -p <span class="variable">$gunicorn_pid</span> | grep -oP <span class="string">&#x27;([0-9]+)(?=\))&#x27;</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># å¦‚æœæ‰¾åˆ°äº†å­è¿›ç¨‹ PID</span></span><br><span class="line">  <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$gunicorn_child_pids</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Found gunicorn child processes: <span class="variable">$gunicorn_child_pids</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ€æ­»æ‰€æœ‰å­è¿›ç¨‹</span></span><br><span class="line">    <span class="keyword">for</span> pid <span class="keyword">in</span> <span class="variable">$gunicorn_child_pids</span>; <span class="keyword">do</span></span><br><span class="line">      <span class="built_in">kill</span> -9 <span class="variable">$pid</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;Stopped gunicorn process and child processes&quot;</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;No running gunicorn process found&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><ul><li>è„šæœ¬æ‰§è¡Œ</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> 777 stop_gunicorn.sh</span><br><span class="line">bash stop_gunicorn.sh</span><br></pre></td></tr></table></figure><h3 id="é…ç½®å¼€æœºè‡ªå¯åŠ¨æœåŠ¡">é…ç½®å¼€æœºè‡ªå¯åŠ¨æœåŠ¡</h3><h4 id="é…ç½®-gunicorn-serviceæœåŠ¡å¼€æœºè‡ªå¯åŠ¨">é…ç½® gunicorn.serviceæœåŠ¡å¼€æœºè‡ªå¯åŠ¨</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;/usr/lib/systemd/system/gunicorn.service &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Gunicorn fast</span></span><br><span class="line"><span class="string">After=syslog.target network.target remote-fs.target nss-lookup.target</span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=forking</span></span><br><span class="line"><span class="string">PIDFile=/var/run/gunicorn.pid</span></span><br><span class="line"><span class="string">ExecStart=/root/.local/share/virtualenvs/fastapi-Xq8atoqR/bin/gunicorn  -c </span></span><br><span class="line"><span class="string">/opt/web/fastapi/gunicorn.py main:app</span></span><br><span class="line"><span class="string">ExecReload=/bin/kill -s HUP $MAINPID</span></span><br><span class="line"><span class="string">ExecStop=/bin/kill -s QUIT $MAINPID</span></span><br><span class="line"><span class="string">PrivateTmp=true</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><blockquote><p>ä¾æ¬¡æ‰§è¡Œä¸‹é¢å‘½ä»¤</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> gunicorn</span><br><span class="line">systemctl start gunicorn</span><br></pre></td></tr></table></figure><blockquote><p>æŸ¥çœ‹æœåŠ¡çŠ¶æ€</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status gunicorn</span><br></pre></td></tr></table></figure><h3 id="Nginxä»£ç†é…ç½®">Nginxä»£ç†é…ç½®</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">            listen 80;</span><br><span class="line">           <span class="comment"># listen 443 ssl;</span></span><br><span class="line">            server_name api.hmily.vip;</span><br><span class="line">            access_log  /var/log/nginx/access.log;</span><br><span class="line">            location / &#123;</span><br><span class="line">                proxy_pass http://127.0.0.1:8000;</span><br><span class="line">                proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">                proxy_set_header X-Forwarded-For</span><br><span class="line">                <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><blockquote><p>nginxé…ç½®ç”Ÿæ•ˆ</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure><h2 id="See">See</h2><ul><li>[1].<a href="https://zhuanlan.zhihu.com/p/580791329">https://zhuanlan.zhihu.com/p/580791329</a></li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> unbutu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Zuul + Oauth 2 å®ç°é‰´æƒåŠŸèƒ½</title>
      <link href="/2023/05/31/gateway-auth-control/"/>
      <url>/2023/05/31/gateway-auth-control/</url>
      
        <content type="html"><![CDATA[<h1>Zuul + Oauth 2 å®ç°é‰´æƒåŠŸèƒ½</h1><h2 id="æŠ€æœ¯ç®€ä»‹">æŠ€æœ¯ç®€ä»‹</h2><h3 id="oauth2">oauth2</h3><blockquote><p>OAuth 2.0 is the industry-standard protocol for authorization. OAuth 2.0 focuses on client developer simplicity while providing specific authorization flows for web applications, desktop applications, mobile phones, and living room devices. This specification and its extensions are being developed within the IETF OAuth Working Group.</p></blockquote><blockquote><p>OAuth 2.1 is an in-progress effort to consolidate OAuth 2.0 and many common extensions under a new name.</p></blockquote><h3 id="zuul">zuul</h3><blockquote><p>Zuul is the front door for all requests from devices and web sites to the backend of the Netflix streaming application. As an edge service application, Zuul is built to enable dynamic routing, monitoring, resiliency and security. It also has the ability to route requests to multiple Amazon Auto Scaling Groups as appropriate.</p></blockquote><h2 id="æŠ€æœ¯ç‰ˆæœ¬é€‰æ‹©">æŠ€æœ¯ç‰ˆæœ¬é€‰æ‹©</h2><ul><li>1.zuul ç‰ˆæœ¬é€‰æ‹©</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-zuul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>2.oauth2 ç‰ˆæœ¬é€‰æ‹©</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="å®ç°">å®ç°</h2><ul><li>1.ç½‘å…³æ­å»º<blockquote><p>è§ï¼š&lt;&lt;Swagger + Zuul æ•´åˆå¾®æœåŠ¡æ¥å£æ–‡æ¡£&gt;&gt; ä¸€æ–‡</p></blockquote></li><li>2.oauth é…ç½®<ul><li>åœ¨ application.yml æ–‡ä»¶ä¸­é…ç½® auth æœåŠ¡</li></ul></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">auth:</span></span><br><span class="line">  <span class="attr">tokenValiditySeconds:</span> <span class="number">1200</span> <span class="comment">#tokenå­˜å‚¨åˆ°redisçš„è¿‡æœŸæ—¶é—´</span></span><br><span class="line">  <span class="attr">clientId:</span> <span class="string">domain</span></span><br><span class="line">  <span class="attr">clientSecret:</span> <span class="string">domain</span></span><br><span class="line">  <span class="attr">cookieDomain:</span> <span class="string">domain.com</span></span><br><span class="line">  <span class="attr">cookieMaxAge:</span> <span class="number">-1</span></span><br><span class="line"><span class="attr">encrypt:</span></span><br><span class="line">  <span class="attr">key-store:</span></span><br><span class="line">    <span class="attr">location:</span> <span class="string">classpath:rs.keystore</span></span><br><span class="line">    <span class="attr">secret:</span> <span class="string">domainkeystore</span></span><br><span class="line">    <span class="attr">alias:</span> <span class="string">domainkey</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">domain</span></span><br></pre></td></tr></table></figure><h4 id="security-é…ç½®-æ”¾è¡Œç™»é™†ã€è·å–éªŒè¯ç ç­‰æ¥å£">security é…ç½®,æ”¾è¡Œç™»é™†ã€è·å–éªŒè¯ç ç­‰æ¥å£</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.czq.auth.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.WebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@Order(-1)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        web.ignoring().antMatchers(<span class="string">&quot;/userlogin&quot;</span>,<span class="string">&quot;/userlogout&quot;</span>,<span class="string">&quot;/userjwt&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">AuthenticationManager</span> <span class="variable">manager</span> <span class="operator">=</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">        <span class="keyword">return</span> manager;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//é‡‡ç”¨bcryptå¯¹å¯†ç è¿›è¡Œç¼–ç </span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.csrf().disable()</span><br><span class="line">                .httpBasic().and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .and()</span><br><span class="line">                .authorizeRequests().anyRequest().permitAll();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="ç»§æ‰¿-AuthorizationServerConfigurer-ç±»é…ç½®-auth-æœåŠ¡å™¨">ç»§æ‰¿ AuthorizationServerConfigurer ç±»é…ç½® auth æœåŠ¡å™¨</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.czq.auth.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.bootstrap.encrypt.KeyProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.ClientDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.client.JdbcClientDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.DefaultAccessTokenConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtTokenStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.KeyStoreKeyFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPair;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AuthorizationServerConfig</span> <span class="keyword">extends</span> <span class="title class_">AuthorizationServerConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line">    <span class="comment">//jwtä»¤ç‰Œè½¬æ¢å™¨</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtAccessTokenConverter jwtAccessTokenConverter;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserDetailsService userDetailsService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    AuthenticationManager authenticationManager;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    TokenStore tokenStore;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomUserAuthenticationConverter customUserAuthenticationConverter;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¯»å–å¯†é’¥çš„é…ç½®</span></span><br><span class="line">    <span class="meta">@Bean(&quot;keyProp&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> KeyProperties <span class="title function_">keyProperties</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">KeyProperties</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;keyProp&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> KeyProperties keyProperties;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®¢æˆ·ç«¯é…ç½®</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ClientDetailsService <span class="title function_">clientDetails</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JdbcClientDetailsService</span>(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        clients.jdbc(<span class="built_in">this</span>.dataSource).clients(<span class="built_in">this</span>.clientDetails());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> TokenStore <span class="title function_">tokenStore</span><span class="params">(JwtAccessTokenConverter jwtAccessTokenConverter)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtTokenStore</span>(jwtAccessTokenConverter);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtAccessTokenConverter <span class="title function_">jwtAccessTokenConverter</span><span class="params">(CustomUserAuthenticationConverter customUserAuthenticationConverter)</span> &#123;</span><br><span class="line">        <span class="type">JwtAccessTokenConverter</span> <span class="variable">converter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtAccessTokenConverter</span>();</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">keyPair</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">KeyStoreKeyFactory</span></span><br><span class="line">                (keyProperties.getKeyStore().getLocation(), keyProperties.getKeyStore().getSecret().toCharArray())</span><br><span class="line">                .getKeyPair(keyProperties.getKeyStore().getAlias(),keyProperties.getKeyStore().getPassword().toCharArray());</span><br><span class="line">        converter.setKeyPair(keyPair);</span><br><span class="line">        <span class="comment">//é…ç½®è‡ªå®šä¹‰çš„CustomUserAuthenticationConverter</span></span><br><span class="line">        <span class="type">DefaultAccessTokenConverter</span> <span class="variable">accessTokenConverter</span> <span class="operator">=</span> (DefaultAccessTokenConverter) converter.getAccessTokenConverter();</span><br><span class="line">        accessTokenConverter.setUserTokenConverter(customUserAuthenticationConverter);</span><br><span class="line">        <span class="keyword">return</span> converter;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æˆæƒæœåŠ¡å™¨ç«¯ç‚¹é…ç½®</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        endpoints.accessTokenConverter(jwtAccessTokenConverter)</span><br><span class="line">                .authenticationManager(authenticationManager)<span class="comment">//è®¤è¯ç®¡ç†å™¨</span></span><br><span class="line">                .tokenStore(tokenStore)<span class="comment">//ä»¤ç‰Œå­˜å‚¨</span></span><br><span class="line">                .userDetailsService(userDetailsService);<span class="comment">//ç”¨æˆ·ä¿¡æ¯service</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æˆæƒæœåŠ¡å™¨çš„å®‰å…¨é…ç½®</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerSecurityConfigurer oauthServer)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"><span class="comment">//        oauthServer.checkTokenAccess(&quot;isAuthenticated()&quot;);//æ ¡éªŒtokenéœ€è¦è®¤è¯é€šè¿‡ï¼Œå¯é‡‡ç”¨http basicè®¤è¯</span></span><br><span class="line">        oauthServer.allowFormAuthenticationForClients()</span><br><span class="line">                .passwordEncoder(<span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>())</span><br><span class="line">                .tokenKeyAccess(<span class="string">&quot;permitAll()&quot;</span>)</span><br><span class="line">                .checkTokenAccess(<span class="string">&quot;permitAll()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    é‡‡ç”¨ bcryptå¯¹å¯†ç è¿›è¡Œhash</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span>  <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="é…ç½®è‡ªå®šä¹‰çš„-CustomUserAuthenticationConverter">é…ç½®è‡ªå®šä¹‰çš„ CustomUserAuthenticationConverter</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.czq.auth.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.czq.auth.service.UserJwt;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.AuthorityUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.DefaultUserAuthenticationConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomUserAuthenticationConverter</span> <span class="keyword">extends</span> <span class="title class_">DefaultUserAuthenticationConverter</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, ?&gt; convertUserAuthentication(Authentication authentication) &#123;</span><br><span class="line">        <span class="type">LinkedHashMap</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> authentication.getName();</span><br><span class="line">        response.put(<span class="string">&quot;username&quot;</span>, name);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">principal</span> <span class="operator">=</span> authentication.getPrincipal();</span><br><span class="line">        <span class="type">UserJwt</span> <span class="variable">userJwt</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(principal <span class="keyword">instanceof</span>  UserJwt)&#123;</span><br><span class="line">            userJwt = (UserJwt) principal;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//refresh_tokené»˜è®¤ä¸å»è°ƒç”¨userdetailServiceè·å–ç”¨æˆ·ä¿¡æ¯ï¼Œè¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨å»è°ƒç”¨ï¼Œå¾—åˆ° UserJwt</span></span><br><span class="line">            <span class="type">UserDetails</span> <span class="variable">userDetails</span> <span class="operator">=</span> userDetailsService.loadUserByUsername(name);</span><br><span class="line">            userJwt = (UserJwt) userDetails;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (authentication.getAuthorities() != <span class="literal">null</span> &amp;&amp; !authentication.getAuthorities().isEmpty()) &#123;</span><br><span class="line">            response.put(<span class="string">&quot;authorities&quot;</span>, AuthorityUtils.authorityListToSet(authentication.getAuthorities()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>3.Oauth ä»¤ç‰Œç”Ÿæˆ<blockquote><p>åœ¨ç”¨æˆ·ç™»å½•æ—¶ç”³è¯· token</p></blockquote></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * description: è®¤è¯æ–¹æ³• ä» spring securityå»è·å–è®¤è¯æ˜¯å¦æˆåŠŸä¿¡æ¯ å³æ˜¯å¦èƒ½æˆåŠŸè·å–ä»¤ç‰Œ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username ç”¨æˆ·å</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password å¯†ç </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clientId å®¢æˆ·id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clientSecret å®¢æˆ·å¯†ç </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> czq</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> $&#123;date&#125; $&#123;time&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="keyword">private</span> AuthToken <span class="title function_">applyToken</span><span class="params">(String username, String password, String clientId, String clientSecret)</span> <span class="keyword">throws</span> UnsupportedEncodingException &#123;</span><br><span class="line"><span class="comment">//    é€‰ä¸­è®¤è¯æœåŠ¡åœ°å€</span></span><br><span class="line">        <span class="type">ServiceInstance</span> <span class="variable">serviceInstance</span> <span class="operator">=</span> loadBalancerClient.choose(ServiceList.AUTH_SERVICE);</span><br><span class="line">        <span class="keyword">if</span> (serviceInstance == <span class="literal">null</span>)&#123;</span><br><span class="line">            LOGGER.error(<span class="string">&quot;choose an auth instance null&quot;</span>);</span><br><span class="line">            ExceptionCast.cast(AuthCode.AUTH_LOGIN_AUTHSERVER_NOTFOUND);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//       è·å–ä»¤ç‰Œurl</span></span><br><span class="line">        <span class="type">URI</span> <span class="variable">uri</span> <span class="operator">=</span> serviceInstance.getUri();</span><br><span class="line">        <span class="type">String</span> <span class="variable">authUrl</span> <span class="operator">=</span> uri+ <span class="string">&quot;/auth/oauth/token&quot;</span>;</span><br><span class="line"><span class="comment">//        å®šä¹‰body</span></span><br><span class="line">        MultiValueMap&lt;String,String&gt; formData = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line"><span class="comment">//        æˆæƒæ–¹å¼</span></span><br><span class="line">        formData.add(<span class="string">&quot;grant_type&quot;</span>,<span class="string">&quot;password&quot;</span>);</span><br><span class="line">        formData.add(<span class="string">&quot;username&quot;</span>,username);</span><br><span class="line">        formData.add(<span class="string">&quot;password&quot;</span>,password);</span><br><span class="line"><span class="comment">//        å®šä¹‰å¤´éƒ¨</span></span><br><span class="line">        MultiValueMap&lt;String,String&gt; header = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line">        header.add(<span class="string">&quot;Authorization&quot;</span>,httpbasic(clientId,clientSecret));</span><br><span class="line">        <span class="comment">///æŒ‡å®š restTemplateå½“é‡åˆ°400æˆ–401å“åº”æ—¶å€™ä¹Ÿä¸è¦æŠ›å‡ºå¼‚å¸¸ï¼Œä¹Ÿè¦æ­£å¸¸è¿”å›å€¼</span></span><br><span class="line">        restTemplate.setErrorHandler(<span class="keyword">new</span> <span class="title class_">DefaultResponseErrorHandler</span>()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleError</span><span class="params">(URI url, HttpMethod method, ClientHttpResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="comment">//å½“å“åº”çš„å€¼ä¸º400æˆ–401æ—¶å€™ä¹Ÿè¦æ­£å¸¸å“åº”ï¼Œä¸è¦æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">                <span class="keyword">if</span>(response.getRawStatusCode()!=<span class="number">400</span> &amp;&amp; response.getRawStatusCode()!=<span class="number">401</span>)&#123;</span><br><span class="line">                    <span class="built_in">super</span>.handleError(response);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; httpEntity = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(formData, header);</span><br><span class="line"><span class="comment">//        httpè¯·æ±‚spring security ç”³è¯·ä»¤ç‰Œæ¥å£</span></span><br><span class="line">            ResponseEntity&lt;Map&gt; mapResponseEntity = restTemplate.exchange(authUrl, HttpMethod.POST,</span><br><span class="line">                    httpEntity, Map.class);</span><br><span class="line">            map = mapResponseEntity.getBody();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RestClientException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            LOGGER.error(<span class="string">&quot;request oauth_token_password error: &#123;&#125;&quot;</span>,e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            ExceptionCast.cast(AuthCode.AUTH_LOGIN_APPLYTOKEN_FAIL);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (map == <span class="literal">null</span> ||</span><br><span class="line">                map.get(<span class="string">&quot;access_token&quot;</span>) == <span class="literal">null</span> ||</span><br><span class="line">                map.get(<span class="string">&quot;refresh_token&quot;</span>) == <span class="literal">null</span> ||</span><br><span class="line">                map.get(<span class="string">&quot;jti&quot;</span>) == <span class="literal">null</span>)&#123;<span class="comment">//jtiæ˜¯jwtä»¤ç‰Œçš„å”¯ä¸€æ ‡è¯†ä½œä¸ºç”¨æˆ·èº«ä»½ä»¤ç‰Œ</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">error_description</span> <span class="operator">=</span> (String) map.get(<span class="string">&quot;error_description&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isNotEmpty(error_description)) &#123;</span><br><span class="line">                <span class="keyword">if</span>(error_description.equals(<span class="string">&quot;åçš„å‡­è¯&quot;</span>))&#123;</span><br><span class="line">                    ExceptionCast.cast(AuthCode.AUTH_CREDENTIAL_ERROR);</span><br><span class="line">                &#125;   <span class="keyword">else</span> <span class="keyword">if</span> (error_description.indexOf(<span class="string">&quot;UserDetailsService returned null&quot;</span>) &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                    ExceptionCast.cast(AuthCode.AUTH_ACCOUNT_NOTEXISTS);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ExceptionCast.cast(AuthCode.AUTH_LOGIN_APPLYTOKEN_FAIL);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">AuthToken</span> <span class="variable">authToken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthToken</span>();</span><br><span class="line"><span class="comment">//        è®¿é—®ä»¤ç‰Œjwt</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jwt_token</span> <span class="operator">=</span> (String) map.get(<span class="string">&quot;access_token&quot;</span>);</span><br><span class="line"><span class="comment">//        åˆ·æ–°ä»¤ç‰Œjwt</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">refresh_token</span> <span class="operator">=</span> (String) map.get(<span class="string">&quot;refresh_token&quot;</span>);</span><br><span class="line">        <span class="comment">//jtiï¼Œä½œä¸ºç”¨æˆ·çš„èº«ä»½æ ‡è¯†</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">access_token</span> <span class="operator">=</span> (String) map.get(<span class="string">&quot;jti&quot;</span>);</span><br><span class="line">        authToken.setJwt_token(jwt_token);</span><br><span class="line">        authToken.setAccess_token(access_token);</span><br><span class="line">        authToken.setRefresh_token(refresh_token);</span><br><span class="line">        <span class="keyword">return</span> authToken;</span><br></pre></td></tr></table></figure><blockquote><p>åœ¨è·å–åˆ°ä»¤ç‰Œåï¼Œå­˜å‚¨è‡³ redis ä¸­ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * description: ç™»å½•æœåŠ¡ è®¤è¯æ–¹æ³•</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username ç”¨æˆ·å</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password å¯†ç </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clientId å®¢æˆ·ç«¯id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clientSecret å®¢æˆ·ç«¯å¯†ç </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> czq</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> $&#123;date&#125; $&#123;time&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">public</span> AuthToken <span class="title function_">login</span><span class="params">(String username, String password, String clientId, String clientSecret)</span> <span class="keyword">throws</span> UnsupportedEncodingException &#123;</span><br><span class="line"><span class="comment">//        ç”³è¯·ä»¤ç‰Œ</span></span><br><span class="line">   <span class="type">AuthToken</span> <span class="variable">authToken</span> <span class="operator">=</span> applyToken(username,password,clientId,clientSecret);</span><br><span class="line">        <span class="keyword">if</span> (authToken == <span class="literal">null</span> )&#123;</span><br><span class="line">            ExceptionCast.cast(AuthCode.AUTH_LOGIN_APPLYTOKEN_FAIL);</span><br><span class="line">        &#125;</span><br><span class="line">  <span class="type">String</span> <span class="variable">access_token</span> <span class="operator">=</span> authToken.getAccess_token();</span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> (String) JSON.toJSONString(authToken);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">saveTokenResult</span> <span class="operator">=</span> saveToken(access_token,content,tokenValiditySeconds);</span><br><span class="line">        <span class="keyword">if</span> (!saveTokenResult)&#123;</span><br><span class="line">            ExceptionCast.cast(AuthCode.AUTH_LOGIN_TOKEN_SAVEFAIL);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> authToken;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * description: å­˜å‚¨ä»¤ç‰Œåˆ°redis</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> access_token ç™»å½•token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content å†…å®¹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ttl è¿‡æœŸæ—¶é—´</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> czq</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> $&#123;date&#125; $&#123;time&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">saveToken</span><span class="params">(String access_token, String content, <span class="type">long</span> ttl)</span> &#123;</span><br><span class="line"><span class="comment">//        ä»¤ç‰Œå</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;user_token:&quot;</span> + access_token;</span><br><span class="line"><span class="comment">//        ä¿å­˜ä»¤ç‰Œåˆ°redis</span></span><br><span class="line">        stringRedisTemplate.boundValueOps(key).set(content,ttl, TimeUnit.SECONDS);</span><br><span class="line"><span class="comment">//        è·å–è¿‡æœŸæ—¶é—´</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">expire</span> <span class="operator">=</span> stringRedisTemplate.getExpire(key,TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> expire &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä¿å­˜åˆ° redis åï¼Œé€šè¿‡ cookie è¿”å›è‡³å‰ç«¯</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * description: å°†ä»¤ç‰Œä¿å­˜åˆ°cookie</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> access_token token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> czq</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> $&#123;date&#125; $&#123;time&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">saveCookie</span><span class="params">(String access_token)</span> &#123;</span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> ((ServletRequestAttributes)</span><br><span class="line">                RequestContextHolder.getRequestAttributes()).getResponse();</span><br><span class="line"><span class="comment">//        æ·»åŠ cookieä»¤ç‰Œ æœ€åä¸€ä¸ªå‚æ•°è®¾ç½®ä¸ºfalse è¡¨ç¤ºå…è®¸æµè§ˆå™¨è·å–</span></span><br><span class="line">        <span class="keyword">assert</span> response != <span class="literal">null</span>;</span><br><span class="line">        CookieUtil.addCookie(response,cookieDomain,<span class="string">&quot;/&quot;</span>,</span><br><span class="line">                <span class="string">&quot;uid&quot;</span>,access_token,cookieMaxAge,<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>æœ€ç»ˆè¿”å› token è‡³å‰ç«¯ï¼Œå‰ç«¯é€šè¿‡æºå¸¦ cookie è·å– jwt ä»¤ç‰Œ</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * description: ä»redisæŸ¥è¯¢ä»¤ç‰Œ</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> access_token å‡†å…¥token</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> auth token</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span></span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span> czq</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@date</span> $&#123;date&#125; $&#123;time&#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> AuthToken <span class="title function_">getUserToken</span><span class="params">(String access_token)</span> &#123;</span><br><span class="line">       <span class="type">String</span> <span class="variable">userToken</span> <span class="operator">=</span> <span class="string">&quot;user_token:&quot;</span> + access_token;<span class="comment">//      String name = &quot;user_token:&quot; + access_token;</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">userTokenString</span> <span class="operator">=</span>  stringRedisTemplate.opsForValue().get(userToken);</span><br><span class="line">       <span class="keyword">if</span> (userToken != <span class="literal">null</span>)&#123;</span><br><span class="line">           <span class="type">AuthToken</span> <span class="variable">authToken</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               authToken = JSON.parseObject(userTokenString,AuthToken.class);</span><br><span class="line">           &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">               LOGGER.error(<span class="string">&quot;getUserToken from redis and execute JSON.parseObject error &#123;&#125;&quot;</span>,e.getMessage());</span><br><span class="line">               e.printStackTrace();</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> authToken;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><ul><li>4.ç½‘å…³é…ç½®è¿‡æ»¤è§„åˆ™ï¼Œæ”¾è¡Œç™»å½•ç­‰æ¥å£<blockquote><p>åœ¨è¿‡æ»¤è§„åˆ™ä¸­ï¼Œå¯¹ä¸ç¬¦åˆè¦æ±‚æ¥å£äºˆä»¥æ‹¦æˆªå¹¶è¿”å› 403ã€‚</p></blockquote></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.czq.gateway.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.czq.common.model.response.CommonCode;</span><br><span class="line"><span class="keyword">import</span> com.czq.common.model.response.ResponseResult;</span><br><span class="line"><span class="keyword">import</span> com.czq.model.auth.ext.*;</span><br><span class="line"><span class="keyword">import</span> com.netflix.zuul.ZuulFilter;</span><br><span class="line"><span class="keyword">import</span> com.netflix.zuul.context.RequestContext;</span><br><span class="line"><span class="keyword">import</span> com.netflix.zuul.exception.ZuulException;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.client.RestTemplateBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.AntPathMatcher;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.LinkedMultiValueMap;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.MultiValueMap;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.PathMatcher;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginFilter</span> <span class="keyword">extends</span> <span class="title class_">ZuulFilter</span> &#123;</span><br><span class="line">    List&lt;String&gt; paths = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(LoginFilter.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Autowired</span></span><br><span class="line"><span class="comment">//    private RestTemplate restTemplate;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LoginFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line"><span class="comment">//        paths.add(&quot;/login/logining&quot;);</span></span><br><span class="line">        paths.add(<span class="string">&quot;/**/auth/oauth/check_token&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/**/auth/oauth/token&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/**/auth/userlogin&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/**/auth/userjwt&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/**/manage/captcha&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/**/manage/verification&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/ui/**&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/**/swagger**/**&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/**/v2/api-docs&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/**/*.css&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/**/*.jpg&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/**/*.png&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/**/*.gif&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/**/*.js&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/**/*.svg&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    è¿‡æ»¤å™¨ç±»å‹</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * pre è¯·æ±‚å‰è°ƒç”¨</span></span><br><span class="line"><span class="comment">     * routing åœ¨è·¯ç”±è¯·æ±‚å‰è°ƒç”¨</span></span><br><span class="line"><span class="comment">     * poståœ¨routing errorè¿‡æ»¤å™¨åè°ƒç”¨</span></span><br><span class="line"><span class="comment">     * errorå¤„ç†è¯·æ±‚å‘ç”Ÿé”™è¯¯è°ƒç”¨</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">filterType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;pre&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">filterOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;<span class="comment">////intå€¼æ¥å®šä¹‰è¿‡æ»¤å™¨çš„æ‰§è¡Œé¡ºåºï¼Œæ•°å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldFilter</span><span class="params">()</span> &#123;<span class="comment">//æ‰§è¡Œè¿‡æ»¤å™¨</span></span><br><span class="line">        <span class="type">RequestContext</span> <span class="variable">requestContext</span> <span class="operator">=</span> RequestContext.getCurrentContext();</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> requestContext.getRequest();</span><br><span class="line">        <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> request.getRequestURI();</span><br><span class="line">        <span class="type">PathMatcher</span> <span class="variable">matcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AntPathMatcher</span>();</span><br><span class="line">        Optional&lt;String&gt; optional = paths.stream().filter(t -&gt; matcher.match(t, uri)).findFirst();</span><br><span class="line">        <span class="keyword">return</span> !optional.isPresent();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">run</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException &#123;</span><br><span class="line">        <span class="type">RequestContext</span> <span class="variable">requestContext</span> <span class="operator">=</span> RequestContext.getCurrentContext();</span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">httpServletResponse</span> <span class="operator">=</span> requestContext.getResponse();</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">httpServletRequest</span> <span class="operator">=</span> requestContext.getRequest();</span><br><span class="line"><span class="comment">//å–å‡ºå¤´éƒ¨ä¿¡æ¯Authorization</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">authorization</span> <span class="operator">=</span> httpServletRequest.getHeader(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(authorization)) &#123;</span><br><span class="line">            requestContext.setSendZuulResponse(<span class="literal">false</span>);<span class="comment">//;æ‹’ç»è®¿é—®</span></span><br><span class="line">            requestContext.setResponseStatusCode(<span class="number">200</span>);<span class="comment">//å“åº”ç </span></span><br><span class="line">            <span class="type">ResponseResult</span> <span class="variable">unauthenticated</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseResult</span>(CommonCode.UNAUTHENTICATED);</span><br><span class="line">            <span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> JSON.toJSONString(unauthenticated);</span><br><span class="line">            requestContext.setResponseBody(jsonString);</span><br><span class="line">            requestContext.getResponse().setContentType(<span class="string">&quot;application/json;charset=UTFâ€8&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.startsWithIgnoreCase(authorization, <span class="string">&quot;bearer &quot;</span>)) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;http request header authorization is error&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">TokenInfo</span> <span class="variable">tokenInfo</span> <span class="operator">=</span> getTokenInfo(authorization);</span><br><span class="line">            httpServletRequest.setAttribute(<span class="string">&quot;token&quot;</span>, tokenInfo);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;token check error !&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>å¯¹æºå¸¦ä»¤ç‰Œçš„è¯·æ±‚é€šè¿‡è¯·æ±‚é‰´æƒæœåŠ¡éªŒè¯ token åˆæ³•åæ”¾è¡Œè‡³ä¸‹ä¸€è¿‡æ»¤è§„åˆ™ï¼Œåä¹‹è¿”å› token æ£€æŸ¥å¤±è´¥ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">private</span> TokenInfo <span class="title function_">getTokenInfo</span><span class="params">(String authorization)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:50201/api/v1.0.1/auth-service/auth/oauth/check_token&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> StringUtils.substringAfter(authorization, <span class="string">&quot;Bearer &quot;</span>);</span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);</span><br><span class="line"><span class="comment">//        headers.setBasicAuth(&quot;RsWebApp&quot;, &quot;RsWebApp&quot;);</span></span><br><span class="line">        <span class="comment">//æ–¹æ³•ä¸€ ä½¿ç”¨RestTemplateBuilderæ¥å®ä¾‹åŒ–</span></span><br><span class="line">        headers.add(HttpHeaders.AUTHORIZATION, <span class="string">&quot;Bearer &quot;</span> + token);</span><br><span class="line">        <span class="comment">//æ­¤å¤„ç›¸å½“äºåœ¨headeré‡Œå¤´æ·»åŠ content-typeç­‰å‚æ•°</span></span><br><span class="line">        headers.add(HttpHeaders.CONTENT_TYPE,<span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">        <span class="type">RestTemplateBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplateBuilder</span>();</span><br><span class="line">        <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> builder.basicAuthorization(<span class="string">&quot;RsWebApp&quot;</span>, <span class="string">&quot;RsWebApp&quot;</span>).build();</span><br><span class="line">        MultiValueMap&lt;String, String&gt; params = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line">        params.add(<span class="string">&quot;token&quot;</span>, token);</span><br><span class="line">        HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; httpEntity = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(params, headers);</span><br><span class="line">        ResponseEntity&lt;TokenInfo&gt; exchange = restTemplate.exchange(url, HttpMethod.POST, httpEntity, TokenInfo.class);</span><br><span class="line">        <span class="keyword">return</span> exchange.getBody();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>5.ç½‘å…³é‰´æƒè¿‡æ»¤è§„åˆ™<blockquote><p>æ‹¦æˆªè¯·æ±‚ï¼Œæ ¡éªŒ token æ˜¯å¦è¿‡æœŸï¼›å¯¹ç¬¦åˆè¦æ±‚çš„è¯·æ±‚åœ¨ header ä¸­æ·»åŠ  jti (java web token identity)å¹¶äºˆä»¥æ”¾è¡Œ</p></blockquote></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.czq.gateway.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.czq.model.auth.ext.TokenInfo;</span><br><span class="line"><span class="keyword">import</span> com.netflix.zuul.ZuulFilter;</span><br><span class="line"><span class="keyword">import</span> com.netflix.zuul.context.RequestContext;</span><br><span class="line"><span class="keyword">import</span> com.netflix.zuul.exception.ZuulException;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.AntPathMatcher;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.PathMatcher;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æˆæƒè¿‡æ»¤å™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthorizationFilter</span> <span class="keyword">extends</span> <span class="title class_">ZuulFilter</span> &#123;</span><br><span class="line">    List&lt;String&gt; paths = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOG</span> <span class="operator">=</span> LoggerFactory.getLogger(LoginFilter.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Autowired</span></span><br><span class="line"><span class="comment">//    private RestTemplate restTemplate;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AuthorizationFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line"><span class="comment">//        paths.add(&quot;/login/logining&quot;);</span></span><br><span class="line"><span class="comment">//        paths.add(&quot;/login/checkCode&quot;);</span></span><br><span class="line">        paths.add(<span class="string">&quot;/**/auth/oauth/check_token&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/**/auth/oauth/token&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/**/auth/userlogin&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/**/auth/userjwt&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/**/manage/captcha&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/**/manage/verification&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/ui/**&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/**/swagger**/**&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/**/v2/api-docs&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/**/*.css&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/**/*.jpg&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/**/*.png&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/**/*.gif&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/**/*.js&quot;</span>);</span><br><span class="line">        paths.add(<span class="string">&quot;/**/*.svg&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldFilter</span><span class="params">()</span> &#123;<span class="comment">//æ‰§è¡Œè¿‡æ»¤å™¨</span></span><br><span class="line">        <span class="type">RequestContext</span> <span class="variable">requestContext</span> <span class="operator">=</span> RequestContext.getCurrentContext();</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> requestContext.getRequest();</span><br><span class="line">        <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> request.getRequestURI();</span><br><span class="line">        <span class="type">PathMatcher</span> <span class="variable">matcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AntPathMatcher</span>();</span><br><span class="line">        Optional&lt;String&gt; optional = paths.stream().filter(t -&gt; matcher.match(t, uri)).findFirst();</span><br><span class="line">        <span class="keyword">return</span> !optional.isPresent();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">run</span><span class="params">()</span> <span class="keyword">throws</span> ZuulException &#123;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;authorization start&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">RequestContext</span> <span class="variable">requestContext</span> <span class="operator">=</span> RequestContext.getCurrentContext();</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> requestContext.getRequest();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isNeedAuth(request)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// OAuthFilter token æ ¡éªŒé€šè¿‡ï¼Œä¼šå°†tokenä¿¡æ¯æ”¾åœ¨è¯·æ±‚å¤´é‡Œ</span></span><br><span class="line">            <span class="type">TokenInfo</span> <span class="variable">tokenInfo</span> <span class="operator">=</span> (TokenInfo) request.getAttribute(<span class="string">&quot;token&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ ¡éªŒæ˜¯å¦æœ‰æƒé™</span></span><br><span class="line">            <span class="keyword">if</span> (tokenInfo != <span class="literal">null</span> &amp;&amp; tokenInfo.isActive()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!hasPermission(tokenInfo, request)) &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;audit log update fail 403&quot;</span>);</span><br><span class="line">                    handleError(<span class="number">403</span>, requestContext);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                requestContext.addZuulRequestHeader(<span class="string">&quot;token&quot;</span>, tokenInfo.getJti());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!StringUtils.startsWith(request.getRequestURI(), <span class="string">&quot;/token&quot;</span>)) &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;audit log update fail 401&quot;</span>);</span><br><span class="line">                    handleError(<span class="number">401</span>, requestContext);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleError</span><span class="params">(<span class="type">int</span> status, RequestContext requestContext)</span> &#123;</span><br><span class="line">        requestContext.getResponse().setContentType(<span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">        requestContext.setResponseStatusCode(status);</span><br><span class="line">        requestContext.setResponseBody(<span class="string">&quot;&#123;\&quot;message\&quot;:\&quot;auth fail\&quot;&#125;&quot;</span>);</span><br><span class="line">        requestContext.setSendZuulResponse(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">hasPermission</span><span class="params">(TokenInfo tokenInfo, HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">//RandomUtils.nextInt() % 2 == 0;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isNeedAuth</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">filterType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;pre&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">filterOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li><ol start="6"><li>token ä¿¡æ¯å®ä½“ç±»</li></ol></li></ul><h4 id="TokenInfo-java">TokenInfo.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.czq.model.auth.ext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TokenInfo</span> &#123;</span><br><span class="line">    String userpic;</span><br><span class="line">    String user_name;</span><br><span class="line">    List&lt;String&gt; scope;</span><br><span class="line">    String name;</span><br><span class="line">    String utype;</span><br><span class="line">    <span class="type">boolean</span> active;</span><br><span class="line">    String id;</span><br><span class="line">    <span class="type">long</span> exp;</span><br><span class="line">    String jti;</span><br><span class="line">    String client_id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="AuthToken-java">AuthToken.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.czq.model.auth.ext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthToken</span> &#123;</span><br><span class="line">    String access_token;<span class="comment">//è®¿é—®token</span></span><br><span class="line">    String refresh_token;<span class="comment">//åˆ·æ–°token</span></span><br><span class="line">    String jwt_token;<span class="comment">//jwtä»¤ç‰Œ</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> zuul </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Swagger + Zuul æ•´åˆå¾®æœåŠ¡æ¥å£æ–‡æ¡£</title>
      <link href="/2023/05/31/swagger-micro-service/"/>
      <url>/2023/05/31/swagger-micro-service/</url>
      
        <content type="html"><![CDATA[<h1>Swagger + Zuul æ•´åˆå¾®æœåŠ¡æ¥å£æ–‡æ¡£</h1><h2 id="ç®€ä»‹">ç®€ä»‹</h2><h3 id="Swagger">Swagger</h3><blockquote><p>Swagger æ˜¯ä¸€æ¬¾ RESTFUL æ¥å£çš„æ–‡æ¡£åœ¨çº¿è‡ªåŠ¨ç”Ÿæˆ+åŠŸèƒ½æµ‹è¯•åŠŸèƒ½è½¯ä»¶ã€‚Swagger æ˜¯ä¸€ä¸ªè§„èŒƒå’Œå®Œæ•´çš„æ¡†æ¶,ç”¨äºç”Ÿæˆã€æè¿°ã€è°ƒç”¨å’Œå¯è§†åŒ– RESTful é£æ ¼çš„ Web æœåŠ¡ã€‚ç›®æ ‡æ˜¯ä½¿å®¢æˆ·ç«¯å’Œæ–‡ä»¶ç³»ç»Ÿä½œä¸ºæœåŠ¡å™¨ä»¥åŒæ ·çš„é€Ÿåº¦æ¥æ›´æ–°æ–‡ä»¶çš„æ–¹æ³•,å‚æ•°å’Œæ¨¡å‹ç´§å¯†é›†æˆåˆ°æœåŠ¡å™¨ã€‚</p></blockquote><h3 id="Zuul">Zuul</h3><blockquote><p>Spring Cloud Zuul æ˜¯ Spring Cloud Netflix å­é¡¹ç›®çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œå¯ä»¥ä½œä¸ºå¾®æœåŠ¡æ¶æ„ä¸­çš„ API ç½‘å…³ä½¿ç”¨ï¼Œæ”¯æŒåŠ¨æ€è·¯ç”±ä¸è¿‡æ»¤åŠŸèƒ½<br>API ç½‘å…³ä¸ºå¾®æœåŠ¡æ¶æ„ä¸­çš„æœåŠ¡æä¾›äº†ç»Ÿä¸€çš„è®¿é—®å…¥å£ï¼Œå®¢æˆ·ç«¯é€šè¿‡ API ç½‘å…³è®¿é—®ç›¸å…³æœåŠ¡ã€‚<br>API ç½‘å…³çš„å®šä¹‰ç±»ä¼¼äºè®¾è®¡æ¨¡å¼ä¸­çš„é—¨é¢æ¨¡å¼ï¼Œå®ƒç›¸å½“äºæ•´ä¸ªå¾®æœåŠ¡æ¶æ„ä¸­çš„é—¨é¢ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯çš„è®¿é—®éƒ½é€šè¿‡å®ƒæ¥è¿›è¡Œè·¯ç”±åŠè¿‡æ»¤ã€‚<br>å®ƒå®ç°äº†è¯·æ±‚è·¯ç”±ã€è´Ÿè½½å‡è¡¡ã€æ ¡éªŒè¿‡æ»¤ã€æœåŠ¡å®¹é”™ã€æœåŠ¡èšåˆç­‰åŠŸèƒ½ã€‚</p></blockquote><h2 id="æŠ€æœ¯">æŠ€æœ¯</h2><ul><li>1.swagger æ–‡æ¡£ï¼š</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>2.zuul ç½‘å…³</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-zuul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="å®ç°">å®ç°</h2><ul><li>1.API æ¨¡å—é…ç½®å¼•å…¥<ul><li>pom.xml æ–‡ä»¶é‡ç‚¹å¦‚ä¸‹:</li></ul></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>2.API æ¨¡å— swagger é…ç½®æ–‡ä»¶</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.czq.api.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.ApiInfoBuilder;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.ParameterBuilder;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.PathSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.RequestHandlerSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.schema.ModelRef;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.ApiInfo;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.Parameter;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spi.DocumentationType;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spring.web.plugins.Docket;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.swagger2.annotations.EnableSwagger2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Swagger2Configuration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Docket <span class="title function_">createRestApi</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Parameter&gt; parameters = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">        parameters.add((<span class="keyword">new</span> <span class="title class_">ParameterBuilder</span>()).name(<span class="string">&quot;Authorization&quot;</span>).description(<span class="string">&quot;Authorization&quot;</span>).modelRef(<span class="keyword">new</span> <span class="title class_">ModelRef</span>(<span class="string">&quot;string&quot;</span>)).parameterType(<span class="string">&quot;header&quot;</span>).required(<span class="literal">false</span>).build());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Docket</span>(DocumentationType.SWAGGER_2)</span><br><span class="line">                .apiInfo(apiInfo())</span><br><span class="line">                .globalOperationParameters(parameters)</span><br><span class="line">                .select()</span><br><span class="line">                .apis(RequestHandlerSelectors.basePackage(<span class="string">&quot;com.czq&quot;</span>))</span><br><span class="line">                .paths(PathSelectors.any())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApiInfo <span class="title function_">apiInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ApiInfoBuilder</span>()</span><br><span class="line">                .title(<span class="string">&quot;RecycleShopæ–‡æ¡£&quot;</span>)</span><br><span class="line">                .description(<span class="string">&quot;RecycleShopæ–‡æ¡£&quot;</span>)</span><br><span class="line"><span class="comment">//                .termsOfServiceUrl(&quot;/&quot;)</span></span><br><span class="line">                .version(<span class="string">&quot;1.0&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>3.ç½‘å…³å¾®æœåŠ¡é…ç½®<ul><li>pom.xml é‡ç‚¹é…ç½®</li></ul></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-zuul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="comment">&lt;!--ç”Ÿæˆæ¥å£æ–‡æ¡£--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!--æä¾›uiç•Œé¢--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>application.yml æ–‡ä»¶éƒ¨åˆ†é…ç½®ï¼ˆè·¯ç”±é…ç½®ï¼‰</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="attr">manage-service:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/manage-service/**</span></span><br><span class="line">      <span class="attr">serviceId:</span> <span class="string">manage-service</span></span><br><span class="line">      <span class="comment">#      strip-prefix: false</span></span><br><span class="line">      <span class="attr">sensitiveHeaders:</span></span><br></pre></td></tr></table></figure><ul><li>4.ç½‘å…³å¾®æœåŠ¡ä¸­ swagger æ•´åˆ<ul><li>swagger é…ç½®ç¼–å†™</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.czq.gateway.config;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.zuul.filters.Route;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.zuul.filters.RouteLocator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Primary;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.swagger.web.SwaggerResource;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.swagger.web.SwaggerResourcesProvider;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.swagger2.annotations.EnableSwagger2;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">//é€šè¿‡configurationæ³¨è§£è‡ªåŠ¨æ³¨å…¥é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//å¼€å¯swaggeråŠŸèƒ½</span></span><br><span class="line"><span class="meta">@EnableSwagger2</span></span><br><span class="line"><span class="comment">//å¦‚æœæœ‰å¤šä¸ªé…ç½®æ–‡ä»¶ï¼Œä»¥è¿™ä¸ªä¸ºå‡†</span></span><br><span class="line"><span class="meta">@Primary</span></span><br><span class="line"><span class="comment">//å®ç°SwaggerResourcesProviderï¼Œé…ç½®swaggeræ¥å£æ–‡æ¡£çš„æ•°æ®æº</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SwaggerConfig</span>  <span class="keyword">implements</span> <span class="title class_">SwaggerResourcesProvider</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//RouteLocatorå¯ä»¥æ ¹æ®zuulé…ç½®çš„è·¯ç”±åˆ—è¡¨è·å–æœåŠ¡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RouteLocator routeLocator;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SwaggerConfig</span><span class="params">(RouteLocator routeLocator)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.routeLocator = routeLocator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¿™ä¸ªæ–¹æ³•ç”¨æ¥æ·»åŠ swaggerçš„æ•°æ®æº</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;SwaggerResource&gt; <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">List</span> <span class="variable">resources</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">        List&lt;Route&gt; routes = routeLocator.getRoutes();</span><br><span class="line">        <span class="comment">//é€šè¿‡RouteLocatorè·å–è·¯ç”±é…ç½®ï¼Œéå†è·å–æ‰€é…ç½®æœåŠ¡çš„æ¥å£æ–‡æ¡£ï¼Œè¿™æ ·ä¸éœ€è¦æ‰‹åŠ¨æ·»åŠ ï¼Œå®ç°åŠ¨æ€è·å–</span></span><br><span class="line">        <span class="keyword">for</span> (Route route: routes) &#123;</span><br><span class="line">            resources.add(swaggerResource(route.getId(), route.getFullPath().replace(<span class="string">&quot;**&quot;</span>, <span class="string">&quot;v2/api-docs&quot;</span>),<span class="string">&quot;2.0&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resources;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SwaggerResource <span class="title function_">swaggerResource</span><span class="params">(String name, String location, String version)</span> &#123;</span><br><span class="line">        <span class="type">SwaggerResource</span> <span class="variable">swaggerResource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SwaggerResource</span>();</span><br><span class="line">        swaggerResource.setName(name);</span><br><span class="line">        swaggerResource.setLocation(location);</span><br><span class="line">        swaggerResource.setSwaggerVersion(version);</span><br><span class="line">        <span class="keyword">return</span> swaggerResource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>5.åœ¨ä¸» main class ä¸­å¯ç”¨ç½‘å…³</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.czq.gateway;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.zuul.EnableZuulProxy;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableZuulProxy</span><span class="comment">//æ­¤å·¥ç¨‹æ˜¯ä¸€ä¸ªzuulç½‘å…³</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GatewayApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(GatewayApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>6.æ‰“å¼€æµè§ˆå™¨ï¼Œä½¿ç”¨ä»¥ä¸‹åœ°å€æµ‹è¯•</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:port/api/v1.0.1/swagger-ui.html</span><br></pre></td></tr></table></figure><blockquote><p>è¿›å…¥åœ°å€åé€‰æ‹©å¯¹åº”å¾®æœåŠ¡æµ‹è¯•æ•ˆæœ</p></blockquote><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è½»é‡å¿«é€Ÿçš„ Python ASGI uvicorn æ¡†æ¶ä½¿ç”¨</title>
      <link href="/2023/05/15/uvicorn-use/"/>
      <url>/2023/05/15/uvicorn-use/</url>
      
        <content type="html"><![CDATA[<h1>è½»é‡å¿«é€Ÿçš„ Python ASGI uvicorn æ¡†æ¶ä½¿ç”¨</h1><h2 id="ä¸‹è½½ä½¿ç”¨">ä¸‹è½½ä½¿ç”¨</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install fastapi</span><br><span class="line">pip install uvicorn</span><br></pre></td></tr></table></figure><h2 id="ä¼˜ç‚¹">ä¼˜ç‚¹</h2><blockquote><p>Python ä»ç¼ºä¹å¼‚æ­¥çš„ç½‘å…³åè®®æ¥å£ï¼ŒASGI çš„å‡ºç°å¡«è¡¥äº†è¿™ä¸€ç©ºç™½ï¼Œç°åœ¨å¼€å§‹ï¼Œæˆ‘ä»¬èƒ½å¤Ÿä½¿ç”¨å…±åŒçš„æ ‡å‡†ä¸ºæ‰€æœ‰çš„å¼‚æ­¥æ¡†æ¶æ¥å®ç°ä¸€äº›å·¥å…·ï¼ŒASGI å¸®åŠ© Python åœ¨ Web æ¡†æ¶ä¸Šå’Œ Node.JS åŠ Golang ç›¸ç«Ÿäº‰ï¼Œç›®æ ‡æ˜¯è·å¾—é«˜æ€§èƒ½çš„ IO å¯†é›†å‹ä»»åŠ¡ï¼ŒASGI æ”¯æŒ HTTP2 å’Œ WebSocketsï¼ŒWSGI æ˜¯ä¸æ”¯æŒçš„ã€‚</p></blockquote><blockquote><p>Uvicorn ç›®å‰æ”¯æŒ HTTP1.1 å’Œ WebSocketï¼Œè®¡åˆ’æ”¯æŒ HTTP2</p></blockquote><h2 id="æ¡†æ¶ä½¿ç”¨">æ¡†æ¶ä½¿ç”¨</h2><h3 id="å¯åŠ¨">å¯åŠ¨</h3><ul><li>1.è„šæœ¬å¼</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uvicorn example:app</span><br></pre></td></tr></table></figure><ul><li>2.ä»£ç å¼</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">app</span>(<span class="params">scope, receive, send</span>):</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;example:app&quot;</span>, host=<span class="string">&quot;127.0.0.1&quot;</span>, port=<span class="number">5000</span>, log_level=<span class="string">&quot;info&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>3.æ•´åˆ FastAPI</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">root</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hello World&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·¯ç”±æ³¨è§£ å‚æ•°æ³¨è§£</span></span><br><span class="line"><span class="meta">@router.get(<span class="params"><span class="string">&quot;/log/log&quot;</span>, summary=<span class="string">&#x27;summary&#x27;</span>, description=<span class="string">&#x27;desc&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_item</span>(<span class="params">item_id: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="literal">None</span>] = Query(<span class="params">default=<span class="literal">None</span>, alias=<span class="string">&quot;log_id&quot;</span></span>)</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è·å–æŠ¥å‘Šç”Ÿæˆè¿›åº¦</span></span><br><span class="line"><span class="string">    @:parameter item_id log id</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> null;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(app=app)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="åŠŸèƒ½å¼•å…¥">åŠŸèƒ½å¼•å…¥</h3><ul><li>1.å…¨å±€ log</li></ul><h4 id="å¯åŠ¨æ–‡ä»¶é…ç½®">å¯åŠ¨æ–‡ä»¶é…ç½®</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init_app</span>():</span><br><span class="line">    app = FastAPI(title=<span class="string">&quot;&quot;</span>, version=<span class="string">&quot;0.0.1&quot;</span>,</span><br><span class="line">                  description=<span class="string">&quot;&quot;</span>, debug=<span class="literal">True</span>)</span><br><span class="line">    app.include_router(router=api_router, prefix=<span class="string">&quot;/api/v1&quot;</span>)</span><br><span class="line">    logging.getLogger().handlers = [InterceptHandler()]</span><br><span class="line">    logger.configure(</span><br><span class="line">        handlers=[&#123;<span class="string">&quot;sink&quot;</span>: sys.stdout, <span class="string">&quot;level&quot;</span>: logging.DEBUG, <span class="string">&quot;format&quot;</span>: format_record&#125;])</span><br><span class="line">    logger.add(LOG_DIR, encoding=<span class="string">&#x27;utf-8&#x27;</span>, rotation=<span class="string">&quot;9:46&quot;</span>)</span><br><span class="line">    logger.debug(<span class="string">&#x27;æ—¥å¿—ç³»ç»Ÿå·²åŠ è½½&#x27;</span>)</span><br><span class="line">    logging.getLogger(<span class="string">&quot;uvicorn.access&quot;</span>).handlers = [InterceptHandler()]</span><br><span class="line">    <span class="keyword">return</span> app</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = init_app()</span><br></pre></td></tr></table></figure><h4 id="log-åŸºç¡€é…ç½®">log åŸºç¡€é…ç½®</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> pprint <span class="keyword">import</span> pformat</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> http_server.log.log_base <span class="keyword">import</span> LOG_FORMAT</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="comment"># from ..config import config</span></span><br><span class="line"><span class="keyword">from</span> loguru._defaults <span class="keyword">import</span> LOGURU_FORMAT</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InterceptHandler</span>(logging.Handler):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">emit</span>(<span class="params">self, record</span>):</span><br><span class="line">        <span class="comment"># Get corresponding Loguru level if it exists</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            level = logger.level(record.levelname).name</span><br><span class="line">        <span class="keyword">except</span> ValueError:</span><br><span class="line">            level = record.levelno</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Find caller from where originated the logged message</span></span><br><span class="line">        frame, depth = logging.currentframe(), <span class="number">2</span></span><br><span class="line">        <span class="keyword">while</span> frame.f_code.co_filename == logging.__file__:</span><br><span class="line">            frame = frame.f_back</span><br><span class="line">            depth += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        logger.opt(depth=depth, exception=record.exc_info).log(</span><br><span class="line">            level, record.getMessage()</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">format_record</span>(<span class="params">record: <span class="built_in">dict</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    format_string = LOG_FORMAT</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> record[<span class="string">&quot;extra&quot;</span>].get(<span class="string">&quot;payload&quot;</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        record[<span class="string">&quot;extra&quot;</span>][<span class="string">&quot;payload&quot;</span>] = pformat(</span><br><span class="line">            record[<span class="string">&quot;extra&quot;</span>][<span class="string">&quot;payload&quot;</span>], indent=<span class="number">4</span>, compact=<span class="literal">True</span>, width=<span class="number">88</span></span><br><span class="line">        )</span><br><span class="line">        format_string += <span class="string">&quot;\n&lt;level&gt;&#123;extra[payload]&#125;&lt;/level&gt;&quot;</span></span><br><span class="line"></span><br><span class="line">    format_string += <span class="string">&quot;&#123;exception&#125;\n&quot;</span></span><br><span class="line">    <span class="keyword">return</span> format_string</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŸºç¡€å˜é‡é…ç½®</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># -----------------------ç³»ç»Ÿè°ƒè¯•------------------------------------</span></span><br><span class="line">DEBUG = <span class="literal">True</span></span><br><span class="line"><span class="comment"># -----------------------æ—¥å¿—-----------------------------------------</span></span><br><span class="line">LOG_DIR = os.path.join(os.getcwd(), <span class="string">f&#x27;log_dir\\<span class="subst">&#123;time.strftime(<span class="string">&quot;%Y-%m-%d&quot;</span>)&#125;</span>.log&#x27;</span>)</span><br><span class="line">LOG_FORMAT = <span class="string">&#x27;&lt;level&gt;&#123;level: &lt;8&#125;&lt;/level&gt;  &lt;green&gt;&#123;time:YYYY-MM-DD HH:mm:ss.SSS&#125;&lt;/green&gt; - &lt;cyan&gt;&#123;name&#125;&lt;/cyan&gt;:&lt;cyan&gt;&#123;&#x27;</span> \</span><br><span class="line">             <span class="string">&#x27;function&#125;&lt;/cyan&gt; - &lt;level&gt;&#123;message&#125;&lt;/level&gt; &#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>2.å…¨å±€å¼‚å¸¸å¤„ç†</li></ul><h4 id="å¼‚å¸¸ç±»å®šä¹‰">å¼‚å¸¸ç±»å®šä¹‰</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># from rest_framework.exceptions import APIException</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># class Success(APIException):</span></span><br><span class="line"><span class="comment">#     code = 201</span></span><br><span class="line"><span class="comment">#     msg = &#x27;ok&#x27;</span></span><br><span class="line"><span class="comment">#     error_code = 0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># class DeleteSuccess(APIException):</span></span><br><span class="line"><span class="comment">#     code = 202</span></span><br><span class="line"><span class="comment">#     msg = &#x27;delete ok&#x27;</span></span><br><span class="line"><span class="comment">#     error_code = 1</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># class UpdateSuccess(APIException):</span></span><br><span class="line"><span class="comment">#     code = 200</span></span><br><span class="line"><span class="comment">#     msg = &#x27;update ok&#x27;</span></span><br><span class="line"><span class="comment">#     error_code = 2</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># class ServerError(APIException):</span></span><br><span class="line"><span class="comment">#     code = 500</span></span><br><span class="line"><span class="comment">#     msg = &#x27;sorry, we made a mistake!&#x27;</span></span><br><span class="line"><span class="comment">#     error_code = 999</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># class ParameterException(APIException):</span></span><br><span class="line"><span class="comment">#     code = 400</span></span><br><span class="line"><span class="comment">#     msg = &#x27;invalid parameter&#x27;</span></span><br><span class="line"><span class="comment">#     error_code = 1000</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># class NotFound(APIException):</span></span><br><span class="line"><span class="comment">#     code = 404</span></span><br><span class="line"><span class="comment">#     msg = &#x27;the resource are not found&#x27;</span></span><br><span class="line"><span class="comment">#     error_code = 1001</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># class AuthFailed(APIException):</span></span><br><span class="line"><span class="comment">#     code = 401</span></span><br><span class="line"><span class="comment">#     msg = &#x27;authorization failed&#x27;</span></span><br><span class="line"><span class="comment">#     error_code = 1005</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># class Forbidden(APIException):</span></span><br><span class="line"><span class="comment">#     code = 403</span></span><br><span class="line"><span class="comment">#     error_code = 1004</span></span><br><span class="line"><span class="comment">#     msg = &#x27;forbidden, not in scope&#x27;</span></span><br><span class="line"><span class="keyword">from</span> docutils.nodes <span class="keyword">import</span> status</span><br><span class="line"><span class="keyword">from</span> fastapi.encoders <span class="keyword">import</span> jsonable_encoder</span><br><span class="line"><span class="keyword">from</span> fastapi.exceptions <span class="keyword">import</span> RequestValidationError</span><br><span class="line"><span class="keyword">from</span> requests <span class="keyword">import</span> Request</span><br><span class="line"><span class="keyword">from</span> starlette.responses <span class="keyword">import</span> JSONResponse, PlainTextResponse</span><br><span class="line"><span class="keyword">from</span> starlette.exceptions <span class="keyword">import</span> HTTPException <span class="keyword">as</span> StarletteHTTPException</span><br><span class="line"><span class="keyword">from</span> http_server.router <span class="keyword">import</span> router</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">è‡ªå®šä¹‰å¼‚å¸¸</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UnicornException</span>(<span class="title class_ inherited__">Exception</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.name = name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@router.api_router.exception_handler(<span class="params">RequestValidationError</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">validation_exception_handler</span>(<span class="params">request: Request, exc: RequestValidationError</span>):</span><br><span class="line">    <span class="keyword">return</span> JSONResponse(</span><br><span class="line">        status_code=status.HTTP_422_UNPROCESSABLE_ENTITY,</span><br><span class="line">        content=jsonable_encoder(&#123;<span class="string">&quot;detail&quot;</span>: exc.errors(), <span class="string">&quot;body&quot;</span>: exc.body&#125;),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@router.api_router.exception_handler(<span class="params">StarletteHTTPException</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">http_exception_handler</span>(<span class="params">request, exc</span>):</span><br><span class="line">    <span class="keyword">return</span> PlainTextResponse(<span class="built_in">str</span>(exc.detail), status_code=exc.status_code)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@router.api_router.exception_handler(<span class="params">UnicornException</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">unicorn_exception_handler</span>(<span class="params">request: Request, exc: UnicornException</span>):</span><br><span class="line">    <span class="keyword">return</span> JSONResponse(</span><br><span class="line">        status_code=<span class="number">418</span>,</span><br><span class="line">        content=&#123;<span class="string">&quot;message&quot;</span>: <span class="string">f&quot;Oops! <span class="subst">&#123;exc.name&#125;</span> did something. There goes a rainbow...&quot;</span>&#125;,</span><br><span class="line">    )</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨">ä½¿ç”¨</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@router.get(<span class="params"><span class="string">&quot;/&#123;id&#125;&quot;</span>, summary=<span class="string">&#x27;æµ‹è¯•æ¥å£&#x27;</span>, description=<span class="string">&#x27;æµ‹è¯•æ¥å£&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_root</span>(<span class="params"><span class="built_in">id</span>: <span class="built_in">int</span> = Path(<span class="params">title=<span class="string">&quot;id not null&quot;</span></span>)</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æµ‹è¯•æ¥å£</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">id</span> == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(<span class="number">404</span>, <span class="string">&quot;no data&quot;</span>)</span><br><span class="line">    datas = &#123;</span><br><span class="line">        <span class="string">&quot;hello &quot;</span>: <span class="string">&quot;wprils&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> JsonResponse.success(datas)</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>3.è·¯ç”±å®šä¹‰</li></ul><h4 id="å¯åŠ¨æ–‡ä»¶é…ç½®-2">å¯åŠ¨æ–‡ä»¶é…ç½®</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.include_router(router=api_router, prefix=<span class="string">&quot;/api/v1&quot;</span>)</span><br></pre></td></tr></table></figure><h4 id="è·¯ç”±æ–‡ä»¶é…ç½®">è·¯ç”±æ–‡ä»¶é…ç½®</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> APIRouter</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> http_server.response.JsonResponse <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">from</span> http_server.view <span class="keyword">import</span> log_process</span><br><span class="line"></span><br><span class="line">api_router = APIRouter()</span><br><span class="line">api_router.include_router(log_process.router, prefix=<span class="string">&quot;/shell&quot;</span>, tags=[<span class="string">&#x27;è„šæœ¬æ“ä½œ&#x27;</span>])</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="æ¥å£å®šä¹‰">æ¥å£å®šä¹‰</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> APIRouter</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> http_server.response.JsonResponse <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">from</span> http_server.request.http_request <span class="keyword">import</span> data_process, get_csv_data</span><br><span class="line"><span class="keyword">from</span> http_server.tools.file_process <span class="keyword">import</span> download_csv_data</span><br><span class="line"><span class="keyword">from</span> run.application_main <span class="keyword">import</span> run_process_thread</span><br><span class="line"></span><br><span class="line">router = APIRouter()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@router.get(<span class="params"><span class="string">&quot;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_root</span>():</span><br><span class="line">    datas = &#123;</span><br><span class="line">        <span class="string">&quot;hello &quot;</span>: <span class="string">&quot;wprils&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> JsonResponse.success(datas)</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>4.ç»Ÿä¸€è¿”å›å€¼</li></ul><h4 id="å®šä¹‰">å®šä¹‰</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JsonResponse</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ç»Ÿä¸€çš„jsonè¿”å›æ ¼å¼</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, data, code, msg</span>):</span><br><span class="line">        <span class="variable language_">self</span>.data = data</span><br><span class="line">        <span class="variable language_">self</span>.code = code</span><br><span class="line">        <span class="variable language_">self</span>.msg = msg</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">success</span>(<span class="params">cls, data=<span class="literal">None</span>, code=<span class="number">0</span>, msg=<span class="string">&#x27;success&#x27;</span></span>):</span><br><span class="line">        <span class="keyword">return</span> cls(data, code, msg)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">error</span>(<span class="params">cls, data=<span class="literal">None</span>, code=-<span class="number">1</span>, msg=<span class="string">&#x27;error&#x27;</span></span>):</span><br><span class="line">        <span class="keyword">return</span> cls(data, code, msg)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">to_dict</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;code&quot;</span>: <span class="variable language_">self</span>.code,</span><br><span class="line">            <span class="string">&quot;msg&quot;</span>: <span class="variable language_">self</span>.msg,</span><br><span class="line">            <span class="string">&quot;data&quot;</span>: <span class="variable language_">self</span>.data</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨-2">ä½¿ç”¨</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@router.get(<span class="params"><span class="string">&quot;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_root</span>():</span><br><span class="line">    datas = &#123;</span><br><span class="line">        <span class="string">&quot;hello &quot;</span>: <span class="string">&quot;wprils&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> JsonResponse.success(datas)</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</h2><ul><li>[1].<a href="https://fastapi.tiangolo.com/zh/tutorial/path-params-numeric-validations/">https://fastapi.tiangolo.com/zh/tutorial/path-params-numeric-validations/</a></li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨ Electron æ¡†æ¶ä¸­ http è¯·æ±‚ä¸ Java åç«¯ websocket æœåŠ¡ç«¯é€šä¿¡</title>
      <link href="/2023/05/09/web-socket-electron/"/>
      <url>/2023/05/09/web-socket-electron/</url>
      
        <content type="html"><![CDATA[<h1>ä½¿ç”¨ Electron æ¡†æ¶ä¸­ http è¯·æ±‚ä¸ Java åç«¯ websocket æœåŠ¡ç«¯é€šä¿¡</h1><h2 id="Electron-æ¡†æ¶åŸºæœ¬æ­å»º">Electron æ¡†æ¶åŸºæœ¬æ­å»º</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å‚è§ã€ŠElectron Egg æ¡†æ¶ç ”ç©¶ã€‹ä¸€æ–‡</span><br></pre></td></tr></table></figure><h2 id="åç«¯-Websocker-æœåŠ¡å»ºç«‹">åç«¯ Websocker æœåŠ¡å»ºç«‹</h2><h3 id="åŸºç¡€ç¯å¢ƒé…ç½®">åŸºç¡€ç¯å¢ƒé…ç½®</h3><ul><li>1.pom.xml æ–‡ä»¶å¼•å…¥ websocket åŒ…</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>2.åç«¯æœåŠ¡æ­å»º</li><li>websocket é…ç½®</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.czq.shop.handler.WebSocketHandler;</span><br><span class="line"><span class="keyword">import</span> com.czq.shop.interceptor.WebSocketInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.config.annotation.EnableWebSocket;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.config.annotation.WebSocketConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.config.annotation.WebSocketHandlerRegistry;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSocket</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebsocketConfiguration</span> <span class="keyword">implements</span> <span class="title class_">WebSocketConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerWebSocketHandlers</span><span class="params">(WebSocketHandlerRegistry registry)</span> &#123;</span><br><span class="line">        <span class="comment">// webSocketé€šé“</span></span><br><span class="line">        <span class="comment">// æŒ‡å®šå¤„ç†å™¨å’Œè·¯å¾„</span></span><br><span class="line">        registry.addHandler(<span class="keyword">new</span> <span class="title class_">WebSocketHandler</span>(), <span class="string">&quot;/websocket&quot;</span>)</span><br><span class="line">                <span class="comment">// æŒ‡å®šè‡ªå®šä¹‰æ‹¦æˆªå™¨</span></span><br><span class="line">                .addInterceptors(<span class="keyword">new</span> <span class="title class_">WebSocketInterceptor</span>())</span><br><span class="line">                <span class="comment">// å…è®¸è·¨åŸŸ</span></span><br><span class="line">                .setAllowedOrigins(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        <span class="comment">// sockJsé€šé“</span></span><br><span class="line">        registry.addHandler(<span class="keyword">new</span> <span class="title class_">WebSocketHandler</span>(), <span class="string">&quot;/sock-js&quot;</span>)</span><br><span class="line">                .addInterceptors(<span class="keyword">new</span> <span class="title class_">WebSocketInterceptor</span>())</span><br><span class="line">                .setAllowedOrigins(<span class="string">&quot;*&quot;</span>)</span><br><span class="line">                <span class="comment">// å¼€å¯sockJsæ”¯æŒ</span></span><br><span class="line">                .withSockJS();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>handle æ–‡ä»¶ç¼–å†™</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.handler.AbstractWebSocketHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketHandler</span> <span class="keyword">extends</span> <span class="title class_">AbstractWebSocketHandler</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å­˜å‚¨sessionIdå’ŒwebSocketSession</span></span><br><span class="line"><span class="comment">     * éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒwebSocketSessionæ²¡æœ‰æä¾›æ— å‚æ„é€ ï¼Œä¸èƒ½è¿›è¡Œåºåˆ—åŒ–ï¼Œä¹Ÿå°±ä¸èƒ½é€šè¿‡rediså­˜å‚¨</span></span><br><span class="line"><span class="comment">     * åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œè¦æƒ³åˆ«çš„åŠæ³•å®ç°webSocketSessionå…±äº«</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, WebSocketSession&gt; sessionMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, String&gt; userMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * webSocketè¿æ¥åˆ›å»ºåè°ƒç”¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterConnectionEstablished</span><span class="params">(WebSocketSession session)</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–å‚æ•°</span></span><br><span class="line"><span class="comment">//session.g6</span></span><br><span class="line"><span class="comment">//        String user = String.valueOf(session.getUri().getPath().get(&quot;user&quot;));</span></span><br><span class="line">        userMap.put(<span class="string">&quot;user&quot;</span>, session.getId());</span><br><span class="line">        sessionMap.put(session.getId(), session);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¥æ”¶åˆ°æ¶ˆæ¯ä¼šè°ƒç”¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(WebSocketSession session, WebSocketMessage&lt;?&gt; message)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSONObject.parseObject(message.getPayload().toString());</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> jsonObject.getString(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> jsonObject.getString(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">        sendMessage(username, <span class="string">&quot;hello user&quot;</span>);</span><br><span class="line">        sendMessage(username, <span class="string">&quot;data content is json data&quot;</span>+password+message.getPayload().toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿æ¥å‡ºé”™ä¼šè°ƒç”¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleTransportError</span><span class="params">(WebSocketSession session, Throwable exception)</span> &#123;</span><br><span class="line">        sessionMap.remove(session.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿æ¥å…³é—­ä¼šè°ƒç”¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterConnectionClosed</span><span class="params">(WebSocketSession session, CloseStatus status)</span> &#123;</span><br><span class="line">        sessionMap.remove(session.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supportsPartialMessages</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åç«¯å‘é€æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(String user, String message)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sessionId</span> <span class="operator">=</span> userMap.get(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(sessionId)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">WebSocketSession</span> <span class="variable">session</span> <span class="operator">=</span> sessionMap.get(sessionId);</span><br><span class="line">        <span class="keyword">if</span> (session == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        session.sendMessage(<span class="keyword">new</span> <span class="title class_">TextMessage</span>(message));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>interceptor æ–‡ä»¶ç¼–å†™</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.czq.shop.interceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.ServerHttpRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.ServerHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.ServletServerHttpRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.WebSocketHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.server.HandshakeInterceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandshakeInterceptor</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * handlerå¤„ç†å‰è°ƒç”¨,attributeså±æ€§æœ€ç»ˆåœ¨WebSocketSessioné‡Œ,</span></span><br><span class="line"><span class="comment">     * å¯èƒ½é€šè¿‡webSocketSession.getAttributes().get(keyå€¼)è·å¾—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">beforeHandshake</span><span class="params">(ServerHttpRequest request, ServerHttpResponse response, WebSocketHandler wsHandler, Map&lt;String, Object&gt; attributes)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (request <span class="keyword">instanceof</span> ServletServerHttpRequest) &#123;</span><br><span class="line">            <span class="type">ServletServerHttpRequest</span> <span class="variable">serverHttpRequest</span> <span class="operator">=</span> (ServletServerHttpRequest) request;</span><br><span class="line">            <span class="comment">// è·å–è¯·æ±‚è·¯å¾„æºå¸¦çš„å‚æ•°</span></span><br><span class="line"><span class="comment">//            String url = serverHttpRequest.getURI().getPath();</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">user</span> <span class="operator">=</span> serverHttpRequest.getServletRequest().getParameter(<span class="string">&quot;user&quot;</span>);</span><br><span class="line"><span class="comment">//            serverHttpRequest.getBody().g/</span></span><br><span class="line">            attributes.put(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line"><span class="comment">//            response.getHeaders().ge</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterHandshake</span><span class="params">(ServerHttpRequest request, ServerHttpResponse response, WebSocketHandler wsHandler, Exception exception)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åœ¨æ­¤ä¹‹åå¯åŠ¨åç«¯</li></ul><h2 id="å‰ç«¯-wesocket-client-è¯·æ±‚å‘èµ·">å‰ç«¯ wesocket client è¯·æ±‚å‘èµ·</h2><ul><li>ç¬¬ä¸‰æ–¹åº“å®‰è£…</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install ReconnectingWebSocket</span><br></pre></td></tr></table></figure><ul><li>1.ç¼–å†™ HTML ç•Œé¢ï¼Œç¼–å†™å•å‡»äº‹ä»¶</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">el-button</span> <span class="attr">type</span>=<span class="string">&quot;primary&quot;</span> <span class="attr">round</span> @<span class="attr">click</span>=<span class="string">&quot;websocket()&quot;</span></span></span><br><span class="line"><span class="tag">  &gt;</span>&#123;&#123; $t(&quot;buttons.api&quot;) &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">el-button</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>2.ç¼–å†™å•å‡»äº‹ä»¶æ–¹æ³•è°ƒç”¨æœåŠ¡ç«¯ websocket æœåŠ¡</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">websocket</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> websocket = <span class="keyword">new</span> <span class="title class_">ReconnectingWebSocket</span>(local_url);</span><br><span class="line">                websocket.<span class="title function_">addEventListener</span>(<span class="string">&#x27;open&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    websocket.<span class="title function_">send</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(<span class="variable language_">this</span>.<span class="property">person_msg</span>).<span class="title function_">toString</span>());</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="comment">//è¿æ¥å‘ç”Ÿé”™è¯¯çš„å›è°ƒæ–¹æ³•</span></span><br><span class="line">                websocket.<span class="property">onerror</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//è¿æ¥æˆåŠŸå»ºç«‹çš„å›è°ƒæ–¹æ³•</span></span><br><span class="line">                websocket.<span class="property">onopen</span> = <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;-----&quot;</span>)</span><br><span class="line">                <span class="comment">//æ¥æ”¶åˆ°æ¶ˆæ¯çš„å›è°ƒæ–¹æ³•</span></span><br><span class="line">                websocket.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ”¶åˆ°æ¶ˆæ¯&#x27;</span>)</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">data</span> = event.<span class="property">data</span>;</span><br><span class="line">                    <span class="variable language_">console</span>.<span class="title function_">log</span>(event.<span class="property">data</span>);</span><br><span class="line">                    <span class="comment">// setTimeout(function () &#123;</span></span><br><span class="line">                    websocket.<span class="title function_">send</span>(<span class="string">&#x27;get data&#x27;</span>);</span><br><span class="line">                    <span class="comment">// &#125;,2000)</span></span><br><span class="line">                    ipcRenderer.<span class="title function_">send</span>(<span class="string">&#x27;openit&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br></pre></td></tr></table></figure><h3 id="æ™®é€š-http-è¯·æ±‚çš„å‘èµ·">æ™®é€š http è¯·æ±‚çš„å‘èµ·</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">&quot;@/utils/request&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getInfo</span>(<span class="params">token</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&quot;/shop/monitor/getOrderCount&quot;</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&quot;get&quot;</span>,</span><br><span class="line">    <span class="attr">params</span>: &#123; token &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>request.js é…ç½®æ–‡ä»¶</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&quot;axios&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Message</span> &#125; <span class="keyword">from</span> <span class="string">&quot;element-ui&quot;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(process.<span class="property">env</span>.<span class="property">userConfig</span>);</span><br><span class="line"><span class="comment">// const process.env.userConfig.BASE_API = &#x27;http://127.0.0.1:10086&#x27;</span></span><br><span class="line"><span class="keyword">const</span> serves = axios.<span class="title function_">create</span>(&#123;</span><br><span class="line">  <span class="attr">baseURL</span>: process.<span class="property">env</span>.<span class="property">userConfig</span>.<span class="property">BASE_API</span>,</span><br><span class="line">  <span class="attr">timeout</span>: <span class="number">5000</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®è¯·æ±‚å‘é€ä¹‹å‰çš„æ‹¦æˆªå™¨</span></span><br><span class="line">serves.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(</span><br><span class="line">  <span class="function">(<span class="params">config</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// è®¾ç½®å‘é€ä¹‹å‰æ•°æ®éœ€è¦åšä»€ä¹ˆå¤„ç†</span></span><br><span class="line">    config.<span class="property">baseURL</span> = <span class="string">&quot;http://0.0.0.0:10086&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> config;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function">(<span class="params">err</span>) =&gt;</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(err)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®è¯·æ±‚æ¥å—æ‹¦æˆªå™¨</span></span><br><span class="line">serves.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(</span><br><span class="line">  <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// è®¾ç½®æ¥å—æ•°æ®ä¹‹åï¼Œåšä»€ä¹ˆå¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> (res.<span class="property">data</span>.<span class="property">code</span> === <span class="number">50000</span>) &#123;</span><br><span class="line">      <span class="title class_">Message</span>.<span class="title function_">error</span>(res.<span class="property">data</span>.<span class="property">data</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="property">data</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­è¯·æ±‚å¼‚å¸¸ä¿¡æ¯ä¸­æ˜¯å¦å«æœ‰è¶…æ—¶timeoutå­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="keyword">if</span> (err.<span class="property">message</span>.<span class="title function_">includes</span>(<span class="string">&quot;timeout&quot;</span>)) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;é”™è¯¯å›è°ƒ&quot;</span>, err);</span><br><span class="line">      <span class="title class_">Message</span>.<span class="title function_">error</span>(<span class="string">&quot;ç½‘ç»œè¶…æ—¶&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (err.<span class="property">message</span>.<span class="title function_">includes</span>(<span class="string">&quot;Network Error&quot;</span>)) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;é”™è¯¯å›è°ƒ&quot;</span>, err);</span><br><span class="line">      <span class="title class_">Message</span>.<span class="title function_">error</span>(<span class="string">&quot;æœåŠ¡ç«¯æœªå¯åŠ¨ï¼Œæˆ–ç½‘ç»œè¿æ¥é”™è¯¯&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(err);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†servesæŠ›å‡ºå»</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> serves;</span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> electron </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨ django-rest-framework æ¡†æ¶ç¼–å†™æ¥å£ä¸é¡µé¢</title>
      <link href="/2023/05/09/rest-framework-user/"/>
      <url>/2023/05/09/rest-framework-user/</url>
      
        <content type="html"><![CDATA[<h1>ä½¿ç”¨ django-rest-framework æ¡†æ¶ç¼–å†™æ¥å£ä¸é¡µé¢</h1><h2 id="åŸºç¡€ç¯å¢ƒæ­å»º">åŸºç¡€ç¯å¢ƒæ­å»º</h2><ul><li>1.python åŸºç¡€ç¯å¢ƒä¸ç¬¬ä¸‰æ–¹åº“æ­å»º<ul><li>python åŸºç¡€ç¯å¢ƒå®‰è£…ï¼Œåœ°å€</li></ul></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.python.org/downloads/</span><br></pre></td></tr></table></figure><pre><code>- å¼€å‘å·¥å…·ä½¿ç”¨ Pycharm æˆ– Anaconda</code></pre><ul><li>2.ç¬¬ä¸‰æ–¹åº“ä¸‹è½½å®‰è£…</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pip install django-restframework-swagger</span><br><span class="line">pip install django-rest-framework</span><br><span class="line">pip install django-rest-framework-jwt</span><br><span class="line"><span class="comment"># æˆ–è€…</span></span><br><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure><ul><li>3.simpleui ä¸‹è½½å®‰è£…</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/newpanjing/simpleui_demo</span><br><span class="line">python manage.py runserver 8000 <span class="comment">#è¿è¡Œ</span></span><br></pre></td></tr></table></figure><blockquote><p>æˆ–è€…ä½¿ç”¨ Docker æ„å»º</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull newpanjing/simpleui_demo</span><br><span class="line"></span><br><span class="line">docker run -p 8080:8080 newpanjing/simpleui_demo</span><br></pre></td></tr></table></figure><h2 id="rest-framework-django-æ¦‚è¿°">rest-framework-django æ¦‚è¿°</h2><blockquote><p>Djangoâ€™s class-based views are a welcome departure from the old-style views.</p></blockquote><blockquote><p>Django REST framework is a powerful and flexible toolkit for building Web APIs.</p></blockquote><ul><li><p>Some reasons you might want to use REST framework:</p></li><li><p>The Web browsable API is a huge usability win for your developers.</p></li><li><p>Authentication policies including packages for OAuth1a and OAuth2.</p></li><li><p>Serialization that supports both ORM and non-ORM data sources.</p></li><li><p>Customizable all the way down - just use regular function-based views if you donâ€™t need the more powerful features.</p></li><li><p>Extensive documentation, and great community support.</p></li><li><p>Used and trusted by internationally recognised companies including Mozilla, Red Hat, Heroku, and Eventbrite.</p></li></ul><h3 id="æ¡†æ¶å®‰è£…">æ¡†æ¶å®‰è£…</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install djangorestframework</span><br></pre></td></tr></table></figure><h2 id="é¡¹ç›®é…ç½®">é¡¹ç›®é…ç½®</h2><ul><li><a href="http://1.setteings.py">1.setteings.py</a> é…ç½®</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Django settings for shellapi project.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Generated by &#x27;django-admin startproject&#x27; using Django 2.1.7.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">For more information on this file, see</span></span><br><span class="line"><span class="string">https://docs.djangoproject.com/en/2.1/topics/settings/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">For the full list of settings and their values, see</span></span><br><span class="line"><span class="string">https://docs.djangoproject.com/en/2.1/ref/settings/</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># Build paths inside the project like this: os.path.join(BASE_DIR, ...)</span></span><br><span class="line">BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Quick-start development settings - unsuitable for production</span></span><br><span class="line"><span class="comment"># See https://docs.djangoproject.com/en/2.1/howto/deployment/checklist/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SECURITY WARNING: keep the secret key used in production secret!</span></span><br><span class="line">SECRET_KEY = <span class="string">&#x27;&amp;%up9@!s_$$4(qurnori=vit2#kg!bzs$_+m64^j$2-vzibx&amp;p&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SECURITY WARNING: don&#x27;t run with debug turned on in production!</span></span><br><span class="line">DEBUG = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">ALLOWED_HOSTS = [<span class="string">&#x27;*&#x27;</span>, ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Application definition</span></span><br><span class="line"></span><br><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="string">&#x27;simpleui&#x27;</span>,<span class="comment"># simpleui æ¡†æ¶</span></span><br><span class="line">    <span class="string">&#x27;drf_spectacular&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;drf_spectacular_sidecar&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;rest_framework&quot;</span>,</span><br><span class="line">    <span class="string">&quot;rest_framework_swagger&quot;</span>,</span><br><span class="line">    <span class="string">&#x27;import_export&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.admin&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.auth&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.contenttypes&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.sessions&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.messages&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.staticfiles&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;shell_sc&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;drf_yasg&#x27;</span>,  <span class="comment">#swagger-ui</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">MIDDLEWARE = [</span><br><span class="line">    <span class="string">&#x27;django.middleware.security.SecurityMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.sessions.middleware.SessionMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.middleware.common.CommonMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.middleware.csrf.CsrfViewMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.auth.middleware.AuthenticationMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.messages.middleware.MessageMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.middleware.clickjacking.XFrameOptionsMiddleware&#x27;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">ROOT_URLCONF = <span class="string">&#x27;shellapi.urls&#x27;</span></span><br><span class="line"></span><br><span class="line">TEMPLATES = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;django.template.backends.django.DjangoTemplates&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;DIRS&#x27;</span>: [os.path.join(BASE_DIR, <span class="string">&#x27;templates&#x27;</span>)],</span><br><span class="line">        <span class="string">&#x27;APP_DIRS&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&#x27;OPTIONS&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;context_processors&#x27;</span>: [</span><br><span class="line">                <span class="string">&#x27;django.template.context_processors.debug&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.template.context_processors.request&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.contrib.auth.context_processors.auth&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.contrib.messages.context_processors.messages&#x27;</span>,</span><br><span class="line">            ],</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">WSGI_APPLICATION = <span class="string">&#x27;shellapi.wsgi.application&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Database éœ€æå‰å®‰è£…pymysql</span></span><br><span class="line"><span class="comment"># https://docs.djangoproject.com/en/2.1/ref/settings/#databases</span></span><br><span class="line"></span><br><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="comment"># &#x27;default&#x27;: &#123;</span></span><br><span class="line">    <span class="comment">#     &#x27;ENGINE&#x27;: &#x27;django.db.backends.sqlite3&#x27;,</span></span><br><span class="line">    <span class="comment">#     &#x27;NAME&#x27;: os.path.join(BASE_DIR, &#x27;db.sqlite3&#x27;),</span></span><br><span class="line">    <span class="comment"># &#125;</span></span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.db.backends.mysql&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&#x27;sh_data&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;USER&#x27;</span>: <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;PASSWORD&#x27;</span>: <span class="string">&#x27;1111&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;HOST&#x27;</span>: <span class="string">&#x27;111.2.3.4&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;PORT&#x27;</span>: <span class="string">&#x27;3306&#x27;</span>,</span><br><span class="line">        <span class="comment"># &#x27;NAME&#x27;: &#x27;&#x27;,</span></span><br><span class="line">        <span class="string">&#x27;OPTIONS&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;init_command&quot;</span>: <span class="string">&quot;SET foreign_key_checks = 0;&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Password validation</span></span><br><span class="line"><span class="comment"># https://docs.djangoproject.com/en/2.1/ref/settings/#auth-password-validators</span></span><br><span class="line"></span><br><span class="line">AUTH_PASSWORD_VALIDATORS = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&#x27;django.contrib.auth.password_validation.UserAttributeSimilarityValidator&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&#x27;django.contrib.auth.password_validation.MinimumLengthValidator&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&#x27;django.contrib.auth.password_validation.CommonPasswordValidator&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&#x27;django.contrib.auth.password_validation.NumericPasswordValidator&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Internationalization</span></span><br><span class="line"><span class="comment"># https://docs.djangoproject.com/en/2.1/topics/i18n/</span></span><br><span class="line"></span><br><span class="line">LANGUAGE_CODE = <span class="string">&#x27;zh-hans&#x27;</span></span><br><span class="line"><span class="comment"># LANGUAGE_CODE = &#x27;en-us&#x27;</span></span><br><span class="line"><span class="comment"># LANGUAGE_CODE = &#x27;ja&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TIME_ZONE = <span class="string">&#x27;Asia/Shanghai&#x27;</span></span><br><span class="line"></span><br><span class="line">USE_I18N = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">USE_L10N = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">USE_TZ = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Static files (CSS, JavaScript, Images)</span></span><br><span class="line"><span class="comment"># https://docs.djangoproject.com/en/2.1/howto/static-files/</span></span><br><span class="line"></span><br><span class="line">STATIC_URL = <span class="string">&#x27;/static/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># STATICFILES_DIRS = [</span></span><br><span class="line"><span class="comment">#      os.path.join(BASE_DIR, &quot;static&quot;),</span></span><br><span class="line"><span class="comment">#  ]</span></span><br><span class="line">STATIC_ROOT = os.path.join(BASE_DIR, <span class="string">&quot;static&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># simpleui è®¾ç½®</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é¦–é¡µé…ç½®</span></span><br><span class="line"><span class="comment"># SIMPLEUI_HOME_PAGE = &#x27;https://www.baidu.com&#x27;</span></span><br><span class="line"><span class="comment"># é¦–é¡µæ ‡é¢˜</span></span><br><span class="line">SIMPLEUI_HOME_TITLE = <span class="string">&#x27;åå°ç®¡ç†&#x27;</span></span><br><span class="line"><span class="comment"># é¦–é¡µå›¾æ ‡,æ”¯æŒelement-uiçš„å›¾æ ‡å’Œfontawesomeçš„å›¾æ ‡</span></span><br><span class="line">SIMPLEUI_HOME_ICON = <span class="string">&#x27;el-icon-date&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®simpleui ç‚¹å‡»é¦–é¡µå›¾æ ‡è·³è½¬çš„åœ°å€</span></span><br><span class="line">SIMPLEUI_INDEX = <span class="string">&#x27;/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é¦–é¡µæ˜¾ç¤ºæœåŠ¡å™¨ã€pythonã€djangoã€simpleuiç›¸å…³ä¿¡æ¯</span></span><br><span class="line">SIMPLEUI_HOME_INFO = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é¦–é¡µæ˜¾ç¤ºå¿«é€Ÿæ“ä½œ</span></span><br><span class="line">SIMPLEUI_HOME_QUICK = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é¦–é¡µæ˜¾ç¤ºæœ€è¿‘åŠ¨ä½œ</span></span><br><span class="line">SIMPLEUI_HOME_ACTION = <span class="literal">False</span></span><br><span class="line"><span class="comment"># SIMPLEUI_HOME_INFO = False</span></span><br><span class="line"><span class="comment"># è‡ªå®šä¹‰SIMPLEUIçš„Logo</span></span><br><span class="line"><span class="comment"># SIMPLEUI_LOGO = &#x27;https://avatars2.githubusercontent.com/u/13655483?s=60&amp;v=4&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç™»å½•é¡µç²’å­åŠ¨ç”»ï¼Œé»˜è®¤å¼€å¯ï¼ŒFalseå…³é—­</span></span><br><span class="line"><span class="comment"># SIMPLEUI_LOGIN_PARTICLES = False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®©simpleui ä¸è¦æ”¶é›†ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">SIMPLEUI_ANALYSIS = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è‡ªå®šä¹‰simpleui èœå•</span></span><br><span class="line">SIMPLEUI_CONFIG = &#123;</span><br><span class="line">    <span class="comment"># åœ¨è‡ªå®šä¹‰èœå•çš„åŸºç¡€ä¸Šä¿ç•™ç³»ç»Ÿæ¨¡å—</span></span><br><span class="line">    <span class="string">&#x27;system_keep&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">    <span class="string">&#x27;menus&#x27;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;app&#x27;</span>: <span class="string">&#x27;shell_sc&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;æ¥å£æµ‹è¯•&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;icon&#x27;</span>: <span class="string">&#x27;fas fa-user-shield&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;models&#x27;</span>: [&#123;</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;è„šæœ¬è°ƒç”¨&#x27;</span>,</span><br><span class="line">                <span class="comment"># æ³¨æ„urlæŒ‰&#x27;/admin/åº”ç”¨åå°å†™/æ¨¡å‹åå°å†™/&#x27;å‘½åã€‚</span></span><br><span class="line">                <span class="string">&#x27;icon&#x27;</span>: <span class="string">&#x27;fa fa-surprise&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;url&#x27;</span>: <span class="string">&#x27;/admin/shell_sc/shellmodel/&#x27;</span></span><br><span class="line">            &#125;]</span><br><span class="line">        &#125;,</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ˜¯å¦æ˜¾ç¤ºé»˜è®¤å›¾æ ‡ï¼Œé»˜è®¤=True</span></span><br><span class="line"><span class="comment"># SIMPLEUI_DEFAULT_ICON = False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å›¾æ ‡è®¾ç½®ï¼Œå›¾æ ‡å‚è€ƒï¼š</span></span><br><span class="line">SIMPLEUI_ICON = &#123;</span><br><span class="line">    <span class="string">&#x27;æ¥å£æµ‹è¯•&#x27;</span>: <span class="string">&#x27;fab fa-apple&#x27;</span>,</span><br><span class="line">    <span class="comment"># &#x27;å‘˜å·¥ç®¡ç†&#x27;: &#x27;fas fa-user-tie&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šsimpleui æ˜¯å¦ä»¥è„±æœºæ¨¡å¼åŠ è½½é™æ€èµ„æºï¼Œä¸ºTrueçš„æ—¶å€™å°†é»˜è®¤ä»æœ¬åœ°è¯»å–æ‰€æœ‰èµ„æºï¼Œå³ä½¿æ²¡æœ‰è”ç½‘ä¸€æ ·å¯ä»¥ã€‚é€‚åˆå†…ç½‘é¡¹ç›®</span></span><br><span class="line"><span class="comment"># ä¸å¡«è¯¥é¡¹æˆ–è€…ä¸ºFalseçš„æ—¶å€™ï¼Œé»˜è®¤ä»ç¬¬ä¸‰æ–¹çš„cdnè·å–</span></span><br><span class="line"></span><br><span class="line">SIMPLEUI_STATIC_OFFLINE = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ä¸Šä¼ ç›®å½•</span></span><br><span class="line">MEDIA_ROOT = os.path.join(BASE_DIR, <span class="string">&#x27;../cml&#x27;</span>)</span><br><span class="line"><span class="comment"># è®¾ç½®å‰ç¼€</span></span><br><span class="line">MEDIA_URL = <span class="string">&#x27;../../cml/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é»˜è®¤ä¸»é¢˜ è®¾ç½®</span></span><br><span class="line">SIMPLEUI_DEFAULT_THEME = <span class="string">&#x27;x-blue.css&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># django 3.2è¦é…ç½®</span></span><br><span class="line">DEFAULT_AUTO_FIELD = <span class="string">&#x27;django.db.models.BigAutoField&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># swagger-ui</span></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="comment"># YOUR SETTINGS</span></span><br><span class="line">    <span class="string">&#x27;DEFAULT_SCHEMA_CLASS&#x27;</span>: <span class="string">&#x27;drf_spectacular.openapi.AutoSchema&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;DEFAULT_PERMISSION_CLASSES&#x27;</span>: (</span><br><span class="line">        <span class="comment"># &#x27;rest_framework.permissions.IsAuthenticated&#x27;,</span></span><br><span class="line">        <span class="string">&#x27;rest_framework.permissions.AllowAny&#x27;</span>,</span><br><span class="line">    ),</span><br><span class="line">    <span class="string">&#x27;DEFAULT_AUTHENTICATION_CLASSES&#x27;</span>: (</span><br><span class="line">        <span class="comment"># &#x27;rest_framework_jwt.authentication.JSONWebTokenAuthentication&#x27;,</span></span><br><span class="line">        <span class="comment"># &#x27;rest_framework.authentication.BasicAuthentication&#x27;,</span></span><br><span class="line">        <span class="comment"># &#x27;rest_framework.authentication.SessionAuthentication&#x27;,</span></span><br><span class="line">        <span class="comment"># &#x27;rest_framework.authentication.TokenAuthentication&#x27;,</span></span><br><span class="line">    ),</span><br><span class="line">    <span class="string">&#x27;DEFAULT_PARSER_CLASSES&#x27;</span>: [</span><br><span class="line">        <span class="string">&#x27;rest_framework.parsers.FormParser&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;rest_framework.parsers.MultiPartParser&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;rest_framework.parsers.JSONParser&#x27;</span>,</span><br><span class="line">    ],</span><br><span class="line">    <span class="comment"># å…¨å±€é…ç½®å¼‚å¸¸æ¨¡å—</span></span><br><span class="line">    <span class="comment"># &#x27;EXCEPTION_HANDLER&#x27;: &#x27;utils.exception.custom_exception_handler&#x27;,</span></span><br><span class="line">    <span class="comment"># # ä¿®æ”¹é»˜è®¤è¿”å›JSONçš„rendererçš„ç±»</span></span><br><span class="line">    <span class="comment"># &#x27;DEFAULT_RENDERER_CLASSES&#x27;: (</span></span><br><span class="line">    <span class="comment">#     &#x27;rendererresponse.customRenderer&#x27;,</span></span><br><span class="line">    <span class="comment"># ),</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SPECTACULAR_SETTINGS = &#123;</span><br><span class="line">    <span class="string">&#x27;SECURITY_DEFINITIONS&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;basic&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;apiKey&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;in&#x27;</span>: <span class="string">&#x27;header&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Authorization&#x27;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment"># å¦‚æœéœ€è¦ç™»å½•æ‰èƒ½å¤ŸæŸ¥çœ‹æ¥å£æ–‡æ¡£, ç™»å½•çš„é“¾æ¥ä½¿ç”¨restframeworkè‡ªå¸¦çš„.</span></span><br><span class="line">    <span class="string">&#x27;LOGIN_URL&#x27;</span>: <span class="string">&#x27;rest_framework:login&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;LOGOUT_URL&#x27;</span>: <span class="string">&#x27;rest_framework:logout&#x27;</span>,</span><br><span class="line">    <span class="comment"># &#x27;DOC_EXPANSION&#x27;: None,</span></span><br><span class="line">    <span class="comment"># &#x27;SHOW_REQUEST_HEADERS&#x27;:True,</span></span><br><span class="line">    <span class="comment"># &#x27;USE_SESSION_AUTH&#x27;: True,</span></span><br><span class="line">    <span class="comment"># &#x27;DOC_EXPANSION&#x27;: &#x27;list&#x27;,</span></span><br><span class="line">    <span class="comment"># æ¥å£æ–‡æ¡£ä¸­æ–¹æ³•åˆ—è¡¨ä»¥é¦–å­—æ¯å‡åºæ’åˆ—</span></span><br><span class="line">    <span class="string">&#x27;APIS_SORTER&#x27;</span>: <span class="string">&#x27;alpha&#x27;</span>,</span><br><span class="line">    <span class="comment"># å¦‚æœæ”¯æŒjsonæäº¤, åˆ™æ¥å£æ–‡æ¡£ä¸­åŒ…å«jsonè¾“å…¥æ¡†</span></span><br><span class="line">    <span class="string">&#x27;JSON_EDITOR&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">    <span class="comment"># æ–¹æ³•åˆ—è¡¨å­—æ¯æ’åº</span></span><br><span class="line">    <span class="string">&#x27;OPERATIONS_SORTER&#x27;</span>: <span class="string">&#x27;alpha&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;VALIDATOR_URL&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">    <span class="string">&#x27;SHOW_REQUEST_HEADERS&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li><a href="http://2.urls.py">2.urls.py</a> æ–‡ä»¶ä¸­ swagger é…ç½®</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include, re_path</span><br><span class="line"><span class="keyword">from</span> django.views.static <span class="keyword">import</span> serve</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> routers, permissions</span><br><span class="line"><span class="keyword">from</span> drf_yasg.views <span class="keyword">import</span> get_schema_view</span><br><span class="line"><span class="keyword">from</span> drf_yasg <span class="keyword">import</span> openapi</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> shell_sc.viewsets <span class="keyword">import</span> ShellInfoViewSet</span><br><span class="line"></span><br><span class="line">router = routers.DefaultRouter()</span><br><span class="line">router.register(<span class="string">&#x27;shell_sc&#x27;</span>, ShellInfoViewSet)</span><br><span class="line"><span class="comment"># router.register(r&#x27;upload&#x27;, FileViewSet)</span></span><br><span class="line">schema_view = get_schema_view(</span><br><span class="line">    openapi.Info(</span><br><span class="line">        title=<span class="string">&quot;æµ‹è¯•å·¥ç¨‹API&quot;</span>,</span><br><span class="line">        default_version=<span class="string">&#x27;v1.0&#x27;</span>,</span><br><span class="line">        description=<span class="string">&quot;æµ‹è¯•å·¥ç¨‹æ¥å£æ–‡æ¡£&quot;</span>,</span><br><span class="line">        terms_of_service=<span class="string">&quot;&quot;</span>,</span><br><span class="line">        contact=openapi.Contact(email=<span class="string">&quot;&quot;</span>),</span><br><span class="line">        license=openapi.License(name=<span class="string">&quot;MIT License&quot;</span>),</span><br><span class="line">    ),</span><br><span class="line">    public=<span class="literal">True</span>,</span><br><span class="line">    permission_classes=(permissions.AllowAny,),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;admin/&#x27;</span>, admin.site.urls),</span><br><span class="line">    path(<span class="string">&#x27;shell_sc/&#x27;</span>, include(<span class="string">&#x27;shell_sc.urls&#x27;</span>)),</span><br><span class="line">    <span class="comment"># re_path(r&quot;file/(?P&lt;path&gt;.*)$&quot;, serve, &#123;&quot;document_root&quot;: settings.MEDIA_ROOT&#125;),</span></span><br><span class="line">    <span class="comment"># é…ç½®django-rest-framwork APIè·¯ç”±</span></span><br><span class="line">    <span class="comment"># path(&#x27;test&#x27;, views.APIList),</span></span><br><span class="line">    <span class="comment"># path(&#x27;api-auth/&#x27;, include(&#x27;rest_framework.urls&#x27;, namespace=&#x27;rest_framework&#x27;)),</span></span><br><span class="line">    <span class="comment"># é…ç½®drf-yasgè·¯ç”±</span></span><br><span class="line">    path(<span class="string">&#x27;&#x27;</span>, include(router.urls)),</span><br><span class="line">    path(<span class="string">&#x27;^swagger(?P&lt;format&gt;\.json|\.yaml)$&#x27;</span>, schema_view.without_ui(cache_timeout=<span class="number">0</span>), name=<span class="string">&#x27;schema-json&#x27;</span>),</span><br><span class="line">    path(<span class="string">&#x27;swagger&#x27;</span>, schema_view.with_ui(<span class="string">&#x27;swagger&#x27;</span>, cache_timeout=<span class="number">0</span>), name=<span class="string">&#x27;schema-swagger-ui&#x27;</span>),</span><br><span class="line">    path(<span class="string">&#x27;redoc/&#x27;</span>, schema_view.with_ui(<span class="string">&#x27;redoc&#x27;</span>, cache_timeout=<span class="number">0</span>), name=<span class="string">&#x27;schema-redoc&#x27;</span>),</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="æ¥å£ç¼–å†™">æ¥å£ç¼–å†™</h2><h3 id="æ¥å£ç¼–å†™æµç¨‹">æ¥å£ç¼–å†™æµç¨‹</h3><ul><li>1.é¡¹ç›®æ„å»º</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">django-admin startapp book_api_swagger</span><br></pre></td></tr></table></figure><ul><li>2.app æ„å»º</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\root\AppData\Roaming\Python\Python38\Scripts\django-admin.exe startapp shellapi</span><br></pre></td></tr></table></figure><ul><li>3.Model æ–‡ä»¶ç¼–å†™</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># @admi</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ShellModel</span>(models.Model):</span><br><span class="line">    name = models.CharField(help_text=<span class="string">&quot;è„šæœ¬åç§°&quot;</span>, max_length=<span class="number">255</span>)</span><br><span class="line"></span><br><span class="line">    file = models.FileField(upload_to=<span class="string">&#x27;upload&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    size = models.IntegerField(help_text=<span class="string">&quot;å¤§å°&quot;</span>)</span><br><span class="line"></span><br><span class="line">    path = models.CharField(help_text=<span class="string">&quot;è·¯å¾„&quot;</span>, max_length=<span class="number">255</span>)</span><br><span class="line"></span><br><span class="line">    desc = models.CharField(help_text=<span class="string">&quot;è„šæœ¬æè¿°&quot;</span>, max_length=<span class="number">255</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        db_table = <span class="string">&#x27;shell_sh&#x27;</span></span><br><span class="line">        <span class="comment"># è®¾ç½®è¡¨åï¼Œé»˜è®¤è¡¨åæ˜¯ï¼šåº”ç”¨åç§°_æ¨¡å‹ç±»å</span></span><br><span class="line">        <span class="comment"># å¸¦æœ‰åº”ç”¨åçš„è¡¨åå¤ªé•¿äº†</span></span><br><span class="line">        <span class="comment"># verbose_name = &#x27;è„šæœ¬åˆ—è¡¨&#x27;</span></span><br><span class="line">        <span class="comment"># verbose_name_plural = &quot;è„šæœ¬åˆ—è¡¨&quot;</span></span><br><span class="line">        verbose_name = <span class="string">&#x27;è„šæœ¬å&#x27;</span></span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.name</span><br></pre></td></tr></table></figure><ul><li>4.åºåˆ—åŒ–æ–‡ä»¶ç¼–å†™</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># book_api_swagger/serializers.py</span></span><br><span class="line">from django.forms import Field</span><br><span class="line">from rest_framework import serializers</span><br><span class="line">from rest_framework.serializers import Serializer</span><br><span class="line"></span><br><span class="line">from . import models</span><br><span class="line">from .models import ShellModel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># from .models import APIInfo</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class ShellSerializer(serializers.ModelSerializer):</span><br><span class="line">    class Meta:</span><br><span class="line">        model = ShellModel</span><br><span class="line">        fields = <span class="string">&quot;__all__&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class ShellInfoSerializer(serializers.HyperlinkedModelSerializer):</span><br><span class="line">    class Meta:</span><br><span class="line">        model = ShellModel</span><br><span class="line">        fields = <span class="string">&quot;__all__&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>5.viewset æ–‡ä»¶ç¼–å†™</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"><span class="comment"># Create your views here.</span></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> generics</span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">APIList</span>(generics.ListAPIView):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æŸ¥çœ‹æ¥å£åˆ—è¡¨</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    queryset = models.APIInfo.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = serializers.APISerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">APIDetail</span>(generics.RetrieveAPIView):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æŸ¥çœ‹æ¥å£è¯¦ç»†</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    queryset = models.APIInfo.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = serializers.APISerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">APIDetail</span>(generics.RetrieveUpdateDestroyAPIView):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æ›´æ–°æ¥å£å†…å®¹</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    queryset = models.APIInfo.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = serializers.APISerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">APIInfoViewSet</span>(viewsets.ModelViewSet):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        retrieve:</span></span><br><span class="line"><span class="string">            è¿”å›ä¸€ç»„ï¼ˆæŸ¥ï¼‰</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        list:</span></span><br><span class="line"><span class="string">            è¿”å›æ‰€æœ‰ç»„ï¼ˆæŸ¥ï¼‰</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        create:</span></span><br><span class="line"><span class="string">            åˆ›å»ºæ–°ç»„ï¼ˆå¢ï¼‰</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        delete:</span></span><br><span class="line"><span class="string">            åˆ é™¤ç°æœ‰çš„ä¸€ç»„ï¼ˆåˆ ï¼‰</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        partial_update:</span></span><br><span class="line"><span class="string">            æ›´æ–°ç°æœ‰ç»„ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªå­—æ®µï¼ˆæ”¹ï¼šéƒ¨åˆ†æ›´æ”¹ï¼‰</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        update:</span></span><br><span class="line"><span class="string">            æ›´æ–°ä¸€ç»„ï¼ˆæ”¹ï¼šå…¨éƒ¨æ›´æ”¹ï¼‰</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    queryset = models.APIInfo.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = serializers.APIInfoSerializer</span><br></pre></td></tr></table></figure><ul><li>6.app ä¸­ urls æ–‡ä»¶è·¯ç”±é…ç½®</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># from django.urls import path, include</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> django.template.defaulttags <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> viewsets</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;&#x27;</span>, viewsets.ShellModelList.as_view()),</span><br><span class="line">    path(<span class="string">&#x27;&lt;int:pk&gt;/&#x27;</span>, viewsets.ShellDetail.as_view()),</span><br><span class="line">    path(<span class="string">&#x27;famous/&#x27;</span>, viewsets.famous, name=<span class="string">&#x27;famous&#x27;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><ul><li>7.é¡¹ç›® urls æ–‡ä»¶é…ç½®</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">router = routers.DefaultRouter()</span><br><span class="line">router.register(<span class="string">&#x27;shell_sc&#x27;</span>, ShellInfoViewSet)</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;admin/&#x27;</span>, admin.site.urls),</span><br><span class="line">    path(<span class="string">&#x27;shell_sc/&#x27;</span>, include(<span class="string">&#x27;shell_sc.urls&#x27;</span>)),</span><br><span class="line">    <span class="comment"># re_path(r&quot;file/(?P&lt;path&gt;.*)$&quot;, serve, &#123;&quot;document_root&quot;: settings.MEDIA_ROOT&#125;),</span></span><br><span class="line">    <span class="comment"># é…ç½®django-rest-framwork APIè·¯ç”±</span></span><br><span class="line">    <span class="comment"># path(&#x27;test&#x27;, views.APIList),</span></span><br><span class="line">    <span class="comment"># path(&#x27;api-auth/&#x27;, include(&#x27;rest_framework.urls&#x27;, namespace=&#x27;rest_framework&#x27;)),</span></span><br><span class="line">    <span class="comment"># é…ç½®drf-yasgè·¯ç”±</span></span><br><span class="line">    path(<span class="string">&#x27;&#x27;</span>, include(router.urls)),</span><br><span class="line">    path(<span class="string">&#x27;^swagger(?P&lt;format&gt;\.json|\.yaml)$&#x27;</span>, schema_view.without_ui(cache_timeout=<span class="number">0</span>), name=<span class="string">&#x27;schema-json&#x27;</span>),</span><br><span class="line">    path(<span class="string">&#x27;swagger&#x27;</span>, schema_view.with_ui(<span class="string">&#x27;swagger&#x27;</span>, cache_timeout=<span class="number">0</span>), name=<span class="string">&#x27;schema-swagger-ui&#x27;</span>),</span><br><span class="line">    path(<span class="string">&#x27;redoc/&#x27;</span>, schema_view.with_ui(<span class="string">&#x27;redoc&#x27;</span>, cache_timeout=<span class="number">0</span>), name=<span class="string">&#x27;schema-redoc&#x27;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><ul><li>8.å¤–éƒ¨æ¥å£è°ƒç”¨</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¤–éƒ¨æ¥å£è°ƒç”¨</span></span><br><span class="line"><span class="meta">@api_view(<span class="params">[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">famous</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è°ƒç”¨å¤–éƒ¨æ¥å£æµ‹è¯•</span></span><br><span class="line"><span class="string">    :param request: è¯·æ±‚å‚æ•° æš‚æ— </span></span><br><span class="line"><span class="string">    :return: è°ƒç”¨æ¥å£è¿”å›å€¼</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    url = <span class="string">&#x27;http://localhost:10086/shop/monitor/getOrderCount&#x27;</span>  <span class="comment"># apié“¾æ¥</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        æˆ‘ç”¨çš„è¿™ä¸ªæ¥å£æ²¡æœ‰ä»€ä¹ˆapikeyæˆ–è€…å‚æ•°</span></span><br><span class="line"><span class="string">        å¦‚æœæœ‰çš„è¯ç›´æ¥å†™ä¸Šå‚æ•°ï¼Œç±»ä¼¼äºè¿™æ ·</span></span><br><span class="line"><span class="string">        apikey = &#x27;chgaxvsf88f3858a15fa4426f4cbdd4d2a02b92ee0747f3&#x27;</span></span><br><span class="line"><span class="string">        area = &quot;äººç”Ÿ&quot;</span></span><br><span class="line"><span class="string">        areaID = &quot;45&quot;</span></span><br><span class="line"><span class="string">        data = &#123;</span></span><br><span class="line"><span class="string">            &quot;apiKey&quot;:apikey,</span></span><br><span class="line"><span class="string">            &quot;area&quot;:area,</span></span><br><span class="line"><span class="string">            &quot;areaID&quot;:areaID,</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        å°†æ•°æ®å°è£…æˆäººå®¶æ¥å£å®šä¹‰çš„æ ¼å¼ï¼Œè¯·æ±‚æ•°æ®æ”¹æˆä»¥ä¸‹æ ·å­</span></span><br><span class="line"><span class="string">        wb_data = requests.get(url,apikey,data)</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    wb_data = requests.get(url)  <span class="comment"># å¼•å…¥requestsåº“æ¥è¯·æ±‚æ•°æ®</span></span><br><span class="line">    result = wb_data.json()  <span class="comment"># å°†è¯·æ±‚çš„æ•°æ®è½¬æ¢ä¸ºjsonæ ¼å¼</span></span><br><span class="line">    <span class="keyword">return</span> JsonResponse(json.dumps(result), safe=<span class="literal">False</span>)  <span class="comment"># ç”¨jsonå“åº”å‡ºå»ï¼Œé¡ºä¾¿æ ¼å¼åŒ–æ•°æ®</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="é¡¹ç›®æ¥å£æµ‹è¯•">é¡¹ç›®æ¥å£æµ‹è¯•</h2><ul><li>1.swagger æ¥å£æµ‹è¯•åœ°å€</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:8000/swagger</span><br></pre></td></tr></table></figure><ul><li>2.åå°ç®¡ç†åœ°å€</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:8000/admin</span><br></pre></td></tr></table></figure><ul><li>3.æµ‹è¯•æ–¹å¼</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># eg:</span></span><br><span class="line">curl -X <span class="string">&#x27;GET&#x27;</span> \</span><br><span class="line">  <span class="string">&#x27;http://127.0.0.1:8000/shell_sc/4/&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;accept: application/json&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;X-CSRFToken: npDP6jrGLiAoUG9ujDsTxCRL2toVaM1EZpRmoNWM9NjtznNnLvtcLgOSkNXw9Wmk&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="rest-framework-django-ä¸­éƒ¨åˆ†-API-ä½¿ç”¨">rest-framework-django ä¸­éƒ¨åˆ† API ä½¿ç”¨</h2><h3 id="generics">generics</h3><ul><li>1.list æŸ¥è¯¢ä¸å•ä¸ªæŸ¥è¯¢ ListCreateAPIView</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç»§æ‰¿äº†è§†å›¾åŸºç±» GenericAPIViewï¼Œå·¥å…·ç±» ListModelMixinï¼ŒCreateModelMixinå®ç°ç¾¤æŸ¥å’Œå•å¢</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ListCreateAPIView</span>(mixins.ListModelMixin,</span><br><span class="line">                        mixins.CreateModelMixin,</span><br><span class="line">                        GenericAPIView):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Concrete view for listing a queryset or creating a model instance.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># ç¾¤æŸ¥</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.<span class="built_in">list</span>(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å•å¢</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">post</span>(<span class="params">self, request, *args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.create(request, *args, **kwargs)</span><br></pre></td></tr></table></figure><ul><li>2.æ·»åŠ </li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># éœ€è¦ä»€ä¹ˆæ¥å£ï¼Œç›´æ¥ç»§æ‰¿å°±è¡Œ</span></span><br><span class="line"><span class="comment"># æ¯”å¦‚æˆ‘ä»¬åœ¨ç¾¤æŸ¥ï¼Œå•å¢çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ å•æ”¹æ¥å£</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BookListCreateView</span>(ListCreateAPIView, UpdateAPIView):</span><br><span class="line">    queryset = models.Book.objects.<span class="built_in">filter</span>(is_delete=<span class="literal">False</span>)</span><br><span class="line">    serializer_class = serializers.BookModelSerializer</span><br></pre></td></tr></table></figure><h3 id="mixins">mixins</h3><blockquote><p>mixins : from rest_framework import mixins #å¯¼å…¥æ–¹å¼<br>å­˜æ”¾ä¸€äº›å¢åˆ æ”¹æŸ¥çš„ä¸€äº›ç±» å¢ æŸ¥ éƒ¨åˆ†ä¿®æ”¹ æ›´æ–° åˆ é™¤<br>CreateModelMixinï¼ŒListModelMixinï¼ŒRetrieveModelMixinï¼ŒUpdateModelMixinï¼ŒDestroyModelMixin</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mixins.ListModelMixin</span><br><span class="line"></span><br><span class="line">è¿™ä¸ªæ˜¯ç”¨æ¥æ˜¾ç¤ºquerysetçš„æ•°æ®</span><br><span class="line"></span><br><span class="line">mixins.CreateModelMixin</span><br><span class="line"></span><br><span class="line">è¿™ä¸ªç”¨æ¥åˆ›å»ºä¸€æ¡modelå¯¹è±¡</span><br><span class="line"></span><br><span class="line">mixins.RetrieveModelMixin</span><br><span class="line"></span><br><span class="line">è¿™ä¸ªæ˜¯ç”¨æ¥æ˜¾ç¤ºä¸€ä¸ªmodelå¯¹è±¡</span><br><span class="line"></span><br><span class="line">mixins.DestroyModelMixin</span><br><span class="line"></span><br><span class="line">è¿™ä¸ªæ˜¯ç”¨æ¥åˆ é™¤ä¸€ä¸ªmodelå¯¹è±¡</span><br><span class="line"></span><br><span class="line">mixins.UpdateModelMixin</span><br><span class="line"></span><br><span class="line">è¿™ä¸ªæ˜¯ç”¨æ¥æ›´æ–°ä¸€ä¸ªmodelå¯¹è±¡</span><br></pre></td></tr></table></figure><ul><li><ol><li>eg:ListModelMixin</li></ol></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ListModelMixin</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    List a queryset.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">list</span>(<span class="params">self, request, *args, **kwargs</span>):</span><br><span class="line">        queryset = <span class="variable language_">self</span>.filter_queryset(<span class="variable language_">self</span>.get_queryset())</span><br><span class="line"></span><br><span class="line">        page = <span class="variable language_">self</span>.paginate_queryset(queryset)</span><br><span class="line">        <span class="keyword">if</span> page <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            serializer = <span class="variable language_">self</span>.get_serializer(page, many=<span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">self</span>.get_paginated_response(serializer.data)</span><br><span class="line"></span><br><span class="line">        serializer = <span class="variable language_">self</span>.get_serializer(queryset, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br></pre></td></tr></table></figure><ul><li><a href="http://2.eg">2.eg</a>:CreateModelMixin</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CreateModelMixin</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Create a model instance.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">self, request, *args, **kwargs</span>):</span><br><span class="line">        serializer = <span class="variable language_">self</span>.get_serializer(data=request.data)</span><br><span class="line">        serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">        <span class="variable language_">self</span>.perform_create(serializer)</span><br><span class="line">        headers = <span class="variable language_">self</span>.get_success_headers(serializer.data)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data, status=status.HTTP_201_CREATED, headers=headers)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">perform_create</span>(<span class="params">self, serializer</span>):</span><br><span class="line">        serializer.save()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_success_headers</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&#x27;Location&#x27;</span>: <span class="built_in">str</span>(data[api_settings.URL_FIELD_NAME])&#125;</span><br><span class="line">        <span class="keyword">except</span> (TypeError, KeyError):</span><br><span class="line">            <span class="keyword">return</span> &#123;&#125;</span><br></pre></td></tr></table></figure><ul><li><a href="http://3.eg">3.eg</a>:RetriveModelMixin</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RetrieveModelMixin</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Retrieve a model instance.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">retrieve</span>(<span class="params">self, request, *args, **kwargs</span>):</span><br><span class="line">        instance = <span class="variable language_">self</span>.get_object()</span><br><span class="line">        serializer = <span class="variable language_">self</span>.get_serializer(instance)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br></pre></td></tr></table></figure><ul><li><a href="http://4.eg">4.eg</a>:DestroyModelMixin</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DestroyModelMixin</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Destroy a model instance.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">destroy</span>(<span class="params">self, request, *args, **kwargs</span>):</span><br><span class="line">        instance = <span class="variable language_">self</span>.get_object()</span><br><span class="line">        <span class="variable language_">self</span>.perform_destroy(instance)</span><br><span class="line">        <span class="keyword">return</span> Response(status=status.HTTP_204_NO_CONTENT)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">perform_destroy</span>(<span class="params">self, instance</span>):</span><br><span class="line">        instance.delete()</span><br></pre></td></tr></table></figure><ul><li><a href="http://5.eg">5.eg</a>:UpdateModelMixin</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UpdateModelMixin</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Update a model instance.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update</span>(<span class="params">self, request, *args, **kwargs</span>):</span><br><span class="line">        partial = kwargs.pop(<span class="string">&#x27;partial&#x27;</span>, <span class="literal">False</span>)</span><br><span class="line">        instance = <span class="variable language_">self</span>.get_object()</span><br><span class="line">        serializer = <span class="variable language_">self</span>.get_serializer(instance, data=request.data, partial=partial)</span><br><span class="line">        serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">        <span class="variable language_">self</span>.perform_update(serializer)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">getattr</span>(instance, <span class="string">&#x27;_prefetched_objects_cache&#x27;</span>, <span class="literal">None</span>):</span><br><span class="line">            <span class="comment"># If &#x27;prefetch_related&#x27; has been applied to a queryset, we need to</span></span><br><span class="line">            <span class="comment"># forcibly invalidate the prefetch cache on the instance.</span></span><br><span class="line">            instance._prefetched_objects_cache = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">perform_update</span>(<span class="params">self, serializer</span>):</span><br><span class="line">        serializer.save()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">partial_update</span>(<span class="params">self, request, *args, **kwargs</span>):</span><br><span class="line">        kwargs[<span class="string">&#x27;partial&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.update(request, *args, **kwargs)</span><br></pre></td></tr></table></figure><h3 id="APIView">APIView</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">APIViewæ˜¯REST frameworkæä¾›çš„æ‰€æœ‰è§†å›¾çš„åŸºç±»ï¼Œç»§æ‰¿è‡ªDjangoçš„Viewç±»</span><br><span class="line">APIViewä¸Viewçš„ä¸åŒç‚¹ä¸ºï¼š</span><br><span class="line">ä¼ å…¥åˆ°è§†å›¾æ–¹æ³•ä¸­çš„æ˜¯REST frameworkçš„Requestå¯¹è±¡ï¼Œè€Œä¸æ˜¯Djangoçš„HttpRequesetå¯¹è±¡</span><br><span class="line">è§†å›¾æ–¹æ³•å¯ä»¥è¿”å›REST frameworkçš„Responseå¯¹è±¡ï¼Œè§†å›¾ä¼šä¸ºå“åº”æ•°æ®è®¾ç½®ï¼ˆrenderï¼‰ç¬¦åˆå‰ç«¯æœŸæœ›è¦æ±‚æ ¼å¼</span><br><span class="line">ä»»ä½•APIExceptionå¼‚å¸¸éƒ½ä¼šè¢«æ•è·åˆ°ï¼Œå¹¶ä¸”å¤„ç†æˆåˆé€‚æ ¼å¼ï¼ˆjsonï¼‰çš„å“åº”ä¿¡æ¯è¿”å›ç»™å®¢æˆ·ç«¯</span><br><span class="line">ä¼šé‡æ–°å£°æ˜äº†ä¸€ä¸ªæ–°çš„as_viewsæ–¹æ³•å¹¶åœ¨dispatch()è¿›è¡Œè·¯ç”±åˆ†å‘å‰ï¼Œå¯¹è¯·æ±‚çš„å®¢æˆ·ç«¯è¿›è¡Œèº«ä»½è®¤è¯ã€æƒé™æ£€æŸ¥ã€æµé‡æ§åˆ¶</span><br><span class="line">APIViewè¿˜æ–°å¢äº†å¦‚ä¸‹çš„ç±»å±æ€§ï¼š</span><br><span class="line"></span><br><span class="line">authentication_classes åˆ—è¡¨æˆ–å…ƒç»„ï¼Œèº«ä»½è®¤è¯ç±»</span><br><span class="line">permissoin_classes åˆ—è¡¨æˆ–å…ƒç»„ï¼Œæƒé™æ£€æŸ¥ç±»</span><br><span class="line">throttle_classes åˆ—è¡¨æˆ–å…ƒç¥–ï¼Œæµé‡æ§åˆ¶ç±»</span><br></pre></td></tr></table></figure><ul><li><ol><li>eg å¢åˆ æ”¹æŸ¥ APIView</li></ol></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Students</span><br><span class="line"><span class="keyword">from</span> .serilizers <span class="keyword">import</span> StudentsModelSerializers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentsApiview</span>(<span class="title class_ inherited__">APIView</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, request</span>):</span><br><span class="line">        <span class="comment"># è·å–æ•°æ®é›†ï¼ˆå­¦ç”Ÿæ¨¡å‹å¯¹è±¡ï¼‰</span></span><br><span class="line">        students_data = Students.objects.<span class="built_in">all</span>()</span><br><span class="line">        <span class="comment"># å®ä¾‹åŒ–åºåˆ—åŒ–å™¨ï¼Œå¾—åˆ°åºåˆ—åŒ–å™¨å¯¹è±¡</span></span><br><span class="line">        ser = StudentsModelSerializers(instance=students_data, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># è°ƒç”¨åºåˆ—åŒ–å™¨å¯¹è±¡çš„dataå±æ€§æ–¹æ³•è·å–è½¬æ¢åçš„æ•°æ®</span></span><br><span class="line">        data = ser.data</span><br><span class="line">        <span class="comment"># å“åº”æ•°æ®</span></span><br><span class="line">        <span class="keyword">return</span> Response(data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">post</span>(<span class="params">self, request</span>):</span><br><span class="line">        <span class="comment"># ååºåˆ—åŒ–æ•°æ®</span></span><br><span class="line">        student = StudentsModelSerializers(data=request.data)</span><br><span class="line">        <span class="comment"># æ ¡éªŒä¸é€šè¿‡</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> student.is_valid():</span><br><span class="line">            <span class="comment"># è¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">return</span> Response(student.errors)</span><br><span class="line">        <span class="comment"># æ ¡éªŒé€šè¿‡ï¼Œä¿å­˜æ•°æ®</span></span><br><span class="line">        student.save()</span><br><span class="line">        <span class="comment"># å“åº”æ•°æ®</span></span><br><span class="line">        <span class="keyword">return</span> Response(student.data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentDerailApiview</span>(<span class="title class_ inherited__">APIView</span>):</span><br><span class="line">    <span class="comment"># è·å–ä¸€ä¸ªå­¦ç”Ÿçš„ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, request, pk</span>):</span><br><span class="line">        student = Students.objects.get(pk=pk)</span><br><span class="line">        ser = StudentsModelSerializers(instance=student)</span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¿®æ”¹ä¸€ä¸ªå­¦ç”Ÿçš„ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">put</span>(<span class="params">self, request, pk</span>):</span><br><span class="line">        instance = Students.objects.get(pk=pk)</span><br><span class="line">        ser = StudentsModelSerializers(instance=instance, data=request.data)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ser.is_valid():</span><br><span class="line">            <span class="keyword">return</span> Response(ser.errors)</span><br><span class="line">        ser.save()</span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ é™¤ä¸€ä¸ªå­¦ç”Ÿçš„ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">self, request, pk</span>):</span><br><span class="line">        Students.objects.get(pk=pk).delete()</span><br><span class="line">        <span class="keyword">return</span> Response(&#123;<span class="string">&#x27;detail&#x27;</span>: <span class="string">&#x27;åˆ é™¤æˆåŠŸï¼ï¼&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure><ul><li>2.urls æ–‡ä»¶ç»Ÿä¸€é…ç½®</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, re_path</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .views <span class="keyword">import</span> StudentsApiview, StudentDerailApiview</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;students/&#x27;</span>, StudentsApiview.as_view()),</span><br><span class="line">    <span class="comment"># å•ä¸ªæ•°æ®è¿›è¡Œæ“ä½œ</span></span><br><span class="line">    re_path(<span class="string">&#x27;students/(?P&lt;pk&gt;\d+)/&#x27;</span>, StudentDerailApiview.as_view())</span><br><span class="line">]</span><br></pre></td></tr></table></figure><ul><li>3.models å®šä¹‰</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Students</span>(models.Model):</span><br><span class="line">    name = models.CharField(verbose_name=<span class="string">&#x27;å§“å&#x27;</span>, max_length=<span class="number">255</span>)</span><br><span class="line">    classmate = models.IntegerField(verbose_name=<span class="string">&#x27;ç­çº§&#x27;</span>)</span><br><span class="line">    studentID = models.IntegerField(verbose_name=<span class="string">&#x27;å­¦å·&#x27;</span>)</span><br><span class="line">    description = models.TextField(verbose_name=<span class="string">&#x27;æè¿°&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        db_table = <span class="string">&#x27;students&#x27;</span></span><br></pre></td></tr></table></figure><ul><li>4.serailizers å®šä¹‰</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentsModelSerializers</span>(serializers.Serializer):</span><br><span class="line">    name = serializers.CharField()</span><br><span class="line">    classmate = serializers.IntegerField()</span><br><span class="line">    studentID = serializers.IntegerField()</span><br><span class="line">    description = serializers.CharField()</span><br></pre></td></tr></table></figure><h3 id="æ•°æ®åŒæ­¥ä¸è¿ç§»">æ•°æ®åŒæ­¥ä¸è¿ç§»</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python manage.py makemigrations</span><br><span class="line">python manage.py migrate</span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Androidå¸¸ç”¨è„šæœ¬</title>
      <link href="/2023/05/01/sh/"/>
      <url>/2023/05/01/sh/</url>
      
        <content type="html"><![CDATA[<h1>1. logcat æ—¥å¿—é‡‡é›†è„šæœ¬</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb logcat -v time &gt; D:\log1.txt</span><br></pre></td></tr></table></figure><h1>2. bugly ç¬¦å·è¡¨ä¸Šä¼ è„šæœ¬</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span>  C:\Windows\System32\cmd.exe</span><br><span class="line">java -jar C:\Users\root\Desktop\buglyqq-upload-symbol.jar -appid 4107a98858 -appkey 3bd03b8a-7c32-447c-ae4f-cb636561bae5 -bundleid com.example.apanewtuozhuai_MKZD531110DZDML1223_u3d -version 1.0.0 -platform Android -inputSymbol D:\u3d_host_app_drm\unityLibrary\symbols\armeabi-v7a\libil2cpp.so</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>mapping æ˜ å°„æ–‡ä»¶ -inputMapping <mapping file></mapping></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%~dp0\D:\Program Files\Java\jdk1.8.0_181\jre\bin\java</span><br></pre></td></tr></table></figure><h2 id="result">result</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">Microsoft Windows [ç‰ˆæœ¬ 10.0.25252.1010]</span><br><span class="line">(c) Microsoft Corporationã€‚ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚</span><br><span class="line"></span><br><span class="line">D:\Program Files\Java\jdk1.8.0_181\bin&gt;java -jar C:\Users\root\Desktop\buglyqq-upload-symbol.jar -appid 4107a98858 -appkey 3bd03b8a-7c32-447c-ae4f-cb636561bae5 -bundleid com.example.apanewtuozhuai_MKZD531110DZDML1223_u3d -version 1.0.0 -platform Android -inputSymbol D:\u3d_host_app_drm\unityLibrary\symbols\armeabi-v7a\libil2cpp.so</span><br><span class="line"><span class="comment">##[info]bugly tools android params: -appid 4107a98858 -appkey 3bd03b8a-7c32-447c-ae4f-cb636561bae5 -bundleid com.example.apanewtuozhuai_MKZD531110DZDML1223_u3d -version 1.0.0 -platform Android -inputSymbol D:\u3d_host_app_drm\unityLibrary\symbols\armeabi-v7a\libil2cpp.so</span></span><br><span class="line"></span><br><span class="line">Bugly(bugly.qq.com)ç¬¦å·è¡¨å·¥å…·ä¸Šä¼ å·¥å…·åŒ… V1.0.48</span><br><span class="line"></span><br><span class="line">ç”¨æ³• -- Usage</span><br><span class="line"> java -jar buglyqq-upload-symbol.jar -appid &lt;APP ID&gt; -appkey &lt;APP KEY&gt; -bundleid &lt;App BundleID&gt; -version &lt;App Version&gt; -platform &lt;App Platform&gt; -inputSymbol &lt;Original Symbol File Path&gt; -inputMapping &lt;Original mapping File Path&gt;</span><br><span class="line"></span><br><span class="line">å‚æ•°è¯´æ˜ -- Introduction <span class="keyword">for</span> arguments</span><br><span class="line"> -appid APP ID of Bugly</span><br><span class="line"> -appkey APP Key of Bugly</span><br><span class="line"> -bundleid Androidå¹³å°å¯¹åº”çš„æ˜¯package name/iOSå¹³å°æ˜¯Bundle Id</span><br><span class="line"> -version APPç‰ˆæœ¬ï¼Œéœ€è¦å’Œbuglyå¹³å°ä¸Šé¢çœ‹åˆ°çš„crashç‰ˆæœ¬å·ä¿æŒå¯¹é½</span><br><span class="line"> -platform å¹³å°ç±»å‹åŒ…å«ä¸‰ä¸ªé€‰é¡¹ Androidã€IOSä¸¤ä¸ªé€‰é¡¹ï¼Œæ³¨æ„å¤§å°å†™è¦æ­£ç¡®</span><br><span class="line"> -inputSymbol åŸå§‹ç¬¦å·è¡¨[iosæ˜¯dsym/androidå¹³å°æ˜¯debug so]æ‰€åœ¨æ–‡ä»¶å¤¹ç›®å½•åœ°å€</span><br><span class="line"> -inputMapping mappingæ‰€åœ¨æ–‡ä»¶å¤¹ç›®å½•åœ°å€[Androidå¹³å°ç‰¹æœ‰ï¼Œioså¿½ç•¥]</span><br><span class="line"></span><br><span class="line"><span class="comment">##[info]args is ArgsParser&#123;appId=&#x27;4107a98858&#x27;appKey=&#x27;3bd03b8a-7c32-447c-ae4f-cb636561bae5&#x27;, appPackage=&#x27;com.example.apanewtuozhuai_MKZD531110DZDML1223_u3d&#x27;, appVersion=&#x27;1.0.0&#x27;, appBuildNo=&#x27;null&#x27;, platformId=Android&#x27;, enviroment=null&#x27;, symbolPathName=&#x27;D:\u3d_host_app_drm\unityLibrary\symbols\armeabi-v7a\libil2cpp.so&#x27;, mappingPathName=&#x27;null&#x27;, appPathName=&#x27;null&#x27;&#125;</span></span><br><span class="line"><span class="comment">##[info]deleteDirFiles file path is D:\Program Files\Java\jdk1.8.0_181\bin\buglybin</span></span><br><span class="line"><span class="comment">##[info]packSymbolFile file</span></span><br><span class="line"><span class="comment">##[warning]mapping path is null</span></span><br><span class="line"><span class="comment">##[info]mapping is exist ?: false</span></span><br><span class="line"><span class="comment">##[info]so is exist ?: true</span></span><br><span class="line"><span class="comment">##[info]bugly tools android params: -i D:\u3d_host_app_drm\unityLibrary\symbols\armeabi-v7a\libil2cpp.so -o D:\Program Files\Java\jdk1.8.0_181\bin\buglybin\symbolResult\BuglySoStifListZip.zip</span></span><br><span class="line">D:\u3d_host_app_drm\unityLibrary\symbols\armeabi-v7a\libil2cpp.so [armeabi-v7a] 611f94d5ee0bbee371346d6abe550c7b</span><br><span class="line"></span><br><span class="line">[SymtabTool-I] Extracting symtab file: libil2cpp.so</span><br><span class="line">[SymtabTool-I] Processing file: D:\u3d_host_app_drm\unityLibrary\symbols\armeabi-v7a\libil2cpp.so</span><br><span class="line">[SymtabTool-I] Begin to parse file: D:\u3d_host_app_drm\unityLibrary\symbols\armeabi-v7a\libil2cpp.so</span><br><span class="line">[SymtabTool-W] No .bugly_version section <span class="keyword">in</span> the elf file</span><br><span class="line">[SymtabTool-I] Successfully parsed the file!</span><br><span class="line">[SymtabTool-I] Begin to extract symbol table.................................................................................................................................................................................................................................................................................................................................................................................................................................................................................</span><br><span class="line">[SymtabTool-I] Successfully extracted symbol table!</span><br><span class="line">[SymtabTool-I] UUID: 611f94d5ee0bbee371346d6abe550c7b</span><br><span class="line">[SymtabTool-I] Begin to create symtab file: D:\u3d_host_app_drm\unityLibrary\symbols\armeabi-v7a\buglySymbol&amp;armeabi-v7a&amp;libil2cpp&amp;611f94d5ee0bbee371346d6abe550c7b.symbol</span><br><span class="line">[SymtabTool-I] Successfully created symtab file!</span><br><span class="line">[SymtabTool-I] Begin to parse the fileï¼šD:\u3d_host_app_drm\unityLibrary\symbols\armeabi-v7a\buglySymbol&amp;armeabi-v7a&amp;libil2cpp&amp;611f94d5ee0bbee371346d6abe550c7b.symbol</span><br><span class="line">[SymtabTool-I] Successfully parsed the file</span><br><span class="line">[SymtabTool-I] Begin to construct stif file: D:\u3d_host_app_drm\unityLibrary\symbols\armeabi-v7a\buglySymbol&amp;armeabi-v7a&amp;libil2cpp&amp;611f94d5ee0bbee371346d6abe550c7b.stif</span><br><span class="line">[SymtabTool-I] getSymtabEntryNum: 9563453</span><br><span class="line">[SymtabTool-I] getIndexEntryLength: 24</span><br><span class="line">[SymtabTool-I] Successfully constructed stif file</span><br><span class="line">[SymtabTool-I] Add stif to symtab zip file: D:\u3d_host_app_drm\unityLibrary\symbols\armeabi-v7a\buglySymbol&amp;armeabi-v7a&amp;libil2cpp&amp;611f94d5ee0bbee371346d6abe550c7b.stif</span><br><span class="line">[SymtabTool-I] Begin to zip stif file: D:\u3d_host_app_drm\unityLibrary\symbols\armeabi-v7a\buglySymbol&amp;armeabi-v7a&amp;libil2cpp&amp;611f94d5ee0bbee371346d6abe550c7b</span><br><span class="line">[SymtabTool-I] Successfully zipped stif file!</span><br><span class="line">[SymtabTool-I] Begin to zip symtab file: D:\Program Files\Java\jdk1.8.0_181\bin\buglybin\symbolResult\BuglySoStifListZip.zip</span><br><span class="line">[SymtabTool-I] Successfully zipped symtab file!</span><br><span class="line"><span class="comment">##[info]destFile :D:\Program Files\Java\jdk1.8.0_181\bin\buglybin\symbolResult\BuglySoStifListZip.zipdir :.\buglybin\symbolResult</span></span><br><span class="line"><span class="comment">##[info]visit file name is : buglySymbol&amp;armeabi-v7a&amp;libil2cpp&amp;611f94d5ee0bbee371346d6abe550c7b.zip</span></span><br><span class="line"><span class="comment">##[info]parseStifFileName prefix : buglySymbol arg1 : armeabi-v7a</span></span><br><span class="line"><span class="comment">##[info]parseStifFileName arg2 : libil2cpp uuid : 611f94d5ee0bbee371346d6abe550c7b</span></span><br><span class="line"><span class="comment">##[info]parseStifFileName endfix : zip</span></span><br><span class="line"><span class="comment">##[info]so file detail :SymbolFileDetail&#123;name=&#x27;buglySymbol&amp;armeabi-v7a&amp;libil2cpp&amp;611f94d5ee0bbee371346d6abe550c7b.zip, uuid=&#x27;611f94d5ee0bbee371346d6abe550c7b, arch=&#x27;armeabi-v7a, type=101, moduleName=&#x27;libil2cpp&#125;</span></span><br><span class="line"><span class="comment">##[info]mix symbol file detail :SymbolFileDetail&#123;name=&#x27;buglySymbol&amp;armeabi-v7a&amp;libil2cpp&amp;611f94d5ee0bbee371346d6abe550c7b.zip, uuid=&#x27;611f94d5ee0bbee371346d6abe550c7b, arch=&#x27;armeabi-v7a, type=101, moduleName=&#x27;libil2cpp&#125;</span></span><br><span class="line"><span class="comment">##[info]androidSymbolFileDetailList size is :1</span></span><br><span class="line"><span class="comment">##[info]uploadSymbolFile file :D:\Program Files\Java\jdk1.8.0_181\bin\buglybin\symbolResult\BuglySoStifListZip.zip</span></span><br><span class="line"><span class="comment">##[info]postRqdFile fileName: BuglySoStifListZip.zip</span></span><br><span class="line"><span class="comment">##[info]now begin to uploadFile</span></span><br><span class="line"><span class="comment">##[info]buildName :null&amp;null</span></span><br><span class="line"><span class="comment">##[info]buildID :null</span></span><br><span class="line"><span class="comment">##[info]appID :4107a98858</span></span><br><span class="line"><span class="comment">##[info]bundle :com.example.apanewtuozhuai_MKZD531110DZDML1223_u3d</span></span><br><span class="line"><span class="comment">##[info]appVersion :1.0.0</span></span><br><span class="line"><span class="comment">##[info]platformId :1</span></span><br><span class="line"><span class="comment">##[info]appBuildNumber :null</span></span><br><span class="line"><span class="comment">##[info]fileType :201</span></span><br><span class="line"><span class="comment">##[info]fileMD5 :f09855ee3011c9a39b59d601374ea61f</span></span><br><span class="line"><span class="comment">##[info]fileSize :81016813</span></span><br><span class="line"><span class="comment">##[info]symbolFileDetail is [&#123;&quot;name&quot;:&quot;buglySymbol&amp;armeabi-v7a&amp;libil2cpp&amp;611f94d5ee0bbee371346d6abe550c7b.zip&quot;,&quot;uuid&quot;:&quot;611f94d5ee0bbee371346d6abe550c7b&quot;,&quot;arch&quot;:&quot;armeabi-v7a&quot;,&quot;type&quot;:101,&quot;moduleName&quot;:&quot;libil2cpp&quot;&#125;]</span></span><br><span class="line"><span class="comment">##[info]request json is &#123;&quot;appID&quot;:&quot;4107a98858&quot;,&quot;authSign&quot;:&quot;3bd03b8a-7c32-447c-ae4f-cb636561bae5&quot;,&quot;appVersion&quot;:&quot;1.0.0&quot;,&quot;appBundleID&quot;:&quot;com.example.apanewtuozhuai_MKZD531110DZDML1223_u3d&quot;,&quot;appPlatform&quot;:1,&quot;appBuildNumber&quot;:null,&quot;fileType&quot;:201,&quot;fileSize&quot;:81016813,&quot;fileMD5&quot;:&quot;f09855ee3011c9a39b59d601374ea61f&quot;,&quot;clientType&quot;:7,&quot;clientVersion&quot;:&quot;1.0.48&quot;,&quot;buildPlatform&quot;:1,&quot;buildID&quot;:null,&quot;buildName&quot;:&quot;null&amp;null&quot;,&quot;fileInfoList&quot;:[&#123;&quot;name&quot;:&quot;buglySymbol&amp;armeabi-v7a&amp;libil2cpp&amp;611f94d5ee0bbee371346d6abe550c7b.zip&quot;,&quot;uuid&quot;:&quot;611f94d5ee0bbee371346d6abe550c7b&quot;,&quot;arch&quot;:&quot;armeabi-v7a&quot;,&quot;type&quot;:101,&quot;moduleName&quot;:&quot;libil2cpp&quot;&#125;],&quot;buildRepo&quot;:null,&quot;buildBranch&quot;:null,&quot;buildCommitID&quot;:null&#125;</span></span><br><span class="line"><span class="comment">##[info]request upload Info Url is https://symbol-v2.bugly.qq.com/trpc.eff_tool.symbol_upload_gateway.SymbolUploadGateway/uploadInfo</span></span><br><span class="line"><span class="comment">##[info]request gitRepoUrl is null</span></span><br><span class="line"><span class="comment">##[info]request gitRepoBranch is null</span></span><br><span class="line"><span class="comment">##[info]request gitRepoHeadCommitId is null</span></span><br><span class="line"><span class="comment">##[info]envtype is null</span></span><br><span class="line"><span class="comment">##[info]getAppModuleList is null</span></span><br><span class="line"><span class="comment">##[info]retCode: 200 response message: &#123;&quot;statusCode&quot;:0,&quot;msg&quot;:&quot;success&quot;,&quot;uploadReqID&quot;:&quot;4107a98858-2015378e-233f-4d3a-84de-798a78374d51&quot;&#125;</span></span><br><span class="line"><span class="comment">##[info]now begin to uploadFileContent</span></span><br><span class="line"><span class="comment">##[info]request uploadFileurl is https://symbol-v2.bugly.qq.com/trpc.eff_tool.symbol_upload_gateway.SymbolUploadGateway/uploadFile</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="æˆåŠŸåç»“æœå¦‚å›¾">æˆåŠŸåç»“æœå¦‚å›¾</h2><p><img src="/2023/05/01/sh/symbol-tables.png" class="lazyload placeholder" data-srcset="/2023/05/01/sh/symbol-tables.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäº Vue+Spring Cloud å‰åç«¯æœåŠ¡çš„äº‘éƒ¨ç½²</title>
      <link href="/2023/04/20/admin-manage-publish/"/>
      <url>/2023/04/20/admin-manage-publish/</url>
      
        <content type="html"><![CDATA[<h1>åŸºäº Vue+Spring Cloud å‰åç«¯æœåŠ¡çš„äº‘éƒ¨ç½²</h1><h2 id="ç³»ç»Ÿç¯å¢ƒ">ç³»ç»Ÿç¯å¢ƒ</h2><ul><li>åŸºç¡€ç¯å¢ƒ</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">centos 8 <span class="comment"># æ“ä½œç³»ç»Ÿ</span></span><br><span class="line">JDK 1.8 <span class="comment"># java</span></span><br><span class="line">yum -y install java</span><br><span class="line">git</span><br><span class="line">yum install git</span><br></pre></td></tr></table></figure><h2 id="å‰ç«¯æ‰“åŒ…">å‰ç«¯æ‰“åŒ…</h2><ul><li>1.æ‰“åŒ…æŒ‡ä»¤</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run build</span><br></pre></td></tr></table></figure><ul><li><p>2.æ–‡ä»¶ä¸Šä¼ </p></li><li><p>ä½¿ç”¨ FTP å·¥å…·ä¸Šä¼ <code>dist</code>æ–‡ä»¶</p></li></ul><h2 id="åç«¯æ‰“åŒ…">åç«¯æ‰“åŒ…</h2><ul><li>1.Maven æ‰“åŒ…</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean package <span class="comment">#or mvn install åªéœ€åœ¨çˆ¶æœåŠ¡ä¸­è¿è¡Œ</span></span><br></pre></td></tr></table></figure><ul><li><p>2.jar åŒ…ä¸Šä¼ </p></li><li><p>ä½¿ç”¨ FTP ä¸Šä¼  jar åŒ…</p></li><li><p>3.jar åŒ…è¿è¡Œ</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohub java -jar rs_shop_service.jar &amp; 1 &amp;out.log</span><br></pre></td></tr></table></figure><h2 id="äº‘æœåŠ¡å™¨éƒ¨ç½²">äº‘æœåŠ¡å™¨éƒ¨ç½²</h2><ul><li><p>1.åŸºç¡€é•œåƒé…ç½®</p></li><li><p>é•œåƒæºè®¾ç½®</p></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /etc/yum.repos.d.bak</span><br><span class="line"><span class="built_in">mv</span> /etc/yum.repos.d/* /etc/yum.repos.d.bak/</span><br><span class="line">ll /etc/yum.repos.d/</span><br><span class="line">ll /etc/yum.repos.d.bak/</span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-8.repo</span><br><span class="line">sed -i -e <span class="string">&#x27;/mirrors.cloud.aliyuncs.com/d&#x27;</span> -e <span class="string">&#x27;/mirrors.aliyuncs.com/d&#x27;</span> /etc/yum.repos.d/CentOS-Base.repo</span><br><span class="line">sed -i <span class="string">&#x27;s/releasever\//releasever-stream\//g&#x27;</span> /etc/yum.repos.d/CentOS-Base.repo</span><br></pre></td></tr></table></figure><ul><li>ç¼“å­˜æ¸…é™¤ä¸å…ƒæ•°æ®é‡å»º</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br></pre></td></tr></table></figure><ul><li><p>2.Docker å®‰è£…ä¸ä½¿ç”¨</p></li><li><p>æ›´æ–° yum æº</p></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y update</span><br></pre></td></tr></table></figure><ul><li>å®‰è£…</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">yum-config-manager \</span><br><span class="line">--add-repo \</span><br><span class="line">https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">yum install -y docker-ce</span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br></pre></td></tr></table></figure><ul><li><p>3.åŸºç¡€é•œåƒå®‰è£…ä¸ä½¿ç”¨</p></li><li><p>mysql</p></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql <span class="comment"># é•œåƒæ‹‰å–</span></span><br><span class="line">docker images <span class="comment"># æŸ¥çœ‹é•œåƒ</span></span><br><span class="line">docker run --name testmysql -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=smx0920 mysqlimagesname <span class="comment">#è¿è¡Œ</span></span><br><span class="line">docker ps -a</span><br></pre></td></tr></table></figure><ul><li>redis</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker pull redis</span><br><span class="line">docker images</span><br><span class="line">docker run -p 6379:6379 -vÂ <span class="variable">$PWD</span>/data:/dataÂ Â -d redis redis-server --appendonlyÂ <span class="built_in">yes</span></span><br><span class="line">docker ps -a</span><br></pre></td></tr></table></figure><ul><li>nginx</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker pull nginx</span><br><span class="line">docker images</span><br><span class="line"><span class="built_in">mkdir</span> -p /data/nginx/conf</span><br><span class="line"><span class="built_in">mkdir</span> -p /data/nginx/conf.d</span><br><span class="line"><span class="built_in">mkdir</span> -p /data/nginx/html</span><br><span class="line"><span class="built_in">mkdir</span> -p /data/nginx/logs</span><br><span class="line">docker run --name mynginx -d -p 80:80 -v /data/nginx/html:/usr/share/nginx/html -v /data/nginx/conf/nginx.conf:/etc/nginx/nginx.conf -v /data/nginx/conf.d/default.conf:/etc/nginx/conf.d/default.conf -v /data/nginx/logs:/var/log/nginx nginx</span><br><span class="line">docker ps -a</span><br></pre></td></tr></table></figure><ul><li><p>4.åŸºç¡€é•œåƒé…ç½®</p></li><li><p>mysql</p></li></ul><p><code>mysqléœ€åšå¦‚ä¸‹é…ç½®</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it mysql bash</span><br><span class="line">mysql -u root -p</span><br><span class="line"><span class="comment"># è¾“å…¥å¯†ç å›è½¦</span></span><br><span class="line">```</span><br><span class="line">`å¯¹æ•°æ®åº“åšå¦‚ä¸‹é…ç½®`</span><br><span class="line">```sql</span><br><span class="line">alter user <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified with mysql_native_password by <span class="string">&#x27;smx0920&#x27;</span>;</span><br><span class="line">flush privileges;</span><br><span class="line">```</span><br><span class="line">```sh</span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">docker restart mysql</span><br><span class="line">docker ps -a</span><br></pre></td></tr></table></figure><ul><li>redis<br><code>è¿è¡Œå®Œååšå¦‚ä¸‹æµ‹è¯•ï¼š</code></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L 127.0.0.1:6379</span><br></pre></td></tr></table></figure><ul><li>nginx</li></ul><h4 id="nginx-conf-é…ç½®">nginx.conf é…ç½®</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">user nginx;</span><br><span class="line">worker_processes 1;</span><br><span class="line"></span><br><span class="line">error_log /var/log/nginx/error.log warn;</span><br><span class="line">pid    /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">  worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">  include    /etc/nginx/mime.types;</span><br><span class="line">  default_type application/octet-stream;</span><br><span class="line"></span><br><span class="line">  log_format main <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">    <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">    <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  access_log /var/log/nginx/access.log main;</span><br><span class="line"></span><br><span class="line">  sendfile    on;</span><br><span class="line">  <span class="comment">#tcp_nopush   on;</span></span><br><span class="line"></span><br><span class="line">  keepalive_timeout 65;</span><br><span class="line"></span><br><span class="line">  <span class="comment">#gzip on;</span></span><br><span class="line"></span><br><span class="line">  include /etc/nginx/conf.d/*.conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="default-conf-é…ç½®">default.conf é…ç½®</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen    6666;</span><br><span class="line">  server_name localhost;</span><br><span class="line"></span><br><span class="line">  <span class="comment">#charset koi8-r;</span></span><br><span class="line">  <span class="comment">#access_log /var/log/nginx/host.access.log main;</span></span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    root  /usr/share/nginx/html;</span><br><span class="line">    index 1.html;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">#error_page 404/404.html;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># redirect server error pages to the static page /50x.html</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  error_page  500 502 503 504 /50x.html;</span><br><span class="line">  location = /50x.html &#123;</span><br><span class="line">    root  /usr/share/nginx/html;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  location /api/ &#123;</span><br><span class="line">    proxy_pass http://localhost:10000/shop <span class="comment">#ç«¯å£ä»£ç†è½¬å‘</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment"># proxy the PHP scripts to Apache listening on 127.0.0.1:80</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment">#location ~ .php$ &#123;</span></span><br><span class="line">  <span class="comment">#  proxy_pass  http://127.0.0.1;</span></span><br><span class="line">  <span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment">#location ~ .php$ &#123;</span></span><br><span class="line">  <span class="comment">#  root      html;</span></span><br><span class="line">  <span class="comment">#  fastcgi_pass  127.0.0.1:9000;</span></span><br><span class="line">  <span class="comment">#  fastcgi_index index.php;</span></span><br><span class="line">  <span class="comment">#  fastcgi_param script_FILENAME /scripts$fastcgi_script_name;</span></span><br><span class="line">  <span class="comment">#  include    fastcgi_params;</span></span><br><span class="line">  <span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># deny access to .htaccess files, if Apache&#x27;s document root</span></span><br><span class="line">  <span class="comment"># concurs with nginx&#x27;s one</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment">#location ~ /.ht &#123;</span></span><br><span class="line">  <span class="comment">#  deny all;</span></span><br><span class="line">  <span class="comment">#&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é…ç½®å®Œæˆåï¼Œé‡å¯å®¹å™¨</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart containerid</span><br></pre></td></tr></table></figure><ul><li>æˆ–è€…è¿›å…¥å®¹å™¨é‡å¯ nginx æœåŠ¡</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it nginx  bash</span><br><span class="line">nginx -s reload</span><br><span class="line">nginx -t</span><br></pre></td></tr></table></figure><ul><li>5.æœåŠ¡æ­å»ºä¸æµ‹è¯•</li></ul><h2 id="æœ€ç»ˆæµ‹è¯•">æœ€ç»ˆæµ‹è¯•</h2><ul><li>1.å‰ç«¯é¡µé¢æµ‹è¯•</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L http://localhost:6666</span><br></pre></td></tr></table></figure><ul><li>2.åç«¯æ¥å£æµ‹è¯•</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L http://localhost:10000/api/shop/test</span><br></pre></td></tr></table></figure><p><code>ä¸Šè¿°æœ‰ç»“æœåé¦ˆï¼Œå³ä¸ºéƒ¨ç½²æˆåŠŸï¼</code></p><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Electron Egg æ¡†æ¶ç ”ç©¶</title>
      <link href="/2023/03/10/eestudy/"/>
      <url>/2023/03/10/eestudy/</url>
      
        <content type="html"><![CDATA[<h2 id="ä»‹ç»">ä»‹ç»</h2><blockquote><p><code> electron-egg æ˜¯ä¸€ä¸ªä¸šåŠ¡æ¡†æ¶ï¼›å°±å¥½æ¯” Spring ä¹‹äº javaï¼Œthinkphp ä¹‹äº phpï¼Œnuxt.js ä¹‹äº vueï¼›electron åªæä¾›äº†åŸºç¡€çš„å‡½æ•°å’Œ apiï¼Œä½†ä½ å†™é¡¹ç›®çš„æ—¶å€™ï¼Œä¸šåŠ¡å’Œä»£ç å·¥ç¨‹åŒ–æ˜¯éœ€è¦è‡ªå·±å®ç°çš„ï¼Œee å°±æä¾›äº†è¿™ä¸ªå·¥ç¨‹åŒ–èƒ½åŠ›ã€‚</code></p></blockquote><ul><li>Electronï¼š åŸºäº JavaScript å¼€å‘çš„å¤šå¹³å°æ¡Œé¢åº”ç”¨æ¡†æ¶ï¼Œæ”¯æŒ MacOS ã€Linuxã€Windows ç­‰æ“ä½œç³»ç»Ÿã€‚</li></ul><h2 id="å®‰è£…ä¸ä½¿ç”¨">å®‰è£…ä¸ä½¿ç”¨</h2><h4 id="å®‰è£…">å®‰è£…</h4><ul><li>æºä»£ç </li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gitee</span></span><br><span class="line">git <span class="built_in">clone</span> https://gitee.com/dromara/electron-egg.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># github</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/dromara/electron-egg.git</span><br></pre></td></tr></table></figure><ul><li>å…¶ä»–</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®å›½å†…é•œåƒæº(åŠ é€Ÿ)</span></span><br><span class="line">npm config <span class="built_in">set</span> registry=https://registry.npmmirror.com</span><br><span class="line">npm config <span class="built_in">set</span> disturl=https://registry.npmmirror.com/-/binary/node</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¦‚æœä¸‹è½½electronæ…¢ï¼Œé…ç½®å¦‚ä¸‹ï¼ˆæˆ–è€…æŒ‚ä¸ªVPNï¼‰</span></span><br><span class="line">npm config <span class="built_in">set</span> electron_mirror=https://registry.npmmirror.com/-/binary/electron/</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›å…¥ç›®å½• ./electron-egg/</span></span><br><span class="line">npm install</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœè¿˜æ˜¯æç¤º electron æ²¡å®‰è£…ï¼Œè¿›å…¥ node_modules/electron ç›®å½•ä¸‹ï¼Œå†npm install</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„å»ºsqlite</span></span><br><span class="line"><span class="comment"># - éœ€è¦ python3 ç¯å¢ƒ ï¼ˆæ“ä½œç³»ç»Ÿè‡ªå¸¦ï¼‰</span></span><br><span class="line"><span class="comment"># - éœ€è¦ node-gyp</span></span><br><span class="line">npm i node-gyp -g</span><br><span class="line">npm run re-sqlite</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœsqliteæŠ¥é”™ ...toolsä¹‹ç±»çš„</span></span><br><span class="line">npm --vs2015 i -g --production windows-build-tools</span><br><span class="line">æˆ–è€…</span><br><span class="line">npm i -g --production windows-build-tools</span><br></pre></td></tr></table></figure><h2 id="å¼€å§‹ä½¿ç”¨">å¼€å§‹ä½¿ç”¨</h2><h3 id="å‰ç«¯">å‰ç«¯</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿›å…¥ã€å‰ç«¯ç›®å½•ã€‘</span></span><br><span class="line"><span class="built_in">cd</span> frontend</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…ä¾èµ–</span></span><br><span class="line">npm install</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨æœåŠ¡</span></span><br><span class="line">npm run serve</span><br></pre></td></tr></table></figure><h3 id="é€»è¾‘ä»£ç ">é€»è¾‘ä»£ç </h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯åŠ¨åç«¯æœåŠ¡</span></span><br><span class="line">npm run dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># çƒ­é‡è½½æ¨¡å¼</span></span><br><span class="line">npm run reload</span><br></pre></td></tr></table></figure><h2 id="é¡¹ç›®é…ç½®">é¡¹ç›®é…ç½®</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½ç½®</span></span><br><span class="line">./electron/config/</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯´æ˜</span></span><br><span class="line">config.default.js // é»˜è®¤é…ç½®æ–‡ä»¶ï¼Œå¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒéƒ½ä¼šåŠ è½½</span><br><span class="line">config.local.js // å¼€å‘ç¯å¢ƒé…ç½®æ–‡ä»¶ï¼Œè¿½åŠ å’Œè¦†ç›–defaulté…ç½®æ–‡ä»¶</span><br><span class="line">config.prod.js // ç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶ï¼Œè¿½åŠ å’Œè¦†ç›–defaulté…ç½®æ–‡ä»¶</span><br><span class="line">encrypt.js     // ä»£ç åŠ å¯†çš„é…ç½®</span><br><span class="line">nodemon.json   // å¼€å‘ç¯å¢ƒï¼Œä»£ç ï¼ˆç›‘æ§ï¼‰çƒ­åŠ è½½</span><br></pre></td></tr></table></figure><h2 id="é¡¹ç›®ç»“æ„">é¡¹ç›®ç»“æ„</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">project</span><br><span class="line">â”œâ”€â”€ package.json npmåŒ…é…ç½®</span><br><span class="line">â”œâ”€â”€ bulid æ‰“åŒ…ç”¨çš„èµ„æºå’Œè„šæœ¬</span><br><span class="line">â”œâ”€â”€ icons è½¯ä»¶å›¾æ ‡ï¼ˆæ‰“åŒ…ç”¨åˆ°ï¼‰</span><br><span class="line">    â”œâ”€â”€ extraResources é¢å¤–èµ„æºç›®å½•</span><br><span class="line">â”œâ”€â”€ electron ä¸»è¿›ç¨‹æœåŠ¡</span><br><span class="line">    â”œâ”€â”€ addon æ’ä»¶ç›®å½•</span><br><span class="line">        â”œâ”€â”€ example demoæ’ä»¶ï¼ˆä»£ç ç¤ºä¾‹ï¼‰</span><br><span class="line">    â”œâ”€â”€ config é…ç½®æ–‡ä»¶</span><br><span class="line">        â”œâ”€â”€ config.default.js é»˜è®¤é…ç½®ï¼Œéƒ½ä¼šåŠ è½½</span><br><span class="line">        â”œâ”€â”€ config.local.js devç¯å¢ƒåŠ è½½</span><br><span class="line">        â”œâ”€â”€ config.prod.js ç”Ÿäº§ç¯å¢ƒåŠ è½½</span><br><span class="line">â”œâ”€â”€ encrypt.js åŠ å¯†é…ç½®æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ controller æ§åˆ¶å™¨</span><br><span class="line">    â”œâ”€â”€ service ä¸šåŠ¡å±‚</span><br><span class="line">    â”œâ”€â”€ preload é¢„åŠ è½½ï¼Œåœ¨ç¨‹åºå¯åŠ¨æ—¶åŠ è½½ï¼Œå¦‚æ‰˜ç›˜ã€è‡ªåŠ¨å‡çº§ç­‰åŠŸèƒ½è¦æå‰åŠ è½½ä»£ç </span><br><span class="line">    â”œâ”€â”€ library ä¸€äº›å°è£…åº“</span><br><span class="line">â”œâ”€â”€ frontend å‰ç«¯ç›®å½•ï¼ˆdemoæ˜¯ç”¨vueç¼–å†™çš„ï¼‰</span><br><span class="line">â”œâ”€â”€ out æ‰“åŒ…åç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ latest.yml è‡ªåŠ¨å‡çº§æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ xxx.exe windowåº”ç”¨å®‰è£…åŒ…</span><br><span class="line">    â”œâ”€â”€ xxx.exe.blockmap windowåº”ç”¨å¢é‡å‡çº§åŒ…ï¼ˆæœªæµ‹è¯•è¿‡ï¼‰</span><br><span class="line">    â”œâ”€â”€ xxx.dmg macåº”ç”¨å®‰è£…åŒ…</span><br><span class="line">    â”œâ”€â”€ xxx.deb linuxåº”ç”¨å®‰è£…åŒ…åç¼€æœ‰å¤šç§</span><br><span class="line">â”œâ”€â”€ run ä¸€äº›è¿è¡Œç¼“å­˜</span><br><span class="line">â”œâ”€â”€ logs æ—¥å¿—</span><br><span class="line">â”œâ”€â”€ main.js å…¥å£æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ public èµ„æºç›®å½•</span><br><span class="line">â”œâ”€â”€ dist å‰ç«¯èµ„æºä¼šç§»åŠ¨åˆ°è¿™é‡Œï¼Œç”Ÿäº§ç¯å¢ƒåŠ è½½</span><br><span class="line">    â”œâ”€â”€ electron ä¸šåŠ¡jsåŠ å¯†åçš„æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ html ä¸€äº›æ¨¡æ¿</span><br><span class="line">    â”œâ”€â”€ images ä¸€äº›å›¾ç‰‡</span><br><span class="line">â”œâ”€â”€ data å†…ç½®æ•°æ®åº“æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ system.json æ¡†æ¶ä½¿ç”¨çš„æ•°æ®åº“</span><br><span class="line">â”œâ”€â”€ demo.json ç¤ºä¾‹jsonæ•°æ®åº“</span><br><span class="line">â”œâ”€â”€ sqlite-demo.db ç¤ºä¾‹sqliteæ•°æ®åº“</span><br></pre></td></tr></table></figure><h2 id="demo-æ”¹å†™æ­¥éª¤">demo æ”¹å†™æ­¥éª¤</h2><ul><li>1.ç¼–å†™æ¥å£</li><li>åœ¨ electron\controller\demo.js ä¸­ç¼–å†™æ–¹æ³•</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‰“å¼€æµè§ˆå™¨</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="title function_">openBrowser</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">messageShowConfirm</span>(<span class="string">&quot;ok?&quot;</span>);</span><br><span class="line">  <span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&quot;http://baidu.com&quot;</span>);<span class="comment">//ä»£æ›¿å‡½æ•°æ“ä½œ</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">messageShow</span>(<span class="string">&quot;success.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>2.å®šä¹‰æ¥å£</li><li>åœ¨ frontend\src\api\main.js ä¸­å®šä¹‰æ¥å£</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ipcApiRoute = &#123;</span><br><span class="line">  <span class="attr">openBrowser</span>: <span class="string">&quot;controller.example.openBrowser&quot;</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>3.ä½¿ç”¨æ¥å£</li><li>åœ¨æŒ‡å®šç•Œé¢ä½¿ç”¨æ¥å£</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">openBrowserClick</span>(<span class="params"></span>)&#123;</span><br><span class="line">   <span class="variable language_">this</span>.<span class="property">$ipc</span>.<span class="title function_">invoke</span>(ipcApiRoute.<span class="property">openBrowser</span>).<span class="title function_">then</span>(<span class="function"><span class="params">r</span> =&gt;</span> &#123;</span><br><span class="line">     <span class="variable language_">console</span>.<span class="title function_">log</span>(r);</span><br><span class="line">   &#125;)</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h2 id="æ‰“åŒ…å‘å¸ƒåº”ç”¨">æ‰“åŒ…å‘å¸ƒåº”ç”¨</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰“åŒ…æ—¶ï¼Œpackage.jsonä¸­build.productNameåŒ…åä¸è¦ä¸ºä¸­æ–‡ï¼Œé¿å…ä¸€äº›æœªçŸ¥å¼‚å¸¸</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å‡†å¤‡ï¼Œè®¾ç½®å›½å†…é•œåƒ</span></span><br><span class="line">npm config <span class="built_in">set</span> electron_builder_binaries_mirror=https://registry.npmmirror.com/-/binary/electron-builder-binaries/</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“åŒ… ï¼ˆwindowsç‰ˆï¼‰</span></span><br><span class="line">npm run build-w</span><br><span class="line">npm run build-w-32 (64ä½)</span><br><span class="line">npm run build-w-64 (64ä½)</span><br><span class="line">npm run build-w-arm64 (arm64)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“åŒ… ï¼ˆwindows å…å®‰è£…ç‰ˆï¼‰</span></span><br><span class="line"><span class="comment"># ee &gt; v2.2.1</span></span><br><span class="line">npm run build-wz</span><br><span class="line">npm run build-wz-32 (32ä½)</span><br><span class="line">npm run build-wz-64 (64ä½)</span><br><span class="line">npm run build-wz-arm64 (arm64)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“åŒ… ï¼ˆmacç‰ˆï¼‰</span></span><br><span class="line">npm run build-m</span><br><span class="line">npm run build-m-arm64 (m1èŠ¯ç‰‡æ¶æ„)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“åŒ… ï¼ˆlinuxç‰ˆï¼‰</span></span><br><span class="line"><span class="comment"># ee &gt; v2.2.1</span></span><br><span class="line">npm run build-l (32ä½ debåŒ…)</span><br><span class="line">npm run build-l-64 (64ä½ debåŒ…)</span><br><span class="line">npm run build-l-arm64 (64ä½ debåŒ… arm64)</span><br><span class="line">npm run build-l-armv7l (64ä½ debåŒ… armv7l)</span><br><span class="line">npm run build-lr-64 (64ä½ rpmåŒ…)</span><br><span class="line">npm run build-lp-64 (64ä½ pacmanåŒ…)</span><br></pre></td></tr></table></figure><h2 id="See">See</h2><ul><li>1.<a href="https://www.yuque.com/u34495/mivcfg/fro580">https://www.yuque.com/u34495/mivcfg/fro580</a></li><li>2.<a href="https://www.w3cschool.cn/electronmanual/dih61qlb.html">https://www.w3cschool.cn/electronmanual/dih61qlb.html</a></li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> electron </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç™¾åº¦åœ°å›¾åŠŸèƒ½ä½¿ç”¨</title>
      <link href="/2023/03/06/baidumapuse/"/>
      <url>/2023/03/06/baidumapuse/</url>
      
        <content type="html"><![CDATA[<h2 id="key-generate-åœ°å›¾-API-ç§˜é’¥ç”Ÿæˆ">key generate åœ°å›¾ API ç§˜é’¥ç”Ÿæˆ</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -printcert -file CERT.RSA</span><br></pre></td></tr></table></figure><h2 id="key-select-è°ƒè¯•ç‰ˆ">key select è°ƒè¯•ç‰ˆ</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -list -v -keystore debug.keystore</span><br></pre></td></tr></table></figure><h2 id="key-gen-å¯†é’¥ç”Ÿæˆ">key gen å¯†é’¥ç”Ÿæˆ</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -genkey -<span class="built_in">alias</span> test.keystore -keyalg RSA -validity 40000 -keystore demo.keystore</span><br></pre></td></tr></table></figure><h2 id="or-see-è¯¦æƒ…è¯·çœ‹">or see è¯¦æƒ…è¯·çœ‹</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://blog.csdn.net/qq_40808344/article/details/101148833</span><br></pre></td></tr></table></figure><h2 id="error">error</h2><ul><li>details å·²çŸ¥é”™è¯¯</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The location <span class="keyword">function</span> has been stopped because you <span class="keyword">do</span> not agree with the privacy compliance policy. Please recheck the setAgreePrivacy interface</span><br></pre></td></tr></table></figure><ul><li><p>solve è§£å†³æ–¹æ¡ˆ</p><ul><li><p>such as figure 1 å–æ¶ˆä¸‹åˆ—æ–‡ä»¶ä¸­å¯¹åº”è¡Œçš„æ³¨é‡Šå³å¯è§£å†³</p><p><img src="/2023/03/06/baidumapuse/solve.png" class="lazyload placeholder" data-srcset="/2023/03/06/baidumapuse/solve.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p></li></ul></li></ul><h2 id="see-å‚è€ƒ">see å‚è€ƒ</h2><p><a href="https://blog.csdn.net/czy_1995/article/details/128342280">https://blog.csdn.net/czy_1995/article/details/128342280</a></p><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C#æ€æ­»unityä¸­çš„è¿›ç¨‹æ–¹æ³•</title>
      <link href="/2023/03/02/csharpkillprocess/"/>
      <url>/2023/03/02/csharpkillprocess/</url>
      
        <content type="html"><![CDATA[<h2 id="unity-é€€å‡º-app">unity é€€å‡º app</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"> <span class="comment"><span class="doctag">///</span> exit</span></span><br><span class="line"> <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ExitUnity</span>()</span></span><br><span class="line"> &#123;</span><br><span class="line">     Application.Quit();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h2 id="unity-æš‚åœé€€å‡º">unity æš‚åœé€€å‡º</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> unload</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UnloadUnity</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    Application.Unload();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="unity-æ€æ­»å½“å‰æ‰€æœ‰è¿›ç¨‹">unity æ€æ­»å½“å‰æ‰€æœ‰è¿›ç¨‹</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> é€€å‡ºæ–¹å¼1 https://blog.csdn.net/sakuya_miku/article/details/109219878</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">OnExitBtnClick</span>(<span class="params"><span class="built_in">string</span> processName</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="comment">// https://blog.csdn.net/qq_38721111/article/details/82864423</span></span><br><span class="line">       UnityEngine.Debug.Log(<span class="string">&quot;å½“å‰åº”ç”¨ï¼š&quot;</span> + System.Diagnostics.Process.GetCurrentProcess().ProcessName + <span class="string">&quot; è¿›ç¨‹ID: &quot;</span> + System.Diagnostics.Process.GetCurrentProcess().Id);</span><br><span class="line">       <span class="comment">// ListAllAppliction();</span></span><br><span class="line">       UnityEngine.Debug.Log(<span class="string">&quot;On Exit Btn CLick method executing&quot;</span>);</span><br><span class="line">       <span class="keyword">try</span></span><br><span class="line">       &#123;</span><br><span class="line"></span><br><span class="line">           System.Diagnostics.Process.GetCurrentProcess().Exited += <span class="keyword">new</span> EventHandler(exep_Exited);</span><br><span class="line">           System.Diagnostics.Process.GetCurrentProcess().CloseMainWindow();</span><br><span class="line">           System.Diagnostics.Process.GetCurrentProcess().Close();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">catch</span> (Exception e)</span><br><span class="line">       &#123;</span><br><span class="line">           UnityEngine.Debug.Log(<span class="string">&quot;error : &quot;</span> + e);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">exep_Exited</span>(<span class="params"><span class="built_in">object</span> sender, EventArgs e</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       UnityEngine.Debug.LogError(<span class="string">&quot;CloseMainWindow&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="unity-æ€æ­»æ‰€æœ‰è¿›ç¨‹">unity æ€æ­»æ‰€æœ‰è¿›ç¨‹</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> æ€æ­»è¿›ç¨‹</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;processName&quot;&gt;</span>åº”ç”¨ç¨‹åºå<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">KillProcess</span>(<span class="params"><span class="built_in">string</span> processName</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       System.Diagnostics.Process[] processes = System.Diagnostics.Process.GetProcesses();</span><br><span class="line">       <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; processes.Length; i++)</span><br><span class="line">           processes[i].Kill();</span><br><span class="line">       UnityEngine.Debug.Log(<span class="string">&quot;å·²æ€æ­»è¿›ç¨‹&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="unity-é€šè¿‡-Pid-æ€æ­»æŒ‡å®šè¿›ç¨‹">unity é€šè¿‡ Pid æ€æ­»æŒ‡å®šè¿›ç¨‹</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> kill by pid</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;id&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">KillByPid</span>(<span class="params"><span class="built_in">string</span> id</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    System.Diagnostics.Process p = System.Diagnostics.Process.GetProcessById(<span class="built_in">int</span>.Parse(id));</span><br><span class="line">    p.Kill();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€æ­»å½“å‰å•ä¸€è¿›ç¨‹">æ€æ­»å½“å‰å•ä¸€è¿›ç¨‹</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> test single kill process</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SingleKillProcess</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    System.Diagnostics.Process.GetCurrentProcess().Kill();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> unity </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android åœ¨Activityä¸­æ‰“å¼€æŸä¸ªapp</title>
      <link href="/2023/03/02/androidopenapp-md/"/>
      <url>/2023/03/02/androidopenapp-md/</url>
      
        <content type="html"><![CDATA[<h2 id="åœ¨ä½¿ç”¨å‰ä¼ å…¥-app-åŒ…åï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š">åœ¨ä½¿ç”¨å‰ä¼ å…¥ app åŒ…åï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">openApp</span><span class="params">(String packageName)</span> &#123;</span><br><span class="line">       <span class="type">PackageInfo</span> <span class="variable">pi</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           pi = getPackageManager().getPackageInfo(packageName, <span class="number">0</span>);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (pi == <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="comment">// è¿™é‡Œå¦‚æœ packageInfo ä¸º null, è¯´æ˜åº”ç”¨ä¸å­˜åœ¨</span></span><br><span class="line">           Toast.makeText(SecondActivity.<span class="built_in">this</span>, <span class="string">&quot;App does not exist&quot;</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="type">Intent</span> <span class="variable">resolveIntent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_MAIN, <span class="literal">null</span>);</span><br><span class="line">           resolveIntent.addCategory(Intent.CATEGORY_LAUNCHER);</span><br><span class="line">           resolveIntent.setPackage(pi.packageName);</span><br><span class="line">           List&lt;ResolveInfo&gt; apps = getPackageManager().queryIntentActivities(resolveIntent, <span class="number">0</span>);</span><br><span class="line">           <span class="type">ResolveInfo</span> <span class="variable">ri</span> <span class="operator">=</span> apps.iterator().next();</span><br><span class="line">           <span class="keyword">if</span> (ri != <span class="literal">null</span>) &#123;</span><br><span class="line">               <span class="type">String</span> <span class="variable">packageName2</span> <span class="operator">=</span> ri.activityInfo.packageName;</span><br><span class="line">               <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> ri.activityInfo.name;</span><br><span class="line">               <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_MAIN);</span><br><span class="line">               intent.addCategory(Intent.CATEGORY_LAUNCHER);</span><br><span class="line">               <span class="type">ComponentName</span> <span class="variable">cn</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ComponentName</span>(packageName2, className);</span><br><span class="line">               intent.setComponent(cn);</span><br><span class="line">               startActivity(intent);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2 id="åœ¨æ‰“å¼€å‰æ£€æŸ¥æ˜¯å¦å­˜åœ¨">åœ¨æ‰“å¼€å‰æ£€æŸ¥æ˜¯å¦å­˜åœ¨</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">PackageManager packageManager = getPackageManager();</span><br><span class="line"><span class="keyword">if</span> (checkPackInfo(packname)) &#123;</span><br><span class="line">    Intent intent = packageManager.getLaunchIntentForPackage(packname);</span><br><span class="line">    startActivity(intent);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">&quot;æ²¡æœ‰å®‰è£…&quot;</span> + packname, <span class="number">1</span>).show();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ£€æŸ¥åŒ…æ˜¯å¦å­˜åœ¨</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param packname</span></span><br><span class="line"><span class="comment"> * @return</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> boolean <span class="title">checkPackInfo</span>(<span class="params">String packname</span>)</span> &#123;</span><br><span class="line">    PackageInfo packageInfo = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        packageInfo = getPackageManager().getPackageInfo(packname, <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> packageInfo != <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="æ‰“å¼€-app-æŒ‡å®š-activity">æ‰“å¼€ app æŒ‡å®š activity</h2><h3 id="ä»£ç ">ä»£ç </h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line"><span class="comment">//ç¬¬ä¸€ç§æ–¹å¼</span></span><br><span class="line"><span class="type">ComponentName</span> <span class="variable">cn</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ComponentName</span>(<span class="string">&quot;com.example.fm&quot;</span>, <span class="string">&quot;com.example.fm.MainFragmentActivity&quot;</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    intent.setComponent(cn);</span><br><span class="line">    <span class="comment">//ç¬¬äºŒç§æ–¹å¼</span></span><br><span class="line">    <span class="comment">//intent.setClassName(&quot;com.example.fm&quot;, &quot;com.example.fm.MainFragmentActivity&quot;);</span></span><br><span class="line">    intent.putExtra(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;intent1&quot;</span>);</span><br><span class="line">    startActivity(intent);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="comment">//TODO  å¯ä»¥åœ¨è¿™é‡Œæç¤ºç”¨æˆ·æ²¡æœ‰å®‰è£…åº”ç”¨æˆ–æ‰¾ä¸åˆ°æŒ‡å®šActivityï¼Œæˆ–è€…æ˜¯åšå…¶ä»–çš„æ“ä½œ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æƒé™é…ç½®">æƒé™é…ç½®</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;activity android:name=<span class="string">&quot;com.example.fm.MainFragmentActivity&quot;</span>&gt;&lt;/activity&gt;</span><br></pre></td></tr></table></figure><h2 id="å¯åŠ¨æ¨¡å¼">å¯åŠ¨æ¨¡å¼</h2><h3 id="android-æ€»-Activity-çš„å¯åŠ¨æ¨¡å¼åˆ†ä¸ºå››ç§ï¼š">android æ€» Activity çš„å¯åŠ¨æ¨¡å¼åˆ†ä¸ºå››ç§ï¼š</h3><h4 id="Activity-å¯åŠ¨æ¨¡å¼è®¾ç½®ï¼š">Activity å¯åŠ¨æ¨¡å¼è®¾ç½®ï¼š</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;activity android:name=<span class="string">&quot;.MainActivity&quot;</span> android:launchMode=<span class="string">&quot;standard&quot;</span> /&gt;</span><br></pre></td></tr></table></figure><h3 id="Activity-çš„å››ç§å¯åŠ¨æ¨¡å¼ï¼š">Activity çš„å››ç§å¯åŠ¨æ¨¡å¼ï¼š</h3><h4 id="1-standard-æ¨¡å¼å¯åŠ¨æ¨¡å¼ï¼Œæ¯æ¬¡æ¿€æ´»-Activity-æ—¶éƒ½ä¼šåˆ›å»º-Activityï¼Œå¹¶æ”¾å…¥ä»»åŠ¡æ ˆä¸­ã€‚">1. standard æ¨¡å¼å¯åŠ¨æ¨¡å¼ï¼Œæ¯æ¬¡æ¿€æ´» Activity æ—¶éƒ½ä¼šåˆ›å»º Activityï¼Œå¹¶æ”¾å…¥ä»»åŠ¡æ ˆä¸­ã€‚</h4><h4 id="2-singleTop-å¦‚æœåœ¨ä»»åŠ¡çš„æ ˆé¡¶æ­£å¥½å­˜åœ¨è¯¥-Activity-çš„å®ä¾‹ï¼Œ-å°±é‡ç”¨è¯¥å®ä¾‹ï¼Œå¦è€…å°±ä¼šåˆ›å»ºæ–°çš„å®ä¾‹å¹¶æ”¾å…¥æ ˆé¡¶-å³ä½¿æ ˆä¸­å·²ç»å­˜åœ¨è¯¥-Activity-å®ä¾‹ï¼Œåªè¦ä¸åœ¨æ ˆé¡¶ï¼Œéƒ½ä¼šåˆ›å»ºå®ä¾‹-ã€‚">2. singleTop å¦‚æœåœ¨ä»»åŠ¡çš„æ ˆé¡¶æ­£å¥½å­˜åœ¨è¯¥ Activity çš„å®ä¾‹ï¼Œ å°±é‡ç”¨è¯¥å®ä¾‹ï¼Œå¦è€…å°±ä¼šåˆ›å»ºæ–°çš„å®ä¾‹å¹¶æ”¾å…¥æ ˆé¡¶(å³ä½¿æ ˆä¸­å·²ç»å­˜åœ¨è¯¥ Activity å®ä¾‹ï¼Œåªè¦ä¸åœ¨æ ˆé¡¶ï¼Œéƒ½ä¼šåˆ›å»ºå®ä¾‹)ã€‚</h4><h4 id="3-singleTask-å¦‚æœåœ¨æ ˆä¸­å·²ç»æœ‰è¯¥-Activity-çš„å®ä¾‹ï¼Œå°±é‡ç”¨è¯¥å®ä¾‹-ä¼šè°ƒç”¨å®ä¾‹çš„-onNewIntent-ã€‚é‡ç”¨æ—¶ï¼Œä¼šè®©è¯¥å®ä¾‹å›åˆ°æ ˆé¡¶ï¼Œå› æ­¤åœ¨å®ƒä¸Šé¢çš„å®ä¾‹å°†ä¼šè¢«ç§»é™¤æ ˆã€‚å¦‚æœæ ˆä¸­ä¸å­˜åœ¨è¯¥å®ä¾‹ï¼Œå°†ä¼šåˆ›å»ºæ–°çš„å®ä¾‹æ”¾å…¥æ ˆä¸­ã€‚">3. singleTask å¦‚æœåœ¨æ ˆä¸­å·²ç»æœ‰è¯¥ Activity çš„å®ä¾‹ï¼Œå°±é‡ç”¨è¯¥å®ä¾‹(ä¼šè°ƒç”¨å®ä¾‹çš„ onNewIntent())ã€‚é‡ç”¨æ—¶ï¼Œä¼šè®©è¯¥å®ä¾‹å›åˆ°æ ˆé¡¶ï¼Œå› æ­¤åœ¨å®ƒä¸Šé¢çš„å®ä¾‹å°†ä¼šè¢«ç§»é™¤æ ˆã€‚å¦‚æœæ ˆä¸­ä¸å­˜åœ¨è¯¥å®ä¾‹ï¼Œå°†ä¼šåˆ›å»ºæ–°çš„å®ä¾‹æ”¾å…¥æ ˆä¸­ã€‚</h4><h4 id="4-singleInstance-åœ¨ä¸€ä¸ªæ–°æ ˆä¸­åˆ›å»ºè¯¥-Activity-å®ä¾‹ï¼Œå¹¶è®©å¤šä¸ªåº”ç”¨å…±äº«æ”¹æ ˆä¸­çš„è¯¥-Activity-å®ä¾‹ã€‚ä¸€æ—¦æ”¹æ¨¡å¼çš„-Activity-çš„å®ä¾‹å­˜åœ¨äºæŸä¸ªæ ˆä¸­ï¼Œä»»ä½•åº”ç”¨å†æ¿€æ´»æ”¹-Activity-æ—¶éƒ½ä¼šé‡ç”¨è¯¥æ ˆä¸­çš„å®ä¾‹ï¼Œå…¶æ•ˆæœç›¸å½“äºå¤šä¸ªåº”ç”¨ç¨‹åºå…±äº«ä¸€ä¸ªåº”ç”¨ï¼Œä¸ç®¡è°æ¿€æ´»è¯¥-Activity-éƒ½ä¼šè¿›å…¥åŒä¸€ä¸ªåº”ç”¨ä¸­ã€‚">4. singleInstance åœ¨ä¸€ä¸ªæ–°æ ˆä¸­åˆ›å»ºè¯¥ Activity å®ä¾‹ï¼Œå¹¶è®©å¤šä¸ªåº”ç”¨å…±äº«æ”¹æ ˆä¸­çš„è¯¥ Activity å®ä¾‹ã€‚ä¸€æ—¦æ”¹æ¨¡å¼çš„ Activity çš„å®ä¾‹å­˜åœ¨äºæŸä¸ªæ ˆä¸­ï¼Œä»»ä½•åº”ç”¨å†æ¿€æ´»æ”¹ Activity æ—¶éƒ½ä¼šé‡ç”¨è¯¥æ ˆä¸­çš„å®ä¾‹ï¼Œå…¶æ•ˆæœç›¸å½“äºå¤šä¸ªåº”ç”¨ç¨‹åºå…±äº«ä¸€ä¸ªåº”ç”¨ï¼Œä¸ç®¡è°æ¿€æ´»è¯¥ Activity éƒ½ä¼šè¿›å…¥åŒä¸€ä¸ªåº”ç”¨ä¸­ã€‚</h4><h4 id="å…¶ä¸­-standard-æ˜¯ç³»ç»Ÿé»˜è®¤çš„å¯åŠ¨æ¨¡å¼ã€‚">å…¶ä¸­ standard æ˜¯ç³»ç»Ÿé»˜è®¤çš„å¯åŠ¨æ¨¡å¼ã€‚</h4><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kill_process_app é€šè¿‡javaä»£ç killè¿›ç¨‹</title>
      <link href="/2023/02/24/kill-process-app/"/>
      <url>/2023/02/24/kill-process-app/</url>
      
        <content type="html"><![CDATA[<h2 id="æ€è·¯">æ€è·¯</h2><ul><li>1.æ€æ­»æŒ‡å®šåŒ…åå¯¹åº”è¿›ç¨‹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">killService</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ActivityManager</span> <span class="variable">manager</span> <span class="operator">=</span> (ActivityManager) getSystemService(Context.ACTIVITY_SERVICE);</span><br><span class="line">    manager.killBackgroundProcesses(<span class="string">&quot;com.googleplay.service&quot;</span>);</span><br><span class="line">    List&lt;RunningAppProcessInfo&gt; list = manager.getRunningAppProcesses();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; list.size(); i++) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">process</span> <span class="operator">=</span> list.get(i).processName;</span><br><span class="line">        <span class="keyword">if</span> (process.equals(<span class="string">&quot;com.google.service&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Runtime.getRuntime().exec(<span class="string">&quot;kill &quot;</span> + list.get(i).pid);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>2.è·å–å½“å‰è¿›ç¨‹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context mContext</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> list</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;ProcessInfo&gt; <span class="title function_">getRunningProcesses</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="type">ActivityManager</span> <span class="variable">am</span> <span class="operator">=</span> (ActivityManager) context.getSystemService(Context.ACTIVITY_SERVICE);</span><br><span class="line">        List&lt;ActivityManager.RunningAppProcessInfo&gt; runningAppProcesses = am</span><br><span class="line">                .getRunningAppProcesses();<span class="comment">//è·å–è¿è¡Œä¸­è¿›ç¨‹é›†åˆ</span></span><br><span class="line"></span><br><span class="line">        <span class="type">PackageManager</span> <span class="variable">pm</span> <span class="operator">=</span> context.getPackageManager();</span><br><span class="line">        ArrayList&lt;ProcessInfo&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;ProcessInfo&gt;();</span><br><span class="line">        <span class="keyword">for</span> (ActivityManager.RunningAppProcessInfo runningAppProcessInfo : runningAppProcesses) &#123;</span><br><span class="line">            <span class="type">ProcessInfo</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessInfo</span>();</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">packageName</span> <span class="operator">=</span> runningAppProcessInfo.processName; <span class="comment">//åŒ…å</span></span><br><span class="line">            info.packageName = packageName;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">pid</span> <span class="operator">=</span> runningAppProcessInfo.pid;</span><br><span class="line">            Debug.MemoryInfo[] processMemoryInfo = am.getProcessMemoryInfo(<span class="keyword">new</span> <span class="title class_">int</span>[]&#123;pid&#125;);<span class="comment">//æ ¹æ®pidè¿”å›å†…å­˜ä¿¡æ¯</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">memory</span> <span class="operator">=</span> processMemoryInfo[<span class="number">0</span>].getTotalPrivateDirty() * <span class="number">1024</span>;  <span class="comment">//è·å–å½“å‰è¿›ç¨‹å ç”¨å†…å­˜å¤§å°</span></span><br><span class="line">            info.memory = memory;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">ApplicationInfo</span> <span class="variable">applicationInfo</span> <span class="operator">=</span> pm.getApplicationInfo(packageName, <span class="number">0</span>);<span class="comment">//æ ¹æ®åŒ…åè·å–ç›¸å…³åº”ç”¨çš„ä¿¡æ¯</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> applicationInfo.loadLabel(pm).toString();</span><br><span class="line">                <span class="type">Drawable</span> <span class="variable">icon</span> <span class="operator">=</span> applicationInfo.loadIcon(pm);</span><br><span class="line"></span><br><span class="line">                info.name = name;</span><br><span class="line">                info.icon = icon;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">flags</span> <span class="operator">=</span> applicationInfo.flags;</span><br><span class="line">                <span class="keyword">if</span> ((flags &amp; ApplicationInfo.FLAG_SYSTEM) == ApplicationInfo.FLAG_SYSTEM) &#123;</span><br><span class="line">                    <span class="comment">//ç³»ç»Ÿè¿›ç¨‹</span></span><br><span class="line">                    info.isUser = <span class="literal">false</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//ç”¨æˆ·è¿›ç¨‹</span></span><br><span class="line">                    info.isUser = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">                <span class="comment">//æŸäº›ç³»ç»Ÿè¿›ç¨‹æ²¡æœ‰åç§°å’Œå›¾æ ‡,ä¼šèµ°æ­¤å¼‚å¸¸</span></span><br><span class="line">                info.name = packageName;</span><br><span class="line">                info.icon = context.getResources().getDrawable(R.drawable.left_car);</span><br><span class="line">                info.isUser = <span class="literal">false</span>;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            list.add(info);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Killsu</span><span class="params">(<span class="type">int</span> pn)</span> &#123;</span><br><span class="line">        <span class="type">Process</span> <span class="variable">sh</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">DataOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            sh = Runtime.getRuntime().exec(<span class="string">&quot;su&quot;</span>);</span><br><span class="line"></span><br><span class="line">            os = <span class="keyword">new</span> <span class="title class_">DataOutputStream</span>(sh.getOutputStream());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                os.writeBytes(<span class="string">&quot;kill -9 &quot;</span> + pn + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">                Log.d(TAG, <span class="string">&quot;kill -9&quot;</span>);</span><br><span class="line"></span><br><span class="line">                sleep(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line"></span><br><span class="line">                Log.d(TAG, <span class="string">&quot;kill -9 catch exception&quot;</span>);</span><br><span class="line"></span><br><span class="line">                e.printStackTrace();</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line"></span><br><span class="line">            e.printStackTrace();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line"></span><br><span class="line">            e.printStackTrace();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>3.å…¶ä»–æ–¹æ³•</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">android.os.Process.killProcess(android.os.Process.myPid());</span><br><span class="line"></span><br><span class="line">   <span class="type">ActivityManager</span> <span class="variable">activityManager</span> <span class="operator">=</span> (ActivityManager) getSystemService(Context.ACTIVITY_SERVICE);</span><br><span class="line">   activityManager.killBackgroundProcesses(<span class="string">&quot;com.zhang.wei&quot;</span>);</span><br><span class="line"></span><br><span class="line">  &lt;uses-permission android:name=<span class="string">&quot;android.permission.KILL_BACKGROUND_PROCESSES&quot;</span>/&gt;</span><br></pre></td></tr></table></figure><ul><li><ol start="4"><li>æ€æ­»æœ¬è¿›ç¨‹</li></ol></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.exit(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨Hexoæ¡†æ¶æ„å»ºåšå®¢å¹¶å‘å¸ƒ</title>
      <link href="/2023/02/22/hexo-blog-createanduse/"/>
      <url>/2023/02/22/hexo-blog-createanduse/</url>
      
        <content type="html"><![CDATA[<h2 id="hexo-blog-desc">hexo blog desc</h2><ul><li>Hexo æ˜¯ä¸€ä¸ªå¿«é€Ÿã€ç®€æ´ä¸”é«˜æ•ˆçš„åšå®¢æ¡†æ¶ã€‚Hexo ä½¿ç”¨ Markdownï¼ˆæˆ–å…¶ä»–æ¸²æŸ“å¼•æ“ï¼‰è§£ææ–‡ç« ï¼Œåœ¨å‡ ç§’å†…ï¼Œå³å¯åˆ©ç”¨é“ä¸½çš„ä¸»é¢˜ç”Ÿæˆé™æ€ç½‘é¡µã€‚</li></ul><h2 id="hexo-install">hexo install</h2><ul><li>å®‰è£… Node.js<br>åœ¨å®˜æ–¹ç½‘ç«™ä¸‹è½½å³å¯å®‰è£…ï¼Œé“¾æ¥å¦‚ä¸‹</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://nodejs.org/en/</span><br></pre></td></tr></table></figure><ul><li>å®‰è£… cnpm æˆ–ä½¿ç”¨æ·˜å®é•œåƒï¼ˆäºŒé€‰ä¸€ï¼‰</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install -g cnpm</span><br><span class="line">npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure><ul><li>å®‰è£… hexo</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g hexo-cli</span><br></pre></td></tr></table></figure><h2 id="github-pages-and-gitee-pages-open-page-services">github pages and gitee pages open page services</h2><ul><li><p>1.github pages å¼€é€šä½¿ç”¨</p><ul><li>åˆ›å»ºä¸ github ç”¨æˆ·åŒåä»“åº“ï¼Œå‘½åæ–¹å¼å¦‚ä¸‹<br>å¦‚å›¾<br><img src="/2023/02/22/hexo-blog-createanduse/createrepo.png" class="lazyload placeholder" data-srcset="/2023/02/22/hexo-blog-createanduse/createrepo.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username.github.io</span><br></pre></td></tr></table></figure><ul><li>å¼€å¯ github pages æœåŠ¡<br>å¦‚å›¾ï¼š<br><img src="/2023/02/22/hexo-blog-createanduse/opengithubpages.png" class="lazyload placeholder" data-srcset="/2023/02/22/hexo-blog-createanduse/opengithubpages.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></li></ul></li><li><p>2.gitee pages å¼€é€šä½¿ç”¨</p><ul><li><p>åˆ›å»ºä¸ç©ºé—´åç›¸åŒä»“åº“</p></li><li><p>å¼€é€š pages æœåŠ¡ï¼ˆéœ€æå‰å®åè®¤è¯ï¼Œè¾ƒä¸ºå¤æ‚ï¼‰</p></li></ul></li></ul><h2 id="hexo-config-and-themes-use">hexo config and themes use</h2><ul><li>1.åœ¨ä¸‹è½½ç»“æŸåï¼Œå¯ä»¥ç¼–è¾‘ hexo é…ç½®<ul><li>é…ç½®æ–‡ä»¶<code>_config.yml</code></li></ul></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">see @link</span><br><span class="line">https://hexo.io/zh-cn/docs/configuration</span><br></pre></td></tr></table></figure><h2 id="hexo-use">hexo use</h2><ul><li><ol><li>blog ç¼–å†™</li></ol></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo new blog</span><br></pre></td></tr></table></figure><ul><li><ol start="2"><li>blog md æ–‡ä»¶ ä¹¦å†™<br>é‡‡ç”¨ MarkerDown è¯­æ³•</li></ol></li></ul><h2 id="macos-use">macos use</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install hexo</span><br></pre></td></tr></table></figure><h2 id="markerdown-upload-server">markerdown upload server</h2><ul><li><ol><li>ä½¿ç”¨ä»¥ä¸‹è„šæœ¬æ¨é€åšå®¢æ›´æ–°</li></ol></li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo g -d</span><br></pre></td></tr></table></figure><h2 id="ä½¿ç”¨åšå®¢æ’ä»¶åœ¨-md-ä¸­å¼•å…¥å›¾ç‰‡èµ„æºï¼ˆç½‘ç«™ã€vscode-å‡å¯ç”¨ï¼‰">ä½¿ç”¨åšå®¢æ’ä»¶åœ¨ md ä¸­å¼•å…¥å›¾ç‰‡èµ„æºï¼ˆç½‘ç«™ã€vscode å‡å¯ç”¨ï¼‰</h2><ul><li>sh è„šæœ¬</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install https://github.com/CodeFalling/hexo-asset-image --save</span><br><span class="line">npm install hexo-generator-search --save</span><br></pre></td></tr></table></figure><ul><li>æ¸²æŸ“åº“å®‰è£…</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">npm un hexo-renderer-marked --save</span><br><span class="line">npm install hexo-renderer-markdown-it</span><br><span class="line">or</span><br><span class="line">cnpm install hexo-renderer-markdown-it-plus</span><br><span class="line">cnpm install --save hexo-renderer-jade hexo-generator-feed hexo-generator-sitemap hexo-browsersync hexo-generator-archive</span><br><span class="line">cnpm install --save hexo-renderer-ejs</span><br><span class="line">cnpm install --save hexo-renderer-pug</span><br><span class="line">cnpm install --save hexo-renderer-haml</span><br><span class="line"></span><br><span class="line"><span class="comment"># Styles</span></span><br><span class="line">cnpm install --save hexo-renderer-less</span><br><span class="line">cnpm install --save hexo-renderer-sass</span><br><span class="line">cnpm install --save hexo-renderer-stylus</span><br><span class="line">cnpm install --global yo</span><br><span class="line">cnpm install --global generator-hexo-theme</span><br></pre></td></tr></table></figure><ul><li>ä¸»é¢˜åº“å®‰è£…</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-theme-next</span><br></pre></td></tr></table></figure><ul><li>æ›´æ¢ç”µè„‘ ä¿®æ”¹keyä¿¡æ¯ï¼ˆgithubï¼‰</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C &quot;youremail@example.com&quot;</span><br><span class="line">https://blog.csdn.net/W_317/article/details/106518894</span><br></pre></td></tr></table></figure><h2 id="See-also">See also</h2><ul><li>[1].<a href="https://hexo.io/zh-cn/docs/setup">https://hexo.io/zh-cn/docs/setup</a></li><li>[2].<a href="https://mp.weixin.qq.com/s/w6m21gLNji3HkJKRMwCQ4g">https://mp.weixin.qq.com/s/w6m21gLNji3HkJKRMwCQ4g</a></li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> blog </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Unity ä¸­ç»•æŸä¸ªç‰©ä½“æ—‹è½¬æ–¹æ³•</title>
      <link href="/2023/02/22/UnityRotation/"/>
      <url>/2023/02/22/UnityRotation/</url>
      
        <content type="html"><![CDATA[<h1>Unity ä¸­ç»•æŸä¸ªç‰©ä½“æ—‹è½¬æ–¹æ³•</h1><h2 id="ç®€ä»‹">ç®€ä»‹</h2><ul><li>æ—‹è½¬ä¸»è¦æ˜¯ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š<ul><li>Transform.Rotate</li><li>Transform.RotateAround</li></ul></li></ul><h2 id="ä½¿ç”¨æ–¹æ³•æè¿°">ä½¿ç”¨æ–¹æ³•æè¿°</h2><h3 id="Transform-Rotate">Transform.Rotate</h3><ul><li><p>æè¿°</p><ul><li><p>ä¸–ç•Œè½´æ—‹è½¬ä½¿ç”¨ Scene çš„åæ ‡ç³»ï¼Œå› æ­¤åœ¨å¼€å§‹æ—‹è½¬ GameObject æ—¶ï¼Œå®ƒçš„ xã€y å’Œ z è½´ä¸ xã€y å’Œ z ä¸–ç•Œè½´å¯¹é½ã€‚æ‰€ä»¥ï¼Œå¦‚æœåœ¨ä¸–ç•Œç©ºé—´ä¸­æ—‹è½¬ä¸€ä¸ªç«‹æ–¹ä½“ï¼Œå®ƒçš„è½´å°±ä¼šä¸ä¸–ç•Œå¯¹é½ã€‚åœ¨ Unity ç¼–è¾‘å™¨çš„ Scene è§†å›¾ä¸­é€‰ä¸­ä¸€ä¸ªç«‹æ–¹ä½“æ—¶ï¼Œå°†æ˜¾ç¤ºå·¦ Gizmos ä¸‹ä»¥åŠæ­£å‘/åå‘æ—‹è½¬è½´çš„æ—‹è½¬ Gizmosã€‚ç§»åŠ¨è¿™äº› Gizmos å°†ä½¿ç«‹æ–¹ä½“ç»•è½´æ—‹è½¬ã€‚å¦‚æœå–æ¶ˆé€‰æ‹©ç„¶åé‡æ–°é€‰æ‹©è¯¥ç«‹æ–¹ä½“ï¼Œè¿™äº›è½´å°†é‡æ–°å¼€å§‹åœ¨ä¸–ç•Œä¸­å¯¹é½ã€‚</p></li><li><p>æœ¬åœ°æ—‹è½¬ä½¿ç”¨ GameObject æœ¬èº«çš„åæ ‡ç³»ã€‚å› æ­¤ï¼Œæ–°å»ºçš„ç«‹æ–¹ä½“å°†ä½¿ç”¨è®¾ç½®ä¸ºé›¶æ—‹è½¬çš„ xã€y å’Œ z è½´ã€‚æ—‹è½¬è¯¥ç«‹æ–¹ä½“å°†æ›´æ–°æ—‹è½¬è½´ã€‚å¦‚æœå–æ¶ˆé€‰æ‹©ç„¶åé‡æ–°é€‰æ‹©è¯¥ç«‹æ–¹ä½“ï¼Œå°†æŒ‰ä¹‹å‰çš„ç›¸åŒæ–¹å‘æ˜¾ç¤ºè¿™äº›è½´ã€‚</p></li></ul></li><li><p>ä¾‹å¦‚</p></li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Rotate</span> (<span class="params">Vector3 eulers, Space relativeTo= Space.Self</span>)</span>;</span><br></pre></td></tr></table></figure><ul><li>ä¾‹å­</li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Transform.Rotate example</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This script creates two different cubes: one red which is rotated using Space.Self; one green which is rotated using Space.World.</span></span><br><span class="line"><span class="comment">// Add it onto any GameObject in a scene and hit play to see it run. The rotation is controlled using xAngle, yAngle and zAngle, modifiable on the inspector.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ExampleScript</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> xAngle, yAngle, zAngle;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> GameObject cube1, cube2;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        cube1 = GameObject.CreatePrimitive(PrimitiveType.Cube);</span><br><span class="line">        cube1.transform.position = <span class="keyword">new</span> Vector3(<span class="number">0.75f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>);</span><br><span class="line">        cube1.transform.Rotate(<span class="number">90.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, Space.Self);</span><br><span class="line">        cube1.GetComponent&lt;Renderer&gt;().material.color = Color.red;</span><br><span class="line">        cube1.name = <span class="string">&quot;Self&quot;</span>;</span><br><span class="line"></span><br><span class="line">        cube2 = GameObject.CreatePrimitive(PrimitiveType.Cube);</span><br><span class="line">        cube2.transform.position = <span class="keyword">new</span> Vector3(<span class="number">-0.75f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>);</span><br><span class="line">        cube2.transform.Rotate(<span class="number">90.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, Space.World);</span><br><span class="line">        cube2.GetComponent&lt;Renderer&gt;().material.color = Color.green;</span><br><span class="line">        cube2.name = <span class="string">&quot;World&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        cube1.transform.Rotate(xAngle, yAngle, zAngle, Space.Self);</span><br><span class="line">        cube2.transform.Rotate(xAngle, yAngle, zAngle, Space.World);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="Transform-RotateAround">Transform.RotateAround</h3><ul><li>æè¿°<ul><li>å°†å˜æ¢å›´ç»•ç©¿è¿‡ä¸–ç•Œåæ ‡ä¸­çš„ point çš„ axis æ—‹è½¬ angle åº¦ã€‚</li></ul></li><li>å‚æ•°<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RotateAround</span> (<span class="params">Vector3 point, Vector3 axis, <span class="built_in">float</span> angle</span>)</span>;</span><br></pre></td></tr></table></figure></li><li>å‚æ•°è¯¦è§£<ul><li>point: ç›®æ ‡åæ ‡ç‚¹</li><li>axis: æ—‹è½¬è½´ï¼Œå¦‚ï¼š<code>new Vector3(1,0,0)</code>ä¸ºç»• x è½´æ—‹è½¬ã€‚</li><li>angle: éœ€æ—‹è½¬è§’åº¦çš„å˜é‡ï¼ˆå¢é‡æˆ–å‡é‡ï¼‰</li></ul></li><li>ä¾‹å­</li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Attach this script to a GameObject to rotate around the target position.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Example</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//Assign a GameObject in the Inspector to rotate around</span></span><br><span class="line">    <span class="keyword">public</span> GameObject target;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Spin the object around the target at 20 degrees/second.</span></span><br><span class="line">        transform.RotateAround(target.transform.position, Vector3.up, <span class="number">20</span> * Time.deltaTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å®é™…åº”ç”¨">å®é™…åº”ç”¨</h3><ul><li>ä»£ç å¦‚ä¸‹ï¼š</li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">region</span> å‚æ•°</span></span><br><span class="line">    <span class="comment">//  ç›¸æœºè°ƒæ•´è§’åº¦å€é€Ÿ</span></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;ç›¸æœºè°ƒæ•´è§’åº¦å€é€Ÿ&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> speed = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// åæ ‡</span></span><br><span class="line">    <span class="keyword">public</span> Vector3 vect;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Header(<span class="string">&quot;éœ€æ—‹è½¬ç›®æ ‡ç‰©ä½“&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Transform target;<span class="comment">//è·å–æ—‹è½¬ç›®æ ‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">float</span> xcream;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">float</span> ycream;</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç»•ç›®æ ‡ç‰©æ—‹è½¬ UI</span></span><br><span class="line">        <span class="comment">// step 1. get target object</span></span><br><span class="line">        <span class="comment">// step 2. get target position</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> è§’åº¦å¢åŠ </span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AngleAdd</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">float</span> x = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">float</span> y = <span class="number">50</span>;</span><br><span class="line">        x += <span class="number">5</span>;</span><br><span class="line">        y += <span class="number">5</span>;</span><br><span class="line">        <span class="built_in">float</span> currentAngle = transform.eulerAngles.x;</span><br><span class="line">        <span class="keyword">if</span> (currentAngle + speed &gt; <span class="number">50</span> &amp;&amp; currentAngle + speed &lt; <span class="number">90</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// limitangle(120);</span></span><br><span class="line">            <span class="comment">// limitangleuandd(50);</span></span><br><span class="line">            Vector3 vector3 = <span class="keyword">new</span> Vector3(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">this</span>.transform.RotateAround(target.position, vector3, speed);</span><br><span class="line">            Debug.Log(<span class="string">&quot;camera controller: angle: &quot;</span> + <span class="keyword">this</span>.transform.eulerAngles);</span><br><span class="line">            <span class="comment">// this.transform.Rotate(0, x * speed, 0, Space.World);</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// currentAngle = 50;</span></span><br><span class="line">            Toast.Show(<span class="string">&quot;å·²ç»å¢å¤§åˆ°æœ€å¤§å€¼ï¼Œè¯·å‡å°è§’åº¦ï¼&quot;</span>, <span class="number">1f</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> è§’åº¦å‡å°‘</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AngleReduce</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">float</span> x = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">float</span> y = <span class="number">90</span>;</span><br><span class="line">        x -= <span class="number">5</span>;</span><br><span class="line">        y -= <span class="number">5</span>;</span><br><span class="line">        <span class="built_in">float</span> currentAngle = transform.eulerAngles.x;</span><br><span class="line">        <span class="keyword">if</span> (currentAngle - speed &gt; <span class="number">50</span> &amp;&amp; currentAngle - speed &lt; <span class="number">90</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// limitangle(120);</span></span><br><span class="line">            <span class="comment">//limitangleuandd(50);</span></span><br><span class="line">            Vector3 vector3 = <span class="keyword">new</span> Vector3(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">this</span>.transform.RotateAround(target.position, vector3, -speed);</span><br><span class="line">            Debug.Log(<span class="string">&quot;camera controller: angle: &quot;</span> + <span class="keyword">this</span>.transform.eulerAngles);</span><br><span class="line">            <span class="comment">// this.transform.Rotate(0, x * speed, 0, Space.World);</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// currentAngle = 50;</span></span><br><span class="line">            Toast.Show(<span class="string">&quot;å·²ç»å‡å°åˆ°æœ€å°å€¼ï¼Œè¯·å¢å¤§è§’åº¦ï¼&quot;</span>, <span class="number">1f</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>ç›®çš„ï¼šé€šè¿‡ä¸Šä¸‹æŒ‰é”®æ§åˆ¶ç›¸æœºæ²¿ x è½´å¯¹ç›®æ ‡ç‰©ä½“è½¬åŠ¨åŒæ—¶é™åˆ¶ x è½´åæ ‡èŒƒå›´ä¸ºï¼ˆ50,90ï¼‰ï¼Œå¯¹å¤§äºç›®æ ‡åæ ‡çš„å€¼äºˆä»¥è¿‡æ»¤å¹¶æç¤ºç”¨æˆ·åå‘æ“ä½œä»¥è¾¾åˆ°ç›®çš„ã€‚</li></ul><h3 id="å‚è€ƒ">å‚è€ƒ</h3><ul><li>[1].<a href="https://docs.unity3d.com/cn/2021.2/ScriptReference/Transform.RotateAround.html">https://docs.unity3d.com/cn/2021.2/ScriptReference/Transform.RotateAround.html</a></li><li>[2].<a href="https://docs.unity3d.com/cn/2021.2/ScriptReference/Transform.Rotate.html">https://docs.unity3d.com/cn/2021.2/ScriptReference/Transform.Rotate.html</a></li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> unity </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äº Unity ä¸åŒæ–¹å¼çš„å¯¼å‡ºä¸è¯¦ç»†ä½¿ç”¨çš„è¯´æ˜(åŸºäº Android å¹³å°)</title>
      <link href="/2023/02/22/unityexport-to-android-md/"/>
      <url>/2023/02/22/unityexport-to-android-md/</url>
      
        <content type="html"><![CDATA[<h1>å…³äº Unity ä¸åŒæ–¹å¼çš„å¯¼å‡ºä¸è¯¦ç»†ä½¿ç”¨çš„è¯´æ˜(åŸºäº Android å¹³å°)</h1><h2 id="å¯¼å‡ºæ–¹å¼-ç¼–è¯‘å™¨é€‰æ‹©">å¯¼å‡ºæ–¹å¼(ç¼–è¯‘å™¨é€‰æ‹©)</h2><ul><li><p>å·²æœ‰æ–¹å¼å¦‚ä¸‹ï¼š</p></li><li><p>1.Mono</p><ul><li>Mono æ˜¯ä¸€ä¸ªç”± Xamarin å…¬å¸æ‰€ä¸»æŒçš„è‡ªç”±å¼€æ”¾æºç é¡¹ç›®ã€‚<br>Mono <a href="http://xn--fhq68al1hea232boqdtuhp3e9zv3kexp4cga58kf87f.net">çš„ç›®æ ‡æ˜¯åœ¨å°½å¯èƒ½å¤šçš„å¹³å°ä¸Šä½¿.net</a> æ ‡å‡†çš„ä¸œè¥¿èƒ½æ­£å¸¸è¿è¡Œçš„ä¸€å¥—å·¥å…·ï¼Œæ ¸å¿ƒåœ¨äº&quot;<a href="http://xn--kpro9ekxi2w4cbmc.net">è·¨å¹³å°åœ°è®©.net</a> ä»£ç èƒ½è¿è¡Œèµ·æ¥&quot;ã€‚<br>Mono ç»„æˆç»„ä»¶ï¼šC# ç¼–è¯‘å™¨ï¼ŒCLI è™šæ‹Ÿæœºï¼Œä»¥åŠæ ¸å¿ƒç±»åˆ«ç¨‹åºåº“ã€‚<br>Mono çš„ç¼–è¯‘å™¨è´Ÿè´£ç”Ÿæˆç¬¦åˆå…¬å…±è¯­è¨€è§„èŒƒçš„æ˜ å°„ä»£ç ï¼Œå³å…¬å…±ä¸­é—´è¯­è¨€ï¼ˆCommon Intermediate Languageï¼ŒCILï¼‰ï¼Œæˆ‘çš„ç†è§£å°±æ˜¯å·¥å‚æ–¹æ³•å®ç°ä¸åŒè§£æã€‚</li></ul></li><li><p>2.IL2CPP</p><ul><li><p>IL çš„å…¨ç§°æ˜¯ Intermediate Languageï¼ŒIL æ˜¯ä¸ CPU æ— å…³çš„æœºå™¨è¯­è¨€ï¼Œèƒ½è®¿é—®å’Œæ“ä½œå¯¹è±¡ç±»å‹ï¼Œå¹¶æä¾›äº†æŒ‡ä»¤æ¥åˆ›å»ºå’Œåˆå§‹åŒ–å¯¹è±¡ã€è°ƒç”¨å¯¹è±¡ä¸Šçš„è™šæ–¹æ³•ä»¥åŠç›´æ¥æ“ä½œæ•°ç»„å…ƒç´ ã€‚ç”šè‡³æä¾›äº†æŠ›å‡ºå’Œæ•æ‰å¼‚å¸¸çš„æŒ‡ä»¤æ¥å®ç°é”™è¯¯å¤„ç†ã€‚å¯å°† IL è§†ä¸ºä¸€ç§é¢å‘å¯¹è±¡çš„åŠå…¶è¯­è¨€ã€‚å¾ˆå¤šæ—¶å€™è¿˜ä¼šçœ‹åˆ° CILï¼ˆ<a href="http://xn--3ds19y5om.Net">ç‰¹æŒ‡åœ¨.Net</a> å¹³å°ä¸‹çš„ IL æ ‡å‡†ï¼‰ã€‚ç¿»è¯‘è¿‡æ¥å°±æ˜¯ä¸­é—´è¯­è¨€ã€‚<br><a href="http://xn--4gq6mm7my2hl5a080bkgcolr64hwyjp18b92e9vp.NET">å®ƒæ˜¯ä¸€ç§å±äºé€šç”¨è¯­è¨€æ¶æ„å’Œ.NET</a> æ¡†æ¶çš„ä½é˜¶çš„äººç±»å¯è¯»çš„ç¼–ç¨‹è¯­è¨€ã€‚<br>CIL ç±»ä¼¼ä¸€ä¸ªé¢å‘å¯¹è±¡çš„æ±‡ç¼–è¯­è¨€ï¼Œå¹¶ä¸”å®ƒæ˜¯å®Œå…¨åŸºäºå †æ ˆçš„ï¼Œå®ƒè¿è¡Œåœ¨è™šæ‹Ÿæœºä¸Šï¼ˆ.Net Framework, Mono VMï¼‰çš„è¯­è¨€ã€‚</p><ul><li><p>IL2CPP åˆ†ä¸ºä¸¤ä¸ªç‹¬ç«‹çš„éƒ¨åˆ†ï¼š</p></li><li><ol><li>AOTï¼ˆé™æ€ç¼–è¯‘ï¼‰ç¼–è¯‘å™¨ï¼šæŠŠ IL ä¸­é—´è¯­è¨€è½¬æ¢æˆ CPP æ–‡ä»¶</li></ol></li><li><ol start="2"><li>è¿è¡Œæ—¶åº“ï¼šä¾‹å¦‚åƒåœ¾å›æ”¶ã€çº¿ç¨‹/æ–‡ä»¶è·å–ï¼ˆç‹¬ç«‹äºå¹³å°ï¼Œä¸å¹³å°æ— å…³ï¼‰ã€å†…éƒ¨è°ƒç”¨ç›´æ¥ä¿®æ”¹æ‰˜ç®¡æ•°æ®ç»“æ„çš„åŸç”Ÿä»£ç çš„æœåŠ¡ä¸æŠ½è±¡</li></ol></li></ul></li></ul></li><li><p>Unity è·¨å¹³å°åŸç†</p><ul><li><p>Mono è¿è¡Œæ—¶ç¼–è¯‘å™¨æ”¯æŒå°† IL ä»£ç è½¬ä¸ºå¯¹åº”å¹³å°åŸç”Ÿç ã€‚</p></li><li><p>IL å¯ä»¥åœ¨ä»»ä½•æ”¯æŒ CLIï¼ˆé€šç”¨è¯­è¨€ç¯å¢ƒç»“æ„ï¼‰ä¸­è¿è¡Œï¼ŒIL çš„è¿è¡Œæ˜¯ä¾æ‰˜äº Mono è¿è¡Œæ—¶ã€‚</p></li></ul></li><li><p>æ€»ç»“<br>IL2CPP æ¯”è¾ƒé€‚åˆå¼€å‘å’Œå‘å¸ƒé¡¹ç›® ï¼Œä½†æ˜¯ä¸ºäº†æé«˜ç‰ˆæœ¬è¿­ä»£é€Ÿåº¦ï¼Œå¯ä»¥åœ¨å¼€å‘æœŸé—´åˆ‡æ¢åˆ° Mono æ¨¡å¼ï¼ˆæ„å»ºåº”ç”¨å¿«ï¼‰ã€‚</p></li><li><p>å¦‚å›¾ï¼š<br><img src="/2023/02/22/unityexport-to-android-md/publish.png" class="lazyload placeholder" data-srcset="/2023/02/22/unityexport-to-android-md/publish.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p></li><li><p>åœ¨é€‰æ‹©ç¼–è¯‘æ–¹å¼åï¼Œå¯é€‰æ‹©ç¼–è¯‘å¹³å°æ¶æ„ï¼ˆarmv7ã€arm64ï¼‰ä»¥åŠ C#ç¼–è¯‘ API åº“ç‰ˆæœ¬ï¼ˆ.netï¼‰</p></li></ul><h2 id="æ¨èå¼€å‘å·¥å…·ç‰ˆæœ¬">æ¨èå¼€å‘å·¥å…·ç‰ˆæœ¬</h2><ul><li>Android Studio Bumblebee (2021.3.1) or later</li><li>Unity version 2021.3.4a18 or later</li><li>Visual Studio Code 1.75.1 (Code)</li></ul><h2 id="å¯¼å‡ºæ­¥éª¤">å¯¼å‡ºæ­¥éª¤</h2><h3 id="åŸºç¡€é…ç½®">åŸºç¡€é…ç½®</h3><ul><li><ol><li>é¢„é…ç½®</li></ol><ul><li><ol><li>å¡«å…… unity file èœå• project settings ä¸­ company nameã€package name åç§°</li></ol></li><li><ol start="2"><li>è®¾ç½®å¯¼å‡ºè·¯å¾„ï¼Œå‹¾é€‰å¯¼å‡ºæ–‡ä»¶</li></ol></li><li><ol start="3"><li>å¤åˆ¶ Unitylibrary ç›®å½•è‡³ Android Studio å·¥ç¨‹</li></ol></li><li><ol start="4"><li>æ›´æ”¹<code>build.gradle</code>æ–‡ä»¶ç­‰</li></ol></li><li><ol start="5"><li>å¯åŠ¨ Android ç¨‹åºï¼Œè·³è½¬è‡³é€‰å›¾åç•Œé¢</li></ol></li><li><ol start="6"><li>å¯åŠ¨ unityï¼Œé¢„è§ˆç¨‹åº</li></ol></li></ul></li><li><ol start="2"><li>å¯¼å‡º</li></ol><ul><li><ol><li>export(File-&gt;Build Settings) é¡µé¢é…ç½®ï¼Œå¦‚å›¾:<br><img src="/2023/02/22/unityexport-to-android-md/player.png" class="lazyload placeholder" data-srcset="/2023/02/22/unityexport-to-android-md/player.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></li></ol></li><li><ol start="2"><li>åœ¨ player settings ä¸­è®¾ç½®å¦‚ä¸‹é¡¹ç›®ï¼Œå¦‚å›¾ï¼šï¼ˆé€‰ä¸­ Android é¡¹ç›®ï¼‰<br><img src="/2023/02/22/unityexport-to-android-md/hidebar.png" class="lazyload placeholder" data-srcset="/2023/02/22/unityexport-to-android-md/hidebar.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></li></ol></li><li><ol start="3"><li>è®¾ç½®å‘å¸ƒé…ç½®ï¼Œå¦‚å›¾ï¼š<br><img src="/2023/02/22/unityexport-to-android-md/publish.png" class="lazyload placeholder" data-srcset="/2023/02/22/unityexport-to-android-md/publish.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></li></ol></li><li><ol start="4"><li>è®¾ç½®å¯åŠ¨é¡µé¢<br><img src="/2023/02/22/unityexport-to-android-md/splash.png" class="lazyload placeholder" data-srcset="/2023/02/22/unityexport-to-android-md/splash.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></li></ol></li><li><ol start="5"><li>æœ€ç»ˆï¼Œåœ¨ Build Settings é¡µé¢ä¸­ç‚¹å‡» export å¯¼å‡º,å¦‚å›¾ï¼š<br><img src="/2023/02/22/unityexport-to-android-md/player.png" class="lazyload placeholder" data-srcset="/2023/02/22/unityexport-to-android-md/player.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></li></ol></li></ul></li><li><ol start="3"><li>å¯¼å‡ºå‰æ€§èƒ½ä¼˜åŒ–</li></ol><ul><li>ç‰©ç†æ¨¡å—ä¼˜åŒ–<ul><li>1.å¦‚æœé¡¹ç›®ä½¿ç”¨ Unity 2017 ä»¥ä¸Šç‰ˆæœ¬ï¼Œä¸”å®é™…æ²¡æœ‰ä½¿ç”¨ç‰©ç†æ¨¡å—ï¼Œå¯ä»¥å°† Project Settings ä¸­ Physics çš„ Auto Simulation å’Œ Auto Sync Transforms é€‰é¡¹å…³é—­ï¼ˆå¦‚å›¾ï¼‰<br><img src="/2023/02/22/unityexport-to-android-md/exp-physical.png" class="lazyload placeholder" data-srcset="/2023/02/22/unityexport-to-android-md/exp-physical.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></li></ul></li></ul></li></ul><h2 id="å¯¼å‡ºæ€§èƒ½åˆ†æ">å¯¼å‡ºæ€§èƒ½åˆ†æ</h2><h3 id="åœ¨-Android-Studio-Profiler-æ€§èƒ½åˆ†æä¸­ï¼ŒUnity-å ç”¨å†…å­˜çš„åˆ¤æ–­">åœ¨ Android Studio Profiler æ€§èƒ½åˆ†æä¸­ï¼ŒUnity å ç”¨å†…å­˜çš„åˆ¤æ–­</h3><ul><li>å¦‚å›¾ï¼Œnative å†…å­˜å³ä¸º Unity å ç”¨å†…å­˜<br><img src="/2023/02/22/unityexport-to-android-md/unity_memory.png" class="lazyload placeholder" data-srcset="/2023/02/22/unityexport-to-android-md/unity_memory.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></li></ul><h2 id="Android-Studio-å¼•å…¥-Unity-å¯¼å‡ºåº“é…ç½®ï¼ˆä»¥å®˜æ–¹æ¡ˆä¾‹ä¸ºå‚è€ƒï¼‰">Android Studio å¼•å…¥ Unity å¯¼å‡ºåº“é…ç½®ï¼ˆä»¥å®˜æ–¹æ¡ˆä¾‹ä¸ºå‚è€ƒï¼‰</h2><ul><li><p>åœ¨ Unity ç¼–è¾‘å™¨ä¸­æ‰“å¼€ UnityProject</p></li><li><p>è¿›å…¥æ„å»ºè®¾ç½®çª—å£(èœå•/æ–‡ä»¶/æ„å»ºè®¾ç½®)</p></li><li><p>é€‰æ‹©å¹¶åˆ‡æ¢åˆ° Android å¹³å°</p></li><li><p>è¿›å…¥æ’­æ”¾å™¨è®¾ç½®çª—å£(ç‚¹å‡»æ„å»ºè®¾ç½®å·¦ä¸‹è§’çš„æ’­æ”¾å™¨è®¾ç½®æŒ‰é’®ï¼Œæˆ–è€…ä½¿ç”¨ç¼–è¾‘/é¡¹ç›®è®¾ç½®èœå•ï¼Œé€‰æ‹©å·¦è¾¹çš„æ’­æ”¾å™¨é€‰é¡¹å¡)</p></li><li><p>åœ¨&quot;å…¶ä»–è®¾ç½®&quot;â€”)é…ç½®&quot;ä¸­é€‰æ‹©ç›®æ ‡æ¶æ„<br><img src="/2023/02/22/unityexport-to-android-md/selectArchitectures.png" class="lazyload placeholder" data-srcset="/2023/02/22/unityexport-to-android-md/selectArchitectures.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li>è¿”å›&quot;æ„å»ºè®¾ç½®&quot;çª—å£ -é€‰æ‹©&quot;å¯¼å‡ºé¡¹ç›®&quot;é€‰é¡¹<br>![img](unityexport-to-android-md/exportProject.png&quot; width=â€˜400pxâ€™&gt;<br>å¯¼å‡º UnityProject åˆ° androidBuild æ–‡ä»¶å¤¹ï¼Œæ–‡ä»¶å¤¹ç»“æ„å¦‚ä¸‹æ‰€ç¤º<br><img src="/2023/02/22/unityexport-to-android-md/exportedProjectFolder.png" class="lazyload placeholder" data-srcset="/2023/02/22/unityexport-to-android-md/exportedProjectFolder.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></li></ul></li><li><p>3.æ·»åŠ  Unity åº“æ¨¡å—åˆ° NativeAndroidApp**</p></li><li><p>åœ¨ Android Studio ä¸­å°†å¯¼å‡ºçš„ androidBuild/unityLibrary æ¨¡å—æ·»åŠ åˆ° NativeAndroidApp Gradle é¡¹ç›®ä¸­:</p></li></ul><p>åœ¨ Android Studio ä¸­æ‰“å¼€ NativeAndroidApp</p><ul><li><p>æ‰“å¼€è®¾ç½®.gradle æ–‡ä»¶</p></li><li><p>åœ¨ä¸» app æ¨¡å—ä¹‹åæ·»åŠ ä¸€ä¸ªæŒ‡å‘ unityLibrary æ¨¡å—çš„æ–°é¡¹ç›®</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">include &#x27;:unityLibrary&#x27;</span><br><span class="line">project(&#x27;:unityLibrary&#x27;).projectDir=new File(&#x27;..\\UnityProject\\androidBuild\\unityLibrary&#x27;)</span><br></pre></td></tr></table></figure><ul><li>åœ¨&quot;dependencyresoltionmanagement {repositories{block&quot;ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flatDir &#123;</span><br><span class="line">  dirs &quot;$&#123;project(&#x27;:unityLibrary&#x27;).projectDir&#125;/libs&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/02/22/unityexport-to-android-md/settingsGradle.png" class="lazyload placeholder" data-srcset="/2023/02/22/unityexport-to-android-md/settingsGradle.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li><p>å¼€æ”¾æ„å»º.gradle(æ¨¡å—:NativeAndroidApp.app)æ–‡ä»¶</p></li><li><p>åœ¨ dependencies{block ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">implementation project(&#x27;:unityLibrary&#x27;)</span><br><span class="line">implementation fileTree(dir: project(&#x27;:unityLibrary&#x27;).getProjectDir().toString() + (&#x27;\\libs&#x27;), include: [&#x27;*.jar&#x27;])</span><br></pre></td></tr></table></figure><p><img src="/2023/02/22/unityexport-to-android-md/buildGradleApp.png" class="lazyload placeholder" data-srcset="/2023/02/22/unityexport-to-android-md/buildGradleApp.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li>åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œçœ‹çœ‹ android{defaultConfig{ndk{å—ï¼Œå¹¶ç¡®ä¿ abiFilters åŒ¹é…ä½ åœ¨ Unity ç¼–è¾‘å™¨ä¸­é€‰æ‹©çš„æ¶æ„ï¼Œç„¶åå†å¯¼å‡ºé¡¹ç›®ã€‚è¿‡æ»¤å™¨å¿…é¡»ä¸ Unity ç¼–è¾‘å™¨ä¸­çš„æ¶æ„å®Œå…¨åŒ¹é…ã€‚å¦‚æœ Unity åªå¯¼å‡º ARMv7 æ¶æ„ï¼Œä½†è¿‡æ»¤å™¨åŒ…å« ARM64 -v8aï¼Œåº”ç”¨ç¨‹åºå°†åœ¨ ARM64 è®¾å¤‡ä¸Šå´©æºƒã€‚åœ¨<a href="https://developer.android.com/ndk/guides/abis#sa">android å®˜æ–¹æ–‡æ¡£</a>ä¸­æ£€æŸ¥æœ‰æ•ˆçš„ abiFilters å€¼ã€‚<br><img src="/2023/02/22/unityexport-to-android-md/buildGradleAppAbiFilters.png" class="lazyload placeholder" data-srcset="/2023/02/22/unityexport-to-android-md/buildGradleAppAbiFilters.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"><ul><li>å¤åˆ¶ gradle çš„å†…å®¹ã€‚å±æ€§æ–‡ä»¶ä»å¯¼å‡ºçš„ Unity é¡¹ç›®æ ¹æ–‡ä»¶å¤¹åˆ° gradleã€‚å±æ€§æ–‡ä»¶åœ¨æœ¬æœºåº”ç”¨ç¨‹åºæ ¹æ–‡ä»¶å¤¹ä¸­ã€‚æ³¨æ„:å¦‚æœä½ æ›´æ–° Unity é¡¹ç›®å¹¶å†æ¬¡é‡æ–°å¯¼å‡ºå®ƒï¼Œè¯·ç¡®ä¿ gradle çš„å†…å®¹ã€‚å¯¼å‡ºé¡¹ç›®ä¸­çš„å±æ€§æ–‡ä»¶æ²¡æœ‰æ›´æ”¹ã€‚å¦‚æœæœ‰ï¼Œé‡å¤è¿™ä¸€æ­¥ã€‚<br><img src="/2023/02/22/unityexport-to-android-md/exportedASProject.png" class="lazyload placeholder" data-srcset="/2023/02/22/unityexport-to-android-md/exportedASProject.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"><br><img src="/2023/02/22/unityexport-to-android-md/gradlePropertiesApp.png" class="lazyload placeholder" data-srcset="/2023/02/22/unityexport-to-android-md/gradlePropertiesApp.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"><ul><li>ç‚¹å‡» Sync Now è¿›è¡Œé¡¹ç›®åŒæ­¥ï¼Œå› ä¸º Gradle æ–‡ä»¶å·²ç»è¢«ä¿®æ”¹äº†<br><img src="/2023/02/22/unityexport-to-android-md/syncGradle.png" class="lazyload placeholder" data-srcset="/2023/02/22/unityexport-to-android-md/syncGradle.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></li></ul></li></ul></li><li>å¦‚æœä¸€åˆ‡æˆåŠŸï¼Œä½ åº”è¯¥çœ‹åˆ° unityLibrary æ¨¡å—æ·»åŠ åˆ° Android è§†å›¾<br><img src="/2023/02/22/unityexport-to-android-md/unityLibraryModule.png" class="lazyload placeholder" data-srcset="/2023/02/22/unityexport-to-android-md/unityLibraryModule.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></li></ul><h3 id="é¡¹ç›®å‡†å¤‡å°±ç»ª">é¡¹ç›®å‡†å¤‡å°±ç»ª</h3><p>ä¸€åˆ‡å°±ç»ªï¼Œå¯ä»¥æ„å»ºã€è¿è¡Œå’Œè°ƒè¯•:<br><img src="/2023/02/22/unityexport-to-android-md/buildOnDevice.png" class="lazyload placeholder" data-srcset="/2023/02/22/unityexport-to-android-md/buildOnDevice.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"><br>å¦‚æœä¸€åˆ‡æˆåŠŸï¼Œåœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œä½ åº”è¯¥èƒ½å¤Ÿè¿è¡Œ NativeAndroidApp:</p><table><thead><tr><th>Main Activity</th><th>Unity Activity</th></tr></thead><tbody><tr><td><img src="/2023/02/22/unityexport-to-android-md/appNativeSS.png" class="lazyload placeholder" data-srcset="/2023/02/22/unityexport-to-android-md/appNativeSS.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></td><td><img src="/2023/02/22/unityexport-to-android-md/appUnitySS.png" class="lazyload placeholder" data-srcset="/2023/02/22/unityexport-to-android-md/appUnitySS.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></td></tr><tr><td>Main Activity</td><td>Unity è¢«åŠ è½½å¹¶è¿è¡Œåœ¨ä¸€ä¸ªå•ç‹¬çš„ Activity ä¸­ã€‚ä¸­é—´çš„æµ…ç°è‰²æŒ‰é’®æ˜¯ä» MainUnityActivity ä¸­æ·»åŠ çš„ï¼Œåœ¨ NativeAndroidApp ä¸­å®ç°</td></tr></tbody></table><h2 id="æ³¨æ„">æ³¨æ„</h2><ul><li>Unity è¿è¡Œåœ¨å¦ä¸€ä¸ªè¿›ç¨‹ android:process=â€œ:Unityâ€ (AndroidManifest.xml åœ¨åº”ç”¨æ¨¡å—)<br>å®‰è£…å®Œæˆåï¼Œè®¾å¤‡ä¸Šä¼šå¢åŠ ä¸¤ä¸ªå›¾æ ‡ã€‚è¦åªç•™ä¸‹ä¸»æ´»åŠ¨çš„å›¾æ ‡ï¼Œåˆ é™¤<intent-filter>â€¦</intent-filter> from AndroidManifest.xml åœ¨ unityLibrary</li><li>(å¯é€‰)æˆ‘ä»¬æ‰¾åˆ°äº†ä¸€äº› Android 7ã€‚*è®¾å¤‡å°†æ´»åŠ¨çš„ frontOfTask è®¾ç½®ä¸ºé”™è¯¯çŠ¶æ€ï¼Œå¯¼è‡´å½“å®Œæˆ/é€€å‡º Unity æ´»åŠ¨æ—¶ï¼Œæ•´ä¸ªä»»åŠ¡å°†è¿›å…¥åå°ï¼Œè€Œä¸æ˜¯å¸¦å›ä¸»æ´»åŠ¨ã€‚ä¸‹ä¸€ä¸ªè§£å†³æ–¹æ¡ˆä¿æŒé¢„æœŸçš„è¡Œä¸º:æ·»åŠ åˆ° MainUnityActivity.java ä» NativeAndroidApp<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUnityPlayerQuitted</span>()</span> &#123;</span><br><span class="line">    showMainActivity(<span class="string">&quot;&quot;</span>); finish();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> unity </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äº Unity ä¸­è§¦æ‘¸å±å¹•åæ ‡ä¸ç‰©ä½“ä¸–ç•Œåæ ‡çš„åˆ¤å®šæ–¹æ³•(ä»¥çŸ©å½¢ä¸ºä¾‹)</title>
      <link href="/2023/02/22/android-unity-touch-md/"/>
      <url>/2023/02/22/android-unity-touch-md/</url>
      
        <content type="html"><![CDATA[<h1>å…³äº Unity ä¸­è§¦æ‘¸å±å¹•åæ ‡ä¸ç‰©ä½“ä¸–ç•Œåæ ‡çš„åˆ¤å®šæ–¹æ³•(ä»¥çŸ©å½¢ä¸ºä¾‹)</h1><h2 id="å¤„ç†æ€è·¯">å¤„ç†æ€è·¯</h2><ul><li>1.è·å–ç”¨æˆ·è§¦æ‘¸çš„å±å¹•åæ ‡(touch_vector3)</li><li>2.è½¬æ¢å±å¹•åæ ‡ä¸ºä¸–ç•Œåæ ‡(Camera.main.ScreenToWorldPoint(touch_vector3))</li><li>3.æ ¹æ®å¯¹åº”ç®—æ³•æ¯”è¾ƒè§¦æ‘¸ç‚¹ä¸ç›®æ ‡ç‚¹å·®å€¼</li><li>4.å·®å€¼åœ¨é¢„æœŸå†…ï¼Œåˆ¤å®šä¸ºç”¨æˆ·é€‰ä¸­ï¼›å¦åˆ™ï¼Œæœªé€‰ä¸­</li></ul><h2 id="ç®—æ³•é€‰æ‹©">ç®—æ³•é€‰æ‹©</h2><h3 id="äº¤ç‚¹-å°„çº¿-æ³•">äº¤ç‚¹(å°„çº¿)æ³•</h3><ul><li><p>1.åŸºæœ¬æ€è·¯ï¼š</p></li><li><p>ä»ä»»æ„ä½ç½®ç”»ä¸€æ¡åˆ°ç›®æ ‡ç‚¹çš„æ°´å¹³çº¿ï¼Œè®¡ç®—è¯¥æ°´å¹³çº¿è¿›å‡ºå¹³é¢è¾¹ç•Œçš„æ¬¡æ•°ï¼Œå¦‚æœæ˜¯å¶æ•°ï¼Œåˆ™ç‚¹åœ¨å¹³é¢å¤–ï¼›å¦‚æœæ˜¯å¥‡æ•°ï¼Œåˆ™ç‚¹åœ¨å¹³é¢å†…ã€‚ç‚¹æ­£å¥½è½åœ¨å®šç‚¹æˆ–è¾¹ç•Œæ—¶ä¼šå‡ºç°ç‰¹æ®Šçš„åˆ¤æ–­ã€‚</p></li><li><p>å¦‚å›¾ï¼š<br><img src="/2023/02/22/android-unity-touch-md/point.png" class="lazyload placeholder" data-srcset="/2023/02/22/android-unity-touch-md/point.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p></li><li><p>2.ä»£ç å®ç°</p></li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> åˆ¤æ–­ç‚¹æ˜¯å¦åœ¨çŸ©å½¢æ¡†å†…- app</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;APoints&quot;&gt;</span>åº“ä½ç‚¹é›†åˆ<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;pointBottomCenter&quot;&gt;</span>ç›®æ ‡ç‚¹<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">isPolygonContainsPoint</span>(<span class="params">List&lt;Vector3&gt; APoints, Vector3 pointBottomCenter</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="built_in">int</span> nCross = <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; APoints.Count; i++)</span><br><span class="line">       &#123;</span><br><span class="line">           Vector3 p1 = APoints[i];</span><br><span class="line">           Vector3 p2 = APoints[(i + <span class="number">1</span>) % APoints.Count];</span><br><span class="line">           <span class="comment">// å–å¤šè¾¹å½¢ä»»æ„ä¸€ä¸ªè¾¹,åšç‚¹pointçš„æ°´å¹³å»¶é•¿çº¿,æ±‚è§£ä¸å½“å‰è¾¹çš„äº¤ç‚¹ä¸ªæ•°</span></span><br><span class="line">           <span class="comment">// p1p2æ˜¯æ°´å¹³çº¿æ®µ,è¦ä¹ˆæ²¡æœ‰äº¤ç‚¹,è¦ä¹ˆæœ‰æ— é™ä¸ªäº¤ç‚¹</span></span><br><span class="line">           <span class="keyword">if</span> (p1.y == p2.y)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="built_in">double</span> minX = Math.Min(p1.x, p2.x);</span><br><span class="line">               <span class="built_in">double</span> maxX = Math.Max(p1.x, p2.x);</span><br><span class="line">               <span class="comment">// pointåœ¨æ°´å¹³çº¿æ®µp1p2ä¸Š,ç›´æ¥return true</span></span><br><span class="line">               <span class="keyword">if</span> ((pointBottomCenter.z == p1.z) &amp;&amp; (pointBottomCenter.x &gt;= minX &amp;&amp; pointBottomCenter.x &lt;= maxX))</span><br><span class="line">               &#123;</span><br><span class="line">                   <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// point åœ¨p1p2 åº•éƒ¨ --&gt; æ— äº¤ç‚¹</span></span><br><span class="line">           <span class="keyword">if</span> (pointBottomCenter.z &lt; Math.Min(p1.z, p2.z))</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           <span class="comment">// point åœ¨p1p2 é¡¶éƒ¨ --&gt; æ— äº¤ç‚¹</span></span><br><span class="line">           <span class="keyword">if</span> (pointBottomCenter.z &gt;= Math.Max(p1.z, p2.z))</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           <span class="comment">// æ±‚è§£ pointç‚¹æ°´å¹³çº¿ä¸å½“å‰p1p2è¾¹çš„äº¤ç‚¹çš„ X åæ ‡</span></span><br><span class="line">           <span class="built_in">double</span> x = (pointBottomCenter.z - p1.z) * (p2.x - p1.x) / (p2.z - p1.z) + p1.x;</span><br><span class="line">           <span class="keyword">if</span> (x &gt; pointBottomCenter.x) <span class="comment">// å½“x=point.xæ—¶,è¯´æ˜pointåœ¨p1p2çº¿æ®µä¸Š</span></span><br><span class="line">               nCross++; <span class="comment">// åªç»Ÿè®¡å•è¾¹äº¤ç‚¹</span></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// å•è¾¹äº¤ç‚¹ä¸ºå¶æ•°ï¼Œç‚¹åœ¨å¤šè¾¹å½¢ä¹‹å¤– ---</span></span><br><span class="line">       <span class="keyword">return</span> (nCross % <span class="number">2</span> == <span class="number">1</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="é¢ç§¯æ³•">é¢ç§¯æ³•</h3><ul><li>1.åŸºæœ¬æ€è·¯</li><li>é€šè¿‡å°†çŸ©å½¢åˆ‡å‰²ä¸ºå¤šä¸ªä¸‰è§’å½¢è®¡ç®—é¢ç§¯ï¼Œä¸åŸé¢ç§¯æ¯”è¾ƒå·®å€¼ï¼›è‹¥å¤§äº 0 åˆ™ä¸åœ¨ï¼Œå¦åˆ™åœ¨ã€‚</li><li>æ‰€æœ‰è¾¹å’Œç›®æ ‡ç‚¹ç»„æˆçš„ä¸‰è§’å½¢é¢ç§¯å’Œæ˜¯å¦ç­‰äºæ€»çš„å¤šè¾¹å½¢é¢ç§¯ï¼Œå¦‚æœç›¸ç­‰ï¼Œåˆ™åœ¨å†…éƒ¨ã€‚åä¹‹åœ¨å¤–éƒ¨ã€‚</li><li>2.ä»£ç å®ç°</li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> è®¡ç®—è·ç¦»</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p1&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p2&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">   <span class="function"><span class="keyword">static</span> <span class="built_in">double</span> <span class="title">dis</span>(<span class="params">Vector3 p1, Vector3 p2</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">return</span> Math.Sqrt((p1.x - p2.x) * (p1.x - p2.x) + (p1.z - p2.z) * (p1.z - p2.z));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> è®¡ç®—ä¸‰è§’å½¢é¢ç§¯</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p1&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p2&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p3&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">double</span> <span class="title">triangleArea</span>(<span class="params">Vector3 p1, Vector3 p2, Vector3 p3</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line"></span><br><span class="line">       <span class="built_in">double</span> a = dis(p1, p2);</span><br><span class="line">       <span class="built_in">double</span> b = dis(p2, p3);</span><br><span class="line">       <span class="built_in">double</span> c = dis(p3, p1);</span><br><span class="line">       <span class="built_in">double</span> p = (a + b + c) * <span class="number">0.5</span>;</span><br><span class="line">       <span class="keyword">return</span> Math.Sqrt(p * (p - a) * (p - b) * (p - c));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> åˆ¤æ–­æŸç‚¹æ˜¯å¦è½åœ¨çŸ©å½¢å†…</span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;a&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;b&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;c&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;d&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p&quot;&gt;</span>ç›®æ ‡ç‚¹<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">   <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">pInQuadrangle</span>(<span class="params">Vector3 a, Vector3 b, Vector3 c, Vector3 d, Vector3 p</span>)</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="built_in">double</span> dTriangle = triangleArea(a, b, p) + triangleArea(b, c, p) + triangleArea(c, d, p) + triangleArea(d, a, p);</span><br><span class="line">       <span class="built_in">double</span> dQuadrangle = triangleArea(a, b, c) + triangleArea(c, d, a);<span class="comment">// s5 + s6;</span></span><br><span class="line">       <span class="keyword">if</span> (Math.Abs(dTriangle - dQuadrangle) &lt; <span class="number">0.25f</span>)    <span class="comment">//è¯´æ˜ç†è®ºä¸Šåº”è¯¥æ˜¯ç›¸ç­‰çš„ï¼Œä½†å› ä¸ºè®¡ç®—æœ¬èº«çš„åŸå› å¯èƒ½ä¼šæœ‰ç»†å¾®ä¸åŒï¼Œæ‰€ä»¥é€‰æ‹©å°äº1ï¼Œæ ¹æ®å®é™…æƒ…å†µæ¥è®¾ç½®</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">else</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> unity </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android ä½œä¸ºæœåŠ¡å™¨å‘ UNITY å®¢æˆ·ç«¯å‘é€æ•°æ®</title>
      <link href="/2023/02/22/AndroidSocketToUnity/"/>
      <url>/2023/02/22/AndroidSocketToUnity/</url>
      
        <content type="html"><![CDATA[<h1>Android ä½œä¸ºæœåŠ¡å™¨å‘ UNITY å®¢æˆ·ç«¯å‘é€æ•°æ®</h1><h2 id="ç®€ä»‹">ç®€ä»‹</h2><ul><li><p>åˆ†å±‚å¯¹åº”åè®®</p><ul><li><p>åº”ç”¨å±‚ï¼šTFTPï¼ŒHTTPï¼ŒSNMPï¼ŒFTPï¼ŒSMTPï¼ŒDNSï¼ŒTelnet ç­‰ç­‰</p></li><li><p>ä¼ è¾“å±‚ï¼šTCPï¼ŒUDP</p></li><li><p>ç½‘ç»œå±‚ï¼šIPï¼ŒICMPï¼ŒOSPFï¼ŒEIGRPï¼ŒIGMP</p></li><li><p>æ•°æ®é“¾è·¯å±‚ï¼šSLIPï¼ŒCSLIPï¼ŒPPPï¼ŒMTU</p></li></ul></li><li><p>é€šä¿¡ç»“æ„ï¼Œå¦‚å›¾<br><img src="https://pic3.zhimg.com/80/v2-6da4cb5ef8a02ea7eeca8fb132bd0776_720w.webp" class="lazyload placeholder" data-srcset="https://pic3.zhimg.com/80/v2-6da4cb5ef8a02ea7eeca8fb132bd0776_720w.webp" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="alt å¦‚å›¾" title="é€šä¿¡è¿‡ç¨‹"></p></li><li><p>socket ä½ç½®ï¼Œå¦‚å›¾<br><img src="https://pic4.zhimg.com/80/v2-57afdc329c984ad909d911bcddd6d0c7_720w.webp" class="lazyload placeholder" data-srcset="https://pic4.zhimg.com/80/v2-57afdc329c984ad909d911bcddd6d0c7_720w.webp" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="alt img" title="socket"></p></li><li><p>ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼Œå¦‚å›¾<br><img src="https://pic2.zhimg.com/80/v2-7e535f4306b205d0aae90e102c56bf9d_720w.webp" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-7e535f4306b205d0aae90e102c56bf9d_720w.webp" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="alt img" title="æ¡æ‰‹è¿‡ç¨‹"></p></li><li><p>å…·ä½“åˆ° socket å¦‚ä¸‹<br><img src="https://pic4.zhimg.com/80/v2-0166c6374f2a842f64fd566599a13d67_720w.webp" class="lazyload placeholder" data-srcset="https://pic4.zhimg.com/80/v2-0166c6374f2a842f64fd566599a13d67_720w.webp" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="alt img" title="socketé“¾æ¥"></p></li><li><p>Android ä½¿ç”¨ Socket ä¸ UNITY å®¢æˆ·ç«¯é€šä¿¡</p></li><li><p>ä¸¤ç«¯å®šä¹‰ç›¸åŒåè®®è¿›è¡Œæ•°æ®çš„äº¤äº’</p></li><li><p>åœ¨æ•°æ®å‘é€å‰ä½¿ç”¨ç›¸åº”è½¬æ¢æ–¹å¼è¿›è¡Œè½¬æ¢</p></li></ul><h2 id="å®ç°æ–¹å¼">å®ç°æ–¹å¼</h2><h3 id="Android-æœåŠ¡ç«¯">Android æœåŠ¡ç«¯</h3><ul><li><ol><li>å»ºç«‹ Android æœåŠ¡å™¨ç«¯ serversocket æœåŠ¡</li></ol></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">          server = <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(port);</span><br><span class="line">          System.out.println(<span class="string">&quot;å¯åŠ¨serverï¼Œç«¯å£å·ï¼š&quot;</span> + port);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure><ul><li><ol start="2"><li>åœ¨åˆ›å»º serversocket åï¼Œåœ¨éœ€è¦çš„åœ°æ–¹è°ƒç”¨æ–¹æ³•å¹¶å¼€å¯ socket æœåŠ¡</li></ol></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯åŠ¨server</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> ServerThread <span class="title function_">startServer</span><span class="params">()</span> &#123;</span><br><span class="line">       System.out.println(<span class="string">&quot;å¼€å¯server&quot;</span>);</span><br><span class="line">       <span class="keyword">if</span> (serverThread != <span class="literal">null</span>) &#123;</span><br><span class="line">           System.out.println(<span class="string">&quot;serverä¸ä¸ºnullæ­£åœ¨é‡å¯server&quot;</span>);</span><br><span class="line">           <span class="comment">// ä»¥ä¸‹ä¸ºå…³é—­serverå’Œsocket</span></span><br><span class="line">           shutDown();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line">       serverThread = <span class="keyword">new</span> <span class="title class_">ServerThread</span>();</span><br><span class="line">       <span class="keyword">new</span> <span class="title class_">Thread</span>(serverThread).start();</span><br><span class="line">       System.out.println(<span class="string">&quot;å¼€å¯serveræˆåŠŸ&quot;</span>);</span><br><span class="line">       <span class="keyword">return</span> serverThread;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li><ol start="3"><li>æ–°å»ºçº¿ç¨‹ï¼Œç­‰å¾…å®¢æˆ·ç«¯é“¾æ¥,åœ¨å®¢æˆ·ç«¯è¿æ¥åå‘é€å›åº”æ¶ˆæ¯</li></ol></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">   <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (!isExit) &#123;</span><br><span class="line">                    <span class="comment">// ç­‰å¾…è¿æ¥</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;ç­‰å¾…æ‰‹æœºçš„è¿æ¥ä¸­... ...&quot;</span>);</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> server.accept();</span><br><span class="line">                    System.out.println(<span class="string">&quot;è·å–çš„æ‰‹æœºIPåœ°å€åŠç«¯å£å·ï¼š&quot;</span> + socket.getRemoteSocketAddress().toString());</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     * å› ä¸ºè€ƒè™‘åˆ°å¤šæ‰‹æœºè¿æ¥çš„æƒ…å†µ æ‰€ä»¥åŠ å…¥çº¿ç¨‹é” åªå…è®¸å•çº¿ç¨‹å·¥ä½œ</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">private</span> String text;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                                    <span class="comment">// åœ¨è¿™é‡Œè€ƒè™‘åˆ°çº¿ç¨‹æ€»æ•°çš„è®¡ç®— ä¹Ÿä»£è¡¨ç€è¿æ¥æ‰‹æœºçš„æ•°é‡</span></span><br><span class="line">                                    ++sum;</span><br><span class="line">                                    <span class="comment">// å­˜å…¥åˆ°é›†åˆå’ŒMapä¸­ä¸ºç¾¤å‘å’Œå•ç‹¬å‘é€åšå‡†å¤‡</span></span><br><span class="line">                                    <span class="type">String</span> <span class="variable">string</span> <span class="operator">=</span> socket.getRemoteSocketAddress().toString();</span><br><span class="line">                                    clientList.add(string);</span><br><span class="line">                                    clientMap.put(<span class="string">&quot;2&quot;</span>, socket);</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                <span class="comment">// å®šä¹‰è¾“å…¥è¾“å‡ºæµ</span></span><br><span class="line">                                <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> socket.getInputStream();</span><br><span class="line">                                <span class="type">OutputStream</span> <span class="variable">os</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line"></span><br><span class="line">                                <span class="comment">// æ¥ä¸‹æ¥è€ƒè™‘è¾“å…¥æµçš„è¯»å–æ˜¾ç¤ºåˆ°PCç«¯å’Œè¿”å›æ˜¯å¦æ”¶åˆ°</span></span><br><span class="line"><span class="comment">//                                byte[] buffer = new byte[1024];</span></span><br><span class="line"><span class="comment">//                                int len;</span></span><br><span class="line"><span class="comment">//                                while ((len = is.read(buffer)) != -1) &#123;</span></span><br><span class="line"><span class="comment">//                                    text = new String(buffer, 0, len);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                                    System.out.println(&quot;æ”¶åˆ°çš„æ•°æ®ä¸ºï¼š&quot; + text);</span></span><br><span class="line"><span class="comment">//                                    os.write(&quot;å·²æ”¶åˆ°æ¶ˆæ¯&quot;.getBytes(&quot;utf-8&quot;));</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                                &#125;</span></span><br><span class="line"></span><br><span class="line">                            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                                e.printStackTrace();</span><br><span class="line">                            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                                System.out.println(<span class="string">&quot;å…³é—­è¿æ¥ï¼š&quot;</span> + socket.getRemoteSocketAddress().toString());</span><br><span class="line">                                <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                                    --sum;</span><br><span class="line">                                    <span class="type">String</span> <span class="variable">string</span> <span class="operator">=</span> socket.getRemoteSocketAddress().toString();</span><br><span class="line">                                    clientMap.remove(string);</span><br><span class="line">                                    clientList.remove(string);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;).start();</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><ul><li><ol start="4"><li>åœ¨è¿æ¥ç»“æŸåï¼Œå…³é—­é“¾æ¥</li></ol></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…³é—­server</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">          isExit = <span class="literal">true</span>;</span><br><span class="line">          <span class="keyword">if</span> (server != <span class="literal">null</span>) &#123;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  server.close();</span><br><span class="line">                  System.out.println(<span class="string">&quot;å·²å…³é—­server&quot;</span>);</span><br><span class="line">              &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                  e.printStackTrace();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">shutDown</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (Socket socket : clientMap.values()) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              socket.close();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">              e.printStackTrace();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      serverThread.stop();</span><br><span class="line">      clientMap.clear();</span><br><span class="line">      clientList.clear();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li><ol start="5"><li>å‘é€ç®€æ˜“æ¶ˆæ¯</li></ol></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// å‘é€æ¶ˆæ¯çš„æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">sendMessage</span><span class="params">(String name, String mag)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> clientMap.get(name);</span><br><span class="line"><span class="comment">//            socket.setSendBufferSize(mag.length());</span></span><br><span class="line"><span class="comment">////            socket.setReceiveBufferSize(mag.length());</span></span><br><span class="line">            <span class="keyword">assert</span> socket != <span class="literal">null</span>;</span><br><span class="line">            <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line"><span class="comment">//            DataOutputStream out = new DataOutputStream(outputStream);</span></span><br><span class="line"><span class="comment">//            outputStream.write(mag.getBytes(&quot;utf-8&quot;));</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">MessageProtocol</span>().GenProtocol(outputStream,mag);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>6.å®šä¹‰æ¶ˆæ¯åè®®</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProtocolHeader</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] version = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] mask = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] length = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] timeStamp = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">10</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>7.åœ¨å‘é€æ¶ˆæ¯å‰ï¼Œç»„è£…æŠ¥æ–‡</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">  <span class="type">byte</span>[] header = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">40</span>];</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">GenProtocol</span><span class="params">(OutputStream out, String msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"><span class="comment">//        int type = 1;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        out.writeInt(type);</span></span><br><span class="line"><span class="comment">//        out.write(totalLen);</span></span><br><span class="line">        <span class="type">ProtocolHeader</span> <span class="variable">protocolHeader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProtocolHeader</span>();</span><br><span class="line">        protocolHeader.length = ConvertUtils.intToByteArray(bytes.length);</span><br><span class="line">        <span class="type">long</span> <span class="variable">timeStamp</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        protocolHeader.timeStamp = longToBytes(timeStamp);</span><br><span class="line">        protocolHeader.mask = <span class="string">&quot;aaaaaaa&quot;</span>.getBytes(StandardCharsets.UTF_8);</span><br><span class="line">        protocolHeader.version= <span class="string">&quot;1.0.0.0.0&quot;</span>.getBytes(StandardCharsets.UTF_8);</span><br><span class="line">        <span class="type">byte</span>[] val = addBytes(protocolHeader.version, protocolHeader.mask);</span><br><span class="line">        <span class="type">byte</span>[] val2 = addBytes(val, protocolHeader.length);</span><br><span class="line">        header = addBytes(val2, protocolHeader.timeStamp);</span><br><span class="line">        out.write(header);</span><br><span class="line"><span class="comment">//        Arrays.toString(serialize(protocolHeader));</span></span><br><span class="line"><span class="comment">//        Log.i(&quot;sss&quot;,  String.valueOf(serialize(protocolHeader)));</span></span><br><span class="line">        out.write(bytes,<span class="number">0</span>, bytes.length);</span><br><span class="line">        out.flush();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data1</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data2</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> data1 ä¸ data2æ‹¼æ¥çš„ç»“æœ</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] addBytes(<span class="type">byte</span>[] data1, <span class="type">byte</span>[] data2) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] data3 = <span class="keyword">new</span> <span class="title class_">byte</span>[data1.length + data2.length];</span><br><span class="line"></span><br><span class="line">        System.arraycopy(data1, <span class="number">0</span>, data3, <span class="number">0</span>, data1.length);</span><br><span class="line"></span><br><span class="line">        System.arraycopy(data2, <span class="number">0</span>, data3, data1.length, data2.length);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> data3;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>8.ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•å‘é€æ¶ˆæ¯</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ClientManager.sendMessage(<span class="string">&quot;id&quot;</span>, msg);</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li><ol start="9"><li>ClientManager å·¥å…·ç±»å®Œæ•´ä»£ç </li></ol></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.DataOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç®¡ç†è¿æ¥åˆ°æœåŠ¡å™¨ä¸­çš„æ‰‹æœºç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientManager</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ServerThread</span> <span class="variable">serverThread</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Socket&gt; clientMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; clientList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ServerThread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> ServerSocket server;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">10086</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isExit</span> <span class="operator">=</span> <span class="literal">false</span>;<span class="comment">// ä¸€ä¸ªbooleanç±»å‹çš„åˆ¤æ–­ é»˜è®¤æ˜¯é€€å‡ºçŠ¶æ€false</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ„é€ æ–¹æ³•åˆå§‹åŒ–</span></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">ServerThread</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                server = <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(port);</span><br><span class="line">                System.out.println(<span class="string">&quot;å¯åŠ¨serverï¼Œç«¯å£å·ï¼š&quot;</span> + port);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 1.è·å¾—è¿œç¨‹æœåŠ¡å™¨çš„IP åœ°å€.</span></span><br><span class="line"><span class="comment">         * InetAddress inetAddress = socket.getInetAddress();</span></span><br><span class="line"><span class="comment">         * 2.è·å¾—è¿œç¨‹æœåŠ¡å™¨çš„ç«¯å£.</span></span><br><span class="line"><span class="comment">         * int port = socket.getPort();</span></span><br><span class="line"><span class="comment">         * 3. è·å¾—å®¢æˆ·æœ¬åœ°çš„IP åœ°å€.</span></span><br><span class="line"><span class="comment">         * InetAddress localAddress = socket.getLocalAddress();</span></span><br><span class="line"><span class="comment">         * 4.è·å¾—å®¢æˆ·æœ¬åœ°çš„ç«¯å£.</span></span><br><span class="line"><span class="comment">         * int localPort = socket.getLocalPort();</span></span><br><span class="line"><span class="comment">         * 5.è·å–æœ¬åœ°çš„åœ°å€å’Œç«¯å£å·</span></span><br><span class="line"><span class="comment">         * SocketAddress localSocketAddress = socket.getLocalSocketAddress();</span></span><br><span class="line"><span class="comment">         * 6.è·å¾—è¿œç¨‹çš„åœ°å€å’Œç«¯å£å·</span></span><br><span class="line"><span class="comment">         * SocketAddress remoteSocketAddress = socket.getRemoteSocketAddress();</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (!isExit) &#123;</span><br><span class="line">                    <span class="comment">// ç­‰å¾…è¿æ¥</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;ç­‰å¾…æ‰‹æœºçš„è¿æ¥ä¸­... ...&quot;</span>);</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> server.accept();</span><br><span class="line">                    System.out.println(<span class="string">&quot;è·å–çš„æ‰‹æœºIPåœ°å€åŠç«¯å£å·ï¼š&quot;</span> + socket.getRemoteSocketAddress().toString());</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     * å› ä¸ºè€ƒè™‘åˆ°å¤šæ‰‹æœºè¿æ¥çš„æƒ…å†µ æ‰€ä»¥åŠ å…¥çº¿ç¨‹é” åªå…è®¸å•çº¿ç¨‹å·¥ä½œ</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">private</span> String text;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                                    <span class="comment">// åœ¨è¿™é‡Œè€ƒè™‘åˆ°çº¿ç¨‹æ€»æ•°çš„è®¡ç®— ä¹Ÿä»£è¡¨ç€è¿æ¥æ‰‹æœºçš„æ•°é‡</span></span><br><span class="line">                                    ++sum;</span><br><span class="line">                                    <span class="comment">// å­˜å…¥åˆ°é›†åˆå’ŒMapä¸­ä¸ºç¾¤å‘å’Œå•ç‹¬å‘é€åšå‡†å¤‡</span></span><br><span class="line">                                    <span class="type">String</span> <span class="variable">string</span> <span class="operator">=</span> socket.getRemoteSocketAddress().toString();</span><br><span class="line">                                    clientList.add(string);</span><br><span class="line">                                    clientMap.put(<span class="string">&quot;2&quot;</span>, socket);</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                <span class="comment">// å®šä¹‰è¾“å…¥è¾“å‡ºæµ</span></span><br><span class="line">                                <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> socket.getInputStream();</span><br><span class="line">                                <span class="type">OutputStream</span> <span class="variable">os</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line"></span><br><span class="line">                                <span class="comment">// æ¥ä¸‹æ¥è€ƒè™‘è¾“å…¥æµçš„è¯»å–æ˜¾ç¤ºåˆ°PCç«¯å’Œè¿”å›æ˜¯å¦æ”¶åˆ°</span></span><br><span class="line"><span class="comment">//                                byte[] buffer = new byte[1024];</span></span><br><span class="line"><span class="comment">//                                int len;</span></span><br><span class="line"><span class="comment">//                                while ((len = is.read(buffer)) != -1) &#123;</span></span><br><span class="line"><span class="comment">//                                    text = new String(buffer, 0, len);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                                    System.out.println(&quot;æ”¶åˆ°çš„æ•°æ®ä¸ºï¼š&quot; + text);</span></span><br><span class="line"><span class="comment">//                                    os.write(&quot;å·²æ”¶åˆ°æ¶ˆæ¯&quot;.getBytes(&quot;utf-8&quot;));</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                                &#125;</span></span><br><span class="line"></span><br><span class="line">                            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                                e.printStackTrace();</span><br><span class="line">                            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                                System.out.println(<span class="string">&quot;å…³é—­è¿æ¥ï¼š&quot;</span> + socket.getRemoteSocketAddress().toString());</span><br><span class="line">                                <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                                    --sum;</span><br><span class="line">                                    <span class="type">String</span> <span class="variable">string</span> <span class="operator">=</span> socket.getRemoteSocketAddress().toString();</span><br><span class="line">                                    clientMap.remove(string);</span><br><span class="line">                                    clientList.remove(string);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;).start();</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å…³é—­server</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">            isExit = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (server != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    server.close();</span><br><span class="line">                    System.out.println(<span class="string">&quot;å·²å…³é—­server&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯åŠ¨server</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ServerThread <span class="title function_">startServer</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å¼€å¯server&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (serverThread != <span class="literal">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;serverä¸ä¸ºnullæ­£åœ¨é‡å¯server&quot;</span>);</span><br><span class="line">            <span class="comment">// ä»¥ä¸‹ä¸ºå…³é—­serverå’Œsocket</span></span><br><span class="line">            shutDown();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line">        serverThread = <span class="keyword">new</span> <span class="title class_">ServerThread</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(serverThread).start();</span><br><span class="line">        System.out.println(<span class="string">&quot;å¼€å¯serveræˆåŠŸ&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> serverThread;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘é€æ¶ˆæ¯çš„æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">sendMessage</span><span class="params">(String name, String mag)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> clientMap.get(name);</span><br><span class="line"><span class="comment">//            socket.setSendBufferSize(mag.length());</span></span><br><span class="line"><span class="comment">////            socket.setReceiveBufferSize(mag.length());</span></span><br><span class="line">            <span class="keyword">assert</span> socket != <span class="literal">null</span>;</span><br><span class="line">            <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line"><span class="comment">//            DataOutputStream out = new DataOutputStream(outputStream);</span></span><br><span class="line"><span class="comment">//            outputStream.write(mag.getBytes(&quot;utf-8&quot;));</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">MessageProtocol</span>().GenProtocol(outputStream,mag);</span><br><span class="line">            Log.e(<span class="string">&quot;AAA&quot;</span>,<span class="string">&quot;AAA==&quot;</span>+<span class="keyword">new</span> <span class="title class_">String</span>(mag.getBytes(<span class="string">&quot;utf-8&quot;</span>)));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¾¤å‘çš„æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">sendMsgAll</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (Socket socket : clientMap.values()) &#123;</span><br><span class="line">                <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line">                outputStream.write(msg.getBytes(<span class="string">&quot;utf-8&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–çº¿ç¨‹æ€»æ•°çš„æ–¹æ³•ï¼Œä¹Ÿç­‰åŒäº&lt;è·å–å·²è¿æ¥äº†å¤šå°‘å°æ‰‹æœº&gt;çš„æ–¹æ³•+</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">sumTotal</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸€ä¸ªè·å–listé›†åˆçš„æ–¹æ³•ï¼Œå–åˆ°æ‰€æœ‰è¿æ¥serverçš„æ‰‹æœºçš„ipå’Œç«¯å£å·çš„é›†åˆ</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title function_">getTotalClients</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> clientList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">shutDown</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Socket socket : clientMap.values()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                socket.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        serverThread.stop();</span><br><span class="line">        clientMap.clear();</span><br><span class="line">        clientList.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Unity-å®¢æˆ·ç«¯">Unity å®¢æˆ·ç«¯</h3><ul><li><ol><li>ä¸ Android å»ºç«‹ socket è¿æ¥</li></ol></li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆ›å»ºsocket</span></span><br><span class="line">         clientSocket = <span class="keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);</span><br><span class="line"></span><br><span class="line">         Debug.Log(logHeader + <span class="string">&quot;current ip and port is : ip :&quot;</span> + ip + <span class="string">&quot;,port:&quot;</span> + port);</span><br><span class="line"></span><br><span class="line">         IPAddress mIp = IPAddress.Parse(ip);</span><br><span class="line">         IPEndPoint ip_end_point = <span class="keyword">new</span> IPEndPoint(mIp, port);</span><br><span class="line"></span><br><span class="line">         <span class="keyword">try</span></span><br><span class="line">         &#123;</span><br><span class="line">             clientSocket.Connect(ip_end_point);</span><br><span class="line">             IsConnected = <span class="literal">true</span>;</span><br><span class="line">             Debug.Log(<span class="string">&quot;è¿æ¥æœåŠ¡å™¨æˆåŠŸï¼&quot;</span>);</span><br><span class="line">             <span class="comment">// WriteLog(&quot;é“¾æ¥æœåŠ¡å™¨æˆåŠŸï¼&quot;);</span></span><br><span class="line">             threadReceive = <span class="keyword">new</span> Thread(ReceiveMsgWS);</span><br><span class="line">             threadReceive.IsBackground = <span class="literal">true</span>;</span><br><span class="line">             threadReceive.Start();</span><br><span class="line"></span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">catch</span></span><br><span class="line">         &#123;</span><br><span class="line">             IsConnected = <span class="literal">false</span>;</span><br><span class="line">             Debug.Log(logHeader + <span class="string">&quot;è¿æ¥æœåŠ¡å™¨å¤±è´¥&quot;</span>);</span><br><span class="line">             <span class="comment">// Toast.Show(&quot;æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼&quot;, 1f);</span></span><br><span class="line">             <span class="comment">// WriteLog(&quot;é“¾æ¥æœåŠ¡å™¨å¤±è´¥&quot;);</span></span><br><span class="line">             <span class="keyword">return</span>;</span><br><span class="line">         &#125;</span><br></pre></td></tr></table></figure><ul><li><ol start="2"><li>æ¥æ”¶ Android æ¶ˆæ¯</li></ol></li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">Byte[] buffer_length;<span class="comment"><span class="doctag">///</span>buffer head</span></span><br><span class="line">Byte[] buffer;</span><br><span class="line"><span class="built_in">string</span> data;</span><br><span class="line"><span class="built_in">int</span> length = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">bool</span> messageStart = <span class="literal">false</span>;</span><br><span class="line"><span class="built_in">string</span> const_str;</span><br><span class="line"><span class="built_in">int</span> status = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    buffer_length = <span class="keyword">new</span> Byte[<span class="number">1024</span>];</span><br><span class="line">    <span class="comment">// clientSocket.get</span></span><br><span class="line">    status = clientSocket.Receive(buffer_length);</span><br><span class="line">    <span class="keyword">if</span> (status == <span class="number">40</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        const_str = System.Text.Encoding.ASCII.GetString(buffer_length).Substring(<span class="number">0</span>, <span class="number">20</span>);<span class="comment">//,(buffer, 0, 12, &quot;ASCII&quot;)</span></span><br><span class="line">        <span class="keyword">if</span> (const_str.Equals(<span class="string">&quot;1.0.0.0.0aaaaaaa&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            messageStart = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (messageStart)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        length = SocketUtils.byteArrayToInt(buffer_length, <span class="number">12</span>, <span class="number">4</span>);</span><br><span class="line">        <span class="comment">// length = headerData.length;</span></span><br><span class="line">        buffer = <span class="keyword">new</span> Byte[length];</span><br><span class="line">        <span class="built_in">int</span> readed_length = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (readed_length &lt; buffer.Length)</span><br><span class="line">        &#123;</span><br><span class="line">            status = clientSocket.Receive(buffer, readed_length, buffer.Length - readed_length, SocketFlags.None);</span><br><span class="line">            <span class="keyword">if</span> (status &lt;= <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            readed_length += status;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (buffer.Length &gt; <span class="number">0</span> &amp;&amp; readed_length == buffer.Length)</span><br><span class="line">        &#123;</span><br><span class="line">            data = System.Text.Encoding.UTF8.GetString(buffer);</span><br><span class="line">            data_send(data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><ol start="3"><li>æ–­å¼€è¿æ¥</li></ol></li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="literal">null</span> != clientSocket &amp;&amp; clientSocket.Connected)</span><br><span class="line">&#123;</span><br><span class="line">    Debug.Log(logHeader + <span class="string">&quot;æœåŠ¡å™¨è¿æ¥å·²æ–­å¼€ï¼&quot;</span>);</span><br><span class="line">    <span class="comment">// Toast.Show(&quot;æœåŠ¡å™¨è¿æ¥æ–­å¼€ï¼&quot;, 1f);</span></span><br><span class="line">    clientSocket.Shutdown(SocketShutdown.Both);</span><br><span class="line">    clientSocket.Close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><ol start="4"><li>å‘é€æ¶ˆæ¯</li></ol></li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (IsConnected == <span class="literal">false</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//    Debug.Log(&quot;å‘é€æ•°æ®é”™è¯¯ï¼ŒæœåŠ¡å™¨æœªè¿æ¥ï¼&quot;);</span></span><br><span class="line">                <span class="comment">//  WriteLog(&quot;æœåŠ¡å™¨æœªè¿æ¥!&quot;);</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == msg)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.Log(logHeader + <span class="string">&quot;å‘é€æ•°æ®é”™è¯¯ï¼Œæ¶ˆæ¯ä¸èƒ½ä¸ºç©ºï¼&quot;</span>);</span><br><span class="line">                <span class="comment">//WriteLog(&quot;æ¶ˆæ¯ä¸èƒ½ä¸ºç©º&quot;);</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                clientSocket.Send(msg);</span><br><span class="line">                <span class="comment">//Debug.Log(&quot;å‘é€æˆåŠŸï¼&quot;);</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// WriteLog(&quot;å‘é€æˆåŠŸï¼&quot;);</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span></span><br><span class="line">            &#123;</span><br><span class="line">                Debug.Log(logHeader + <span class="string">&quot;å‘é€æ•°æ®é”™è¯¯ï¼Œæ¶ˆæ¯ç¼–ç é”™è¯¯ï¼&quot;</span>);</span><br><span class="line">                <span class="comment">// WriteLog(&quot;æ¶ˆæ¯ç¼–ç é”™è¯¯ï¼&quot;);</span></span><br><span class="line">                IsConnected = <span class="literal">false</span>;</span><br><span class="line">                clientSocket.Shutdown(SocketShutdown.Both);</span><br><span class="line">                clientSocket.Close();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><ul><li><ol start="5"><li>æ•´æ•°æ®è½¬ byte æ•°ç»„</li></ol></li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">byteArrayToInt</span>(<span class="params"><span class="built_in">byte</span>[] byteArray, <span class="built_in">int</span> offset, <span class="built_in">int</span> length</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (length != <span class="number">4</span> || (offset + length) &gt; byteArray.Length)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">int</span> <span class="keyword">value</span> = (byteArray[offset] &amp; <span class="number">0xFF</span>);</span><br><span class="line">    <span class="keyword">value</span> |= (byteArray[offset + <span class="number">1</span>] &amp; <span class="number">0xff</span>) &lt;&lt; <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">value</span> |= (byteArray[offset + <span class="number">2</span>] &amp; <span class="number">0xff</span>) &lt;&lt; <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">value</span> |= (byteArray[offset + <span class="number">3</span>] &amp; <span class="number">0xff</span>) &lt;&lt; <span class="number">24</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">value</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>6.æ¥æ”¶å¤„ç†ç±»ä»£ç </li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Net.Sockets;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> Newtonsoft.Json;</span><br><span class="line"><span class="comment">// using System;</span></span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="comment">// using Newtonsoft.Json;</span></span><br><span class="line"><span class="keyword">using</span> cccc.util;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>socket å·¥å…·ç±»</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ccccc.ccc.internet</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SocketClient</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">#<span class="keyword">region</span> å·¥å…·ç±»å‚æ•°</span></span><br><span class="line">        <span class="comment">//æ˜¯å¦ç™»å½•</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> login_flag = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> Socket clientSocket;</span><br><span class="line">        <span class="comment">//æ˜¯å¦å·²è¿æ¥çš„æ ‡è¯†</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> logHeader = <span class="string">&quot;file:SocketClient.cs: &quot;</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> result;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> IsConnected = <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">//æ¡æ‰‹æ¶ˆæ¯</span></span><br><span class="line">        <span class="keyword">public</span> Thread threadReceive;</span><br><span class="line">        <span class="comment">//ä¸»æ•°æ®</span></span><br><span class="line">        <span class="keyword">public</span> Thread threadReceive_get_data;</span><br><span class="line">        <span class="comment">//è§£ææ¶ˆæ¯</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// IMessage IMperson = new DetectionInfo();</span></span><br><span class="line">        <span class="comment">// DetectionInfo p1 = new();</span></span><br><span class="line">        <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> struct methods</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SocketClient</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//åˆ›å»ºsocket</span></span><br><span class="line">            clientSocket = <span class="keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> è¿æ¥æŒ‡å®šIPå’Œç«¯å£çš„æœåŠ¡å™¨</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;ip&quot;&gt;</span>IPåœ°å€<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;port&quot;&gt;</span>ç«¯å£å·<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Connect</span>(<span class="params"><span class="built_in">string</span> ip, <span class="built_in">int</span> port</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Debug.Log(logHeader + <span class="string">&quot;current ip and port is : ip :&quot;</span> + ip + <span class="string">&quot;,port:&quot;</span> + port);</span><br><span class="line">            IPAddress mIp = IPAddress.Parse(ip);</span><br><span class="line">            IPEndPoint ip_end_point = <span class="keyword">new</span> IPEndPoint(mIp, port);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                clientSocket.Connect(ip_end_point);</span><br><span class="line">                IsConnected = <span class="literal">true</span>;</span><br><span class="line">                Debug.Log(<span class="string">&quot;è¿æ¥æœåŠ¡å™¨æˆåŠŸï¼&quot;</span>);</span><br><span class="line">                <span class="comment">// WriteLog(&quot;é“¾æ¥æœåŠ¡å™¨æˆåŠŸï¼&quot;);</span></span><br><span class="line">                threadReceive = <span class="keyword">new</span> Thread(ReceiveMsgWS);</span><br><span class="line">                threadReceive.IsBackground = <span class="literal">true</span>;</span><br><span class="line">                threadReceive.Start();</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span></span><br><span class="line">            &#123;</span><br><span class="line">                IsConnected = <span class="literal">false</span>;</span><br><span class="line">                Debug.Log(logHeader + <span class="string">&quot;è¿æ¥æœåŠ¡å™¨å¤±è´¥&quot;</span>);</span><br><span class="line">                <span class="comment">// Toast.Show(&quot;æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼&quot;, 1f);</span></span><br><span class="line">                <span class="comment">// WriteLog(&quot;é“¾æ¥æœåŠ¡å™¨å¤±è´¥&quot;);</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> æ–­å¼€è¿æ¥</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Disconnect</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != clientSocket &amp;&amp; clientSocket.Connected)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.Log(logHeader + <span class="string">&quot;æœåŠ¡å™¨è¿æ¥å·²æ–­å¼€ï¼&quot;</span>);</span><br><span class="line">                <span class="comment">// Toast.Show(&quot;æœåŠ¡å™¨è¿æ¥æ–­å¼€ï¼&quot;, 1f);</span></span><br><span class="line">                clientSocket.Shutdown(SocketShutdown.Both);</span><br><span class="line">                clientSocket.Close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> å‘é€æ•°æ®ç»™æœåŠ¡å™¨</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;msg&quot;&gt;</span>å‘é€æ¶ˆæ¯å†…å®¹<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Send</span>(<span class="params"><span class="built_in">string</span> msg</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (IsConnected == <span class="literal">false</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.Log(logHeader + <span class="string">&quot;å‘é€æ•°æ®é”™è¯¯ï¼ŒæœåŠ¡å™¨æœªè¿æ¥ï¼&quot;</span>);</span><br><span class="line">                <span class="comment">// Toast.Show(&quot;æ— æ³•å‘é€æ•°æ®ï¼ŒæœåŠ¡å™¨æœªè¿æ¥ï¼&quot;, 1f);</span></span><br><span class="line">                <span class="comment">//   WriteLog(&quot;æœåŠ¡å™¨æœªè¿æ¥ï¼&quot;);</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == msg)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.Log(logHeader + <span class="string">&quot;å‘é€æ•°æ®é”™è¯¯ï¼Œæ¶ˆæ¯ä¸èƒ½ä¸ºç©ºï¼&quot;</span>);</span><br><span class="line">                <span class="comment">//  WriteLog(&quot;æ¶ˆæ¯ä¸èƒ½ä¸ºç©ºï¼&quot;);</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// clientSocket.Send(ProtobufEncoding.Encode(msg));</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span></span><br><span class="line">            &#123;</span><br><span class="line">                Debug.Log(logHeader + <span class="string">&quot;å‘é€æ•°æ®é”™è¯¯ï¼Œæ¶ˆæ¯ç¼–ç é”™è¯¯ï¼&quot;</span>);</span><br><span class="line">                <span class="comment">// WriteLog(&quot;æ¶ˆæ¯ç¼–ç é”™è¯¯!&quot;);</span></span><br><span class="line">                IsConnected = <span class="literal">false</span>;</span><br><span class="line">                clientSocket.Shutdown(SocketShutdown.Both);</span><br><span class="line">                clientSocket.Close();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> å‘é€æ•°æ®ç»™æœåŠ¡å™¨</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;msg&quot;&gt;</span>å‘é€æ¶ˆæ¯å†…å®¹<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SendLogin</span>(<span class="params"><span class="built_in">byte</span>[] msg</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (IsConnected == <span class="literal">false</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//    Debug.Log(&quot;å‘é€æ•°æ®é”™è¯¯ï¼ŒæœåŠ¡å™¨æœªè¿æ¥ï¼&quot;);</span></span><br><span class="line">                <span class="comment">//  WriteLog(&quot;æœåŠ¡å™¨æœªè¿æ¥!&quot;);</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == msg)</span><br><span class="line">            &#123;</span><br><span class="line">                Debug.Log(logHeader + <span class="string">&quot;å‘é€æ•°æ®é”™è¯¯ï¼Œæ¶ˆæ¯ä¸èƒ½ä¸ºç©ºï¼&quot;</span>);</span><br><span class="line">                <span class="comment">//WriteLog(&quot;æ¶ˆæ¯ä¸èƒ½ä¸ºç©º&quot;);</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                clientSocket.Send(msg);</span><br><span class="line">                <span class="comment">//Debug.Log(&quot;å‘é€æˆåŠŸï¼&quot;);</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// WriteLog(&quot;å‘é€æˆåŠŸï¼&quot;);</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span></span><br><span class="line">            &#123;</span><br><span class="line">                Debug.Log(logHeader + <span class="string">&quot;å‘é€æ•°æ®é”™è¯¯ï¼Œæ¶ˆæ¯ç¼–ç é”™è¯¯ï¼&quot;</span>);</span><br><span class="line">                <span class="comment">// WriteLog(&quot;æ¶ˆæ¯ç¼–ç é”™è¯¯ï¼&quot;);</span></span><br><span class="line">                IsConnected = <span class="literal">false</span>;</span><br><span class="line">                clientSocket.Shutdown(SocketShutdown.Both);</span><br><span class="line">                clientSocket.Close();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// return;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> é€šè¿‡çº¿ç¨‹æœåŠ¡å™¨æ•°æ®è·å–</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ReceiveMsgWS</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// string length_str;</span></span><br><span class="line">            Byte[] buffer_length;<span class="comment"><span class="doctag">///</span>buffer head</span></span><br><span class="line">            Byte[] buffer;</span><br><span class="line">            <span class="built_in">string</span> data;</span><br><span class="line">            <span class="built_in">int</span> length = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">bool</span> messageStart = <span class="literal">false</span>;</span><br><span class="line">            <span class="built_in">string</span> const_str;</span><br><span class="line">            <span class="built_in">int</span> status = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line"></span><br><span class="line">                buffer_length = <span class="keyword">new</span> Byte[<span class="number">1024</span>];</span><br><span class="line">                <span class="comment">// clientSocket.get</span></span><br><span class="line">                status = clientSocket.Receive(buffer_length);</span><br><span class="line">                <span class="keyword">if</span> (status == <span class="number">24</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    const_str = System.Text.Encoding.ASCII.GetString(buffer_length).Substring(<span class="number">0</span>, <span class="number">12</span>);<span class="comment">//,(buffer, 0, 12, &quot;ASCII&quot;)</span></span><br><span class="line">                    <span class="keyword">if</span> (const_str.Equals(<span class="string">&quot;1.0.ccccc&quot;</span>))</span><br><span class="line">                    &#123;</span><br><span class="line">                        messageStart = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (messageStart)</span><br><span class="line">                &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    length = SocketUtils.byteArrayToInt(buffer_length, <span class="number">12</span>, <span class="number">4</span>);</span><br><span class="line">                    <span class="comment">// length = headerData.length;</span></span><br><span class="line">                    buffer = <span class="keyword">new</span> Byte[length];</span><br><span class="line">                    <span class="built_in">int</span> readed_length = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span> (readed_length &lt; buffer.Length)</span><br><span class="line">                    &#123;</span><br><span class="line">                        status = clientSocket.Receive(buffer, readed_length, buffer.Length - readed_length, SocketFlags.None);</span><br><span class="line">                        <span class="keyword">if</span> (status &lt;= <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        readed_length += status;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (buffer.Length &gt; <span class="number">0</span> &amp;&amp; readed_length == buffer.Length)</span><br><span class="line">                    &#123;</span><br><span class="line">                        data = System.Text.Encoding.UTF8.GetString(buffer);</span><br><span class="line">                        data_send(data);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> å‘é€æ•°æ®è‡³ä¸»çº¿ç¨‹</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;p1&quot;&gt;</span>æ•°æ®<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">data_send</span>(<span class="params"><span class="built_in">string</span> p1</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//  var event1 = &quot;event1&quot;;</span></span><br><span class="line">            <span class="keyword">var</span> event2 = <span class="string">&quot;event2&quot;</span>;</span><br><span class="line">            <span class="keyword">var</span> thread = Unity.Threading.EasyThread.GetInstance();</span><br><span class="line">            <span class="comment">//æ³¨å†Œå­çº¿ç¨‹ç›‘å¬</span></span><br><span class="line">            thread.childRemote.Once(event2, () =&gt;</span><br><span class="line">            &#123;</span><br><span class="line"></span><br><span class="line">                thread.mainRemote.Send(event2, p1);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//æ¨é€å­çº¿ç¨‹äº‹ä»¶,æ¿€æ´»å­çº¿ç¨‹ç›‘å¬æ–¹æ³•</span></span><br><span class="line">            thread.childRemote.Send(event2);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> android </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Integrating Unity as a library into standard Android app</title>
      <link href="/2023/02/22/android/"/>
      <url>/2023/02/22/android/</url>
      
        <content type="html"><![CDATA[<h2 id="Integrating-Unity-as-a-library-into-standard-Android-app">Integrating Unity as a library into standard Android app</h2><p>This document explains how to include Unity as a Library into standard Android application through Activity. You can read more about <a href="https://docs.unity3d.com/2019.3/Documentation/Manual/UnityasaLibrary.html">Unity as a Library</a>.</p><p><strong>Requirements:</strong></p><ul><li>Android Studio Bumblebee (2021.1.1) or later</li><li>Unity version 2022.2.0a18 or later<br>[Note] For Unity versions from 2019.3.0b4 to 2022.2.0a17 use <a href="https://github.com/Unity-Technologies/uaal-example/tree/uaal-example/19LTS-21LTS">this branch</a></li></ul><p><strong>1. Get source</strong></p><ul><li>Clone or Download GitHub repo <a href="https://github.com/Unity-Technologies/uaal-example">uaal-example</a>. It includes:<br><img src="/2023/02/22/android/rootFolderStructure.png" class="lazyload placeholder" data-srcset="/2023/02/22/android/rootFolderStructure.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"><ul><li>Unityproject - this is a simple demo project made with Unity which will be integrated to the standard Android application</li><li>NativeAndroidApp - this is the Basic Activity application from Android Studio templates where Unity project will be integrated. It has a simple UI, MainUnityActivity, which extends OverrideUnityActivity, and is prepared to start MainUnityActivity with an Intent</li></ul></li></ul><p><strong>2. Generate Gradle project for Android platform</strong></p><ul><li>Open UnityProject in Unity Editor</li><li>Go to Build Settings window (Menu / File / Build Settings)<ul><li>Select and switch to Android Platform</li></ul></li><li>Go to Player Settings window (click Player Settings button at the bottom left corner of Build Settings or use Edit / Project Settings menu and choose Player tab on the left)<ul><li>In Other Settings -&gt; Configuration section choose targeted architectures<br><img src="/2023/02/22/android/selectArchitectures.png" class="lazyload placeholder" data-srcset="/2023/02/22/android/selectArchitectures.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></li></ul></li><li>Go back to Build Settings window<ul><li>Select option â€œExport Projectâ€<br>![img](android/exportProject.png&quot; width=â€˜400pxâ€™&gt;</li><li>Export UnityProject to androidBuild folder, the folder structure should look like this<br><img src="/2023/02/22/android/exportedProjectFolder.png" class="lazyload placeholder" data-srcset="/2023/02/22/android/exportedProjectFolder.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></li></ul></li></ul><p><strong>3. Add Unity Library module to NativeAndroidApp</strong><br><br>Do the following to add the exported androidBuild/unityLibrary module to the NativeAndroidApp Gradle project in Android Studio:</p><ul><li>Open NativeAndroidApp in Android Studio</li><li>Open settings.gradle file<ul><li>Add a new project pointing to unityLibrary module after the main app module</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">include &#x27;:unityLibrary&#x27;</span><br><span class="line">project(&#x27;:unityLibrary&#x27;).projectDir=new File(&#x27;..\\UnityProject\\androidBuild\\unityLibrary&#x27;)</span><br></pre></td></tr></table></figure><ul><li>And add the following in dependencyResolutionManagement{repositories{ block</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flatDir &#123;</span><br><span class="line">  dirs &quot;$&#123;project(&#x27;:unityLibrary&#x27;).projectDir&#125;/libs&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2023/02/22/android/settingsGradle.png" class="lazyload placeholder" data-srcset="/2023/02/22/android/settingsGradle.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></li><li>Open build.gradle(Module: NativeAndroidApp.app) file<ul><li>Add the following in dependencies{ block</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">implementation project(&#x27;:unityLibrary&#x27;)</span><br><span class="line">implementation fileTree(dir: project(&#x27;:unityLibrary&#x27;).getProjectDir().toString() + (&#x27;\\libs&#x27;), include: [&#x27;*.jar&#x27;])</span><br></pre></td></tr></table></figure><img src="/2023/02/22/android/buildGradleApp.png" class="lazyload placeholder" data-srcset="/2023/02/22/android/buildGradleApp.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"><ul><li>In the same file take a look at android{defaultConfig{ndk{ block and make sure abiFilters match the architectures you selected in Unity editor before exporting the project. The filter must match architectures in Unity editor exactly. If Unity exports only ARMv7 architecture, but the filter includes arm64-v8a, the application will crash on ARM64 devices. Check for valid abiFilters values in the <a href="https://developer.android.com/ndk/guides/abis#sa">official android documentation</a>.<br><img src="/2023/02/22/android/buildGradleAppAbiFilters.png" class="lazyload placeholder" data-srcset="/2023/02/22/android/buildGradleAppAbiFilters.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></li></ul></li><li>Copy the contents of the gradle.properties file from the exported Unity project root folder to the gradle.properties file in the native application root folder. Note: if you update the Unity project and re-export it again, make sure that the contents of the gradle.properties file in the exported project did not change. If they did - repeat this step.<br><img src="/2023/02/22/android/exportedASProject.png" class="lazyload placeholder" data-srcset="/2023/02/22/android/exportedASProject.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"><a href="android/gradlePropertiesApp.png">img</a></li><li>Click Sync Now to do a project sync since Gradle files have been modified<br><a href="android/syncGradle.png">img</a></li><li>If everything succeeds, you should see unityLibrary module added in Android view<br><img src="/2023/02/22/android/unityLibraryModule.png" class="lazyload placeholder" data-srcset="/2023/02/22/android/unityLibraryModule.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></li></ul><h2 id="Project-is-ready">Project is ready</h2><p>Everything is ready to build, run and debug:<br>![img](android/buildOnDevice.png&quot; width=â€˜500pxâ€™&gt;<br><br>If everything succeeded, at this point you should be able to run NativeAndroidApp:</p><table><thead><tr><th>Main Activity</th><th>Unity Activity</th></tr></thead><tbody><tr><td><img src="/2023/02/22/android/appNativeSS.png" class="lazyload placeholder" data-srcset="/2023/02/22/android/appNativeSS.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></td><td><img src="/2023/02/22/android/appUnitySS.png" class="lazyload placeholder" data-srcset="/2023/02/22/android/appUnitySS.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></td></tr><tr><td>Main Activity</td><td>Unity is loaded and is running in a separate Activity. Light grey buttons in the middle are added from the MainUnityActivity implemented in NativeAndroidApp</td></tr></tbody></table><h2 id="Notes">Notes</h2><ul><li>Unity is running in another process android:process=â€œ:Unityâ€ (AndroidManifest.xml at app module)</li><li>After installation there will be two icons added on the device. To leave only the icon of the main activity, remove <intent-filter>â€¦</intent-filter> from the AndroidManifest.xml in unityLibrary</li><li>(Optional) We found some Android 7.* devices set frontOfTask to wrong state for activities as a result when finishing/quitting Unity activity whole task goes to background instead of bringing back Main activity. Next workaround keeps expected behavior: add to MainUnityActivity.java from NativeAndroidApp<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@Override public void onUnityPlayerQuitted() &#123; showMainActivity(&quot;&quot;); finish(); &#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> unity </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
