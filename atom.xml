<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Zhaoqi.Cao static blog</title>
  
  <subtitle>æµ…æ–Ÿä½å”±</subtitle>
  <link href="https://caozhaoqi.github.io/atom.xml" rel="self"/>
  
  <link href="https://caozhaoqi.github.io/"/>
  <updated>2025-11-28T15:34:27.317Z</updated>
  <id>https://caozhaoqi.github.io/</id>
  
  <author>
    <name>Zhaoqi.Cao</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>åŸºäº RAG ä¸ Agent åä½œçš„æ™ºèƒ½é¢è¯•åŠ©æ‰‹å¼€å‘æŒ‡å—</title>
    <link href="https://caozhaoqi.github.io/2025/11/28/agent-rag-jd/"/>
    <id>https://caozhaoqi.github.io/2025/11/28/agent-rag-jd/</id>
    <published>2025-11-28T15:32:37.000Z</published>
    <updated>2025-11-28T15:34:27.317Z</updated>
    
    <content type="html"><![CDATA[<h1>å®æˆ˜ï¼šå¦‚ä½•è®© AI â€œè¯»æ‡‚â€æˆ‘çš„åšå®¢ï¼Ÿâ€”â€”åŸºäº RAG ä¸ Agent åä½œçš„æ™ºèƒ½é¢è¯•åŠ©æ‰‹å¼€å‘æŒ‡å—</h1><blockquote><p><strong>æ‘˜è¦</strong>ï¼šåœ¨å¤§æ¨¡å‹æ—¶ä»£ï¼Œå¦‚ä½•è®© AI ä¸ä»…å…·å¤‡é€šç”¨çŸ¥è¯†ï¼Œè¿˜èƒ½åˆ©ç”¨æˆ‘ä»¬ç§æœ‰çš„æ•°æ®ï¼ˆå¦‚ä¸ªäººåšå®¢ã€æŠ€æœ¯ç¬”è®°ï¼‰è¿›è¡Œå›ç­”ï¼Ÿæœ¬æ–‡å°†æ‹†è§£ä¸€ä¸ªçœŸå®é¡¹ç›® <code>JD_Agent</code> çš„å®ç°è¿‡ç¨‹ã€‚æˆ‘ä»¬åˆ©ç”¨ <strong>FastAPI + LangChain</strong> æ„å»ºäº†ä¸€ä¸ªæ™ºèƒ½ä½“ï¼Œå®ƒä¸ä»…èƒ½åˆ†æå²—ä½ JDï¼Œè¿˜èƒ½é€šè¿‡ <strong>RAG æŠ€æœ¯</strong> æ£€ç´¢æˆ‘çš„æœ¬åœ° Markdown åšå®¢ï¼Œç”Ÿæˆç»“åˆäº†æˆ‘ä¸ªäººæŠ€æœ¯ç§¯ç´¯çš„ä¸“å±é¢è¯•æŒ‡å—ã€‚</p></blockquote><hr><h2 id="ä¸€ã€-ä¸ºä»€ä¹ˆè¦åšè¿™ä¸ªï¼Ÿï¼ˆç—›ç‚¹ä¸æ€è·¯ï¼‰">ä¸€ã€ ä¸ºä»€ä¹ˆè¦åšè¿™ä¸ªï¼Ÿï¼ˆç—›ç‚¹ä¸æ€è·¯ï¼‰</h2><p>åœ¨å‡†å¤‡é¢è¯•æ—¶ï¼Œæˆ‘ä»¬ç»å¸¸é‡åˆ°ä¸¤ä¸ªé—®é¢˜ï¼š</p><ol><li><strong>JD åˆ†æå¤ªç´¯</strong>ï¼šæ¯ä¸ªå²—ä½çš„æŠ€æœ¯æ ˆä¸åŒï¼Œéœ€è¦é’ˆå¯¹æ€§å¤ä¹ ã€‚</li><li><strong>çŸ¥è¯†é—å¿˜</strong>ï¼šæ˜æ˜ä»¥å‰å†™è¿‡å…³äº Docker æˆ– Redis çš„åšå®¢ç¬”è®°ï¼Œä½†é¢è¯•æ—¶ä¸€æ—¶æƒ³ä¸èµ·æ¥ç»†èŠ‚ã€‚</li></ol><p><strong>æˆ‘çš„è§£å†³æ–¹æ¡ˆ</strong>ï¼š<br>æ„å»ºä¸€ä¸ª <strong>AI Agent</strong>ã€‚</p><ol><li>å®ƒèƒ½<strong>è‡ªåŠ¨åˆ†æ</strong>æˆ‘æŠ•é€’çš„ JDï¼ˆå²—ä½æè¿°ï¼‰ï¼Œæå–æ ¸å¿ƒæŠ€æœ¯æ ˆã€‚</li><li>å®ƒæ‹¥æœ‰ä¸€ä¸ª<strong>å¤–æŒ‚å¤§è„‘ï¼ˆçŸ¥è¯†åº“ï¼‰</strong>ï¼Œå­˜å‚¨äº†æˆ‘æ‰€æœ‰çš„åšå®¢æ–‡ç« ã€‚</li><li>åœ¨ç”Ÿæˆé¢è¯•é¢˜æ—¶ï¼Œå®ƒä¼š<strong>ä¼˜å…ˆå‚è€ƒ</strong>æˆ‘çš„åšå®¢å†…å®¹ï¼Œå¹¶å‘Šè¯‰æˆ‘ï¼šâ€œè¿™ä¸ªé—®é¢˜ä½ å¯ä»¥å¤ä¹ ä½ å†™çš„è¿™ç¯‡æ–‡ç« ã€‚â€</li></ol><hr><h2 id="äºŒã€-æ ¸å¿ƒåŸç†ï¼šRAG-ä¸-Agent-çš„åä½œ">äºŒã€ æ ¸å¿ƒåŸç†ï¼šRAG ä¸ Agent çš„åä½œ</h2><p>åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬é‡‡ç”¨äº† <strong>RAG (Retrieval-Augmented Generation)</strong> æ¶æ„ã€‚</p><h3 id="1-ä»€ä¹ˆæ˜¯-RAGï¼Ÿ">1. ä»€ä¹ˆæ˜¯ RAGï¼Ÿ</h3><p>å¦‚æœæŠŠå¤§æ¨¡å‹ï¼ˆLLMï¼‰æ¯”ä½œä¸€ä¸ªâ€œè¶…çº§å­¦éœ¸â€ï¼Œé‚£ RAG å°±æ˜¯ç»™äº†å­¦éœ¸ä¸€æœ¬â€œå¼€å·è€ƒè¯•çš„ä¹¦â€ã€‚</p><ul><li><strong>LLM</strong>ï¼šè´Ÿè´£é€»è¾‘æ¨ç†ã€è¯­è¨€ç»„ç»‡ã€‚</li><li><strong>Knowledge Base</strong>ï¼šè´Ÿè´£æä¾›ç²¾å‡†çš„ã€ç§æœ‰çš„äº‹å®æ•°æ®ï¼ˆæˆ‘çš„åšå®¢ï¼‰ã€‚</li></ul><h3 id="2-åä½œæµç¨‹å›¾">2. åä½œæµç¨‹å›¾</h3><p>æ•´ä¸ªç³»ç»Ÿçš„è¿ä½œæµç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    User[ç”¨æˆ·è¾“å…¥ JD] --&gt;|1. æäº¤| Agent[æ™ºèƒ½ä½“æ ¸å¿ƒ (Service)]</span><br><span class="line">    </span><br><span class="line">    subgraph Analysis [é˜¶æ®µä¸€: æ„å›¾è¯†åˆ«]</span><br><span class="line">        Agent --&gt;|2. è§£æ JD| Parser[LLM è§£æå™¨]</span><br><span class="line">        Parser --&gt;|æå–å…³é”®è¯: Python, Docker| Keywords[æŠ€æœ¯æ ˆåˆ—è¡¨]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph Retrieval [é˜¶æ®µäºŒ: RAG æ£€ç´¢]</span><br><span class="line">        Keywords --&gt;|3. æŸ¥è¯¢å‘é‡åº“| VectorDB[(FAISS å‘é‡åº“)]</span><br><span class="line">        VectorDB --&gt;|4. è¿”å›åšå®¢ç‰‡æ®µ + æ¥æº| Context[çŸ¥è¯†åº“ä¸Šä¸‹æ–‡]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    subgraph Generation [é˜¶æ®µä¸‰: å¢å¼ºç”Ÿæˆ]</span><br><span class="line">        Context --&gt;|5. æ³¨å…¥ Prompt| Generator[LLM ç”Ÿæˆå™¨]</span><br><span class="line">        Generator --&gt;|6. ç”Ÿæˆé¢è¯•é¢˜ &amp; å¼•ç”¨æ¥æº| Output[æœ€ç»ˆæŠ¥å‘Š]</span><br><span class="line">    end</span><br></pre></td></tr></table></figure><hr><h2 id="ä¸‰ã€-å…³é”®æŠ€æœ¯å®ç°">ä¸‰ã€ å…³é”®æŠ€æœ¯å®ç°</h2><h3 id="1-æ„å»ºçŸ¥è¯†åº“-The-Embedding-Pipeline">1. æ„å»ºçŸ¥è¯†åº“ (The Embedding Pipeline)</h3><p>è¿™æ˜¯ RAG çš„åœ°åŸºã€‚æˆ‘ä»¬éœ€è¦æŠŠ Markdown æ ¼å¼çš„åšå®¢æ–‡ç« è½¬æ¢æˆè®¡ç®—æœºèƒ½ç†è§£çš„â€œå‘é‡â€ã€‚</p><p><strong>æŠ€æœ¯æ ˆ</strong>ï¼š<code>LangChain</code> + <code>BGE-Small-zh</code> + <code>FAISS</code></p><ul><li><strong>æ•°æ®æ¸…æ´— (ETL)</strong>ï¼š<br>ä½¿ç”¨ <code>MarkdownHeaderTextSplitter</code> æŒ‰ç« èŠ‚åˆ‡åˆ†æ–‡ç« ï¼Œä¿è¯è¯­ä¹‰å®Œæ•´æ€§ã€‚</li><li><strong>å‘é‡åŒ– (Embedding)</strong>ï¼š<br>æˆ‘ä»¬é€‰ç”¨äº† <strong>BAAI/bge-small-zh-v1.5</strong> æ¨¡å‹ã€‚å®ƒèƒ½å°†ä¸€æ®µæ–‡å­—è½¬æ¢ä¸º 512 ç»´çš„æµ®ç‚¹æ•°ç»„ã€‚<blockquote><p><em>åŸç†</em>ï¼šè¯­ä¹‰ç›¸è¿‘çš„å¥å­ï¼ˆå¦‚â€œDockerå®¹å™¨â€å’Œâ€œå®¹å™¨åŒ–éƒ¨ç½²â€ï¼‰ï¼Œåœ¨å‘é‡ç©ºé—´ä¸­çš„è·ç¦»éå¸¸è¿‘ã€‚</p></blockquote></li><li><strong>å­˜å‚¨ç»“æ„</strong>ï¼š<br>å­˜å…¥ FAISS çš„ä¸ä»…æ˜¯å‘é‡ï¼Œè¿˜åŒ…å« <strong>Payload</strong>ï¼ˆåŸæ–‡ï¼‰å’Œ <strong>Metadata</strong>ï¼ˆå…ƒæ•°æ®ï¼Œå¦‚æ–‡ä»¶åï¼‰ã€‚</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ ¸å¿ƒä»£ç ç‰‡æ®µï¼šå…¥åº“é€»è¾‘</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_index</span>():</span><br><span class="line">    <span class="comment"># 1. åŠ è½½åšå®¢ Markdown</span></span><br><span class="line">    docs = load_and_split_markdown(<span class="string">&quot;source/_posts&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. åˆå§‹åŒ– BGE æ¨¡å‹ (ä½¿ç”¨å›½å†…é•œåƒ)</span></span><br><span class="line">    embedding_model = HuggingFaceEmbeddings(model_name=<span class="string">&quot;BAAI/bge-small-zh-v1.5&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. å‘é‡åŒ–å¹¶å­˜å…¥ FAISS</span></span><br><span class="line">    vector_store = FAISS.from_documents(docs, embedding_model)</span><br><span class="line">    vector_store.save_local(<span class="string">&quot;blog_faiss_index&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="2-Agent-çš„å¤§è„‘ï¼šå¼‚æ­¥ç¼–æ’-Orchestration">2. Agent çš„å¤§è„‘ï¼šå¼‚æ­¥ç¼–æ’ (Orchestration)</h3><p>ä¸ºäº†è®©ç”¨æˆ·ä½“éªŒè¾¾åˆ°æè‡´ï¼ˆå¿«ï¼ï¼‰ï¼Œåç«¯ä¸èƒ½ä¸²è¡Œå¤„ç†ã€‚æˆ‘ä»¬åˆ©ç”¨ <strong>Python Asyncio</strong> å®ç°äº†å¹¶è¡Œä»»åŠ¡æµã€‚</p><ul><li><strong>æŠ€æœ¯æŒ‘æˆ˜</strong>ï¼šå¦‚ä½•åŒæ—¶è¿›è¡Œâ€œå…¬å¸èƒŒæ™¯è°ƒæŸ¥â€å’Œâ€œçŸ¥è¯†åº“æ£€ç´¢â€ï¼Ÿ</li><li><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š<code>asyncio.gather</code>ã€‚</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ ¸å¿ƒä»£ç ç‰‡æ®µï¼šå¹¶è¡Œç¼–æ’</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">generate_interview_guide</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="comment"># 1. å…ˆè§£æ JD (å‰ç½®ä¾èµ–)</span></span><br><span class="line">    jd_meta = <span class="keyword">await</span> parse_jd_async(request.jd_text)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. æ„é€ æŸ¥è¯¢ï¼šç”¨ JD é‡Œçš„æŠ€æœ¯æ ˆå»æŸ¥åšå®¢</span></span><br><span class="line">    query = <span class="string">&quot; &quot;</span>.join(jd_meta.tech_stack)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. å¹¶è¡Œæ‰§è¡Œï¼š(æŸ¥åšå®¢) &amp; (æŸ¥å…¬å¸èƒŒæ™¯) &amp; (å‡ºé€šç”¨é¢˜)</span></span><br><span class="line">    task_rag = kb_engine.search(query)</span><br><span class="line">    task_research = research_company(jd_meta.company_name)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å¹¶å‘ç­‰å¾…ç»“æœ</span></span><br><span class="line">    rag_result, company_info = <span class="keyword">await</span> asyncio.gather(task_rag, task_research)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 4. å°†æŸ¥åˆ°çš„åšå®¢å†…å®¹æ³¨å…¥ Prompt</span></span><br><span class="line">    final_report = <span class="keyword">await</span> generate_final_report(context=rag_result[<span class="string">&#x27;context&#x27;</span>])</span><br></pre></td></tr></table></figure><h3 id="3-ä¸Šä¸‹æ–‡æ³¨å…¥-Context-Injection">3. ä¸Šä¸‹æ–‡æ³¨å…¥ (Context Injection)</h3><p>è¿™æ˜¯è®© AI â€œè¯»æ‡‚â€åšå®¢çš„å…³é”®ä¸€æ­¥ã€‚æˆ‘ä»¬åŠ¨æ€æ„å»ºäº† Prompt Templateã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">prompt_template = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">ä½ æ˜¯ä¸€ä¸ªèµ„æ·±æŠ€æœ¯é¢è¯•å®˜ã€‚</span></span><br><span class="line"><span class="string">è¯·æ ¹æ®ä»¥ä¸‹ã€å‚è€ƒçŸ¥è¯†åº“ã€‘ï¼ˆè¿™æ˜¯ç”¨æˆ·çš„ä¸ªäººåšå®¢ç¬”è®°ï¼‰æ¥ç”Ÿæˆé¢è¯•é¢˜ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ã€å‚è€ƒçŸ¥è¯†åº“ã€‘ï¼š</span></span><br><span class="line"><span class="string">&#123;kb_context&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¯·åœ¨ç”Ÿæˆé¢˜ç›®æ—¶ï¼Œæ˜ç¡®æŒ‡å‡ºç”¨æˆ·åœ¨åšå®¢ä¸­å¯¹è¯¥çŸ¥è¯†ç‚¹çš„ç†è§£ã€‚</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure><hr><h2 id="å››ã€-é‡åˆ°çš„å‘ä¸ä¼˜åŒ–-Troubleshooting">å››ã€ é‡åˆ°çš„å‘ä¸ä¼˜åŒ– (Troubleshooting)</h2><p>åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è§£å†³äº†å‡ ä¸ªå…¸å‹çš„å·¥ç¨‹é—®é¢˜ï¼š</p><ol><li><p><strong>æ¨¡å‹ä¸‹è½½å¡é¡¿</strong>ï¼š</p><ul><li><em>é—®é¢˜</em>ï¼šHuggingFace å›½å†…æ— æ³•ç›´è¿ã€‚</li><li><em>è§£å†³</em>ï¼šåœ¨ä»£ç é¡¶éƒ¨è®¾ç½® <code>os.environ['HF_ENDPOINT'] = 'https://hf-mirror.com'</code> å¼ºåˆ¶èµ°é•œåƒã€‚</li></ul></li><li><p><strong>Pydantic æ•°æ®æ ¡éªŒé”™è¯¯</strong>ï¼š</p><ul><li><em>é—®é¢˜</em>ï¼šæœ‰æ—¶å€™ RAG æ²¡æŸ¥åˆ°æ•°æ®ï¼Œè¿”å› <code>None</code>ï¼Œå¯¼è‡´æ¥å£æŠ¥é”™ã€‚</li><li><em>è§£å†³</em>ï¼šåœ¨ Schema å®šä¹‰ä¸­ä½¿ç”¨ <code>Optional[List[str]] = []</code>ï¼Œå¢å¼ºç³»ç»Ÿçš„é²æ£’æ€§ã€‚</li></ul></li><li><p><strong>å¤§æ¨¡å‹â€œå¹»è§‰â€</strong>ï¼š</p><ul><li><em>é—®é¢˜</em>ï¼šAI ç¼–é€ åšå®¢é‡Œæ²¡æœ‰çš„å†…å®¹ã€‚</li><li><em>è§£å†³</em>ï¼šåœ¨ Prompt ä¸­åŠ å…¥çº¦æŸâ€”â€”â€œä»…ä¾æ®å‚è€ƒçŸ¥è¯†åº“å›ç­”ï¼Œå¦‚æœçŸ¥è¯†åº“æœªæåŠï¼Œè¯·å¿½ç•¥â€ã€‚</li></ul></li></ol><hr><h2 id="äº”ã€-æœ€ç»ˆæ•ˆæœ">äº”ã€ æœ€ç»ˆæ•ˆæœ</h2><p>å½“ç”¨æˆ·è¾“å…¥ä¸€ä¸ªåŒ…å« <strong>â€œPython, Dockerâ€</strong> çš„ JD æ—¶ï¼š</p><ol><li><strong>åç«¯</strong> è¿…é€Ÿå®šä½åˆ°æœ¬åœ°åšå®¢ä¸­çš„ <code>Dockeréƒ¨ç½²ç¬”è®°.md</code> å’Œ <code>Pythonå¹¶å‘ç¼–ç¨‹.md</code>ã€‚</li><li><strong>AI</strong> ç”Ÿæˆçš„é¢è¯•æŒ‡å—ä¸­å†™é“ï¼š<blockquote><p><strong>Q1: è¯·è°ˆè°ˆ Docker çš„éš”ç¦»æœºåˆ¶ï¼Ÿ</strong><br><em>å‚è€ƒå›ç­”è¦ç‚¹</em>ï¼šæ ¹æ®ä½ çš„åšå®¢ <strong>ã€Š<a href="http://xn--Docker-gl3pp3z6v2awsl.md">Dockeréƒ¨ç½²ç¬”è®°.md</a>ã€‹</strong>ï¼Œä½ æ›¾æ€»ç»“è¿‡ Namespace è´Ÿè´£èµ„æºéš”ç¦»ï¼ŒCgroups è´Ÿè´£èµ„æºé™åˆ¶â€¦</p></blockquote></li><li><strong>å‰ç«¯</strong> ç•Œé¢åº•éƒ¨ä¼šå±•ç¤ºï¼š<blockquote><p>ğŸ“š <strong>çŸ¥è¯†åº“å¼•ç”¨</strong>ï¼š</p><ul><li>ğŸ“„ <code>Dockeréƒ¨ç½²ç¬”è®°.md</code></li></ul></blockquote></li></ol><p>è¿™ä¸ä»…æ˜¯ä¸€ä¸ªé¢è¯•é¢˜ç”Ÿæˆå™¨ï¼Œæ›´æ˜¯ä¸€ä¸ª<strong>å”¤é†’æ²‰ç¡çŸ¥è¯†çš„ç¬¬äºŒå¤§è„‘</strong>ã€‚</p><hr><h2 id="å…­ã€-æ€»ç»“">å…­ã€ æ€»ç»“</h2><p>æœ¬é¡¹ç›®é€šè¿‡ <strong>FastAPI</strong> æ„å»ºé«˜æ€§èƒ½åç«¯ï¼Œ<strong>LangChain</strong> å¤„ç†å¤æ‚çš„ LLM é€»è¾‘ï¼Œ<strong>FAISS</strong> å®ç°æ¯«ç§’çº§çŸ¥è¯†æ£€ç´¢ã€‚å®ƒå±•ç¤ºäº† <strong>LLM Ops (å¤§æ¨¡å‹å·¥ç¨‹åŒ–)</strong> çš„æ ¸å¿ƒæ€è·¯ï¼š<strong>ä¸ä»…è¦ä¼šè°ƒ APIï¼Œæ›´è¦æ‡‚å¾—å¦‚ä½•ç®¡ç†æ•°æ®æµå’Œä¸Šä¸‹æ–‡ã€‚</strong></p><p>å¦‚æœä½ ä¹Ÿæƒ³ä¸ºè‡ªå·±çš„çŸ¥è¯†åº“è£…ä¸Š AI å¼•æ“ï¼Œæ¬¢è¿å‚è€ƒæˆ‘çš„ GitHub ä»“åº“ï¼š[<a href="https://github.com/caozhaoqi/jd_agent">https://github.com/caozhaoqi/jd_agent</a>]</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;å®æˆ˜ï¼šå¦‚ä½•è®© AI â€œè¯»æ‡‚â€æˆ‘çš„åšå®¢ï¼Ÿâ€”â€”åŸºäº RAG ä¸ Agent åä½œçš„æ™ºèƒ½é¢è¯•åŠ©æ‰‹å¼€å‘æŒ‡å—&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;æ‘˜è¦&lt;/strong&gt;ï¼šåœ¨å¤§æ¨¡å‹æ—¶ä»£ï¼Œå¦‚ä½•è®© AI ä¸ä»…å…·å¤‡é€šç”¨çŸ¥è¯†ï¼Œè¿˜èƒ½åˆ©ç”¨æˆ‘ä»¬ç§æœ‰çš„æ•°æ®ï¼ˆå¦‚ä¸ªäººåšå®¢ã€æŠ€æœ¯ç¬”è®°</summary>
      
    
    
    
    
    <category term="python" scheme="https://caozhaoqi.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäº FastAPI + LangChain çš„ç®€å•agentå®ç°</title>
    <link href="https://caozhaoqi.github.io/2025/11/26/agent-research-llm/"/>
    <id>https://caozhaoqi.github.io/2025/11/26/agent-research-llm/</id>
    <published>2025-11-26T13:26:13.000Z</published>
    <updated>2025-11-26T13:53:49.049Z</updated>
    
    <content type="html"><![CDATA[<p><strong>GitHub ä»“åº“</strong>: <a href="https://github.com/caozhaoqi/jd_agent">https://github.com/caozhaoqi/jd_agent</a></p><blockquote><p><strong>æ‘˜è¦</strong>ï¼šåœ¨ AI Agent å¼€å‘ä¸­ï¼Œå¦‚ä½•å¹³è¡¡å¤§æ¨¡å‹çš„ç”Ÿæˆè´¨é‡ä¸æ¥å£çš„å“åº”é€Ÿåº¦ï¼Ÿæœ¬æ–‡å°†è¯¦ç»†æ‹†è§£ <code>jd_agent</code> é¡¹ç›®ã€‚è¿™æ˜¯ä¸€ä¸ªåŸºäºå²—ä½æè¿°ï¼ˆJDï¼‰è‡ªåŠ¨ç”Ÿæˆç»“æ„åŒ–é¢è¯•æŒ‡å—çš„æ™ºèƒ½ä½“ã€‚æˆ‘ä»¬é‡‡ç”¨ <strong>FastAPI</strong> ä½œä¸ºåç«¯ï¼Œåˆ©ç”¨ <strong>LangChain</strong> è¿›è¡Œé€»è¾‘ç¼–æ’ï¼Œå¹¶é€šè¿‡ <strong>Asyncio</strong> å®ç°å¹¶è¡Œæ¨ç†ï¼Œå°†ä»»åŠ¡è€—æ—¶ä» 30s+ ä¼˜åŒ–è‡³ 10s çº§ã€‚æ­¤å¤–ï¼Œæœ¬æ–‡è¿˜è®°å½•äº†ä» OpenAI è¿ç§»è‡³ DeepSeek çš„å®æˆ˜ç»éªŒåŠå·¥ç¨‹è¸©å‘è®°å½•ã€‚</p></blockquote><hr><h2 id="1-é¡¹ç›®èƒŒæ™¯ä¸ç—›ç‚¹">1. é¡¹ç›®èƒŒæ™¯ä¸ç—›ç‚¹</h2><p>åœ¨æ±‚èŒè¿‡ç¨‹ä¸­ï¼Œé’ˆå¯¹æ¯ä¸ªå²—ä½è¿›è¡Œæ·±åº¦å‡†å¤‡ï¼ˆåˆ†ææŠ€æœ¯æ ˆã€é¢„æµ‹é¢è¯•é¢˜ã€è°ƒç ”å…¬å¸èƒŒæ™¯ï¼‰æ˜¯éå¸¸è€—æ—¶çš„ã€‚<br>ä¼ ç»Ÿçš„ ChatGPT äº¤äº’æ–¹å¼è™½ç„¶å¯è¡Œï¼Œä½†å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š</p><ul><li><strong>Prompt é‡å¤åŠ³åŠ¨</strong>ï¼šæ¯æ¬¡éƒ½è¦è¾“å…¥ä¸€å¤§æ®µ Promptã€‚</li><li><strong>è¾“å‡ºéç»“æ„åŒ–</strong>ï¼šç”Ÿæˆçš„æ–‡æœ¬éš¾ä»¥ç›´æ¥ç”¨äºåç»­çš„æ•°æ®å­˜å‚¨æˆ–å‰ç«¯å±•ç¤ºã€‚</li><li><strong>å“åº”ç¼“æ…¢</strong>ï¼šåˆ†æ JDã€å‡ºæŠ€æœ¯é¢˜ã€å‡º HR é¢˜ã€èƒŒè°ƒå…¬å¸ï¼Œå¦‚æœä¸²è¡Œæ‰§è¡Œï¼Œç­‰å¾…æ—¶é—´æé•¿ã€‚</li></ul><p>æœ¬é¡¹ç›®æ—¨åœ¨é€šè¿‡<strong>å·¥ç¨‹åŒ–</strong>æ‰‹æ®µè§£å†³ä¸Šè¿°é—®é¢˜ï¼Œæ„å»ºä¸€ä¸ª<strong>å¯æ‰©å±•ã€é«˜å¹¶å‘ã€ç»“æ„åŒ–è¾“å‡º</strong>çš„ AI Agent åç«¯ã€‚</p><hr><h2 id="2-æŠ€æœ¯æ¶æ„è®¾è®¡-System-Architecture">2. æŠ€æœ¯æ¶æ„è®¾è®¡ (System Architecture)</h2><p>ä¸ºäº†ä¿è¯ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ï¼Œæœ¬é¡¹ç›®é‡‡ç”¨äº†<strong>åˆ†å±‚æ¶æ„ (Layered Architecture)</strong>ã€‚</p><h3 id="2-1-æ¶æ„åˆ†å±‚å›¾">2.1 æ¶æ„åˆ†å±‚å›¾</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    Client[å‰ç«¯/å®¢æˆ·ç«¯] --&gt;|HTTP/SSE| API[API Interface Layer]</span><br><span class="line">    </span><br><span class="line">    subgraph Backend [FastAPI Backend]</span><br><span class="line">        API --&gt; Service[Service Layer (Orchestration)]</span><br><span class="line">        </span><br><span class="line">        subgraph Parallel_Execution [å¼‚æ­¥å¹¶è¡Œæ‰§è¡ŒåŒº]</span><br><span class="line">            Task_A[JD Meta Parser]</span><br><span class="line">            Task_B[Tech Question Generator]</span><br><span class="line">            Task_C[Company Research Agent]</span><br><span class="line">        end</span><br><span class="line">        </span><br><span class="line">        Service --&gt; Task_A</span><br><span class="line">        Task_A --&gt; Task_B</span><br><span class="line">        Task_A --&gt; Task_C</span><br><span class="line">        </span><br><span class="line">        Task_B &amp; Task_C --&gt; Task_D[HR Question Generator]</span><br><span class="line">        </span><br><span class="line">        Task_B --&gt; Chains[LangChain Logic]</span><br><span class="line">        Task_C --&gt; Chains</span><br><span class="line">        </span><br><span class="line">        Chains --&gt; LLM_Factory[LLM Factory (OpenAI/DeepSeek)]</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    Service --&gt;|Structured JSON| Client</span><br></pre></td></tr></table></figure><h3 id="2-2-æ ¸å¿ƒç»„ä»¶">2.2 æ ¸å¿ƒç»„ä»¶</h3><ul><li><strong>Web æ¡†æ¶</strong>: <code>FastAPI</code> (åˆ©ç”¨å…¶åŸç”Ÿå¼‚æ­¥ç‰¹æ€§å¤„ç† IO å¯†é›†å‹ä»»åŠ¡)ã€‚</li><li><strong>LLM ç¼–æ’</strong>: <code>LangChain</code> (ç®¡ç† Promptã€Chain å’Œ OutputParser)ã€‚</li><li><strong>æ•°æ®éªŒè¯</strong>: <code>Pydantic</code> (å¼ºåˆ¶ LLM è¾“å‡ºç¬¦åˆ Schema çš„ JSON)ã€‚</li><li><strong>å¹¶å‘æ§åˆ¶</strong>: <code>Python Asyncio</code> (å®ç°å¤š Chain å¹¶è¡Œè°ƒç”¨)ã€‚</li><li><strong>æ¨¡å‹å±‚</strong>: æ”¯æŒ <code>OpenAI</code> åè®®ï¼Œå®æµ‹å®Œç¾å…¼å®¹ <code>DeepSeek-V3</code>ã€‚</li></ul><hr><h2 id="3-æ ¸å¿ƒå®ç°ç»†èŠ‚-Implementation-Details">3. æ ¸å¿ƒå®ç°ç»†èŠ‚ (Implementation Details)</h2><h3 id="3-1-å¼ºåˆ¶ç»“æ„åŒ–è¾“å‡º-Structured-Output">3.1 å¼ºåˆ¶ç»“æ„åŒ–è¾“å‡º (Structured Output)</h3><p>å¤§æ¨¡å‹å¤©ç”Ÿå–œæ¬¢â€œèŠå¤©â€ï¼Œä¸ºäº†è®©å®ƒè¾“å‡º JSONï¼Œæˆ‘ä»¬æ‘’å¼ƒäº†ä¸ç¨³å®šçš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œè½¬è€Œä½¿ç”¨ LangChain çš„ <code>PydanticOutputParser</code>ã€‚</p><p><strong>Schema å®šä¹‰ (<code>schemas/interview.py</code>):</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">InterviewReport</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    meta: JDMetaData</span><br><span class="line">    tech_questions: <span class="type">List</span>[InterviewQuestion]</span><br><span class="line">    hr_questions: <span class="type">List</span>[InterviewQuestion]</span><br><span class="line">    <span class="comment"># ä½¿ç”¨ Optional å¤„ç†éå¿…å¡«é¡¹ï¼Œå¢å¼ºé²æ£’æ€§</span></span><br><span class="line">    system_design_question: <span class="type">Optional</span>[InterviewQuestion] = <span class="literal">None</span></span><br></pre></td></tr></table></figure><p><strong>Chain å®ç° (<code>chains/tech_gen.py</code>):</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">parser = PydanticOutputParser(pydantic_object=QuestionList)</span><br><span class="line">prompt = ChatPromptTemplate.from_template(</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ...</span></span><br><span class="line"><span class="string">    è¯·ä¸¥æ ¼æŒ‰ç…§ JSON æ ¼å¼è¾“å‡º:</span></span><br><span class="line"><span class="string">    &#123;format_instructions&#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># æ³¨å…¥ Pydantic ç”Ÿæˆçš„ Schema æŒ‡ä»¤</span></span><br><span class="line">chain = prompt | llm | parser</span><br></pre></td></tr></table></figure><h3 id="3-2-å¼‚æ­¥å¹¶å‘ç¼–æ’-Asyncio-Optimization">3.2 å¼‚æ­¥å¹¶å‘ç¼–æ’ (Asyncio Optimization)</h3><p>è¿™æ˜¯æœ¬é¡¹ç›®æ€§èƒ½æå‡çš„å…³é”®ã€‚</p><ul><li><strong>ä¸²è¡Œæ¨¡å¼</strong>ï¼šè§£æ JD (5s) -&gt; æŸ¥å…¬å¸ (10s) -&gt; å‡ºæŠ€æœ¯é¢˜ (10s) -&gt; å‡º HR é¢˜ (5s) = <strong>30s+</strong></li><li><strong>å¹¶è¡Œæ¨¡å¼</strong>ï¼šè§£æ JD (5s) -&gt; [æŸ¥å…¬å¸ | å‡ºæŠ€æœ¯é¢˜] (åŒæ—¶è¿›è¡Œ, å–æœ€å¤§å€¼ 10s) -&gt; å‡º HR é¢˜ = <strong>çº¦ 15s</strong></li></ul><p><strong>Service å±‚å®ç° (<code>services/interview_service.py</code>):</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">generate_interview_guide</span>(<span class="params">request: JDRequest</span>):</span><br><span class="line">    <span class="comment"># 1. å‰ç½®ä¾èµ–ï¼šå¿…é¡»å…ˆè§£æ JD</span></span><br><span class="line">    jd_meta = <span class="keyword">await</span> parse_jd_async(request.jd_text)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. æ„é€ å¹¶è¡Œä»»åŠ¡ (Fire tasks)</span></span><br><span class="line">    <span class="comment"># æŠ€æœ¯é¢˜ä¸ä¾èµ–å…¬å¸èƒŒæ™¯</span></span><br><span class="line">    task_tech = generate_tech_async(jd_meta.tech_stack, jd_meta.years_required)</span><br><span class="line">    <span class="comment"># å…¬å¸èƒŒè°ƒæ˜¯ç½‘ç»œ IO å¯†é›†å‹</span></span><br><span class="line">    task_research = research_company(jd_meta.company_name)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. æ ¸å¿ƒï¼šå¹¶å‘ç­‰å¾…</span></span><br><span class="line">    tech_qs, company_info = <span class="keyword">await</span> asyncio.gather(task_tech, task_research)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 4. åç½®ä¾èµ–ï¼šHR é¢˜ä¾èµ–å…¬å¸èƒŒæ™¯</span></span><br><span class="line">    hr_qs = <span class="keyword">await</span> generate_hr_async(jd_meta.soft_skills, company_info)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> InterviewReport(...)</span><br></pre></td></tr></table></figure><h3 id="3-3-å…¼å®¹å¤šæ¨¡å‹çš„-LLM-å·¥å‚">3.3 å…¼å®¹å¤šæ¨¡å‹çš„ LLM å·¥å‚</h3><p>ä¸ºäº†åœ¨å¼€å‘é˜¶æ®µèŠ‚çœæˆæœ¬ï¼ˆä½¿ç”¨ DeepSeekï¼‰ï¼Œåœ¨ç”Ÿäº§é˜¶æ®µè¿½æ±‚ç¨³å®šï¼ˆä½¿ç”¨ OpenAIï¼‰ï¼Œæˆ‘ä»¬è®¾è®¡äº†å·¥å‚æ¨¡å¼ã€‚</p><p><strong>é…ç½®è§£è€¦ (<code>core/config.py</code>):</strong><br>é€šè¿‡ <code>.env</code> æ–‡ä»¶åŠ¨æ€åˆ‡æ¢åº•åº§ï¼Œæ— éœ€ä¿®æ”¹ä¸šåŠ¡ä»£ç ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Settings</span>(<span class="title class_ inherited__">BaseSettings</span>):</span><br><span class="line">    OPENAI_API_KEY: <span class="built_in">str</span></span><br><span class="line">    OPENAI_API_BASE: <span class="built_in">str</span> = <span class="string">&quot;https://api.deepseek.com&quot;</span> <span class="comment"># é»˜è®¤æŒ‡å‘ DeepSeek</span></span><br><span class="line">    MODEL_NAME: <span class="built_in">str</span> = <span class="string">&quot;deepseek-chat&quot;</span></span><br></pre></td></tr></table></figure><hr><h2 id="4-å·¥ç¨‹åŒ–è¸©å‘ä¸è§£å†³æ–¹æ¡ˆ-Troubleshooting">4. å·¥ç¨‹åŒ–è¸©å‘ä¸è§£å†³æ–¹æ¡ˆ (Troubleshooting)</h2><p>åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬é‡åˆ°äº†æ•°ä¸ªçœŸå®çš„å·¥ç¨‹æŒ‘æˆ˜ï¼Œä»¥ä¸‹æ˜¯æ’æŸ¥è®°å½•ã€‚</p><h3 id="å‘ä½-1ï¼šAPI-ä½™é¢ä¸é‰´æƒæ··æ·†-429-vs-402">å‘ä½ 1ï¼šAPI ä½™é¢ä¸é‰´æƒæ··æ·† (429 vs 402)</h3><ul><li><strong>ç°è±¡</strong>: ç¨‹åºå´©æºƒï¼ŒæŠ¥é”™ <code>openai.RateLimitError: Error code: 429</code> æˆ– <code>402 Payment Required</code>ã€‚</li><li><strong>åˆ†æ</strong>:<ul><li><code>429</code> é€šå¸¸æŒ‡é€Ÿç‡é™åˆ¶ï¼Œä½† OpenAI åœ¨ä½™é¢ä¸è¶³æ—¶ä¹Ÿä¼šæŠ¥è¿™ä¸ªé”™ï¼ˆ<code>insufficient_quota</code>ï¼‰ã€‚</li><li><code>402</code> æ˜¯æ˜ç¡®çš„ä½™é¢ä¸ºé›¶ã€‚</li></ul></li><li><strong>è§£å†³</strong>:<ul><li>ä¸è¦æ­»ç£•ä»£ç é€»è¾‘ã€‚</li><li>åˆ‡æ¢è‡³ <strong>DeepSeek</strong>ï¼ˆå……å€¼ 10 å…ƒäººæ°‘å¸å¯ç”¨å¾ˆä¹…ï¼‰æˆ– <strong>SiliconFlow</strong>ï¼ˆå…è´¹é¢åº¦ï¼‰ã€‚</li><li>ä¿®æ”¹ <code>.env</code> å³å¯è§£å†³ã€‚</li></ul></li></ul><h3 id="å‘ä½-2ï¼šPydantic-å­—æ®µæ ¡éªŒå¼‚å¸¸">å‘ä½ 2ï¼šPydantic å­—æ®µæ ¡éªŒå¼‚å¸¸</h3><ul><li><strong>ç°è±¡</strong>: <code>ValidationError: system_design_question Input should be a valid dictionary</code>ã€‚</li><li><strong>åˆ†æ</strong>: ä¸šåŠ¡é€»è¾‘ä¸­æŸäº›æƒ…å†µä¸‹æœªç”Ÿæˆç³»ç»Ÿè®¾è®¡é¢˜ï¼Œè¿”å›äº† <code>None</code>ï¼Œä½† Schema å®šä¹‰é»˜è®¤ä¸ºå¿…å¡«ã€‚</li><li><strong>è§£å†³</strong>: ä½¿ç”¨ <code>Optional</code> ç±»å‹æç¤ºã€‚<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line">system_design_question: <span class="type">Optional</span>[InterviewQuestion] = <span class="literal">None</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="å‘ä½-3ï¼šSSL-è¯ä¹¦è­¦å‘Š-Mac-ç¯å¢ƒ">å‘ä½ 3ï¼šSSL è¯ä¹¦è­¦å‘Š (Mac ç¯å¢ƒ)</h3><ul><li><strong>ç°è±¡</strong>: <code>NotOpenSSLWarning: urllib3 v2 only supports OpenSSL 1.1.1+</code></li><li><strong>åˆ†æ</strong>: macOS è‡ªå¸¦çš„ LibreSSL ç‰ˆæœ¬è¿‡ä½ï¼Œä¸æ–°ç‰ˆ <code>urllib3</code> ä¸å…¼å®¹ã€‚</li><li><strong>è§£å†³</strong>: é™çº§ urllib3 æˆ–ä½¿ç”¨ Homebrew å‡çº§ OpenSSLã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install <span class="string">&quot;urllib3&lt;2.0&quot;</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="å‘ä½-4ï¼šNginx-åå‘ä»£ç†è¶…æ—¶-504-Gateway-Time-out">å‘ä½ 4ï¼šNginx åå‘ä»£ç†è¶…æ—¶ (504 Gateway Time-out)</h3><ul><li><strong>ç°è±¡</strong>: çˆ¬è™«æˆ–é•¿æ–‡æœ¬ç”Ÿæˆä»»åŠ¡è€—æ—¶è¶…è¿‡ 60sï¼Œå‰ç«¯æ”¶åˆ° 504 é”™è¯¯ã€‚</li><li><strong>åˆ†æ</strong>: Nginx é»˜è®¤ <code>proxy_read_timeout</code> ä¸º 60sã€‚</li><li><strong>è§£å†³</strong>: åœ¨ Nginx é…ç½®ä¸­é’ˆå¯¹ API è·¯ç”±å¢åŠ è¶…æ—¶æ—¶é—´ã€‚<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /api/ &#123;</span><br><span class="line">    <span class="attribute">proxy_read_timeout</span> <span class="number">600s</span>;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:8000;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h2 id="5-æ€»ç»“ä¸å±•æœ›">5. æ€»ç»“ä¸å±•æœ›</h2><p><code>jd_agent</code> é¡¹ç›®å±•ç¤ºäº†å¦‚ä½•å°†ä¸€ä¸ªç®€å•çš„ Prompt äº¤äº’è½¬åŒ–ä¸ºä¸€ä¸ª<strong>å·¥ä¸šçº§çš„åç«¯æœåŠ¡</strong>ã€‚</p><p><strong>æ ¸å¿ƒæ”¶ç›Š</strong>:</p><ol><li><strong>æ•ˆç‡æå‡</strong>: å¹¶è¡Œå¤„ç†ä½¿å“åº”é€Ÿåº¦æå‡ <strong>300%</strong>ã€‚</li><li><strong>æˆæœ¬é™ä½</strong>: é€šè¿‡ LLM å·¥å‚æ¨¡å¼åˆ‡æ¢è‡³ DeepSeekï¼ŒToken æˆæœ¬é™ä½ <strong>90%</strong>ã€‚</li><li><strong>ç¨³å®šæ€§</strong>: å¼ºç±»å‹æ ¡éªŒå’Œé‡è¯•æœºåˆ¶ä¿è¯äº†æœåŠ¡çš„é²æ£’æ€§ã€‚</li></ol><p><strong>åç»­è§„åˆ’</strong>:</p><ul><li>å¼•å…¥ <strong>Redis</strong> ç¼“å­˜ JD è§£æç»“æœï¼Œé¿å…é‡å¤æ‰£è´¹ã€‚</li><li>é›†æˆ <strong>Celery</strong> å¤„ç†è¶…é•¿è€—æ—¶çš„ç³»ç»Ÿè®¾è®¡é¢˜ç”Ÿæˆã€‚</li><li>å¼€å‘ <strong>React/Next.js</strong> å‰ç«¯ï¼Œå®ç°æµå¼ Markdown æ¸²æŸ“ã€‚</li></ul><hr><p><em>å¦‚æœä½ è§‰å¾—è¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿åœ¨ GitHub ä¸Šç‚¹ä¸ª Star â­ï¸ï¼</em></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;strong&gt;GitHub ä»“åº“&lt;/strong&gt;: &lt;a href=&quot;https://github.com/caozhaoqi/jd_agent&quot;&gt;https://github.com/caozhaoqi/jd_agent&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p</summary>
      
    
    
    
    
    <category term="python" scheme="https://caozhaoqi.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>å®ç°é«˜å¯ç”¨ MySQL é›†ç¾¤</title>
    <link href="https://caozhaoqi.github.io/2025/09/30/mysql-cluster-use/"/>
    <id>https://caozhaoqi.github.io/2025/09/30/mysql-cluster-use/</id>
    <published>2025-09-30T02:18:54.000Z</published>
    <updated>2025-11-25T15:05:10.334Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å‡†å¤‡é˜¶æ®µï¼šé¡¹ç›®ç»“æ„">å‡†å¤‡é˜¶æ®µï¼šé¡¹ç›®ç»“æ„</h3><blockquote><p>é¦–å…ˆï¼Œåœ¨æ‚¨çš„æœåŠ¡å™¨ä¸Šåˆ›å»ºä¸€ä¸ªé¡¹ç›®æ–‡ä»¶å¤¹ï¼Œç»“æ„å¦‚ä¸‹ï¼š</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql_cluster/</span><br><span class="line">â”œâ”€â”€ docker-compose.yml</span><br><span class="line">â”œâ”€â”€ proxysql/</span><br><span class="line">â”‚   â””â”€â”€ proxysql.cnf</span><br><span class="line">â””â”€â”€ mysql/</span><br><span class="line">    â”œâ”€â”€ master/</span><br><span class="line">    â”‚   â””â”€â”€ conf/</span><br><span class="line">    â”‚       â””â”€â”€ master.cnf</span><br><span class="line">    â”œâ”€â”€ slave1/</span><br><span class="line">    â”‚   â””â”€â”€ conf/</span><br><span class="line">    â”‚       â””â”€â”€ slave1.cnf</span><br><span class="line">    â””â”€â”€ slave2/</span><br><span class="line">        â””â”€â”€ conf/</span><br><span class="line">            â””â”€â”€ slave2.cnf</span><br></pre></td></tr></table></figure><h3 id="é˜¶æ®µä¸€ï¼šç¼–å†™é…ç½®æ–‡ä»¶">é˜¶æ®µä¸€ï¼šç¼–å†™é…ç½®æ–‡ä»¶</h3><h4 id="1-ä¸»åº“é…ç½®-mysql-master-conf-master-cnf">1. ä¸»åº“é…ç½® (<code>mysql/master/conf/master.cnf</code>)</h4><p>è¿™ä¸ªæ–‡ä»¶å®šä¹‰äº†ä¸»åº“çš„ç‰¹å®šé…ç½®ã€‚</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">server-id</span>               = <span class="number">100</span></span><br><span class="line"><span class="attr">log-bin</span>                 = /var/lib/mysql/mysql-bin</span><br><span class="line"><span class="attr">gtid-mode</span>               = <span class="literal">ON</span></span><br><span class="line"><span class="attr">enforce-gtid-consistency</span>= <span class="literal">ON</span></span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„</strong>ï¼šæˆ‘ä»¬ä½¿ç”¨äº† <code>GTID</code> æ¨¡å¼ï¼Œè¿™æ˜¯æ¯”ä¼ ç»ŸåŸºäº <code>File</code> å’Œ <code>Position</code> æ›´ç°ä»£ã€æ›´å¯é çš„å¤åˆ¶æ–¹å¼ã€‚</p><h4 id="2-ä»åº“é…ç½®-mysql-slave1-conf-slave1-cnf-å’Œ-slave2-cnf">2. ä»åº“é…ç½® (<code>mysql/slave1/conf/slave1.cnf</code> å’Œ <code>slave2.cnf</code>)</h4><p>ä¸¤ä¸ªä»åº“çš„é…ç½®ç±»ä¼¼ï¼Œåªéœ€æ›´æ”¹ <code>server-id</code>ã€‚</p><p><strong><code>slave1.cnf</code>:</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">server-id</span>               = <span class="number">101</span></span><br><span class="line"><span class="attr">gtid-mode</span>               = <span class="literal">ON</span></span><br><span class="line"><span class="attr">enforce-gtid-consistency</span>= <span class="literal">ON</span></span><br><span class="line"><span class="attr">read-only</span>               = <span class="number">1</span></span><br></pre></td></tr></table></figure><p><strong><code>slave2.cnf</code>:</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">server-id</span>               = <span class="number">102</span></span><br><span class="line"><span class="attr">gtid-mode</span>               = <span class="literal">ON</span></span><br><span class="line"><span class="attr">enforce-gtid-consistency</span>= <span class="literal">ON</span></span><br><span class="line"><span class="attr">read-only</span>               = <span class="number">1</span></span><br></pre></td></tr></table></figure><h4 id="3-ProxySQL-é…ç½®-proxysql-proxysql-cnf">3. ProxySQL é…ç½® (<code>proxysql/proxysql.cnf</code>)</h4><p>è¿™ä¸ªæ–‡ä»¶ç”¨äºåˆå§‹åŒ– ProxySQL çš„é…ç½®ã€‚</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">admin_variables</span>=</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">admin_credentials</span>=<span class="string">&quot;admin:admin&quot;</span></span><br><span class="line">    <span class="attr">mysql_ifaces</span>=<span class="string">&quot;0.0.0.0:6032&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attr">mysql_variables</span>=</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">connect_timeout_server</span>=<span class="number">3000</span></span><br><span class="line">    <span class="attr">monitor_username</span>=<span class="string">&quot;monitor_user&quot;</span></span><br><span class="line">    <span class="attr">monitor_password</span>=<span class="string">&quot;monitor_password&quot;</span></span><br><span class="line">    <span class="attr">monitor_connect_timeout</span>=<span class="number">2000</span></span><br><span class="line">    <span class="attr">monitor_ping_timeout</span>=<span class="number">1000</span></span><br><span class="line">    <span class="attr">monitor_read_only_interval</span>=<span class="number">1000</span></span><br><span class="line">    <span class="attr">monitor_read_only_timeout</span>=<span class="number">1000</span></span><br><span class="line">    <span class="attr">commands_stats</span>=<span class="string">&quot;enabled&quot;</span></span><br><span class="line">    <span class="attr">connect_timeout_server_max</span>=<span class="number">10000</span></span><br><span class="line">    <span class="attr">stacksize</span>=<span class="number">1048576</span></span><br><span class="line">    <span class="attr">threads</span>=<span class="number">4</span></span><br><span class="line">    <span class="attr">max_connections</span>=<span class="number">2048</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„</strong>ï¼šè¿™é‡Œæˆ‘ä»¬å®šä¹‰äº† ProxySQL çš„ç®¡ç†ç”¨æˆ· (<code>admin:admin</code>) å’Œä¸€ä¸ªç”¨äºç›‘æ§åç«¯ MySQL å¥åº·çŠ¶æ€çš„ç›‘æ§ç”¨æˆ· (<code>monitor_user:monitor_password</code>)ã€‚</p><h4 id="4-Docker-Compose-æ–‡ä»¶-docker-compose-yml">4. Docker Compose æ–‡ä»¶ (<code>docker-compose.yml</code>)</h4><p>è¿™æ˜¯æ•´ä¸ªæ¶æ„çš„æ ¸å¿ƒç¼–æ’æ–‡ä»¶ã€‚å®ƒå®šä¹‰äº†æ‰€æœ‰çš„æœåŠ¡ã€ç½‘ç»œå’Œæ•°æ®å·ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="comment"># ä¸»æ•°æ®åº“</span></span><br><span class="line">  <span class="attr">mysql_master:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:8.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mysql_master</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">your_root_password</span></span><br><span class="line">      <span class="attr">MYSQL_DATABASE:</span> <span class="string">my_app_db</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./mysql/master/conf:/etc/mysql/conf.d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql_master_data:/var/lib/mysql</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql_cluster_net</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ä»æ•°æ®åº“1</span></span><br><span class="line">  <span class="attr">mysql_slave1:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:8.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mysql_slave1</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">your_root_password</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./mysql/slave1/conf:/etc/mysql/conf.d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql_slave1_data:/var/lib/mysql</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql_cluster_net</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql_master</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ä»æ•°æ®åº“2</span></span><br><span class="line">  <span class="attr">mysql_slave2:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:8.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mysql_slave2</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">your_root_password</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./mysql/slave2/conf:/etc/mysql/conf.d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql_slave2_data:/var/lib/mysql</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql_cluster_net</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql_master</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ProxySQL ä¸­é—´ä»¶</span></span><br><span class="line">  <span class="attr">proxysql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">proxysql/proxysql:2.4.4</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">proxysql</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6032:6032&quot;</span> <span class="comment"># ç®¡ç†ç«¯å£</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6033:6033&quot;</span> <span class="comment"># å®¢æˆ·ç«¯è¿æ¥ç«¯å£</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./proxysql/proxysql.cnf:/etc/proxysql.cnf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">proxysql_data:/var/lib/proxysql</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql_cluster_net</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql_master</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql_slave1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql_slave2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰æ•°æ®å·</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">mysql_master_data:</span></span><br><span class="line">  <span class="attr">mysql_slave1_data:</span></span><br><span class="line">  <span class="attr">mysql_slave2_data:</span></span><br><span class="line">  <span class="attr">proxysql_data:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ç½‘ç»œ</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">mysql_cluster_net:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure><p><strong>è¯·åŠ¡å¿…å°† <code>your_root_password</code> æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„å¼ºå¯†ç ã€‚</strong></p><h3 id="é˜¶æ®µäºŒï¼šå¯åŠ¨å’Œé…ç½®é›†ç¾¤">é˜¶æ®µäºŒï¼šå¯åŠ¨å’Œé…ç½®é›†ç¾¤</h3><ol><li><p><strong>å¯åŠ¨æ‰€æœ‰æœåŠ¡</strong>ï¼š<br>åœ¨ <code>mysql_cluster</code> æ–‡ä»¶å¤¹ä¸‹ï¼Œè¿è¡Œå‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure><p>Docker ä¼šè‡ªåŠ¨æ‹‰å–é•œåƒå¹¶æŒ‰é¡ºåºå¯åŠ¨æ‰€æœ‰å®¹å™¨ã€‚</p></li><li><p><strong>é…ç½®ä¸»ä»å¤åˆ¶</strong>ï¼š<br>æˆ‘ä»¬éœ€è¦è¿›å…¥ä¸»åº“å®¹å™¨ï¼Œåˆ›å»ºå¤åˆ¶ç”¨æˆ·å’Œ ProxySQL çš„ç›‘æ§ç”¨æˆ·ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿›å…¥ä¸»åº“å®¹å™¨</span></span><br><span class="line">docker <span class="built_in">exec</span> -it mysql_master bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç™»å½•MySQL</span></span><br><span class="line">mysql -u root -p</span><br><span class="line"><span class="comment"># (è¾“å…¥æ‚¨åœ¨docker-composeä¸­è®¾ç½®çš„å¯†ç )</span></span><br></pre></td></tr></table></figure><p>åœ¨MySQLå‘½ä»¤è¡Œä¸­æ‰§è¡Œï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- åˆ›å»ºå¤åˆ¶ç”¨æˆ·</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;repl_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;repl_password&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> REPLICATION SLAVE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;repl_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ›å»ºProxySQLç›‘æ§ç”¨æˆ·</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;monitor_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;monitor_password&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> USAGE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;monitor_user&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"></span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure><p><strong>ç°åœ¨ï¼Œé…ç½®ä¸¤ä¸ªä»åº“</strong>ã€‚è¿›å…¥æ¯ä¸ªä»åº“å®¹å™¨ï¼Œæ‰§è¡Œ <code>CHANGE MASTER TO</code> å‘½ä»¤ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿›å…¥ä»åº“1å®¹å™¨</span></span><br><span class="line">docker <span class="built_in">exec</span> -it mysql_slave1 bash</span><br><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure><p>åœ¨ä»åº“1çš„MySQLå‘½ä»¤è¡Œä¸­æ‰§è¡Œï¼ˆå¯¹ä»åº“2é‡å¤æ­¤æ“ä½œï¼‰ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ä½¿ç”¨GTIDè‡ªåŠ¨å®šä½ï¼Œæ¯”File/Positionæ›´ç®€å•</span></span><br><span class="line">CHANGE MASTER <span class="keyword">TO</span></span><br><span class="line">  MASTER_HOST<span class="operator">=</span><span class="string">&#x27;mysql_master&#x27;</span>,  <span class="comment">-- ä½¿ç”¨Dockerçš„æœåŠ¡å</span></span><br><span class="line">  MASTER_USER<span class="operator">=</span><span class="string">&#x27;repl_user&#x27;</span>,</span><br><span class="line">  MASTER_PASSWORD<span class="operator">=</span><span class="string">&#x27;repl_password&#x27;</span>,</span><br><span class="line">  MASTER_AUTO_POSITION<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">START</span> SLAVE;</span><br><span class="line"><span class="comment">-- éªŒè¯çŠ¶æ€</span></span><br><span class="line"><span class="keyword">SHOW</span> SLAVE STATUS\G; </span><br></pre></td></tr></table></figure><p>åœ¨ä»åº“2ä¸Šé‡å¤ä»¥ä¸Š <code>CHANGE MASTER TO</code> å’Œ <code>START SLAVE</code> çš„æ­¥éª¤ã€‚</p></li><li><p><strong>é…ç½® ProxySQL</strong>ï¼š<br>è¿æ¥åˆ° ProxySQL çš„ç®¡ç†åå°ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ³¨æ„ï¼Œæ˜¯ä»æ‚¨çš„å®¿ä¸»æœºè¿æ¥ï¼Œä¸æ˜¯åœ¨å®¹å™¨é‡Œ</span></span><br><span class="line">mysql -u admin -padmin -h 127.0.0.1 -P 6032</span><br></pre></td></tr></table></figure><p>åœ¨ ProxySQL ç®¡ç†åå°æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- è®¾ç½®ç›‘æ§ç”¨æˆ·å‡­è¯ï¼ˆä¸proxysql.cnfå’ŒMySQLä¸­åˆ›å»ºçš„ä¸€è‡´ï¼‰</span></span><br><span class="line"><span class="keyword">UPDATE</span> global_variables <span class="keyword">SET</span> variable_value<span class="operator">=</span><span class="string">&#x27;monitor_user&#x27;</span> <span class="keyword">WHERE</span> variable_name<span class="operator">=</span><span class="string">&#x27;mysql-monitor_username&#x27;</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> global_variables <span class="keyword">SET</span> variable_value<span class="operator">=</span><span class="string">&#x27;monitor_password&#x27;</span> <span class="keyword">WHERE</span> variable_name<span class="operator">=</span><span class="string">&#x27;mysql-monitor_password&#x27;</span>;</span><br><span class="line">LOAD MYSQL VARIABLES <span class="keyword">TO</span> RUNTIME;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- é…ç½®åç«¯MySQLæœåŠ¡å™¨</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> mysql_servers(hostgroup_id, hostname, port) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">10</span>, <span class="string">&#x27;mysql_master&#x27;</span>, <span class="number">3306</span>), <span class="comment">-- å†™å…¥ç»„ (ä¸»åº“)</span></span><br><span class="line">(<span class="number">20</span>, <span class="string">&#x27;mysql_slave1&#x27;</span>, <span class="number">3306</span>), <span class="comment">-- è¯»å–ç»„ (ä»åº“1)</span></span><br><span class="line">(<span class="number">20</span>, <span class="string">&#x27;mysql_slave2&#x27;</span>, <span class="number">3306</span>); <span class="comment">-- è¯»å–ç»„ (ä»åº“2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- é…ç½®åº”ç”¨è¿æ¥ç”¨æˆ·</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> mysql_users(username, password, default_hostgroup) <span class="keyword">VALUES</span> </span><br><span class="line">(<span class="string">&#x27;app_user&#x27;</span>, <span class="string">&#x27;app_password&#x27;</span>, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- å®šä¹‰è¯»å†™åˆ†ç¦»è§„åˆ™</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> mysql_query_rules(rule_id, active, match_digest, destination_hostgroup, apply) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;^SELECT.*&#x27;</span>, <span class="number">20</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="number">2</span>, <span class="number">1</span>, <span class="string">&#x27;.*&#x27;</span>, <span class="number">10</span>, <span class="number">1</span>); <span class="comment">-- ä¸€ä¸ªæ›´ç®€å•çš„è§„åˆ™ï¼šåŒ¹é…SELECTçš„å»è¯»å–ç»„ï¼Œå…¶ä»–æ‰€æœ‰éƒ½å»å†™å…¥ç»„</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- åŠ è½½å¹¶ä¿å­˜é…ç½®</span></span><br><span class="line">LOAD MYSQL SERVERS <span class="keyword">TO</span> RUNTIME;</span><br><span class="line">LOAD MYSQL USERS <span class="keyword">TO</span> RUNTIME;</span><br><span class="line">LOAD MYSQL QUERY RULES <span class="keyword">TO</span> RUNTIME;</span><br><span class="line">SAVE MYSQL SERVERS <span class="keyword">TO</span> DISK;</span><br><span class="line">SAVE MYSQL USERS <span class="keyword">TO</span> DISK;</span><br><span class="line">SAVE MYSQL QUERY RULES <span class="keyword">TO</span> DISK;</span><br></pre></td></tr></table></figure></li></ol><h3 id="proxy-sql-web">proxy-sql-web</h3><ul><li>docker-compose.yml</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">proxysql-web:</span></span><br><span class="line">    <span class="comment"># --- ä¿®æ”¹ç‚¹åœ¨è¿™é‡Œ ---</span></span><br><span class="line">    <span class="comment"># ä½¿ç”¨ä¸€ä¸ªåœ¨ Docker Hub ä¸Šå…¬å¼€å¯ç”¨çš„é•œåƒ</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">kishorj/proxysql-web:latest</span></span><br><span class="line">    <span class="comment"># ------------------</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">proxysql-web</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:80&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB_HOST=192.168.10.158</span> <span class="comment"># æ‚¨çš„ ProxySQL æœåŠ¡å™¨ IP</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB_PORT=6032</span>         <span class="comment"># ProxySQL ç®¡ç†ç«¯å£</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB_USER=admin</span>          <span class="comment"># ProxySQL ç®¡ç†ç”¨æˆ·å</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB_PASS=admin</span>          <span class="comment"># ProxySQL ç®¡ç†å¯†ç </span></span><br></pre></td></tr></table></figure><ul><li>run</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> docker-compose up -d</span><br></pre></td></tr></table></figure><h3 id="é˜¶æ®µä¸‰ï¼šåˆ‡æ¢åº”ç”¨">é˜¶æ®µä¸‰ï¼šåˆ‡æ¢åº”ç”¨</h3><p>ç°åœ¨ï¼Œæ‚¨çš„æ•´ä¸ªé«˜å¯ç”¨é›†ç¾¤å·²ç»åœ¨ Docker ä¸­è¿è¡Œèµ·æ¥äº†ã€‚æœ€åä¸€æ­¥å°±æ˜¯å°†æ‚¨æ‰€æœ‰200å¤šå°ç”µè„‘ä¸Šçš„åº”ç”¨ç¨‹åºçš„æ•°æ®åº“è¿æ¥é…ç½®ï¼ŒæŒ‡å‘ ProxySQL å®¹å™¨æš´éœ²çš„ç«¯å£ã€‚</p><ul><li><strong>Host</strong>: è¿è¡Œ Docker çš„é‚£å°æœåŠ¡å™¨çš„ IP åœ°å€ã€‚</li><li><strong>Port</strong>: <code>6033</code></li><li><strong>User</strong>: <code>app_user</code></li><li><strong>Password</strong>: <code>app_password</code></li></ul><h3 id="ä¼˜ç‚¹æ€»ç»“">ä¼˜ç‚¹æ€»ç»“</h3><ul><li><strong>ç¯å¢ƒä¸€è‡´æ€§</strong>ï¼šæ— è®ºéƒ¨ç½²åˆ°å“ªå°æœºå™¨ï¼Œæ•´ä¸ªé›†ç¾¤çš„ç¯å¢ƒéƒ½æ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚</li><li><strong>å¿«é€Ÿéƒ¨ç½²ä¸é”€æ¯</strong>ï¼šä½¿ç”¨ <code>docker-compose up -d</code> å’Œ <code>docker-compose down -v</code> å¯ä»¥ç§’çº§åˆ›å»ºå’Œå½»åº•é”€æ¯æ•´å¥—ç¯å¢ƒï¼Œéå¸¸é€‚åˆæµ‹è¯•å’Œå¼€å‘ã€‚</li><li><strong>ç®€åŒ–ç®¡ç†</strong>ï¼šæœåŠ¡ä¹‹é—´çš„ç½‘ç»œå’Œä¾èµ–å…³ç³»ç”± Docker Compose ç®¡ç†ï¼Œæ¯”æ‰‹åŠ¨é…ç½®ç½‘ç»œå’Œé˜²ç«å¢™ç®€å•å¾—å¤šã€‚</li><li><strong>èµ„æºéš”ç¦»</strong>ï¼šæ¯ä¸ªæœåŠ¡éƒ½åœ¨è‡ªå·±çš„å®¹å™¨ä¸­è¿è¡Œï¼Œäº’ä¸å¹²æ‰°ã€‚</li></ul><p>è¿™ä¸ª Docker åŒ–çš„æ–¹æ¡ˆä¸ºæ‚¨æä¾›äº†ä¸€ä¸ªå¯ç§»æ¤ã€å¯å¤ç°ã€é«˜åº¦è‡ªåŠ¨åŒ–çš„æ–¹å¼æ¥éƒ¨ç½²å’Œç®¡ç†æ‚¨çš„MySQLè¯»å†™åˆ†ç¦»é›†ç¾¤ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;å‡†å¤‡é˜¶æ®µï¼šé¡¹ç›®ç»“æ„&quot;&gt;å‡†å¤‡é˜¶æ®µï¼šé¡¹ç›®ç»“æ„&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;é¦–å…ˆï¼Œåœ¨æ‚¨çš„æœåŠ¡å™¨ä¸Šåˆ›å»ºä¸€ä¸ªé¡¹ç›®æ–‡ä»¶å¤¹ï¼Œç»“æ„å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;/blockquote&gt;
&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr</summary>
      
    
    
    
    
    <category term="python" scheme="https://caozhaoqi.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨Devpiä¸Nginxæ„å»ºé«˜å¯ç”¨PyPIé•œåƒæº</title>
    <link href="https://caozhaoqi.github.io/2025/09/17/pypi-mirror-self/"/>
    <id>https://caozhaoqi.github.io/2025/09/17/pypi-mirror-self/</id>
    <published>2025-09-17T06:03:20.000Z</published>
    <updated>2025-11-25T15:05:10.344Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä½¿ç”¨Devpiä¸Nginxæ„å»ºé«˜å¯ç”¨PyPIé•œåƒæº">ä½¿ç”¨Devpiä¸Nginxæ„å»ºé«˜å¯ç”¨PyPIé•œåƒæº</h2><h3 id="å‰è¨€ï¼šä¸ºä»€ä¹ˆä½ çš„pip-installåˆè¶…æ—¶äº†ï¼Ÿ">å‰è¨€ï¼šä¸ºä»€ä¹ˆä½ çš„<code>pip install</code>åˆè¶…æ—¶äº†ï¼Ÿ</h3><p>å¯¹äºæ¯ä¸€ä½Pythonå¼€å‘è€…æ¥è¯´ï¼Œ<code>pip install</code> æ— ç–‘æ˜¯æœ€å¸¸ç”¨çš„å‘½ä»¤ä¹‹ä¸€ã€‚ç„¶è€Œï¼Œå›¢é˜Ÿå¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šé‡åˆ°è¿™äº›ç—›ç‚¹ï¼š</p><ul><li><strong>é€Ÿåº¦ç“¶é¢ˆ</strong>ï¼šå›¢é˜Ÿå‡ åå·äººï¼ŒCI/CDæµæ°´çº¿ä¸Šç™¾ä¸ªä»»åŠ¡ï¼Œå…¨éƒ½ä»å›½å¤–çš„å®˜æ–¹PyPIæºæ‹‰å–åŒ…ï¼Œä¸‹è½½é€Ÿåº¦æ…¢å¾—ä»¤äººæŠ“ç‹‚ï¼Œä¸¥é‡å½±å“å¼€å‘å’Œéƒ¨ç½²æ•ˆç‡ã€‚</li><li><strong>å•ç‚¹æ•…éšœ</strong>ï¼šå®˜æ–¹PyPIå¶å°”ä¼šæŠ–åŠ¨ï¼Œæˆ–è€…å…¬å¸å‡ºå£ç½‘ç»œå‡ºç°é—®é¢˜ï¼Œå¯¼è‡´æ‰€æœ‰ä¾èµ–å®‰è£…å¤±è´¥ï¼Œç ”å‘æµç¨‹ç¬é—´åœæ‘†ã€‚</li><li><strong>å®‰å…¨ä¸åˆè§„</strong>ï¼šæ— æ³•å¯¹å›¢é˜Ÿä½¿ç”¨çš„ç¬¬ä¸‰æ–¹åŒ…è¿›è¡Œç»Ÿä¸€ç®¡ç†å’Œå®‰å…¨å®¡è®¡ã€‚</li><li><strong>ç§æœ‰åŒ…æ‰˜ç®¡</strong>ï¼šå›¢é˜Ÿå†…éƒ¨å¼€å‘çš„å…¬å…±åº“æ— å¤„å®‰æ”¾ï¼Œåªèƒ½é€šè¿‡Gitä»“åº“ç­‰åŸå§‹æ–¹å¼å…±äº«ã€‚</li></ul><p>ä¸ºäº†å½»åº•è§£å†³è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª<strong>ç§æœ‰çš„ã€é«˜é€Ÿçš„ã€ä¸”æ°¸ä¸å®•æœº</strong>çš„PythonåŒ…ä»“åº“ã€‚ä»Šå¤©ï¼Œæˆ‘å°†æ‰‹æŠŠæ‰‹å¸¦ä½ ä½¿ç”¨ä¸šç•Œæœ€å¼ºå¤§çš„å¼€æºå·¥å…· <strong><code>devpi</code></strong> å’Œ <strong><code>Nginx</code></strong>ï¼Œæ„å»ºä¸€ä¸ªå…·å¤‡è‡ªåŠ¨æ•…éšœè½¬ç§»èƒ½åŠ›çš„é«˜å¯ç”¨PyPIé•œåƒæºã€‚</p><p><strong>æœ€ç»ˆç›®æ ‡</strong>ï¼šæ— è®ºæ¸…åæºã€é˜¿é‡Œæºè¿˜æ˜¯å…¶ä»–ä»»ä½•ä¸€ä¸ªé•œåƒæŒ‚äº†ï¼Œæˆ‘ä»¬çš„ <code>pip install</code> ä¾ç„¶èƒ½ä¸æ»‘æµç•…åœ°è¿è¡Œï¼Œå¯¹å¼€å‘è€…å®Œå…¨é€æ˜ï¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">+-----------+     +-------------------+     +-------------------------+     +--------------------------+</span><br><span class="line">|           |     |                   |     |                         |     |   Tsinghua Mirror       |</span><br><span class="line">|  å¼€å‘è€…   | --&gt; |  devpi æœåŠ¡å™¨      | --&gt; |  Nginx åå‘ä»£ç†          | --&gt; |  (Upstream 1)            |</span><br><span class="line">| (pip)     |     | (ç¼“å­˜/ç§æœ‰åŒ…)      |     | (å¤„ç†ä¸Šæ¸¸æ•…éšœè½¬ç§»)       |     +--------------------------+</span><br><span class="line">|           |     |                   |     |                         |     |  Aliyun Mirror         |</span><br><span class="line">+-----------+     +-------------------+     +-------------------------+ --&gt; |  (Upstream 2)            |</span><br><span class="line">                                                                            +--------------------------+</span><br><span class="line">                                                                            |  USTC Mirror             |</span><br><span class="line">                                                                          -&gt;|  (Upstream 3)            |</span><br><span class="line">                                                                            +--------------------------+</span><br><span class="line">                                                                            |  ... and so on           |</span><br><span class="line">                                                                            +--------------------------+</span><br></pre></td></tr></table></figure><h3 id="ç¬¬ä¸€ç« ï¼šæ ¸å¿ƒæ­¦å™¨ä»‹ç»-Devpi-ä¸-Nginx">ç¬¬ä¸€ç« ï¼šæ ¸å¿ƒæ­¦å™¨ä»‹ç» - Devpi ä¸ Nginx</h3><p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹ä¸¤ä½ä¸»è§’ï¼š</p><ol><li><p><strong>Devpi</strong>: ä¸€ä¸ªåŠŸèƒ½å®Œå¤‡çš„PythonåŒ…æœåŠ¡å™¨ã€‚å®ƒä¸ä»…ä»…æ˜¯ <code>pypi.org</code> çš„ä¸€ä¸ªç¼“å­˜ä»£ç†ï¼Œæ›´æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ç§æœ‰åŒ…ä»“åº“å’Œç‰ˆæœ¬å‘å¸ƒç®¡ç†å·¥å…·ã€‚æˆ‘ä»¬å°†ä¸»è¦åˆ©ç”¨å®ƒçš„<strong>ç¼“å­˜é•œåƒ</strong>åŠŸèƒ½ã€‚</p></li><li><p><strong>Nginx</strong>: ä¸€æ¬¾é«˜æ€§èƒ½çš„HTTPå’Œåå‘ä»£ç†æœåŠ¡å™¨ã€‚åœ¨è¿™é‡Œï¼Œå®ƒå°†æ‰®æ¼”æˆ‘ä»¬é•œåƒæºçš„â€œæ™ºèƒ½è°ƒåº¦å‘˜â€å’Œâ€œæ•…éšœå“¨å…µâ€ï¼Œè´Ÿè´£ç›‘æµ‹ä¸Šæ¸¸é•œåƒæºçš„å¥åº·çŠ¶å†µï¼Œå¹¶åœ¨æŸä¸ªæºå‡ºç°é—®é¢˜æ—¶ï¼Œè‡ªåŠ¨å°†æµé‡åˆ‡æ¢åˆ°å¥åº·çš„å¤‡ç”¨æºä¸Šã€‚</p></li></ol><h3 id="ç¬¬äºŒç« ï¼šåŸºç¡€å»ºè®¾-æ­å»ºDevpiç¼“å­˜æœåŠ¡å™¨">ç¬¬äºŒç« ï¼šåŸºç¡€å»ºè®¾ - æ­å»ºDevpiç¼“å­˜æœåŠ¡å™¨</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªèƒ½ç¨³å®šè¿è¡Œçš„<code>devpi</code>æœåŠ¡ã€‚</p><h4 id="æ­¥éª¤-1-å‡†å¤‡æœåŠ¡å™¨ä¸å®‰è£…Devpi">æ­¥éª¤ 1: å‡†å¤‡æœåŠ¡å™¨ä¸å®‰è£…Devpi</h4><p>åœ¨ä¸€å°LinuxæœåŠ¡å™¨ï¼ˆæœ¬æ•™ç¨‹ä»¥Ubuntuä¸ºä¾‹ï¼‰ä¸Šï¼Œç¡®ä¿å·²å®‰è£…Pythonå’Œpipã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ›´æ–°å¹¶å®‰è£…ä¾èµ–</span></span><br><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install -y python3 python3-pip</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… devpi-server</span></span><br><span class="line">pip3 install devpi-server</span><br><span class="line"></span><br><span class="line">devpi-init</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="æ­¥éª¤-2-åˆå§‹åŒ–Devpi">æ­¥éª¤ 2: åˆå§‹åŒ–Devpi</h4><p>è¿™ä¸ªä¸€æ¬¡æ€§æ“ä½œä¼šä¸ºä½ åˆ›å»ºæ•°æ®ç›®å½•å’Œ <code>root</code> è¶…çº§ç®¡ç†å‘˜ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">devpi-init</span><br></pre></td></tr></table></figure><p>åœ¨æç¤ºä¸­ï¼Œä¸º <code>root</code> ç”¨æˆ·è®¾ç½®ä¸€ä¸ªå®‰å…¨çš„å¯†ç ï¼Œå¹¶ç‰¢ç‰¢è®°ä½å®ƒã€‚</p><h4 id="æ­¥éª¤-3-è®©Devpiåœ¨åå°ç¨³å®šè¿è¡Œ">æ­¥éª¤ 3: è®©Devpiåœ¨åå°ç¨³å®šè¿è¡Œ</h4><p>ä¸ºäº†ç”Ÿäº§ç¯å¢ƒçš„ç¨³å®šï¼Œæˆ‘ä»¬å°† <code>devpi</code> é…ç½®æˆä¸€ä¸ª <code>systemd</code> ç³»ç»ŸæœåŠ¡ï¼Œå®ç°å¼€æœºè‡ªå¯å’Œåå°è¿è¡Œã€‚</p><ol><li><p><strong>åˆ›å»ºæœåŠ¡æ–‡ä»¶</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> nano /etc/systemd/system/devpi.service</span><br></pre></td></tr></table></figure></li><li><p><strong>ç²˜è´´ä»¥ä¸‹é…ç½®</strong> (æ³¨æ„ä¿®æ”¹ <code>User</code> å’Œ <code>ExecStart</code> ä¸­çš„è·¯å¾„ä¸ºä½ è‡ªå·±çš„):</p></li></ol><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(venv) czq2@czq2:~/clip-video$ sudo cat /etc/systemd/system/devpi.service</span><br><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=devpi-server daemon</span><br><span class="line"><span class="attr">After</span>=network.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=simple</span><br><span class="line"><span class="attr">User</span>=czq2</span><br><span class="line"><span class="attr">Group</span>=czq2</span><br><span class="line"><span class="attr">ExecStart</span>=/home/czq2/clip-video/venv/bin/devpi-server --host=<span class="number">0.0</span>.<span class="number">0.0</span> --port=<span class="number">3141</span></span><br><span class="line"><span class="attr">Restart</span>=<span class="literal">on</span>-failure</span><br><span class="line"><span class="attr">RestartSec</span>=<span class="number">5</span>s</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure><ul><li><code>--host=0.0.0.0</code> ç¡®ä¿å±€åŸŸç½‘å†…çš„å…¶ä»–æœºå™¨å¯ä»¥è®¿é—®ã€‚</li></ul><ol start="3"><li><strong>å¯åŠ¨å¹¶éªŒè¯æœåŠ¡</strong>:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload</span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> devpi  <span class="comment"># å¼€æœºè‡ªå¯</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl start devpi   <span class="comment"># å¯åŠ¨</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl status devpi  <span class="comment"># æ£€æŸ¥çŠ¶æ€</span></span><br></pre></td></tr></table></figure>çœ‹åˆ°ç»¿è‰²çš„ <code>active (running)</code>ï¼Œæ­å–œä½ ï¼ŒåŸºç¡€çš„ <code>devpi</code> é•œåƒæœåŠ¡å·²ç»æˆåŠŸè¿è¡Œåœ¨ <code>http://&lt;ä½ çš„æœåŠ¡å™¨IP&gt;:3141</code> ä¸Šäº†ï¼</li></ol><ul><li>æˆåŠŸè¾“å‡º</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">(venv) czq2@czq2:~/clip-video$ <span class="built_in">sudo</span> systemctl start devpi</span><br><span class="line">(venv) czq2@czq2:~/clip-video$ <span class="built_in">sudo</span> systemctl status devpi</span><br><span class="line">â— devpi.service - devpi-server daemon</span><br><span class="line">     Loaded: loaded (/etc/systemd/system/devpi.service; enabled; preset: enabled)</span><br><span class="line">     Active: active (running) since Wed 2025-09-17 07:19:23 UTC; 3s ago</span><br><span class="line">   Main PID: 1619813 (devpi-server)</span><br><span class="line">      Tasks: 54 (<span class="built_in">limit</span>: 309293)</span><br><span class="line">     Memory: 41.4M (peak: 553.5M)</span><br><span class="line">        CPU: 15.733s</span><br><span class="line">     CGroup: /system.slice/devpi.service</span><br><span class="line">             â””â”€1619813 /home/czq2/clip-video/venv/bin/python3 /home/czq2/clip-video/venv/bin/devpi-server --host=0.0.0.0 --p&gt;</span><br><span class="line"></span><br><span class="line">Sep 17 07:19:23 czq2 devpi-server[1619813]: 2025-09-17 07:19:23,634 WARNI NOCTX No secret file provided, creating a new rand&gt;</span><br><span class="line">Sep 17 07:19:25 czq2 devpi-server[1619813]: 2025-09-17 07:19:25,757 INFO  [ASYN] Starting asyncio event loop</span><br><span class="line">Sep 17 07:19:25 czq2 devpi-server[1619813]: 2025-09-17 07:19:25,777 INFO  NOCTX devpi-server version: 6.17.0</span><br><span class="line">Sep 17 07:19:25 czq2 devpi-server[1619813]: 2025-09-17 07:19:25,777 INFO  NOCTX serverdir: /home/czq2/.devpi/server</span><br><span class="line">Sep 17 07:19:25 czq2 devpi-server[1619813]: 2025-09-17 07:19:25,777 INFO  NOCTX uuid: 0c7aa3d0d1874fd596c8936cd007d305</span><br><span class="line">Sep 17 07:19:25 czq2 devpi-server[1619813]: 2025-09-17 07:19:25,777 INFO  NOCTX serving at url: http://0.0.0.0:3141 (might b&gt;</span><br><span class="line">Sep 17 07:19:25 czq2 devpi-server[1619813]: 2025-09-17 07:19:25,777 INFO  NOCTX using 50 threads</span><br><span class="line">Sep 17 07:19:25 czq2 devpi-server[1619813]: 2025-09-17 07:19:25,777 INFO  NOCTX bug tracker: https://github.com/devpi/devpi/&gt;</span><br><span class="line">Sep 17 07:19:25 czq2 devpi-server[1619813]: 2025-09-17 07:19:25,777 INFO  NOCTX Hit Ctrl-C to quit.</span><br><span class="line">Sep 17 07:19:25 czq2 devpi-server[1619813]: 2025-09-17 07:19:25,785 INFO  Serving on http://0.0.0.0:3141</span><br></pre></td></tr></table></figure><ul><li>é”™è¯¯åˆ†æ</li></ul> <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> journalctl -u devpi.service -n 50 --no-pager</span><br></pre></td></tr></table></figure><h3 id="ç¬¬ä¸‰ç« ï¼šæ„å»ºæŠ¤åŸæ²³-Nginxé«˜å¯ç”¨åå‘ä»£ç†">ç¬¬ä¸‰ç« ï¼šæ„å»ºæŠ¤åŸæ²³ - Nginxé«˜å¯ç”¨åå‘ä»£ç†</h3><p>ç°åœ¨ï¼Œæˆ‘ä»¬è¦ä¸º <code>devpi</code> æ„å»ºä¸€ä¸ªåšå›ºçš„å‰å“¨ç«™ï¼Œè®©å®ƒä¸å†ç›´æ¥ä¾èµ–ä»»ä½•å•ä¸€çš„ä¸Šæ¸¸æºã€‚</p><h4 id="æ­¥éª¤-1-å®‰è£…-Nginx">æ­¥éª¤ 1: å®‰è£… Nginx</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install -y nginx</span><br></pre></td></tr></table></figure><h4 id="æ­¥éª¤-2-ç¼–å†™Nginxé«˜å¯ç”¨é…ç½®">æ­¥éª¤ 2: ç¼–å†™Nginxé«˜å¯ç”¨é…ç½®</h4><p>è¿™æ˜¯å®ç°è‡ªåŠ¨æ•…éšœè½¬ç§»çš„<strong>æ ¸å¿ƒ</strong>ã€‚</p><ol><li><p><strong>åˆ›å»ºNginxé…ç½®æ–‡ä»¶</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> nano /etc/nginx/sites-available/pypi-proxy</span><br></pre></td></tr></table></figure></li><li><p><strong>ç²˜è´´ä»¥ä¸‹é­”æ³•é…ç½®</strong>:</p></li></ol><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># /etc/nginx/sites-available/pypi-proxy</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## å®šä¹‰ä¸€ä¸ªä¸Šæ¸¸æœåŠ¡å™¨ç»„ï¼Œè¿™æ¬¡å…¨éƒ¨ä½¿ç”¨ HTTPS</span></span><br><span class="line"></span><br><span class="line"><span class="section">upstream</span> pypi_mirrors_https &#123;</span><br><span class="line">    <span class="comment"># ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç›´æ¥æŒ‡å‘ HTTPS åŸŸåï¼Œç«¯å£ 443 æ˜¯é»˜è®¤çš„ï¼Œå¯ä»¥ä¸å†™</span></span><br><span class="line">    <span class="attribute">server</span> pypi.tuna.tsinghua.edu.cn:<span class="number">443</span>;</span><br><span class="line">    <span class="attribute">server</span> mirrors.aliyun.com:<span class="number">443</span>;</span><br><span class="line">    <span class="attribute">server</span> pypi.mirrors.ustc.edu.cn:<span class="number">443</span>;</span><br><span class="line">    <span class="attribute">server</span> mirrors.cloud.tencent.com:<span class="number">443</span>;</span><br><span class="line">    <span class="attribute">server</span> repo.huaweicloud.com:<span class="number">443</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8888</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="comment"># ã€æ ¸å¿ƒä¿®æ”¹ã€‘å°†è¯·æ±‚ä»£ç†åˆ°æˆ‘ä»¬æ–°çš„ HTTPS æœåŠ¡å™¨ç»„</span></span><br><span class="line">        <span class="attribute">proxy_pass</span> https://pypi_mirrors_https;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ•…éšœè½¬ç§»çš„é…ç½®ä¿æŒä¸å˜</span></span><br><span class="line">        <span class="attribute">proxy_next_upstream</span> <span class="literal">error</span> timeout http_500 http_502 http_503 http_504;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_connect_timeout</span> <span class="number">10s</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ã€é‡è¦ã€‘å½“ä»£ç†åˆ° HTTPS ä¸Šæ¸¸æ—¶ï¼Œå¿…é¡»æ­£ç¡®è®¾ç½® Host å¤´</span></span><br><span class="line">        <span class="comment"># è¿™é‡Œçš„ $host ä¼šæ˜¯ä¸Šæ¸¸æœåŠ¡å™¨ç»„çš„åç§°ï¼Œä¸ºäº†æ­£ç¡®æ€§ï¼Œæˆ‘ä»¬åº”è¯¥ä¼ é€’åŸå§‹è¯·æ±‚çš„Host</span></span><br><span class="line">        <span class="comment"># æˆ–è€…ç›´æ¥ç¡¬ç¼–ç ä¸º pypi.tuna.tsinghua.edu.cn ç­‰ï¼Œä½†ä¼ é€’åŸå§‹Hostæ›´çµæ´»</span></span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$proxy_host</span>; <span class="comment"># ä½¿ç”¨ $proxy_host å˜é‡</span></span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰å¢åŠ  SSL ç›¸å…³çš„ä»£ç†è®¾ç½®</span></span><br><span class="line">        <span class="attribute">proxy_ssl_server_name</span> <span class="literal">on</span>; <span class="comment"># è¿™ä¼šè®©Nginxåœ¨TLSæ¡æ‰‹ä¸­å‘é€æ­£ç¡®çš„æœåŠ¡å™¨åç§°(SNI)</span></span><br><span class="line">        <span class="attribute">proxy_ssl_session_reuse</span> <span class="literal">on</span>; <span class="comment"># å¯ç”¨SSLä¼šè¯å¤ç”¨ä»¥æé«˜æ€§èƒ½</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li><strong>å¯ç”¨é…ç½®å¹¶é‡å¯Nginx</strong>:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">ln</span> -s /etc/nginx/sites-available/pypi-proxy /etc/nginx/sites-enabled/</span><br><span class="line"><span class="built_in">sudo</span> nginx -t          <span class="comment"># æµ‹è¯•é…ç½®è¯­æ³•</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl restart nginx <span class="comment"># é‡å¯Nginx</span></span><br></pre></td></tr></table></figure>ç°åœ¨ï¼Œä¸€ä¸ªå¼ºå¤§çš„ã€èƒ½è‡ªåŠ¨åˆ‡æ¢æºçš„åå‘ä»£ç†å·²ç»åœ¨ <code>http://192.168.10.158:8088</code> ä¸Šä¸ºä½ å¾…å‘½ã€‚</li></ol><hr><h3 id="ç¬¬å››ç« ï¼šåˆä½“ï¼å°†Devpiæ¥å…¥Nginxä»£ç†">ç¬¬å››ç« ï¼šåˆä½“ï¼å°†Devpiæ¥å…¥Nginxä»£ç†</h3><p>ä¸‡äº‹ä¿±å¤‡ï¼Œåªå·®æœ€åä¸€æ­¥ï¼šè®© <code>devpi</code> é€šè¿‡æˆ‘ä»¬çš„ Nginx â€œæŠ¤åŸæ²³â€å»è®¿é—®ä¸–ç•Œã€‚</p><ol><li><p><strong>åœæ­¢DevpiæœåŠ¡</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl stop devpi</span><br></pre></td></tr></table></figure></li><li><p><strong>ä¿®æ”¹Devpiçš„å¯åŠ¨å‚æ•°</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> nano /etc/systemd/system/devpi.service</span><br></pre></td></tr></table></figure></li><li><p>åœ¨ <code>ExecStart</code> è¡Œçš„æœ«å°¾ï¼Œæ·»åŠ  <code>--mirror-url</code> å‚æ•°ï¼ŒæŒ‡å‘æˆ‘ä»¬çš„Nginxä»£ç†ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="attr">ExecStart</span>=/home/your_username/.local/bin/devpi-server --host=<span class="number">0.0</span>.<span class="number">0.0</span> --port=<span class="number">3141</span> --mirror-url http://<span class="number">192.168</span>.<span class="number">10.158</span>:<span class="number">8088</span>/pypi</span><br><span class="line"><span class="comment"># ...</span></span><br></pre></td></tr></table></figure></li><li><p><strong>é‡æ–°åŠ è½½å¹¶å¯åŠ¨Devpi</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload</span><br><span class="line"><span class="built_in">sudo</span> systemctl start devpi</span><br></pre></td></tr></table></figure></li></ol><hr><h3 id="ç¬¬äº”ç« ï¼šäº«å—æˆæœ-é…ç½®å®¢æˆ·ç«¯">ç¬¬äº”ç« ï¼šäº«å—æˆæœ - é…ç½®å®¢æˆ·ç«¯</h3><p>ç°åœ¨ï¼Œè®©å›¢é˜Ÿçš„æ‰€æœ‰å¼€å‘è€…å’ŒCI/CDæœåŠ¡å™¨éƒ½äº«å—åˆ°è¿™ä¸ªç¨³å®šé«˜é€Ÿçš„é•œåƒæºå§ï¼</p><p>åœ¨æ¯ä¸€å°å®¢æˆ·ç«¯æœºå™¨ä¸Šï¼Œåˆ›å»ºæˆ–ä¿®æ”¹ <code>~/.pip/pip.conf</code> (macOS/Linux) æˆ– <code>%APPDATA%\pip\pip.ini</code> (Windows) æ–‡ä»¶ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[global]</span></span><br><span class="line"><span class="attr">index-url</span> = http://<span class="number">192.168</span>.<span class="number">10.158</span>:<span class="number">3141</span>/root/pypi/</span><br><span class="line"><span class="attr">trusted-host</span> = <span class="number">192.168</span>.<span class="number">10.158</span></span><br></pre></td></tr></table></figure><ul><li><code>index-url</code> æŒ‡å‘æˆ‘ä»¬æ­å»ºçš„ <code>devpi</code> æœåŠ¡ã€‚</li><li><code>trusted-host</code> å‘Šè¯‰ <code>pip</code> è¿™æ˜¯ä¸€ä¸ªå¯ä¿¡ä»»çš„HTTPæºã€‚</li></ul><h3 id="ä½¿ç”¨docker-compose-æ­å»º-devpi">ä½¿ç”¨docker compose æ­å»º devpi</h3><ul><li>docker-comose.yml</li></ul> <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># version å±æ€§å·²è¿‡æ—¶ï¼Œå¯ä»¥ç§»é™¤</span></span><br><span class="line"><span class="comment"># version: &quot;2.3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="comment"># æœåŠ¡1ï¼šé«˜å¯ç”¨ Nginx åå‘ä»£ç†</span></span><br><span class="line">  <span class="attr">nginx-proxy:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">devpi-nginx-proxy</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="comment"># å°†æˆ‘ä»¬çš„ stream é…ç½®æ–‡ä»¶æŒ‚è½½åˆ°å®¹å™¨ä¸­</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx_conf/nginx.conf:/etc/nginx/nginx.conf:ro</span></span><br><span class="line">    <span class="comment"># è¿™ä¸ªæœåŠ¡åªåœ¨å†…éƒ¨ä½¿ç”¨ï¼Œä¸éœ€è¦æš´éœ²ç«¯å£åˆ°å®¿ä¸»æœº</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># æœåŠ¡2ï¼šDevpi æœåŠ¡å™¨</span></span><br><span class="line">  <span class="attr">devpi-lib:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">devpi-lib</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">lowinli98/devpi:v0.2</span></span><br><span class="line">    <span class="attr">expose:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7104</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;7104:7104&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DEVPISERVER_HOST=0.0.0.0</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DEVPISERVER_PORT=7104</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DEVPISERVER_ROOT_PASSWORD=111</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DEVPISERVER_USER=czq</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DEVPISERVER_PASSWORD=111</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DEVPISERVER_MIRROR_INDEX=pypi</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DEVPISERVER_LIB_INDEX=devpi</span></span><br><span class="line">      <span class="comment"># --- ã€æ ¸å¿ƒä¿®æ”¹ã€‘---</span></span><br><span class="line">      <span class="comment"># å°†ä¸Šæ¸¸é•œåƒæºæŒ‡å‘æˆ‘ä»¬å†…éƒ¨çš„ nginx-proxy æœåŠ¡çš„ 443 ç«¯å£</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SOURCE_MIRROR_URL=http://nginx-proxy</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./volume:/var/lib/devpi</span></span><br><span class="line">    <span class="comment"># ã€é‡è¦ã€‘ç¡®ä¿ devpi æœåŠ¡ä¾èµ–äº nginx-proxy æœåŠ¡</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nginx-proxy</span></span><br></pre></td></tr></table></figure><ul><li>nignx conf</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"># nginx_conf/nginx.conf (HTTP ä»£ç†ç‰ˆæœ¬)</span><br><span class="line"></span><br><span class="line">events &#123;&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    # å®šä¹‰é«˜å¯ç”¨çš„ PyPI é•œåƒä¸Šæ¸¸æœåŠ¡å™¨æ± </span><br><span class="line">    upstream pypi_mirrors_https &#123;</span><br><span class="line">        server pypi.tuna.tsinghua.edu.cn:443;</span><br><span class="line">        server mirrors.aliyun.com:443;</span><br><span class="line">        server pypi.mirrors.ustc.edu.cn:443;</span><br><span class="line">        server mirrors.cloud.tencent.com:443;</span><br><span class="line">        server pypi.douban.com:443;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        # ç›‘å¬å®¹å™¨å†…éƒ¨çš„ 80 ç«¯å£ï¼Œæ¥æ”¶æ¥è‡ª devpi-lib çš„ HTTP è¯·æ±‚</span><br><span class="line">        listen 80;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            # å°†è¯·æ±‚ä»£ç†åˆ° HTTPS ä¸Šæ¸¸</span><br><span class="line">            proxy_pass https://pypi_mirrors_https;</span><br><span class="line"></span><br><span class="line">            # --- ä»£ç†æ ¸å¿ƒé…ç½® ---</span><br><span class="line">            proxy_next_upstream error timeout http_502 http_503 http_504;</span><br><span class="line">            proxy_connect_timeout 10s;</span><br><span class="line"></span><br><span class="line">            # --- å…³é”®çš„è¯·æ±‚å¤´ä¸ SSL/TLS é…ç½® ---</span><br><span class="line">            proxy_set_header Host $proxy_host;</span><br><span class="line">            proxy_ssl_server_name on;</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">            proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">            proxy_ssl_session_reuse on;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>docker run</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> docker-compose up -d --build</span><br></pre></td></tr></table></figure><h3 id="è‡ªå»ºdevpié•œåƒ">è‡ªå»ºdevpié•œåƒ</h3><ul><li>Dockerfile</li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dockerfile (æœ€ç»ˆç¨³å®šç‰ˆ)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ä¸€ä¸ªå®˜æ–¹çš„ã€è½»é‡çº§çš„ Python 3.9 åŸºç¡€é•œåƒ</span></span><br><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.9</span>-slim</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å®¹å™¨å†…çš„å·¥ä½œç›®å½•</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ã€æ„å»ºæ—¶ç½‘ç»œä¼˜åŒ–ã€‘</span></span><br><span class="line"><span class="comment"># å°† pip çš„é»˜è®¤æºè®¾ç½®ä¸ºé«˜é€Ÿçš„é•œåƒæº</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip config <span class="built_in">set</span> global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- ã€æ ¸å¿ƒ Bug ä¿®å¤ &amp; ç‰ˆæœ¬é”å®šã€‘ ---</span></span><br><span class="line"><span class="comment"># å®‰è£…åº”ç”¨ç¨‹åºåŠå…¶ä¾èµ–ï¼Œå¹¶é”å®šæ‰€æœ‰æ ¸å¿ƒç»„ä»¶çš„ç‰ˆæœ¬</span></span><br><span class="line"><span class="comment"># devpi-server 6.9.x æ˜¯ä¸€ä¸ªéå¸¸ç¨³å®šçš„ç³»åˆ—</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install --no-cache-dir --upgrade pip &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    pip install --no-cache-dir \</span></span><br><span class="line"><span class="language-bash">        <span class="string">&quot;devpi-server==6.9.2&quot;</span> \</span></span><br><span class="line"><span class="language-bash">        <span class="string">&quot;devpi-web==4.1.0&quot;</span> \</span></span><br><span class="line"><span class="language-bash">        <span class="string">&quot;httpx==0.22.0&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæ•°æ®å·æŒ‚è½½ç‚¹</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> /var/lib/devpi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ã€æƒé™ä¿®å¤ã€‘</span></span><br><span class="line"><span class="comment"># å°†æ•°æ®ç›®å½•çš„æ‰€æœ‰è€…æ›´æ”¹ä¸ºé root ç”¨æˆ· (UID 1000)</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chown</span> -R 1000:1000 /var/lib/devpi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ã€å®‰å…¨å®è·µã€‘</span></span><br><span class="line"><span class="comment"># å°†å®¹å™¨çš„é»˜è®¤è¿è¡Œç”¨æˆ·åˆ‡æ¢ä¸ºé root ç”¨æˆ·</span></span><br><span class="line"><span class="keyword">USER</span> <span class="number">1000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å£°æ˜å®¹å™¨å°†è¦ç›‘å¬çš„ç«¯å£</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">7104</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰å®¹å™¨å¯åŠ¨æ—¶è¦æ‰§è¡Œçš„é»˜è®¤å‘½ä»¤</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;devpi-server&quot;</span>, <span class="string">&quot;--serverdir&quot;</span>, <span class="string">&quot;/var/lib/devpi&quot;</span>, <span class="string">&quot;--host&quot;</span>, <span class="string">&quot;0.0.0.0&quot;</span>, <span class="string">&quot;--port&quot;</span>, <span class="string">&quot;7104&quot;</span>]</span></span><br></pre></td></tr></table></figure><ul><li>docker-compose.yml</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.yml (æœ€ç»ˆã€å†³å®šæ€§ç‰ˆæœ¬)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">nginx-proxy:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">devpi-nginx-proxy</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">http_proxy=http://192.168.12.80:7890</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https_proxy=http://192.168.12.80:7890</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">HTTP_PROXY=http://192.168.12.80:7890</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">HTTPS_PROXY=http://192.168.12.80:7890</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx_conf/nginx.conf:/etc/nginx/nginx.conf:ro</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">devpi-lib:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">devpi-lib</span></span><br><span class="line">    <span class="comment"># --- ã€æ ¸å¿ƒä¿®æ”¹ã€‘---</span></span><br><span class="line">    <span class="comment"># ä¸å†ä½¿ç”¨æ—§çš„ imageï¼Œè€Œæ˜¯ä½¿ç”¨ build æŒ‡ä»¤</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span>  <span class="comment"># è¡¨ç¤ºä½¿ç”¨å½“å‰ç›®å½•ä¸‹çš„ Dockerfile æ¥æ„å»ºé•œåƒ</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;7104:7104&quot;</span></span><br><span class="line">    <span class="comment"># ã€é‡è¦ã€‘æˆ‘ä»¬ä¸å†éœ€è¦æ—§é•œåƒçš„ç¯å¢ƒå˜é‡æ¥è‡ªåŠ¨åŒ–é…ç½®</span></span><br><span class="line">    <span class="comment"># æˆ‘ä»¬å°†åœ¨å¯åŠ¨åï¼Œæ‰‹åŠ¨è¿›è¡Œä¸€æ¬¡æ€§é…ç½®ï¼Œè¿™æ›´å¯é </span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">http_proxy=http://192.168.12.80:7890</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https_proxy=http://192.168.12.80:7890</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">HTTP_PROXY=http://192.168.12.80:7890</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">HTTPS_PROXY=http://192.168.12.80:7890</span></span><br><span class="line">        <span class="comment"># environment:</span></span><br><span class="line">    <span class="comment">#   - ... (å¯ä»¥å…¨éƒ¨åˆ é™¤)</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="comment"># æ•°æ®å·ä¾ç„¶éœ€è¦ï¼Œç”¨äºæŒä¹…åŒ– devpi çš„æ•°æ®</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./volume:/var/lib/devpi</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nginx-proxy</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li><ol><li><strong>åœ¨ä½ çš„å®¢æˆ·ç«¯ç”µè„‘ä¸Šï¼Œå®‰è£… <code>devpi-client</code></strong>:</li></ol>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> -R czq2:czq2 ./volume <span class="comment"># æ›´æ”¹ç›®å½•æƒé™</span></span><br><span class="line">pip install devpi-client</span><br></pre></td></tr></table></figure></li><li><ol start="2"><li><strong>ç™»å½•åˆ°ä½ çš„æ–° <code>devpi</code> æœåŠ¡å™¨</strong>:</li></ol>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŒ‡å‘æœåŠ¡å™¨</span></span><br><span class="line">devpi use http://&lt;ä½ çš„æœåŠ¡å™¨IP&gt;:7104</span><br><span class="line"></span><br><span class="line"><span class="comment"># é¦–æ¬¡ç™»å½• root ç”¨æˆ·ï¼Œdevpi-server ä¼šè‡ªåŠ¨åˆ›å»ºï¼Œæ— éœ€å¯†ç </span></span><br><span class="line"><span class="comment"># ç„¶åä¼šå¼ºåˆ¶ä½ è®¾ç½®æ–°å¯†ç </span></span><br><span class="line">devpi login root --password=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># (æŒ‰ç…§æç¤ºè¾“å…¥ä½ çš„æ–° root å¯†ç )</span></span><br></pre></td></tr></table></figure></li><li><ol start="3"><li><strong>ã€å…³é”®ã€‘é…ç½® <code>root/pypi</code> é•œåƒ</strong>:<br>é»˜è®¤çš„ <code>root/pypi</code> æŒ‡å‘ <code>pypi.org</code>ã€‚æˆ‘ä»¬éœ€è¦å°†å®ƒä¿®æ”¹ä¸ºæŒ‡å‘æˆ‘ä»¬å†…éƒ¨çš„ <code>nginx-proxy</code>ã€‚</li></ol>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¡®ä¿ä½ å·²ç™»å½• root</span></span><br><span class="line">devpi index root/pypi mirror_url=http://nginx-proxy</span><br></pre></td></tr></table></figure><ul><li><strong>æ³¨æ„</strong>: è¿™é‡Œçš„ <code>http://nginx-proxy</code> æ˜¯ <code>devpi-lib</code> å®¹å™¨å†…éƒ¨è®¿é—® <code>nginx-proxy</code> å®¹å™¨çš„åœ°å€ã€‚<code>devpi-server</code> åœ¨æ”¶åˆ°è¿™ä¸ªé…ç½®åï¼Œå®ƒå†…éƒ¨å‘èµ·çš„è¯·æ±‚å°±ä¼šèµ°è¿™æ¡è·¯ã€‚</li></ul></li><li><ol start="4"><li><strong>éªŒè¯</strong>:<br>åœ¨ä½ çš„å®¢æˆ·ç«¯ç”µè„‘ä¸Šï¼Œé…ç½®å¥½ <code>pip</code> æŒ‡å‘ <code>http://&lt;æœåŠ¡å™¨IP&gt;:7104/root/pypi/</code>ï¼Œç„¶åæ‰§è¡Œ <code>pip install numpy</code>ã€‚</li></ol></li></ul><h3 id="æˆåŠŸæ—¥å¿—">æˆåŠŸæ—¥å¿—</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">(.venv) czq2@czq2:~/pypi-docker$ sudo docker logs devpi-lib</span><br><span class="line">2025-09-22 02:56:36,728 INFO  [req12] POST /+login</span><br><span class="line">2025-09-22 02:57:08,329 INFO  [req13] GET /root/pypi</span><br><span class="line">2025-09-22 02:57:08,339 INFO  [req14] PATCH /root/pypi</span><br><span class="line">2025-09-22 02:57:08,342 INFO  [req14] [Wtx13] modified index root/pypi: &#123;&#x27;type&#x27;: &#x27;mirror&#x27;, &#x27;volatile&#x27;: False, &#x27;title&#x27;: &#x27;PyPI&#x27;, &#x27;mirror_url&#x27;: &#x27;http://mirrors.aliyun.com/pypi/simple/&#x27;, &#x27;mirror_web_url_fmt&#x27;: &#x27;https://pypi.org/project/&#123;name&#125;/&#x27;&#125;</span><br><span class="line">2025-09-22 02:57:08,345 INFO  [req14] [Wtx13] fswriter14: committed at 14</span><br><span class="line">2025-09-22 02:57:08,351 INFO  [req15] GET /root/pypi</span><br><span class="line">2025-09-22 02:57:25,788 INFO  [req16] GET /root/pypi/opencv-python/</span><br><span class="line">2025-09-22 02:57:40,843 INFO  [req17] GET /root/pypi/opencv-python/</span><br><span class="line">2025-09-22 02:57:41,058 INFO  [req18] GET /root</span><br><span class="line">2025-09-22 02:57:41,533 INFO  [req19] GET /+static-4.1.0/favicon.ico</span><br><span class="line">2025-09-22 02:57:43,732 INFO  [Wtx14] fswriter15: committed at 15</span><br><span class="line">2025-09-22 02:57:43,885 INFO  [NOTI] [Rtx15] indexing &#x27;root/pypi&#x27; mirror with 658356 projects</span><br><span class="line">2025-09-22 02:57:44,305 INFO  [IDX] Indexer queue size ~ 2</span><br><span class="line">2025-09-22 02:57:46,680 INFO  [req20] GET /root</span><br><span class="line">2025-09-22 02:57:47,303 INFO  [IDX] Committing 2500 new documents to search index.</span><br><span class="line">2025-09-22 02:57:47,410 INFO  [req21] GET /root/pypi</span><br><span class="line">2025-09-22 02:57:48,180 INFO  [req22] GET /root/pypi/+simple/</span><br><span class="line">2025-09-22 02:57:48,183 INFO  [req22] starting +simple</span><br><span class="line">2025-09-22 02:57:52,640 INFO  [req23] GET /root/pypi/+simple/</span><br><span class="line">2025-09-22 02:57:52,643 INFO  [req23] starting +simple</span><br><span class="line">2025-09-22 02:58:00,856 INFO  [IDX] Indexer queue size ~ 23</span><br><span class="line">2025-09-22 02:58:03,872 INFO  [IDX] Committing 2500 new documents to search index.</span><br><span class="line">2025-09-22 02:58:13,593 INFO  [IDX] Indexer queue size ~ 43</span><br><span class="line">2025-09-22 02:58:16,637 INFO  [IDX] Committing 2500 new documents to search index.</span><br><span class="line">2025-09-22 02:58:24,550 INFO  [IDX] Indexer queue size ~ 63</span><br><span class="line">2025-09-22 02:58:27,063 INFO  [req24] GET /root/dev/+simple/</span><br><span class="line">2025-09-22 02:58:27,068 INFO  [req24] starting +simple</span><br><span class="line">2025-09-22 02:58:31,043 INFO  [IDX] Committing 2500 new documents to search index.</span><br><span class="line">2025-09-22 02:58:36,905 INFO  [IDX] Indexer queue size ~ 84</span><br><span class="line">2025-09-22 02:58:40,109 INFO  [IDX] Committing 2500 new documents to search index.</span><br><span class="line">2025-09-22 02:58:46,493 INFO  [IDX] Indexer queue size ~ 105</span><br><span class="line">2025-09-22 02:58:49,808 INFO  [IDX] Committing 2500 new documents to search index.</span><br><span class="line">2025-09-22 02:58:57,171 INFO  [req25] GET /root/pypi/opencv-python/</span><br><span class="line">2025-09-22 02:58:57,452 INFO  [req26] GET /root/pypi/+f/092/c16da4c5a163a/opencv_python-4.12.0.88-cp37-abi3-manylinux2014_x86_64.manylinux_2_17_x86_64.whl</span><br><span class="line">2025-09-22 02:58:57,703 INFO  [req26] [Rtx15] reading remote: URL(&#x27;http://mirrors.aliyun.com/pypi/packages/68/1f/795e7f4aa2eacc59afa4fb61a2e35e510d06414dd5a802b51a012d691b37/opencv_python-4.12.0.88-cp37-abi3-manylinux2014_x86_64.manylinux_2_17_x86_64.whl&#x27;), target root/pypi/+f/092/c16da4c5a163a/opencv_python-4.12.0.88-cp37-abi3-manylinux2014_x86_64.manylinux_2_17_x86_64.whl</span><br><span class="line">2025-09-22 02:58:58,698 INFO  [IDX] Indexer queue size ~ 125</span><br><span class="line">2025-09-22 02:59:02,452 INFO  [IDX] Committing 2500 new documents to search index.</span><br><span class="line">2025-09-22 02:59:13,134 INFO  [Wtx15] fswriter16: committed at 16</span><br><span class="line">2025-09-22 02:59:13,406 INFO  [req27] GET /root/pypi/numpy/</span><br><span class="line">2025-09-22 02:59:16,152 INFO  [IDX] Indexer queue size ~ 144</span><br><span class="line">2025-09-22 02:59:20,559 INFO  [IDX] Committing 2500 new documents to search index.</span><br><span class="line">2025-09-22 02:59:22,506 INFO  [Wtx16] fswriter17: committed at 17</span><br><span class="line">2025-09-22 02:59:22,974 INFO  [req28] GET /root/pypi/+f/fd8/3c01228a68873/numpy-2.2.6-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl</span><br><span class="line">2025-09-22 02:59:23,201 INFO  [req28] [Rtx17] reading remote: URL(&#x27;http://mirrors.aliyun.com/pypi/packages/8c/3d/1e1db36cfd41f895d266b103df00ca5b3cbe965184df824dec5c08c6b803/numpy-2.2.6-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl&#x27;), target root/pypi/+f/fd8/3c01228a68873/numpy-2.2.6-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl</span><br><span class="line">2025-09-22 02:59:25,317 INFO  [Wtx17] fswriter18: committed at 18</span><br><span class="line">2025-09-22 02:59:29,854 INFO  [IDX] Indexer queue size ~ 157</span><br><span class="line">2025-09-22 02:59:32,438 INFO  [req29] GET /czq/devpi</span><br><span class="line">2025-09-22 02:59:33,214 INFO  [req30] GET /czq/devpi/+simple/</span><br><span class="line">2025-09-22 02:59:33,219 INFO  [req30] starting +simple</span><br><span class="line">2025-09-22 02:59:33,222 WARNI [req30] [Rtx18] Index czq/devpi refers to non-existing base czq/pypi.</span><br><span class="line">2025-09-22 02:59:33,419 INFO  [IDX] Committing 2500 new documents to search index.</span><br><span class="line">2025-09-22 02:59:35,333 INFO  [req31] GET /root/dev</span><br><span class="line">2025-09-22 02:59:36,071 INFO  [req32] GET /root/dev/+simple/</span><br><span class="line">2025-09-22 02:59:36,073 INFO  [req32] starting +simple</span><br><span class="line">2025-09-22 02:59:45,543 INFO  [IDX] Indexer queue size ~ 183</span><br><span class="line">2025-09-22 02:59:49,092 INFO  [IDX] Committing 2500 new documents to search index.</span><br><span class="line">2025-09-22 02:59:59,191 INFO  [IDX] Indexer queue size ~ 204</span><br><span class="line">2025-09-22 02:59:59,375 INFO  [req33] GET /</span><br><span class="line">2025-09-22 03:00:02,409 INFO  [req34] GET /+search</span><br><span class="line">2025-09-22 03:00:03,190 INFO  [IDX] Committing 2500 new documents to search index.</span><br><span class="line">2025-09-22 03:00:12,782 INFO  [IDX] Indexer queue size ~ 223</span><br><span class="line">2025-09-22 03:00:16,424 INFO  [IDX] Committing 2500 new documents to search index.</span><br><span class="line">2025-09-22 03:00:22,925 INFO  [IDX] Indexer queue size ~ 243</span><br></pre></td></tr></table></figure><h2 id="python-æ­å»ºé«˜å¯ç”¨">python æ­å»ºé«˜å¯ç”¨</h2><ul><li>python flask</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ha_proxy.py</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, Response, request</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- é«˜å¯ç”¨é•œåƒæºåˆ—è¡¨ ---</span></span><br><span class="line"><span class="comment"># å°†æŒ‰ç…§è¿™ä¸ªé¡ºåºå°è¯•ã€‚å¯ä»¥éšæ„å¢åˆ æˆ–è°ƒæ•´é¡ºåºã€‚</span></span><br><span class="line">UPSTREAM_MIRRORS = [</span><br><span class="line">    <span class="string">&quot;https://pypi.tuna.tsinghua.edu.cn/simple&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://mirrors.aliyun.com/pypi/simple&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://pypi.mirrors.ustc.edu.cn/simple&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://mirrors.cloud.tencent.com/pypi/simple&quot;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿æ¥å’Œè¯»å–çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line">TIMEOUT = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&lt;path:path&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">proxy</span>(<span class="params">path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æ¥æ”¶æ¥è‡ª devpi-server çš„æ‰€æœ‰è¯·æ±‚ï¼Œå¹¶å°è¯•ä»ä¸Šæ¸¸é•œåƒåˆ—è¡¨ä¸­è·å–ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> base_url <span class="keyword">in</span> UPSTREAM_MIRRORS:</span><br><span class="line">        url = <span class="string">f&quot;<span class="subst">&#123;base_url&#125;</span>/<span class="subst">&#123;path&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;HA-PROXY: Attempting to fetch from <span class="subst">&#123;url&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># `requests` ä¼šè‡ªåŠ¨ä½¿ç”¨ HTTP_PROXY/HTTPS_PROXY ç¯å¢ƒå˜é‡</span></span><br><span class="line">            response = requests.get(url, timeout=TIMEOUT, stream=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># å¦‚æœè¯·æ±‚æˆåŠŸ (ä¾‹å¦‚ 200 OK)</span></span><br><span class="line">            <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;HA-PROXY: Success from <span class="subst">&#123;url&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="comment"># ä½¿ç”¨æµå¼å“åº”ï¼Œé¿å…å¤§æ–‡ä»¶å ç”¨è¿‡å¤šå†…å­˜</span></span><br><span class="line">                <span class="keyword">return</span> Response(response.iter_content(chunk_size=<span class="number">8192</span>),</span><br><span class="line">                                status=response.status_code,</span><br><span class="line">                                content_type=response.headers[<span class="string">&#x27;Content-Type&#x27;</span>])</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># å¦‚æœæ˜¯ 404ï¼Œè¯´æ˜è¿™ä¸ªæºæ²¡æœ‰è¿™ä¸ªåŒ…ï¼Œç«‹å³å°è¯•ä¸‹ä¸€ä¸ª</span></span><br><span class="line">            <span class="keyword">elif</span> response.status_code == <span class="number">404</span>:</span><br><span class="line">                 <span class="built_in">print</span>(<span class="string">f&quot;HA-PROXY: Got 404 from <span class="subst">&#123;url&#125;</span>, trying next mirror.&quot;</span>)</span><br><span class="line">                 <span class="keyword">continue</span> <span class="comment"># ç»§ç»­ä¸‹ä¸€ä¸ªå¾ªç¯</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># å…¶ä»–å®¢æˆ·ç«¯é”™è¯¯ï¼Œä¹Ÿå°è¯•ä¸‹ä¸€ä¸ª</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;HA-PROXY: Got client error <span class="subst">&#123;response.status_code&#125;</span> from <span class="subst">&#123;url&#125;</span>, trying next mirror.&quot;</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> requests.exceptions.RequestException <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># æ•è·æ‰€æœ‰ç½‘ç»œå±‚é¢çš„é”™è¯¯ (å¦‚è¶…æ—¶ã€è¿æ¥å¤±è´¥)</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;HA-PROXY: Failed to connect to <span class="subst">&#123;base_url&#125;</span>. Error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span> <span class="comment"># ç»§ç»­ä¸‹ä¸€ä¸ªå¾ªç¯</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¦‚æœæ‰€æœ‰é•œåƒæºéƒ½å°è¯•å¤±è´¥</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;HA-PROXY: All upstream mirrors failed for path: <span class="subst">&#123;path&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> Response(<span class="string">&quot;All upstream mirrors failed.&quot;</span>, status=<span class="number">502</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># ç›‘å¬åœ¨ 8000 ç«¯å£ï¼Œåªæ¥å—æ¥è‡ªå®¹å™¨å†…éƒ¨çš„è¿æ¥</span></span><br><span class="line">    app.run(host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure><ul><li>supervisord.conf</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">; supervisord.conf (æœ€ç»ˆç”Ÿäº§ç‰ˆ)</span><br><span class="line"></span><br><span class="line">[supervisord]</span><br><span class="line">nodaemon=true</span><br><span class="line"></span><br><span class="line">[program:devpi]</span><br><span class="line">command=devpi-server --serverdir /var/lib/devpi --host 0.0.0.0 --port 7104</span><br><span class="line">user=devpiuser ; &lt;--- ä¿®æ”¹è¿™é‡Œ</span><br><span class="line">autostart=true</span><br><span class="line">autorestart=true</span><br><span class="line">stderr_logfile=/var/log/supervisor/devpi_err.log</span><br><span class="line">stdout_logfile=/var/log/supervisor/devpi_out.log</span><br><span class="line"></span><br><span class="line">[program:ha_proxy]</span><br><span class="line">command=python3 /app/ha_proxy.py</span><br><span class="line">user=devpiuser ; &lt;--- ä¿®æ”¹è¿™é‡Œ</span><br><span class="line">autostart=true</span><br><span class="line">autorestart=true</span><br><span class="line">stderr_logfile=/var/log/supervisor/ha_proxy_err.log</span><br><span class="line">stdout_logfile=/var/log/supervisor/ha_proxy_out.log</span><br></pre></td></tr></table></figure><h3 id="åŒæ­¥æ›´æ–°dockerfileå’Œdocker-compose-yml">åŒæ­¥æ›´æ–°dockerfileå’Œdocker-compose.yml</h3><ul><li>Dockerfile</li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dockerfile (æœ€ç»ˆç”Ÿäº§ç‰ˆ)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.9</span>-slim</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&#x27;s/deb.debian.org/mirrors.aliyun.com/g&#x27;</span> /etc/apt/sources.list.d/debian.sources</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip config <span class="built_in">set</span> global.index-url https://pypi.tuna.tsinghua.edu.cn/simple</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- ã€å…³é”®ä¿®å¤ã€‘åˆ›å»ºä¸€ä¸ªä¸“ç”¨çš„é root ç”¨æˆ· ---</span></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªåä¸º devpiuser çš„ç³»ç»Ÿç»„å’Œç”¨æˆ·ï¼Œå¹¶æŒ‡å®šå…¶ ID ä¸º 1000</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> adduser \</span></span><br><span class="line"><span class="language-bash">    --system \</span></span><br><span class="line"><span class="language-bash">    --group \</span></span><br><span class="line"><span class="language-bash">    --uid 1000 \</span></span><br><span class="line"><span class="language-bash">    --no-create-home \</span></span><br><span class="line"><span class="language-bash">    --disabled-password \</span></span><br><span class="line"><span class="language-bash">    devpiuser</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- å®‰è£…æ‰€æœ‰ä¾èµ– ---</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y supervisor &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    pip install --no-cache-dir --upgrade pip &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    pip install --no-cache-dir \</span></span><br><span class="line"><span class="language-bash">        <span class="string">&quot;devpi-server==6.9.2&quot;</span> \</span></span><br><span class="line"><span class="language-bash">        <span class="string">&quot;devpi-web==4.1.0&quot;</span> \</span></span><br><span class="line"><span class="language-bash">        <span class="string">&quot;httpx==0.22.0&quot;</span> \</span></span><br><span class="line"><span class="language-bash">        <span class="string">&quot;flask&quot;</span> \</span></span><br><span class="line"><span class="language-bash">        <span class="string">&quot;requests&quot;</span> &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- å¤åˆ¶é…ç½®æ–‡ä»¶å’Œè„šæœ¬ ---</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> supervisord.conf /etc/supervisor/conf.d/supervisord.conf</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ha_proxy.py /app/ha_proxy.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- æƒé™ä¿®å¤ ---</span></span><br><span class="line"><span class="comment"># ä½¿ç”¨æ–°åˆ›å»ºçš„ç”¨æˆ·å devpiuser æ¥è®¾ç½®æƒé™</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> -p /var/log/supervisor</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> /var/lib/devpi</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chown</span> -R devpiuser:devpiuser /var/lib/devpi</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chown</span> -R devpiuser:devpiuser /var/log/supervisor</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®¹å™¨å°†ä»¥ root å¯åŠ¨ï¼Œç”± supervisor è´Ÿè´£é™æƒ</span></span><br><span class="line"><span class="comment"># USER devpiuser (è¿™é‡Œä¸éœ€è¦ï¼Œsupervisor ä¼šå¤„ç†)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">7104</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/usr/bin/supervisord&quot;</span>]</span></span><br></pre></td></tr></table></figure><ul><li>docker-compose.yml</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.yml (ä¸æœ€ç»ˆé«˜å¯ç”¨ç‰ˆ Dockerfile é…åˆä½¿ç”¨)</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.7&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">devpi-lib:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">devpi-lib</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;7104:7104&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">devpi-data:/var/lib/devpi</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="comment"># ä»£ç†é…ç½®ä¾ç„¶éœ€è¦ï¼Œha_proxy.py ä¼šä½¿ç”¨å®ƒ</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">http_proxy=http://192.168.12.80:7890</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">https_proxy=http://192.168.12.80:7890</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">HTTP_PROXY=http://192.168.12.80:7890</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">HTTPS_PROXY=http://192.168.12.80:7890</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">devpi-data:</span></span><br></pre></td></tr></table></figure><ul><li>docker build</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> docker-compose up -d --build --force-recreate</span><br></pre></td></tr></table></figure><ul><li>mirror set</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">devpi login root --password=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># å°† mirror_url æŒ‡å‘æˆ‘ä»¬å†…éƒ¨çš„ HA ä»£ç†æœåŠ¡</span></span><br><span class="line">devpi index root/pypi mirror_url=http://127.0.0.1:8000/</span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure><h2 id="See">See</h2><ul><li><ol><li><a href="https://github.com/devpi/devpi">https://github.com/devpi/devpi</a></li></ol></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;ä½¿ç”¨Devpiä¸Nginxæ„å»ºé«˜å¯ç”¨PyPIé•œåƒæº&quot;&gt;ä½¿ç”¨Devpiä¸Nginxæ„å»ºé«˜å¯ç”¨PyPIé•œåƒæº&lt;/h2&gt;
&lt;h3 id=&quot;å‰è¨€ï¼šä¸ºä»€ä¹ˆä½ çš„pip-installåˆè¶…æ—¶äº†ï¼Ÿ&quot;&gt;å‰è¨€ï¼šä¸ºä»€ä¹ˆä½ çš„&lt;code&gt;pip install&lt;/code&gt;åˆè¶…æ—¶äº†ï¼Ÿ&lt;/h</summary>
      
    
    
    
    
    <category term="python" scheme="https://caozhaoqi.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ Docker Compose å¿«é€Ÿéƒ¨ç½² Shadowsocks ä»£ç†æœåŠ¡æ•™ç¨‹</title>
    <link href="https://caozhaoqi.github.io/2025/08/29/ss-build-doc/"/>
    <id>https://caozhaoqi.github.io/2025/08/29/ss-build-doc/</id>
    <published>2025-08-29T01:06:20.000Z</published>
    <updated>2025-11-25T15:05:10.365Z</updated>
    
    <content type="html"><![CDATA[<h2 id="åŸºç¡€ç¯å¢ƒ">åŸºç¡€ç¯å¢ƒ</h2><h4 id="1-1-æ›´æ–°ç³»ç»Ÿè½¯ä»¶åŒ…åˆ—è¡¨">1.1 æ›´æ–°ç³»ç»Ÿè½¯ä»¶åŒ…åˆ—è¡¨</h4><p>é¦–å…ˆï¼Œè¿æ¥åˆ°æ‚¨çš„æœåŠ¡å™¨ï¼Œç„¶åè¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥æ›´æ–°ç³»ç»Ÿçš„è½¯ä»¶åŒ…ç´¢å¼•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get update -y</span><br></pre></td></tr></table></figure><p>d</p><h4 id="1-2-å®‰è£…-Docker-çš„ä¾èµ–é¡¹">1.2 å®‰è£… Docker çš„ä¾èµ–é¡¹</h4><p>æ¥ä¸‹æ¥ï¼Œå®‰è£…ä¸€äº›å¿…è¦çš„è½¯ä»¶åŒ…ï¼Œä»¥å…è®¸ <code>apt</code> é€šè¿‡ HTTPS ä½¿ç”¨ Docker çš„è½¯ä»¶ä»“åº“ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install -y \</span><br><span class="line">    apt-transport-https \</span><br><span class="line">    ca-certificates \</span><br><span class="line">    curl \</span><br><span class="line">    software-properties-common</span><br></pre></td></tr></table></figure><h4 id="1-3-æ·»åŠ -Docker-å®˜æ–¹-GPG-å¯†é’¥">1.3 æ·»åŠ  Docker å®˜æ–¹ GPG å¯†é’¥</h4><p>ä¸ºäº†å®‰å…¨èµ·è§ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ  Docker çš„å®˜æ–¹ GPG å¯†é’¥ã€‚è¿™ä¼šéªŒè¯æˆ‘ä»¬ä¸‹è½½çš„ Docker è½¯ä»¶åŒ…æ˜¯å®˜æ–¹å‘å¸ƒçš„ï¼Œæœªç»ç¯¡æ”¹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºç”¨äºå­˜æ”¾å¯†é’¥çš„ç›®å½•</span></span><br><span class="line"><span class="built_in">sudo</span> install -m 0755 -d /etc/apt/keyrings</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½ Docker çš„ GPG å¯†é’¥</span></span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | <span class="built_in">sudo</span> gpg --dearmor -o /etc/apt/keyrings/docker.gpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹å¯†é’¥æ–‡ä»¶çš„æƒé™</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> a+r /etc/apt/keyrings/docker.gpg</span><br></pre></td></tr></table></figure><h4 id="1-4-è®¾ç½®-Docker-çš„-APT-è½¯ä»¶æº">1.4 è®¾ç½® Docker çš„ APT è½¯ä»¶æº</h4><p>ç°åœ¨ï¼Œæˆ‘ä»¬å°† Docker çš„å®˜æ–¹è½¯ä»¶æºåœ°å€æ·»åŠ åˆ°æˆ‘ä»¬ç³»ç»Ÿçš„æºåˆ—è¡¨ä¸­ã€‚è¿™æ ·ï¼Œ<code>apt</code> å‘½ä»¤å°±èƒ½æ‰¾åˆ°å¹¶å®‰è£… Docker äº†ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> \</span><br><span class="line">  <span class="string">&quot;deb [arch=<span class="subst">$(dpkg --print-architecture)</span> signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">  <span class="subst">$(. /etc/os-release &amp;&amp; echo <span class="string">&quot;<span class="variable">$VERSION_CODENAME</span>&quot;</span>)</span> stable&quot;</span> | \</span><br><span class="line">  <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null```</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 1.5 å®‰è£… Docker å¼•æ“å’Œ Compose V2</span></span><br><span class="line"></span><br><span class="line">å†æ¬¡æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨ï¼Œä»¥åŒ…å«æ¥è‡ª Docker å®˜æ–¹æºçš„è½¯ä»¶åŒ…ä¿¡æ¯ï¼Œç„¶åæ‰§è¡Œå®‰è£…ï¼š</span><br><span class="line"></span><br><span class="line">```bash</span><br><span class="line"><span class="comment"># å†æ¬¡æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get update -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… Docker å¼•æ“, å‘½ä»¤è¡Œå·¥å…·, containerd å’Œ Docker Compose V2 æ’ä»¶</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin</span><br></pre></td></tr></table></figure><h4 id="1-6-å¯é€‰ä½†æ¨è-é…ç½®é-root-ç”¨æˆ·è¿è¡Œ-Docker">1.6 (å¯é€‰ä½†æ¨è) é…ç½®é root ç”¨æˆ·è¿è¡Œ Docker</h4><p>æ¯æ¬¡éƒ½è¾“å…¥ <code>sudo</code> æ¥è¿è¡Œ Docker å‘½ä»¤å¾ˆéº»çƒ¦ã€‚æˆ‘ä»¬å¯ä»¥å°†å½“å‰ç”¨æˆ·æ·»åŠ åˆ° <code>docker</code> ç”¨æˆ·ç»„ï¼Œä»è€Œå…å» <code>sudo</code>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†æ‚¨çš„ç”¨æˆ·ï¼ˆ$USER æ˜¯ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œä»£è¡¨å½“å‰ç”¨æˆ·ï¼‰æ·»åŠ åˆ° docker ç»„</span></span><br><span class="line"><span class="built_in">sudo</span> usermod -aG docker <span class="variable">$USER</span></span><br></pre></td></tr></table></figure><p><strong>é‡è¦æç¤ºï¼š</strong> æ‰§è¡Œæ­¤å‘½ä»¤åï¼Œæ‚¨éœ€è¦<strong>å®Œå…¨é€€å‡º SSH ä¼šè¯å¹¶é‡æ–°ç™»å½•</strong>ï¼Œæ‰èƒ½ä½¿æƒé™æ›´æ”¹ç”Ÿæ•ˆï¼</p><hr><h3 id="ç¬¬äºŒæ­¥ï¼šé…ç½®å¹¶éƒ¨ç½²-Shadowsocks-æœåŠ¡">ç¬¬äºŒæ­¥ï¼šé…ç½®å¹¶éƒ¨ç½² Shadowsocks æœåŠ¡</h3><p>ç¯å¢ƒå‡†å¤‡å¥½åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹å®šä¹‰å’Œéƒ¨ç½²æˆ‘ä»¬çš„ Shadowsocks æœåŠ¡äº†ã€‚</p><h4 id="2-1-åˆ›å»ºä¸€ä¸ªå·¥ä½œç›®å½•">2.1 åˆ›å»ºä¸€ä¸ªå·¥ä½œç›®å½•</h4><p>ä¸ºæˆ‘ä»¬çš„é¡¹ç›®åˆ›å»ºä¸€ä¸ªä¸“é—¨çš„ç›®å½•ï¼Œè¿™æ ·å¯ä»¥ä¿æŒæ•´æ´ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªåä¸º ss çš„ç›®å½•å¹¶è¿›å…¥</span></span><br><span class="line"><span class="built_in">mkdir</span> ~/ss</span><br><span class="line"><span class="built_in">cd</span> ~/ss</span><br></pre></td></tr></table></figure><h4 id="2-2-ç¼–å†™-docker-compose-yml-é…ç½®æ–‡ä»¶">2.2 ç¼–å†™ <code>docker-compose.yml</code> é…ç½®æ–‡ä»¶</h4><p>è¿™æ˜¯æ•´ä¸ªéƒ¨ç½²çš„æ ¸å¿ƒã€‚æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªåä¸º <code>docker-compose.yml</code> çš„æ–‡ä»¶ï¼Œå®ƒåƒä¸€ä»½è“å›¾ï¼Œè¯¦ç»†æè¿°äº†æˆ‘ä»¬çš„æœåŠ¡åº”è¯¥å¦‚ä½•è¿è¡Œã€‚</p><p>ä½¿ç”¨æ‚¨å–œæ¬¢çš„æ–‡æœ¬ç¼–è¾‘å™¨ï¼ˆè¿™é‡Œä»¥ <code>nano</code> ä¸ºä¾‹ï¼Œå®ƒæ¯” <code>vim</code> æ›´æ˜“ä¸Šæ‰‹ï¼‰åˆ›å»ºæ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim docker-compose.yml</span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œå°†ä»¥ä¸‹å†…å®¹<strong>å¤åˆ¶å¹¶ç²˜è´´</strong>åˆ°ç¼–è¾‘å™¨ä¸­ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ Compose æ–‡ä»¶æ ¼å¼çš„ç‰ˆæœ¬ 3</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰æ‰€æœ‰æœåŠ¡</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="comment"># å®šä¹‰ä¸€ä¸ªåä¸º &quot;shadowsocks&quot; çš„æœåŠ¡</span></span><br><span class="line">  <span class="attr">shadowsocks:</span></span><br><span class="line">    <span class="comment"># æŒ‡å®šè¦ä½¿ç”¨çš„ Docker é•œåƒï¼Œæˆ‘ä»¬ä½¿ç”¨å®˜æ–¹çš„ shadowsocks-libev</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">shadowsocks/shadowsocks-libev</span></span><br><span class="line">    <span class="comment"># ç»™è¿è¡Œçš„å®¹å™¨èµ·ä¸€ä¸ªå›ºå®šçš„åå­—ï¼Œæ–¹ä¾¿æˆ‘ä»¬ç®¡ç†</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">shadowsocks</span></span><br><span class="line">    <span class="comment"># è®¾ç½®ç«¯å£æ˜ å°„ (æ ¼å¼: &quot;ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£&quot;)</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="comment"># å°†æœåŠ¡å™¨çš„ TCP 8388 ç«¯å£æ˜ å°„åˆ°å®¹å™¨çš„ TCP 8388 ç«¯å£</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8388:8388/tcp&quot;</span></span><br><span class="line">      <span class="comment"># å°†æœåŠ¡å™¨çš„ UDP 8388 ç«¯å£ä¹Ÿæ˜ å°„å‡ºå» (ç”¨äºæ¸¸æˆã€è§†é¢‘é€šè¯ç­‰)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8388:8388/udp&quot;</span></span><br><span class="line">    <span class="comment"># è®¾ç½®å®¹å™¨çš„é‡å¯ç­–ç•¥</span></span><br><span class="line">    <span class="comment"># unless-stopped: é™¤éæˆ‘ä»¬æ‰‹åŠ¨åœæ­¢å®¹å™¨ï¼Œå¦åˆ™å®ƒæ€»æ˜¯åœ¨é€€å‡ºåè‡ªåŠ¨é‡å¯</span></span><br><span class="line">    <span class="comment"># (åŒ…æ‹¬æœåŠ¡å™¨é‡å¯åï¼ŒæœåŠ¡ä¹Ÿä¼šè‡ªåŠ¨æ‹‰èµ·ï¼Œéå¸¸çœå¿ƒ)</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="comment"># è®¾ç½®å®¹å™¨å†…çš„ç¯å¢ƒå˜é‡ï¼Œç”¨äºé…ç½® Shadowsocks</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="comment"># è®¾ç½®åŠ å¯†æ–¹æ³•ï¼Œchacha20-ietf-poly1305 æ˜¯ç›®å‰æ¨èçš„å®‰å…¨ä¸”é«˜æ•ˆçš„ç®—æ³•</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">METHOD=chacha20-ietf-poly1305</span></span><br><span class="line">      <span class="comment"># åœ¨è¿™é‡Œè®¾ç½®æ‚¨çš„è¿æ¥å¯†ç ï¼è¯·åŠ¡å¿…æ›¿æ¢æˆä¸€ä¸ªæ‚¨è‡ªå·±çš„å¼ºå¯†ç ï¼</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PASSWORD=YOUR_STRONG_PASSWORD_HERE</span></span><br></pre></td></tr></table></figure><p><strong>é‡è¦é…ç½®ä¿®æ”¹ï¼š</strong></p><ul><li><strong><code>PASSWORD</code></strong>: å°† <code>YOUR_STRONG_PASSWORD_HERE</code> <strong>æ›¿æ¢ä¸ºæ‚¨è‡ªå·±è®¾å®šçš„ä¸€ä¸ªå¼ºå¯†ç </strong>ã€‚è¿™æ˜¯æ‚¨çš„å®¢æˆ·ç«¯è¿æ¥æ—¶éœ€è¦ç”¨åˆ°çš„å‡­è¯ã€‚</li><li><strong><code>ports</code></strong>: å¦‚æœæ‚¨æœåŠ¡å™¨çš„ <code>8388</code> ç«¯å£å·²è¢«å…¶ä»–æœåŠ¡å ç”¨ï¼Œæ‚¨å¯ä»¥ä¿®æ”¹ä¸»æœºç«¯å£ã€‚ä¾‹å¦‚ï¼Œæ”¹æˆ <code>&quot;10086:8388/tcp&quot;</code>ï¼Œè¿™æ ·æ‚¨çš„å®¢æˆ·ç«¯å°±éœ€è¦è¿æ¥æœåŠ¡å™¨çš„ <code>10086</code> ç«¯å£ã€‚</li></ul><p>ä¿®æ”¹å®Œæˆåï¼Œåœ¨ <code>nano</code> ç¼–è¾‘å™¨ä¸­ï¼ŒæŒ‰ <code>Ctrl + X</code>ï¼Œç„¶åæŒ‰ <code>Y</code>ï¼Œæœ€åæŒ‰ <code>Enter</code> ä¿å­˜å¹¶é€€å‡ºã€‚</p><h4 id="2-3-å¯åŠ¨-Shadowsocks-æœåŠ¡">2.3 å¯åŠ¨ Shadowsocks æœåŠ¡</h4><p>ç°åœ¨ï¼Œæ¿€åŠ¨äººå¿ƒçš„æ—¶åˆ»åˆ°äº†ï¼åœ¨ <code>docker-compose.yml</code> æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ï¼ˆå³ <code>~/ss</code>ï¼‰ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ³¨æ„ï¼šå¦‚æœæ‚¨åœ¨ 1.6 æ­¥ä¸­é…ç½®äº†ç”¨æˆ·ç»„ï¼Œè¿™é‡Œå°±ä¸éœ€è¦ sudo äº†</span></span><br><span class="line"><span class="comment"># æ–°ç‰ˆå‘½ä»¤ (æ¨è)</span></span><br><span class="line">docker compose up -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ—§ç‰ˆå‘½ä»¤ (ä¹Ÿèƒ½å·¥ä½œ)</span></span><br><span class="line"><span class="comment"># docker-compose up -d</span></span><br></pre></td></tr></table></figure><ul><li><code>up</code>: å‘Šè¯‰ Docker Compose å¯åŠ¨å¹¶è¿è¡ŒæœåŠ¡ã€‚</li><li><code>-d</code>: (<code>--detach</code>) å‚æ•°è¡¨ç¤ºåœ¨åå°è¿è¡ŒæœåŠ¡ã€‚è¿™æ˜¯å¿…é¡»çš„ï¼Œå¦åˆ™å½“æ‚¨å…³é—­ SSH çª—å£æ—¶ï¼ŒæœåŠ¡ä¹Ÿä¼šåœæ­¢ã€‚</li></ul><p>Docker Compose ç°åœ¨ä¼šè‡ªåŠ¨ï¼š</p><ol><li>æ£€æŸ¥ <code>docker-compose.yml</code> æ–‡ä»¶ã€‚</li><li>ä» Docker Hub ä¸Šæ‹‰å– <code>shadowsocks/shadowsocks-libev</code> é•œåƒï¼ˆå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œï¼‰ã€‚</li><li>æ ¹æ®æ‚¨çš„é…ç½®åˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªåä¸º <code>shadowsocks</code> çš„å®¹å™¨ã€‚</li></ol><hr><h3 id="ç¬¬ä¸‰æ­¥ï¼šéªŒè¯æœåŠ¡ä¸å®¢æˆ·ç«¯é…ç½®">ç¬¬ä¸‰æ­¥ï¼šéªŒè¯æœåŠ¡ä¸å®¢æˆ·ç«¯é…ç½®</h3><blockquote><p>æœåŠ¡å¯åŠ¨åï¼Œæˆ‘ä»¬éœ€è¦ç¡®è®¤å®ƒæ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œå¹¶é…ç½®å®¢æˆ·ç«¯è¿›è¡Œè¿æ¥ã€‚</p></blockquote><h4 id="3-1-æ£€æŸ¥å®¹å™¨è¿è¡ŒçŠ¶æ€">3.1 æ£€æŸ¥å®¹å™¨è¿è¡ŒçŠ¶æ€</h4><p>è¿è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å½“å‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></table></figure><p>æ‚¨åº”è¯¥èƒ½çœ‹åˆ°ç±»ä¼¼ä¸‹é¢çš„è¾“å‡ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CONTAINER ID   IMAGE                           COMMAND                  CREATED         STATUS         PORTS                                                 NAMES</span><br><span class="line">a1b2c3d4e5f6   shadowsocks/shadowsocks-libev   &quot;/usr/bin/ss-server â€¦&quot;   30 seconds ago   Up 29 seconds   0.0.0.0:8388-&gt;8388/tcp, 0.0.0.0:8388-&gt;8388/udp   shadowsocks</span><br></pre></td></tr></table></figure><p>è¯·å…³æ³¨ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li><strong><code>IMAGE</code></strong>: ç¡®è®¤æ˜¯ <code>shadowsocks/shadowsocks-libev</code>ã€‚</li><li><strong><code>STATUS</code></strong>: å¿…é¡»æ˜¯ <code>Up ...</code>ï¼Œè¡¨ç¤ºæ­£åœ¨å¥åº·è¿è¡Œã€‚å¦‚æœæ˜¯ <code>Exited</code>ï¼Œè¯´æ˜å¯åŠ¨å¤±è´¥ã€‚</li><li><strong><code>PORTS</code></strong>: ç¡®è®¤ç«¯å£æ˜ å°„æ­£ç¡®ã€‚</li><li><strong><code>NAMES</code></strong>: ç¡®è®¤æ˜¯ <code>shadowsocks</code>ã€‚</li></ul><h4 id="3-2-æŸ¥çœ‹æœåŠ¡æ—¥å¿—">3.2 æŸ¥çœ‹æœåŠ¡æ—¥å¿—</h4><p>å¦‚æœå®¹å™¨å¯åŠ¨å¤±è´¥ï¼Œæˆ–è€…æ‚¨æƒ³ç¡®è®¤æœåŠ¡çš„å†…éƒ¨è¿è¡Œæƒ…å†µï¼ŒæŸ¥çœ‹æ—¥å¿—æ˜¯æœ€ä½³æ–¹å¼ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs shadowsocks</span><br></pre></td></tr></table></figure><p>æˆåŠŸçš„æ—¥å¿—ä¼šæ˜¾ç¤ºæœåŠ¡æ­£åœ¨ç›‘å¬ç«¯å£ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INFO: initializing ciphers... chacha20-ietf-poly1305</span><br><span class="line">INFO: listening at 0.0.0.0:8388</span><br></pre></td></tr></table></figure><h4 id="3-3-é…ç½®æ‚¨çš„å®¢æˆ·ç«¯">3.3 é…ç½®æ‚¨çš„å®¢æˆ·ç«¯</h4><p>ç°åœ¨ï¼Œæ‚¨å¯ä»¥åœ¨æ‚¨çš„ç”µè„‘æˆ–æ‰‹æœºä¸Šé…ç½® Shadowsocks å®¢æˆ·ç«¯äº†ã€‚å¡«å…¥ä»¥ä¸‹ä¿¡æ¯ï¼š</p><ul><li><strong>æœåŠ¡å™¨åœ°å€ (Server Address)</strong>: <code>æ‚¨æœåŠ¡å™¨çš„å…¬ç½‘ IP åœ°å€</code></li><li><strong>æœåŠ¡å™¨ç«¯å£ (Server Port)</strong>: <code>8388</code> (æˆ–è€…æ‚¨åœ¨ <code>docker-compose.yml</code> ä¸­è®¾ç½®çš„ä¸»æœºç«¯å£)</li><li><strong>å¯†ç  (Password)</strong>: <code>æ‚¨åœ¨ docker-compose.yml ä¸­è®¾ç½®çš„å¯†ç </code></li><li><strong>åŠ å¯†æ–¹æ³• (Encryption/Method)</strong>: <code>chacha20-ietf-poly1305</code></li></ul><p>ä¿å­˜é…ç½®å¹¶è¿æ¥ï¼Œç°åœ¨æ‚¨åº”è¯¥å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ï¼</p><hr><h3 id="ç¬¬å››æ­¥ï¼šå¸¸ç”¨ç®¡ç†å‘½ä»¤">ç¬¬å››æ­¥ï¼šå¸¸ç”¨ç®¡ç†å‘½ä»¤</h3><ul><li><strong>åœæ­¢æœåŠ¡</strong>:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨ ~/ss ç›®å½•ä¸‹è¿è¡Œ</span></span><br><span class="line">docker compose down</span><br></pre></td></tr></table></figure></li><li><strong>é‡å¯æœåŠ¡</strong>:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨ ~/ss ç›®å½•ä¸‹è¿è¡Œ</span></span><br><span class="line">docker compose restart</span><br></pre></td></tr></table></figure></li><li><strong>æ›´æ–°æœåŠ¡ (ä¾‹å¦‚æ›´æ–° Shadowsocks é•œåƒ)</strong>:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨ ~/ss ç›®å½•ä¸‹è¿è¡Œ</span></span><br><span class="line"><span class="comment"># 1. æ‹‰å–æœ€æ–°çš„é•œåƒ</span></span><br><span class="line">docker compose pull</span><br><span class="line"><span class="comment"># 2. é‡æ–°åˆ›å»ºå¹¶å¯åŠ¨å®¹å™¨</span></span><br><span class="line">docker compose up -d</span><br></pre></td></tr></table></figure></li></ul><h2 id="å®¢æˆ·ç«¯">å®¢æˆ·ç«¯</h2><ul><li>windows</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/shadowsocks/shadowsocks-windows</span><br></pre></td></tr></table></figure><ul><li>android</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/shadowsocks/shadowsocks-android</span><br></pre></td></tr></table></figure><h2 id="ä»£ç†æ¨¡å¼">ä»£ç†æ¨¡å¼</h2><ul><li><p>ç¦ç”¨ (Disabled)ï¼šä¸ä½¿ç”¨ä»£ç†ã€‚ç­‰åŒäºå–æ¶ˆå‹¾é€‰â€œå¯ç”¨ç³»ç»Ÿä»£ç†â€ã€‚</p></li><li><p>PAC æ¨¡å¼ (PAC)ï¼šæ¨èæ—¥å¸¸ä½¿ç”¨ã€‚æ­¤æ¨¡å¼ä¸‹ï¼Œå®¢æˆ·ç«¯ä¼šæ ¹æ®ä¸€ä¸ªåä¸º PAC (Proxy Auto-Config) çš„è§„åˆ™åˆ—è¡¨æ¥åˆ¤æ–­ã€‚</p></li><li><p>å…¨å±€æ¨¡å¼ (Global)ï¼šæ‰€æœ‰ç½‘ç»œæµé‡éƒ½å¼ºåˆ¶é€šè¿‡ä»£ç†æœåŠ¡å™¨ã€‚</p></li></ul><h2 id="See">See</h2><ul><li><a href="https://github.com/shadowsocks/shadowsocks-rust">https://github.com/shadowsocks/shadowsocks-rust</a></li><li><a href="https://github.com/shadowsocks/shadowsocks-windows">https://github.com/shadowsocks/shadowsocks-windows</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;åŸºç¡€ç¯å¢ƒ&quot;&gt;åŸºç¡€ç¯å¢ƒ&lt;/h2&gt;
&lt;h4 id=&quot;1-1-æ›´æ–°ç³»ç»Ÿè½¯ä»¶åŒ…åˆ—è¡¨&quot;&gt;1.1 æ›´æ–°ç³»ç»Ÿè½¯ä»¶åŒ…åˆ—è¡¨&lt;/h4&gt;
&lt;p&gt;é¦–å…ˆï¼Œè¿æ¥åˆ°æ‚¨çš„æœåŠ¡å™¨ï¼Œç„¶åè¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥æ›´æ–°ç³»ç»Ÿçš„è½¯ä»¶åŒ…ç´¢å¼•ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;ta</summary>
      
    
    
    
    
    <category term="python" scheme="https://caozhaoqi.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>PyAVç”¨äºè§†é¢‘å‰ªè¾‘å¤„ç†</title>
    <link href="https://caozhaoqi.github.io/2025/08/14/pyav-use-video/"/>
    <id>https://caozhaoqi.github.io/2025/08/14/pyav-use-video/</id>
    <published>2025-08-14T10:54:52.000Z</published>
    <updated>2025-11-25T15:05:10.344Z</updated>
    
    <content type="html"><![CDATA[<h1>PyAVç”¨äºè§†é¢‘å‰ªè¾‘å¤„ç†</h1><blockquote><p>PyAVæ˜¯FFmpegåº“çš„Pythonicç»‘å®šã€‚å®ƒå…è®¸ä½ ç›´æ¥åœ¨Pythonä»£ç ä¸­ï¼Œä»¥ä¸€ç§æå…¶ç²¾ç»†å’Œé«˜æ•ˆçš„æ–¹å¼è®¿é—®FFmpegçš„å†…éƒ¨åŠŸèƒ½ã€‚è¿™æ„å‘³ç€ï¼š</p></blockquote><ul><li><strong>å†…å­˜æ“ä½œ</strong>ï¼šç›´æ¥åœ¨å†…å­˜ä¸­å¤„ç†è§†é¢‘å¸§å’ŒéŸ³é¢‘æ ·æœ¬ï¼Œæ— éœ€åˆ›å»ºå¤§é‡ä¸´æ—¶æ–‡ä»¶ã€‚</li><li><strong>ç²¾ç»†æ§åˆ¶</strong>ï¼šä½ å¯ä»¥å®Œå…¨æ§åˆ¶å®¹å™¨çš„è§£å¤ç”¨ã€æ•°æ®åŒ…çš„è§£ç ã€å¸§çš„å¤„ç†å’Œç¼–ç çš„æ¯ä¸€ä¸ªç¯èŠ‚ã€‚</li><li><strong>ç¡¬ä»¶åŠ é€Ÿ</strong>ï¼šå¯ä»¥åˆ©ç”¨GPUï¼ˆå¦‚macOSçš„VideoToolbox, Linux/Windowsçš„CUDA/NVENCï¼‰æ¥æå¤§åœ°åŠ é€Ÿè§£ç å’Œç¼–ç è¿‡ç¨‹ã€‚</li><li><strong>é«˜åº¦é›†æˆ</strong>ï¼šå¯ä»¥æ— ç¼åœ°å°†è§†é¢‘å¸§ä¸NumPyã€Pillowç­‰æµè¡Œçš„Pythonåº“ç»“åˆä½¿ç”¨ã€‚</li></ul><h3 id="PyAVçš„æ ¸å¿ƒæ¦‚å¿µ">PyAVçš„æ ¸å¿ƒæ¦‚å¿µ</h3><blockquote><p>åœ¨æ·±å…¥ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œå®ƒä»¬ç›´æ¥æ˜ å°„è‡ªFFmpegï¼š</p></blockquote><ol><li><strong>å®¹å™¨ (Container)</strong>: æŒ‡çš„æ˜¯è§†é¢‘æ–‡ä»¶æœ¬èº«ï¼Œæ¯”å¦‚ä¸€ä¸ª<code>.mp4</code>æˆ–<code>.mkv</code>æ–‡ä»¶ã€‚å®ƒæ˜¯ä¸€ä¸ªâ€œå®¹å™¨â€ï¼Œé‡Œé¢è£…ç€å„ç§æ•°æ®æµã€‚</li><li><strong>æµ (Stream)</strong>: æŒ‡çš„æ˜¯å®¹å™¨å†…çš„æ•°æ®è½¨é“ã€‚ä¸€ä¸ªè§†é¢‘æ–‡ä»¶é€šå¸¸è‡³å°‘åŒ…å«ä¸€ä¸ªè§†é¢‘æµå’Œä¸€ä¸ªéŸ³é¢‘æµï¼Œæœ‰æ—¶è¿˜ä¼šæœ‰å­—å¹•æµã€‚</li><li><strong>æ•°æ®åŒ… (Packet)</strong>: ä»æµä¸­è¯»å–çš„ä¸€å°å—<strong>å‹ç¼©å</strong>çš„æ•°æ®ã€‚</li><li><strong>å¸§ (Frame)</strong>: ä¸€ä¸ªæ•°æ®åŒ…ç»è¿‡<strong>è§£ç å</strong>å¾—åˆ°çš„æ•°æ®ã€‚å¯¹äºè§†é¢‘æµï¼Œå®ƒæ˜¯ä¸€å¼ å›¾ç‰‡ï¼›å¯¹äºéŸ³é¢‘æµï¼Œå®ƒæ˜¯ä¸€æ®µå£°éŸ³æ ·æœ¬ã€‚</li></ol><blockquote><p>æ ‡å‡†çš„å¤„ç†æµç¨‹æ˜¯ï¼š<strong>æ‰“å¼€å®¹å™¨ â†’ æ‰¾åˆ°éœ€è¦çš„æµ â†’ ä»æµä¸­è§£å¤ç”¨(demux)æ•°æ®åŒ… â†’ è§£ç (decode)æ•°æ®åŒ…å¾—åˆ°å¸§ â†’ (å¤„ç†å¸§) â†’ ç¼–ç (encode)å¤„ç†åçš„å¸§å˜å›æ•°æ®åŒ… â†’ å°†æ•°æ®åŒ…æ··åˆ(mux)åˆ°æ–°çš„è¾“å‡ºå®¹å™¨ â†’ å…³é—­å®¹å™¨</strong>ã€‚</p></blockquote><h2 id="ç®€å•å®‰è£…">ç®€å•å®‰è£…</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install av</span><br><span class="line">conda install av -c conda-forge</span><br></pre></td></tr></table></figure><h3 id="åŠŸèƒ½">åŠŸèƒ½</h3><ul><li><p>libavformat: containers, audio/video/subtitle streams, packets;</p></li><li><p>libavdevice (by specifying a format to containers);</p></li><li><p>libavcodec: Codec, CodecContext, BitStreamFilterContext, audio/video frames, data planes, subtitles;</p></li><li><p>libavfilter: Filter, Graph;</p></li><li><p>libswscale: VideoReformatter;</p></li><li><p>libswresample: AudioResampler;</p></li></ul><h3 id="simple-demo">simple demo</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> av</span><br><span class="line"></span><br><span class="line">av.logging.set_level(av.logging.VERBOSE)</span><br><span class="line">container = av.<span class="built_in">open</span>(path_to_video)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> index, frame <span class="keyword">in</span> <span class="built_in">enumerate</span>(container.decode(video=<span class="number">0</span>)):</span><br><span class="line">    frame.to_image().save(<span class="string">f&quot;frame-<span class="subst">&#123;index:04d&#125;</span>.jpg&quot;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --- è°ƒåº¦å™¨å‡½æ•° ---</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">crop_video_pyav</span>(<span class="params">input_video_path, output_video_path, ...</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æ ¹æ®ç¯å¢ƒè‡ªåŠ¨é€‰æ‹©æœ€ä½³æ–¹å¼è£å‰ªè§†é¢‘ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># æ£€æŸ¥ç¡¬ä»¶åŠ é€Ÿæ˜¯å¦å—æ”¯æŒ</span></span><br><span class="line">    <span class="keyword">if</span> HW_ACCEL_SUPPORTED:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># ä¼˜å…ˆå°è¯•ç¡¬ä»¶åŠ é€Ÿ</span></span><br><span class="line">            logger.info(<span class="string">&quot;æ£€æµ‹åˆ°ç¡¬ä»¶åŠ é€Ÿæ”¯æŒï¼Œå°è¯• Metal è·¯å¾„...&quot;</span>)</span><br><span class="line">            success = _crop_video_pyav_metal(...)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> success:</span><br><span class="line">                <span class="comment"># å¦‚æœç¡¬ä»¶è·¯å¾„æ˜ç¡®è¿”å›å¤±è´¥ï¼Œåˆ™é™çº§</span></span><br><span class="line">                logger.warning(<span class="string">&quot;ç¡¬ä»¶åŠ é€Ÿè·¯å¾„æ‰§è¡Œå¤±è´¥ï¼Œè‡ªåŠ¨é™çº§åˆ°çº¯è½¯ä»¶æ¨¡å¼ã€‚&quot;</span>)</span><br><span class="line">                success = _crop_video_software(...)</span><br><span class="line">            <span class="keyword">return</span> success</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># å¦‚æœç¡¬ä»¶è·¯å¾„æ„å¤–å´©æºƒï¼Œåˆ™é™çº§</span></span><br><span class="line">            logger.error(<span class="string">f&quot;ç¡¬ä»¶åŠ é€Ÿè·¯å¾„æ‰§è¡Œæ—¶å‘ç”Ÿæ„å¤–å¼‚å¸¸: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            logger.warning(<span class="string">&quot;è‡ªåŠ¨é™çº§åˆ°çº¯è½¯ä»¶æ¨¡å¼ã€‚&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> _crop_video_software(...)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># ä¸æ”¯æŒç¡¬ä»¶åŠ é€Ÿï¼Œç›´æ¥èµ°è½¯ä»¶è·¯å¾„</span></span><br><span class="line">        logger.info(<span class="string">&quot;æœªæ£€æµ‹åˆ°ç¡¬ä»¶åŠ é€Ÿæ”¯æŒï¼Œä½¿ç”¨çº¯è½¯ä»¶è·¯å¾„ã€‚&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> _crop_video_software(...)</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ·±å…¥åˆ†æè¿™ä¸¤ç§æ ¸å¿ƒå®ç°ã€‚</p><h3 id="Part-1-å¥å£®çš„åŸºçŸ³-â€”â€”-çº¯è½¯ä»¶-CPU-å®ç°">Part 1: å¥å£®çš„åŸºçŸ³ â€”â€” çº¯è½¯ä»¶ (CPU) å®ç°</h3><p>è¿™æ˜¯æˆ‘ä»¬åå¤‡æ–¹æ¡ˆçš„æ ¸å¿ƒï¼Œä¹Ÿæ˜¯ç†è§£PyAVåŸºç¡€æ“ä½œçš„æœ€ä½³å…¥å£ã€‚å®ƒä¸ä¾èµ–ä»»ä½•ç‰¹æ®Šçš„ç¡¬ä»¶ï¼Œå¯ä»¥åœ¨ä»»ä½•å¹³å°ä¸Šè¿è¡Œã€‚</p><h4 id="æ ¸å¿ƒæ­¥éª¤">æ ¸å¿ƒæ­¥éª¤</h4><ol><li><p><strong>å‚æ•°å‡†å¤‡</strong>:<br>æœ€å…³é”®çš„ä¸€æ­¥æ˜¯ç¡®ä¿è¾“å‡ºçš„åˆ†è¾¨ç‡æ°¸è¿œæ˜¯å¶æ•°ã€‚åƒ <code>libx264</code> è¿™æ ·çš„H.264ç¼–ç å™¨æ— æ³•å¤„ç†å®½åº¦æˆ–é«˜åº¦ä¸ºå¥‡æ•°çš„è§†é¢‘ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">final_w = w - (w % <span class="number">2</span>)</span><br><span class="line">final_h = h - (h % <span class="number">2</span>)</span><br></pre></td></tr></table></figure></li><li><p><strong>æ‰“å¼€è¾“å…¥/è¾“å‡ºå®¹å™¨</strong>:<br>ä½¿ç”¨ <code>av.open()</code>ï¼Œå°±åƒPythonå†…ç½®çš„ <code>open()</code> ä¸€æ ·ç®€å•ï¼Œä½†å®ƒå¯ä»¥åŒæ—¶ç”¨äºè¯»å’Œå†™ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> av.<span class="built_in">open</span>(input_video_path, mode=<span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> in_container:</span><br><span class="line">    <span class="keyword">with</span> av.<span class="built_in">open</span>(output_video_path, mode=<span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> out_container:</span><br><span class="line">        <span class="comment"># ...</span></span><br></pre></td></tr></table></figure></li><li><p><strong>åˆ›å»ºè¾“å‡ºæµ</strong>:<br>æœ€ç®€å•çš„æ–¹å¼æ˜¯ä»è¾“å…¥æµåˆ›å»ºæ¨¡æ¿ã€‚è¿™ä¼šè‡ªåŠ¨å¤åˆ¶ç¼–è§£ç å™¨ã€ç ç‡ç­‰å¤§éƒ¨åˆ†å‚æ•°ã€‚ç„¶åæˆ‘ä»¬å†æ‰‹åŠ¨è¦†ç›–éœ€è¦ä¿®æ”¹çš„å‚æ•°ï¼Œæ¯”å¦‚æ–°çš„å®½åº¦å’Œé«˜åº¦ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥æ‰¾æ‰€æœ‰è¾“å…¥æµ</span></span><br><span class="line">in_video_stream = in_container.streams.video[<span class="number">0</span>]</span><br><span class="line">in_audio_stream = in_container.streams.audio[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»æ¨¡æ¿åˆ›å»ºè¾“å‡ºæµ</span></span><br><span class="line">out_video_stream = out_container.add_stream_from_template(in_video_stream)</span><br><span class="line">out_audio_stream = out_container.add_stream_from_template(in_audio_stream)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¦†ç›–è§†é¢‘æµçš„å°ºå¯¸</span></span><br><span class="line">out_video_stream.width = final_w</span><br><span class="line">out_video_stream.height = final_h</span><br></pre></td></tr></table></figure></li><li><p><strong>æ ¸å¿ƒå¤„ç†å¾ªç¯</strong>:<br>è¿™æ˜¯æœ€ç²¾å½©çš„éƒ¨åˆ†ï¼Œå®Œç¾ä½“ç°äº†PyAVä¸Pillowçš„ç»“åˆã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> packet <span class="keyword">in</span> in_container.demux(streams_to_demux):</span><br><span class="line">    <span class="keyword">if</span> packet.stream.<span class="built_in">type</span> == <span class="string">&#x27;video&#x27;</span>:</span><br><span class="line">        <span class="keyword">for</span> frame <span class="keyword">in</span> packet.decode():</span><br><span class="line">            <span class="comment"># a. è§£ç å¸§å¹¶è½¬æ¢ä¸ºPillow Imageå¯¹è±¡</span></span><br><span class="line">            img = frame.to_image()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># b. ä½¿ç”¨Pillowçš„å¼ºå¤§åŠŸèƒ½è¿›è¡Œå›¾åƒå¤„ç†</span></span><br><span class="line">            cropped_img = img.crop((x, y, x + w, y + h))</span><br><span class="line">            <span class="keyword">if</span> needs_scaling:</span><br><span class="line">                cropped_img = cropped_img.resize((final_w, final_h))</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># c. å°†å¤„ç†åçš„Pillow Imageè½¬æ¢å›PyAVçš„VideoFrame</span></span><br><span class="line">            new_frame = av.VideoFrame.from_image(cropped_img)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># d. ç¼–ç æ–°å¸§å¹¶æ··åˆåˆ°è¾“å‡ºæ–‡ä»¶</span></span><br><span class="line">            <span class="keyword">for</span> out_packet <span class="keyword">in</span> out_video_stream.encode(new_frame):</span><br><span class="line">                out_container.mux(out_packet)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> packet.stream.<span class="built_in">type</span> == <span class="string">&#x27;audio&#x27;</span>:</span><br><span class="line">        <span class="comment"># éŸ³é¢‘ç›´é€šï¼šä¸è§£ç ï¼Œç›´æ¥å¤åˆ¶æ•°æ®åŒ…ï¼Œæ•ˆç‡æœ€é«˜</span></span><br><span class="line">        packet.stream = out_audio_stream</span><br><span class="line">        out_container.mux(packet)</span><br></pre></td></tr></table></figure></li><li><p><strong>å†²æ´— (Flush) ç¼–ç å™¨</strong>:<br>å¤„ç†å®Œæ‰€æœ‰å¸§åï¼Œç¼–ç å™¨çš„å†…éƒ¨å¯èƒ½è¿˜ç¼“å­˜ç€ä¸€äº›æ•°æ®ã€‚æˆ‘ä»¬é€šè¿‡å‘é€ä¸€ä¸ª <code>None</code> æ¥å‘Šè¯‰å®ƒç»“æŸç¼–ç ï¼Œå¹¶æ¸…ç©ºæ‰€æœ‰ç¼“å†²åŒºã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> out_packet <span class="keyword">in</span> out_video_stream.encode(<span class="literal">None</span>):</span><br><span class="line">    out_container.mux(out_packet)</span><br></pre></td></tr></table></figure></li></ol><h3 id="Part-2-æè‡´æ€§èƒ½-â€”â€”-Metalç¡¬ä»¶åŠ é€Ÿ-GPU-å®ç°">Part 2: æè‡´æ€§èƒ½ â€”â€” Metalç¡¬ä»¶åŠ é€Ÿ (GPU) å®ç°</h3><p>è¿™æ˜¯è„šæœ¬çš„â€œé«˜æ€§èƒ½æ¨¡å¼â€ï¼Œä¸“é—¨ä¸ºmacOSè®¾è®¡ã€‚å®ƒå°½å¯èƒ½åœ°å°†æ‰€æœ‰æ“ä½œéƒ½ç•™åœ¨GPUä¸Šï¼Œé¿å…äº†æ˜‚è´µçš„CPU&lt;-&gt;GPUæ•°æ®æ‹·è´ã€‚</p><h4 id="æ ¸å¿ƒæ­¥éª¤-2">æ ¸å¿ƒæ­¥éª¤</h4><ol><li><p><strong>åˆ›å»ºç¡¬ä»¶è®¾å¤‡ä¸Šä¸‹æ–‡</strong>:<br>è¿™æ˜¯å¼€å¯ç¡¬ä»¶åŠ é€Ÿçš„ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬å‘Šè¯‰PyAVæˆ‘ä»¬è¦ä½¿ç”¨è‹¹æœçš„ <code>videotoolbox</code> æ¡†æ¶ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hw_device = av.hwdevice.Device(<span class="string">&quot;videotoolbox&quot;</span>)</span><br></pre></td></tr></table></figure></li><li><p><strong>é…ç½®ç¡¬ä»¶è§£ç </strong>:<br>è¿™æ˜¯ç°ä»£PyAVä¸­é…ç½®ç¡¬ä»¶è§£ç çš„å…³é”®ã€‚æˆ‘ä»¬ä¸æ˜¯æ‰‹åŠ¨è®¾ç½®ä¸Šä¸‹æ–‡ï¼Œè€Œæ˜¯ä¸ºè¾“å…¥æµçš„ <code>codec_context</code> æä¾›ä¸€ä¸ª <code>get_format</code> å›è°ƒå‡½æ•°ã€‚å½“è§£ç å™¨å‡†å¤‡å¥½æ—¶ï¼Œå®ƒä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°å¹¶æä¾›ä¸€ä¸ªå®ƒæ”¯æŒçš„åƒç´ æ ¼å¼åˆ—è¡¨ã€‚æˆ‘ä»¬çš„å‡½æ•°åªéœ€ä»ä¸­é€‰æ‹© <code>'videotoolbox'</code> æ ¼å¼å³å¯ã€‚è¿™å‘Šè¯‰è§£ç å™¨ï¼šâ€œè¯·ç›´æ¥å°†å¸§è§£ç åˆ°GPUæ˜¾å­˜ä¸­ï¼Œä¸è¦ä¸‹è½½åˆ°CPUå†…å­˜ã€‚â€</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">hw_pix_fmt = <span class="string">&#x27;videotoolbox&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_hw_format</span>(<span class="params">formats</span>):</span><br><span class="line">    <span class="keyword">for</span> fmt <span class="keyword">in</span> formats:</span><br><span class="line">        <span class="keyword">if</span> fmt.name == hw_pix_fmt:</span><br><span class="line">            <span class="keyword">return</span> fmt</span><br><span class="line">    <span class="keyword">raise</span> av.EncoderNotFoundError(<span class="string">&quot;æœªæ‰¾åˆ° &#x27;videotoolbox&#x27; ç¡¬ä»¶æ ¼å¼ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">in_stream.codec_context.get_format = get_hw_format</span><br></pre></td></tr></table></figure></li><li><p><strong>æ„å»ºç¡¬ä»¶æ»¤é•œå›¾ (Filter Graph)</strong>:<br>è£å‰ªå’Œç¼©æ”¾æ˜¯é€šè¿‡FFmpegçš„æ»¤é•œç³»ç»Ÿå®Œæˆçš„ã€‚PyAVå…è®¸æˆ‘ä»¬ç”¨ä»£ç æ„å»ºè¿™ä¸ªå¤„ç†é“¾ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">graph = av.<span class="built_in">filter</span>.Graph()</span><br><span class="line">buffer_src = graph.add_buffer(template=in_stream) <span class="comment"># è¾“å…¥æº</span></span><br><span class="line">buffer_sink = graph.add(<span class="string">&quot;buffersink&quot;</span>) <span class="comment"># è¾“å‡ºæ±‡</span></span><br><span class="line"></span><br><span class="line">filter_chain = <span class="string">f&quot;crop=<span class="subst">&#123;...&#125;</span>,scale=<span class="subst">&#123;...&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é“¾æ¥ï¼šæº -&gt; æ»¤é•œé“¾ -&gt; æ±‡</span></span><br><span class="line">filters = graph.add_filter(filter_chain, <span class="string">&quot;filters&quot;</span>)</span><br><span class="line">buffer_src.link_to(filters)</span><br><span class="line">filters.link_to(buffer_sink)</span><br><span class="line"></span><br><span class="line">graph.configure()</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ€å·§å¦™çš„æ˜¯ï¼Œå³ä½¿ <code>crop</code> å’Œ <code>scale</code> æ»¤é•œæ˜¯çº¯CPUæ“ä½œï¼ŒFFmpegä¹Ÿä¼šåœ¨åå°<strong>è‡ªåŠ¨</strong>å¤„ç†ç¡¬ä»¶å¸§çš„ä¸‹è½½ï¼ˆGPU-&gt;CPUï¼‰ã€åº”ç”¨æ»¤é•œã€å†ä¸Šä¼ ï¼ˆCPU-&gt;GPUï¼‰çš„è¿‡ç¨‹ã€‚</p></li><li><p><strong>é…ç½®ç¡¬ä»¶ç¼–ç </strong>:<br>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä½¿ç”¨ <code>h264_videotoolbox</code> ç¼–ç å™¨çš„è¾“å‡ºæµã€‚å®ƒä¼šè‡ªåŠ¨æ¥æ”¶æ¥è‡ªæ»¤é•œå›¾çš„ã€å·²ç»å¤„ç†å¥½çš„å¸§ï¼ˆè¿™äº›å¸§å¯èƒ½åœ¨CPUä¸Šï¼Œä¹Ÿå¯èƒ½åœ¨GPUä¸Šï¼Œç¼–ç å™¨ä¼šè‡ªåŠ¨å¤„ç†ï¼‰ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">out_stream = out_container.add_stream(<span class="string">&quot;h264_videotoolbox&quot;</span>, rate=rate)</span><br><span class="line">out_stream.width = final_w</span><br><span class="line">out_stream.height = final_h</span><br><span class="line">out_stream.pix_fmt = <span class="string">&quot;nv12&quot;</span> <span class="comment"># VideoToolbox ç¼–ç å™¨åå¥½çš„åƒç´ æ ¼å¼</span></span><br></pre></td></tr></table></figure></li><li><p><strong>ç¡¬ä»¶å¤„ç†å¾ªç¯</strong>:<br>å¾ªç¯çš„ä¸»ä½“ç»“æ„ç±»ä¼¼ï¼Œä½†æ“ä½œå¯¹è±¡å˜æˆäº†æ»¤é•œå›¾ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> frame <span class="keyword">in</span> packet.decode(): <span class="comment"># è§£ç å‡ºçš„ frame æ˜¯ä¸€ä¸ªæŒ‡å‘GPUæ˜¾å­˜çš„ç¡¬ä»¶å¸§</span></span><br><span class="line">    graph.push(frame) <span class="comment"># å°†ç¡¬ä»¶å¸§æ¨å…¥æ»¤é•œå›¾å¤„ç†</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            filtered_frame = buffer_sink.pull() <span class="comment"># ä»æ»¤é•œå›¾æ‹‰å–å¤„ç†å¥½çš„å¸§</span></span><br><span class="line">            <span class="keyword">for</span> out_packet <span class="keyword">in</span> out_stream.encode(filtered_frame):</span><br><span class="line">                output_container.mux(out_packet)</span><br><span class="line">        <span class="keyword">except</span> (av.error.EOFError, av.error.BlockingIOError):</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="å®é™…å¤„ç†">å®é™…å¤„ç†</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥å½“å‰ PyAV ç¯å¢ƒæ˜¯å¦æ”¯æŒç¡¬ä»¶åŠ é€Ÿ</span></span><br><span class="line">HW_ACCEL_SUPPORTED = <span class="built_in">hasattr</span>(av, <span class="string">&#x27;hwdevice&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> HW_ACCEL_SUPPORTED:</span><br><span class="line">    <span class="comment"># è¿›ä¸€æ­¥æ£€æŸ¥å¹³å°æ˜¯å¦ä¸º macOS</span></span><br><span class="line">    <span class="keyword">if</span> platform.system() == <span class="string">&#x27;Darwin&#x27;</span>:</span><br><span class="line">        logger.info(<span class="string">&quot;ç¡¬ä»¶åŠ é€Ÿ (VideoToolbox) å¯ç”¨ã€‚å°†ä¼˜å…ˆä½¿ç”¨ Metal è·¯å¾„ã€‚&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        HW_ACCEL_SUPPORTED = <span class="literal">False</span></span><br><span class="line">        logger.warning(<span class="string">&quot;PyAV æ”¯æŒç¡¬ä»¶åŠ é€Ÿï¼Œä½†å½“å‰ç³»ç»Ÿä¸æ˜¯ macOSã€‚VideoToolbox ä¸å¯ç”¨ã€‚&quot;</span>)</span><br><span class="line">        logger.warning(<span class="string">&quot;æ‰€æœ‰è§†é¢‘å¤„ç†å°†å›é€€åˆ°çº¯è½¯ä»¶æ¨¡å¼ã€‚&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    logger.warning(<span class="string">&quot;å½“å‰ PyAV ç¯å¢ƒä¸­æœªæ‰¾åˆ°ç¡¬ä»¶åŠ é€Ÿæ¨¡å— (&#x27;av.hwdevice&#x27;)ã€‚&quot;</span>)</span><br><span class="line">    logger.warning(<span class="string">&quot;æ‰€æœ‰è§†é¢‘å¤„ç†å°†å›é€€åˆ°çº¯è½¯ä»¶æ¨¡å¼ï¼Œé€Ÿåº¦ä¼šè¾ƒæ…¢ã€‚&quot;</span>)</span><br><span class="line">    logger.warning(<span class="string">&quot;è¦è§£å†³æ­¤é—®é¢˜ï¼Œè¯·ç¡®ä¿æ‚¨çš„é¡¹ç›®è§£é‡Šå™¨é…ç½®æ­£ç¡®ï¼Œå¹¶ä½¿ç”¨äº†å®Œæ•´ç¼–è¯‘çš„ PyAV åº“ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 2. ä¸»è°ƒåº¦å™¨å‡½æ•° ---</span></span><br><span class="line"><span class="comment"># æ‚¨çš„å¤–éƒ¨ä»£ç åº”è¯¥åªè°ƒç”¨è¿™ä¸ªå‡½æ•°</span></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">crop_video_pyav</span>(<span class="params"></span></span><br><span class="line"><span class="params">        input_video_path: <span class="built_in">str</span>, output_video_path: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">        crop_x: <span class="built_in">float</span>, crop_y: <span class="built_in">float</span>, crop_w: <span class="built_in">float</span>, crop_h: <span class="built_in">float</span>,</span></span><br><span class="line"><span class="params">        log_queue=<span class="literal">None</span>,  <span class="comment"># log_queue å’Œå…¶ä»–å‚æ•°ä¿ç•™ä»¥å…¼å®¹æ‚¨çš„æ¥å£</span></span></span><br><span class="line"><span class="params">        min_short_side_output_px: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        assigned_gpu_id: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        **kwargs  <span class="comment"># æ•è·ä»»ä½•å…¶ä»–æœªä½¿ç”¨çš„å‚æ•°</span></span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æ ¹æ®ç¯å¢ƒè‡ªåŠ¨é€‰æ‹©æœ€ä½³æ–¹å¼è£å‰ªè§†é¢‘ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    å¦‚æœæ”¯æŒç¡¬ä»¶åŠ é€Ÿï¼Œåˆ™å°è¯•ä½¿ç”¨Metalè·¯å¾„ï¼›å¦åˆ™ï¼Œæˆ–Metalè·¯å¾„å¤±è´¥æ—¶ï¼Œ</span></span><br><span class="line"><span class="string">    è‡ªåŠ¨å›é€€åˆ°çº¯è½¯ä»¶è·¯å¾„ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    crop_params = &#123;</span><br><span class="line">        <span class="string">&#x27;x&#x27;</span>: crop_x, <span class="string">&#x27;y&#x27;</span>: crop_y, <span class="string">&#x27;w&#x27;</span>: crop_w, <span class="string">&#x27;h&#x27;</span>: crop_h</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> HW_ACCEL_SUPPORTED:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># ä¼˜å…ˆå°è¯•ç¡¬ä»¶åŠ é€Ÿè·¯å¾„</span></span><br><span class="line">            logger.info(<span class="string">f&quot;æ£€æµ‹åˆ°ç¡¬ä»¶åŠ é€Ÿæ”¯æŒï¼Œå°è¯• Metal è·¯å¾„...&quot;</span>)</span><br><span class="line">            success = _crop_video_pyav_metal(</span><br><span class="line">                input_video_path, output_video_path, crop_params,</span><br><span class="line">                min_short_side_output_px</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> success:</span><br><span class="line">                logger.warning(<span class="string">&quot;ç¡¬ä»¶åŠ é€Ÿè·¯å¾„æ‰§è¡Œå¤±è´¥ï¼Œè‡ªåŠ¨é™çº§åˆ°çº¯è½¯ä»¶æ¨¡å¼ã€‚&quot;</span>)</span><br><span class="line">                success = _crop_video_software(</span><br><span class="line">                    input_video_path, output_video_path, crop_params,</span><br><span class="line">                    min_short_side_output_px</span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">return</span> success</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.opt(exception=<span class="literal">True</span>).error(<span class="string">f&quot;ç¡¬ä»¶åŠ é€Ÿè·¯å¾„æ‰§è¡Œæ—¶å‘ç”Ÿæ„å¤–å¼‚å¸¸: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            logger.warning(<span class="string">&quot;è‡ªåŠ¨é™çº§åˆ°çº¯è½¯ä»¶æ¨¡å¼ã€‚&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> _crop_video_software(</span><br><span class="line">                input_video_path, output_video_path, crop_params,</span><br><span class="line">                min_short_side_output_px</span><br><span class="line">            )</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># å¦‚æœä¸€å¼€å§‹å°±ä¸æ”¯æŒç¡¬ä»¶åŠ é€Ÿï¼Œç›´æ¥èµ°è½¯ä»¶è·¯å¾„</span></span><br><span class="line">        logger.info(<span class="string">f&quot;æœªæ£€æµ‹åˆ°ç¡¬ä»¶åŠ é€Ÿæ”¯æŒï¼Œä½¿ç”¨çº¯è½¯ä»¶è·¯å¾„ã€‚&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> _crop_video_software(</span><br><span class="line">            input_video_path, output_video_path, crop_params,</span><br><span class="line">            min_short_side_output_px</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 3. ç¡¬ä»¶åŠ é€Ÿå®ç° (å†…éƒ¨å‡½æ•°) ---</span></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_crop_video_pyav_metal</span>(<span class="params"></span></span><br><span class="line"><span class="params">        input_video_path: <span class="built_in">str</span>, output_video_path: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">        crop_rect: <span class="type">Dict</span>,</span></span><br><span class="line"><span class="params">        min_short_side_output_px: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ä½¿ç”¨ PyAV å’Œ VideoToolbox (Metal) è¿›è¡Œç¡¬ä»¶åŠ é€Ÿçš„è§†é¢‘è£å‰ªã€‚</span></span><br><span class="line"><span class="string">    è¿™æ˜¯ä¸€ä¸ªå†…éƒ¨å‡½æ•°ï¼Œå‡è®¾ç¡¬ä»¶æ”¯æŒå·²ç¡®è®¤ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    logger.info(<span class="string">f&quot;Metalè·¯å¾„: å¼€å§‹å¤„ç† <span class="subst">&#123;os.path.basename(input_video_path)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å‚æ•°å‡†å¤‡</span></span><br><span class="line">    crop_w_f = <span class="built_in">int</span>(crop_rect[<span class="string">&#x27;w&#x27;</span>]) - (<span class="built_in">int</span>(crop_rect[<span class="string">&#x27;w&#x27;</span>]) % <span class="number">2</span>)</span><br><span class="line">    crop_h_f = <span class="built_in">int</span>(crop_rect[<span class="string">&#x27;h&#x27;</span>]) - (<span class="built_in">int</span>(crop_rect[<span class="string">&#x27;h&#x27;</span>]) % <span class="number">2</span>)</span><br><span class="line">    crop_x_f = <span class="built_in">int</span>(crop_rect[<span class="string">&#x27;x&#x27;</span>]) - (<span class="built_in">int</span>(crop_rect[<span class="string">&#x27;x&#x27;</span>]) % <span class="number">2</span>)</span><br><span class="line">    crop_y_f = <span class="built_in">int</span>(crop_rect[<span class="string">&#x27;y&#x27;</span>]) - (<span class="built_in">int</span>(crop_rect[<span class="string">&#x27;y&#x27;</span>]) % <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">if</span> crop_w_f &lt;= <span class="number">0</span> <span class="keyword">or</span> crop_h_f &lt;= <span class="number">0</span>: <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    final_w, final_h = crop_w_f, crop_h_f</span><br><span class="line">    needs_scaling = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> min_short_side_output_px <span class="keyword">and</span> <span class="built_in">min</span>(crop_w_f, crop_h_f) &lt; min_short_side_output_px:</span><br><span class="line">        needs_scaling = <span class="literal">True</span></span><br><span class="line">        scale_factor = min_short_side_output_px / <span class="built_in">min</span>(crop_w_f, crop_h_f)</span><br><span class="line">        final_w = math.ceil((crop_w_f * scale_factor) / <span class="number">2</span>) * <span class="number">2</span></span><br><span class="line">        final_h = math.ceil((crop_h_f * scale_factor) / <span class="number">2</span>) * <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    input_container = <span class="literal">None</span></span><br><span class="line">    output_container = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># --- ç¡¬ä»¶è®¾å¤‡ä¸å®¹å™¨ ---</span></span><br><span class="line">        logger.debug(<span class="string">&quot;Metalè·¯å¾„: åˆ›å»º VideoToolbox ä¸Šä¸‹æ–‡ã€‚&quot;</span>)</span><br><span class="line">        hw_device = av.hwdevice.Device(<span class="string">&quot;videotoolbox&quot;</span>)</span><br><span class="line"></span><br><span class="line">        input_container = av.<span class="built_in">open</span>(input_video_path, mode=<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">        output_container = av.<span class="built_in">open</span>(output_video_path, mode=<span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">        in_stream = input_container.streams.video[<span class="number">0</span>]</span><br><span class="line">        in_stream.thread_type = <span class="string">&quot;AUTO&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- é…ç½®ç¡¬ä»¶è§£ç  (ç°ä»£æ–¹å¼) ---</span></span><br><span class="line">        logger.debug(<span class="string">&quot;Metalè·¯å¾„: é…ç½®ç¡¬ä»¶è§£ç ã€‚&quot;</span>)</span><br><span class="line">        hw_pix_fmt = <span class="string">&#x27;videotoolbox&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">get_hw_format</span>(<span class="params">formats</span>):</span><br><span class="line">            <span class="keyword">for</span> fmt <span class="keyword">in</span> formats:</span><br><span class="line">                <span class="keyword">if</span> fmt.name == hw_pix_fmt:</span><br><span class="line">                    <span class="keyword">return</span> fmt</span><br><span class="line">            <span class="keyword">raise</span> av.EncoderNotFoundError(<span class="string">f&quot;æœªæ‰¾åˆ° &#x27;<span class="subst">&#123;hw_pix_fmt&#125;</span>&#x27; ç¡¬ä»¶æ ¼å¼ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">        in_stream.codec_context.get_format = get_hw_format</span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- é…ç½®æ»¤é•œå›¾ ---</span></span><br><span class="line">        <span class="comment"># FFmpeg ä¼šåœ¨åå°è‡ªåŠ¨æ’å…¥ hwupload/hwdownload æ»¤é•œ</span></span><br><span class="line">        logger.debug(<span class="string">&quot;Metalè·¯å¾„: é…ç½®æ»¤é•œå›¾ã€‚&quot;</span>)</span><br><span class="line">        graph = av.<span class="built_in">filter</span>.Graph()</span><br><span class="line">        buffer_src = graph.add_buffer(template=in_stream)</span><br><span class="line"></span><br><span class="line">        filter_chain = <span class="string">f&quot;crop=<span class="subst">&#123;crop_w_f&#125;</span>:<span class="subst">&#123;crop_h_f&#125;</span>:<span class="subst">&#123;crop_x_f&#125;</span>:<span class="subst">&#123;crop_y_f&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">if</span> needs_scaling:</span><br><span class="line">            filter_chain += <span class="string">f&quot;,scale=<span class="subst">&#123;final_w&#125;</span>:<span class="subst">&#123;final_h&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ»¤é•œå›¾çš„ç»ˆç‚¹æ˜¯ buffer_sink</span></span><br><span class="line">        buffer_sink = graph.add(<span class="string">&quot;buffersink&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># é“¾æ¥æ»¤é•œ</span></span><br><span class="line">        buffer_src.link_to(graph.add_filter(filter_chain, <span class="string">&quot;filters&quot;</span>))</span><br><span class="line">        graph.get_filter(<span class="string">&quot;filters&quot;</span>).link_to(buffer_sink)</span><br><span class="line"></span><br><span class="line">        graph.configure()</span><br><span class="line">        logger.info(<span class="string">f&quot;Metalè·¯å¾„: æ»¤é•œå›¾é…ç½®æˆåŠŸ: &#x27;<span class="subst">&#123;filter_chain&#125;</span>&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- é…ç½®ç¡¬ä»¶ç¼–ç  ---</span></span><br><span class="line">        logger.debug(<span class="string">&quot;Metalè·¯å¾„: é…ç½®ç¡¬ä»¶ç¼–ç ã€‚&quot;</span>)</span><br><span class="line">        rate = in_stream.base_rate <span class="keyword">or</span> in_stream.guessed_rate <span class="keyword">or</span> in_stream.average_rate</span><br><span class="line">        out_stream = output_container.add_stream(<span class="string">&quot;h264_videotoolbox&quot;</span>, rate=rate)</span><br><span class="line">        out_stream.width = final_w</span><br><span class="line">        out_stream.height = final_h</span><br><span class="line">        out_stream.pix_fmt = <span class="string">&quot;nv12&quot;</span>  <span class="comment"># VideoToolbox ç¼–ç å™¨é€šå¸¸ä½¿ç”¨ nv12</span></span><br><span class="line">        out_stream.time_base = in_stream.time_base</span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- éŸ³é¢‘æµå¤„ç† (ç›´é€š) ---</span></span><br><span class="line">        in_audio_stream = <span class="built_in">next</span>((s <span class="keyword">for</span> s <span class="keyword">in</span> input_container.streams <span class="keyword">if</span> s.<span class="built_in">type</span> == <span class="string">&#x27;audio&#x27;</span>), <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> in_audio_stream:</span><br><span class="line">            out_audio_stream = output_container.add_stream(<span class="string">&#x27;aac&#x27;</span>, template=in_audio_stream)</span><br><span class="line">            streams_to_demux = (in_stream, in_audio_stream)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            out_audio_stream = <span class="literal">None</span></span><br><span class="line">            streams_to_demux = in_stream</span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- æ ¸å¿ƒå¤„ç†å¾ªç¯ ---</span></span><br><span class="line">        <span class="keyword">for</span> packet <span class="keyword">in</span> input_container.demux(streams_to_demux):</span><br><span class="line">            <span class="keyword">if</span> packet.dts <span class="keyword">is</span> <span class="literal">None</span>: <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> packet.stream.<span class="built_in">type</span> == <span class="string">&#x27;video&#x27;</span>:</span><br><span class="line">                <span class="keyword">for</span> frame <span class="keyword">in</span> packet.decode():</span><br><span class="line">                    graph.push(frame)</span><br><span class="line">                    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                        <span class="keyword">try</span>:</span><br><span class="line">                            filtered_frame = buffer_sink.pull()</span><br><span class="line">                            <span class="keyword">for</span> out_packet <span class="keyword">in</span> out_stream.encode(filtered_frame):</span><br><span class="line">                                output_container.mux(out_packet)</span><br><span class="line">                        <span class="keyword">except</span> (av.error.EOFError, av.error.BlockingIOError):</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">elif</span> out_audio_stream <span class="keyword">and</span> packet.stream.<span class="built_in">type</span> == <span class="string">&#x27;audio&#x27;</span>:</span><br><span class="line">                packet.stream = out_audio_stream</span><br><span class="line">                output_container.mux(packet)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- å†²æ´—(Flush) ---</span></span><br><span class="line">        logger.debug(<span class="string">&quot;Metalè·¯å¾„: å†²æ´—æ»¤é•œå’Œç¼–ç å™¨ã€‚&quot;</span>)</span><br><span class="line">        graph.push(<span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                filtered_frame = buffer_sink.pull()</span><br><span class="line">                <span class="keyword">for</span> out_packet <span class="keyword">in</span> out_stream.encode(filtered_frame):</span><br><span class="line">                    output_container.mux(out_packet)</span><br><span class="line">            <span class="keyword">except</span> (av.error.EOFError, av.error.BlockingIOError):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> out_packet <span class="keyword">in</span> out_stream.encode(<span class="literal">None</span>):</span><br><span class="line">            output_container.mux(out_packet)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ­£å¸¸å…³é—­</span></span><br><span class="line">        output_container.close()</span><br><span class="line">        input_container.close()</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">f&quot;Metalè·¯å¾„: è§†é¢‘å¤„ç†æˆåŠŸ -&gt; <span class="subst">&#123;os.path.basename(output_video_path)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.opt(exception=<span class="literal">True</span>).error(<span class="string">f&quot;Metalè·¯å¾„å¤„ç†æ—¶å‘ç”Ÿè‡´å‘½é”™è¯¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># æ¸…ç†</span></span><br><span class="line">        <span class="keyword">if</span> output_container:</span><br><span class="line">            output_container.close()</span><br><span class="line">        <span class="keyword">if</span> input_container:</span><br><span class="line">            input_container.close()</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(output_video_path):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                os.remove(output_video_path)</span><br><span class="line">            <span class="keyword">except</span> OSError:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 4. çº¯è½¯ä»¶å¤‡ç”¨æ–¹æ¡ˆ (å†…éƒ¨å‡½æ•°) ---</span></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_crop_video_software</span>(<span class="params"></span></span><br><span class="line"><span class="params">        input_video_path: <span class="built_in">str</span>, output_video_path: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">        crop_rect: <span class="type">Dict</span>,</span></span><br><span class="line"><span class="params">        min_short_side_output_px: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ä½¿ç”¨çº¯è½¯ä»¶ (CPU) è¿›è¡Œè§†é¢‘è£å‰ªçš„å¤‡ç”¨æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="string">    è¿™ä¸ªæ–¹æ³•æ€»æ˜¯å¯ç”¨çš„ï¼Œä½†é€Ÿåº¦æ¯”ç¡¬ä»¶åŠ é€Ÿæ…¢ã€‚</span></span><br><span class="line"><span class="string">    å®ƒç¡®ä¿è¾“å‡ºå°ºå¯¸ä¸ºå¶æ•°ï¼Œä»¥å…¼å®¹H.264ç­‰ç¼–ç å™¨ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    logger.info(<span class="string">f&quot;è½¯ä»¶è·¯å¾„: å¼€å§‹å¤„ç† <span class="subst">&#123;os.path.basename(input_video_path)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    input_container = <span class="literal">None</span></span><br><span class="line">    output_container = <span class="literal">None</span></span><br><span class="line">    success = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># --- 1. å‚æ•°å‡†å¤‡ (å…³é”®ä¿®æ­£éƒ¨åˆ†) ---</span></span><br><span class="line">        x, y, w, h = <span class="built_in">int</span>(crop_rect[<span class="string">&#x27;x&#x27;</span>]), <span class="built_in">int</span>(crop_rect[<span class="string">&#x27;y&#x27;</span>]), <span class="built_in">int</span>(crop_rect[<span class="string">&#x27;w&#x27;</span>]), <span class="built_in">int</span>(crop_rect[<span class="string">&#x27;h&#x27;</span>])</span><br><span class="line">        <span class="keyword">if</span> w &lt;= <span class="number">0</span> <span class="keyword">or</span> h &lt;= <span class="number">0</span>:</span><br><span class="line">            logger.error(<span class="string">f&quot;è£å‰ªå°ºå¯¸æ— æ•ˆ (w=<span class="subst">&#123;w&#125;</span>, h=<span class="subst">&#123;h&#125;</span>)ã€‚&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># åˆå§‹çš„æœ€ç»ˆå°ºå¯¸å°±æ˜¯è£å‰ªåçš„å°ºå¯¸</span></span><br><span class="line">        final_w, final_h = w, h</span><br><span class="line">        needs_scaling = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ£€æŸ¥æ˜¯å¦éœ€è¦ç¼©æ”¾</span></span><br><span class="line">        <span class="keyword">if</span> min_short_side_output_px <span class="keyword">and</span> <span class="built_in">min</span>(w, h) &lt; min_short_side_output_px:</span><br><span class="line">            needs_scaling = <span class="literal">True</span></span><br><span class="line">            scale_factor = min_short_side_output_px / <span class="built_in">min</span>(w, h)</span><br><span class="line">            final_w = <span class="built_in">int</span>(w * scale_factor)</span><br><span class="line">            final_h = <span class="built_in">int</span>(h * scale_factor)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># *** æ ¸å¿ƒä¿®æ­£ï¼šç¡®ä¿æœ€ç»ˆçš„è¾“å‡ºå°ºå¯¸æ°¸è¿œæ˜¯å¶æ•° ***</span></span><br><span class="line">        <span class="comment"># è¿™å¯¹äº H.264 (libx264) å’Œè®¸å¤šå…¶ä»–ç¼–ç å™¨è‡³å…³é‡è¦</span></span><br><span class="line">        final_w = final_w - (final_w % <span class="number">2</span>)</span><br><span class="line">        final_h = final_h - (final_h % <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> final_w &lt;= <span class="number">0</span> <span class="keyword">or</span> final_h &lt;= <span class="number">0</span>:</span><br><span class="line">            logger.error(<span class="string">f&quot;è®¡ç®—åçš„è¾“å‡ºå°ºå¯¸æ— æ•ˆ (<span class="subst">&#123;final_w&#125;</span>x<span class="subst">&#123;final_h&#125;</span>)ã€‚&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- 2. æ‰“å¼€å®¹å™¨å¹¶è®¾ç½®æµ ---</span></span><br><span class="line">        <span class="keyword">with</span> av.<span class="built_in">open</span>(input_video_path, mode=<span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> in_container:</span><br><span class="line">            <span class="keyword">with</span> av.<span class="built_in">open</span>(output_video_path, mode=<span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> out_container:</span><br><span class="line"></span><br><span class="line">                <span class="comment"># a. æŸ¥æ‰¾æ‰€æœ‰è¾“å…¥æµ</span></span><br><span class="line">                in_video_stream = <span class="built_in">next</span>((s <span class="keyword">for</span> s <span class="keyword">in</span> in_container.streams <span class="keyword">if</span> s.<span class="built_in">type</span> == <span class="string">&#x27;video&#x27;</span>), <span class="literal">None</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> in_video_stream:</span><br><span class="line">                    logger.error(<span class="string">&quot;è¾“å…¥æ–‡ä»¶ä¸­æœªæ‰¾åˆ°è§†é¢‘æµã€‚&quot;</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">                in_video_stream.thread_type = <span class="string">&quot;AUTO&quot;</span></span><br><span class="line"></span><br><span class="line">                in_audio_stream = <span class="built_in">next</span>((s <span class="keyword">for</span> s <span class="keyword">in</span> in_container.streams <span class="keyword">if</span> s.<span class="built_in">type</span> == <span class="string">&#x27;audio&#x27;</span>), <span class="literal">None</span>)</span><br><span class="line">                in_subtitle_stream = <span class="built_in">next</span>((s <span class="keyword">for</span> s <span class="keyword">in</span> in_container.streams <span class="keyword">if</span> s.<span class="built_in">type</span> == <span class="string">&#x27;subtitle&#x27;</span>), <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># b. ä¸ºæ¯ä¸ªè¾“å…¥æµåˆ›å»ºå¯¹åº”çš„è¾“å‡ºæµ</span></span><br><span class="line">                out_video_stream = out_container.add_stream_from_template(in_video_stream)</span><br><span class="line">                out_video_stream.width = final_w</span><br><span class="line">                out_video_stream.height = final_h</span><br><span class="line"></span><br><span class="line">                out_audio_stream = out_container.add_stream_from_template(in_audio_stream) <span class="keyword">if</span> in_audio_stream <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">                out_subtitle_stream = out_container.add_stream_from_template(</span><br><span class="line">                    in_subtitle_stream) <span class="keyword">if</span> in_subtitle_stream <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">                streams_to_demux = [s <span class="keyword">for</span> s <span class="keyword">in</span> [in_video_stream, in_audio_stream, in_subtitle_stream] <span class="keyword">if</span> s]</span><br><span class="line"></span><br><span class="line">                <span class="comment"># --- 3. æ ¸å¿ƒå¤„ç†å¾ªç¯ ---</span></span><br><span class="line">                <span class="keyword">for</span> packet <span class="keyword">in</span> in_container.demux(streams_to_demux):</span><br><span class="line">                    <span class="keyword">if</span> packet.dts <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> packet.stream.<span class="built_in">type</span> == <span class="string">&#x27;video&#x27;</span>:</span><br><span class="line">                        <span class="keyword">for</span> frame <span class="keyword">in</span> packet.decode():</span><br><span class="line">                            img = frame.to_image()</span><br><span class="line"></span><br><span class="line">                            <span class="comment"># è£å‰ª</span></span><br><span class="line">                            cropped_img = img.crop((x, y, x + w, y + h))</span><br><span class="line"></span><br><span class="line">                            <span class="comment"># å¦‚æœéœ€è¦ï¼Œè¿›è¡Œç¼©æ”¾</span></span><br><span class="line">                            <span class="keyword">if</span> needs_scaling:</span><br><span class="line">                                <span class="comment"># Pillow çš„ resize éœ€è¦ä¸€ä¸ª (width, height) å…ƒç»„</span></span><br><span class="line">                                cropped_img = cropped_img.resize((final_w, final_h))</span><br><span class="line"></span><br><span class="line">                            new_frame = av.VideoFrame.from_image(cropped_img)</span><br><span class="line">                            new_frame.pts = frame.pts</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">for</span> out_packet <span class="keyword">in</span> out_video_stream.encode(new_frame):</span><br><span class="line">                                out_container.mux(out_packet)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">elif</span> packet.stream.<span class="built_in">type</span> == <span class="string">&#x27;audio&#x27;</span> <span class="keyword">and</span> out_audio_stream:</span><br><span class="line">                        packet.stream = out_audio_stream</span><br><span class="line">                        out_container.mux(packet)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">elif</span> packet.stream.<span class="built_in">type</span> == <span class="string">&#x27;subtitle&#x27;</span> <span class="keyword">and</span> out_subtitle_stream:</span><br><span class="line">                        packet.stream = out_subtitle_stream</span><br><span class="line">                        out_container.mux(packet)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># --- 4. å†²æ´—(Flush)è§†é¢‘ç¼–ç å™¨ ---</span></span><br><span class="line">                logger.debug(<span class="string">&quot;è½¯ä»¶è·¯å¾„: å†²æ´—è§†é¢‘ç¼–ç å™¨ã€‚&quot;</span>)</span><br><span class="line">                <span class="keyword">for</span> out_packet <span class="keyword">in</span> out_video_stream.encode(<span class="literal">None</span>):</span><br><span class="line">                    out_container.mux(out_packet)</span><br><span class="line"></span><br><span class="line">        success = <span class="literal">True</span></span><br><span class="line">        logger.info(<span class="string">f&quot;è½¯ä»¶è·¯å¾„: è§†é¢‘å¤„ç†æˆåŠŸ -&gt; <span class="subst">&#123;os.path.basename(output_video_path)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.opt(exception=<span class="literal">True</span>).error(<span class="string">f&quot;è½¯ä»¶è·¯å¾„å¤„ç†æ—¶å‘ç”Ÿé”™è¯¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">if</span> output_container <span class="keyword">and</span> <span class="keyword">not</span> output_container.closed:</span><br><span class="line">            output_container.close()</span><br><span class="line">        <span class="keyword">if</span> input_container <span class="keyword">and</span> <span class="keyword">not</span> input_container.closed:</span><br><span class="line">            input_container.close()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> success <span class="keyword">and</span> os.path.exists(output_video_path):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                os.remove(output_video_path)</span><br><span class="line">                logger.info(<span class="string">f&quot;å·²æ¸…ç†å¤±è´¥çš„è¾“å‡ºæ–‡ä»¶: <span class="subst">&#123;output_video_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> OSError <span class="keyword">as</span> err:</span><br><span class="line">                logger.warning(<span class="string">f&quot;æ¸…ç†å¤±è´¥çš„è¾“å‡ºæ–‡ä»¶æ—¶å‡ºé”™: <span class="subst">&#123;err&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><h2 id="one-more-thing">one more thing</h2><ul><li>gpu acc</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># GPU Acceleration Defaults</span></span><br><span class="line">GPU_ACCELERATION_DEFAULT = &#123;</span><br><span class="line">    <span class="string">&quot;gpu_opencv_decode&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">    <span class="string">&quot;opencv_cuda_device&quot;</span>: <span class="number">0</span>,  <span class="comment"># Default/primary GPU for OpenCV CUDA operations</span></span><br><span class="line">    <span class="string">&quot;ffmpeg_hwaccel&quot;</span>: <span class="string">&quot;videotoolbox&quot;</span>,     <span class="comment"># e.g., &quot;cuda&quot;, &quot;qsv&quot;, &quot;vaapi&quot;, &quot;videotoolbox&quot;</span></span><br><span class="line">    <span class="string">&quot;ffmpeg_gpu_encoder&quot;</span>: <span class="string">&quot;h264_videotoolbox&quot;</span>, <span class="comment"># e.g., &quot;h264_nvenc&quot;, &quot;hevc_qsv&quot;, h264_videotoolbox</span></span><br><span class="line">    <span class="string">&quot;gpu_ids_to_use&quot;</span>: <span class="string">&quot;0&quot;</span>      <span class="comment"># New: Comma-separated list of GPU IDs (e.g., &quot;0,1&quot;) for general processing</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GPU_ACCELERATION_DEFAULT_win = &#123;</span><br><span class="line">    <span class="string">&quot;gpu_opencv_decode&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">    <span class="string">&quot;opencv_cuda_device&quot;</span>: <span class="number">0</span>,  <span class="comment"># Default/primary GPU for OpenCV CUDA operations</span></span><br><span class="line">    <span class="string">&quot;ffmpeg_hwaccel&quot;</span>: <span class="string">&quot;cuda&quot;</span>,     <span class="comment"># e.g., &quot;cuda&quot;, &quot;qsv&quot;, &quot;vaapi&quot;, &quot;videotoolbox&quot;</span></span><br><span class="line">    <span class="string">&quot;ffmpeg_gpu_encoder&quot;</span>: <span class="string">&quot;h264_nvenc&quot;</span>, <span class="comment"># e.g., &quot;h264_nvenc&quot;, &quot;hevc_qsv&quot;, h264_videotoolbox</span></span><br><span class="line">    <span class="string">&quot;gpu_ids_to_use&quot;</span>: <span class="string">&quot;0&quot;</span>      <span class="comment"># New: Comma-separated list of GPU IDs (e.g., &quot;0,1&quot;) for general processing</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="See">See</h2><ul><li>1.<a href="https://github.com/PyAV-Org/PyAV/tree/main/docs/api">https://github.com/PyAV-Org/PyAV/tree/main/docs/api</a></li><li>2.<a href="https://ffmpeg.org/documentation.html">https://ffmpeg.org/documentation.html</a></li><li>3.<a href="https://pyav.basswood-io.com/docs/stable/">https://pyav.basswood-io.com/docs/stable/</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;PyAVç”¨äºè§†é¢‘å‰ªè¾‘å¤„ç†&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;PyAVæ˜¯FFmpegåº“çš„Pythonicç»‘å®šã€‚å®ƒå…è®¸ä½ ç›´æ¥åœ¨Pythonä»£ç ä¸­ï¼Œä»¥ä¸€ç§æå…¶ç²¾ç»†å’Œé«˜æ•ˆçš„æ–¹å¼è®¿é—®FFmpegçš„å†…éƒ¨åŠŸèƒ½ã€‚è¿™æ„å‘³ç€ï¼š&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;</summary>
      
    
    
    
    
    <category term="python" scheme="https://caozhaoqi.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>æ•°å­—æ°´å°ç³»ç»Ÿå®ç°</title>
    <link href="https://caozhaoqi.github.io/2025/07/22/watermark-gen-valid/"/>
    <id>https://caozhaoqi.github.io/2025/07/22/watermark-gen-valid/</id>
    <published>2025-07-22T10:25:23.000Z</published>
    <updated>2025-11-25T15:05:10.374Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å®ç°æµç¨‹æ¡†æ¶">å®ç°æµç¨‹æ¡†æ¶</h2><p>æ— è®ºä½¿ç”¨å“ªç§æŠ€æœ¯ï¼Œä¸€ä¸ªå®Œæ•´çš„æ•°å­—æ°´å°ç³»ç»Ÿé€šå¸¸éƒ½åŒ…æ‹¬ä¸¤ä¸ªåŸºæœ¬è¿‡ç¨‹ï¼š</p><ol><li><p><strong>æ°´å°åµŒå…¥ (Watermark Embedding)</strong>ï¼š</p><ul><li><strong>è¾“å…¥</strong>ï¼šåŸå§‹è½½ä½“ï¼ˆå¦‚å›¾ç‰‡Aï¼‰ã€æ°´å°ä¿¡æ¯ï¼ˆå¦‚å­—ç¬¦ä¸²&quot;ID:123&quot;æˆ–ä¸€ä¸ªLogoå›¾ç‰‡Bï¼‰ã€‚</li><li><strong>è¿‡ç¨‹</strong>ï¼šé€šè¿‡ç‰¹å®šç®—æ³•ï¼Œå°†æ°´å°ä¿¡æ¯Bå¤„ç†åï¼Œâ€œå åŠ â€æˆ–â€œèå…¥â€åˆ°åŸå§‹è½½ä½“Aä¸­ã€‚</li><li><strong>è¾“å‡º</strong>ï¼šä¸€ä¸ªå¸¦æœ‰æ°´å°ã€ä½†çœ‹èµ·æ¥å’ŒåŸå§‹è½½ä½“å‡ ä¹æ²¡åŒºåˆ«çš„è½½ä½“Aâ€™ã€‚</li></ul></li><li><p><strong>æ°´å°æå–/æ£€æµ‹ (Watermark Extraction/Detection)</strong>ï¼š</p><ul><li><strong>è¾“å…¥</strong>ï¼šå¯èƒ½è¢«ä¿®æ”¹è¿‡çš„å¸¦æ°´å°è½½ä½“Aâ€™'ï¼Œæœ‰æ—¶è¿˜éœ€è¦åŸå§‹è½½ä½“Aæˆ–åŸå§‹æ°´å°Bä½œä¸ºå‚è€ƒã€‚</li><li><strong>è¿‡ç¨‹</strong>ï¼šé€šè¿‡ä¸åµŒå…¥è¿‡ç¨‹ç›¸é€†çš„ç®—æ³•ï¼Œä»è½½ä½“Aâ€™'ä¸­è§£ç å‡ºéšè—çš„æ°´å°ä¿¡æ¯ã€‚</li><li><strong>è¾“å‡º</strong>ï¼šæå–å‡ºçš„æ°´å°ä¿¡æ¯Bâ€™ï¼Œæˆ–è€…ä¸€ä¸ªâ€œæ˜¯/å¦â€çš„åˆ¤æ–­ï¼ˆç¡®è®¤æ˜¯å¦å­˜åœ¨æŸä¸ªç‰¹å®šæ°´å°ï¼‰ã€‚</li></ul></li></ol><blockquote><p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥çœ‹å®ç°è¿™äº›æµç¨‹çš„å…·ä½“æŠ€æœ¯ã€‚</p></blockquote><hr><h3 id="ä¸€ã€-ç©ºåŸŸï¼ˆSpatial-Domainï¼‰æŠ€æœ¯">ä¸€ã€ ç©ºåŸŸï¼ˆSpatial Domainï¼‰æŠ€æœ¯</h3><p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šç›´æ¥ä¿®æ”¹åŸå§‹å›¾åƒçš„åƒç´ å€¼ï¼ˆæ¯”å¦‚RGBå€¼ï¼‰æ¥åµŒå…¥ä¿¡æ¯ã€‚è¿™ç§æ–¹æ³•ç›´è§‚ã€ç®€å•ã€‚</p><h4 id="å…¸å‹æŠ€æœ¯ï¼šLSB-Least-Significant-Bit-ç®—æ³•">å…¸å‹æŠ€æœ¯ï¼šLSB (Least Significant Bit) ç®—æ³•</h4><p>è¿™æ˜¯æœ€ç»å…¸ã€æœ€ç®€å•çš„ç©ºåŸŸæ°´å°æŠ€æœ¯ã€‚</p><ul><li><p><strong>åŸç†</strong>ï¼š</p><ul><li>è®¡ç®—æœºä¸­çš„å›¾åƒï¼Œæ¯ä¸ªåƒç´ çš„é¢œè‰²ç”±è‹¥å¹²ä¸ªäºŒè¿›åˆ¶ä½ï¼ˆbitsï¼‰è¡¨ç¤ºã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ª8ä½çš„ç°åº¦å›¾åƒï¼Œæ¯ä¸ªåƒç´ çš„ç°åº¦å€¼èŒƒå›´æ˜¯0-255ï¼Œç”±8ä¸ªäºŒè¿›åˆ¶ä½ç»„æˆã€‚</li><li><strong>æœ€ä½æœ‰æ•ˆä½ (LSB)</strong> å°±æ˜¯è¿™8ä¸ªä½ä¸­æœ€å³è¾¹çš„é‚£ä¸€ä½ã€‚æ”¹å˜è¿™ä¸€ä½ï¼Œå¯¹åƒç´ å€¼çš„æ•´ä½“å½±å“æœ€å°ï¼ˆæœ€å¤šæ”¹å˜1ï¼‰ï¼Œäººçœ¼åŸºæœ¬æ— æ³•å¯Ÿè§‰ã€‚</li><li><strong>åµŒå…¥æ–¹æ³•</strong>ï¼šå°†è¦éšè—çš„æ°´å°ä¿¡æ¯ï¼ˆæ¯”å¦‚ä¸€å¼ é»‘ç™½Logoå›¾ç‰‡ï¼‰è½¬æ¢æˆäºŒè¿›åˆ¶æµï¼ˆ0å’Œ1çš„åºåˆ—ï¼‰ã€‚ç„¶åï¼Œç”¨è¿™ä¸ªäºŒè¿›åˆ¶æµå»æ›¿æ¢åŸå§‹å›¾åƒä¸­æ¯ä¸ªï¼ˆæˆ–éƒ¨åˆ†ï¼‰åƒç´ çš„LSBã€‚<ul><li>å¦‚æœè¦åµŒå…¥<code>1</code>ï¼Œå°±æŠŠåƒç´ çš„LSBæ”¹æˆ<code>1</code>ã€‚</li><li>å¦‚æœè¦åµŒå…¥<code>0</code>ï¼Œå°±æŠŠåƒç´ çš„LSBæ”¹æˆ<code>0</code>ã€‚</li></ul></li></ul></li><li><p><strong>æå–æ–¹æ³•</strong>ï¼šç›´æ¥è¯»å–å¸¦æ°´å°å›¾åƒä¸­ç›¸åº”åƒç´ çš„LSBï¼Œå°±èƒ½è¿˜åŸå‡ºéšè—çš„äºŒè¿›åˆ¶æµï¼Œä»è€Œé‡æ„æ°´å°ä¿¡æ¯ã€‚</p></li><li><p><strong>ä¼˜ç‚¹</strong>ï¼š</p><ul><li><strong>å®ç°ç®€å•</strong>ï¼šç®—æ³•éå¸¸ç›´æ¥ã€‚</li><li><strong>å®¹é‡å¤§</strong>ï¼šæ¯ä¸ªåƒç´ éƒ½èƒ½è—1æ¯”ç‰¹ä¿¡æ¯ï¼Œå¯ä»¥éšè—å¤§é‡æ•°æ®ã€‚</li><li><strong>éšè”½æ€§å¥½</strong>ï¼šå¯¹è§†è§‰å½±å“æå°ã€‚</li></ul></li><li><p><strong>ç¼ºç‚¹</strong>ï¼š</p><ul><li><strong>é²æ£’æ€§æå·®ï¼ˆéå¸¸è„†å¼±ï¼‰</strong>ï¼šè¿™æ˜¯å®ƒçš„è‡´å‘½å¼±ç‚¹ã€‚ä»»ä½•å¯¹å›¾åƒçš„è½»å¾®å¤„ç†ï¼Œå¦‚ <strong>JPEGå‹ç¼©ã€ç¼©æ”¾ã€è£å‰ªã€åŠ ä¸ªæ»¤é•œ</strong>ï¼Œéƒ½ä¼šç ´åLSBå±‚çš„æ•°æ®ï¼Œå¯¼è‡´æ°´å°å®Œå…¨ä¸¢å¤±ã€‚</li></ul></li><li><p><strong>åº”ç”¨åœºæ™¯</strong>ï¼šä¸»è¦ç”¨äº<strong>è„†å¼±æ°´å°</strong>ï¼Œå³<strong>å†…å®¹å®Œæ•´æ€§è®¤è¯</strong>ã€‚å› ä¸ºåªè¦å›¾ç‰‡è¢«æ”¹åŠ¨ï¼Œæ°´å°å°±ä¼šè¢«ç ´åï¼Œä»è€Œå¯ä»¥è¯æ˜â€œæ­¤å›¾å·²è¢«ä¿®æ”¹â€ã€‚</p></li></ul><hr><h3 id="äºŒã€-å˜æ¢åŸŸï¼ˆTransform-Domainï¼‰æŠ€æœ¯">äºŒã€ å˜æ¢åŸŸï¼ˆTransform Domainï¼‰æŠ€æœ¯</h3><p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šä¸ç›´æ¥æ”¹åƒç´ å€¼ï¼Œè€Œæ˜¯å…ˆå¯¹å›¾åƒè¿›è¡Œæ•°å­¦å˜æ¢ï¼ˆå¦‚å‚…é‡Œå¶å˜æ¢ã€ä½™å¼¦å˜æ¢ï¼‰ï¼Œå°†å…¶ä»ç©ºåŸŸè½¬æ¢åˆ°å¦ä¸€ä¸ªåŸŸï¼ˆå¦‚é¢‘åŸŸï¼‰ã€‚ç„¶åï¼Œåœ¨å˜æ¢åçš„åŸŸä¸­ä¿®æ”¹ç³»æ•°æ¥åµŒå…¥æ°´å°ã€‚è¿™æ˜¯ç›®å‰ä¸»æµçš„ã€<strong>é²æ£’æ°´å°</strong>çš„å®ç°æ–¹å¼ã€‚</p><p><strong>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Ÿ</strong><br>å› ä¸ºåƒJPEGå‹ç¼©è¿™æ ·çš„æ“ä½œï¼Œä¸»è¦ä¸¢å¼ƒçš„æ˜¯å›¾åƒçš„<strong>é«˜é¢‘ä¿¡æ¯</strong>ï¼ˆç»†èŠ‚ï¼‰ï¼Œè€Œä¿ç•™<strong>ä¸­ä½é¢‘ä¿¡æ¯</strong>ï¼ˆè½®å»“ã€ä¸»è¦èƒ½é‡ï¼‰ã€‚å¦‚æœåœ¨ä¸­ä½é¢‘ç³»æ•°é‡ŒåµŒå…¥æ°´å°ï¼Œé‚£ä¹ˆå³ä½¿ç»è¿‡å‹ç¼©ï¼Œæ°´å°ä¿¡æ¯ä¹Ÿèƒ½å¤§æ¦‚ç‡è¢«ä¿ç•™ä¸‹æ¥ã€‚</p><h4 id="1-åŸºäºDCTï¼ˆç¦»æ•£ä½™å¼¦å˜æ¢ï¼‰çš„æŠ€æœ¯">1. åŸºäºDCTï¼ˆç¦»æ•£ä½™å¼¦å˜æ¢ï¼‰çš„æŠ€æœ¯</h4><ul><li><strong>èƒŒæ™¯</strong>ï¼šDCTæ˜¯ <strong>JPEG å‹ç¼©</strong>çš„æ ¸å¿ƒç®—æ³•ã€‚å®ƒå°†å›¾åƒåˆ†æˆ8x8çš„å°å—ï¼Œç„¶åå¯¹æ¯ä¸ªå—è¿›è¡ŒDCTå˜æ¢ï¼Œå¾—åˆ°ä¸€ä¸ªé¢‘ç‡ç³»æ•°çŸ©é˜µã€‚è¿™ä¸ªçŸ©é˜µä¸­ï¼Œå·¦ä¸Šè§’æ˜¯ä½é¢‘ç³»æ•°ï¼ˆèƒ½é‡é›†ä¸­ï¼‰ï¼Œå³ä¸‹è§’æ˜¯é«˜é¢‘ç³»æ•°ã€‚</li><li><strong>åµŒå…¥æ–¹æ³•</strong>ï¼š<ol><li>å°†åŸå§‹å›¾åƒåˆ†å—ï¼ˆå¦‚8x8ï¼‰ã€‚</li><li>å¯¹æ¯ä¸ªå—è¿›è¡ŒDCTå˜æ¢ã€‚</li><li>é€‰æ‹©<strong>ä¸­é¢‘åŒºåŸŸ</strong>çš„ç³»æ•°è¿›è¡Œä¿®æ”¹ã€‚ä¸ºä»€ä¹ˆæ˜¯ä¸­é¢‘ï¼Ÿå› ä¸ºä½é¢‘ç³»æ•°å¯¹è§†è§‰å½±å“å¤ªå¤§ï¼Œé«˜é¢‘ç³»æ•°å®¹æ˜“åœ¨å‹ç¼©ä¸­ä¸¢å¤±ï¼Œä¸­é¢‘æ˜¯æœ€ä½³å¹³è¡¡ç‚¹ã€‚</li><li>æ ¹æ®æ°´å°ä¿¡æ¯ï¼ˆ0æˆ–1ï¼‰æ¥ä¿®æ”¹è¿™äº›ä¸­é¢‘ç³»æ•°ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡é‡åŒ–æˆ–æ¯”è¾ƒä¸¤ä¸ªç³»æ•°çš„å¤§å°æ¥åµŒå…¥1æ¯”ç‰¹ä¿¡æ¯ã€‚</li><li>å¯¹ä¿®æ”¹åçš„ç³»æ•°çŸ©é˜µè¿›è¡Œ<strong>é€†DCTå˜æ¢</strong> (IDCT)ï¼Œå¾—åˆ°å¸¦æ°´å°çš„å›¾åƒå—ã€‚</li></ol></li><li><strong>ä¼˜ç‚¹</strong>ï¼š<ul><li><strong>é²æ£’æ€§å¼º</strong>ï¼šå¯¹JPEGå‹ç¼©ã€è½»å¾®å™ªå£°ã€äº®åº¦è°ƒæ•´ç­‰æœ‰å¾ˆå¥½çš„æŠµæŠ—èƒ½åŠ›ã€‚</li><li><strong>éšè”½æ€§å¥½</strong>ï¼šåˆ©ç”¨äº†äººç±»è§†è§‰ç³»ç»Ÿå¯¹ä¸­é¢‘å˜åŒ–ä¸æ•æ„Ÿçš„ç‰¹æ€§ã€‚</li></ul></li><li><strong>åº”ç”¨åœºæ™¯</strong>ï¼š<strong>ç‰ˆæƒä¿æŠ¤</strong>ã€<strong>ç›—ç‰ˆè¿½è¸ª</strong>ç­‰éœ€è¦å¼ºé²æ£’æ€§çš„åœºåˆã€‚</li></ul><h4 id="2-åŸºäºDWTï¼ˆç¦»æ•£å°æ³¢å˜æ¢ï¼‰çš„æŠ€æœ¯">2. åŸºäºDWTï¼ˆç¦»æ•£å°æ³¢å˜æ¢ï¼‰çš„æŠ€æœ¯</h4><ul><li><strong>èƒŒæ™¯</strong>ï¼šDWTæ˜¯ <strong>JPEG 2000</strong> å‹ç¼©æ ‡å‡†çš„æ ¸å¿ƒã€‚ä¸DCTä¸åŒï¼ŒDWTèƒ½å¯¹æ•´ä¸ªå›¾åƒè¿›è¡Œå¤šåˆ†è¾¨ç‡åˆ†æï¼Œå¾—åˆ°ä¸åŒå°ºåº¦å’Œæ–¹å‘çš„å­å¸¦ï¼ˆä½é¢‘ã€æ°´å¹³ç»†èŠ‚ã€å‚ç›´ç»†èŠ‚ã€å¯¹è§’çº¿ç»†èŠ‚ï¼‰ã€‚</li><li><strong>åµŒå…¥æ–¹æ³•</strong>ï¼š<ol><li>å¯¹æ•´ä¸ªå›¾åƒè¿›è¡ŒDWTå˜æ¢ã€‚</li><li>æ°´å°é€šå¸¸è¢«åµŒå…¥åˆ°<strong>ä¸­ã€ä½é¢‘å­å¸¦</strong>çš„ç³»æ•°ä¸­ã€‚</li><li>å› ä¸ºDWTæä¾›äº†å›¾åƒçš„ç©ºé—´å’Œé¢‘ç‡å±€éƒ¨åŒ–ä¿¡æ¯ï¼Œæ‰€ä»¥å®ƒå¯¹è£å‰ªã€ç¼©æ”¾ç­‰å‡ ä½•æ”»å‡»çš„æŠµæŠ—æ€§æ›´å¥½ã€‚</li></ol></li><li><strong>ä¼˜ç‚¹</strong>ï¼š<ul><li><strong>å¤šåˆ†è¾¨ç‡ç‰¹æ€§</strong>ï¼šé²æ£’æ€§æ¯”DCTæ›´å…¨é¢ï¼Œå°¤å…¶åœ¨æŠ—å‡ ä½•æ”»å‡»æ–¹é¢ã€‚</li><li><strong>ä¸äººç±»è§†è§‰ç³»ç»Ÿï¼ˆHVSï¼‰åŒ¹é…æ›´å¥½</strong>ï¼šå¯ä»¥æ›´ç²¾ç»†åœ°æ§åˆ¶æ°´å°çš„åµŒå…¥å¼ºåº¦ï¼Œè¾¾åˆ°æ›´å¥½çš„éšè”½æ€§ã€‚</li></ul></li><li><strong>åº”ç”¨åœºæ™¯</strong>ï¼šåŒDCTï¼Œç”¨äºéœ€è¦æ›´é«˜é²æ£’æ€§çš„ç‰ˆæƒä¿æŠ¤ç³»ç»Ÿã€‚</li></ul><h4 id="3-åŸºäºDFTï¼ˆç¦»æ•£å‚…é‡Œå¶å˜æ¢ï¼‰çš„æŠ€æœ¯">3. åŸºäºDFTï¼ˆç¦»æ•£å‚…é‡Œå¶å˜æ¢ï¼‰çš„æŠ€æœ¯</h4><ul><li><strong>èƒŒæ™¯</strong>ï¼šDFTå°†å›¾åƒè½¬æ¢æˆå¹…åº¦å’Œç›¸ä½è°±ã€‚</li><li><strong>ç‰¹ç‚¹</strong>ï¼šå›¾åƒçš„å¹…åº¦è°±å¯¹<strong>æ—‹è½¬ã€ç¼©æ”¾å’Œå¹³ç§»ï¼ˆRSTæ”»å‡»ï¼‰</strong> å…·æœ‰ä¸å˜æ€§æˆ–ç‰¹å®šçš„å˜åŒ–è§„å¾‹ã€‚</li><li><strong>åµŒå…¥æ–¹æ³•</strong>ï¼šé€šè¿‡ä¿®æ”¹DFTå˜æ¢åçš„<strong>å¹…åº¦è°±</strong>æ¥åµŒå…¥æ°´å°ã€‚</li><li><strong>ä¼˜ç‚¹</strong>ï¼š<ul><li>å¯¹æ—‹è½¬ã€ç¼©æ”¾ç­‰å‡ ä½•æ”»å‡»å…·æœ‰å¤©ç„¶çš„é²æ£’æ€§ã€‚</li></ul></li><li><strong>ç¼ºç‚¹</strong>ï¼š<ul><li>å®ç°å¤æ‚ï¼Œä¸”å®¹æ˜“å‡ºç°å›¾åƒå—æ•ˆåº”ã€‚</li></ul></li><li><strong>åº”ç”¨åœºæ™¯</strong>ï¼šä¸»è¦ç”¨äºæŠµæŠ—å‡ ä½•å˜æ¢çš„ç‰¹å®šåœºåˆã€‚</li></ul><hr><h2 id="å®ç°">å®ç°</h2><h3 id="æ ¸å¿ƒçš„Pythonåº“ï¼š">æ ¸å¿ƒçš„Pythonåº“ï¼š</h3><ul><li><strong>Pillow (PIL Fork)</strong>: ç”¨äºå›¾åƒçš„è¯»å†™å’ŒåŸºæœ¬çš„åƒç´ æ“ä½œï¼ˆå®ç°LSBï¼‰ã€‚</li><li><strong>NumPy</strong>: ç”¨äºé«˜æ•ˆçš„æ•°ç»„å’ŒçŸ©é˜µè¿ç®—ï¼Œæ˜¯æ‰€æœ‰å›¾åƒå¤„ç†çš„åŸºç¡€ã€‚</li><li><strong>PyWavelets (pywt)</strong>: ç”¨äºå®ç°DWTï¼ˆç¦»æ•£å°æ³¢å˜æ¢ï¼‰ã€‚</li><li><strong>OpenCV-Python (cv2)</strong>: åŠŸèƒ½æœ€å¼ºå¤§çš„è®¡ç®—æœºè§†è§‰åº“ï¼Œå¯ä»¥æ–¹ä¾¿åœ°å®ç°DCTã€DFTä»¥åŠå„ç§å›¾åƒå¤„ç†æ“ä½œã€‚</li></ul><hr><h3 id="1-ç©ºåŸŸ-Spatial-Domain-LSB-ç®—æ³•">1. ç©ºåŸŸ (Spatial Domain) - LSB ç®—æ³•</h3><p><strong>æ ¸å¿ƒåº“</strong>: <code>Pillow</code> (PIL), <code>NumPy</code></p><p>è¿™ä¸ªç®—æ³•ä¸ä¾èµ–å¤æ‚çš„æ•°å­¦åº“ï¼ŒPillowå’ŒNumPyè¶³ä»¥èƒœä»»ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode_lsb</span>(<span class="params">image_path, secret_message</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å°†ç§˜å¯†ä¿¡æ¯åµŒå…¥åˆ°å›¾ç‰‡çš„LSBå±‚&quot;&quot;&quot;</span></span><br><span class="line">    img = Image.<span class="built_in">open</span>(image_path, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">    width, height = img.size</span><br><span class="line">    img_array = np.array(img)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. å°†ç§˜å¯†ä¿¡æ¯è½¬æ¢ä¸ºäºŒè¿›åˆ¶æµ</span></span><br><span class="line">    binary_secret = <span class="string">&#x27;&#x27;</span>.join([<span class="built_in">format</span>(<span class="built_in">ord</span>(c), <span class="string">&#x27;08b&#x27;</span>) <span class="keyword">for</span> c <span class="keyword">in</span> secret_message])</span><br><span class="line">    binary_secret += <span class="string">&#x27;1111111111111110&#x27;</span> <span class="comment"># æ·»åŠ ç»“æŸæ ‡è®°</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(binary_secret) &gt; width * height * <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;ä¿¡æ¯è¿‡é•¿ï¼Œæ— æ³•åµŒå…¥åˆ°å›¾ç‰‡ä¸­ï¼&quot;</span>)</span><br><span class="line"></span><br><span class="line">    data_index = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 2. éå†åƒç´ å¹¶ä¿®æ”¹LSB</span></span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(height):</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(width):</span><br><span class="line">            pixel = img_array[y, x]</span><br><span class="line">            <span class="comment"># éå†RGBä¸‰ä¸ªé€šé“</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">                <span class="keyword">if</span> data_index &lt; <span class="built_in">len</span>(binary_secret):</span><br><span class="line">                    <span class="comment"># æ¸…é™¤LSBå¹¶è®¾ç½®æ–°çš„ä½</span></span><br><span class="line">                    pixel[i] = (pixel[i] &amp; <span class="number">0xFE</span>) | <span class="built_in">int</span>(binary_secret[data_index])</span><br><span class="line">                    data_index += <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> data_index &gt;= <span class="built_in">len</span>(binary_secret):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> data_index &gt;= <span class="built_in">len</span>(binary_secret):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. åˆ›å»ºå¹¶ä¿å­˜æ–°å›¾ç‰‡</span></span><br><span class="line">    encoded_image = Image.fromarray(img_array)</span><br><span class="line">    encoded_image.save(<span class="string">&quot;encoded_image.png&quot;</span>, <span class="string">&quot;PNG&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ä¿¡æ¯åµŒå…¥æˆåŠŸï¼Œå·²ä¿å­˜ä¸º encoded_image.png&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode_lsb</span>(<span class="params">image_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä»å›¾ç‰‡çš„LSBå±‚æå–ç§˜å¯†ä¿¡æ¯&quot;&quot;&quot;</span></span><br><span class="line">    img = Image.<span class="built_in">open</span>(image_path, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">    img_array = np.array(img)</span><br><span class="line">    width, height = img.size</span><br><span class="line"></span><br><span class="line">    binary_data = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 1. éå†åƒç´ å¹¶æå–LSB</span></span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(height):</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(width):</span><br><span class="line">            pixel = img_array[y, x]</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">                binary_data += <span class="built_in">str</span>(pixel[i] &amp; <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. æ‰¾åˆ°ç»“æŸæ ‡è®°å¹¶è½¬æ¢ä¿¡æ¯</span></span><br><span class="line">    end_marker = <span class="string">&#x27;1111111111111110&#x27;</span></span><br><span class="line">    end_index = binary_data.find(end_marker)</span><br><span class="line">    <span class="keyword">if</span> end_index != -<span class="number">1</span>:</span><br><span class="line">        secret_binary = binary_data[:end_index]</span><br><span class="line">        secret_message = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(secret_binary), <span class="number">8</span>):</span><br><span class="line">            byte = secret_binary[i:i+<span class="number">8</span>]</span><br><span class="line">            secret_message += <span class="built_in">chr</span>(<span class="built_in">int</span>(byte, <span class="number">2</span>))</span><br><span class="line">        <span class="keyword">return</span> secret_message</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;æœªæ‰¾åˆ°ç»“æŸæ ‡è®°æˆ–ä¿¡æ¯ã€‚&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- ä½¿ç”¨ç¤ºä¾‹ ---</span></span><br><span class="line"><span class="comment"># è¯·å‡†å¤‡ä¸€å¼ åä¸º &#x27;original.png&#x27; çš„å›¾ç‰‡</span></span><br><span class="line"><span class="comment"># encode_lsb(&#x27;original.png&#x27;, &quot;This is a secret message!&quot;)</span></span><br><span class="line"><span class="comment"># message = decode_lsb(&#x27;encoded_image.png&#x27;)</span></span><br><span class="line"><span class="comment"># print(f&quot;æå–åˆ°çš„ä¿¡æ¯: &#123;message&#125;&quot;)</span></span><br></pre></td></tr></table></figure><hr><h3 id="2-å˜æ¢åŸŸ-Transform-Domain-DCT-ç®—æ³•">2. å˜æ¢åŸŸ (Transform Domain) - DCT ç®—æ³•</h3><p><strong>æ ¸å¿ƒåº“</strong>: <code>OpenCV-Python (cv2)</code>, <code>NumPy</code></p><p>OpenCV æä¾›äº†éå¸¸æ–¹ä¾¿çš„ <code>cv2.dct()</code> å’Œ <code>cv2.idct()</code> å‡½æ•°ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dct_watermark_embed</span>(<span class="params">image_path, watermark_path, alpha=<span class="number">0.1</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åŸºäºDCTçš„ä¸­é¢‘å¸¦åµŒå…¥å›¾åƒæ°´å°&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 1. å‡†å¤‡è½½ä½“å’Œæ°´å°</span></span><br><span class="line">    img = cv2.imread(image_path, cv2.IMREAD_GRAYSCALE)</span><br><span class="line">    watermark = cv2.imread(watermark_path, cv2.IMREAD_GRAYSCALE)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç¡®ä¿æ°´å°å°ºå¯¸å°äºè½½ä½“</span></span><br><span class="line">    watermark = cv2.resize(watermark, (img.shape[<span class="number">1</span>], img.shape[<span class="number">0</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. å¯¹è½½ä½“å›¾åƒè¿›è¡ŒDCTå˜æ¢</span></span><br><span class="line">    img_dct = cv2.dct(np.float32(img))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. å¯¹æ°´å°å›¾åƒè¿›è¡ŒDCTå˜æ¢ (ä¹Ÿå¯ä»¥ç›´æ¥ç”¨äºŒå€¼åŒ–æ°´å°)</span></span><br><span class="line">    watermark_dct = cv2.dct(np.float32(watermark))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 4. å°†æ°´å°çš„DCTç³»æ•°åŠ åˆ°è½½ä½“çš„ä¸­é¢‘DCTç³»æ•°ä¸Š</span></span><br><span class="line">    <span class="comment"># è¿™é‡Œç®€å•åœ°å°†æ•´ä¸ªæ°´å°DCTåŠ åˆ°è½½ä½“DCTä¸Šï¼Œæ›´å¤æ‚çš„ä¼šé€‰æ‹©ç‰¹å®šåŒºåŸŸ</span></span><br><span class="line">    <span class="comment"># alpha æ˜¯åµŒå…¥å¼ºåº¦</span></span><br><span class="line">    result_dct = img_dct + alpha * watermark_dct</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 5. è¿›è¡Œé€†DCTå˜æ¢</span></span><br><span class="line">    result_img = cv2.idct(result_dct)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è£å‰ªå€¼åˆ° 0-255 å¹¶è½¬æ¢ä¸ºuint8</span></span><br><span class="line">    result_img = np.clip(result_img, <span class="number">0</span>, <span class="number">255</span>).astype(np.uint8)</span><br><span class="line"></span><br><span class="line">    cv2.imwrite(<span class="string">&#x27;dct_embedded_image.png&#x27;</span>, result_img)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;DCTæ°´å°åµŒå…¥æˆåŠŸï¼&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dct_watermark_extract</span>(<span class="params">embedded_image_path, original_image_path, alpha=<span class="number">0.1</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æå–DCTæ°´å°ï¼ˆéœ€è¦åŸå§‹å›¾åƒï¼‰&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># è¿™æ˜¯ä¸€ä¸ªéç›²æ°´å°æå–çš„ä¾‹å­</span></span><br><span class="line">    embedded_img = cv2.imread(embedded_image_path, cv2.IMREAD_GRAYSCALE)</span><br><span class="line">    original_img = cv2.imread(original_image_path, cv2.IMREAD_GRAYSCALE)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. å¯¹å¸¦æ°´å°å›¾åƒå’ŒåŸå§‹å›¾åƒåˆ†åˆ«åšDCT</span></span><br><span class="line">    embedded_dct = cv2.dct(np.float32(embedded_img))</span><br><span class="line">    original_dct = cv2.dct(np.float32(original_img))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. ç›¸å‡å¹¶é™¤ä»¥å¼ºåº¦å› å­ï¼Œå¾—åˆ°æ°´å°çš„DCTç³»æ•°</span></span><br><span class="line">    extracted_watermark_dct = (embedded_dct - original_dct) / alpha</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. é€†DCTå˜æ¢ï¼Œæ¢å¤æ°´å°</span></span><br><span class="line">    extracted_watermark = cv2.idct(extracted_watermark_dct)</span><br><span class="line">    extracted_watermark = np.clip(extracted_watermark, <span class="number">0</span>, <span class="number">255</span>).astype(np.uint8)</span><br><span class="line"></span><br><span class="line">    cv2.imwrite(<span class="string">&#x27;dct_extracted_watermark.png&#x27;</span>, extracted_watermark)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;DCTæ°´å°æå–æˆåŠŸï¼&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- ä½¿ç”¨ç¤ºä¾‹ ---</span></span><br><span class="line"><span class="comment"># è¯·å‡†å¤‡ &#x27;original.png&#x27; å’Œ &#x27;watermark_logo.png&#x27;</span></span><br><span class="line"><span class="comment"># dct_watermark_embed(&#x27;original.png&#x27;, &#x27;watermark_logo.png&#x27;, alpha=0.1)</span></span><br><span class="line"><span class="comment"># dct_watermark_extract(&#x27;dct_embedded_image.png&#x27;, &#x27;original.png&#x27;, alpha=0.1)</span></span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„</strong>: ä¸Šè¿°DCTç¤ºä¾‹æ˜¯ä¸€ä¸ª<strong>éç›²æ°´å°</strong>ï¼Œæå–æ—¶éœ€è¦åŸå§‹å›¾åƒã€‚å®ç°ç›²æ°´å°ï¼ˆæ— éœ€åŸå›¾ï¼‰ä¼šæ›´å¤æ‚ï¼Œé€šå¸¸æ¶‰åŠåœ¨ä¸­é¢‘å¸¦é€‰æ‹©ç‰¹å®šçš„ç³»æ•°å¯¹è¿›è¡Œæ¯”è¾ƒï¼Œè€Œä¸æ˜¯ç›´æ¥å åŠ ã€‚</p><hr><h3 id="3-å˜æ¢åŸŸ-Transform-Domain-DWT-ç®—æ³•">3. å˜æ¢åŸŸ (Transform Domain) - DWT ç®—æ³•</h3><p><strong>æ ¸å¿ƒåº“</strong>: <code>PyWavelets (pywt)</code>, <code>NumPy</code>, <code>OpenCV-Python (cv2)</code></p><p><code>pywt</code> æ˜¯Pythonä¸­è¿›è¡Œå°æ³¢å˜æ¢çš„æ ‡å‡†åº“ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pywt</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dwt_watermark_embed</span>(<span class="params">image_path, watermark_path, alpha=<span class="number">0.1</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åŸºäºDWTçš„LLå­å¸¦åµŒå…¥å›¾åƒæ°´å°&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 1. å‡†å¤‡è½½ä½“å’Œæ°´å°</span></span><br><span class="line">    img = cv2.imread(image_path, cv2.IMREAD_GRAYSCALE)</span><br><span class="line">    watermark = cv2.imread(watermark_path, cv2.IMREAD_GRAYSCALE)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. å¯¹è½½ä½“å›¾åƒè¿›è¡ŒDWTå˜æ¢</span></span><br><span class="line">    <span class="comment"># &#x27;haar&#x27; æ˜¯æœ€ç®€å•çš„å°æ³¢åŸº</span></span><br><span class="line">    coeffs_img = pywt.dwt2(img, <span class="string">&#x27;haar&#x27;</span>)</span><br><span class="line">    LL, (LH, HL, HH) = coeffs_img</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç¡®ä¿æ°´å°å°ºå¯¸ä¸LLå­å¸¦åŒ¹é…</span></span><br><span class="line">    watermark_resized = cv2.resize(watermark, (LL.shape[<span class="number">1</span>], LL.shape[<span class="number">0</span>]))</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. å°†æ°´å°æ·»åŠ åˆ°ä½é¢‘å­å¸¦ (LL)</span></span><br><span class="line">    <span class="comment"># LLå­å¸¦èƒ½é‡æœ€é›†ä¸­ï¼Œé²æ£’æ€§æœ€å¼ºï¼Œä½†å¯¹ç”»è´¨å½±å“ä¹Ÿæœ€å¤§</span></span><br><span class="line">    LL_watermarked = LL + alpha * watermark_resized</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4. é‡æ„å›¾åƒ</span></span><br><span class="line">    coeffs_watermarked = (LL_watermarked, (LH, HL, HH))</span><br><span class="line">    img_watermarked = pywt.idwt2(coeffs_watermarked, <span class="string">&#x27;haar&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    img_watermarked = np.clip(img_watermarked, <span class="number">0</span>, <span class="number">255</span>).astype(np.uint8)</span><br><span class="line">    cv2.imwrite(<span class="string">&#x27;dwt_embedded_image.png&#x27;</span>, img_watermarked)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;DWTæ°´å°åµŒå…¥æˆåŠŸï¼&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dwt_watermark_extract</span>(<span class="params">embedded_image_path, original_image_path, alpha=<span class="number">0.1</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æå–DWTæ°´å°ï¼ˆéœ€è¦åŸå§‹å›¾åƒï¼‰&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># åŒæ ·æ˜¯éç›²æ°´å°æå–</span></span><br><span class="line">    embedded_img = cv2.imread(embedded_image_path, cv2.IMREAD_GRAYSCALE)</span><br><span class="line">    original_img = cv2.imread(original_image_path, cv2.IMREAD_GRAYSCALE)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. å¯¹ä¸¤å¼ å›¾åˆ†åˆ«åšDWT</span></span><br><span class="line">    coeffs_embedded = pywt.dwt2(embedded_img, <span class="string">&#x27;haar&#x27;</span>)</span><br><span class="line">    LL_embedded, _ = coeffs_embedded</span><br><span class="line">    </span><br><span class="line">    coeffs_original = pywt.dwt2(original_img, <span class="string">&#x27;haar&#x27;</span>)</span><br><span class="line">    LL_original, _ = coeffs_original</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. æå–æ°´å°</span></span><br><span class="line">    extracted_watermark = (LL_embedded - LL_original) / alpha</span><br><span class="line">    </span><br><span class="line">    extracted_watermark = np.clip(extracted_watermark, <span class="number">0</span>, <span class="number">255</span>).astype(np.uint8)</span><br><span class="line">    cv2.imwrite(<span class="string">&#x27;dwt_extracted_watermark.png&#x27;</span>, extracted_watermark)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;DWTæ°´å°æå–æˆåŠŸï¼&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- ä½¿ç”¨ç¤ºä¾‹ ---</span></span><br><span class="line"><span class="comment"># è¯·å‡†å¤‡ &#x27;original.png&#x27; å’Œ &#x27;watermark_logo.png&#x27;</span></span><br><span class="line"><span class="comment"># dwt_watermark_embed(&#x27;original.png&#x27;, &#x27;watermark_logo.png&#x27;, alpha=0.2)</span></span><br><span class="line"><span class="comment"># dwt_watermark_extract(&#x27;dwt_embedded_image.png&#x27;, &#x27;original.png&#x27;, alpha=0.2)</span></span><br></pre></td></tr></table></figure><hr><h3 id="4-å˜æ¢åŸŸ-Transform-Domain-DFT-ç®—æ³•">4. å˜æ¢åŸŸ (Transform Domain) - DFT ç®—æ³•</h3><p><strong>æ ¸å¿ƒåº“</strong>: <code>NumPy</code>, <code>OpenCV-Python (cv2)</code></p><p>DFTçš„å®ç°ä¸DCTç±»ä¼¼ï¼Œä½†é€šå¸¸ç”¨äºæŠµæŠ—å‡ ä½•æ”»å‡»ã€‚è¿™é‡Œæä¾›ä¸€ä¸ªåŸºç¡€çš„åµŒå…¥æ€è·¯ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dft_watermark_embed</span>(<span class="params">image_path, watermark_path, alpha=<span class="number">100</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åŸºäºDFTå¹…åº¦è°±åµŒå…¥æ°´å°&quot;&quot;&quot;</span></span><br><span class="line">    img = cv2.imread(image_path, cv2.IMREAD_GRAYSCALE)</span><br><span class="line">    watermark = cv2.imread(watermark_path, cv2.IMREAD_GRAYSCALE)</span><br><span class="line">    watermark = cv2.resize(watermark, (img.shape[<span class="number">1</span>], img.shape[<span class="number">0</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. DFTå˜æ¢</span></span><br><span class="line">    <span class="comment"># OpenCVçš„dftéœ€è¦è¾“å…¥float32ï¼Œå¹¶ä¼šè¾“å‡ºåŒé€šé“å¤æ•°ç»“æœ</span></span><br><span class="line">    dft = cv2.dft(np.float32(img), flags=cv2.DFT_COMPLEX_OUTPUT)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. å°†é¢‘è°±ä¸­å¿ƒç§»åˆ°å›¾åƒä¸­å¤®ï¼Œä¾¿äºè§‚å¯Ÿå’Œæ“ä½œ</span></span><br><span class="line">    dft_shift = np.fft.fftshift(dft)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. è®¡ç®—å¹…åº¦å’Œç›¸ä½è°±</span></span><br><span class="line">    magnitude_spectrum = cv2.magnitude(dft_shift[:,:,<span class="number">0</span>], dft_shift[:,:,<span class="number">1</span>])</span><br><span class="line">    phase_spectrum = cv2.phase(dft_shift[:,:,<span class="number">0</span>], dft_shift[:,:,<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4. åœ¨å¹…åº¦è°±ä¸Šæ·»åŠ æ°´å°</span></span><br><span class="line">    magnitude_spectrum_watermarked = magnitude_spectrum + alpha * watermark</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 5. æ ¹æ®æ–°çš„å¹…åº¦å’Œæ—§çš„ç›¸ä½ï¼Œé‡æ„DFTç»“æœ</span></span><br><span class="line">    real_part = magnitude_spectrum_watermarked * np.cos(phase_spectrum)</span><br><span class="line">    imag_part = magnitude_spectrum_watermarked * np.sin(phase_spectrum)</span><br><span class="line">    dft_shift_watermarked = cv2.merge([real_part, imag_part])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 6. å°†é¢‘è°±ä¸­å¿ƒç§»å›å·¦ä¸Šè§’</span></span><br><span class="line">    dft_watermarked = np.fft.ifftshift(dft_shift_watermarked)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 7. é€†DFTå˜æ¢</span></span><br><span class="line">    img_back = cv2.idft(dft_watermarked)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è·å–å®éƒ¨å¹¶æ¢å¤å›¾åƒ</span></span><br><span class="line">    img_back = cv2.magnitude(img_back[:,:,<span class="number">0</span>], img_back[:,:,<span class="number">1</span>])</span><br><span class="line">    </span><br><span class="line">    img_back = np.clip(img_back, <span class="number">0</span>, <span class="number">255</span>).astype(np.uint8)</span><br><span class="line">    cv2.imwrite(<span class="string">&#x27;dft_embedded_image.png&#x27;</span>, img_back)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;DFTæ°´å°åµŒå…¥æˆåŠŸï¼&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- ä½¿ç”¨ç¤ºä¾‹ ---</span></span><br><span class="line"><span class="comment"># è¯·å‡†å¤‡ &#x27;original.png&#x27; å’Œ &#x27;watermark_logo.png&#x27;</span></span><br><span class="line"><span class="comment"># dft_watermark_embed(&#x27;original.png&#x27;, &#x27;watermark_logo.png&#x27;, alpha=100)</span></span><br><span class="line"><span class="comment"># æå–DFTæ°´å°é€šå¸¸ä¹Ÿéœ€è¦åŸå§‹å›¾åƒï¼Œè¿‡ç¨‹ä¸DCT/DWTç±»ä¼¼ã€‚</span></span><br></pre></td></tr></table></figure><h3 id="å®‰è£…ä¾èµ–åº“">å®‰è£…ä¾èµ–åº“</h3><ul><li>pipå®‰è£…ï¼š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pillow numpy opencv-python pywavelets</span><br></pre></td></tr></table></figure><h2 id="demo">demo</h2><h3 id="æ°´å°ä¿¡æ¯åµŒå…¥ï¼ˆLSBï¼‰">æ°´å°ä¿¡æ¯åµŒå…¥ï¼ˆLSBï¼‰</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_message_to_binary</span>(<span class="params">message: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Converts a string message into its binary representation.&quot;&quot;&quot;</span></span><br><span class="line">    binary_message = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">format</span>(<span class="built_in">ord</span>(char), <span class="string">&#x27;08b&#x27;</span>) <span class="keyword">for</span> char <span class="keyword">in</span> message)</span><br><span class="line">    <span class="keyword">return</span> binary_message</span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_binary_to_message</span>(<span class="params">binary_message: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Converts a binary string back into a string message.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># Ensure the binary string is a multiple of 8</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(binary_message) % <span class="number">8</span> != <span class="number">0</span>:</span><br><span class="line">        logger.warning(<span class="string">&quot;Binary string length is not a multiple of 8; data may be incomplete.&quot;</span>)</span><br><span class="line">        binary_message = binary_message[:-(<span class="built_in">len</span>(binary_message) % <span class="number">8</span>)]</span><br><span class="line"></span><br><span class="line">    message = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(binary_message), <span class="number">8</span>):</span><br><span class="line">        byte = binary_message[i:i + <span class="number">8</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(byte) == <span class="number">8</span>:</span><br><span class="line">            message += <span class="built_in">chr</span>(<span class="built_in">int</span>(byte, <span class="number">2</span>))</span><br><span class="line">    <span class="keyword">return</span> message</span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode_lsb</span>(<span class="params">input_image_path: <span class="built_in">str</span>, secret_message: <span class="built_in">str</span>, output_image_path: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Encodes a secret message into an image using the LSB (Least Significant Bit) technique.</span></span><br><span class="line"><span class="string">    The output image will be saved in a lossless format (PNG) to preserve the watermark.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        input_image_path (str): The path to the source image.</span></span><br><span class="line"><span class="string">        secret_message (str): The message to hide.</span></span><br><span class="line"><span class="string">        output_image_path (str): The path to save the watermarked image.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        logger.info(<span class="string">f&quot;Starting LSB encoding for &#x27;<span class="subst">&#123;input_image_path&#125;</span>&#x27;...&quot;</span>)</span><br><span class="line">        image = Image.<span class="built_in">open</span>(input_image_path, <span class="string">&#x27;r&#x27;</span>).convert(<span class="string">&quot;RGBA&quot;</span>) <span class="comment"># Convert to RGBA for consistency</span></span><br><span class="line">        width, height = image.size</span><br><span class="line">        img_array = np.array(<span class="built_in">list</span>(image.getdata()))</span><br><span class="line"></span><br><span class="line">        channels = <span class="number">4</span>  <span class="comment"># We are using RGBA</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Add a unique delimiter to know where the message ends</span></span><br><span class="line">        binary_secret_message = _message_to_binary(secret_message + <span class="string">&quot;####&quot;</span>)</span><br><span class="line">        required_pixels = <span class="built_in">len</span>(binary_secret_message)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> required_pixels &gt; width * height * channels:</span><br><span class="line">            logger.error(<span class="string">&quot;Error: Message is too long to be encoded in this image.&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Modify the LSB of the pixel data</span></span><br><span class="line">        data_index = <span class="number">0</span></span><br><span class="line">        flat_array = img_array.flatten()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(flat_array)):</span><br><span class="line">            <span class="keyword">if</span> data_index &lt; required_pixels:</span><br><span class="line">                <span class="comment"># Change the LSB of the color value</span></span><br><span class="line">                flat_array[i] = <span class="built_in">int</span>(<span class="built_in">bin</span>(flat_array[i])[<span class="number">2</span>:-<span class="number">1</span>] + binary_secret_message[data_index], <span class="number">2</span>)</span><br><span class="line">                data_index += <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">break</span> <span class="comment"># Stop once the message is encoded</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Create a new image with the modified pixel data</span></span><br><span class="line">        encoded_image = Image.fromarray(flat_array.reshape(height, width, channels).astype(<span class="string">&#x27;uint8&#x27;</span>), image.mode)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Save as PNG to ensure lossless storage of the watermark</span></span><br><span class="line">        encoded_image.save(output_image_path, <span class="string">&quot;PNG&quot;</span>)</span><br><span class="line">        logger.info(<span class="string">f&quot;Successfully encoded message into &#x27;<span class="subst">&#123;output_image_path&#125;</span>&#x27;.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        logger.error(<span class="string">f&quot;Error: Input image not found at &#x27;<span class="subst">&#123;input_image_path&#125;</span>&#x27;.&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.exception(<span class="string">f&quot;An unexpected error occurred during encoding: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode_lsb</span>(<span class="params">encoded_image_path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span> | <span class="literal">None</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Decodes a secret message from an image using the LSB technique.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        encoded_image_path (str): The path to the watermarked image.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        The decoded secret message, or None if an error occurs or no message is found.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        logger.info(<span class="string">f&quot;Starting LSB decoding for &#x27;<span class="subst">&#123;encoded_image_path&#125;</span>&#x27;...&quot;</span>)</span><br><span class="line">        image = Image.<span class="built_in">open</span>(encoded_image_path, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">        img_array = np.array(<span class="built_in">list</span>(image.getdata()))</span><br><span class="line"></span><br><span class="line">        binary_data = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> pixel <span class="keyword">in</span> img_array:</span><br><span class="line">            <span class="keyword">for</span> value <span class="keyword">in</span> pixel:</span><br><span class="line">                binary_data += <span class="built_in">bin</span>(value)[-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Find the delimiter by decoding byte by byte</span></span><br><span class="line">        decoded_message = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(binary_data), <span class="number">8</span>):</span><br><span class="line">            byte = binary_data[i:i+<span class="number">8</span>]</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(byte) &lt; <span class="number">8</span>:</span><br><span class="line">                <span class="keyword">break</span> <span class="comment"># End of data</span></span><br><span class="line">            decoded_message += <span class="built_in">chr</span>(<span class="built_in">int</span>(byte, <span class="number">2</span>))</span><br><span class="line">            <span class="keyword">if</span> decoded_message.endswith(<span class="string">&quot;####&quot;</span>):</span><br><span class="line">                logger.info(<span class="string">&quot;Successfully decoded the message.&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> decoded_message[:-<span class="number">4</span>]  <span class="comment"># Return message without the delimiter</span></span><br><span class="line"></span><br><span class="line">        logger.warning(<span class="string">&quot;Could not find the end-of-message delimiter in the image.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        logger.error(<span class="string">f&quot;Error: Encoded image not found at &#x27;<span class="subst">&#123;encoded_image_path&#125;</span>&#x27;.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.exception(<span class="string">f&quot;An unexpected error occurred during decoding: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure><h3 id="æ°´å°ä¿¡æ¯éªŒè¯">æ°´å°ä¿¡æ¯éªŒè¯</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">valid_img_msg</span>(<span class="params">image_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Command-line tool to decode an invisible watermark from an image file.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    image_path = Path(image_path)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> image_path.is_file():</span><br><span class="line">        logger.debug(<span class="string">f&quot;Error: File not found at &#x27;<span class="subst">&#123;image_path&#125;</span>&#x27;&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    logger.debug(<span class="string">f&quot;Verifying &#x27;<span class="subst">&#123;image_path.name&#125;</span>&#x27;...&quot;</span>)</span><br><span class="line">    decoded_message = decode_lsb(<span class="built_in">str</span>(image_path))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> decoded_message:</span><br><span class="line">        logger.debug(<span class="string">&quot;\n--- âœ… Watermark Found! ---&quot;</span>)</span><br><span class="line">        <span class="comment"># Pretty logger.debug the decoded information</span></span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> decoded_message.split(<span class="string">&#x27;|&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;:&#x27;</span> <span class="keyword">in</span> item:</span><br><span class="line">                key, value = item.split(<span class="string">&#x27;:&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">                logger.debug(<span class="string">f&quot;  - <span class="subst">&#123;key.strip():&lt;<span class="number">15</span>&#125;</span>: <span class="subst">&#123;value.strip()&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                logger.debug(<span class="string">f&quot;  - <span class="subst">&#123;item&#125;</span>&quot;</span>)</span><br><span class="line">        logger.debug(<span class="string">&quot;--------------------------\n&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.debug(<span class="string">&quot;\n--- âŒ No Watermark Found ---&quot;</span>)</span><br><span class="line">        logger.debug(<span class="string">&quot;No hidden message could be decoded from this image.&quot;</span>)</span><br><span class="line">        logger.debug(<span class="string">&quot;--------------------------\n&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> decoded_message</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="æ°´å°ä¿¡æ¯åµŒå…¥ï¼ˆEXIFï¼‰">æ°´å°ä¿¡æ¯åµŒå…¥ï¼ˆEXIFï¼‰</h3> <figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> piexif</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ UserComment çš„æ ‡å‡†å‰ç¼€ï¼ŒUNDEFINED è¡¨ç¤ºæœªå®šä¹‰ç¼–ç ï¼Œå…è®¸æˆ‘ä»¬ä½¿ç”¨ UTF-8ã€‚</span></span><br><span class="line"><span class="comment"># è¿™æ˜¯ç¬¦åˆ EXIF è§„èŒƒçš„æ¨èåšæ³•ã€‚</span></span><br><span class="line">USER_COMMENT_PREFIX = <span class="string">b&#x27;UNDEFINED\x00&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode_exif</span>(<span class="params">input_image_path: <span class="built_in">str</span>, secret_message: <span class="built_in">str</span>, output_image_path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    å°†ç§˜å¯†ä¿¡æ¯ä½œä¸ºéšå½¢æ°´å°ç¼–ç åˆ°å›¾ç‰‡çš„EXIFå…ƒæ•°æ®ä¸­ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        input_image_path: è¾“å…¥å›¾ç‰‡çš„è·¯å¾„ã€‚</span></span><br><span class="line"><span class="string">        secret_message: è¦éšè—çš„ä¿¡æ¯ã€‚</span></span><br><span class="line"><span class="string">        output_image_path: ä¿å­˜å¸¦æ°´å°å›¾ç‰‡çš„è·¯å¾„ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        å¦‚æœç¼–ç æˆåŠŸï¼Œè¿”å› Trueï¼Œå¦åˆ™è¿”å› Falseã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        logger.info(<span class="string">f&quot;æ­£åœ¨ä¸º &#x27;<span class="subst">&#123;Path(input_image_path).name&#125;</span>&#x27; æ·»åŠ EXIFæ°´å°...&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ‰“å¼€å›¾ç‰‡</span></span><br><span class="line">        image = Image.<span class="built_in">open</span>(input_image_path)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å¤åˆ¶åŸå§‹å›¾ç‰‡ä¿¡æ¯ï¼Œä»¥ä¾¿åœ¨ä¿å­˜æ—¶ä¿ç•™è´¨é‡ã€DPIç­‰è®¾ç½®</span></span><br><span class="line">        image_info = image.info.copy()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ£€æŸ¥å›¾ç‰‡æ˜¯å¦å·²æœ‰EXIFæ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºä¸€ä¸ªç©ºçš„</span></span><br><span class="line">        exif_dict = &#123;&#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;exif&quot;</span> <span class="keyword">in</span> image_info <span class="keyword">and</span> image_info[<span class="string">&#x27;exif&#x27;</span>]:</span><br><span class="line">            exif_dict = piexif.load(image_info[<span class="string">&quot;exif&quot;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># [FIXED] ç¡®ä¿ &#x27;Exif&#x27; å­å­—å…¸å­˜åœ¨ï¼Œé˜²æ­¢ KeyError</span></span><br><span class="line">        <span class="keyword">if</span> piexif.ImageIFD.ExifPtr <span class="keyword">not</span> <span class="keyword">in</span> exif_dict:</span><br><span class="line">             exif_dict[<span class="string">&#x27;Exif&#x27;</span>] = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># [FIXED] å°†ç§˜å¯†ä¿¡æ¯ç¼–ç å¹¶æ·»åŠ æ ‡å‡†å‰ç¼€ï¼Œç„¶åæ”¾å…¥ UserComment å­—æ®µ</span></span><br><span class="line">        <span class="comment"># è¿™æ˜¯å­˜å‚¨ä»»æ„ç”¨æˆ·æ•°æ®çš„æ ‡å‡†å­—æ®µ</span></span><br><span class="line">        user_comment_payload = USER_COMMENT_PREFIX + secret_message.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        exif_dict[<span class="string">&#x27;Exif&#x27;</span>][piexif.ExifIFD.UserComment] = user_comment_payload</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å°†æ›´æ–°åçš„EXIFå­—å…¸è½¬æ¢ä¸ºå­—èŠ‚æµ</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            exif_bytes = piexif.dump(exif_dict)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># æœ‰æ—¶ EXIF æ•°æ®å¯èƒ½åŒ…å« piexif ä¸æ”¯æŒçš„æ ¼å¼</span></span><br><span class="line">            logger.error(<span class="string">f&quot;æ— æ³•åºåˆ—åŒ– EXIF æ•°æ®: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># å°è¯•ç§»é™¤å¯èƒ½å¯¼è‡´é—®é¢˜çš„ç¼©ç•¥å›¾æ•°æ®</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;thumbnail&#x27;</span> <span class="keyword">in</span> exif_dict:</span><br><span class="line">                <span class="keyword">del</span> exif_dict[<span class="string">&#x27;thumbnail&#x27;</span>]</span><br><span class="line">                exif_bytes = piexif.dump(exif_dict)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># [FIXED] ä¿å­˜å›¾ç‰‡ï¼Œå¹¶é™„ä¸Šæ–°çš„EXIFæ•°æ®</span></span><br><span class="line">        <span class="comment"># å¯¹äº JPEGï¼Œä¼ é€’åŸå§‹ info å­—å…¸ä»¥ä¿ç•™è´¨é‡ç­‰è®¾ç½®</span></span><br><span class="line">        <span class="comment"># å¯¹äº PNG ç­‰å…¶ä»–æ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨ exif å‚æ•°</span></span><br><span class="line">        <span class="keyword">if</span> image.<span class="built_in">format</span> == <span class="string">&#x27;JPEG&#x27;</span>:</span><br><span class="line">            image.save(output_image_path, <span class="string">&quot;jpeg&quot;</span>, exif=exif_bytes, **image_info)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            image.save(output_image_path, exif=exif_bytes)</span><br><span class="line"></span><br><span class="line">        logger.success(<span class="string">f&quot;æˆåŠŸå°†EXIFæ°´å°å†™å…¥ &#x27;<span class="subst">&#123;Path(output_image_path).name&#125;</span>&#x27;.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        logger.error(<span class="string">f&quot;è¾“å…¥æ–‡ä»¶æœªæ‰¾åˆ°: <span class="subst">&#123;input_image_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.exception(<span class="string">f&quot;æ·»åŠ EXIFæ°´å°æ—¶å‘ç”Ÿé”™è¯¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode_exif</span>(<span class="params">encoded_image_path: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">str</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ä»å›¾ç‰‡çš„EXIFå…ƒæ•°æ®ä¸­è§£ç å‡ºéšè—çš„ç§˜å¯†ä¿¡æ¯ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        encoded_image_path: å¸¦æ°´å°å›¾ç‰‡çš„è·¯å¾„ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        è§£ç åçš„ä¿¡æ¯å­—ç¬¦ä¸²ï¼Œå¦‚æœæœªæ‰¾åˆ°æˆ–å‘ç”Ÿé”™è¯¯åˆ™è¿”å› Noneã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        logger.info(<span class="string">f&quot;æ­£åœ¨ä» &#x27;<span class="subst">&#123;Path(encoded_image_path).name&#125;</span>&#x27; è§£ç EXIFæ°´å°...&quot;</span>)</span><br><span class="line"></span><br><span class="line">        image = Image.<span class="built_in">open</span>(encoded_image_path)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ£€æŸ¥å›¾ç‰‡æ˜¯å¦æœ‰EXIFæ•°æ®</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;exif&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> image.info <span class="keyword">or</span> <span class="keyword">not</span> image.info[<span class="string">&#x27;exif&#x27;</span>]:</span><br><span class="line">            logger.warning(<span class="string">&quot;å›¾ç‰‡ä¸­æœªæ‰¾åˆ°EXIFæ•°æ®ã€‚&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># åŠ è½½EXIFæ•°æ®</span></span><br><span class="line">        exif_dict = piexif.load(image.info[<span class="string">&quot;exif&quot;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment"># [FIXED] å®‰å…¨åœ°ä» UserComment å­—æ®µè¯»å–ä¿¡æ¯ï¼Œé˜²æ­¢ KeyError</span></span><br><span class="line">        exif_ifd = exif_dict.get(<span class="string">&#x27;Exif&#x27;</span>, &#123;&#125;)</span><br><span class="line">        user_comment_bytes = exif_ifd.get(piexif.ExifIFD.UserComment)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> user_comment_bytes:</span><br><span class="line">            <span class="comment"># [FIXED] æ£€æŸ¥æ˜¯å¦å­˜åœ¨æˆ‘ä»¬å®šä¹‰çš„å‰ç¼€ï¼Œå¹¶å‰¥ç¦»å®ƒ</span></span><br><span class="line">            <span class="keyword">if</span> user_comment_bytes.startswith(USER_COMMENT_PREFIX):</span><br><span class="line">                message_bytes = user_comment_bytes[<span class="built_in">len</span>(USER_COMMENT_PREFIX):]</span><br><span class="line">                <span class="comment"># å°†å­—èŠ‚è§£ç å›å­—ç¬¦ä¸²</span></span><br><span class="line">                decoded_message = message_bytes.decode(<span class="string">&#x27;utf-8&#x27;</span>, errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">                logger.success(<span class="string">&quot;æˆåŠŸè§£ç EXIFæ°´å°ã€‚&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> decoded_message</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                logger.warning(<span class="string">&quot;åœ¨&#x27;UserComment&#x27;å­—æ®µä¸­æ‰¾åˆ°æ•°æ®ï¼Œä½†ä¸åŒ…å«é¢„æœŸçš„æ°´å°å‰ç¼€ã€‚&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logger.warning(<span class="string">&quot;åœ¨EXIFä¸­æœªæ‰¾åˆ°&#x27;UserComment&#x27;æ°´å°å­—æ®µã€‚&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        logger.error(<span class="string">f&quot;æ–‡ä»¶æœªæ‰¾åˆ°: <span class="subst">&#123;encoded_image_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.exception(<span class="string">f&quot;è§£ç EXIFæ°´å°æ—¶å‘ç”Ÿé”™è¯¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="æŠ€æœ¯æ€»ç»“å¯¹æ¯”">æŠ€æœ¯æ€»ç»“å¯¹æ¯”</h3><table><thead><tr><th style="text-align:left">æŠ€æœ¯ç±»åˆ«</th><th style="text-align:left">æ ¸å¿ƒç®—æ³•</th><th style="text-align:left">ä¸»è¦ä¼˜ç‚¹</th><th style="text-align:left">ä¸»è¦ç¼ºç‚¹</th><th style="text-align:left">å…¸å‹åº”ç”¨</th></tr></thead><tbody><tr><td style="text-align:left"><strong>ç©ºåŸŸ (Spatial Domain)</strong></td><td style="text-align:left"><strong>LSB</strong></td><td style="text-align:left">å®ç°ç®€å•ã€å®¹é‡å¤§</td><td style="text-align:left"><strong>é²æ£’æ€§æå·®</strong>ï¼Œä¸€ç¢°å°±å</td><td style="text-align:left"><strong>å®Œæ•´æ€§è®¤è¯ (è„†å¼±æ°´å°)</strong></td></tr><tr><td style="text-align:left"><strong>å˜æ¢åŸŸ (Transform Domain)</strong></td><td style="text-align:left"><strong>DCT</strong></td><td style="text-align:left"><strong>å¯¹å‹ç¼©é²æ£’</strong>ã€éšè”½æ€§å¥½</td><td style="text-align:left">å¯¹å‡ ä½•æ”»å‡»æŠµæŠ—åŠ›ä¸€èˆ¬</td><td style="text-align:left"><strong>ç‰ˆæƒä¿æŠ¤ (é²æ£’æ°´å°)</strong></td></tr><tr><td style="text-align:left"><strong>å˜æ¢åŸŸ (Transform Domain)</strong></td><td style="text-align:left"><strong>DWT</strong></td><td style="text-align:left"><strong>ç»¼åˆé²æ£’æ€§å¼º</strong>ï¼Œå°¤å…¶å¯¹è£å‰ªç­‰</td><td style="text-align:left">ç®—æ³•æ¯”DCTå¤æ‚</td><td style="text-align:left"><strong>ç‰ˆæƒä¿æŠ¤ (é²æ£’æ°´å°)</strong></td></tr><tr><td style="text-align:left"><strong>å˜æ¢åŸŸ (Transform Domain)</strong></td><td style="text-align:left"><strong>DFT</strong></td><td style="text-align:left"><strong>å¯¹æ—‹è½¬/ç¼©æ”¾é²æ£’</strong></td><td style="text-align:left">å®ç°å¤æ‚ï¼Œå¯èƒ½å½±å“ç”»è´¨</td><td style="text-align:left"><strong>æŠµæŠ—å‡ ä½•æ”»å‡»çš„ç‰¹æ®Šåº”ç”¨</strong></td></tr></tbody></table><p>ç®€å•æ¥è¯´ï¼š</p><ul><li>æƒ³åš<strong>é˜²ä¼ªæ ‡ç­¾</strong>ï¼Œä¸€æ”¹å°±å¤±æ•ˆï¼Œç”¨ <strong>LSB</strong>ã€‚</li><li>æƒ³åš<strong>ç‰ˆæƒå°ç« </strong>ï¼Œä¸æ€•å‹ç¼©å’ŒåŸºæœ¬å¤„ç†ï¼Œç”¨ <strong>DCT</strong> æˆ– <strong>DWT</strong>ã€‚å®ƒä»¬æ˜¯ç›®å‰æœ€å®ç”¨å’Œæœ€ä¸»æµçš„é²æ£’æ°´å°æŠ€æœ¯ã€‚</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å®ç°æµç¨‹æ¡†æ¶&quot;&gt;å®ç°æµç¨‹æ¡†æ¶&lt;/h2&gt;
&lt;p&gt;æ— è®ºä½¿ç”¨å“ªç§æŠ€æœ¯ï¼Œä¸€ä¸ªå®Œæ•´çš„æ•°å­—æ°´å°ç³»ç»Ÿé€šå¸¸éƒ½åŒ…æ‹¬ä¸¤ä¸ªåŸºæœ¬è¿‡ç¨‹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;æ°´å°åµŒå…¥ (Watermark Embedding)&lt;/strong&gt;ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;</summary>
      
    
    
    
    
    <category term="python" scheme="https://caozhaoqi.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>Docker éƒ¨ç½² Tailscale</title>
    <link href="https://caozhaoqi.github.io/2025/07/17/tailscale-docker-build/"/>
    <id>https://caozhaoqi.github.io/2025/07/17/tailscale-docker-build/</id>
    <published>2025-07-17T12:10:39.000Z</published>
    <updated>2025-11-25T15:05:10.366Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç®€ä»‹">ç®€ä»‹</h2><h3 id="ä¸€ã€Tailscale-åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ">ä¸€ã€Tailscale åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>ä½ å¯ä»¥æŠŠå®ƒç†è§£æˆä¸€ä¸ª**â€œä¸ºä½ æ‰€æœ‰è®¾å¤‡æ‰“é€ çš„ã€ç§äººçš„ã€åŠ å¯†çš„è™šæ‹Ÿå±€åŸŸç½‘â€**ã€‚</p><ul><li><strong>ä¼ ç»Ÿçš„VPN</strong>ï¼šåƒæ˜¯åœ¨ä½ å®¶ï¼ˆå±€åŸŸç½‘ï¼‰å’Œå…¬å¸ï¼ˆå¦ä¸€ä¸ªå±€åŸŸç½‘ï¼‰ä¹‹é—´æŒ–äº†ä¸€æ¡ç§˜å¯†éš§é“ã€‚</li><li><strong>Tailscale</strong>ï¼šæ›´åƒæ˜¯ç»™ä½ çš„æ¯ä¸€å°è®¾å¤‡ï¼ˆNASã€ç”µè„‘ã€æ‰‹æœºã€å¹³æ¿ï¼‰éƒ½ç©¿ä¸Šäº†ä¸€ä»¶â€œéšèº«è¡£â€ï¼Œå¹¶ç»™å®ƒä»¬ä¸€ä¸ªç§˜å¯†çš„è”ç»œæš—å·ã€‚æ— è®ºè¿™äº›è®¾å¤‡èº«å¤„ä¸–ç•Œä½•åœ°ï¼Œåªè¦å®ƒä»¬éƒ½ç©¿ç€è¿™ä»¶â€œéšèº«è¡£â€ï¼ˆå®‰è£…äº† Tailscale å®¢æˆ·ç«¯å¹¶ç”¨åŒä¸€è´¦å·ç™»å½•ï¼‰ï¼Œå®ƒä»¬å°±èƒ½äº’ç›¸çœ‹è§ã€äº’ç›¸é€šä¿¡ï¼Œä»¿ä½›å°±åœ¨åŒä¸€ä¸ªæˆ¿é—´é‡Œã€‚</li></ul><p>è¿™ä¸ªâ€œè™šæ‹Ÿå±€åŸŸç½‘â€æ˜¯å»ºç«‹åœ¨äº’è”ç½‘ä¹‹ä¸Šçš„ï¼Œä½†å®ƒåˆæ˜¯å®Œå…¨éš”ç¦»å’ŒåŠ å¯†çš„ï¼Œå¤–ç•Œæ— æ³•çª¥æ¢ã€‚</p><h3 id="äºŒã€å®ƒå¦‚ä½•è§£å†³ä½ çš„-NAS-å¤–é“¾é—®é¢˜ï¼Ÿ">äºŒã€å®ƒå¦‚ä½•è§£å†³ä½ çš„ NAS å¤–é“¾é—®é¢˜ï¼Ÿ</h3><p>Tailscale é€šè¿‡ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒåŠŸèƒ½æ¥è§£å†³ä½ çš„é—®é¢˜ï¼š</p><ol><li><strong>ç¨³å®šçš„è™šæ‹Ÿ IP åœ°å€</strong>ï¼šä¸€æ—¦ä½ çš„ NAS åŠ å…¥äº† Tailscale ç½‘ç»œï¼Œå®ƒä¼šè¢«åˆ†é…ä¸€ä¸ª <code>100.x.x.x</code> å¼€å¤´çš„ã€ç‹¬ä¸€æ— äºŒä¸”å›ºå®šçš„ IP åœ°å€ã€‚ä½ å†ä¹Ÿä¸ç”¨å…³å¿ƒå®¶é‡Œå®½å¸¦çš„å…¬ç½‘ IP æ˜¯ä¸æ˜¯å˜äº†ã€‚</li><li><strong>é›¶é…ç½®ç©¿é€ (Zero-config NAT traversal)</strong>ï¼šä½ ä¸éœ€è¦åœ¨è·¯ç”±å™¨ä¸Šåšä»»ä½•ç«¯å£è½¬å‘ã€‚Tailscale ä¼šè‡ªåŠ¨æƒ³åŠæ³•åœ¨ä½ çš„è®¾å¤‡ä¹‹é—´â€œæ‰“æ´â€ï¼Œå»ºç«‹ç‚¹å¯¹ç‚¹ï¼ˆP2Pï¼‰çš„åŠ å¯†è¿æ¥ã€‚è¿™æ„å‘³ç€æ•°æ®ä¼ è¾“é€Ÿåº¦å¾ˆå¿«ï¼Œå› ä¸ºå¤§éƒ¨åˆ†æ—¶é—´æ•°æ®æ˜¯ç›´è¿çš„ï¼Œä¸ç»è¿‡ç¬¬ä¸‰æ–¹æœåŠ¡å™¨ä¸­è½¬ã€‚</li><li><strong>æé«˜çš„å®‰å…¨æ€§</strong>ï¼šå®ƒåŸºäºç›®å‰æœ€å…ˆè¿›çš„ VPN åè®® <strong>WireGuardÂ®</strong> æ„å»ºï¼Œæ‰€æœ‰é€šä¿¡éƒ½æ˜¯ç«¯åˆ°ç«¯åŠ å¯†çš„ã€‚å› ä¸ºä½ æ²¡æœ‰åœ¨è·¯ç”±å™¨ä¸Šå¼€æ”¾ä»»ä½•ç«¯å£ï¼Œæ‰€ä»¥ä½ çš„ NAS ä¸ä¼šæš´éœ²åœ¨å…¬ç½‘ä¸Šï¼Œå¤§å¤§é™ä½äº†è¢«é»‘å®¢æ‰«æå’Œæ”»å‡»çš„é£é™©ã€‚</li><li><strong>è®¾å¤‡é—´çš„æ— ç¼è®¿é—®</strong>ï¼šåªè¦ä½ çš„ç”µè„‘æˆ–æ‰‹æœºä¹Ÿå®‰è£…å¹¶ç™»å½•äº† Tailscaleï¼Œä½ å°±å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ï¼Œç›´æ¥é€šè¿‡ NAS çš„é‚£ä¸ª <code>100.x.x.x</code> è™šæ‹Ÿ IP æ¥è®¿é—®å®ƒçš„ç®¡ç†é¡µé¢ã€File Station ç­‰æ‰€æœ‰æœåŠ¡ï¼Œä½“éªŒå’Œåœ¨å®¶é‡Œä¸€æ¨¡ä¸€æ ·ã€‚</li></ol><h2 id="éƒ¨ç½²">éƒ¨ç½²</h2><h3 id="éƒ¨ç½²æ–¹å¼ä¸€ï¼šä½¿ç”¨-docker-run-å‘½ä»¤ï¼ˆå•æ¬¡éƒ¨ç½²ï¼‰">éƒ¨ç½²æ–¹å¼ä¸€ï¼šä½¿ç”¨ <code>docker run</code> å‘½ä»¤ï¼ˆå•æ¬¡éƒ¨ç½²ï¼‰</h3><p>è¿™æ˜¯æœ€ç›´æ¥çš„æ–¹å¼ï¼Œé€‚åˆå¿«é€Ÿå¯åŠ¨ã€‚</p><h4 id="æ­¥éª¤-1ï¼šå‡†å¤‡æŒä¹…åŒ–ç›®å½•">æ­¥éª¤ 1ï¼šå‡†å¤‡æŒä¹…åŒ–ç›®å½•</h4><p>ä¸ºäº†è®© Tailscale çš„çŠ¶æ€ï¼ˆä¸»è¦æ˜¯å®ƒçš„èº«ä»½å¯†é’¥ï¼‰åœ¨å®¹å™¨é‡å¯åä¸ä¸¢å¤±ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ªç›®å½•æ¥æŒä¹…åŒ–å­˜å‚¨å®ƒã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é€šè¿‡ SSH ç™»å½•åˆ°ä½ çš„ NAS æˆ–æœåŠ¡å™¨</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /path/to/your/appdata/tailscale</span><br><span class="line"><span class="comment"># æ³¨æ„ï¼šè¯·å°† /path/to/your/appdata æ›¿æ¢ä¸ºä½ è‡ªå·±å­˜æ”¾åº”ç”¨æ•°æ®çš„å®é™…è·¯å¾„</span></span><br><span class="line"><span class="comment"># ä¾‹å¦‚ï¼Œåœ¨ç¾¤æ™–ä¸Šå¯èƒ½æ˜¯ /volume1/docker/tailscale</span></span><br></pre></td></tr></table></figure><h4 id="æ­¥éª¤-2ï¼šè¿è¡Œ-Docker-å®¹å™¨">æ­¥éª¤ 2ï¼šè¿è¡Œ Docker å®¹å™¨</h4><p>å¤åˆ¶å¹¶æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ã€‚è¿™æ¡å‘½ä»¤å·²ç»åŒ…å«äº†è¿è¡Œ Tailscale æ‰€éœ€çš„æ‰€æœ‰å…³é”®é…ç½®ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">  --name=tailscaled \</span><br><span class="line">  -v /path/to/your/appdata/tailscale:/var/lib/tailscale \</span><br><span class="line">  -v /dev/net/tun:/dev/net/tun \</span><br><span class="line">  --network=host \</span><br><span class="line">  --cap-add=NET_ADMIN \</span><br><span class="line">  --cap-add=NET_RAW \</span><br><span class="line">  --restart unless-stopped \</span><br><span class="line">  tailscale/tailscale</span><br></pre></td></tr></table></figure><p><strong>å‘½ä»¤å‚æ•°è¯¦è§£ï¼š</strong></p><ul><li><code>docker run -d</code>: åœ¨åå°ï¼ˆdetached modeï¼‰è¿è¡Œå®¹å™¨ã€‚</li><li><code>--name=tailscaled</code>: ç»™å®¹å™¨èµ·ä¸€ä¸ªå¥½è®°çš„åå­—ï¼Œæ–¹ä¾¿ç®¡ç†ã€‚</li><li><code>-v /path/to/your/appdata/tailscale:/var/lib/tailscale</code>: <strong>ã€æ ¸å¿ƒã€‘</strong> å°†ä¸»æœºä¸Šçš„ç›®å½•æŒ‚è½½åˆ°å®¹å™¨å†…ï¼Œç”¨äºä¿å­˜ Tailscale çš„çŠ¶æ€ã€‚<strong>åŠ¡å¿…æ›¿æ¢ä¸ºä½ è‡ªå·±çš„è·¯å¾„</strong>ã€‚</li><li><code>-v /dev/net/tun:/dev/net/tun</code>: å°†ä¸»æœºçš„ TUN è®¾å¤‡æŒ‚è½½åˆ°å®¹å™¨å†…ï¼Œè¿™æ˜¯ Tailscale åˆ›å»ºè™šæ‹Ÿç½‘å¡æ‰€å¿…éœ€çš„ã€‚</li><li><code>--network=host</code>: <strong>ã€æ ¸å¿ƒã€‘</strong> è®©å®¹å™¨ç›´æ¥ä½¿ç”¨ä¸»æœºçš„ç½‘ç»œï¼Œè¿™æ˜¯æœ€ç®€å•ä¸”åŠŸèƒ½æœ€å…¨çš„æ¨¡å¼ã€‚å®¹å™¨å¯ä»¥è½»æ¾è®¿é—®ä¸»æœºçš„æ‰€æœ‰ç«¯å£ï¼Œä¹Ÿæ–¹ä¾¿å°†ä¸»æœºä½œä¸ºå­ç½‘è·¯ç”±ï¼ˆSubnet Routerï¼‰ã€‚</li><li><code>--cap-add=NET_ADMIN --cap-add=NET_RAW</code>: æˆäºˆå®¹å™¨æ“ä½œç½‘ç»œæ¥å£æ‰€éœ€çš„ Linux Capabilities æƒé™ã€‚</li><li><code>--restart unless-stopped</code>: è®¾ç½®å®¹å™¨çš„é‡å¯ç­–ç•¥ï¼Œé™¤éæ‰‹åŠ¨åœæ­¢ï¼Œå¦åˆ™ Docker é‡å¯æ—¶ä¼šè‡ªåŠ¨å¯åŠ¨è¯¥å®¹å™¨ã€‚</li><li><code>tailscale/tailscale</code>: æŒ‡å®šè¦ä½¿ç”¨çš„å®˜æ–¹ Docker é•œåƒã€‚</li></ul><h4 id="æ­¥éª¤-3ï¼šå°†-NAS-åŠ å…¥ä½ çš„-Tailscale-ç½‘ç»œ">æ­¥éª¤ 3ï¼šå°† NAS åŠ å…¥ä½ çš„ Tailscale ç½‘ç»œ</h4><p>å®¹å™¨å·²ç»åœ¨è¿è¡Œäº†ï¼Œä½†å®ƒè¿˜ä¸çŸ¥é“è‡ªå·±æ˜¯è°ã€‚æˆ‘ä»¬éœ€è¦æ‰§è¡Œä¸€æ¡å‘½ä»¤æ¥è®©å®ƒç™»å½•ã€‚</p><ol><li><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå¯åŠ¨ Tailscale å¹¶è·å–ç™»å½•é“¾æ¥ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> tailscaled tailscale up</span><br></pre></td></tr></table></figure></li><li><p>å‘½ä»¤æ‰§è¡Œåï¼Œç»ˆç«¯ä¼šè¾“å‡ºä¸€ä¸ªç™»å½• URLï¼Œçœ‹èµ·æ¥åƒè¿™æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">To authenticate, visit:</span><br><span class="line"></span><br><span class="line">    https://login.tailscale.com/a/123456789ABC</span><br></pre></td></tr></table></figure></li><li><p>å¤åˆ¶è¿™ä¸ª URLï¼Œåœ¨ä½ çš„ç”µè„‘æµè§ˆå™¨ä¸­æ‰“å¼€ï¼Œç”¨ä½ çš„ Tailscale è´¦æˆ·ç™»å½•å¹¶æˆæƒè¿™å°æ–°è®¾å¤‡ã€‚</p></li><li><p>æˆæƒæˆåŠŸåï¼Œå›åˆ°ä½ çš„ <a href="https://login.tailscale.com/admin/machines">Tailscale Admin Console</a> åå°ï¼Œä½ å°±èƒ½çœ‹åˆ°è¿™å°æ–°è®¾å¤‡å·²ç»åŠ å…¥äº†ä½ çš„ç½‘ç»œã€‚</p></li></ol><p><strong>è‡³æ­¤ï¼Œä½ çš„ NAS å·²ç»æˆåŠŸé€šè¿‡ Docker åŠ å…¥äº† Tailscale ç½‘ç»œï¼</strong> ä½ å¯ä»¥åœ¨ä»»ä½•å…¶ä»–å·²ç™»å½• Tailscale çš„è®¾å¤‡ä¸Šï¼Œé€šè¿‡åˆ†é…çš„ <code>100.x.x.x</code> IP åœ°å€æ¥è®¿é—®ä½ çš„ NASã€‚</p><hr><h3 id="éƒ¨ç½²æ–¹å¼äºŒï¼šä½¿ç”¨-docker-composeï¼ˆæ¨èï¼Œä¾¿äºç®¡ç†ï¼‰">éƒ¨ç½²æ–¹å¼äºŒï¼šä½¿ç”¨ <code>docker-compose</code>ï¼ˆæ¨èï¼Œä¾¿äºç®¡ç†ï¼‰</h3><p>å¦‚æœä½ éœ€è¦ç®¡ç†å¤šä¸ªå®¹å™¨ï¼Œæˆ–è€…å¸Œæœ›å°†é…ç½®ä»¥æ–‡ä»¶å½¢å¼ä¿å­˜ä¸‹æ¥ï¼Œ<code>docker-compose</code> æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚</p><h4 id="æ­¥éª¤-1ï¼šåˆ›å»º-docker-compose-yml-æ–‡ä»¶">æ­¥éª¤ 1ï¼šåˆ›å»º <code>docker-compose.yml</code> æ–‡ä»¶</h4><p>åœ¨ä½ å–œæ¬¢çš„ä½ç½®ï¼ˆä¾‹å¦‚ <code>/volume1/docker/tailscale</code>ï¼‰åˆ›å»ºä¸€ä¸ªåä¸º <code>docker-compose.yml</code> çš„æ–‡ä»¶ï¼Œå¹¶å°†ä»¥ä¸‹å†…å®¹ç²˜è´´è¿›å»ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.7&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">tailscaled:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tailscale/tailscale</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">tailscaled</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">my-nas</span> <span class="comment"># åœ¨ Tailscale ç®¡ç†åå°æ˜¾ç¤ºçš„è®¾å¤‡å</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data:/var/lib/tailscale</span> <span class="comment"># å°†çŠ¶æ€ä¿å­˜åœ¨å½“å‰ç›®å½•ä¸‹çš„ data æ–‡ä»¶å¤¹</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/dev/net/tun:/dev/net/tun</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">cap_add:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">NET_ADMIN</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">NET_RAW</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„ï¼š</strong></p><ul><li><code>hostname</code>: ä½ å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªåå­—ï¼Œè¿™æ ·åœ¨ Tailscale åå°ä¸€çœ¼å°±èƒ½è®¤å‡ºæ˜¯å“ªå°è®¾å¤‡ã€‚</li><li><code>volumes</code>: <code>- ./data:/var/lib/tailscale</code> è¿™ç§ç›¸å¯¹è·¯å¾„çš„å†™æ³•è¡¨ç¤ºå°†çŠ¶æ€æ–‡ä»¶ä¿å­˜åœ¨ <code>docker-compose.yml</code> æ–‡ä»¶åŒçº§çš„ <code>data</code> æ–‡ä»¶å¤¹å†…ï¼Œéå¸¸æ–¹ä¾¿ã€‚</li></ul><h4 id="æ­¥éª¤-2ï¼šå¯åŠ¨æœåŠ¡">æ­¥éª¤ 2ï¼šå¯åŠ¨æœåŠ¡</h4><p>åœ¨ <code>docker-compose.yml</code> æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ä¸­ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure><h4 id="æ­¥éª¤-3ï¼šç™»å½•å’Œæˆæƒ">æ­¥éª¤ 3ï¼šç™»å½•å’Œæˆæƒ</h4><p>è¿™ä¸€æ­¥å’Œ <code>docker run</code> æ–¹å¼å®Œå…¨ä¸€æ ·ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose <span class="built_in">exec</span> tailscaled tailscale up</span><br></pre></td></tr></table></figure><p>ç„¶åå¤åˆ¶è¾“å‡ºçš„ URL åˆ°æµè§ˆå™¨å®Œæˆæˆæƒã€‚</p><hr><h3 id="é«˜çº§åŠŸèƒ½ï¼šå¦‚ä½•ç”Ÿæˆå¤–é“¾å’Œè®¿é—®å†…ç½‘ï¼Ÿ">é«˜çº§åŠŸèƒ½ï¼šå¦‚ä½•ç”Ÿæˆå¤–é“¾å’Œè®¿é—®å†…ç½‘ï¼Ÿ</h3><p>éƒ¨ç½²æˆåŠŸåï¼Œä½ å¯ä»¥åˆ©ç”¨ Tailscale çš„é«˜çº§åŠŸèƒ½æ¥å®ç°æœ€åˆçš„ç›®æ ‡ã€‚</p><h4 id="1-å°†-NAS-ä½œä¸ºå­ç½‘è·¯ç”±-Subnet-Router">1. å°† NAS ä½œä¸ºå­ç½‘è·¯ç”± (Subnet Router)</h4><p><strong>åœºæ™¯</strong>ï¼šä½ æƒ³é€šè¿‡æ‰‹æœºï¼ˆå·²è¿æ¥ Tailscaleï¼‰è®¿é—®ä½ å®¶é‡Œçš„å…¶ä»–è®¾å¤‡ï¼Œæ¯”å¦‚æ‰“å°æœº (<code>192.168.1.100</code>)ã€‚</p><ol><li><p>ä¿®æ”¹å¯åŠ¨å‘½ä»¤ï¼Œä½¿å…¶â€œå®£å‘Šâ€å®ƒå¯ä»¥è·¯ç”±çš„å†…ç½‘ç½‘æ®µã€‚åœ¨æ‰§è¡Œ <code>tailscale up</code> æ—¶åŠ å…¥ <code>--advertise-routes</code> å‚æ•°ã€‚</p><ul><li>ä½ éœ€è¦å…ˆ <code>down</code> å† <code>up</code>ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> tailscaled tailscale down</span><br><span class="line">docker <span class="built_in">exec</span> tailscaled tailscale up --advertise-routes=192.168.1.0/24</span><br><span class="line"><span class="comment"># !!! å°† 192.168.1.0/24 æ›¿æ¢ä¸ºä½ è‡ªå·±çš„å±€åŸŸç½‘ç½‘æ®µ !!!</span></span><br><span class="line">docker <span class="built_in">exec</span> tailscaled tailscale up --advertise-routes=192.168.10.0/24 -accept-dns=<span class="literal">false</span></span><br></pre></td></tr></table></figure></li></ul></li><li><p>åœ¨ Tailscale Admin Console åå°ï¼Œæ‰¾åˆ°ä½ çš„ NAS è®¾å¤‡ï¼Œç‚¹å‡»å³ä¾§çš„ â€œâ€¦â€ï¼Œé€‰æ‹© â€œEdit route settingsâ€¦â€ã€‚</p></li><li><p>å‹¾é€‰å¹¶å¯ç”¨ä½ åˆšåˆšå®£å‘Šçš„å­ç½‘è·¯ç”±ã€‚</p></li></ol><p>ç°åœ¨ï¼Œä½ ä»»ä½•è¿æ¥äº† Tailscale çš„è®¾å¤‡ï¼Œéƒ½å¯ä»¥ç›´æ¥è®¿é—® <code>192.168.1.x</code> ç½‘æ®µçš„æ‰€æœ‰è®¾å¤‡äº†ï¼Œå°±åƒåœ¨å®¶ä¸€æ ·ã€‚</p><h4 id="2-ä½¿ç”¨-Tailscale-Funnel-ç”Ÿæˆå¤–é“¾">2. ä½¿ç”¨ Tailscale Funnel ç”Ÿæˆå¤–é“¾</h4><p><strong>åœºæ™¯</strong>ï¼šä½ æƒ³ä¸´æ—¶åˆ†äº« NAS ä¸Šçš„ä¸€ä¸ªæ–‡ä»¶ç»™æ²¡æœ‰å®‰è£… Tailscale çš„æœ‹å‹ã€‚</p><ol><li><p>ç¡®ä¿ä½ çš„ Docker å®¹å™¨å·²ç»é€šè¿‡ <code>tailscale up</code> æˆåŠŸè¿æ¥ã€‚</p></li><li><p>å‡è®¾ä½ æƒ³åˆ†äº«çš„æœåŠ¡åœ¨ä¸»æœºçš„ <code>8080</code> ç«¯å£ä¸Šï¼ˆæ¯”å¦‚ä¸€ä¸ªä¸´æ—¶çš„æ–‡ä»¶æœåŠ¡å™¨ï¼‰ã€‚</p><ul><li>ç”±äºæˆ‘ä»¬ä½¿ç”¨äº† <code>--network=host</code>ï¼Œå®¹å™¨å¯ä»¥ç›´æ¥è®¿é—®åˆ°ä¸»æœºçš„ <code>8080</code> ç«¯å£ã€‚</li></ul></li><li><p>æ‰§è¡Œ Funnel å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> tailscaled tailscale funnel 8080</span><br></pre></td></tr></table></figure></li><li><p>å‘½ä»¤ä¼šè¾“å‡ºä¸€ä¸ªå…¬ç½‘å¯è®¿é—®çš„ HTTPS é“¾æ¥ï¼Œå½¢å¦‚ <code>https://your-nas-hostname.ts.net</code>ã€‚å°†è¿™ä¸ªé“¾æ¥å‘ç»™ä½ çš„æœ‹å‹å³å¯ã€‚</p></li><li><p>åˆ†äº«å®Œæ¯•åï¼ŒæŒ‰ <code>Ctrl+C</code> åœæ­¢ Funnelï¼Œå¤–é“¾å³åˆ»å¤±æ•ˆï¼Œéå¸¸å®‰å…¨ã€‚å¦‚æœæƒ³åœ¨åå°è¿è¡Œï¼Œå¯ä»¥åŠ ä¸Š <code>--bg</code> å‚æ•°ã€‚</p></li></ol><h3 id="æ€»ç»“ï¼šå¦‚ä½•ä½¿ç”¨éƒ¨ç½²åçš„æœåŠ¡">æ€»ç»“ï¼šå¦‚ä½•ä½¿ç”¨éƒ¨ç½²åçš„æœåŠ¡</h3><table><thead><tr><th style="text-align:left">ä½ çš„éœ€æ±‚</th><th style="text-align:left">ä½¿ç”¨çš„åŠŸèƒ½</th><th style="text-align:left">å…·ä½“æ“ä½œ</th></tr></thead><tbody><tr><td style="text-align:left"><strong>åœ¨å¤–é¢ç”¨</strong></td><td style="text-align:left"><strong>Tailscale æ ¸å¿ƒè¿æ¥ + MagicDNS</strong></td><td style="text-align:left">åœ¨ä½ çš„ç”µè„‘/æ‰‹æœºä¸Šå®‰è£…å¹¶ç™»å½• Tailscaleï¼Œç„¶ååƒåœ¨å®¶é‡Œä¸€æ ·ï¼Œç”¨ <code>http://è®¾å¤‡å:ç«¯å£</code> çš„æ–¹å¼è®¿é—® NAS çš„å„é¡¹æœåŠ¡ã€‚</td></tr><tr><td style="text-align:left"><strong>æ˜ å°„ä¸ºç”µè„‘ç¡¬ç›˜</strong></td><td style="text-align:left"><strong>SMB/AFP over Tailscale</strong></td><td style="text-align:left">åœ¨ç”µè„‘çš„â€œæ˜ å°„ç½‘ç»œé©±åŠ¨å™¨â€æˆ–â€œè¿æ¥æœåŠ¡å™¨â€åŠŸèƒ½ä¸­ï¼Œä½¿ç”¨ <code>\\è®¾å¤‡å</code> æˆ– <code>smb://è®¾å¤‡å</code> ä½œä¸ºåœ°å€ã€‚</td></tr><tr><td style="text-align:left"><strong>åˆ†äº«æ–‡ä»¶ç»™åˆ«äºº</strong></td><td style="text-align:left"><strong>Tailscale Funnel</strong></td><td style="text-align:left">åœ¨ NAS ä¸Šç”¨ Python æˆ–å…¶ä»–æ–¹å¼å¯åŠ¨ä¸€ä¸ªä¸´æ—¶ Web æœåŠ¡å™¨ï¼Œç„¶åç”¨ <code>tailscale funnel &lt;ç«¯å£å·&gt;</code> å‘½ä»¤ç”Ÿæˆä¸€ä¸ªä¸´æ—¶çš„å…¬ç½‘ä¸‹è½½é“¾æ¥ã€‚</td></tr><tr><td style="text-align:left"><strong>è®¿é—®å®¶é‡Œå…¶ä»–è®¾å¤‡</strong></td><td style="text-align:left"><strong>å­ç½‘è·¯ç”± (Subnet Router)</strong></td><td style="text-align:left">åœ¨éƒ¨ç½² Tailscale æ—¶å®£å‘Šå†…ç½‘ç½‘æ®µï¼Œå¹¶åœ¨ç®¡ç†åå°å¯ç”¨ã€‚ä¹‹åå°±èƒ½ç›´æ¥é€šè¿‡å†…ç½‘ IP è®¿é—®å®¶é‡Œæ‰€æœ‰è®¾å¤‡ã€‚</td></tr></tbody></table>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;ç®€ä»‹&quot;&gt;ç®€ä»‹&lt;/h2&gt;
&lt;h3 id=&quot;ä¸€ã€Tailscale-åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ&quot;&gt;ä¸€ã€Tailscale åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ&lt;/h3&gt;
&lt;p&gt;ä½ å¯ä»¥æŠŠå®ƒç†è§£æˆä¸€ä¸ª**â€œä¸ºä½ æ‰€æœ‰è®¾å¤‡æ‰“é€ çš„ã€ç§äººçš„ã€åŠ å¯†çš„è™šæ‹Ÿå±€åŸŸç½‘â€**ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;ä¼ ç»Ÿçš„V</summary>
      
    
    
    
    
    <category term="python" scheme="https://caozhaoqi.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>NAS æ–‡ä»¶å€ŸåŠ© MinIO è½¬æ¢OSS</title>
    <link href="https://caozhaoqi.github.io/2025/07/16/minio-nas-build/"/>
    <id>https://caozhaoqi.github.io/2025/07/16/minio-nas-build/</id>
    <published>2025-07-16T08:58:11.000Z</published>
    <updated>2025-11-25T15:05:10.333Z</updated>
    
    <content type="html"><![CDATA[<h3 id="æ•´ä½“æ¶æ„">æ•´ä½“æ¶æ„</h3><p>è¿™ä¸ªæ¶æ„çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š<strong>MinIO ä½œä¸ºå¯¹è±¡å­˜å‚¨çš„â€œå‰ç«¯â€ï¼Œè€Œä½ çš„ NAS ä»ç„¶æ˜¯æ•°æ®çš„â€œåç«¯â€ç‰©ç†å­˜å‚¨ã€‚</strong> ç”¨æˆ·å’Œåº”ç”¨ç¨‹åºåªä¸ MinIO äº¤äº’ï¼Œå®Œå…¨ä¸éœ€è¦å…³å¿ƒæ–‡ä»¶å…·ä½“å­˜æ”¾åœ¨ NAS çš„å“ªä¸ªç‰©ç†è·¯å¾„ä¸‹ã€‚</p><h3 id="æ–¹æ¡ˆä¼˜ç‚¹">æ–¹æ¡ˆä¼˜ç‚¹</h3><ol><li><strong>åè®®ç°ä»£åŒ–</strong>ï¼šå°†ä¼ ç»Ÿçš„ã€åŸºäºæ–‡ä»¶ç³»ç»Ÿçš„è®¿é—®ï¼ˆå¦‚ NFS, SMBï¼‰å‡çº§ä¸ºç°ä»£çš„ã€åŸºäº HTTP çš„ S3 API è®¿é—®ã€‚</li><li><strong>æ— éœ€æ•°æ®è¿ç§»</strong>ï¼šæ•°æ®ä»ç„¶å­˜æ”¾åœ¨ NAS ä¸Šï¼Œä½ ä¸éœ€è¦èŠ±è´¹å¤§é‡æ—¶é—´å»æ‹·è´æˆ–è¿ç§» TB çº§çš„æµ·é‡æ•°æ®ã€‚MinIO ç›´æ¥åœ¨ NAS çš„æ–‡ä»¶ç³»ç»Ÿä¹‹ä¸Šè¿è¡Œã€‚</li><li><strong>ç»Ÿä¸€è®¿é—®å…¥å£</strong>ï¼šæ— è®ºä½ æœ‰å¤šå°‘ä¸ª NAS å·æˆ–ç›®å½•ï¼Œéƒ½å¯ä»¥é€šè¿‡ MinIO çš„ Bucketï¼ˆå­˜å‚¨æ¡¶ï¼‰æ¥ç»„ç»‡å’Œè®¿é—®ï¼Œå½¢æˆä¸€ä¸ªç»Ÿä¸€çš„è§†å›¾ã€‚</li><li><strong>ç”Ÿæ€å…¼å®¹æ€§</strong>ï¼šå‡ ä¹æ‰€æœ‰ç°ä»£äº‘åŸç”Ÿåº”ç”¨ã€å¤§æ•°æ®æ¡†æ¶ã€å¤‡ä»½å·¥å…·éƒ½åŸç”Ÿæ”¯æŒ S3 åè®®ï¼Œå¯ä»¥æ— ç¼å¯¹æ¥ã€‚</li><li><strong>é«˜æ€§èƒ½</strong>ï¼šMinIO æœ¬èº«æ˜¯ä¸ºé«˜æ€§èƒ½è€Œè®¾è®¡çš„ï¼Œå¯ä»¥ç›´æ¥åˆ©ç”¨ NAS çš„ç¡¬ä»¶æ€§èƒ½ã€‚</li></ol><hr><h3 id="ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡å·¥ä½œ">ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡å·¥ä½œ</h3><ol><li><strong>ä¸€å°æœåŠ¡å™¨/è™šæ‹Ÿæœº</strong>ï¼šä½ éœ€è¦ä¸€å° Linux æœåŠ¡å™¨æ¥è¿è¡Œ MinIOã€‚è¿™å°æœåŠ¡å™¨<strong>å¿…é¡»èƒ½å¤Ÿé«˜é€ŸæŒ‚è½½ï¼ˆmountï¼‰ä½ çš„ NAS ç›®å½•</strong>ã€‚è¿™å°æœåŠ¡å™¨çš„ CPU å’Œå†…å­˜èµ„æºä¼šå½±å“ MinIO çš„æ€§èƒ½ï¼Œä½†å¯¹äºä¸€èˆ¬çš„æ–‡ä»¶æœåŠ¡ï¼Œé…ç½®è¦æ±‚ä¸é«˜ï¼ˆä¾‹å¦‚ 2æ ¸4G å†…å­˜å³å¯èµ·æ­¥ï¼‰ã€‚æˆ‘ä»¬ç§°è¿™å°æœåŠ¡å™¨ä¸º â€œMinIO Serverâ€ã€‚</li><li><strong>ç½‘ç»œè¿æ¥</strong>ï¼šç¡®ä¿ MinIO Server å’Œ NAS ä¹‹é—´æœ‰é«˜é€Ÿã€ä½å»¶è¿Ÿçš„ç½‘ç»œè¿æ¥ï¼ˆä¾‹å¦‚ï¼Œåƒå…†æˆ–ä¸‡å…†ä»¥å¤ªç½‘ï¼‰ã€‚</li><li><strong>NAS ç›®å½•</strong>ï¼šç¡®å®šä½ è¦æä¾›ä¸ºå¯¹è±¡å­˜å‚¨çš„ NAS ä¸Šçš„ä¸€ä¸ªæˆ–å¤šä¸ªç›®å½•ã€‚ä¾‹å¦‚ï¼Œ<code>/volume1/data</code>ã€‚</li></ol><h3 id="ç¬¬äºŒæ­¥ï¼šåœ¨-MinIO-Server-ä¸ŠæŒ‚è½½-NAS-ç›®å½•">ç¬¬äºŒæ­¥ï¼šåœ¨ MinIO Server ä¸ŠæŒ‚è½½ NAS ç›®å½•</h3><p>è¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥ã€‚ä½ å¿…é¡»å°† NAS çš„å…±äº«ç›®å½•æŒ‚è½½åˆ° MinIO Server çš„æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸Šã€‚</p><p>å‡è®¾ä½ çš„ NAS IP æ˜¯ <code>192.168.1.100</code>ï¼Œå…±äº«çš„ç›®å½•æ˜¯ <code>shared_data</code>ï¼Œä½ å¸Œæœ›å°†å®ƒæŒ‚è½½åˆ° MinIO Server çš„ <code>/mnt/nas_data</code> ç›®å½•ã€‚</p><h4 id="ä½¿ç”¨-NFS-æŒ‚è½½ï¼ˆæ¨èï¼‰">ä½¿ç”¨ NFS æŒ‚è½½ï¼ˆæ¨èï¼‰</h4><ol><li><p><strong>åœ¨ NAS ä¸Š</strong>ï¼šç¡®ä¿ NFS æœåŠ¡å·²å¼€å¯ï¼Œå¹¶ä¸” <code>shared_data</code> ç›®å½•å·²ç»é€šè¿‡ NFS å…±äº«å‡ºå»ï¼ŒåŒæ—¶æˆæƒ MinIO Server çš„ IP (<code>192.168.1.50</code> å‡è®¾) æœ‰è¯»å†™æƒé™ã€‚</p></li><li><p><strong>åœ¨ MinIO Server ä¸Š</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. å®‰è£… NFS å®¢æˆ·ç«¯</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get update</span><br><span class="line"><span class="built_in">sudo</span> apt-get install -y nfs-common</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. åˆ›å»ºæœ¬åœ°æŒ‚è½½ç‚¹</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /mnt/nas_data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. æ‰‹åŠ¨æŒ‚è½½è¿›è¡Œæµ‹è¯•</span></span><br><span class="line"><span class="comment"># -o nfsvers=4 æŒ‡å®šç‰ˆæœ¬ï¼Œå¯æ ¹æ®ä½ çš„NASè°ƒæ•´</span></span><br><span class="line"><span class="built_in">sudo</span> mount -t nfs 192.168.1.100:/shared_data /mnt/nas_data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. éªŒè¯æŒ‚è½½æ˜¯å¦æˆåŠŸ</span></span><br><span class="line"><span class="built_in">df</span> -h</span><br><span class="line"><span class="comment"># ä½ åº”è¯¥èƒ½çœ‹åˆ°ç±»ä¼¼ä¸‹é¢çš„ä¸€è¡Œ</span></span><br><span class="line"><span class="comment"># 192.168.1.100:/shared_data   50T   10T   40T   20% /mnt/nas_data</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. (é‡è¦) è®¾ç½®å¼€æœºè‡ªåŠ¨æŒ‚è½½ï¼Œé˜²æ­¢æœåŠ¡å™¨é‡å¯åæœåŠ¡å¤±æ•ˆ</span></span><br><span class="line"><span class="comment"># ç¼–è¾‘ /etc/fstab æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">sudo</span> nano /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ä¸€è¡Œ (ä½¿ç”¨ nofail é€‰é¡¹é˜²æ­¢NASæ•…éšœå¯¼è‡´æœåŠ¡å™¨æ— æ³•å¯åŠ¨)</span></span><br><span class="line">192.168.1.100:/shared_data /mnt/nas_data nfs defaults,nofail 0 0</span><br></pre></td></tr></table></figure></li></ol><h3 id="ç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨-Docker-Compose-éƒ¨ç½²-MinIO">ç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨ Docker Compose éƒ¨ç½² MinIO</h3><p>ä½¿ç”¨ Docker Compose æ˜¯éƒ¨ç½²å’Œç®¡ç† MinIO æœ€ç®€å•ã€æœ€å¯é çš„æ–¹å¼ã€‚</p><ol><li><p><strong>åœ¨ MinIO Server ä¸Šå®‰è£… Docker å’Œ Docker Composeã€‚</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… Docker</span></span><br><span class="line">curl -fsSL https://get.docker.com -o get-docker.sh</span><br><span class="line"><span class="built_in">sudo</span> sh get-docker.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… Docker Compose</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install -y docker-compose</span><br></pre></td></tr></table></figure></li><li><p><strong>åˆ›å»ºä¸€ä¸ªå·¥ä½œç›®å½•å¹¶ç¼–å†™ <code>docker-compose.yml</code> æ–‡ä»¶ã€‚</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> minio-deployment</span><br><span class="line"><span class="built_in">cd</span> minio-deployment</span><br><span class="line">nano docker-compose.yml</span><br></pre></td></tr></table></figure></li><li><p><strong>å°†ä»¥ä¸‹å†…å®¹ç²˜è´´åˆ° <code>docker-compose.yml</code> æ–‡ä»¶ä¸­ï¼š</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.7&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">minio:</span></span><br><span class="line">    <span class="comment"># ä½¿ç”¨å®˜æ–¹ MinIO é•œåƒ</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">minio/minio:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">local-oss-server</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å®šä¹‰ç¯å¢ƒå˜é‡ (è¯·åŠ¡å¿…ä¿®æ”¹å¯†ç )</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="comment"># MinIO çš„ç™»å½• Access Key (ç”¨æˆ·å)</span></span><br><span class="line">      <span class="attr">MINIO_ROOT_USER:</span> <span class="string">minioadmin</span></span><br><span class="line">      <span class="comment"># MinIO çš„ç™»å½• Secret Key (å¯†ç , è‡³å°‘8ä½)</span></span><br><span class="line">      <span class="attr">MINIO_ROOT_PASSWORD:</span> <span class="string">VERY_SECRET_PASSWORD_CHANGE_ME</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># volumes å·æŒ‚è½½æ˜¯æ ¸å¿ƒ</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="comment"># å°†æˆ‘ä»¬åˆšåˆšæŒ‚è½½çš„ NAS ç›®å½•ï¼Œæ˜ å°„åˆ° MinIO å®¹å™¨å†…éƒ¨çš„ /data ç›®å½•</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mnt/nas_data:/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mnt/nas:/data2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ports ç«¯å£æ˜ å°„</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="comment"># 9000 ç«¯å£æ˜¯ S3 API çš„è®¿é—®ç«¯å£</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9000:9000&quot;</span></span><br><span class="line">      <span class="comment"># 9001 ç«¯å£æ˜¯ MinIO Web æ§åˆ¶å°çš„è®¿é—®ç«¯å£</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9001:9001&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># command å‘½ä»¤</span></span><br><span class="line">    <span class="comment"># å‘Šè¯‰ MinIO å¯åŠ¨ä¸€ä¸ªæœåŠ¡å™¨ï¼Œå¹¶ä½¿ç”¨å®¹å™¨å†…çš„ /data ç›®å½•ä½œä¸ºå­˜å‚¨æ ¹ç›®å½•</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">server</span> <span class="string">/data</span> <span class="string">/data2</span> <span class="string">--console-address</span> <span class="string">&quot;:9001&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¥åº·æ£€æŸ¥ï¼Œç¡®ä¿æœåŠ¡æ­£å¸¸è¿è¡Œ</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost:9000/minio/health/live&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">20s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure></li><li><p><strong>å¯åŠ¨ MinIO æœåŠ¡ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure></li></ol><h3 id="ç¬¬å››æ­¥ï¼šéªŒè¯å’Œä½¿ç”¨">ç¬¬å››æ­¥ï¼šéªŒè¯å’Œä½¿ç”¨</h3><p>ç°åœ¨ï¼Œä½ çš„æœ¬åœ° OSS æœåŠ¡å·²ç»æ­å»ºå®Œæˆå¹¶å¼€å§‹è¿è¡Œäº†ï¼</p><ol><li><p><strong>è®¿é—® Web æ§åˆ¶å°</strong>ï¼š</p><ul><li>åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ <code>http://&lt;MinIO_Server_IP&gt;:9001</code>ã€‚</li><li>ä½¿ç”¨ä½ åœ¨ <code>docker-compose.yml</code> ä¸­è®¾ç½®çš„ <code>MINIO_ROOT_USER</code> (minioadmin) å’Œ <code>MINIO_ROOT_PASSWORD</code> ç™»å½•ã€‚</li></ul></li><li><p><strong>æŸ¥çœ‹æ•°æ®</strong>ï¼š</p><ul><li>ç™»å½•åï¼Œä½ ä¼šçœ‹åˆ° MinIO çš„ç•Œé¢ã€‚ç‚¹å‡» â€œBucketsâ€ï¼ˆå­˜å‚¨æ¡¶ï¼‰ã€‚</li><li><strong>ä½ ä¼šæƒŠå–œåœ°å‘ç°ï¼Œä½ åœ¨ NAS ç›®å½• <code>/mnt/nas_data</code> ä¸‹çš„æ‰€æœ‰ä¸€çº§å­ç›®å½•ï¼Œéƒ½å·²ç»è‡ªåŠ¨å˜æˆäº† MinIO çš„ Bucketsï¼</strong></li><li>ä¾‹å¦‚ï¼Œå¦‚æœä½ çš„ NAS ç›®å½•ç»“æ„æ˜¯ï¼š<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/mnt/nas_data/</span><br><span class="line">â”œâ”€â”€ images/</span><br><span class="line">â”‚   â”œâ”€â”€ cat.jpg</span><br><span class="line">â”‚   â””â”€â”€ dog.png</span><br><span class="line">â””â”€â”€ videos/</span><br><span class="line">    â””â”€â”€ movie.mp4</span><br></pre></td></tr></table></figure></li><li>é‚£ä¹ˆåœ¨ MinIO æ§åˆ¶å°é‡Œï¼Œä½ å°±ä¼šçœ‹åˆ°ä¸¤ä¸ª bucketï¼š<code>images</code> å’Œ <code>videos</code>ã€‚ä½ å¯ä»¥ç›´æ¥ç‚¹å‡»è¿›å…¥å¹¶ç®¡ç†é‡Œé¢çš„æ–‡ä»¶ã€‚</li></ul></li><li><p><strong>ä½¿ç”¨ S3 API è®¿é—®</strong>ï¼š</p><ul><li><strong>Endpoint (æœåŠ¡åœ°å€)</strong>: <code>http://&lt;MinIO_Server_IP&gt;:9000</code></li><li><strong>Access Key</strong>: <code>minioadmin</code></li><li><strong>Secret Key</strong>: <code>VERY_SECRET_PASSWORD_CHANGE_ME</code></li><li>ä½ å¯ä»¥ä½¿ç”¨ä»»ä½•æ”¯æŒ S3 çš„å®¢æˆ·ç«¯å·¥å…·ï¼ˆå¦‚ <code>s3cmd</code>, <code>mc</code>, AWS SDKï¼‰æ¥è¿æ¥å’Œæ“ä½œä½ çš„æ•°æ®ã€‚</li></ul><p><strong>ä½¿ç”¨ MinIO Client (mc) çš„ç¤ºä¾‹ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. ä¸‹è½½ mc</span></span><br><span class="line">wget https://dl.min.io/client/mc/release/linux-amd64/mc</span><br><span class="line"><span class="built_in">chmod</span> +x mc</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mv</span> mc /usr/local/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. é…ç½®ä¸€ä¸ªåˆ«åï¼ŒæŒ‡å‘ä½ çš„æœ¬åœ° OSS</span></span><br><span class="line">mc <span class="built_in">alias</span> <span class="built_in">set</span> local-oss http://&lt;MinIO_Server_IP&gt;:9000 minioadmin VERY_SECRET_PASSWORD_CHANGE_ME</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. åˆ—å‡ºæ‰€æœ‰çš„ bucket (å³ NAS ä¸Šçš„ä¸€çº§ç›®å½•)</span></span><br><span class="line">mc <span class="built_in">ls</span> local-oss</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. åˆ—å‡º images bucket é‡Œçš„æ‰€æœ‰æ–‡ä»¶</span></span><br><span class="line">mc <span class="built_in">ls</span> local-oss/images</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. ä¸Šä¼ ä¸€ä¸ªæ–°æ–‡ä»¶åˆ° videos bucket</span></span><br><span class="line">mc <span class="built_in">cp</span> my_new_video.mp4 local-oss/videos</span><br><span class="line"><span class="comment"># æ‰§è¡Œåï¼Œä½ ä¼šåœ¨ NAS çš„ /mnt/nas_data/videos/ ç›®å½•ä¸‹çœ‹åˆ° my_new_video.mp4 æ–‡ä»¶</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="é—®é¢˜">é—®é¢˜</h3><ul><li>é‡å¯åæ®‹ç•™æ–‡ä»¶æ¸…ç†</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">rm</span> -rf .minio.sys</span><br><span class="line">docker-compose down &amp;&amp; docker-compose up -d</span><br></pre></td></tr></table></figure><h3 id="æ€»ç»“">æ€»ç»“</h3><p>é€šè¿‡ <strong>NAS æŒ‚è½½ + MinIO Docker éƒ¨ç½²</strong> è¿™ä¸ªç®€å•çš„ä¸¤æ­¥ç»„åˆï¼Œä½ æˆåŠŸåœ°å°†ä¼ ç»Ÿçš„ NAS æ–‡ä»¶å­˜å‚¨â€œåŒ…è£…â€æˆäº†ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ã€æ¥å£æ ‡å‡†ã€æ˜“äºæ‰©å±•çš„æœ¬åœ°å¯¹è±¡å­˜å‚¨æœåŠ¡ã€‚è¿™ä¸ªæ–¹æ¡ˆå…¼å…·äº† NAS çš„å¤§å®¹é‡å­˜å‚¨æˆæœ¬ä¼˜åŠ¿å’Œ OSS çš„ç°ä»£åŒ–æ¥å£ä¼˜åŠ¿ï¼Œæ˜¯ç›˜æ´»å­˜é‡æ•°æ®èµ„äº§çš„ç»ä½³å®è·µã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;æ•´ä½“æ¶æ„&quot;&gt;æ•´ä½“æ¶æ„&lt;/h3&gt;
&lt;p&gt;è¿™ä¸ªæ¶æ„çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š&lt;strong&gt;MinIO ä½œä¸ºå¯¹è±¡å­˜å‚¨çš„â€œå‰ç«¯â€ï¼Œè€Œä½ çš„ NAS ä»ç„¶æ˜¯æ•°æ®çš„â€œåç«¯â€ç‰©ç†å­˜å‚¨ã€‚&lt;/strong&gt; ç”¨æˆ·å’Œåº”ç”¨ç¨‹åºåªä¸ MinIO äº¤äº’ï¼Œå®Œå…¨ä¸éœ€è¦å…³å¿ƒæ–‡ä»¶å…·ä½“å­˜æ”¾åœ¨ NAS çš„å“ªä¸ªç‰©ç†</summary>
      
    
    
    
    
    <category term="python" scheme="https://caozhaoqi.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäº FFmpeg çš„è§†é¢‘åœºæ™¯ï¼ˆé•œå¤´è¾¹ç•Œï¼‰æ£€æµ‹</title>
    <link href="https://caozhaoqi.github.io/2025/07/02/ffmpeg-detect-scene/"/>
    <id>https://caozhaoqi.github.io/2025/07/02/ffmpeg-detect-scene/</id>
    <published>2025-07-02T10:44:48.000Z</published>
    <updated>2025-11-25T15:05:10.304Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>åœ¨è§†é¢‘å¤„ç†é¢†åŸŸï¼Œåœºæ™¯æ£€æµ‹ï¼ˆScene Detectionï¼‰æˆ–ç§°é•œå¤´åˆ†å‰²ï¼ˆShot Boundary Detectionï¼‰æ˜¯ä¸€é¡¹åŸºç¡€ä¸”å…³é”®çš„ä»»åŠ¡ï¼Œå¹¿æ³›åº”ç”¨äºè§†é¢‘ç´¢å¼•ã€è‡ªåŠ¨å‰ªè¾‘ã€å†…å®¹æ‘˜è¦ç­‰åœºæ™¯ã€‚</p></blockquote><h2 id="1-æŠ€æœ¯å¯è¡Œæ€§åˆ†æ-Feasibility-Analysis"><strong>1. æŠ€æœ¯å¯è¡Œæ€§åˆ†æ (Feasibility Analysis)</strong></h2><p>å°† FFmpeg ç”¨äºåœºæ™¯æ£€æµ‹ä¸ä»…å¯è¡Œï¼Œè€Œä¸”æ˜¯ä¸€ç§éå¸¸æˆç†Ÿå’Œé«˜æ•ˆçš„æ–¹æ¡ˆã€‚å…¶å¯è¡Œæ€§ä¸»è¦åŸºäºä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li><strong>å†…ç½®çš„ä¸“ä¸šæ»¤é•œ</strong>: FFmpeg å†…ç½®äº†ä¸“é—¨ä¸ºåª’ä½“åˆ†æè®¾è®¡çš„å¼ºå¤§æ»¤é•œï¼ˆfiltersï¼‰ï¼Œå¦‚ <code>scdet</code> å’Œ <code>select</code>ï¼Œå®ƒä»¬å¯ä»¥ç›´æ¥è®¿é—®è§†é¢‘å¸§çš„åº•å±‚æ•°æ®ï¼Œå¹¶è¿›è¡Œå¿«é€Ÿçš„æ•°å­¦è¿ç®—ã€‚</li><li><strong>åƒç´ çº§å·®å¼‚è®¡ç®—</strong>: åœºæ™¯æ£€æµ‹çš„æ ¸å¿ƒåŸç†æ˜¯è®¡ç®—è¿ç»­è§†é¢‘å¸§ä¹‹é—´çš„è§†è§‰å·®å¼‚ã€‚å½“å·®å¼‚è¶…è¿‡æŸä¸ªé˜ˆå€¼æ—¶ï¼Œå³è®¤ä¸ºå‘ç”Ÿäº†åœºæ™¯åˆ‡æ¢ã€‚FFmpeg çš„æ»¤é•œèƒ½å¤Ÿé«˜æ•ˆåœ°æ‰§è¡Œè¿™ç§åƒç´ çº§çš„ç›´æ–¹å›¾æˆ–å¸§å·®è®¡ç®—ï¼Œå¹¶å°†ç»“æœé‡åŒ–ä¸ºä¸€ä¸ªâ€œåœºæ™¯å˜åŒ–åˆ†æ•°â€ï¼ˆscene scoreï¼‰ã€‚</li><li><strong>è·¨å¹³å°ä¸æ ‡å‡†åŒ–</strong>: FFmpeg æ˜¯ä¸€ä¸ªè·¨å¹³å°çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œåœ¨ Windows, macOS, Linux ä¸Šè¡¨ç°ä¸€è‡´ï¼Œæ— éœ€ä¾èµ–å¤æ‚çš„å›¾å½¢ç•Œé¢æˆ–ç‰¹å®šæ“ä½œç³»ç»ŸAPIã€‚è¿™ä½¿å…¶æˆä¸ºè‡ªåŠ¨åŒ–ã€æœåŠ¡å™¨ç«¯å¤„ç†æµç¨‹çš„ç†æƒ³é€‰æ‹©ã€‚</li><li><strong>è½»é‡çº§ä¸é›¶ä¾èµ–</strong>: ä¸éœ€è¦å®‰è£…åºå¤§ä¾èµ–åº“çš„ä¸“ä¸šè½¯ä»¶æˆ–Pythonåº“ç›¸æ¯”ï¼ŒFFmpeg åªæœ‰ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œéƒ¨ç½²ç®€å•ï¼Œèµ„æºå ç”¨æä½ã€‚</li></ul><p><strong>ç»“è®º</strong>: FFmpeg æä¾›äº†å®ç°åœºæ™¯æ£€æµ‹æ‰€éœ€çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œå…¶æ€§èƒ½å’Œæ ‡å‡†åŒ–ç‰¹æ€§ä½¿å…¶æˆä¸ºä¸€ä¸ªé«˜åº¦å¯è¡Œçš„æŠ€æœ¯é€‰å‹ã€‚</p><h2 id="2-å®ç°æ–¹æ³•-Implementation"><strong>2. å®ç°æ–¹æ³• (Implementation)</strong></h2><p>å®ç° FFmpeg åœºæ™¯æ£€æµ‹çš„æœ€ä½³å®è·µæ˜¯ç»“åˆ <code>select</code> å’Œ <code>showinfo</code> ä¸¤ä¸ªæ»¤é•œã€‚è¿™ç§æ–¹æ³•æ¯”å•ç‹¬ä½¿ç”¨è€æ—§çš„ <code>scdet</code> æ»¤é•œè¾“å‡ºæ›´å¹²å‡€ã€æ›´å¯é ã€‚</p><p><strong>æ ¸å¿ƒå‘½ä»¤</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -i <span class="string">&quot;input.mp4&quot;</span> -vf <span class="string">&quot;select=&#x27;gt(scene,THRESHOLD)&#x27;,showinfo&quot;</span> -f null -</span><br></pre></td></tr></table></figure><p><strong>å‘½ä»¤è§£æ</strong>:</p><ol><li><code>ffmpeg -i &quot;input.mp4&quot;</code>: æŒ‡å®šè¾“å…¥è§†é¢‘æ–‡ä»¶ã€‚</li><li><code>-vf &quot;...&quot;</code>: <code>-vf</code> æ˜¯ <code>-filter:v</code> çš„ç¼©å†™ï¼Œç”¨äºæŒ‡å®šè§†é¢‘æ»¤é•œé“¾ã€‚</li><li><code>select='gt(scene,THRESHOLD)'</code>: è¿™æ˜¯æ ¸å¿ƒçš„<strong>é€‰æ‹©æ»¤é•œ</strong>ã€‚<ul><li><code>scene</code>: FFmpeg å†…ç½®çš„ä¸€ä¸ªå˜é‡ï¼Œä»£è¡¨å½“å‰å¸§ä¸å‰ä¸€å¸§çš„åœºæ™¯å˜åŒ–åˆ†æ•°ï¼ˆèŒƒå›´ 0.0 åˆ° 1.0ï¼‰ã€‚</li><li><code>gt(a, b)</code>: â€œGreater Thanâ€ å‡½æ•°ï¼Œå½“ <code>a &gt; b</code> æ—¶è¿”å›çœŸã€‚</li><li><code>THRESHOLD</code>: è¿™æ˜¯ä¸€ä¸ª<strong>å¯è°ƒé˜ˆå€¼</strong>ï¼ˆä¾‹å¦‚ <code>0.4</code>ï¼‰ã€‚å€¼è¶Šä½ï¼Œæ£€æµ‹è¶Šçµæ•ã€‚è¯¥æ»¤é•œä¼šç­›é€‰å‡ºæ‰€æœ‰åœºæ™¯å˜åŒ–åˆ†æ•°å¤§äºé˜ˆå€¼çš„è§†é¢‘å¸§ã€‚</li></ul></li><li><code>,showinfo</code>: è¿™æ˜¯<strong>ä¿¡æ¯æ‰“å°æ»¤é•œ</strong>ã€‚å®ƒä¼šæ¥æ”¶ç”± <code>select</code> æ»¤é•œç­›é€‰å‡ºçš„å¸§ï¼Œå¹¶åœ¨æ ‡å‡†é”™è¯¯æµï¼ˆstderrï¼‰ä¸­æ‰“å°å‡ºè¿™äº›å¸§çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ ¼å¼é«˜åº¦ç»Ÿä¸€ã€‚</li><li><code>-f null -</code>: æŒ‡ç¤º FFmpeg ä¸ç”Ÿæˆä»»ä½•è¾“å‡ºæ–‡ä»¶ï¼Œä»…æ‰§è¡Œæ»¤é•œåˆ†æï¼Œå¹¶å°†ç»“æœè¾“å‡ºåˆ°æ ‡å‡†è¾“å‡º/é”™è¯¯æµã€‚</li></ol><p><strong>Python è„šæœ¬å®ç°</strong>:</p><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨ Python çš„ <code>subprocess</code> æ¨¡å—æ¥è°ƒç”¨æ­¤å‘½ä»¤å¹¶è§£æå…¶è¾“å‡ºã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detect_scenes_with_ffmpeg</span>(<span class="params">video_path, threshold=<span class="number">0.4</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä½¿ç”¨ FFmpeg æ£€æµ‹è§†é¢‘åœºæ™¯åˆ‡æ¢ç‚¹ã€‚&quot;&quot;&quot;</span></span><br><span class="line">    command = [</span><br><span class="line">        <span class="string">&quot;ffmpeg&quot;</span>,</span><br><span class="line">        <span class="string">&quot;-i&quot;</span>, video_path,</span><br><span class="line">        <span class="string">&quot;-vf&quot;</span>, <span class="string">f&quot;select=&#x27;gt(scene,<span class="subst">&#123;threshold&#125;</span>)&#x27;,showinfo&quot;</span>,</span><br><span class="line">        <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;null&quot;</span>,</span><br><span class="line">        <span class="string">&quot;-&quot;</span></span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    process = subprocess.Popen(command, stderr=subprocess.PIPE, text=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    timestamps = []</span><br><span class="line">    <span class="comment"># æ­£åˆ™è¡¨è¾¾å¼ä¸“é—¨åŒ¹é… showinfo è¾“å‡ºçš„ pts_time</span></span><br><span class="line">    regex = <span class="string">r&quot;\[Parsed_showinfo.*\] .* pts_time:([0-9]+\.?[0-9]*)&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> process.stderr:</span><br><span class="line">        <span class="keyword">match</span> = re.search(regex, line)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">            timestamps.append(<span class="built_in">float</span>(<span class="keyword">match</span>.group(<span class="number">1</span>)))</span><br><span class="line">            </span><br><span class="line">    process.wait()</span><br><span class="line">    <span class="keyword">if</span> process.returncode != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;FFmpeg command failed.&quot;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> timestamps</span><br></pre></td></tr></table></figure><h2 id="3-æµ‹è¯•ä¸éªŒè¯æ–¹æ³•-Testing-Validation"><strong>3. æµ‹è¯•ä¸éªŒè¯æ–¹æ³• (Testing &amp; Validation)</strong></h2><p>è¦éªŒè¯ FFmpeg åœºæ™¯æ£€æµ‹çš„å‡†ç¡®æ€§ï¼Œéœ€è¦ç³»ç»Ÿæ€§çš„æµ‹è¯•æ–¹æ³•ã€‚</p><ol><li><p><strong>æ„å»ºæµ‹è¯•é›† (Test Dataset Construction)</strong>:</p><ul><li><strong>æ­£æ ·æœ¬</strong>: åŒ…å«å¤šç§ç±»å‹åœºæ™¯åˆ‡æ¢çš„è§†é¢‘ã€‚<ul><li><strong>ç¡¬åˆ‡ (Hard Cuts)</strong>: ç¬é—´åˆ‡æ¢ï¼ŒFFmpeg æ£€æµ‹æ•ˆæœæœ€å¥½ã€‚</li><li><strong>æ·¡å…¥æ·¡å‡º (Fades)</strong>: é€æ¸å˜é»‘æˆ–ä»é»‘å±å‡ºç°ã€‚</li><li><strong>å åŒ– (Dissolves)</strong>: ä¸¤ä¸ªåœºæ™¯å¹³æ»‘è¿‡æ¸¡ã€‚</li><li><strong>å¿«é€Ÿè¿åŠ¨/é—ªå…‰</strong>: å®¹æ˜“äº§ç”Ÿè¯¯æŠ¥çš„åœºæ™¯ï¼Œå¦‚çˆ†ç‚¸ã€ç›¸æœºå¿«é€Ÿæ‘‡æ™ƒã€é—ªå…‰ç¯ã€‚</li></ul></li><li><strong>è´Ÿæ ·æœ¬</strong>: é•¿é•œå¤´ã€æ— æ˜æ˜¾åˆ‡æ¢çš„è§†é¢‘ï¼Œç”¨äºæµ‹è¯•æ˜¯å¦ä¼šäº§ç”Ÿè¯¯æŠ¥ã€‚</li></ul></li><li><p><strong>äººå·¥æ ‡æ³¨ (Ground Truth Annotation)</strong>:</p><ul><li>ä½¿ç”¨è§†é¢‘ç¼–è¾‘è½¯ä»¶ï¼ˆå¦‚ Adobe Premiere, Final Cut Proï¼‰æ‰‹åŠ¨è®°å½•æµ‹è¯•é›†ä¸­æ‰€æœ‰åœºæ™¯åˆ‡æ¢çš„ç²¾ç¡®æ—¶é—´æˆ³ï¼Œä½œä¸ºâ€œé»„é‡‘æ ‡å‡†â€æˆ–â€œåŸºå‡†çœŸç›¸â€ï¼ˆGround Truthï¼‰ã€‚</li></ul></li><li><p><strong>é‡åŒ–è¯„ä¼°æŒ‡æ ‡ (Quantitative Metrics)</strong>:</p><ul><li>å°† FFmpeg æ£€æµ‹å‡ºçš„æ—¶é—´æˆ³ä¸äººå·¥æ ‡æ³¨çš„æ—¶é—´æˆ³è¿›è¡Œæ¯”å¯¹ï¼ˆå…è®¸ä¸€ä¸ªå°çš„å®¹å¿çª—å£ï¼Œå¦‚ Â±0.5ç§’ï¼‰ã€‚</li><li>è®¡ç®—ä»¥ä¸‹æŒ‡æ ‡ï¼š<ul><li><strong>ç²¾ç¡®ç‡ (Precision)</strong>: <code>TP / (TP + FP)</code>ï¼Œæ£€æµ‹å‡ºçš„è½¬åœºä¸­æœ‰å¤šå°‘æ˜¯æ­£ç¡®çš„ã€‚</li><li><strong>å¬å›ç‡ (Recall)</strong>: <code>TP / (TP + FN)</code>ï¼Œæ‰€æœ‰çœŸå®è½¬åœºä¸­ï¼Œæœ‰å¤šå°‘è¢«æˆåŠŸæ£€æµ‹å‡ºæ¥äº†ã€‚</li><li><strong>F1-Score</strong>: <code>2 * (Precision * Recall) / (Precision + Recall)</code>ï¼Œç²¾ç¡®ç‡å’Œå¬å›ç‡çš„è°ƒå’Œå¹³å‡å€¼ï¼Œæ˜¯ç»¼åˆè¯„ä¼°æ€§èƒ½çš„å¸¸ç”¨æŒ‡æ ‡ã€‚</li><li><code>TP</code> (True Positives): æ­£ç¡®æ£€æµ‹åˆ°çš„è½¬åœºã€‚</li><li><code>FP</code> (False Positives): è¯¯æŠ¥çš„è½¬åœºã€‚</li><li><code>FN</code> (False Negatives): æ¼æ‰çš„è½¬åœºã€‚</li></ul></li></ul></li><li><p><strong>é˜ˆå€¼è°ƒä¼˜</strong>:</p><ul><li>é€šè¿‡åœ¨æµ‹è¯•é›†ä¸Šè¿è¡Œä¸åŒé˜ˆå€¼ï¼ˆä¾‹å¦‚ä» 0.2 åˆ° 0.7ï¼‰ï¼Œç»˜åˆ¶ Precision-Recall æ›²çº¿ï¼Œæ‰¾åˆ°åœ¨ç‰¹å®šåº”ç”¨åœºæ™¯ä¸‹ F1-Score æœ€é«˜çš„æœ€ä½³é˜ˆå€¼ã€‚</li></ul></li></ol><h2 id="4-ä¼˜ç¼ºç‚¹åˆ†æ-Pros-and-Cons"><strong>4. ä¼˜ç¼ºç‚¹åˆ†æ (Pros and Cons)</strong></h2><p><strong>ä¼˜ç‚¹ (Pros)</strong>:</p><ul><li><strong>æ€§èƒ½å“è¶Š</strong>: ä½œä¸ºCè¯­è¨€ç¼–å†™çš„é«˜åº¦ä¼˜åŒ–çš„ç¨‹åºï¼ŒFFmpeg çš„å¤„ç†é€Ÿåº¦æå¿«ï¼Œè¿œè¶…è®¸å¤šé«˜çº§è¯­è¨€å®ç°çš„åº“ã€‚</li><li><strong>èµ„æºå ç”¨ä½</strong>: å†…å­˜å’ŒCPUå ç”¨éƒ½å¾ˆå°ï¼Œéå¸¸é€‚åˆåœ¨èµ„æºå—é™çš„ç¯å¢ƒæˆ–å¤§è§„æ¨¡æœåŠ¡å™¨é›†ç¾¤ä¸Šè¿è¡Œã€‚</li><li><strong>éƒ¨ç½²ç®€å•</strong>: æ— éœ€å¤æ‚çš„ä¾èµ–å®‰è£…ï¼Œä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶å³å¯æå®šã€‚</li><li><strong>é«˜åº¦å¯å®šåˆ¶ä¸é›†æˆ</strong>: å¯ä»¥é€šè¿‡è°ƒæ•´é˜ˆå€¼æ¥æ§åˆ¶çµæ•åº¦ï¼Œå¹¶ä¸”èƒ½ä¸ FFmpeg å…¶ä»–ä¸Šç™¾ç§æ»¤é•œå’ŒåŠŸèƒ½ï¼ˆå¦‚åˆ‡ç‰‡ã€è½¬ç ã€æˆªå›¾ï¼‰åœ¨åŒä¸€ä¸ªå‘½ä»¤ä¸­æ— ç¼é›†æˆï¼Œå½¢æˆå¼ºå¤§çš„å¤„ç†æµæ°´çº¿ã€‚</li><li><strong>å…è´¹ä¸å¼€æº</strong>: æ— ä»»ä½•å•†ä¸šæˆæœ¬ï¼Œç¤¾åŒºæ´»è·ƒï¼Œæ–‡æ¡£ä¸°å¯Œã€‚</li></ul><p><strong>ç¼ºç‚¹ (Cons)</strong>:</p><ul><li><strong>ä»…åŸºäºåƒç´ ï¼Œä¸ç†è§£å†…å®¹</strong>: è¿™æ˜¯å…¶æ ¸å¿ƒå±€é™ã€‚FFmpeg æ— æ³•ç†è§£è§†é¢‘çš„è¯­ä¹‰ã€‚<ul><li><strong>å¯¹æ¸å˜è½¬åœºä¸æ•æ„Ÿ</strong>: å¯¹äºæ·¡å…¥æ·¡å‡ºã€å åŒ–ç­‰ç¼“æ…¢å˜åŒ–çš„è½¬åœºï¼Œç”±äºè¿ç»­å¸§å·®å¼‚å°ï¼Œå¾ˆå®¹æ˜“è¢«æ¼æ£€ (False Negatives)ã€‚</li><li><strong>å¯¹å‰§çƒˆè¿åŠ¨æ•æ„Ÿ</strong>: å¿«é€Ÿçš„é•œå¤´ç§»åŠ¨ã€çˆ†ç‚¸ã€é—ªå…‰ç¯ç­‰éåœºæ™¯åˆ‡æ¢çš„å‰§çƒˆè§†è§‰å˜åŒ–ï¼Œå¾ˆå®¹æ˜“è¢«è¯¯æŠ¥ (False Positives)ã€‚</li><li><strong>æ— æ³•è¯†åˆ«è½¬åœºç±»å‹</strong>: å®ƒåªèƒ½å‘Šè¯‰ä½ â€œè¿™é‡Œå‘ç”Ÿäº†å˜åŒ–â€ï¼Œä½†æ— æ³•åŒºåˆ†æ˜¯ç¡¬åˆ‡è¿˜æ˜¯å…¶ä»–ç‰¹æ•ˆã€‚</li></ul></li><li><strong>é˜ˆå€¼ä¾èµ–æ€§å¼º</strong>: æ•ˆæœå¥½åä¸¥é‡ä¾èµ–äºé˜ˆå€¼çš„è®¾å®šï¼Œè€Œâ€œæœ€ä½³é˜ˆå€¼â€å¯¹äºä¸åŒç±»å‹ï¼ˆå¦‚åŠ¨ç”»ã€ç”µå½±ã€Vlogï¼‰çš„è§†é¢‘å¯èƒ½å®Œå…¨ä¸åŒï¼Œéœ€è¦ç»éªŒæˆ–å®éªŒæ¥ç¡®å®šã€‚</li><li><strong>éœ€è¦å¤–éƒ¨è°ƒç”¨ä¸è§£æ</strong>: å®ƒä¸æ˜¯ä¸€ä¸ªåŸç”Ÿåº“ï¼Œåœ¨ Python ç­‰è¯­è¨€ä¸­ä½¿ç”¨æ—¶ï¼Œå¿…é¡»é€šè¿‡å­è¿›ç¨‹è°ƒç”¨ï¼Œå¹¶ç¼–å†™æ­£åˆ™è¡¨è¾¾å¼ç­‰ä»£ç æ¥è§£æå…¶æ–‡æœ¬è¾“å‡ºï¼Œå¢åŠ äº†é›†æˆçš„å¤æ‚æ€§ã€‚</li></ul><h2 id="5-æ•ˆç‡è¯„ä¼°-Efficiency-Evaluation"><strong>5. æ•ˆç‡è¯„ä¼° (Efficiency Evaluation)</strong></h2><p>FFmpeg çš„æ•ˆç‡æ˜¯å…¶æœ€æ˜¾è‘—çš„ä¼˜åŠ¿ä¹‹ä¸€ã€‚</p><ul><li><strong>å¤„ç†é€Ÿåº¦</strong>: åœ¨ç°ä»£å¤šæ ¸ CPU ä¸Šï¼Œå¤„ç†ä¸€ä¸ª 1080p çš„è§†é¢‘æ–‡ä»¶ï¼Œå…¶é€Ÿåº¦é€šå¸¸å¯ä»¥è¾¾åˆ°å®æ—¶é€Ÿåº¦çš„æ•°å€ç”šè‡³æ•°åå€ï¼ˆä¾‹å¦‚ï¼Œå¤„ç†1å°æ—¶çš„è§†é¢‘å¯èƒ½åªéœ€è¦å‡ åˆ†é’Ÿï¼‰ã€‚ç”±äºå…¶ä¸»è¦è¿›è¡Œæ•°å­¦è®¡ç®—ï¼Œæ€§èƒ½ç“¶é¢ˆé€šå¸¸åœ¨äºç£ç›˜ I/O æˆ– CPU å•æ ¸æ€§èƒ½ã€‚</li><li><strong>ä¸ PySceneDetect çš„å¯¹æ¯”</strong>:<ul><li><code>PySceneDetect</code> (ä½¿ç”¨ OpenCV åç«¯) åŒæ ·é«˜æ•ˆï¼Œä½†é€šå¸¸ä¼šæ¯” FFmpeg ç¨æ…¢ï¼Œå› ä¸ºå®ƒæœ‰ Python å±‚çš„å¼€é”€ã€‚</li><li>å½“ <code>PySceneDetect</code> ä½¿ç”¨æ›´å¤æ‚çš„æ£€æµ‹å™¨ï¼ˆå¦‚ <code>ThresholdDetector</code>ï¼Œæ£€æµ‹é»‘åœº/ç™½åœºï¼‰æ—¶ï¼Œå…¶å¼€é”€ä¼šè¿›ä¸€æ­¥å¢åŠ ã€‚</li><li>FFmpeg çš„ä¼˜åŠ¿åœ¨äºå…¶çº¯ C å®ç°å’Œæç®€çš„è®¡ç®—é€»è¾‘ï¼Œä½¿å…¶åœ¨åŸå§‹é€Ÿåº¦ä¸Šé€šå¸¸ä¿æŒé¢†å…ˆã€‚</li></ul></li><li><strong>å†…å­˜ä½¿ç”¨</strong>: FFmpeg é‡‡ç”¨æµå¼å¤„ç†ï¼ˆstreamingï¼‰ï¼Œä¸€æ¬¡åªåœ¨å†…å­˜ä¸­ä¿ç•™å°‘é‡å¸§è¿›è¡Œè®¡ç®—ï¼Œå› æ­¤å†…å­˜å ç”¨éå¸¸ç¨³å®šä¸”ä½ä¸‹ï¼Œå³ä¾¿æ˜¯å¤„ç†æ•°å°æ—¶çš„é•¿è§†é¢‘ä¹Ÿä¸ä¼šè€—å°½å†…å­˜ã€‚</li></ul><p><strong>ä¼˜åŒ–å»ºè®®</strong>: è™½ç„¶ FFmpeg å·²ç»å¾ˆå¿«ï¼Œä½†å¯¹äºè¶…é«˜åˆ†è¾¨ç‡è§†é¢‘ï¼ˆå¦‚ 4K, 8Kï¼‰ï¼Œå¯ä»¥é€šè¿‡åœ¨æ»¤é•œé“¾ä¸­åŠ å…¥ <code>scale</code> æ»¤é•œè¿›è¡Œ<strong>é™é‡‡æ ·</strong>æ¥è¿›ä¸€æ­¥æé€Ÿï¼Œä¾‹å¦‚ <code>scale=640:-1</code>ï¼Œè¿™é€šå¸¸ä¸ä¼šå½±å“ç¡¬åˆ‡æ£€æµ‹çš„å‡†ç¡®æ€§ã€‚</p><h2 id="6-æ¡ˆä¾‹">6. æ¡ˆä¾‹</h2><ul><li>code</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span>, <span class="type">Any</span>, <span class="type">Tuple</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- 1. Setup Logging ---</span></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setup_logging</span>(<span class="params">log_file: <span class="built_in">str</span> = <span class="string">&quot;analysis.log&quot;</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Configures logging to file and console.&quot;&quot;&quot;</span></span><br><span class="line">    logging.basicConfig(</span><br><span class="line">        level=logging.INFO,</span><br><span class="line">        <span class="built_in">format</span>=<span class="string">&quot;%(asctime)s [%(levelname)s] - %(message)s&quot;</span>,</span><br><span class="line">        handlers=[</span><br><span class="line">            logging.FileHandler(log_file, mode=<span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>),</span><br><span class="line">            logging.StreamHandler()  <span class="comment"># Also print to console</span></span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">analyze_video_transitions</span>(<span class="params"></span></span><br><span class="line"><span class="params">        video_path: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">        ffmpeg_path: <span class="built_in">str</span> = <span class="string">&quot;ffmpeg&quot;</span>,</span></span><br><span class="line"><span class="params">        threshold: <span class="built_in">float</span> = <span class="number">0.4</span></span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="type">Tuple</span>[<span class="type">List</span>[<span class="built_in">float</span>], <span class="built_in">str</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Analyzes a video file for scene transitions using ffmpeg.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    This function uses the &#x27;select&#x27; and &#x27;showinfo&#x27; filters in ffmpeg, which is a</span></span><br><span class="line"><span class="string">    more robust method than parsing the output of &#x27;scdet&#x27; alone. It identifies</span></span><br><span class="line"><span class="string">    frames where the scene change score exceeds a given threshold.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        video_path: The absolute or relative path to the video file.</span></span><br><span class="line"><span class="string">        ffmpeg_path: The path to the ffmpeg executable. Defaults to &#x27;ffmpeg&#x27;.</span></span><br><span class="line"><span class="string">        threshold: The sensitivity for scene detection, from 0.0 to 1.0.</span></span><br><span class="line"><span class="string">                   Lower values detect more transitions. A common default is 0.4.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        A tuple containing:</span></span><br><span class="line"><span class="string">        - A sorted list of timestamps (in seconds) where transitions were detected.</span></span><br><span class="line"><span class="string">        - The complete, raw stderr output from the ffmpeg command for debugging.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Raises:</span></span><br><span class="line"><span class="string">        FileNotFoundError: If the ffmpeg executable is not found at ffmpeg_path.</span></span><br><span class="line"><span class="string">        FFmpegError: If ffmpeg returns a non-zero exit code, indicating an error</span></span><br><span class="line"><span class="string">                     (e.g., invalid video file, incorrect parameters).</span></span><br><span class="line"><span class="string">        ValueError: If the provided video_path does not exist.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># It&#x27;s good practice to check for file existence early</span></span><br><span class="line">    <span class="keyword">import</span> os</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(video_path):</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Video file not found at: <span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># This command is more robust:</span></span><br><span class="line">    <span class="comment"># - `select=&#x27;gt(scene,&#123;threshold&#125;)&#x27;`: Selects frames where the scene change</span></span><br><span class="line">    <span class="comment">#   score is greater than the threshold.</span></span><br><span class="line">    <span class="comment"># - `showinfo`: Prints information about the selected frames to stderr.</span></span><br><span class="line">    <span class="comment"># The output is structured and easy to parse.</span></span><br><span class="line">    command = [</span><br><span class="line">        ffmpeg_path,</span><br><span class="line">        <span class="string">&quot;-i&quot;</span>, video_path,</span><br><span class="line">        <span class="string">&quot;-vf&quot;</span>, <span class="string">f&quot;select=&#x27;gt(scene,<span class="subst">&#123;threshold&#125;</span>)&#x27;,showinfo&quot;</span>,</span><br><span class="line">        <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;null&quot;</span>,</span><br><span class="line">        <span class="string">&quot;-&quot;</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        process = subprocess.Popen(</span><br><span class="line">            command,</span><br><span class="line">            stdout=subprocess.PIPE,</span><br><span class="line">            stderr=subprocess.PIPE,</span><br><span class="line">            text=<span class="literal">True</span>,</span><br><span class="line">            encoding=<span class="string">&#x27;utf-8&#x27;</span>,</span><br><span class="line">            errors=<span class="string">&#x27;replace&#x27;</span></span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        <span class="keyword">raise</span> FileNotFoundError(</span><br><span class="line">            <span class="string">f&quot;ffmpeg executable not found at &#x27;<span class="subst">&#123;ffmpeg_path&#125;</span>&#x27;. &quot;</span></span><br><span class="line">            <span class="string">&quot;Please install ffmpeg or provide the correct path.&quot;</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Process stderr line-by-line for memory efficiency</span></span><br><span class="line">    timestamps = []</span><br><span class="line">    <span class="comment"># The regex now specifically looks for &#x27;pts_time&#x27; from the showinfo filter</span></span><br><span class="line">    regex = <span class="string">r&quot;\[Parsed_showinfo.*\] .* pts_time:([0-9]+\.?[0-9]*)&quot;</span></span><br><span class="line"></span><br><span class="line">    stderr_lines = []</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> process.stderr:</span><br><span class="line">        stderr_lines.append(line)</span><br><span class="line">        <span class="keyword">match</span> = re.search(regex, line)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">            time_str = <span class="keyword">match</span>.group(<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> time_str:</span><br><span class="line">                timestamps.append(<span class="built_in">float</span>(time_str))</span><br><span class="line"></span><br><span class="line">    process.wait()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Check for ffmpeg errors after processing is complete</span></span><br><span class="line">    <span class="keyword">if</span> process.returncode != <span class="number">0</span>:</span><br><span class="line">        full_stderr = <span class="string">&quot;&quot;</span>.join(stderr_lines)</span><br><span class="line">        <span class="comment"># raise FFmpegError(</span></span><br><span class="line">        <span class="comment">#     f&quot;ffmpeg failed with exit code &#123;process.returncode&#125;.\n&quot;</span></span><br><span class="line">        <span class="comment">#     f&quot;Command: &#123;&#x27; &#x27;.join(command)&#125;\n&quot;</span></span><br><span class="line">        <span class="comment">#     f&quot;Stderr:\n&#123;full_stderr&#125;&quot;</span></span><br><span class="line">        <span class="comment"># )</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Timestamps from showinfo should already be in order, but sorting is safe</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sorted</span>(timestamps), <span class="string">&quot;&quot;</span>.join(stderr_lines)</span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Main function to run the analysis script.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- Configuration ---</span></span><br><span class="line">    <span class="comment"># 1. Setup logging first</span></span><br><span class="line">    log_file = <span class="string">&quot;./logs/transition_analysis.log&quot;</span></span><br><span class="line">    os.makedirs(log_file, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    setup_logging(log_file)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. Get user input for video directory</span></span><br><span class="line">    video_directory = <span class="string">&quot;/Volumes/share/æ–°å»ºæ–‡ä»¶å¤¹/7ï¼Œ1æ•°æ®&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. Output JSON file path</span></span><br><span class="line">    output_json_path = <span class="string">&quot;./data/transition_analysis_results.json&quot;</span></span><br><span class="line"></span><br><span class="line">    os.makedirs(<span class="string">&quot;./data&quot;</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4. (Optional) FFmpeg executable path</span></span><br><span class="line">    ffmpeg_executable = <span class="string">&quot;ffmpeg&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 5. Supported video file extensions</span></span><br><span class="line">    supported_extensions = &#123;<span class="string">&quot;.mp4&quot;</span>, <span class="string">&quot;.mkv&quot;</span>, <span class="string">&quot;.mov&quot;</span>, <span class="string">&quot;.avi&quot;</span>, <span class="string">&quot;.webm&quot;</span>, <span class="string">&quot;.flv&quot;</span>&#125;</span><br><span class="line">    <span class="comment"># --- End of Configuration ---</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(video_directory):</span><br><span class="line">        logging.error(<span class="string">f&quot;Directory not found at &#x27;<span class="subst">&#123;video_directory&#125;</span>&#x27;. Aborting.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    all_results: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    logging.info(<span class="string">&quot;Starting video transition analysis...&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 2. Find all video files first to set up the progress bar ---</span></span><br><span class="line">    video_files_to_process = []</span><br><span class="line">    <span class="keyword">for</span> filename <span class="keyword">in</span> os.listdir(video_directory):</span><br><span class="line">        file_path = os.path.join(video_directory, filename)</span><br><span class="line">        <span class="keyword">if</span> os.path.isfile(file_path) <span class="keyword">and</span> Path(filename).suffix.lower() <span class="keyword">in</span> supported_extensions:</span><br><span class="line">            video_files_to_process.append(file_path)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> video_files_to_process:</span><br><span class="line">        logging.warning(<span class="string">&quot;No video files found in the specified directory.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 3. Process files with a tqdm progress bar ---</span></span><br><span class="line">    <span class="keyword">with</span> tqdm(total=<span class="built_in">len</span>(video_files_to_process), desc=<span class="string">&quot;Analyzing Videos&quot;</span>) <span class="keyword">as</span> pbar:</span><br><span class="line">        <span class="keyword">for</span> video_path <span class="keyword">in</span> video_files_to_process:</span><br><span class="line">            filename = os.path.basename(video_path)</span><br><span class="line">            pbar.set_description(<span class="string">f&quot;Processing <span class="subst">&#123;filename[:<span class="number">20</span>]&#125;</span>...&quot;</span>)  <span class="comment"># Update progress bar description</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                transition_times, ffmpeg_log = analyze_video_transitions(video_path, ffmpeg_executable)</span><br><span class="line"></span><br><span class="line">                logging.info(<span class="string">f&quot;Successfully analyzed &#x27;<span class="subst">&#123;filename&#125;</span>&#x27;. Found <span class="subst">&#123;<span class="built_in">len</span>(transition_times)&#125;</span> transitions.&quot;</span>)</span><br><span class="line">                all_results[filename] = &#123;</span><br><span class="line">                    <span class="string">&quot;file_path&quot;</span>: video_path,</span><br><span class="line">                    <span class="string">&quot;transitions&quot;</span>: transition_times,</span><br><span class="line">                    <span class="string">&quot;transition_count&quot;</span>: <span class="built_in">len</span>(transition_times)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logging.error(<span class="string">f&quot;Failed to analyze &#x27;<span class="subst">&#123;filename&#125;</span>&#x27;: <span class="subst">&#123;e&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">                <span class="comment"># Also log the full ffmpeg output for debugging</span></span><br><span class="line">                logging.debug(<span class="string">f&quot;FFmpeg stderr for failed file &#x27;<span class="subst">&#123;filename&#125;</span>&#x27;:\n<span class="subst">&#123;ffmpeg_log&#125;</span>&quot;</span>)</span><br><span class="line">                all_results[filename] = &#123;</span><br><span class="line">                    <span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            pbar.update(<span class="number">1</span>)  <span class="comment"># Move progress bar forward by one step</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Save the results to a JSON file</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(output_json_path, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            json.dump(all_results, f, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        logging.info(<span class="string">f&quot;Analysis complete. Results saved to &#x27;<span class="subst">&#123;output_json_path&#125;</span>&#x27;&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;Error saving results to JSON file: <span class="subst">&#123;e&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><ul><li>output</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> </span><br><span class="line">    <span class="attr">&quot;6æœˆ27æ—¥ (1)-71.mp4&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;file_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/Volumes/share/æ–°å»ºæ–‡ä»¶å¤¹/7ï¼Œ1æ•°æ®/6æœˆ27æ—¥ (1)-71.mp4&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;transitions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="number">4.0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">7.666667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">11.766667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">16.566667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">22.866667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">27.066667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">29.266667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">34.766667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">36.966667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">49.566667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">57.066667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">61.766667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">63.5</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">69.866667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">74.8</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">79.466667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">81.266667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">84.066667</span><span class="punctuation">,</span></span><br><span class="line">            <span class="number">88.266667</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;transition_count&quot;</span><span class="punctuation">:</span> <span class="number">19</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>log</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2025-07-02 17:50:43,359 [INFO] - Successfully analyzed &#x27;._6æœˆ27æ—¥ (1)-36.mp4&#x27;. Found 0 transitions.</span><br><span class="line">2025-07-02 17:50:55,619 [INFO] - Successfully analyzed &#x27;6æœˆ27æ—¥ (1)-71.mp4&#x27;. Found 19 transitions.</span><br><span class="line">2025-07-02 17:50:55,620 [INFO] - Analysis complete. Results saved to &#x27;transition_analysis_results.json&#x27;</span><br></pre></td></tr></table></figure><h2 id="ç»“è®º"><strong>ç»“è®º</strong></h2><h3 id="æ£€å‡ºæ•ˆæœå¯¹æ¯”">æ£€å‡ºæ•ˆæœå¯¹æ¯”</h3><table><thead><tr><th style="text-align:left">å¯¹æ¯”é¡¹</th><th style="text-align:left"><strong>æ–¹æ³•ä¸€: PySceneDetect (pyscenedetect_analysis.py)</strong></th><th style="text-align:left"><strong>æ–¹æ³•äºŒ: FFmpeg (transition_analysis.py)</strong></th></tr></thead><tbody><tr><td style="text-align:left"><strong>æ ¸å¿ƒæŠ€æœ¯</strong></td><td style="text-align:left">ä½¿ç”¨ä¸“ä¸šçš„Pythonåœºæ™¯æ£€æµ‹åº“ <code>scenedetect</code>ã€‚é€šè¿‡ <code>ContentDetector</code> ç®—æ³•ï¼Œæ¯”è¾ƒè¿ç»­å¸§åœ¨äº®åº¦ï¼ˆlumaï¼‰å’Œè‰²åº¦ï¼ˆchromaï¼‰ä¸Šçš„å˜åŒ–æ¥è¯†åˆ«åœºæ™¯åˆ‡æ¢ã€‚</td><td style="text-align:left">è°ƒç”¨å¤–éƒ¨å‘½ä»¤è¡Œå·¥å…· FFmpegï¼Œå¹¶ä½¿ç”¨å…¶å†…ç½®çš„ <code>select</code> å’Œ <code>showinfo</code> æ»¤é•œç»„åˆã€‚è¯¥æ–¹æ³•åŸºäºä¸€ä¸ªç®€å•çš„â€œåœºæ™¯å˜åŒ–åˆ†æ•°â€ï¼ˆscene scoreï¼‰è¿›è¡Œé˜ˆå€¼åˆ¤æ–­ã€‚</td></tr><tr><td style="text-align:left"><strong>æ£€æµ‹çµæ•åº¦ä¸å‡†ç¡®æ€§</strong></td><td style="text-align:left"><strong>é«˜</strong>ã€‚æ­¤æ–¹æ³•éå¸¸çµæ•ï¼Œèƒ½ç¨³å®šåœ°è¯†åˆ«å‡ºå¤§é‡çš„æœ‰æ•ˆåœºæ™¯åˆ‡æ¢ç‚¹ã€‚å…¶ç®—æ³•å¯¹ç¡¬åˆ‡ï¼ˆHard Cutsï¼‰çš„è¯†åˆ«å‡†ç¡®ç‡å¾ˆé«˜ã€‚</td><td style="text-align:left"><strong>ä¾èµ–é˜ˆå€¼ï¼Œé»˜è®¤è¾ƒä½</strong>ã€‚åœ¨ <code>threshold=0.4</code> çš„è®¾ç½®ä¸‹ï¼Œçµæ•åº¦å¯èƒ½ä¸è¶³ï¼Œå¯¼è‡´å¤§é‡æ˜æ˜¾çš„é•œå¤´åˆ‡æ¢è¢«æ¼æ£€ã€‚éœ€è¦é’ˆå¯¹è§†é¢‘å†…å®¹è¿›è¡Œç»†è‡´çš„é˜ˆå€¼è°ƒä¼˜æ‰èƒ½è¾¾åˆ°ç†æƒ³æ•ˆæœã€‚</td></tr><tr><td style="text-align:left"><strong>ç»“æœå¯¹æ¯” (ç¤ºä¾‹)</strong></td><td style="text-align:left"><code>6æœˆ27æ—¥ (1)-47.mp4</code>: æ£€å‡º <strong>46</strong> ä¸ª<br><code>6æœˆ27æ—¥ (1)-49.mp4</code>: æ£€å‡º <strong>43</strong> ä¸ª<br><code>6.27(1)-64.mp4</code>: æ£€å‡º <strong>17</strong> ä¸ª</td><td style="text-align:left"><code>6æœˆ27æ—¥ (1)-47.mp4</code>: æ£€å‡º <strong>0</strong> ä¸ª<br><code>6æœˆ27æ—¥ (1)-49.mp4</code>: æ£€å‡º <strong>33</strong> ä¸ª<br><code>6.27(1)-64.mp4</code>: æ£€å‡º <strong>4</strong> ä¸ª</td></tr><tr><td style="text-align:left"><strong>æ–‡ä»¶å¤„ç†å¥å£®æ€§</strong></td><td style="text-align:left"><strong>é«˜</strong>ã€‚è„šæœ¬ä¸­åŠ å…¥äº†æ˜ç¡®çš„é€»è¾‘ï¼Œèƒ½è‡ªåŠ¨è¯†åˆ«å¹¶è·³è¿‡ macOS ç³»ç»Ÿäº§ç”Ÿçš„æ— æ•ˆå…ƒæ•°æ®æ–‡ä»¶ï¼ˆå¦‚ <code>._filename.mp4</code>ï¼‰ï¼Œé¿å…äº†å› å¤„ç†æ— æ•ˆæ–‡ä»¶è€Œå¯¼è‡´çš„ç¨‹åºå´©æºƒæˆ–é”™è¯¯ã€‚</td><td style="text-align:left"><strong>ä¸­ç­‰</strong>ã€‚è„šæœ¬ä¼šå°è¯•å¤„ç† <code>._</code> å¼€å¤´çš„æ— æ•ˆæ–‡ä»¶ã€‚è™½ç„¶ FFmpeg æœ¬èº«é€šå¸¸ä¸ä¼šå› æ­¤å´©æºƒï¼ˆä¼šæŠ¥å‘Šé”™è¯¯å¹¶é€€å‡ºï¼‰ï¼Œä½†è¿™æµªè´¹äº†å¤„ç†æ—¶é—´ï¼Œå¹¶åœ¨æ—¥å¿—å’Œç»“æœæ–‡ä»¶ä¸­ç•™ä¸‹äº†æ— æ•ˆæ¡ç›®ã€‚</td></tr><tr><td style="text-align:left"><strong>æ€§èƒ½ä¸æ•ˆç‡</strong></td><td style="text-align:left"><strong>ä¸­ç­‰</strong>ã€‚å•ä¸ªæ–‡ä»¶å¤„ç†é€Ÿåº¦ç›¸å¯¹è¾ƒæ…¢ï¼Œå› å…¶åœ¨Pythonå±‚æœ‰ä¸€å®šå¼€é”€ã€‚ä½†é€šè¿‡è‡ªåŠ¨é™é‡‡æ ·ï¼ˆdownscalingï¼‰é«˜åˆ†è¾¨ç‡è§†é¢‘ï¼Œæ€§èƒ½å·²å¾—åˆ°æ˜¾è‘—ä¼˜åŒ–ï¼Œæœ€ç»ˆä»¥å¯æ¥å—çš„é€Ÿåº¦æ¢å–é«˜è´¨é‡çš„æ£€æµ‹ç»“æœã€‚</td><td style="text-align:left"><strong>éå¸¸é«˜</strong>ã€‚ä½œä¸ºCè¯­è¨€ç¼–å†™çš„åº•å±‚å·¥å…·ï¼Œå•ä¸ªæ–‡ä»¶å¤„ç†é€Ÿåº¦æå¿«ã€‚ä½†è¿™ç§é€Ÿåº¦ä¼˜åŠ¿å»ºç«‹åœ¨ç®—æ³•ç›¸å¯¹ç®€å•çš„åŸºç¡€ä¸Šï¼Œç‰ºç‰²äº†éƒ¨åˆ†å‡†ç¡®æ€§å’Œå¯¹å¤æ‚è½¬åœºçš„è¯†åˆ«èƒ½åŠ›ã€‚</td></tr><tr><td style="text-align:left"><strong>æ˜“ç”¨æ€§ä¸é›†æˆ</strong></td><td style="text-align:left"><strong>é«˜</strong>ã€‚ä½œä¸ºåŸç”ŸPythonåº“ï¼Œé›†æˆæ–¹ä¾¿ï¼Œæ— éœ€å¤„ç†å¤–éƒ¨è¿›ç¨‹å’Œè§£ææ–‡æœ¬è¾“å‡ºã€‚APIå‹å¥½ï¼Œè¿”å›ç›´æ¥å¯ç”¨çš„Pythonæ•°æ®ç»“æ„ï¼ˆå¦‚åˆ—è¡¨ï¼‰ã€‚</td><td style="text-align:left"><strong>ä¸­ç­‰</strong>ã€‚éœ€è¦é€šè¿‡ <code>subprocess</code> æ¨¡å—è°ƒç”¨ï¼Œå¹¶ç¼–å†™æ­£åˆ™è¡¨è¾¾å¼æ¥è§£æ <code>stderr</code> è¾“å‡ºï¼Œé›†æˆç›¸å¯¹å¤æ‚ï¼Œä¸”å®¹æ˜“å› FFmpegç‰ˆæœ¬æ›´æ–°å¯¼è‡´è§£æé€»è¾‘å¤±æ•ˆã€‚</td></tr><tr><td style="text-align:left"><strong>ä¾èµ–ä¸éƒ¨ç½²</strong></td><td style="text-align:left"><strong>ä¸­ç­‰</strong>ã€‚éœ€è¦é€šè¿‡ <code>pip</code> å®‰è£… <code>scenedetect</code> åŠå…¶ä¾èµ–ï¼ˆå¦‚ <code>opencv-python</code>ï¼‰ï¼Œç¯å¢ƒé…ç½®ç›¸å¯¹å¤æ‚ã€‚</td><td style="text-align:left"><strong>ç®€å•</strong>ã€‚ä»…ä¾èµ–äºä¸€ä¸ªå•ä¸€çš„ FFmpeg å¯æ‰§è¡Œæ–‡ä»¶ï¼Œéƒ¨ç½²å’Œåˆ†å‘éå¸¸æ–¹ä¾¿ã€‚</td></tr><tr><td style="text-align:left"><strong>æ¨èåœºæ™¯</strong></td><td style="text-align:left">é€‚ç”¨äºå¯¹<strong>æ£€æµ‹å‡†ç¡®æ€§è¦æ±‚é«˜</strong>ã€éœ€è¦ç¨³å®šå¯é ç»“æœçš„åº”ç”¨ã€‚æ˜¯æ„å»ºä¸“ä¸šè§†é¢‘åˆ†æå·¥å…·å’ŒæœåŠ¡çš„é¦–é€‰ã€‚</td><td style="text-align:left">é€‚ç”¨äºå¯¹<strong>å¤„ç†é€Ÿåº¦è¦æ±‚æé«˜</strong>ã€èµ„æºå—é™ï¼Œä¸”ä¸»è¦ä»»åŠ¡æ˜¯æ£€æµ‹ç¡¬åˆ‡ï¼ˆHard Cutsï¼‰çš„æ‰¹é‡è‡ªåŠ¨åŒ–æµç¨‹ã€‚</td></tr></tbody></table><h3 id="æ£€å‡ºæ•°ç›®å¯¹æ¯”">æ£€å‡ºæ•°ç›®å¯¹æ¯”</h3><table><thead><tr><th style="text-align:left">æ£€æµ‹æ–¹æ³•</th><th style="text-align:left">åˆ†æçš„è§†é¢‘æ€»æ•°</th><th style="text-align:left">æˆåŠŸæ£€å‡ºè½¬åœºçš„è§†é¢‘æ•°</th><th style="text-align:left">æ£€å‡ºç‡</th></tr></thead><tbody><tr><td style="text-align:left">æ–¹æ³•ä¸€: PySceneDetect</td><td style="text-align:left">48</td><td style="text-align:left">37</td><td style="text-align:left">77.1%</td></tr><tr><td style="text-align:left">æ–¹æ³•äºŒ: FFmpeg</td><td style="text-align:left">48</td><td style="text-align:left">19</td><td style="text-align:left">39.6%</td></tr></tbody></table><h3 id="æ€»ç»“">æ€»ç»“</h3><ul><li><p>PySceneDetect æ•ˆæœè¿œèƒœ FFmpegï¼šPySceneDetect æˆåŠŸåœ¨ 37 ä¸ªè§†é¢‘ä¸­æ‰¾åˆ°äº†è½¬åœºï¼Œè€Œ FFmpeg åªåœ¨å…¶ä¸­çš„ 19 ä¸ªè§†é¢‘ä¸­æ‰¾åˆ°äº†è½¬åœºã€‚PySceneDetect çš„â€œå‘½ä¸­ç‡â€å‡ ä¹æ˜¯ FFmpeg çš„ä¸¤å€ã€‚</p></li><li><p>FFmpeg æ¼æ£€ä¸¥é‡ï¼šä»æ•°æ®å¯ä»¥çœ‹å‡ºï¼ŒFFmpeg çš„æ–¹æ³•æ¼æ‰äº†å¤§é‡æœ‰è½¬åœºçš„è§†é¢‘ã€‚ä¾‹å¦‚ï¼Œåœ¨ PySceneDetect æ£€å‡º 80 ä¸ªè½¬åœºçš„ 6æœˆ27æ—¥ (1)-7.mp4 è§†é¢‘ä¸­ï¼ŒFFmpeg çš„ç»“æœä¸º 0ã€‚è¿™ç§å·¨å¤§çš„å·®å¼‚è¡¨æ˜ FFmpeg çš„ scdet æ»¤é•œåœ¨å½“å‰å‚æ•°ä¸‹è¿‡äºè¿Ÿé’ï¼Œä¸é€‚åˆç”¨äºç²¾ç¡®çš„åœºæ™¯åˆ‡åˆ†ã€‚</p></li></ul><blockquote><p>FFmpeg æ˜¯ä¸€ç§ç”¨äºè§†é¢‘åœºæ™¯æ£€æµ‹çš„â€œå¿«ã€å‡†ï¼ˆå¯¹ç¡¬åˆ‡è€Œè¨€ï¼‰ã€ç‹ â€çš„å·¥å…·**ã€‚å®ƒéå¸¸é€‚åˆäºéœ€è¦<strong>å¤§è§„æ¨¡ã€è‡ªåŠ¨åŒ–ã€å¿«é€Ÿå¤„ç†</strong>è§†é¢‘ï¼Œä¸”ä¸»è¦ç›®æ ‡æ˜¯æ£€æµ‹<strong>ç¡¬åˆ‡</strong>çš„åœºæ™¯ã€‚å®ƒçš„é«˜æ€§èƒ½ã€ä½èµ„æºå ç”¨å’Œå¼ºå¤§çš„é›†æˆèƒ½åŠ›ä½¿å…¶åœ¨åç«¯æœåŠ¡å’Œæ•°æ®é¢„å¤„ç†æµç¨‹ä¸­å…·æœ‰ä¸å¯æ›¿ä»£çš„ä»·å€¼ã€‚</p></blockquote><h2 id="See">See</h2><ul><li><a href="https://ffmpeg.org/ffmpeg-bitstream-filters.html">https://ffmpeg.org/ffmpeg-bitstream-filters.html</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;åœ¨è§†é¢‘å¤„ç†é¢†åŸŸï¼Œåœºæ™¯æ£€æµ‹ï¼ˆScene Detectionï¼‰æˆ–ç§°é•œå¤´åˆ†å‰²ï¼ˆShot Boundary Detectionï¼‰æ˜¯ä¸€é¡¹åŸºç¡€ä¸”å…³é”®çš„ä»»åŠ¡ï¼Œå¹¿æ³›åº”ç”¨äºè§†é¢‘ç´¢å¼•ã€è‡ªåŠ¨å‰ªè¾‘ã€å†…å®¹æ‘˜è¦ç­‰åœºæ™¯ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;1-</summary>
      
    
    
    
    
    <category term="python" scheme="https://caozhaoqi.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>TransNetV2æ¨¡å‹ç”¨äºè§†é¢‘å¤æ‚è½¬åœºæ£€æµ‹</title>
    <link href="https://caozhaoqi.github.io/2025/06/09/TransNetV2-model-use/"/>
    <id>https://caozhaoqi.github.io/2025/06/09/TransNetV2-model-use/</id>
    <published>2025-06-09T02:39:48.000Z</published>
    <updated>2025-11-25T15:05:10.067Z</updated>
    
    <content type="html"><![CDATA[<h2 id="TransNet-V2-æ¨¡å‹ä»‹ç»">TransNet V2 æ¨¡å‹ä»‹ç»</h2><ol><li>ç›®æ ‡ï¼š<br>TransNet V2 çš„ç›®æ ‡æ˜¯åˆ›å»ºä¸€ä¸ªå¿«é€Ÿä¸”å‡†ç¡®çš„é•œå¤´è¾¹ç•Œæ£€æµ‹ï¼ˆShot Boundary Detection, SBDï¼‰æ¨¡å‹ã€‚å®ƒèƒ½å¤Ÿè¯†åˆ«è§†é¢‘ä¸­çš„ä¸¤ç§ä¸»è¦ç±»å‹çš„é•œå¤´åˆ‡æ¢ï¼š<ul><li>ç¡¬åˆ‡ (Hard Cuts): ä¸¤ä¸ªé•œå¤´ä¹‹é—´çš„çªå˜ã€‚</li><li>æ¸å˜è½¬åœº (Gradual Transitions): å¦‚æº¶è§£ (dissolves)ã€æ·¡å…¥æ·¡å‡º (fades)ã€åˆ’åƒ (wipes) ç­‰ï¼Œè¿™äº›è½¬åœºä¼šæŒç»­æ•°å¸§ã€‚</li></ul></li></ol><ul><li>æ¨¡å‹æ¶æ„</li></ul><p><img src="/2025/06/09/TransNetV2-model-use/transnetv2_struct.png" class="lazyload placeholder" data-srcset="/2025/06/09/TransNetV2-model-use/transnetv2_struct.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ol start="2"><li><p>æ ¸å¿ƒæ€æƒ³ï¼š<br>TransNet V2 æ˜¯ä¸€ä¸ªæ·±åº¦ç¥ç»ç½‘ç»œã€‚å®ƒç›´æ¥å¤„ç†ä¸€ç³»åˆ—è¿ç»­çš„ã€ä½åˆ†è¾¨ç‡çš„ RGB è§†é¢‘å¸§ï¼Œæ¥é¢„æµ‹æ¯ä¸€å¸§å‘ç”Ÿé•œå¤´è½¬æ¢çš„æ¦‚ç‡ï¼Œå¹¶èƒ½åŒºåˆ†è½¬åœºç±»å‹ã€‚</p></li><li><p>å…³é”®æ¶æ„ç‰¹ç‚¹ï¼š</p><ul><li>è¾“å…¥ (Input)ï¼š<ul><li>æ¨¡å‹æ¥æ”¶ <code>N</code> ä¸ªè¿ç»­çš„ã€ä½åˆ†è¾¨ç‡ RGB è§†é¢‘å¸§ä½œä¸ºè¾“å…¥ï¼ˆä¾‹å¦‚ï¼Œè®ºæ–‡ä¸­å¸¸ä½¿ç”¨ <code>N=100</code> å¸§ï¼Œæ¯å¸§åˆ†è¾¨ç‡ç¼©å°åˆ° <code>48x27</code> åƒç´ ï¼‰ã€‚</li><li>ç›´æ¥ä½¿ç”¨åŸå§‹çš„ã€é™é‡‡æ ·åçš„ RGB å¸§ï¼ˆè€Œä¸æ˜¯é¢„å…ˆè®¡ç®—çš„ç‰¹å¾ï¼Œå¦‚å¸§å·®æˆ–å…‰æµï¼‰ä½¿å¾—ç½‘ç»œå¯ä»¥ç«¯åˆ°ç«¯åœ°å­¦ä¹ æœ€ä¼˜çš„è§†è§‰ç‰¹å¾ã€‚</li></ul></li><li>å¸§ç¼–ç  (Frame Encoding)ï¼š<ul><li>è¾“å…¥çš„æ¯ä¸€å¸§é¦–å…ˆä¼šç»è¿‡ä¸¤ä¸ª 2D å·ç§¯å±‚å’Œæœ€å¤§æ± åŒ–å±‚ï¼Œç”¨äºæå–ç©ºé—´ç‰¹å¾ã€‚</li><li>è¿™äº›ç‰¹å¾å›¾éšåè¢«å±•å¹³ (flatten) å¹¶æŒ‰æ—¶é—´é¡ºåºå †å èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªç‰¹å¾åºåˆ—ã€‚</li></ul></li><li>æ—¶é—´å»ºæ¨¡ (Temporal Modeling) - æ ¸å¿ƒéƒ¨åˆ†ï¼š<ul><li>TransNet V2 çš„æ ¸å¿ƒæ˜¯ä¸€å †ä¸€ç»´æ‰©å¼ å·ç§¯ (1D Dilated Convolutions) å—ï¼Œå®ƒä»¬ä½œç”¨äºå¸§ç‰¹å¾åºåˆ—ã€‚</li><li>ä¸€ç»´å·ç§¯ï¼š éå¸¸é€‚åˆå¤„ç†åºåˆ—æ•°æ®ï¼Œè®¡ç®—æ•ˆç‡é«˜ã€‚</li><li>æ‰©å¼ å·ç§¯ (Dilated Convolutions)ï¼š å…è®¸ç½‘ç»œåœ¨ä¸æ˜¾è‘—å¢åŠ å‚æ•°æ•°é‡æˆ–è®¡ç®—æˆæœ¬ï¼ˆé€šè¿‡é¿å…è¿‡å¤šçš„æ± åŒ–å±‚ï¼‰çš„æƒ…å†µä¸‹ï¼Œæ‹¥æœ‰éå¸¸å¤§çš„æ„Ÿå—é‡ï¼ˆå³èƒ½çœ‹åˆ°å¾ˆé•¿çš„æ—¶é—´ä¸Šä¸‹æ–‡ï¼‰ã€‚è¿™å¯¹äºæ£€æµ‹è·¨è¶Šå¤šå¸§çš„æ¸å˜è½¬åœºè‡³å…³é‡è¦ã€‚æ¯ä¸ªæ‰©å¼ å·ç§¯å—é€šå¸¸åŒ…å«ä¸€ä¸ªæ‰©å¼ ä¸€ç»´å·ç§¯å±‚ã€æ‰¹é‡å½’ä¸€åŒ– (Batch Normalization)ã€ReLU æ¿€æ´»å‡½æ•°å’Œ Dropoutã€‚</li></ul></li><li>åŒé¢„æµ‹å¤´ (Dual Prediction Heads)ï¼š<br>ç½‘ç»œä»æœ€åä¸€ä¸ªæ‰©å¼ å·ç§¯å±‚çš„è¾“å‡ºç‰¹å¾ä¸­å¼•å‡ºä¸¤ä¸ªåˆ†æ”¯ï¼ˆé¢„æµ‹å¤´ï¼‰ï¼š<ol><li>è½¬åœºæ¦‚ç‡é¢„æµ‹ (Transition Probability Prediction)ï¼š ä¸€ä¸ªæ ¸å¤§å°ä¸º 1 çš„ä¸€ç»´å·ç§¯å±‚ï¼Œåæ¥ Sigmoid æ¿€æ´»å‡½æ•°ã€‚å¯¹è¾“å…¥åºåˆ—ä¸­çš„æ¯ä¸€å¸§è¾“å‡ºä¸€ä¸ªæ¦‚ç‡å€¼ï¼ˆ0 åˆ° 1ï¼‰ï¼Œè¡¨ç¤ºè¯¥å¸§æ˜¯é•œå¤´è¾¹ç•Œï¼ˆç¡¬åˆ‡æˆ–æ¸å˜è½¬åœºçš„ä¸­å¿ƒï¼‰çš„å¯èƒ½æ€§ã€‚ä½¿ç”¨äºŒå…ƒäº¤å‰ç†µ (BCE) æŸå¤±è¿›è¡Œè®­ç»ƒã€‚</li><li>è½¬åœºç±»å‹é¢„æµ‹ (Transition Type Prediction - One-Hot)ï¼š å¦ä¸€ä¸ªæ ¸å¤§å°ä¸º 1 çš„ä¸€ç»´å·ç§¯å±‚ï¼Œæœ‰ 3 ä¸ªè¾“å‡ºé€šé“ï¼Œæ¯ä¸ªé€šé“åæ¥ Sigmoidã€‚å®ƒä»¬åˆ†åˆ«é¢„æµ‹æ¯ä¸€å¸§å±äºä»¥ä¸‹ç±»åˆ«çš„æ¦‚ç‡ï¼š<ul><li>æ— é•œå¤´è½¬åœº</li><li>ç¡¬åˆ‡</li><li>æ¸å˜è½¬åœºçš„ä¸­å¿ƒ<br>è¿™è¢«è§†ä¸ºä¸‰ä¸ªç‹¬ç«‹çš„äºŒåˆ†ç±»é—®é¢˜ï¼ŒåŒæ ·ä½¿ç”¨ BCE æŸå¤±è®­ç»ƒã€‚è¿™ä¸ªè¾…åŠ©ä»»åŠ¡æœ‰åŠ©äºç½‘ç»œå­¦ä¹ æ›´ä¸°å¯Œçš„ç‰¹å¾ã€‚</li></ul></li></ol></li><li>ç»„åˆæŸå¤± (Combined Loss)ï¼š<br>æ€»æŸå¤±æ˜¯ä¸¤ä¸ªé¢„æµ‹å¤´ BCE æŸå¤±çš„åŠ æƒå’Œã€‚</li></ul></li><li><p>æ¨¡å‹ä¼˜åŠ¿ï¼š</p><ul><li>é«˜å‡†ç¡®æ€§ï¼š åœ¨å¤šä¸ªæ ‡å‡† SBD æ•°æ®é›†ï¼ˆå¦‚ ClipShots, TRECVID IACC.3, RAI, BBC Planet Earthï¼‰ä¸Šå–å¾—äº†ä¸šç•Œé¢†å…ˆ (SOTA) çš„ç»“æœã€‚</li><li>é«˜é€Ÿåº¦ï¼š ä¸ºæ•ˆç‡è€Œè®¾è®¡ï¼Œåœ¨ç°ä»£ GPU ä¸Šèƒ½å¤Ÿå®ç°è¿œè¶…å®æ—¶çš„å¤„ç†é€Ÿåº¦ï¼ˆä¾‹å¦‚ï¼Œåœ¨ NVIDIA V100 ä¸Šç½‘ç»œæ¨ç†éƒ¨åˆ†çº¦ 150 FPSï¼Œä¸åŒ…æ‹¬è§†é¢‘è§£ç ï¼‰ã€‚</li><li>é²æ£’æ€§å¼ºï¼š èƒ½å¤Ÿæœ‰æ•ˆå¤„ç†ç¡¬åˆ‡å’Œå„ç§å¤æ‚çš„æ¸å˜è½¬åœºã€‚</li><li>ç«¯åˆ°ç«¯å­¦ä¹ ï¼š ç›´æ¥ä»ä½åˆ†è¾¨ç‡ RGB å¸§ä¸­å­¦ä¹ ç‰¹å¾ï¼Œæ— éœ€å¤æ‚çš„æ‰‹åŠ¨ç‰¹å¾å·¥ç¨‹ã€‚</li></ul></li></ol><h2 id="TransNet-V2-ä½¿ç”¨æ–¹æ³•-æ¨ç†ä¸åå¤„ç†">TransNet V2 ä½¿ç”¨æ–¹æ³• (æ¨ç†ä¸åå¤„ç†)</h2><ol><li><p>è¾“å…¥è§†é¢‘å¤„ç†ï¼š</p><ul><li>å°†è§†é¢‘è§£ç æˆå•ç‹¬çš„å¸§ã€‚</li><li>å°†æ¯ä¸€å¸§çš„å¤§å°è°ƒæ•´åˆ°ç½‘ç»œæ‰€éœ€çš„è¾“å…¥åˆ†è¾¨ç‡ï¼ˆä¾‹å¦‚ <code>48x27</code> åƒç´ ï¼‰ã€‚</li></ul></li><li><p>æ»‘åŠ¨çª—å£æ¨ç†ï¼š</p><ul><li>è§†é¢‘ä»¥ <code>N</code> å¸§ï¼ˆå¦‚ 100 å¸§ï¼‰çš„é‡å çª—å£è¿›è¡Œå¤„ç†ã€‚</li><li>å¯¹äºæ¯ä¸ªçª—å£ï¼Œç½‘ç»œä»ä¸»è¦çš„è½¬åœºæ¦‚ç‡é¢„æµ‹å¤´è¾“å‡º <code>N</code> ä¸ªæ¦‚ç‡å€¼ï¼ˆå¯¹åº”çª—å£ä¸­çš„æ¯ä¸€å¸§ï¼‰ã€‚</li><li>ç”±äºçª—å£æ˜¯é‡å çš„ï¼Œè§†é¢‘ä¸­çš„åŒä¸€å¸§å¯èƒ½ä¼šè·å¾—å¤šä¸ªé¢„æµ‹ã€‚é€šå¸¸ä¼šå¯¹è¿™äº›é¢„æµ‹è¿›è¡Œå¹³å‡ï¼Œä»¥è·å¾—è¯¥å¸§æ›´ç¨³å®šçš„æ¦‚ç‡ã€‚</li></ul></li><li><p>é¢„æµ‹ç»“æœåå¤„ç†ï¼š</p><ul><li>é˜ˆå€¼åŒ– (Thresholding)ï¼š<ul><li>å°†ï¼ˆå¹³å‡åçš„ï¼‰é€å¸§æ¦‚ç‡ä¸ä¸€ä¸ªé¢„å®šä¹‰çš„é˜ˆå€¼ <code>P_thresh</code> è¿›è¡Œæ¯”è¾ƒã€‚æ¦‚ç‡è¶…è¿‡æ­¤é˜ˆå€¼çš„å¸§è¢«è®¤ä¸ºæ˜¯å€™é€‰çš„é•œå¤´è¾¹ç•Œã€‚</li><li>è®ºæ–‡å»ºè®® <code>P_thresh = 0.5</code> æ˜¯ä¸€ä¸ªä¸é”™çš„é»˜è®¤å€¼ï¼Œä½†å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ã€‚</li></ul></li><li>æœ€å°é•œå¤´é•¿åº¦ (Minimum Shot Length - <code>L_min</code>)ï¼š<ul><li>ä¸ºäº†é¿å…äº§ç”Ÿè®¸å¤šéå¸¸çŸ­çš„ã€å¯èƒ½æ˜¯è¯¯æŠ¥çš„é•œå¤´ï¼Œä¼šæ–½åŠ ä¸€ä¸ªçº¦æŸï¼šä»»ä½•ä¼šå¯¼è‡´é•œå¤´é•¿åº¦å°äº <code>L_min</code> å¸§çš„æ£€æµ‹è¾¹ç•Œéƒ½ä¼šè¢«ä¸¢å¼ƒã€‚</li><li>è¿™é€šå¸¸é€šè¿‡éå†å€™é€‰è¾¹ç•Œå¹¶ç¡®ä¿å…¶ä¸å‰ä¸€ä¸ªå·²æ¥å—è¾¹ç•Œçš„è·ç¦»è‡³å°‘ä¸º <code>L_min</code> æ¥å®ç°ã€‚</li><li>è®ºæ–‡ä¸­æåˆ°æ ¹æ®æ•°æ®é›†æˆ–æœŸæœ›çš„ç²’åº¦ä½¿ç”¨ <code>L_min</code> å€¼ï¼Œå¦‚ 10 å¸§æˆ– 25 å¸§ã€‚</li></ul></li></ul></li><li><p>è¾“å‡ºï¼š</p><ul><li>æœ€ç»ˆè¾“å‡ºæ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼ŒåŒ…å«æ£€æµ‹åˆ°çš„é•œå¤´è¾¹ç•Œæ‰€åœ¨çš„å¸§ç´¢å¼•å·ã€‚</li><li>å¯é€‰åœ°ï¼Œå¯ä»¥ä½¿ç”¨è½¬åœºç±»å‹é¢„æµ‹å¤´çš„è¾“å‡ºæ¥å¯¹æ£€æµ‹åˆ°çš„è¾¹ç•Œè¿›è¡Œåˆ†ç±»ï¼Œä½†é€šå¸¸ä¸»è¦å…³æ³¨çš„æ˜¯è¾¹ç•Œçš„æ£€æµ‹æœ¬<br>èº«ã€‚</li></ul></li></ol><ul><li>æ¨¡å‹æ£€æµ‹ç»“æœ</li></ul><p><img src="/2025/06/09/TransNetV2-model-use/detect_result.png" class="lazyload placeholder" data-srcset="/2025/06/09/TransNetV2-model-use/detect_result.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="ä½¿ç”¨">ä½¿ç”¨</h2><h3 id="æ¨¡å‹æ¨ç†">æ¨¡å‹æ¨ç†</h3><ul><li>æ¨ç†è„šæœ¬å¦‚ä¸‹ï¼š</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys  <span class="comment"># å¼•å…¥ sys ä»¥ä¾¿ä½¿ç”¨ sys.stderr</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TransNetV2</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model_dir=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="keyword">if</span> model_dir <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            model_dir = os.path.join(os.path.dirname(__file__), <span class="string">&quot;transnetv2-weights/&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(model_dir):</span><br><span class="line">                <span class="keyword">raise</span> FileNotFoundError(<span class="string">f&quot;[TransNetV2] ERROR: <span class="subst">&#123;model_dir&#125;</span> is not a directory.&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2] Using weights from <span class="subst">&#123;model_dir&#125;</span>.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>._input_size = (<span class="number">27</span>, <span class="number">48</span>, <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>._model = tf.saved_model.load(model_dir)</span><br><span class="line">        <span class="keyword">except</span> OSError <span class="keyword">as</span> exc:</span><br><span class="line">            <span class="keyword">raise</span> IOError(<span class="string">f&quot;[TransNetV2] It seems that files in <span class="subst">&#123;model_dir&#125;</span> are corrupted or missing. &quot;</span></span><br><span class="line">                          <span class="string">f&quot;Re-download them manually and retry. For more info, see: &quot;</span></span><br><span class="line">                          <span class="string">f&quot;https://github.com/soCzech/TransNetV2/issues/1#issuecomment-647357796&quot;</span>) <span class="keyword">from</span> exc</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">predict_raw</span>(<span class="params">self, frames: np.ndarray</span>):</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(frames.shape) == <span class="number">5</span> <span class="keyword">and</span> frames.shape[<span class="number">2</span>:] == <span class="variable language_">self</span>._input_size, \</span><br><span class="line">            <span class="string">&quot;[TransNetV2] Input shape must be [batch, frames, height, width, 3].&quot;</span></span><br><span class="line">        frames = tf.cast(frames, tf.float32)</span><br><span class="line"></span><br><span class="line">        logits, dict_ = <span class="variable language_">self</span>._model(frames)</span><br><span class="line">        single_frame_pred = tf.sigmoid(logits)</span><br><span class="line">        all_frames_pred = tf.sigmoid(dict_[<span class="string">&quot;many_hot&quot;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> single_frame_pred, all_frames_pred</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">predict_frames</span>(<span class="params">self, frames: np.ndarray</span>):</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(frames.shape) == <span class="number">4</span> <span class="keyword">and</span> frames.shape[<span class="number">1</span>:] == <span class="variable language_">self</span>._input_size, \</span><br><span class="line">            <span class="string">&quot;[TransNetV2] Input shape must be [frames, height, width, 3].&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">input_iterator</span>():</span><br><span class="line">            <span class="comment"># return windows of size 100 where the first/last 25 frames are from the previous/next batch</span></span><br><span class="line">            <span class="comment"># the first and last window must be padded by copies of the first and last frame of the video</span></span><br><span class="line">            no_padded_frames_start = <span class="number">25</span></span><br><span class="line">            no_padded_frames_end = <span class="number">25</span> + <span class="number">50</span> - (<span class="built_in">len</span>(frames) % <span class="number">50</span> <span class="keyword">if</span> <span class="built_in">len</span>(frames) % <span class="number">50</span> != <span class="number">0</span> <span class="keyword">else</span> <span class="number">50</span>)  <span class="comment"># 25 - 74</span></span><br><span class="line"></span><br><span class="line">            start_frame = np.expand_dims(frames[<span class="number">0</span>], <span class="number">0</span>)</span><br><span class="line">            end_frame = np.expand_dims(frames[-<span class="number">1</span>], <span class="number">0</span>)</span><br><span class="line">            padded_inputs = np.concatenate(</span><br><span class="line">                ([start_frame] * no_padded_frames_start) + [frames] + ([end_frame] * no_padded_frames_end), <span class="number">0</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            ptr = <span class="number">0</span></span><br><span class="line">            <span class="keyword">while</span> ptr + <span class="number">100</span> &lt;= <span class="built_in">len</span>(padded_inputs):</span><br><span class="line">                out = padded_inputs[ptr:ptr + <span class="number">100</span>]</span><br><span class="line">                ptr += <span class="number">50</span></span><br><span class="line">                <span class="keyword">yield</span> out[np.newaxis]</span><br><span class="line"></span><br><span class="line">        predictions = []</span><br><span class="line"></span><br><span class="line">        <span class="comment"># åœ¨å¾ªç¯å¤–éƒ¨åˆå§‹åŒ–å¤„ç†å¸§æ•°çš„è®¡æ•°å™¨</span></span><br><span class="line">        processed_frames_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> inp <span class="keyword">in</span> input_iterator():</span><br><span class="line">            single_frame_pred, all_frames_pred = <span class="variable language_">self</span>.predict_raw(inp)</span><br><span class="line">            predictions.append((single_frame_pred.numpy()[<span class="number">0</span>, <span class="number">25</span>:<span class="number">75</span>, <span class="number">0</span>],</span><br><span class="line">                                all_frames_pred.numpy()[<span class="number">0</span>, <span class="number">25</span>:<span class="number">75</span>, <span class="number">0</span>]))</span><br><span class="line"></span><br><span class="line">            processed_frames_count = <span class="built_in">min</span>(<span class="built_in">len</span>(predictions) * <span class="number">50</span>, <span class="built_in">len</span>(frames))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;\r[TransNetV2] Processing video frames &#123;&#125;/&#123;&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">                processed_frames_count, <span class="built_in">len</span>(frames)</span><br><span class="line">            ), end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç¡®ä¿å³ä½¿è§†é¢‘å¸§æ•°å°‘äºä¸€ä¸ªæ‰¹æ¬¡ï¼Œä¹Ÿä¼šæ‰“å°æœ€ç»ˆçš„æ¢è¡Œç¬¦</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(frames) &gt; <span class="number">0</span>:  <span class="comment"># åªæœ‰åœ¨æœ‰å¸§çš„æƒ…å†µä¸‹æ‰æ‰“å°æ¢è¡Œï¼Œé¿å…ç©ºè§†é¢‘ä¹Ÿæ‰“å°</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">        single_frame_pred_list = [single_ <span class="keyword">for</span> single_, all_ <span class="keyword">in</span> predictions]</span><br><span class="line">        all_frames_pred_list = [all_ <span class="keyword">for</span> single_, all_ <span class="keyword">in</span> predictions]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> single_frame_pred_list:  <span class="comment"># å¦‚æœ predictions ä¸ºç©º (ä¾‹å¦‚ï¼Œè§†é¢‘å¸§æ•°éå¸¸å°‘)</span></span><br><span class="line">            <span class="comment"># æ ¹æ® frames çš„é•¿åº¦åˆ›å»ºä¸€ä¸ªå…¨é›¶çš„é¢„æµ‹æ•°ç»„</span></span><br><span class="line">            <span class="comment"># è¿™ç¡®ä¿äº†å³ä½¿æ²¡æœ‰é€šè¿‡è¿­ä»£å™¨å¤„ç†ä»»ä½•å†…å®¹ï¼Œä¹Ÿä¼šè¿”å›æ­£ç¡®å½¢çŠ¶çš„æ•°ç»„</span></span><br><span class="line">            <span class="comment"># ï¼ˆå°½ç®¡å¯¹äºéå¸¸çŸ­çš„è§†é¢‘ï¼Œè¿™å¯èƒ½ä»ç„¶ä¸æ˜¯ç†æƒ³çš„ï¼Œä½†è‡³å°‘é¿å…äº† concatenate ç©ºåˆ—è¡¨çš„é”™è¯¯ï¼‰</span></span><br><span class="line">            <span class="built_in">print</span>(</span><br><span class="line">                <span class="string">f&quot;[TransNetV2 WARNING] No predictions generated from input_iterator for a video of length <span class="subst">&#123;<span class="built_in">len</span>(frames)&#125;</span>. Returning zeros.&quot;</span>,</span><br><span class="line">                file=sys.stderr)</span><br><span class="line">            empty_preds_shape = (<span class="built_in">len</span>(frames),)  <span class="comment"># æˆ–è€… (0,) å¦‚æœ len(frames) æ˜¯ 0</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(frames) == <span class="number">0</span>:  <span class="comment"># å¤„ç†0å¸§è§†é¢‘çš„æç«¯æƒ…å†µ</span></span><br><span class="line">                <span class="keyword">return</span> np.array([]), np.array([])</span><br><span class="line">            <span class="keyword">return</span> np.zeros(empty_preds_shape, dtype=np.float32), np.zeros(empty_preds_shape, dtype=np.float32)</span><br><span class="line"></span><br><span class="line">        single_frame_pred_concatenated = np.concatenate(single_frame_pred_list)</span><br><span class="line">        all_frames_pred_concatenated = np.concatenate(all_frames_pred_list)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> single_frame_pred_concatenated[:<span class="built_in">len</span>(frames)], all_frames_pred_concatenated[</span><br><span class="line">                                                             :<span class="built_in">len</span>(frames)]  <span class="comment"># remove extra padded frames</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">predict_video</span>(<span class="params">self, video_fn: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">import</span> ffmpeg</span><br><span class="line">        <span class="keyword">except</span> ModuleNotFoundError:</span><br><span class="line">            <span class="keyword">raise</span> ModuleNotFoundError(<span class="string">&quot;For `predict_video` function `ffmpeg` needs to be installed in order to extract &quot;</span></span><br><span class="line">                                      <span class="string">&quot;individual frames from video file. Install `ffmpeg` command line tool and then &quot;</span></span><br><span class="line">                                      <span class="string">&quot;install python wrapper by `pip install ffmpeg-python`.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[TransNetV2] Extracting frames from &#123;&#125;&quot;</span>.<span class="built_in">format</span>(video_fn))</span><br><span class="line">        video_stream, err = <span class="literal">None</span>, <span class="literal">None</span>  <span class="comment"># Initialize</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            process = (</span><br><span class="line">                ffmpeg</span><br><span class="line">                .<span class="built_in">input</span>(video_fn)</span><br><span class="line">                .output(<span class="string">&quot;pipe:&quot;</span>, <span class="built_in">format</span>=<span class="string">&quot;rawvideo&quot;</span>, pix_fmt=<span class="string">&quot;rgb24&quot;</span>, s=<span class="string">&quot;48x27&quot;</span>)</span><br><span class="line">                .run_async(pipe_stdout=<span class="literal">True</span>, pipe_stderr=<span class="literal">True</span>)</span><br><span class="line">            )</span><br><span class="line">            video_stream, err = process.communicate()  <span class="comment"># Get output after process finishes</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> process.returncode != <span class="number">0</span>:</span><br><span class="line">                <span class="built_in">print</span>(</span><br><span class="line">                    <span class="string">f&quot;[TransNetV2 ERROR] ffmpeg process failed for <span class="subst">&#123;os.path.basename(video_fn)&#125;</span> with exit code <span class="subst">&#123;process.returncode&#125;</span>.&quot;</span>,</span><br><span class="line">                    file=sys.stderr)</span><br><span class="line">                <span class="keyword">if</span> err:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 ERROR] ffmpeg stderr:\n<span class="subst">&#123;err.decode(errors=<span class="string">&#x27;ignore&#x27;</span>)&#125;</span>&quot;</span>, file=sys.stderr)</span><br><span class="line">                <span class="keyword">return</span> np.array([]), np.array([]), np.array([])  <span class="comment"># Return empty arrays indicating failure</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> err:  <span class="comment"># Even if return code is 0, check stderr</span></span><br><span class="line">                <span class="comment"># Not all messages on stderr are errors, but log them as warnings</span></span><br><span class="line">                <span class="comment"># Filter out common non-error messages if necessary, or log all for debugging</span></span><br><span class="line">                decoded_err = err.decode(errors=<span class="string">&#x27;ignore&#x27;</span>).strip()</span><br><span class="line">                <span class="keyword">if</span> decoded_err:  <span class="comment"># Only print if there&#x27;s actual content</span></span><br><span class="line">                    <span class="built_in">print</span>(</span><br><span class="line">                        <span class="string">f&quot;[TransNetV2 WARNING] ffmpeg stderr for <span class="subst">&#123;os.path.basename(video_fn)&#125;</span> (exit code <span class="subst">&#123;process.returncode&#125;</span>):\n<span class="subst">&#123;decoded_err&#125;</span>&quot;</span>,</span><br><span class="line">                        file=sys.stderr)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> video_stream:</span><br><span class="line">                <span class="built_in">print</span>(</span><br><span class="line">                    <span class="string">f&quot;[TransNetV2 ERROR] ffmpeg produced no video stream for <span class="subst">&#123;os.path.basename(video_fn)&#125;</span>. Cannot proceed.&quot;</span>,</span><br><span class="line">                    file=sys.stderr)</span><br><span class="line">                <span class="keyword">return</span> np.array([]), np.array([]), np.array([])  <span class="comment"># Return empty</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> ffmpeg.Error <span class="keyword">as</span> e_ffmpeg:  <span class="comment"># Catch ffmpeg&#x27;s own errors</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 ERROR] ffmpeg.Error during frame extraction for <span class="subst">&#123;os.path.basename(video_fn)&#125;</span>:&quot;</span>,</span><br><span class="line">                  file=sys.stderr)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">hasattr</span>(e_ffmpeg, <span class="string">&#x27;stderr&#x27;</span>) <span class="keyword">and</span> e_ffmpeg.stderr:</span><br><span class="line">                <span class="built_in">print</span>(e_ffmpeg.stderr.decode(errors=<span class="string">&#x27;ignore&#x27;</span>), file=sys.stderr)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="built_in">str</span>(e_ffmpeg), file=sys.stderr)</span><br><span class="line">            <span class="keyword">return</span> np.array([]), np.array([]), np.array([])  <span class="comment"># Return empty</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e_generic_ffmpeg:  <span class="comment"># Catch other potential errors during ffmpeg processing</span></span><br><span class="line">            <span class="built_in">print</span>(</span><br><span class="line">                <span class="string">f&quot;[TransNetV2 ERROR] Generic exception during ffmpeg processing for <span class="subst">&#123;os.path.basename(video_fn)&#125;</span>: <span class="subst">&#123;e_generic_ffmpeg&#125;</span>&quot;</span>,</span><br><span class="line">                file=sys.stderr)</span><br><span class="line">            <span class="keyword">return</span> np.array([]), np.array([]), np.array([])  <span class="comment"># Return empty</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> video_stream <span class="keyword">is</span> <span class="literal">None</span>:  <span class="comment"># Should have been caught above, but as a safeguard</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 ERROR] video_stream is None after ffmpeg processing for <span class="subst">&#123;os.path.basename(video_fn)&#125;</span>.&quot;</span>,</span><br><span class="line">                  file=sys.stderr)</span><br><span class="line">            <span class="keyword">return</span> np.array([]), np.array([]), np.array([])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            video = np.frombuffer(video_stream, np.uint8).reshape([-<span class="number">1</span>, <span class="number">27</span>, <span class="number">48</span>, <span class="number">3</span>])</span><br><span class="line">        <span class="keyword">except</span> ValueError <span class="keyword">as</span> e_reshape:</span><br><span class="line">            <span class="built_in">print</span>(</span><br><span class="line">                <span class="string">f&quot;[TransNetV2 ERROR] Failed to reshape video_stream for <span class="subst">&#123;os.path.basename(video_fn)&#125;</span>. Stream length: <span class="subst">&#123;<span class="built_in">len</span>(video_stream)&#125;</span>. Error: <span class="subst">&#123;e_reshape&#125;</span>&quot;</span>,</span><br><span class="line">                file=sys.stderr)</span><br><span class="line">            <span class="keyword">return</span> np.array([]), np.array([]), np.array([])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> video.shape[<span class="number">0</span>] == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(</span><br><span class="line">                <span class="string">f&quot;[TransNetV2 ERROR] Extracted 0 frames from <span class="subst">&#123;os.path.basename(video_fn)&#125;</span> after ffmpeg. Cannot proceed.&quot;</span>,</span><br><span class="line">                file=sys.stderr)</span><br><span class="line">            <span class="keyword">return</span> np.array([]), np.array([]), np.array([])  <span class="comment"># Return empty</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (video, *<span class="variable language_">self</span>.predict_frames(video))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">predictions_to_scenes</span>(<span class="params">predictions: np.ndarray, threshold: <span class="built_in">float</span> = <span class="number">0.5</span></span>):</span><br><span class="line">        <span class="keyword">if</span> predictions <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> predictions.size == <span class="number">0</span>:  <span class="comment"># Handle empty or None predictions</span></span><br><span class="line">            <span class="built_in">print</span>(</span><br><span class="line">                <span class="string">&quot;[TransNetV2 DEBUG] predictions_to_scenes received empty or None predictions. Returning empty scenes.&quot;</span>,</span><br><span class="line">                file=sys.stderr)</span><br><span class="line">            <span class="keyword">return</span> np.array([], dtype=np.int32)  <span class="comment"># Return empty array of correct type</span></span><br><span class="line"></span><br><span class="line">        predictions = (predictions &gt; threshold).astype(np.uint8)</span><br><span class="line"></span><br><span class="line">        scenes = []</span><br><span class="line">        t, t_prev, start = -<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i, t_current_frame_pred <span class="keyword">in</span> <span class="built_in">enumerate</span>(predictions):  <span class="comment"># Renamed &#x27;t&#x27; to avoid conflict</span></span><br><span class="line">            <span class="keyword">if</span> t_prev == <span class="number">1</span> <span class="keyword">and</span> t_current_frame_pred == <span class="number">0</span>:</span><br><span class="line">                start = i</span><br><span class="line">            <span class="keyword">if</span> t_prev == <span class="number">0</span> <span class="keyword">and</span> t_current_frame_pred == <span class="number">1</span> <span class="keyword">and</span> i != <span class="number">0</span>:</span><br><span class="line">                scenes.append([start, i])</span><br><span class="line">            t_prev = t_current_frame_pred</span><br><span class="line"></span><br><span class="line">        <span class="comment"># After loop, check if the video ends in a shot (t_prev will be 0 if it ended with a transition, or 1 if it ended mid-shot)</span></span><br><span class="line">        <span class="comment"># The original logic for &#x27;if t == 0:&#x27; was based on the last prediction value.</span></span><br><span class="line">        <span class="comment"># If the last prediction was 0 (meaning it&#x27;s part of a shot that started earlier)</span></span><br><span class="line">        <span class="keyword">if</span> t_prev == <span class="number">0</span> <span class="keyword">and</span> <span class="built_in">len</span>(predictions) &gt; <span class="number">0</span>:  <span class="comment"># Ensure there was at least one prediction</span></span><br><span class="line">            <span class="comment"># If start is not the beginning of the video and a shot has started</span></span><br><span class="line">            <span class="keyword">if</span> start &lt; <span class="built_in">len</span>(predictions):  <span class="comment"># Make sure start is a valid index</span></span><br><span class="line">                scenes.append([start, <span class="built_in">len</span>(predictions) - <span class="number">1</span>])  <span class="comment"># Shot goes to the end</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># just fix if all predictions are 1 (no transitions found, so one scene from start to end)</span></span><br><span class="line">        <span class="comment"># or if all predictions are 0 (also one scene from start to end, after fixing start to 0)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> scenes <span class="keyword">and</span> <span class="built_in">len</span>(predictions) &gt; <span class="number">0</span>:  <span class="comment"># If no scenes were appended and there are predictions</span></span><br><span class="line">            <span class="built_in">print</span>(</span><br><span class="line">                <span class="string">&quot;[TransNetV2 DEBUG] No scenes detected by transition logic, assuming single scene for the entire video.&quot;</span>,</span><br><span class="line">                file=sys.stderr)</span><br><span class="line">            <span class="keyword">return</span> np.array([[<span class="number">0</span>, <span class="built_in">len</span>(predictions) - <span class="number">1</span>]], dtype=np.int32)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> scenes <span class="keyword">and</span> <span class="built_in">len</span>(predictions) == <span class="number">0</span>:  <span class="comment"># If no predictions at all</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[TransNetV2 DEBUG] No predictions, returning empty scenes array.&quot;</span>, file=sys.stderr)</span><br><span class="line">            <span class="keyword">return</span> np.array([], dtype=np.int32)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> np.array(scenes, dtype=np.int32)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">visualize_predictions</span>(<span class="params">frames: np.ndarray, predictions</span>):</span><br><span class="line">        <span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageDraw</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> frames <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> frames.size == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[TransNetV2 WARNING] visualize_predictions received no frames. Skipping visualization.&quot;</span>,</span><br><span class="line">                  file=sys.stderr)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span>  <span class="comment"># Or a placeholder image</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(predictions, np.ndarray):</span><br><span class="line">            predictions = [predictions]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Filter out None or empty prediction arrays</span></span><br><span class="line">        valid_predictions = []</span><br><span class="line">        <span class="keyword">for</span> p_arr <span class="keyword">in</span> predictions:</span><br><span class="line">            <span class="keyword">if</span> p_arr <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> p_arr.size &gt; <span class="number">0</span>:</span><br><span class="line">                valid_predictions.append(p_arr)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> valid_predictions:</span><br><span class="line">            <span class="built_in">print</span>(</span><br><span class="line">                <span class="string">&quot;[TransNetV2 WARNING] visualize_predictions received no valid prediction arrays. Skipping visualization.&quot;</span>,</span><br><span class="line">                file=sys.stderr)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span>  <span class="comment"># Or a placeholder image</span></span><br><span class="line">        predictions = valid_predictions</span><br><span class="line"></span><br><span class="line">        ih, iw, ic = frames.shape[<span class="number">1</span>:]</span><br><span class="line">        width = <span class="number">25</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># pad frames so that length of the video is divisible by width</span></span><br><span class="line">        <span class="comment"># pad frames also by len(predictions) pixels in width in order to show predictions</span></span><br><span class="line">        pad_with = width - <span class="built_in">len</span>(frames) % width <span class="keyword">if</span> <span class="built_in">len</span>(frames) % width != <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">        <span class="comment"># Ensure pad_with is not negative if len(frames) is 0</span></span><br><span class="line">        pad_with = <span class="built_in">max</span>(<span class="number">0</span>, pad_with)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Pad frames, ensuring frames is not empty</span></span><br><span class="line">        <span class="keyword">if</span> frames.size &gt; <span class="number">0</span>:</span><br><span class="line">            frames = np.pad(frames, [(<span class="number">0</span>, pad_with), (<span class="number">0</span>, <span class="number">1</span>), (<span class="number">0</span>, <span class="built_in">len</span>(predictions)), (<span class="number">0</span>, <span class="number">0</span>)])</span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># Should not happen if caught earlier, but as a safeguard</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        predictions = [np.pad(x, (<span class="number">0</span>, pad_with)) <span class="keyword">for</span> x <span class="keyword">in</span> predictions]</span><br><span class="line">        height = <span class="built_in">len</span>(frames) // width</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> height == <span class="number">0</span> <span class="keyword">or</span> width == <span class="number">0</span>:  <span class="comment"># Avoid division by zero or empty reshape</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[TransNetV2 WARNING] Cannot create visualization due to zero height or width after padding.&quot;</span>,</span><br><span class="line">                  file=sys.stderr)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        img = frames.reshape([height, width, ih + <span class="number">1</span>, iw + <span class="built_in">len</span>(predictions), ic])</span><br><span class="line">        img = np.concatenate(np.split(</span><br><span class="line">            np.concatenate(np.split(img, height, axis=<span class="number">0</span>), axis=<span class="number">2</span>)[<span class="number">0</span>], width, axis=<span class="number">1</span>  <span class="comment"># Corrected axis for split</span></span><br><span class="line">        ), axis=<span class="number">2</span>)[<span class="number">0</span>, :-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        img = Image.fromarray(img)</span><br><span class="line">        draw = ImageDraw.Draw(img)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># iterate over all frames</span></span><br><span class="line">        <span class="keyword">for</span> i, pred_tuple <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="built_in">zip</span>(*predictions)):  <span class="comment"># pred_tuple contains predictions for frame i</span></span><br><span class="line">            x_base, y_base = i % width, i // width  <span class="comment"># Top-left corner of the frame in the grid</span></span><br><span class="line">            x_offset, y_offset = x_base * (iw + <span class="built_in">len</span>(predictions)) + iw, y_base * (</span><br><span class="line">                    ih + <span class="number">1</span>) + ih - <span class="number">1</span>  <span class="comment"># Bottom-right of frame content, before prediction lines</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># we can visualize multiple predictions per single frame</span></span><br><span class="line">            <span class="keyword">for</span> j, p_value <span class="keyword">in</span> <span class="built_in">enumerate</span>(pred_tuple):  <span class="comment"># j is prediction type index, p_value is its value</span></span><br><span class="line">                color = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">                <span class="comment"># Cycle through R, G, B for different prediction types</span></span><br><span class="line">                color[j % <span class="number">3</span>] = <span class="number">255</span>  <span class="comment"># Use j for color to distinguish prediction types</span></span><br><span class="line"></span><br><span class="line">                value_scaled = <span class="built_in">round</span>(p_value * (ih - <span class="number">1</span>))  <span class="comment"># Scale prediction to frame height</span></span><br><span class="line">                <span class="keyword">if</span> value_scaled != <span class="number">0</span>:</span><br><span class="line">                    <span class="comment"># Draw line upwards from the bottom edge of the frame visualization area</span></span><br><span class="line">                    draw.line((x_offset + j, y_offset, x_offset + j, y_offset - value_scaled), fill=<span class="built_in">tuple</span>(color),</span><br><span class="line">                              width=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> img</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">import</span> argparse  <span class="comment"># Already imported sys</span></span><br><span class="line"></span><br><span class="line">    parser = argparse.ArgumentParser()</span><br><span class="line">    parser.add_argument(<span class="string">&quot;files&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, nargs=<span class="string">&quot;+&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;path to video files to process&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--weights&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="literal">None</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;path to TransNet V2 weights, tries to infer the location if not specified&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--visualize&#x27;</span>, action=<span class="string">&quot;store_true&quot;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;save a png file with prediction visualization for each extracted video&quot;</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        model = TransNetV2(args.weights)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e_model_load:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 CRITICAL] Failed to load TransNetV2 model: <span class="subst">&#123;e_model_load&#125;</span>&quot;</span>, file=sys.stderr)</span><br><span class="line">        sys.exit(<span class="number">1</span>)  <span class="comment"># Exit if model fails to load</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> args.files:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 INFO] Processing file: <span class="subst">&#123;file&#125;</span>&quot;</span>, file=sys.stderr)</span><br><span class="line">        <span class="comment"># This pre-check is fine, but the calling script test_and_cut_video.py now also does pre-cleanup</span></span><br><span class="line">        <span class="keyword">if</span> os.path.exists(file + <span class="string">&quot;.predictions.txt&quot;</span>) <span class="keyword">or</span> os.path.exists(file + <span class="string">&quot;.scenes.txt&quot;</span>):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2] <span class="subst">&#123;file&#125;</span>.predictions.txt or <span class="subst">&#123;file&#125;</span>.scenes.txt already exists. &quot;</span></span><br><span class="line">                  <span class="string">f&quot;Skipping video <span class="subst">&#123;file&#125;</span>.&quot;</span>, file=sys.stderr)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            video_frames, single_frame_predictions, all_frame_predictions = \</span><br><span class="line">                model.predict_video(file)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># --- Debugging: Check outputs of predict_video ---</span></span><br><span class="line">            <span class="keyword">if</span> video_frames <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> video_frames.size == <span class="number">0</span>:</span><br><span class="line">                <span class="built_in">print</span>(</span><br><span class="line">                    <span class="string">f&quot;[TransNetV2 ERROR] predict_video returned no frames for <span class="subst">&#123;os.path.basename(file)&#125;</span>. Cannot save outputs.&quot;</span>,</span><br><span class="line">                    file=sys.stderr)</span><br><span class="line">                <span class="keyword">continue</span>  <span class="comment"># Skip to next file</span></span><br><span class="line">            <span class="keyword">if</span> single_frame_predictions <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> single_frame_predictions.size == <span class="number">0</span>:</span><br><span class="line">                <span class="built_in">print</span>(</span><br><span class="line">                    <span class="string">f&quot;[TransNetV2 ERROR] predict_video returned no single_frame_predictions for <span class="subst">&#123;os.path.basename(file)&#125;</span>. Cannot save outputs.&quot;</span>,</span><br><span class="line">                    file=sys.stderr)</span><br><span class="line">                <span class="keyword">continue</span>  <span class="comment"># Skip to next file</span></span><br><span class="line">            <span class="comment"># all_frame_predictions can sometimes be legitimately empty if single_frame_predictions is also empty.</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 DEBUG] Returned from predict_video for <span class="subst">&#123;os.path.basename(file)&#125;</span>.&quot;</span>, file=sys.stderr)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 DEBUG]   video_frames shape: <span class="subst">&#123;video_frames.shape&#125;</span>&quot;</span>, file=sys.stderr)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 DEBUG]   single_frame_predictions shape: <span class="subst">&#123;single_frame_predictions.shape&#125;</span>&quot;</span>,</span><br><span class="line">                  file=sys.stderr)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 DEBUG]   all_frame_predictions shape: <span class="subst">&#123;all_frame_predictions.shape&#125;</span>&quot;</span>, file=sys.stderr)</span><br><span class="line">            <span class="comment"># --- End Debugging ---</span></span><br><span class="line"></span><br><span class="line">            predictions = np.stack([single_frame_predictions, all_frame_predictions], <span class="number">1</span>)</span><br><span class="line">            predictions_filepath = file + <span class="string">&quot;.predictions.txt&quot;</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                np.savetxt(predictions_filepath, predictions, fmt=<span class="string">&quot;%.6f&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 DEBUG] Attempted to save predictions to <span class="subst">&#123;predictions_filepath&#125;</span>&quot;</span>, file=sys.stderr)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(predictions_filepath):</span><br><span class="line">                    <span class="built_in">print</span>(</span><br><span class="line">                        <span class="string">f&quot;[TransNetV2 CRITICAL DEBUG] Saved predictions but file <span class="subst">&#123;predictions_filepath&#125;</span> does NOT exist!&quot;</span>,</span><br><span class="line">                        file=sys.stderr)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 DEBUG] File <span class="subst">&#123;predictions_filepath&#125;</span> successfully created.&quot;</span>, file=sys.stderr)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e_pred_save:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 ERROR] Exception saving predictions file <span class="subst">&#123;predictions_filepath&#125;</span>: <span class="subst">&#123;e_pred_save&#125;</span>&quot;</span>,</span><br><span class="line">                      file=sys.stderr)</span><br><span class="line">                <span class="keyword">continue</span>  <span class="comment"># Skip to next file if saving predictions fails</span></span><br><span class="line"></span><br><span class="line">            scenes = model.predictions_to_scenes(single_frame_predictions)</span><br><span class="line">            <span class="built_in">print</span>(</span><br><span class="line">                <span class="string">f&quot;[TransNetV2 DEBUG] Scenes array for <span class="subst">&#123;os.path.basename(file)&#125;</span> (shape: <span class="subst">&#123;scenes.shape <span class="keyword">if</span> scenes <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">else</span> <span class="string">&#x27;None&#x27;</span>&#125;</span>):\n<span class="subst">&#123;scenes&#125;</span>&quot;</span>,</span><br><span class="line">                file=sys.stderr)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> scenes <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> scenes.size == <span class="number">0</span>:  <span class="comment"># Check if scenes array is empty</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 WARNING] Scenes array is empty or None for <span class="subst">&#123;os.path.basename(file)&#125;</span>. &quot;</span></span><br><span class="line">                      <span class="string">f&quot;No .scenes.txt will be saved, or it might be empty.&quot;</span>, file=sys.stderr)</span><br><span class="line">                <span class="comment"># Depending on desired behavior, you might &#x27;continue&#x27; here or let np.savetxt handle an empty array.</span></span><br><span class="line">                <span class="comment"># np.savetxt with an empty array will create an empty file.</span></span><br><span class="line">                <span class="comment"># If an empty scenes file is problematic for the parent script, handle it here.</span></span><br><span class="line">                <span class="comment"># For now, let it try to save, which will result in an empty file if scenes is empty.</span></span><br><span class="line"></span><br><span class="line">            scenes_filepath = file + <span class="string">&quot;.scenes.txt&quot;</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                np.savetxt(scenes_filepath, scenes, fmt=<span class="string">&quot;%d&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 DEBUG] Attempted to save scenes to <span class="subst">&#123;scenes_filepath&#125;</span>&quot;</span>, file=sys.stderr)</span><br><span class="line">                <span class="keyword">if</span> os.path.exists(scenes_filepath):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 DEBUG] File <span class="subst">&#123;scenes_filepath&#125;</span> successfully created.&quot;</span>, file=sys.stderr)</span><br><span class="line">                    <span class="comment"># Optionally, check file size or content for empty scenes</span></span><br><span class="line">                    <span class="keyword">if</span> scenes <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> scenes.size == <span class="number">0</span> <span class="keyword">and</span> os.path.getsize(scenes_filepath) == <span class="number">0</span>:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 DEBUG] <span class="subst">&#123;scenes_filepath&#125;</span> is empty as expected for empty scenes array.&quot;</span>,</span><br><span class="line">                              file=sys.stderr)</span><br><span class="line">                    <span class="keyword">elif</span> scenes <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> scenes.size &gt; <span class="number">0</span> <span class="keyword">and</span> os.path.getsize(scenes_filepath) == <span class="number">0</span>:</span><br><span class="line">                        <span class="built_in">print</span>(</span><br><span class="line">                            <span class="string">f&quot;[TransNetV2 WARNING] <span class="subst">&#123;scenes_filepath&#125;</span> is unexpectedly empty despite non-empty scenes array.&quot;</span>,</span><br><span class="line">                            file=sys.stderr)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(</span><br><span class="line">                        <span class="string">f&quot;[TransNetV2 CRITICAL DEBUG] Saved scenes but file <span class="subst">&#123;scenes_filepath&#125;</span> does NOT exist afterwards!&quot;</span>,</span><br><span class="line">                        file=sys.stderr)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e_save:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 ERROR] Exception during np.savetxt for .scenes.txt (<span class="subst">&#123;scenes_filepath&#125;</span>): <span class="subst">&#123;e_save&#125;</span>&quot;</span>,</span><br><span class="line">                      file=sys.stderr)</span><br><span class="line">                <span class="keyword">continue</span>  <span class="comment"># Skip to next file if saving scenes fails</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> args.visualize:</span><br><span class="line">                vis_filepath = file + <span class="string">&quot;.vis.png&quot;</span></span><br><span class="line">                <span class="keyword">if</span> os.path.exists(vis_filepath):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2] <span class="subst">&#123;vis_filepath&#125;</span> already exists. &quot;</span></span><br><span class="line">                          <span class="string">f&quot;Skipping visualization of video <span class="subst">&#123;file&#125;</span>.&quot;</span>, file=sys.stderr)</span><br><span class="line">                    <span class="comment"># continue # This continue was inside the loop for &#x27;file in args.files&#x27;</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 DEBUG] Attempting to visualize predictions for <span class="subst">&#123;os.path.basename(file)&#125;</span>&quot;</span>,</span><br><span class="line">                          file=sys.stderr)</span><br><span class="line">                    pil_image = model.visualize_predictions(</span><br><span class="line">                        video_frames, predictions=(single_frame_predictions, all_frame_predictions))</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> pil_image:</span><br><span class="line">                        <span class="keyword">try</span>:</span><br><span class="line">                            pil_image.save(vis_filepath)</span><br><span class="line">                            <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 DEBUG] Saved visualization to <span class="subst">&#123;vis_filepath&#125;</span>&quot;</span>, file=sys.stderr)</span><br><span class="line">                        <span class="keyword">except</span> Exception <span class="keyword">as</span> e_vis_save:</span><br><span class="line">                            <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 ERROR] Exception saving visualization <span class="subst">&#123;vis_filepath&#125;</span>: <span class="subst">&#123;e_vis_save&#125;</span>&quot;</span>,</span><br><span class="line">                                  file=sys.stderr)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 WARNING] Visualization not generated for <span class="subst">&#123;os.path.basename(file)&#125;</span>.&quot;</span>,</span><br><span class="line">                              file=sys.stderr)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e_video_processing:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[TransNetV2 ERROR] Unhandled exception during processing of video <span class="subst">&#123;file&#125;</span>: <span class="subst">&#123;e_video_processing&#125;</span>&quot;</span>,</span><br><span class="line">                  file=sys.stderr)</span><br><span class="line">            <span class="comment"># Optionally, re-raise or sys.exit(1) if this should halt the script</span></span><br><span class="line">            <span class="comment"># For now, it will just print the error and attempt the next file.</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[TransNetV2 INFO] Finished processing all files.&quot;</span>, file=sys.stderr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="è°ƒç”¨æ¨ç†è„šæœ¬å¤„ç†è§†é¢‘">è°ƒç”¨æ¨ç†è„šæœ¬å¤„ç†è§†é¢‘</h3><ul><li>benchmark</li></ul><p><img src="/2025/06/09/TransNetV2-model-use/model-benchmark.png" class="lazyload placeholder" data-srcset="/2025/06/09/TransNetV2-model-use/model-benchmark.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li>å¤„ç†è¾“å…¥è§†é¢‘ä¸ºå•ä¸€åœºæ™¯ æ£€æµ‹è§†é¢‘è½¬åœºå¹¶åˆ†å‰²</li></ul><blockquote><p>è‡ªåŠ¨è·³è¿‡åˆ‡å‰²åè§†é¢‘å‰å500ms å»é™¤è½¬åœºåŠ¨ç”»</p></blockquote> <figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Time:     2025/6/7 19:00  # ä¿®æ”¹ä¸ºå®é™…æ—¶é—´</span></span><br><span class="line"><span class="string">Author:   ZhaoQi Cao(Clara)</span></span><br><span class="line"><span class="string">Version:  V 1.4 # ç‰ˆæœ¬æ›´æ–°: ä¿®æ­£ parse_scenes_file å‡½æ•°ä»¥æ­£ç¡®è§£æåœºæ™¯æ–‡ä»¶æ ¼å¼</span></span><br><span class="line"><span class="string">File:     test_and_cut_video.py</span></span><br><span class="line"><span class="string">date:     2025/6/7 # ä¿®æ”¹ä¸ºå®é™…æ—¥æœŸ</span></span><br><span class="line"><span class="string">Describe: Write during the python at Tianjin</span></span><br><span class="line"><span class="string">GitHub link: https://github.com/caozhaoqi</span></span><br><span class="line"><span class="string">Blog link: https://caozhaoqi.github.io</span></span><br><span class="line"><span class="string">WeChat Official Account: ç é—´æ‹¾é—ï¼ˆCode Snippetsï¼‰</span></span><br><span class="line"><span class="string">Power by macOS on Mac mini m4(2024)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> cv2  <span class="comment"># For getting total frames</span></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path  <span class="comment"># ç”¨äºæ›´æ–¹ä¾¿åœ°å¤„ç†è·¯å¾„</span></span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm  <span class="comment"># ç”¨äºè¿›åº¦æ¡</span></span><br><span class="line"><span class="keyword">import</span> shutil  <span class="comment"># ç”¨äºç§»åŠ¨æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- é…ç½®æ—¥å¿— ---</span></span><br><span class="line">logging.basicConfig(level=logging.INFO,</span><br><span class="line">                    <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(levelname)s - %(filename)s:%(lineno)d - %(message)s&#x27;</span>,</span><br><span class="line">                    datefmt=<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>)</span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ”¯æŒçš„è§†é¢‘æ–‡ä»¶æ‰©å±•å</span></span><br><span class="line">SUPPORTED_VIDEO_EXTENSIONS = [<span class="string">&#x27;.mp4&#x27;</span>, <span class="string">&#x27;.avi&#x27;</span>, <span class="string">&#x27;.mov&#x27;</span>, <span class="string">&#x27;.mkv&#x27;</span>, <span class="string">&#x27;.flv&#x27;</span>, <span class="string">&#x27;.wmv&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_video_files</span>(<span class="params">input_dir, output_dir_to_skip=<span class="literal">None</span></span>):  <span class="comment"># å¢åŠ ä¸€ä¸ªå¯é€‰å‚æ•°</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Recursively finds all video files in the given directory,</span></span><br><span class="line"><span class="string">    optionally skipping a specified output directory.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    video_files = []</span><br><span class="line">    logger.info(<span class="string">f&quot;Searching for video files in: <span class="subst">&#123;input_dir&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment"># è§„èŒƒåŒ– output_dir_to_skip ä»¥è¿›è¡Œå¯é çš„è·¯å¾„æ¯”è¾ƒ</span></span><br><span class="line">    normalized_output_skip_path = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> output_dir_to_skip:</span><br><span class="line">        normalized_output_skip_path = os.path.normpath(os.path.abspath(output_dir_to_skip))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(input_dir):</span><br><span class="line">        current_root_abs = os.path.normpath(os.path.abspath(root))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å¦‚æœå½“å‰éå†çš„ç›®å½•æ˜¯è¾“å‡ºç›®å½•æˆ–å…¶å­ç›®å½•ï¼Œåˆ™è·³è¿‡</span></span><br><span class="line">        <span class="keyword">if</span> normalized_output_skip_path <span class="keyword">and</span> current_root_abs.startswith(normalized_output_skip_path):</span><br><span class="line">            logger.info(<span class="string">f&quot;Skipping scan of output directory: <span class="subst">&#123;root&#125;</span>&quot;</span>)</span><br><span class="line">            dirs[:] = []  <span class="comment"># æ¸…ç©º dirs åˆ—è¡¨ï¼Œé˜»æ­¢ os.walk è¿›å…¥æ­¤ç›®å½•çš„å­ç›®å½•</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">            <span class="comment"># è¿‡æ»¤æ‰ macOS çš„ ._* æ–‡ä»¶å’Œå…¶ä»–ä»¥ç‚¹å¼€å¤´çš„éšè—æ–‡ä»¶</span></span><br><span class="line">            <span class="keyword">if</span> file.startswith(<span class="string">&#x27;.&#x27;</span>):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">any</span>(file.lower().endswith(ext) <span class="keyword">for</span> ext <span class="keyword">in</span> SUPPORTED_VIDEO_EXTENSIONS):</span><br><span class="line">                video_files.append(os.path.join(root, file))</span><br><span class="line">    logger.info(<span class="string">f&quot;Found <span class="subst">&#123;<span class="built_in">len</span>(video_files)&#125;</span> video file(s).&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> video_files</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_transnet_inference</span>(<span class="params">video_path, transnet_script_path, model_dir, working_directory=<span class="string">&quot;.&quot;</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Runs TransNetV2 inference to get shot boundaries.</span></span><br><span class="line"><span class="string">    Returns the path to the &#x27;.scenes.txt&#x27; file located in the working_directory.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    logger.info(<span class="string">f&quot;Running TransNetV2 inference on: <span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line">    video_filename = os.path.basename(video_path)  <span class="comment"># e.g., &quot;myvideo.mp4&quot;</span></span><br><span class="line">    base_name = os.path.splitext(video_filename)[<span class="number">0</span>]  <span class="comment"># e.g., &quot;myvideo&quot; (for target filename in working_dir)</span></span><br><span class="line">    original_video_dir = os.path.dirname(video_path)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- Pre-cleanup: å°è¯•åˆ é™¤åŸå§‹è§†é¢‘ç›®å½•ä¸­ä¸è¯¥è§†é¢‘ç›¸å…³çš„æ—§è¾“å‡ºæ–‡ä»¶ ---</span></span><br><span class="line">    <span class="comment"># This should target the names transnetv2.py actually creates</span></span><br><span class="line">    files_to_pre_cleanup = [</span><br><span class="line">        video_path + <span class="string">&quot;.scenes.txt&quot;</span>,</span><br><span class="line">        video_path + <span class="string">&quot;.predictions.txt&quot;</span>,</span><br><span class="line">        video_path + <span class="string">&quot;.vis.png&quot;</span></span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">for</span> old_file_path <span class="keyword">in</span> files_to_pre_cleanup:</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(old_file_path):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                os.remove(old_file_path)</span><br><span class="line">                logger.info(<span class="string">f&quot;Pre-emptively removed old file: <span class="subst">&#123;old_file_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> OSError <span class="keyword">as</span> e:</span><br><span class="line">                logger.warning(<span class="string">f&quot;Could not pre-emptively remove old file <span class="subst">&#123;old_file_path&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="comment"># --- é¢„æ¸…ç†ç»“æŸ ---</span></span><br><span class="line"></span><br><span class="line">    command = [</span><br><span class="line">        <span class="string">&quot;python&quot;</span>, transnet_script_path,</span><br><span class="line">        video_path,</span><br><span class="line">        <span class="string">&quot;--weights&quot;</span>, model_dir</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        process = subprocess.Popen(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE, cwd=working_directory)</span><br><span class="line">        stdout_bytes, stderr_bytes = process.communicate(timeout=<span class="number">3600</span>)</span><br><span class="line"></span><br><span class="line">        process_stdout = stdout_bytes.decode(errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">        process_stderr = stderr_bytes.decode(errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> process.returncode != <span class="number">0</span>:</span><br><span class="line">            logger.error(<span class="string">f&quot;TransNetV2 inference failed for <span class="subst">&#123;video_filename&#125;</span>:&quot;</span>)</span><br><span class="line">            logger.error(<span class="string">f&quot;STDOUT: <span class="subst">&#123;process_stdout&#125;</span>&quot;</span>)</span><br><span class="line">            logger.error(<span class="string">f&quot;STDERR: <span class="subst">&#123;process_stderr&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">f&quot;TransNetV2 inference successful for <span class="subst">&#123;video_filename&#125;</span> (exit code 0).&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> process_stdout.strip():</span><br><span class="line">            logger.info(<span class="string">f&quot;TransNetV2 STDOUT for <span class="subst">&#123;video_filename&#125;</span>:\n<span class="subst">&#123;process_stdout.strip()&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> process_stderr.strip():</span><br><span class="line">            logger.warning(</span><br><span class="line">                <span class="string">f&quot;TransNetV2 STDERR for <span class="subst">&#123;video_filename&#125;</span> (though exit code was 0):\n<span class="subst">&#123;process_stderr.strip()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> subprocess.TimeoutExpired:</span><br><span class="line">        logger.error(<span class="string">f&quot;TransNetV2 inference timed out for <span class="subst">&#123;video_filename&#125;</span>.&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> process:</span><br><span class="line">            process.kill()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                stdout_bytes, stderr_bytes = process.communicate(timeout=<span class="number">5</span>)</span><br><span class="line">                process_stdout = stdout_bytes.decode(errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">                process_stderr = stderr_bytes.decode(errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">                <span class="keyword">if</span> process_stdout.strip():</span><br><span class="line">                    logger.error(<span class="string">f&quot;STDOUT (on timeout): <span class="subst">&#123;process_stdout.strip()&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> process_stderr.strip():</span><br><span class="line">                    logger.error(<span class="string">f&quot;STDERR (on timeout): <span class="subst">&#123;process_stderr.strip()&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e_comm:</span><br><span class="line">                logger.error(<span class="string">f&quot;Error getting output after timeout kill: <span class="subst">&#123;e_comm&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Exception during TransNetV2 inference for <span class="subst">&#123;video_filename&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- æ–‡ä»¶æŸ¥æ‰¾å’Œç§»åŠ¨é€»è¾‘ ---</span></span><br><span class="line">    target_scenes_file_in_working_dir = os.path.join(working_directory, <span class="string">f&quot;<span class="subst">&#123;base_name&#125;</span>.scenes.txt&quot;</span>)</span><br><span class="line">    target_predictions_file_in_working_dir = os.path.join(working_directory, <span class="string">f&quot;<span class="subst">&#123;base_name&#125;</span>.predictions.txt&quot;</span>)</span><br><span class="line"></span><br><span class="line">    expected_scenes_file_in_original_dir = video_path + <span class="string">&quot;.scenes.txt&quot;</span></span><br><span class="line">    expected_predictions_file_in_original_dir = video_path + <span class="string">&quot;.predictions.txt&quot;</span></span><br><span class="line"></span><br><span class="line">    scenes_file_found_path = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(target_scenes_file_in_working_dir):</span><br><span class="line">        logger.info(<span class="string">f&quot;Found scenes file directly in working directory: <span class="subst">&#123;target_scenes_file_in_working_dir&#125;</span>&quot;</span>)</span><br><span class="line">        scenes_file_found_path = target_scenes_file_in_working_dir</span><br><span class="line">    <span class="keyword">elif</span> os.path.exists(expected_scenes_file_in_original_dir):</span><br><span class="line">        logger.info(<span class="string">f&quot;Found scenes file in original video directory: <span class="subst">&#123;expected_scenes_file_in_original_dir&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            shutil.move(expected_scenes_file_in_original_dir, target_scenes_file_in_working_dir)</span><br><span class="line">            logger.info(<span class="string">f&quot;Moved scenes file to: <span class="subst">&#123;target_scenes_file_in_working_dir&#125;</span>&quot;</span>)</span><br><span class="line">            scenes_file_found_path = target_scenes_file_in_working_dir</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> os.path.exists(expected_predictions_file_in_original_dir):</span><br><span class="line">                shutil.move(expected_predictions_file_in_original_dir, target_predictions_file_in_working_dir)</span><br><span class="line">                logger.info(<span class="string">f&quot;Moved predictions file to: <span class="subst">&#123;target_predictions_file_in_working_dir&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(</span><br><span class="line">                <span class="string">f&quot;Failed to move scenes/predictions file from &#x27;<span class="subst">&#123;expected_scenes_file_in_original_dir&#125;</span>&#x27; to &#x27;<span class="subst">&#123;target_scenes_file_in_working_dir&#125;</span>&#x27;: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.error(<span class="string">f&quot;Scenes file not found in working directory (<span class="subst">&#123;target_scenes_file_in_working_dir&#125;</span>) &quot;</span></span><br><span class="line">                     <span class="string">f&quot;nor in original video directory (<span class="subst">&#123;expected_scenes_file_in_original_dir&#125;</span>).&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> scenes_file_found_path</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_total_frames</span>(<span class="params">video_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Gets the total number of frames in a video.&quot;&quot;&quot;</span></span><br><span class="line">    cap = cv2.VideoCapture(video_path)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cap.isOpened():</span><br><span class="line">        <span class="comment"># Log OpenCV error if available (requires newer OpenCV versions for good messages)</span></span><br><span class="line">        <span class="comment"># For older versions, this might not give much info.</span></span><br><span class="line">        <span class="comment"># cv_error = cv2.getErrorMsg() if hasattr(cv2, &#x27;getErrorMsg&#x27;) else &quot;OpenCV error&quot;</span></span><br><span class="line">        <span class="comment"># logger.error(f&quot;Could not open video: &#123;video_path&#125;. OpenCV: &#123;cv_error&#125;&quot;)</span></span><br><span class="line">        logger.error(<span class="string">f&quot;Could not open video: <span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    total_frames = <span class="built_in">int</span>(cap.get(cv2.CAP_PROP_FRAME_COUNT))</span><br><span class="line">    cap.release()</span><br><span class="line">    <span class="keyword">return</span> total_frames</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_scenes_file</span>(<span class="params">scenes_file_path, total_frames</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Parses the .scenes.txt file which contains start and end frames for each shot,</span></span><br><span class="line"><span class="string">    one shot per line, space-separated.</span></span><br><span class="line"><span class="string">    Returns a list of (start_frame, end_frame) tuples for each shot.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(scenes_file_path):</span><br><span class="line">        logger.error(<span class="string">f&quot;Scenes file not found for parsing: <span class="subst">&#123;scenes_file_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">    shots = []</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(scenes_file_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">for</span> line_number, line <span class="keyword">in</span> <span class="built_in">enumerate</span>(f, <span class="number">1</span>):</span><br><span class="line">                stripped_line = line.strip()</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> stripped_line:  <span class="comment"># Skip empty lines</span></span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                parts = stripped_line.split()</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(parts) == <span class="number">2</span> <span class="keyword">and</span> parts[<span class="number">0</span>].isdigit() <span class="keyword">and</span> parts[<span class="number">1</span>].isdigit():</span><br><span class="line">                    start_frame = <span class="built_in">int</span>(parts[<span class="number">0</span>])</span><br><span class="line">                    end_frame = <span class="built_in">int</span>(parts[<span class="number">1</span>])  <span class="comment"># This is the end frame of the shot (inclusive)</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment"># Validate frames against total_frames</span></span><br><span class="line">                    <span class="keyword">if</span> start_frame &lt; <span class="number">0</span>:</span><br><span class="line">                        logger.warning(</span><br><span class="line">                            <span class="string">f&quot;Invalid start_frame <span class="subst">&#123;start_frame&#125;</span> &lt; 0 in <span class="subst">&#123;scenes_file_path&#125;</span> line <span class="subst">&#123;line_number&#125;</span>. Clamping to 0.&quot;</span>)</span><br><span class="line">                        start_frame = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment"># end_frame from TransNetV2 is inclusive and 0-indexed.</span></span><br><span class="line">                    <span class="comment"># If total_frames is N, valid frames are 0 to N-1.</span></span><br><span class="line">                    <span class="keyword">if</span> end_frame &gt;= total_frames <span class="keyword">and</span> total_frames &gt; <span class="number">0</span>:</span><br><span class="line">                        logger.warning(</span><br><span class="line">                            <span class="string">f&quot;End_frame <span class="subst">&#123;end_frame&#125;</span> from scenes file is &gt;= total_frames <span class="subst">&#123;total_frames&#125;</span> in <span class="subst">&#123;scenes_file_path&#125;</span> line <span class="subst">&#123;line_number&#125;</span>. Clamping to <span class="subst">&#123;total_frames - <span class="number">1</span>&#125;</span>.&quot;</span>)</span><br><span class="line">                        end_frame = total_frames - <span class="number">1</span></span><br><span class="line">                    <span class="keyword">elif</span> total_frames == <span class="number">0</span> <span class="keyword">and</span> end_frame &gt; <span class="number">0</span>:</span><br><span class="line">                        logger.warning(</span><br><span class="line">                            <span class="string">f&quot;Invalid end_frame <span class="subst">&#123;end_frame&#125;</span> for video with 0 total_frames in <span class="subst">&#123;scenes_file_path&#125;</span> line <span class="subst">&#123;line_number&#125;</span>. Skipping shot.&quot;</span>)</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    <span class="keyword">elif</span> total_frames == <span class="number">0</span> <span class="keyword">and</span> end_frame == <span class="number">0</span> <span class="keyword">and</span> start_frame == <span class="number">0</span>:  <span class="comment"># Special case for 0-frame video if it somehow yields a (0,0) shot</span></span><br><span class="line">                        <span class="keyword">pass</span>  <span class="comment"># Allow (0,0) for a 0-frame video if that&#x27;s a possible output</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> start_frame &gt; end_frame:</span><br><span class="line">                        logger.warning(</span><br><span class="line">                            <span class="string">f&quot;Invalid shot (start_frame <span class="subst">&#123;start_frame&#125;</span> &gt; end_frame <span class="subst">&#123;end_frame&#125;</span>) in <span class="subst">&#123;scenes_file_path&#125;</span> line <span class="subst">&#123;line_number&#125;</span>. Skipping shot.&quot;</span>)</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                    shots.append((start_frame, end_frame))</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="comment"># This warning will catch lines that are not two integers.</span></span><br><span class="line">                    logger.warning(</span><br><span class="line">                        <span class="string">f&quot;Malformed line in scenes file &#x27;<span class="subst">&#123;scenes_file_path&#125;</span>&#x27; line <span class="subst">&#123;line_number&#125;</span>: &#x27;<span class="subst">&#123;stripped_line&#125;</span>&#x27;. Expected two integers separated by space.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Error reading or parsing scenes file <span class="subst">&#123;scenes_file_path&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> shots:</span><br><span class="line">        logger.warning(</span><br><span class="line">            <span class="string">f&quot;No valid shots derived from scenes file: <span class="subst">&#123;scenes_file_path&#125;</span>. Assuming single shot for the entire video.&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> total_frames &gt; <span class="number">0</span>:</span><br><span class="line">            shots.append((<span class="number">0</span>, total_frames - <span class="number">1</span>))</span><br><span class="line">        <span class="comment"># If total_frames is 0, shots will remain empty, which is correct.</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># Sort shots by start frame, just in case they are not ordered in the file</span></span><br><span class="line">        shots.sort(key=<span class="keyword">lambda</span> x: x[<span class="number">0</span>])</span><br><span class="line">        logger.info(</span><br><span class="line">            <span class="string">f&quot;Detected <span class="subst">&#123;<span class="built_in">len</span>(shots)&#125;</span> shots for <span class="subst">&#123;os.path.basename(scenes_file_path)&#125;</span> (start_frame, end_frame_inclusive): <span class="subst">&#123;shots&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> shots</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cut_video_into_shots</span>(<span class="params">video_path, shots, video_output_dir, padding_ms=<span class="number">500</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Cuts the video into shots using ffmpeg based on frame numbers.</span></span><br><span class="line"><span class="string">    The start and end of each shot are REDUCED by padding_ms.</span></span><br><span class="line"><span class="string">    (Note: The &#x27;padding_ms&#x27; parameter is used here as a reduction amount).</span></span><br><span class="line"><span class="string">    Saves shots into the video_specific output directory.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    video_basename = Path(video_path).stem</span><br><span class="line">    logger.info(<span class="string">f&quot;Starting to cut <span class="subst">&#123;<span class="built_in">len</span>(shots)&#125;</span> shots for video: <span class="subst">&#123;video_basename&#125;</span>, REDUCING each end by <span class="subst">&#123;padding_ms&#125;</span>ms.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Get video properties (FPS and total frames) once</span></span><br><span class="line">    cap = cv2.VideoCapture(video_path)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cap.isOpened():</span><br><span class="line">        logger.error(<span class="string">f&quot;Could not open video <span class="subst">&#123;video_path&#125;</span> for properties. Skipping cutting.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    fps = cap.get(cv2.CAP_PROP_FPS)</span><br><span class="line">    video_total_frames = <span class="built_in">int</span>(cap.get(cv2.CAP_PROP_FRAME_COUNT))</span><br><span class="line">    cap.release()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> fps &gt; <span class="number">0</span>:</span><br><span class="line">        logger.error(<span class="string">f&quot;Could not determine FPS for <span class="subst">&#123;video_path&#125;</span>. Skipping reduction cut.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> video_total_frames == <span class="number">0</span>:</span><br><span class="line">        logger.error(<span class="string">f&quot;Video <span class="subst">&#123;video_path&#125;</span> has 0 frames. Skipping cutting.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Convert the reduction amount from milliseconds to frames</span></span><br><span class="line">    reduction_frames = <span class="built_in">round</span>(padding_ms / <span class="number">1000</span> * fps)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, (start_frame, end_frame) <span class="keyword">in</span> <span class="built_in">enumerate</span>(tqdm(shots, desc=<span class="string">f&quot;Cutting shots for <span class="subst">&#123;video_basename&#125;</span>&quot;</span>, unit=<span class="string">&quot;shot&quot;</span>)):</span><br><span class="line">        start_frame = <span class="built_in">int</span>(start_frame)</span><br><span class="line">        end_frame = <span class="built_in">int</span>(end_frame)  <span class="comment"># Inclusive end frame from parse_scenes_file</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Calculate new target start and end frames after reduction</span></span><br><span class="line">        target_start_frame = start_frame + reduction_frames</span><br><span class="line">        target_end_frame = end_frame - reduction_frames  <span class="comment"># This will also be an inclusive frame index</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Check if the shot is too short for the reduction, making it invalid</span></span><br><span class="line">        <span class="keyword">if</span> target_end_frame &lt; target_start_frame:</span><br><span class="line">            logger.warning(</span><br><span class="line">                <span class="string">f&quot;Shot <span class="subst">&#123;i + <span class="number">1</span>&#125;</span> (original: <span class="subst">&#123;start_frame&#125;</span>-<span class="subst">&#123;end_frame&#125;</span>) is too short to apply <span class="subst">&#123;padding_ms&#125;</span>ms reduction &quot;</span></span><br><span class="line">                <span class="string">f&quot;from both ends (would result in invalid segment: <span class="subst">&#123;target_start_frame&#125;</span>-<span class="subst">&#123;target_end_frame&#125;</span>). &quot;</span></span><br><span class="line">                <span class="string">f&quot;Original duration: <span class="subst">&#123;(end_frame - start_frame + <span class="number">1</span>) / fps:<span class="number">.2</span>f&#125;</span>s. Skipping this shot.&quot;</span></span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Clamp the target frames to the video&#x27;s actual boundaries</span></span><br><span class="line">        <span class="comment"># (0 to video_total_frames - 1)</span></span><br><span class="line">        final_start_frame = <span class="built_in">max</span>(<span class="number">0</span>, target_start_frame)</span><br><span class="line">        final_start_frame = <span class="built_in">min</span>(final_start_frame, video_total_frames - <span class="number">1</span>)  <span class="comment"># Ensure start isn&#x27;t past video end</span></span><br><span class="line"></span><br><span class="line">        final_end_frame = <span class="built_in">min</span>(video_total_frames - <span class="number">1</span>, target_end_frame)</span><br><span class="line">        final_end_frame = <span class="built_in">max</span>(<span class="number">0</span>, final_end_frame)  <span class="comment"># Ensure end isn&#x27;t before video start</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Re-check validity after clamping.</span></span><br><span class="line">        <span class="comment"># This handles cases where clamping itself might make the segment invalid.</span></span><br><span class="line">        <span class="keyword">if</span> final_end_frame &lt; final_start_frame:</span><br><span class="line">            logger.warning(</span><br><span class="line">                <span class="string">f&quot;Shot <span class="subst">&#123;i + <span class="number">1</span>&#125;</span> (original: <span class="subst">&#123;start_frame&#125;</span>-<span class="subst">&#123;end_frame&#125;</span>) became invalid after reduction and clamping to video boundaries: &quot;</span></span><br><span class="line">                <span class="string">f&quot;intended reduced (<span class="subst">&#123;target_start_frame&#125;</span>-<span class="subst">&#123;target_end_frame&#125;</span>), &quot;</span></span><br><span class="line">                <span class="string">f&quot;clamped to (<span class="subst">&#123;final_start_frame&#125;</span>-<span class="subst">&#123;final_end_frame&#125;</span>). Skipping this shot.&quot;</span></span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        output_shot_filename = <span class="string">f&quot;<span class="subst">&#123;video_basename&#125;</span>_shot_<span class="subst">&#123;i + <span class="number">1</span>:03d&#125;</span>.mp4&quot;</span></span><br><span class="line">        output_shot_path = os.path.join(video_output_dir, output_shot_filename)</span><br><span class="line"></span><br><span class="line">        logger.debug(</span><br><span class="line">            <span class="string">f&quot;Preparing to cut shot <span class="subst">&#123;i + <span class="number">1</span>&#125;</span>: original (<span class="subst">&#123;start_frame&#125;</span>-<span class="subst">&#123;end_frame&#125;</span>), &quot;</span></span><br><span class="line">            <span class="string">f&quot;target reduced frames (<span class="subst">&#123;final_start_frame&#125;</span>-<span class="subst">&#123;final_end_frame&#125;</span>) -&gt; <span class="subst">&#123;output_shot_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        ffmpeg_command = [</span><br><span class="line">            <span class="string">&quot;ffmpeg&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-loglevel&quot;</span>, <span class="string">&quot;error&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-i&quot;</span>, video_path,</span><br><span class="line">            <span class="string">&quot;-vf&quot;</span>, <span class="string">f&quot;select=&#x27;between(n,<span class="subst">&#123;final_start_frame&#125;</span>,<span class="subst">&#123;final_end_frame&#125;</span>)&#x27;,setpts=PTS-STARTPTS&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-af&quot;</span>, <span class="string">f&quot;aselect=&#x27;between(n,<span class="subst">&#123;final_start_frame&#125;</span>,<span class="subst">&#123;final_end_frame&#125;</span>)&#x27;,asetpts=PTS-STARTPTS&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-c:v&quot;</span>, <span class="string">&quot;libx264&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-preset&quot;</span>, <span class="string">&quot;ultrafast&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-crf&quot;</span>, <span class="string">&quot;23&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-c:a&quot;</span>, <span class="string">&quot;aac&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-y&quot;</span>,  <span class="comment"># Overwrite output files without asking</span></span><br><span class="line">            output_shot_path</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            process = subprocess.Popen(ffmpeg_command, stdout=subprocess.PIPE, stderr=subprocess.PIPE)</span><br><span class="line">            stdout_bytes, stderr_bytes = process.communicate(timeout=<span class="number">300</span>)</span><br><span class="line"></span><br><span class="line">            stdout = stdout_bytes.decode(errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">            stderr = stderr_bytes.decode(errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> process.returncode != <span class="number">0</span>:</span><br><span class="line">                logger.error(<span class="string">f&quot;ffmpeg failed for shot <span class="subst">&#123;output_shot_filename&#125;</span>:&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> stderr.strip(): logger.error(<span class="string">f&quot;FFMPEG STDERR: <span class="subst">&#123;stderr.strip()&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> stdout.strip(): logger.error(<span class="string">f&quot;FFMPEG STDOUT: <span class="subst">&#123;stdout.strip()&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                logger.info(<span class="string">f&quot;Successfully created <span class="subst">&#123;output_shot_filename&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> subprocess.TimeoutExpired:</span><br><span class="line">            logger.error(<span class="string">f&quot;ffmpeg timed out for shot <span class="subst">&#123;output_shot_filename&#125;</span>.&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> process:</span><br><span class="line">                process.kill()</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    stdout_bytes, stderr_bytes = process.communicate(timeout=<span class="number">5</span>)</span><br><span class="line">                    stdout = stdout_bytes.decode(errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">                    stderr = stderr_bytes.decode(errors=<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">                    <span class="keyword">if</span> stderr.strip(): logger.error(<span class="string">f&quot;FFMPEG STDERR (on timeout kill): <span class="subst">&#123;stderr.strip()&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="keyword">if</span> stdout.strip(): logger.error(<span class="string">f&quot;FFMPEG STDOUT (on timeout kill): <span class="subst">&#123;stdout.strip()&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e_comm_kill:</span><br><span class="line">                    logger.error(<span class="string">f&quot;Error getting output after ffmpeg timeout kill: <span class="subst">&#123;e_comm_kill&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;Exception during ffmpeg processing for shot <span class="subst">&#123;output_shot_filename&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">f&quot;Finished cutting <span class="subst">&#123;<span class="built_in">len</span>(shots)&#125;</span> shots for video: <span class="subst">&#123;video_basename&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(</span><br><span class="line">        description=<span class="string">&quot;Process videos using TransNetV2 to detect shot boundaries and cut the videos into shots.&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;input_source&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;Path to a directory containing video files to process.&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--transnet_script&quot;</span>, required=<span class="literal">False</span>, default=<span class="string">&quot;inference/transnetv2.py&quot;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;Path to the transnetv2.py script.&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--model_dir&quot;</span>, required=<span class="literal">False</span>, default=<span class="string">&quot;inference/transnetv2-weights&quot;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;Path to the TransNetV2 model directory.&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--output_dir&quot;</span>, required=<span class="literal">False</span>, default=<span class="string">&quot;./r&quot;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;Base directory to output processed videos.  A subdirectory will be created for each video.&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--log_file&quot;</span>, required=<span class="literal">False</span>, default=<span class="string">&quot;my_processing_log.txt&quot;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;Path to the log file.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- æ—¥å¿—æ–‡ä»¶è®¾ç½® ---</span></span><br><span class="line">    log_file_path = args.log_file</span><br><span class="line">    log_dir = os.path.dirname(log_file_path)  <span class="comment"># è·å–æ—¥å¿—æ–‡ä»¶æ‰€åœ¨ç›®å½•</span></span><br><span class="line">    <span class="keyword">if</span> log_dir <span class="keyword">and</span> <span class="keyword">not</span> os.path.exists(log_dir):</span><br><span class="line">        os.makedirs(log_dir)  <span class="comment"># å¦‚æœæ—¥å¿—ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºå®ƒ</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ›å»ºä¸€ä¸ªfile handlerï¼Œå°†æ—¥å¿—å†™å…¥æ–‡ä»¶</span></span><br><span class="line">    file_handler = logging.FileHandler(log_file_path, encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    file_handler.setLevel(logging.INFO)  <span class="comment"># è®¾ç½®æ—¥å¿—çº§åˆ«ä¸ºINFO</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ›å»ºä¸€ä¸ªformatterå¹¶å°†å…¶æ·»åŠ åˆ°handler</span></span><br><span class="line">    formatter = logging.Formatter(<span class="string">&#x27;%(asctime)s - %(levelname)s - %(filename)s:%(lineno)d - %(message)s&#x27;</span>,</span><br><span class="line">                                  datefmt=<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>)</span><br><span class="line">    file_handler.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å°†handleræ·»åŠ åˆ°logger</span></span><br><span class="line">    logger.addHandler(file_handler)</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">&quot;Script started.&quot;</span>)</span><br><span class="line">    logger.info(<span class="string">f&quot;Arguments: <span class="subst">&#123;args&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    input_source = args.input_source</span><br><span class="line">    transnet_script = args.transnet_script</span><br><span class="line">    model_dir = args.model_dir</span><br><span class="line">    output_dir = args.output_dir</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(output_dir):</span><br><span class="line">        os.makedirs(output_dir)</span><br><span class="line">        logger.info(<span class="string">f&quot;Created base output directory: <span class="subst">&#123;output_dir&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.info(<span class="string">f&quot;Base output directory already exists: <span class="subst">&#123;output_dir&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    video_files = find_video_files(input_source, output_dir_to_skip=output_dir)  <span class="comment"># æ’é™¤ output_dir</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> video_files:</span><br><span class="line">        logger.warning(<span class="string">&quot;No video files found to process.&quot;</span>)</span><br><span class="line">        logger.info(<span class="string">&quot;All processing complete.&quot;</span>)</span><br><span class="line">        exit()</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">f&quot;Processing <span class="subst">&#123;<span class="built_in">len</span>(video_files)&#125;</span> video(s)...&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> video_path <span class="keyword">in</span> video_files:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># --- è§†é¢‘ç‰¹å®šå¤„ç†å¼€å§‹ ---</span></span><br><span class="line">            video_basename = Path(video_path).stem</span><br><span class="line">            logger.info(<span class="string">f&quot;--- Starting processing for video: <span class="subst">&#123;video_path&#125;</span> ---&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># ä¸ºå½“å‰è§†é¢‘åˆ›å»ºå¤„ç†ç›®å½•å’Œè¾“å‡ºç›®å½•</span></span><br><span class="line">            video_output_dir = os.path.join(output_dir, video_basename)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(video_output_dir):</span><br><span class="line">                os.makedirs(video_output_dir)</span><br><span class="line">                logger.info(<span class="string">f&quot;Created processing/output directory for this video: <span class="subst">&#123;video_output_dir&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                logger.info(<span class="string">f&quot;Processing/output directory already exists: <span class="subst">&#123;video_output_dir&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            total_frames = get_total_frames(video_path)</span><br><span class="line">            <span class="keyword">if</span> total_frames <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> total_frames == <span class="number">0</span>:</span><br><span class="line">                logger.error(</span><br><span class="line">                    <span class="string">f&quot;Cannot process video <span class="subst">&#123;video_path&#125;</span> as it has no frames or could not be read. Skipping.&quot;</span>)</span><br><span class="line">                <span class="keyword">continue</span>  <span class="comment"># Skip to the next video</span></span><br><span class="line">            logger.info(<span class="string">f&quot;Total frames in <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;total_frames&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># è¿è¡Œ TransNetV2 æ¨ç†</span></span><br><span class="line">            scenes_file = run_transnet_inference(video_path, transnet_script, model_dir,</span><br><span class="line">                                                 working_directory=video_output_dir)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> scenes_file <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                logger.error(<span class="string">f&quot;Failed to get scenes file for <span class="subst">&#123;video_path&#125;</span>. Skipping this video.&quot;</span>)</span><br><span class="line">                <span class="keyword">continue</span>  <span class="comment"># Skip to the next video</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># è§£æåœºæ™¯æ–‡ä»¶</span></span><br><span class="line">            shots = parse_scenes_file(scenes_file, total_frames)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># å°†è§†é¢‘å‰ªåˆ‡æˆé•œå¤´</span></span><br><span class="line">            cut_video_into_shots(video_path, shots, video_output_dir, padding_ms=<span class="number">500</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;An unexpected error occurred while processing <span class="subst">&#123;video_path&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">&quot;All processing complete.&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>æ£€æµ‹è¾“å‡ºç»“æœ</li></ul><p><img src="/2025/06/09/TransNetV2-model-use/test-result.png" class="lazyload placeholder" data-srcset="/2025/06/09/TransNetV2-model-use/test-result.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="See">See</h2><ul><li>1.<a href="https://arxiv.org/pdf/2008.04838">https://arxiv.org/pdf/2008.04838</a></li><li>2.<a href="https://github.com/soCzech/TransNetV2/tree/master">https://github.com/soCzech/TransNetV2/tree/master</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;TransNet-V2-æ¨¡å‹ä»‹ç»&quot;&gt;TransNet V2 æ¨¡å‹ä»‹ç»&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;ç›®æ ‡ï¼š&lt;br&gt;
TransNet V2 çš„ç›®æ ‡æ˜¯åˆ›å»ºä¸€ä¸ªå¿«é€Ÿä¸”å‡†ç¡®çš„é•œå¤´è¾¹ç•Œæ£€æµ‹ï¼ˆShot Boundary Detection, SBDï¼‰æ¨¡å‹ã€‚å®ƒèƒ½å¤Ÿè¯†åˆ«è§†é¢‘ä¸­çš„ä¸¤</summary>
      
    
    
    
    
    <category term="python" scheme="https://caozhaoqi.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>åœºæ™¯æ£€æµ‹æ€§èƒ½ä¼˜åŒ–æ–¹å‘ä¸æµ‹è¯•æ–¹æ³•</title>
    <link href="https://caozhaoqi.github.io/2025/05/30/scene-detect-benchmark/"/>
    <id>https://caozhaoqi.github.io/2025/05/30/scene-detect-benchmark/</id>
    <published>2025-05-30T08:44:00.000Z</published>
    <updated>2025-11-25T15:05:10.347Z</updated>
    
    <content type="html"><![CDATA[<h1>åœºæ™¯æ£€æµ‹æ€§èƒ½ä¼˜åŒ–æ–¹å‘ä¸æµ‹è¯•æ–¹æ³•</h1><h2 id="1-å¼•è¨€">1. å¼•è¨€</h2><p>æœ¬æŒ‡å—æ—¨åœ¨æä¾›ä¸€å¥—ç³»ç»ŸåŒ–çš„æ–¹æ³•ï¼Œç”¨äºéªŒè¯å’Œåˆ†æè§†é¢‘å¤„ç†é¡¹ç›®çš„æ•ˆç‡ï¼Œç‰¹åˆ«æ˜¯é’ˆå¯¹åœºæ™¯æ£€æµ‹æ¨¡å—çš„æ€§èƒ½ã€‚é€šè¿‡æ”¶é›†å…³é”®æ€§èƒ½æŒ‡æ ‡ (KPIs)<br>å’Œå‰–æä»£ç æ‰§è¡Œï¼Œæˆ‘ä»¬å¯ä»¥è¯†åˆ«æ€§èƒ½ç“¶é¢ˆï¼Œå¹¶ä¸ºåç»­çš„ä»£ç ä¼˜åŒ–æä¾›æ•°æ®æ”¯æŒã€‚</p><h2 id="2-å‡†å¤‡å·¥ä½œ">2. å‡†å¤‡å·¥ä½œ</h2><h3 id="2-1-å®šä¹‰å…³é”®æ€§èƒ½æŒ‡æ ‡-KPIs">2.1. å®šä¹‰å…³é”®æ€§èƒ½æŒ‡æ ‡ (KPIs)</h3><p>åœ¨å¼€å§‹æµ‹è¯•å‰ï¼Œæ˜ç¡®éœ€è¦è¡¡é‡çš„æ€§èƒ½æŒ‡æ ‡ï¼š</p><ul><li>æ€»å¤„ç†æ—¶é—´ (End-to-End Time)*è¡¡é‡å•ä¸ªè§†é¢‘ä»åœºæ™¯æ£€æµ‹å¼€å§‹åˆ°ç»“æŸçš„æ€»è€—æ—¶ã€‚</li><li>åœºæ™¯æ£€æµ‹å‡½æ•°è€—æ—¶<code>detect_scenes</code> å‡½æ•°çš„ç²¾ç¡®æ‰§è¡Œæ—¶é—´ã€‚</li><li>CPU ä½¿ç”¨ç‡åœºæ™¯æ£€æµ‹è¿‡ç¨‹ä¸­çš„å¹³å‡å’Œå³°å€¼ CPU ä½¿ç”¨ç‡ã€‚</li><li>å†…å­˜ä½¿ç”¨é‡ åœºæ™¯æ£€æµ‹è¿‡ç¨‹ä¸­çš„å³°å€¼å’Œå¹³å‡å†…å­˜æ¶ˆè€—ã€‚</li><li>GPU ä½¿ç”¨ç‡ (è‹¥å¯ç”¨)ï¼šGPU è®¡ç®—å•å…ƒå’Œæ˜¾å­˜çš„ä½¿ç”¨ç‡ã€‚</li><li>æ£€æµ‹åˆ°çš„åœºæ™¯æ•°ä½œä¸ºæ£€æµ‹ç»“æœçš„ä¸€ä¸ªåŸºæœ¬è¡¡é‡ã€‚</li><li>æ£€æµ‹æ—¶ä½¿ç”¨çš„å¸§ç‡è®°å½• <code>detect_scenes</code> å†…éƒ¨å®é™…ä½¿ç”¨çš„è§†é¢‘å¸§ç‡ã€‚</li></ul><h3 id="2-2-é€‰æ‹©æµ‹è¯•æ•°æ®é›†">2.2. é€‰æ‹©æµ‹è¯•æ•°æ®é›†</h3><ul><li>å¤šæ ·æ€§ å‡†å¤‡ä¸€ç»„åŒ…å«ä¸åŒç‰¹å¾çš„è§†é¢‘æ–‡ä»¶ï¼š<ul><li>ä¸åŒåˆ†è¾¨ç‡ (ä¾‹å¦‚ï¼š720p, 1080p, 4K)ã€‚</li><li>ä¸åŒç¼–ç æ ¼å¼ (ä¾‹å¦‚ï¼šH.264, HEVC)ã€‚</li><li>ä¸åŒæ—¶é•¿ (ä¾‹å¦‚ï¼šçŸ­è§†é¢‘ &lt; 1åˆ†é’Ÿï¼Œä¸­ç­‰è§†é¢‘ 5-10åˆ†é’Ÿï¼Œé•¿è§†é¢‘ &gt; 30åˆ†é’Ÿ)ã€‚</li><li>ä¸åŒåœºæ™¯å¤æ‚åº¦ (ä¾‹å¦‚ï¼šåœºæ™¯åˆ‡æ¢é¢‘ç¹çš„é¢„å‘Šç‰‡ï¼Œåœºæ™¯åˆ‡æ¢è¾ƒå°‘çš„è®²åº§è§†é¢‘)ã€‚</li></ul></li><li>ä»£è¡¨æ€§ æµ‹è¯•è§†é¢‘åº”èƒ½ä»£è¡¨é¡¹ç›®å®é™…åº”ç”¨ä¸­å¸¸è§çš„è§†é¢‘ç±»å‹ã€‚</li><li>å¯é‡å¤æ€§ ä½¿ç”¨å›ºå®šçš„è§†é¢‘é›†è¿›è¡Œæ‰€æœ‰æµ‹è¯•ï¼Œä»¥ä¾¿æ¯”è¾ƒä¸åŒä¼˜åŒ–ç‰ˆæœ¬çš„æ•ˆæœã€‚</li></ul><h3 id="2-3-æ­å»ºæµ‹è¯•ç¯å¢ƒ">2.3. æ­å»ºæµ‹è¯•ç¯å¢ƒ</h3><ul><li>ç¡¬ä»¶ä¸€è‡´æ€§ æ‰€æœ‰åŸºå‡†æµ‹è¯•åº”åœ¨åŒä¸€å°æœºå™¨ä¸Šè¿›è¡Œï¼Œä»¥æ¶ˆé™¤ç¡¬ä»¶å·®å¼‚ã€‚è®°å½•æµ‹è¯•æœºå™¨çš„ CPUã€å†…å­˜ã€GPUå‹å·ã€ç£ç›˜ç±»å‹ç­‰è§„æ ¼ã€‚</li><li>è½¯ä»¶ç¯å¢ƒä¸€è‡´æ€§ ç¡®ä¿ Python ç‰ˆæœ¬ã€æ“ä½œç³»ç»Ÿä»¥åŠæ‰€æœ‰ç›¸å…³ä¾èµ–åº“ (å¦‚ PySceneDetect, OpenCV, FFmpeg) çš„ç‰ˆæœ¬åœ¨æµ‹è¯•æœŸé—´ä¿æŒä¸å˜ã€‚å¯ä»¥ä»<br><code>requirements.txt</code> æ–‡ä»¶ä¸­è·å–ä¾èµ–åˆ—è¡¨ã€‚</li><li>ç¯å¢ƒéš”ç¦» æµ‹è¯•æ—¶ï¼Œå°½é‡å…³é—­å…¶ä»–ä¸å¿…è¦çš„åº”ç”¨ç¨‹åºï¼Œä»¥å‡å°‘å¯¹æµ‹è¯•ç»“æœçš„å¹²æ‰°ã€‚</li></ul><h3 id="2-4-é…ç½®æµ‹è¯•å‚æ•°">2.4. é…ç½®æµ‹è¯•å‚æ•°</h3><ul><li><code>config.ini</code> åŸºå‡†æµ‹è¯•è„šæœ¬ä¼šåŠ è½½æ­¤æ–‡ä»¶ã€‚ç¡®ä¿å…¶ä¸­çš„è·¯å¾„é…ç½® (å¦‚ <code>ffmpeg_path</code>, <code>ffprobe_path</code>) å’Œé»˜è®¤çš„æ£€æµ‹å™¨å‚æ•°æ˜¯ä½ æƒ³è¦æµ‹è¯•çš„åŸºç¡€é…ç½®ã€‚</li><li>æµ‹è¯•è„šæœ¬å†…é…ç½® <code>benchmark_scene_detector.py</code> è„šæœ¬å…è®¸å®šä¹‰å¤šç§æµ‹è¯•é…ç½® ( <code>configurations_to_test</code> åˆ—è¡¨)ï¼Œä¾‹å¦‚ï¼š<ul><li>CPU vs GPU è§£ç ã€‚</li><li>ä½¿ç”¨ä¸åŒçš„æ£€æµ‹å™¨ç»„åˆ (ä¾‹å¦‚ï¼Œä»… <code>ContentDetector</code> vs <code>MultiDetector</code> å…¨å¯ç”¨)ã€‚</li><li>ä¸åŒçš„æ£€æµ‹å™¨å‚æ•° (ä¾‹å¦‚ï¼Œä¸åŒçš„ <code>threshold</code> æˆ– <code>min_scene_len_frames</code>)ã€‚</li></ul></li></ul><h2 id="3-æµ‹è¯•æ‰§è¡Œ">3. æµ‹è¯•æ‰§è¡Œ</h2><h3 id="3-1-æµ‹è¯•è„šæœ¬ï¼šbenchmark-scene-detector-py">3.1. æµ‹è¯•è„šæœ¬ï¼š<code>benchmark_scene_detector.py</code></h3><ul><li>åŸºç¡€åº“å®‰è£…</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install memory-profiler psutil snakeviz # snakeviz ç”¨äºå¯è§†åŒ– cProfile ç»“æœ</span><br><span class="line">    </span><br></pre></td></tr></table></figure><ul><li>åŸºå‡†æµ‹è¯•è„šæœ¬è¿è¡Œ</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python src/video/benchmark_scene_detector.py</span><br></pre></td></tr></table></figure><ul><li>æ€§èƒ½åˆ†æ</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python -m pstats profiling_results/profile_your_test_video1_Config_Default_CPU.prof</span><br><span class="line">    </span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">snakeviz profiling_results/profile_your_test_video1_Config_Default_CPU.prof</span><br></pre></td></tr></table></figure><h3 id="3-2-æ€§èƒ½å‰–æ-Profiling">3.2. æ€§èƒ½å‰–æ (Profiling)</h3><ul><li>å½“æµ‹è¯•é…ç½®ä¸­ <code>&quot;profile&quot;: True</code> æ—¶ï¼Œè„šæœ¬ä¼šä¸ºè¯¥æ¬¡è¿è¡Œç”Ÿæˆä¸€ä¸ª <code>.prof</code> æ–‡ä»¶ï¼Œä¿å­˜åœ¨ <code>profiling_results</code> ç›®å½•ä¸‹ã€‚</li><li>è¿™äº›æ–‡ä»¶åŒ…å«äº†å‡½æ•°è°ƒç”¨æ¬¡æ•°ã€æ¯æ¬¡è°ƒç”¨çš„è€—æ—¶ã€ç´¯è®¡è€—æ—¶ç­‰è¯¦ç»†ä¿¡æ¯ã€‚</li></ul><h3 id="3-3-èµ„æºç›‘æ§">3.3. èµ„æºç›‘æ§</h3><ul><li>æ‰‹åŠ¨ç›‘æ§ åœ¨æµ‹è¯•è„šæœ¬è¿è¡Œæ—¶ï¼Œä½¿ç”¨æ“ä½œç³»ç»Ÿè‡ªå¸¦çš„å·¥å…·ï¼ˆå¦‚ Windows çš„ä»»åŠ¡ç®¡ç†å™¨ï¼ŒLinux çš„ <code>top</code>/<code>htop</code>ï¼ŒmacOS çš„æ´»åŠ¨ç›‘è§†å™¨ï¼‰è§‚å¯Ÿ<br>CPU å’Œå†…å­˜çš„å®æ—¶ä½¿ç”¨æƒ…å†µã€‚</li><li>GPU ç›‘æ§ å¦‚æœæµ‹è¯• GPU åŠ é€Ÿï¼Œä½¿ç”¨ç‰¹å®šäº GPU å‚å•†çš„å·¥å…·ï¼ˆå¦‚ NVIDIA çš„ <code>nvidia-smi</code>ï¼‰ç›‘æ§ GPU åˆ©ç”¨ç‡å’Œæ˜¾å­˜ä½¿ç”¨ã€‚</li><li>è„šæœ¬å†…ç›‘æ§ (å¯é€‰) å¯ä»¥ä¿®æ”¹ <code>benchmark_scene_detector.py</code>ï¼Œä½¿ç”¨ <code>psutil</code> åº“åœ¨è°ƒç”¨ <code>detect_scenes</code> å‰åè®°å½•è¿›ç¨‹çš„ CPU<br>å’Œå†…å­˜å¿«ç…§ï¼Œä»¥è·å¾—æ›´ç²¾ç¡®çš„æ•°æ®ã€‚</li></ul><h3 id="3-4-æ¯”è¾ƒè€—æ—¶ï¼š">3.4 æ¯”è¾ƒè€—æ—¶ï¼š</h3><ul><li>å¯¹æ¯” CPU å’Œ GPU é…ç½®ä¸‹çš„è€—æ—¶ï¼Œè¯„ä¼° GPU åŠ é€Ÿçš„å®é™…æ•ˆæœã€‚ä»ç¤ºä¾‹è¾“å‡ºæ¥çœ‹ï¼Œå¯¹äºâ€œå»ºç­‘å®¶å›­-02.mp4â€ï¼Œä½¿ç”¨ GPU (<br>Config_Default_GPU) å°†å¤„ç†æ—¶é—´ä»çº¦ 15.1 ç§’é™ä½åˆ°äº†çº¦ 8.6 ç§’ï¼Œæœ‰æ˜¾è‘—æå‡ã€‚</li><li>å¯¹æ¯”ä¸åŒæ£€æµ‹å™¨ç»„åˆæˆ–å‚æ•°ä¸‹çš„è€—æ—¶ã€‚ä¾‹å¦‚ï¼ŒConfig_ContentDetectorOnly_CPU (ä»…ä½¿ç”¨ ContentDetector) çš„è€—æ—¶çº¦ä¸º 5.4 ç§’ï¼Œè¿œå¿«äºä½¿ç”¨<br>MultiDetector çš„ Config_Default_CPU (15.1 ç§’)ï¼Œä½†æ£€æµ‹åˆ°çš„åœºæ™¯æ•°ä¹Ÿä» 12 ä¸ªå‡å°‘åˆ°äº† 9 ä¸ªã€‚è¿™éœ€è¦åœ¨é€Ÿåº¦å’Œæ£€æµ‹å…¨é¢æ€§ä¹‹é—´è¿›è¡Œæƒè¡¡ã€‚</li><li>è§‚å¯Ÿä¸åŒç‰¹æ€§è§†é¢‘ï¼ˆå¦‚æ—¶é•¿ã€åˆ†è¾¨ç‡ï¼‰å¯¹å¤„ç†æ—¶é—´çš„å½±å“ï¼ˆéœ€è¦æ›´å¤šæµ‹è¯•è§†é¢‘æ ·æœ¬æ¥åˆ†ææ­¤é¡¹ï¼‰ã€‚4.2. åˆ†ææ€§èƒ½å‰–æ (.prof) æ–‡ä»¶ä½¿ç”¨<br>Python çš„ pstats æ¨¡å—æˆ– snakeviz å·¥å…·æ¥åˆ†æ .prof æ–‡ä»¶ã€‚ä½¿ç”¨ pstats (å‘½ä»¤è¡Œ)ï¼š</li></ul><h2 id="4-ç»“æœåˆ†æ">4. ç»“æœåˆ†æ</h2><h3 id="4-1-åˆ†æåŸºå‡†æµ‹è¯•æ—¥å¿—">4.1. åˆ†æåŸºå‡†æµ‹è¯•æ—¥å¿—</h3><blockquote><p>è„šæœ¬æ‰§è¡Œå®Œæ¯•åï¼Œä¼šæ‰“å°ä¸€ä¸ªæ€»ç»“æŠ¥å‘Šï¼Œæ˜¾ç¤ºæ¯ä¸ªè§†é¢‘åœ¨ä¸åŒé…ç½®ä¸‹çš„å¤„ç†æ—¶é•¿å’Œæ£€æµ‹åˆ°çš„åœºæ™¯æ•°ã€‚</p></blockquote><h4 id="åœ¨-pstats-äº¤äº’å¼-shell-ä¸­ï¼Œå¸¸ç”¨å‘½ä»¤ï¼š">åœ¨ pstats äº¤äº’å¼ shell ä¸­ï¼Œå¸¸ç”¨å‘½ä»¤ï¼š</h4><ul><li>sort cumulative: æŒ‰ç´¯è®¡è€—æ—¶æ’åºã€‚</li><li>stats 20: æ˜¾ç¤ºè€—æ—¶æœ€å¤šçš„å‰ 20 ä¸ªå‡½æ•°ã€‚</li><li>callers function_name: æŸ¥çœ‹å“ªäº›å‡½æ•°è°ƒç”¨äº† function_nameã€‚</li><li>callees function_name: æŸ¥çœ‹ function_name è°ƒç”¨äº†å“ªäº›å‡½æ•°ã€‚</li></ul><h4 id="ä½¿ç”¨-snakeviz-Web-ç•Œé¢ï¼Œæ¨è-ï¼š">ä½¿ç”¨ snakeviz (Web ç•Œé¢ï¼Œæ¨è)ï¼š</h4><ul><li><p>æ¯”è¾ƒè€—æ—¶</p><ul><li>å¯¹æ¯” CPU å’Œ GPU é…ç½®ä¸‹çš„è€—æ—¶ï¼Œè¯„ä¼° GPU åŠ é€Ÿçš„å®é™…æ•ˆæœã€‚ä»ç¤ºä¾‹è¾“å‡ºæ¥çœ‹ï¼Œå¯¹äºâ€œå»ºç­‘å®¶å›­-02.mp4â€ï¼Œä½¿ç”¨ GPU (<br><code>Config_Default_GPU</code>) å°†å¤„ç†æ—¶é—´ä»çº¦ 15.1 ç§’é™ä½åˆ°äº†çº¦ 8.6 ç§’ï¼Œæœ‰æ˜¾è‘—æå‡ã€‚</li><li>å¯¹æ¯”ä¸åŒæ£€æµ‹å™¨ç»„åˆæˆ–å‚æ•°ä¸‹çš„è€—æ—¶ã€‚ä¾‹å¦‚ï¼Œ<code>Config_ContentDetectorOnly_CPU</code> (ä»…ä½¿ç”¨ ContentDetector) çš„è€—æ—¶çº¦ä¸º 5.4<br>ç§’ï¼Œè¿œå¿«äºä½¿ç”¨ <code>MultiDetector</code> çš„ <code>Config_Default_CPU</code> (15.1 ç§’)ï¼Œä½†æ£€æµ‹åˆ°çš„åœºæ™¯æ•°ä¹Ÿä» 12 ä¸ªå‡å°‘åˆ°äº† 9<br>ä¸ªã€‚è¿™éœ€è¦åœ¨é€Ÿåº¦å’Œæ£€æµ‹å…¨é¢æ€§ä¹‹é—´è¿›è¡Œæƒè¡¡ã€‚</li><li>è§‚å¯Ÿä¸åŒç‰¹æ€§è§†é¢‘ï¼ˆå¦‚æ—¶é•¿ã€åˆ†è¾¨ç‡ï¼‰å¯¹å¤„ç†æ—¶é—´çš„å½±å“ï¼ˆéœ€è¦æ›´å¤šæµ‹è¯•è§†é¢‘æ ·æœ¬æ¥åˆ†ææ­¤é¡¹ï¼‰ã€‚</li></ul></li><li><p>æ¯”è¾ƒè€—æ—¶ (Updated Interpretation based on new logs)</p><ul><li>å¯¹æ¯” CPU å’Œ GPU é…ç½®ä¸‹çš„è€—æ—¶ï¼Œè¯„ä¼° GPU åŠ é€Ÿçš„å®é™…æ•ˆæœã€‚ä»æœ€æ–°çš„ç¤ºä¾‹è¾“å‡ºæ¥çœ‹ï¼Œå¯¹äºâ€œå»ºç­‘å®¶å›­-02.mp4â€ (ä¸€ä¸ª60fpsçš„è§†é¢‘):<ul><li><code>Config_Default_CPU</code> (MultiDetector, CPU decode): 433.73 ç§’</li><li><code>Config_Default_GPU</code> (MultiDetector, GPU decode requested): 411.56 ç§’</li><li>è§‚å¯Ÿ: åœ¨è¿™ä¸ªç‰¹å®šçš„æµ‹è¯•ä¸­ (macOS, <code>VideoStreamCv2</code> è¢«ç”¨ä½œå›é€€)ï¼Œè¯·æ±‚ GPU è§£ç ç›¸æ¯”çº¯ CPU è§£ç ç•¥æœ‰æ€§èƒ½æå‡ (çº¦<br>22 ç§’ï¼Œæˆ– 5% çš„æå‡)ã€‚è¿™è¡¨æ˜åœ¨ macOS ä¸Šï¼Œå³ä½¿ PySceneDetect å›é€€åˆ° <code>VideoStreamCv2</code>ï¼Œåº•å±‚çš„ OpenCV å’Œ<br>AVFoundation/VideoToolbox å¯èƒ½ä»ç„¶åˆ©ç”¨äº†ä¸€äº›ç¡¬ä»¶åŠ é€Ÿã€‚ç„¶è€Œï¼Œè¿™ä¸ä¹‹å‰æ—¥å¿—ä¸­åœ¨é macOS ç¯å¢ƒä¸‹ä½¿ç”¨<br><code>VideoStreamCv2Cuda</code> å¯èƒ½å¸¦æ¥çš„æ›´æ˜¾è‘—æå‡æœ‰æ‰€ä¸åŒã€‚æ–‡æ¡£ä¸­åº”æŒ‡å‡ºï¼ŒGPU åŠ é€Ÿçš„æ•ˆæœé«˜åº¦ä¾èµ–äºæ“ä½œç³»ç»Ÿã€OpenCV<br>çš„ç¼–è¯‘é€‰é¡¹ã€PySceneDetect çš„åç«¯é€‰æ‹©ä»¥åŠå…·ä½“çš„ GPU ç¡¬ä»¶ã€‚</li></ul></li><li>å¯¹æ¯”ä¸åŒæ£€æµ‹å™¨ç»„åˆæˆ–å‚æ•°ä¸‹çš„è€—æ—¶ã€‚ä¾‹å¦‚:<ul><li><code>Config_ContentDetectorOnly_CPU</code> (ä»…ä½¿ç”¨ ContentDetector, CPU decode): 400.30 ç§’</li><li>è§‚å¯Ÿ: ä»…ä½¿ç”¨ <code>ContentDetector</code> ä»ç„¶æ˜¯æœ€å¿«çš„é…ç½®ï¼Œæ¯”ä½¿ç”¨ <code>MultiDetector</code> çš„ CPU é…ç½®å¿«äº†çº¦ 33 ç§’ã€‚ä½†æ£€æµ‹åˆ°çš„åœºæ™¯æ•°ä»<br>214 ä¸ªå‡å°‘åˆ°äº† 164 ä¸ªã€‚è¿™å†æ¬¡å¼ºè°ƒäº†åœ¨é€Ÿåº¦å’Œæ£€æµ‹å…¨é¢æ€§/å‡†ç¡®æ€§ä¹‹é—´çš„æƒè¡¡ã€‚</li></ul></li><li>é‡è¦æç¤º:<ul><li>æ—¥å¿—ä¸­å‡ºç° <code>Backend None not available. Trying another backend: opencv</code>ï¼Œå¹¶ä¸”åœ¨è¯·æ±‚ GPU è§£ç æ—¶ï¼Œæœ€ç»ˆä»ç„¶æ˜¯<br><code>opened with VideoStreamCv2</code>ã€‚è¿™è¡¨æ˜åœ¨å½“å‰çš„ macOS æµ‹è¯•ç¯å¢ƒä¸‹ï¼Œ<code>VideoStreamCv2Cuda</code> (å¦‚æœæœŸæœ›ä½¿ç”¨çš„è¯)<br>å¹¶æœªè¢«æˆåŠŸåŠ è½½æˆ–ä½¿ç”¨ï¼ŒPySceneDetect å›é€€åˆ°äº†æ ‡å‡†çš„ OpenCV åç«¯ (<code>VideoStreamCv2</code>)ã€‚æ–‡æ¡£åº”è¯¥æåŠè¿™ä¸€ç‚¹ï¼Œå¹¶å»ºè®®ç”¨æˆ·æ£€æŸ¥å…¶<br>PySceneDetect å’Œ OpenCV (åŒ…æ‹¬ CUDA æ”¯æŒ) çš„å®‰è£…ï¼Œå°¤å…¶æ˜¯åœ¨é macOS ç¯å¢ƒä¸‹æœŸæœ›ä½¿ç”¨ NVIDIA GPU åŠ é€Ÿæ—¶ã€‚</li><li>æ—¥å¿—ä¸­å‡ºç° <code>min_delta_hsv is deprecated, use min_content_val instead.</code> è¿™æ˜¯æ¥è‡ª <code>AdaptiveDetector</code><br>çš„ä¸€ä¸ªè­¦å‘Šã€‚è™½ç„¶ä¸å½±å“åŸºå‡†æµ‹è¯•çš„è€—æ—¶è®°å½•ï¼Œä½†åœ¨æ–‡æ¡£ä¸­æˆ–ä»£ç æ³¨é‡Šä¸­æåŠï¼Œå¹¶å»ºè®®æ›´æ–° <code>config.ini</code> æˆ–<br><code>AdaptiveDetector</code> çš„å‚æ•°ä»¥ä½¿ç”¨æ–°çš„ <code>min_content_val</code> æ˜¯ä¸€ä¸ªå¥½åšæ³•ï¼Œä»¥ä¿æŒä¸åº“æ›´æ–°çš„å…¼å®¹æ€§ã€‚</li></ul></li></ul></li></ul><p>macOSæ€§èƒ½æµ‹è¯•ç»“æœè§£é‡Š:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">/Users/zg/PycharmProjects/scene_detect_split/.venv/bin/python /Users/zg/PycharmProjects/scene_detect_split/src/tests/benchmark_scene_detector.py </span><br><span class="line">2025-05-30 10:46:40.555 | INFO     | config.config:initialize_settings:147 - Configuration successfully loaded from: /Users/zg/PycharmProjects/scene_detect_split/src/run/config.ini</span><br><span class="line">2025-05-30 10:46:40.556 | INFO     | __main__:&lt;module&gt;:118 - Configuration loaded from: /Users/zg/PycharmProjects/scene_detect_split/src/run/config.ini</span><br><span class="line">2025-05-30 10:46:40.556 | INFO     | __main__:&lt;module&gt;:210 - </span><br><span class="line">===== Processing Video: /Volumes/shared/æ ·ä¾‹/CGæ¸²æŸ“æ ·ä¾‹/å»ºç­‘å®¶å›­/å»ºç­‘å®¶å›­-02.mp4 =====</span><br><span class="line">2025-05-30 10:46:40.556 | INFO     | __main__:&lt;module&gt;:214 - --- Running with Configuration: Config_Default_CPU ---</span><br><span class="line">2025-05-30 10:46:40.556 | INFO     | __main__:run_detection_benchmark:50 - --- Benchmarking: å»ºç­‘å®¶å›­-02.mp4 ---</span><br><span class="line">2025-05-30 10:46:40.556 | INFO     | __main__:run_detection_benchmark:51 - Detector Setup: MultiDetector</span><br><span class="line">2025-05-30 10:46:40.556 | INFO     | __main__:run_detection_benchmark:52 - Using GPU for OpenCV decode: False</span><br><span class="line">2025-05-30 10:46:40.556 | INFO     | video.scene_detector:detect_scenes:69 - [MainThread] Starting detect_scenes for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;</span><br><span class="line">Backend None not available.</span><br><span class="line">Trying another backend: opencv</span><br><span class="line">2025-05-30 10:46:40.720 | INFO     | video.scene_detector:detect_scenes:99 - [MainThread] Video &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27; opened with VideoStreamCv2.</span><br><span class="line">2025-05-30 10:46:40.720 | INFO     | video.scene_detector:detect_scenes:126 - [MainThread] Configured detector type: MultiDetector for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 10:46:40.721 | INFO     | video.scene_detector:detect_scenes:133 - [MainThread] Effective global min_scene_len (frames) for detectors: 15 for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">min_delta_hsv is deprecated, use min_content_val instead.</span><br><span class="line">2025-05-30 10:53:54.141 | INFO     | video.scene_detector:detect_scenes:302 - [MainThread] SceneManager detected 214 scenes in &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 10:53:54.143 | INFO     | video.scene_detector:detect_scenes:334 - [MainThread] Final 214 scenes for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27; after adjustments.</span><br><span class="line">2025-05-30 10:53:54.296 | INFO     | __main__:run_detection_benchmark:76 - Profiling data saved to: profiling_results/profile_å»ºç­‘å®¶å›­_02_Config_Default_CPU.prof</span><br><span class="line">2025-05-30 10:53:54.297 | INFO     | __main__:run_detection_benchmark:83 - Video: å»ºç­‘å®¶å›­-02.mp4</span><br><span class="line">2025-05-30 10:53:54.297 | INFO     | __main__:run_detection_benchmark:85 - Detected Scenes: 214</span><br><span class="line">2025-05-30 10:53:54.298 | INFO     | __main__:run_detection_benchmark:86 - Detected Frame Rate: 60.00 fps</span><br><span class="line">2025-05-30 10:53:54.298 | INFO     | __main__:run_detection_benchmark:87 - Processing Time: 433.7327 seconds</span><br><span class="line">2025-05-30 10:53:54.298 | INFO     | __main__:run_detection_benchmark:90 - --- Benchmark End ---</span><br><span class="line">2025-05-30 10:53:54.298 | INFO     | __main__:&lt;module&gt;:214 - --- Running with Configuration: Config_Default_GPU ---</span><br><span class="line">2025-05-30 10:53:54.298 | INFO     | __main__:run_detection_benchmark:50 - --- Benchmarking: å»ºç­‘å®¶å›­-02.mp4 ---</span><br><span class="line">2025-05-30 10:53:54.298 | INFO     | __main__:run_detection_benchmark:51 - Detector Setup: MultiDetector</span><br><span class="line">2025-05-30 10:53:54.298 | INFO     | __main__:run_detection_benchmark:52 - Using GPU for OpenCV decode: True</span><br><span class="line">2025-05-30 10:53:54.298 | INFO     | video.scene_detector:detect_scenes:69 - [MainThread] Starting detect_scenes for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;</span><br><span class="line">2025-05-30 10:53:54.299 | INFO     | video.scene_detector:detect_scenes:95 - [MainThread] GPU decode (AVFoundation/VideoToolbox likely) on macOS for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">Backend None not available.</span><br><span class="line">Trying another backend: opencv</span><br><span class="line">2025-05-30 10:53:54.381 | INFO     | video.scene_detector:detect_scenes:99 - [MainThread] Video &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27; opened with VideoStreamCv2.</span><br><span class="line">2025-05-30 10:53:54.381 | INFO     | video.scene_detector:detect_scenes:126 - [MainThread] Configured detector type: MultiDetector for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 10:53:54.381 | INFO     | video.scene_detector:detect_scenes:133 - [MainThread] Effective global min_scene_len (frames) for detectors: 15 for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">min_delta_hsv is deprecated, use min_content_val instead.</span><br><span class="line">2025-05-30 11:00:45.457 | INFO     | video.scene_detector:detect_scenes:302 - [MainThread] SceneManager detected 214 scenes in &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 11:00:45.458 | INFO     | video.scene_detector:detect_scenes:334 - [MainThread] Final 214 scenes for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27; after adjustments.</span><br><span class="line">2025-05-30 11:00:45.865 | INFO     | __main__:run_detection_benchmark:76 - Profiling data saved to: profiling_results/profile_å»ºç­‘å®¶å›­_02_Config_Default_GPU.prof</span><br><span class="line">2025-05-30 11:00:45.865 | INFO     | __main__:run_detection_benchmark:83 - Video: å»ºç­‘å®¶å›­-02.mp4</span><br><span class="line">2025-05-30 11:00:45.865 | INFO     | __main__:run_detection_benchmark:85 - Detected Scenes: 214</span><br><span class="line">2025-05-30 11:00:45.865 | INFO     | __main__:run_detection_benchmark:86 - Detected Frame Rate: 60.00 fps</span><br><span class="line">2025-05-30 11:00:45.865 | INFO     | __main__:run_detection_benchmark:87 - Processing Time: 411.5587 seconds</span><br><span class="line">2025-05-30 11:00:45.865 | INFO     | __main__:run_detection_benchmark:90 - --- Benchmark End ---</span><br><span class="line">2025-05-30 11:00:45.865 | INFO     | __main__:&lt;module&gt;:214 - --- Running with Configuration: Config_ContentDetectorOnly_CPU ---</span><br><span class="line">2025-05-30 11:00:45.865 | INFO     | __main__:run_detection_benchmark:50 - --- Benchmarking: å»ºç­‘å®¶å›­-02.mp4 ---</span><br><span class="line">2025-05-30 11:00:45.865 | INFO     | __main__:run_detection_benchmark:51 - Detector Setup: ContentDetector</span><br><span class="line">2025-05-30 11:00:45.865 | INFO     | __main__:run_detection_benchmark:52 - Using GPU for OpenCV decode: False</span><br><span class="line">2025-05-30 11:00:45.865 | INFO     | video.scene_detector:detect_scenes:69 - [MainThread] Starting detect_scenes for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;</span><br><span class="line">Backend None not available.</span><br><span class="line">Trying another backend: opencv</span><br><span class="line">2025-05-30 11:00:45.939 | INFO     | video.scene_detector:detect_scenes:99 - [MainThread] Video &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27; opened with VideoStreamCv2.</span><br><span class="line">2025-05-30 11:00:45.939 | INFO     | video.scene_detector:detect_scenes:126 - [MainThread] Configured detector type: ContentDetector for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 11:00:45.939 | INFO     | video.scene_detector:detect_scenes:133 - [MainThread] Effective global min_scene_len (frames) for detectors: 15 for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 11:07:26.007 | INFO     | video.scene_detector:detect_scenes:302 - [MainThread] SceneManager detected 164 scenes in &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 11:07:26.011 | INFO     | video.scene_detector:detect_scenes:334 - [MainThread] Final 164 scenes for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27; after adjustments.</span><br><span class="line">2025-05-30 11:07:26.170 | INFO     | __main__:run_detection_benchmark:83 - Video: å»ºç­‘å®¶å›­-02.mp4</span><br><span class="line">2025-05-30 11:07:26.170 | INFO     | __main__:run_detection_benchmark:85 - Detected Scenes: 164</span><br><span class="line">2025-05-30 11:07:26.170 | INFO     | __main__:run_detection_benchmark:86 - Detected Frame Rate: 60.00 fps</span><br><span class="line">2025-05-30 11:07:26.170 | INFO     | __main__:run_detection_benchmark:87 - Processing Time: 400.2969 seconds</span><br><span class="line">2025-05-30 11:07:26.170 | INFO     | __main__:run_detection_benchmark:90 - --- Benchmark End ---</span><br><span class="line">2025-05-30 11:07:26.170 | INFO     | __main__:&lt;module&gt;:236 - </span><br><span class="line"></span><br><span class="line">===== Benchmark Summary =====</span><br><span class="line">2025-05-30 11:07:26.170 | INFO     | __main__:&lt;module&gt;:238 - </span><br><span class="line">Video: å»ºç­‘å®¶å›­-02.mp4</span><br><span class="line">2025-05-30 11:07:26.170 | INFO     | __main__:&lt;module&gt;:240 -   Config: Config_Default_CPU             | Duration: 433.7327s | Scenes: 214</span><br><span class="line">2025-05-30 11:07:26.170 | INFO     | __main__:&lt;module&gt;:240 -   Config: Config_Default_GPU             | Duration: 411.5587s | Scenes: 214</span><br><span class="line">2025-05-30 11:07:26.170 | INFO     | __main__:&lt;module&gt;:240 -   Config: Config_ContentDetectorOnly_CPU | Duration: 400.2969s | Scenes: 164</span><br><span class="line">2025-05-30 11:07:26.170 | INFO     | __main__:&lt;module&gt;:242 - </span><br><span class="line">To analyze .prof files, use a tool like &#x27;snakeviz&#x27; or Python&#x27;s pstats module.</span><br><span class="line">2025-05-30 11:07:26.170 | INFO     | __main__:&lt;module&gt;:243 - Example: python -m pstats profiling_results/your_profile_file.prof</span><br><span class="line">2025-05-30 11:07:26.170 | INFO     | __main__:&lt;module&gt;:244 - Then in pstats shell: sort cumulative, stats 20</span><br><span class="line"></span><br><span class="line">è¿›ç¨‹å·²ç»“æŸï¼Œé€€å‡ºä»£ç ä¸º 0</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>macOS ä¸Šçš„ GPU è§£ç :<ul><li>åœ¨ â€œGPU ç›‘æ§â€ æˆ– â€œæ¯”è¾ƒè€—æ—¶â€ éƒ¨åˆ†ï¼Œå¯ä»¥ç‰¹åˆ«è¯´æ˜åœ¨ macOS ä¸Šï¼Œå³ä½¿æ²¡æœ‰æ˜ç¡®çš„ <code>VideoStreamCv2Cuda</code>ï¼ŒPySceneDetect é€šè¿‡<br><code>VideoStreamCv2</code> ä¹Ÿå¯èƒ½é—´æ¥åˆ©ç”¨ VideoToolbox/AVFoundation è¿›è¡Œç¡¬ä»¶åŠ é€Ÿè§£ç ï¼Œä½†æ•ˆæœå¯èƒ½ä¸ä¸“ç”¨ CUDA åç«¯ä¸åŒã€‚</li></ul></li><li>PySceneDetect åç«¯å›é€€:<ul><li>åœ¨ â€œç»“æœåˆ†æâ€ æˆ– â€œæ•…éšœæ’æŸ¥â€ (å¦‚æœæ·»åŠ æ­¤ç« èŠ‚) éƒ¨åˆ†ï¼Œè§£é‡Š<br><code>Backend None not available. Trying another backend: opencv</code> æ—¥å¿—çš„å«ä¹‰ï¼Œå³ PySceneDetect<br>å°è¯•äº†é»˜è®¤åç«¯ï¼ˆå¯èƒ½æ˜¯ç”¨æˆ·æŒ‡å®šçš„æˆ–åº“çš„ä¼˜é€‰ï¼‰ä½†å¤±è´¥ï¼Œç„¶åå›é€€åˆ° OpenCVã€‚è¿™å¯¹äºç†è§£å®é™…ä½¿ç”¨çš„è§£ç è·¯å¾„å¾ˆé‡è¦ã€‚</li></ul></li><li>ä¾èµ–åº“ç‰ˆæœ¬çš„é‡è¦æ€§:<ul><li>å†æ¬¡å¼ºè°ƒåœ¨ â€œè½¯ä»¶ç¯å¢ƒä¸€è‡´æ€§â€ éƒ¨åˆ†ï¼ŒPySceneDetectã€OpenCV (åŠå…¶ CUDA/OpenCL æ”¯æŒçš„ç¼–è¯‘æ–¹å¼)ã€FFmpeg<br>çš„ç‰ˆæœ¬éƒ½ä¼šæ˜¾è‘—å½±å“æ€§èƒ½å’ŒåŠŸèƒ½ï¼ŒåŒ…æ‹¬ç¡¬ä»¶åŠ é€Ÿçš„å¯ç”¨æ€§ã€‚</li></ul></li><li><code>min_delta_hsv</code> åºŸå¼ƒè­¦å‘Š:<ul><li>åœ¨ â€œé…ç½®æµ‹è¯•å‚æ•°â€ æˆ– â€œç»“æœåˆ†æâ€ éƒ¨åˆ†ï¼Œæç¤ºç”¨æˆ·æ³¨æ„ PySceneDetect çš„åºŸå¼ƒè­¦å‘Šï¼Œå¹¶åŠæ—¶æ›´æ–°å…¶é…ç½®æ–‡ä»¶æˆ–ä»£ç ä»¥ä½¿ç”¨æ¨èçš„æ–°å‚æ•°ã€‚</li></ul></li></ul><p>é€šè¿‡è¿™äº›è¡¥å……ï¼Œ<code>benchmark_test.md</code> æ–‡æ¡£å°†æ›´å‡†ç¡®åœ°åæ˜ å®é™…çš„æµ‹è¯•æƒ…å†µï¼Œå¹¶ä¸ºç”¨æˆ·æä¾›æ›´æœ‰ä»·å€¼çš„æ€§èƒ½åˆ†ææŒ‡å¯¼ã€‚</p><h3 id="4-2-åˆ†ææ€§èƒ½å‰–æ-prof-æ–‡ä»¶">4.2. åˆ†ææ€§èƒ½å‰–æ (<code>.prof</code>) æ–‡ä»¶</h3><p>ä½¿ç”¨ Python çš„ <code>pstats</code> æ¨¡å—æˆ– <code>snakeviz</code> å·¥å…·æ¥åˆ†æ <code>.prof</code> æ–‡ä»¶ã€‚</p><ul><li>ä½¿ç”¨ <code>pstats</code> (å‘½ä»¤è¡Œ)</li><li>snakeviz ä¼šåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ä¸€ä¸ªäº¤äº’å¼çš„ç«ç„°å›¾æˆ–æ—­æ—¥å›¾ï¼Œç›´è§‚åœ°å±•ç¤ºå‡½æ•°è°ƒç”¨æ ˆå’Œå„éƒ¨åˆ†è€—æ—¶ã€‚</li><li>å…³æ³¨ç‚¹ï¼š</li><li>è€—æ—¶æœ€å¤šçš„å‡½æ•°ï¼šè¿™äº›æ˜¯é¦–è¦çš„ä¼˜åŒ–ç›®æ ‡ã€‚é€šå¸¸ä¼šæ˜¯ PySceneDetect åº“ä¸­ä¸è§†é¢‘è§£ç ã€å¸§å¤„ç†ä»¥åŠå„æ£€æµ‹å™¨æ ¸å¿ƒç®—æ³•ç›¸å…³çš„å‡½æ•°ã€‚</li><li>PySceneDetect å†…éƒ¨å‡½æ•°ï¼šå¦‚æœç“¶é¢ˆåœ¨ PySceneDetect åº“å†…éƒ¨ï¼ˆå¦‚ç‰¹å®šæ£€æµ‹å™¨çš„ process_frame<br>æ–¹æ³•ï¼Œè§†é¢‘è§£ç å‡½æ•°ï¼‰ï¼Œä¼˜åŒ–æ–¹å‘å¯èƒ½åŒ…æ‹¬è°ƒæ•´æ£€æµ‹å™¨å‚æ•°ã€é€‰æ‹©æ›´å¿«çš„æ£€æµ‹å™¨ã€æˆ–ä¼˜åŒ–è§†é¢‘è§£ç æ–¹å¼ï¼ˆå¦‚éªŒè¯ GPU è§£ç æ•ˆæœï¼Œå°è¯•å¸§é™é‡‡æ ·ï¼‰ã€‚</li><li>è‡ªå®šä¹‰é€»è¾‘ï¼šå¦‚æœ detect_scenes å‡½æ•°ä¸­è‡ªå®šä¹‰çš„é€»è¾‘éƒ¨åˆ†ï¼ˆä¾‹å¦‚ï¼Œåœ¨ scene_detector.py ä¸­æ·»åŠ æ£€æµ‹å™¨ã€è°ƒæ•´åœºæ™¯åˆ—è¡¨çš„å¾ªç¯ï¼‰è€—æ—¶è¾ƒé•¿ï¼Œéœ€è¦é’ˆå¯¹æ€§ä¼˜åŒ–ã€‚</li></ul><h3 id="4-3-åˆ†æèµ„æºç›‘æ§æ•°æ®">4.3. åˆ†æèµ„æºç›‘æ§æ•°æ®</h3><h4 id="CPU-ç“¶é¢ˆï¼š">CPU ç“¶é¢ˆï¼š</h4><ul><li>å¦‚æœ CPU å•æ ¸æˆ–å¤šæ ¸é•¿æ—¶é—´å¤„äºé«˜è´Ÿè½½çŠ¶æ€ï¼Œè¡¨æ˜è®¡ç®—æ˜¯ç“¶é¢ˆã€‚</li><li>æ£€æŸ¥æ˜¯å¦å­˜åœ¨æŸä¸ªæ ¸å¿ƒè¿œé«˜äºå…¶ä»–æ ¸å¿ƒçš„æƒ…å†µï¼ˆå¯èƒ½è¡¨ç¤ºå¹¶è¡Œåº¦ä¸è¶³æˆ–æŸäº›æ“ä½œæ— æ³•æœ‰æ•ˆå¹¶è¡Œï¼Œå°½ç®¡ detect_scenes æœ¬èº«æ˜¯å•çº¿ç¨‹çš„ï¼Œä½†å…¶è°ƒç”¨çš„<br>OpenCV æˆ– FFmpeg åç«¯å¯èƒ½åˆ©ç”¨å¤šæ ¸ï¼‰ã€‚</li></ul><h4 id="å†…å­˜ç“¶é¢ˆï¼š">å†…å­˜ç“¶é¢ˆï¼š</h4><ul><li>å¦‚æœå†…å­˜ä½¿ç”¨æŒç»­å¢é•¿æˆ–è¾¾åˆ°ç³»ç»Ÿä¸Šé™ï¼Œå¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼æˆ–å¤„ç†å¤§æ•°æ®æ—¶å†…å­˜ç®¡ç†ä¸å½“ã€‚</li><li>PySceneDetect é€šå¸¸æ˜¯æµå¼å¤„ç†ï¼Œä½†æŸäº›é…ç½®æˆ–é•¿è§†é¢‘ä»å¯èƒ½æ¶ˆè€—è¾ƒå¤šå†…å­˜ã€‚ç¡®ä¿ video_api_obj.reset() è¢«æ­£ç¡®è°ƒç”¨ã€‚</li></ul><h4 id="GPU-ç“¶é¢ˆï¼š">GPU ç“¶é¢ˆï¼š</h4><ul><li>å¦‚æœå¯ç”¨äº† GPU åŠ é€Ÿï¼Œä½† GPU åˆ©ç”¨ç‡ä½ï¼Œæ£€æŸ¥é©±åŠ¨ã€CUDA/OpenCV é…ç½®ï¼Œä»¥åŠæ•°æ®ä¼ è¾“åˆ° GPU çš„å¼€é”€ã€‚ç¤ºä¾‹è¾“å‡ºæ˜¾ç¤º GPU é…ç½® (<br>Config_Default_GPU) é€Ÿåº¦æ›´å¿«ï¼Œè¡¨æ˜ GPU åœ¨æ­¤åœºæ™¯ä¸‹å¯èƒ½å¾—åˆ°äº†æœ‰æ•ˆåˆ©ç”¨ã€‚</li><li>å¦‚æœ GPU åˆ©ç”¨ç‡é«˜ï¼Œä½†æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Œå¯èƒ½ç“¶é¢ˆåœ¨å…¶ä»–éƒ¨åˆ†ï¼ˆå¦‚ Python ä»£ç æœ¬èº«ã€ç£ç›˜ I/Oï¼‰ã€‚</li></ul><h2 id="5-æ ¹æ®åˆ†æç»“æœæ”¹è¿›ä»£ç -ä¼˜åŒ–æ–¹å‘ç¤ºä¾‹">5.æ ¹æ®åˆ†æç»“æœæ”¹è¿›ä»£ç  (ä¼˜åŒ–æ–¹å‘ç¤ºä¾‹)</h2><blockquote><p>åŸºäºä¸Šè¿°åˆ†æï¼Œå¯ä»¥é’ˆå¯¹æ€§åœ°å¯¹ scene_detector.py åŠç›¸å…³æ¨¡å—è¿›è¡Œä¼˜åŒ–ï¼š</p></blockquote><h4 id="åœºæ™¯æ£€æµ‹ç­–ç•¥ä¼˜åŒ–ï¼š">åœºæ™¯æ£€æµ‹ç­–ç•¥ä¼˜åŒ–ï¼š</h4><ul><li>è°ƒæ•´æ£€æµ‹å™¨ï¼šæ ¹æ®æ€§èƒ½å’Œå‡†ç¡®åº¦éœ€æ±‚ï¼Œåœ¨ config.ini ä¸­å¯ç”¨æˆ–ç¦ç”¨ç‰¹å®šçš„æ£€æµ‹å™¨ï¼Œæˆ–è°ƒæ•´å…¶å‚æ•°ï¼ˆå¦‚ threshold,<br>min_scene_len_framesï¼‰ã€‚ä»ç¤ºä¾‹è¾“å‡ºçœ‹ï¼Œä»…ä½¿ç”¨ ContentDetector é€Ÿåº¦æœ€å¿«ï¼Œä½†åœºæ™¯æ•°ç•¥å°‘ã€‚éœ€è¦æ ¹æ®ä¸šåŠ¡éœ€æ±‚å†³å®šæ˜¯å¦å€¼å¾—ç‰ºç‰²ä¸€äº›æ£€æµ‹åœºæ™¯æ¢å–é€Ÿåº¦ã€‚</li><li>å¸§é™é‡‡æ ·ï¼šå¯¹äºé•¿è§†é¢‘ï¼Œåœ¨ scene_detector.py ä¸­ä¸º SceneManager è®¾ç½® frame_skip æˆ–é€šè¿‡<br>video_api_obj.set_downscale_factor() æ¥å‡å°‘å¤„ç†çš„å¸§æ•°/åˆ†è¾¨ç‡ï¼Œä»¥å¤§å¹…æå‡é€Ÿåº¦ã€‚å°†å…¶ä½œä¸ºå¯é…ç½®é¡¹ã€‚è§†é¢‘è§£ç ä¼˜åŒ–ï¼š</li><li>åŸºäºæµ‹è¯•ç»“æœï¼Œç¡®å®š CPU è§£ç æˆ– GPU è§£ç  (VideoStreamCv2Cuda) åœ¨ä½•ç§æƒ…å†µä¸‹æ›´ä¼˜ï¼Œå¹¶ç›¸åº”è°ƒæ•´é…ç½®ã€‚ç¤ºä¾‹ä¸­ GPU è§£ç æ•ˆæœæ˜æ˜¾ã€‚</li></ul><h4 id="ä»£ç é€»è¾‘ä¼˜åŒ–ï¼š">ä»£ç é€»è¾‘ä¼˜åŒ–ï¼š</h4><ul><li>æ£€æŸ¥ detect_scenes å†…éƒ¨æ˜¯å¦æœ‰å¯ä¼˜åŒ–çš„å¾ªç¯æˆ–æ•°æ®å¤„ç†ã€‚ç¡®ä¿èµ„æºï¼ˆå¦‚ video_api_objï¼‰å¾—åˆ°æ­£ç¡®å’ŒåŠæ—¶çš„é‡Šæ”¾ã€‚</li></ul><h4 id="é•¿è§†é¢‘ç‰¹å®šä¼˜åŒ–ï¼š">é•¿è§†é¢‘ç‰¹å®šä¼˜åŒ–ï¼š</h4><ul><li>è€ƒè™‘æ›´ç»†ç²’åº¦çš„æ£€æŸ¥ç‚¹æœºåˆ¶ï¼ˆå¦‚æœ detect_scenes æœ¬èº«è€—æ—¶è¿‡é•¿ï¼‰ã€‚</li><li>æ¢ç´¢åˆ†å—å¤„ç†é•¿è§†é¢‘çš„ç­–ç•¥ã€‚</li></ul><h2 id="6-è¿­ä»£ä¸éªŒè¯">6. è¿­ä»£ä¸éªŒè¯</h2><blockquote><p>æ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªè¿­ä»£è¿‡ç¨‹ã€‚æ¯æ¬¡åº”ç”¨ä¼˜åŒ–åï¼Œéƒ½åº”é‡æ–°è¿è¡ŒåŸºå‡†æµ‹è¯•ï¼Œä»¥éªŒè¯ä¼˜åŒ–çš„æ•ˆæœï¼Œå¹¶ç¡®ä¿æ²¡æœ‰å¼•å…¥æ–°çš„æ€§èƒ½é—®é¢˜æˆ–åŠŸèƒ½æ€§ç¼ºé™·ã€‚</p></blockquote><blockquote><p>é€šè¿‡éµå¾ªæœ¬æŒ‡å—ï¼Œæ‚¨å¯ä»¥ç³»ç»Ÿåœ°è¯„ä¼°å’Œæå‡è§†é¢‘å¤„ç†é¡¹ç›®çš„æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†è®¡ç®—å¯†é›†çš„åœºæ™¯æ£€æµ‹ä»»åŠ¡æ—¶ã€‚</p></blockquote><h2 id="æ€»ç»“">æ€»ç»“</h2><h3 id="macOS-åœºæ™¯æ£€æµ‹æ€§èƒ½æµ‹è¯•æ€»ç»“">macOS åœºæ™¯æ£€æµ‹æ€§èƒ½æµ‹è¯•æ€»ç»“</h3><p>æµ‹è¯•è§†é¢‘: <code>å»ºç­‘å®¶å›­-02.mp4</code> (60fps)<br>æµ‹è¯•æ—¥æœŸ: 2025-05-30</p><h4 id="å…³é”®æµ‹è¯•æ•°æ®">å…³é”®æµ‹è¯•æ•°æ®</h4><table><thead><tr><th style="text-align:left">æµ‹è¯•é…ç½®</th><th style="text-align:left">è§£ç æ–¹å¼</th><th style="text-align:left">æ£€æµ‹å™¨ç»„åˆ</th><th style="text-align:left">å¤„ç†æ—¶é•¿ (ç§’)</th><th style="text-align:left">æ£€æµ‹åœºæ™¯æ•°</th><th style="text-align:left">å¸§ç‡ (fps)</th></tr></thead><tbody><tr><td style="text-align:left"><code>Config_Default_CPU</code></td><td style="text-align:left">CPU</td><td style="text-align:left">MultiDetector</td><td style="text-align:left">433.7327</td><td style="text-align:left">214</td><td style="text-align:left">60.00</td></tr><tr><td style="text-align:left"><code>Config_Default_GPU</code></td><td style="text-align:left">GPU (è¯·æ±‚)</td><td style="text-align:left">MultiDetector</td><td style="text-align:left">411.5587</td><td style="text-align:left">214</td><td style="text-align:left">60.00</td></tr><tr><td style="text-align:left"><code>Config_ContentDetectorOnly_CPU</code></td><td style="text-align:left">CPU</td><td style="text-align:left">ContentDetector</td><td style="text-align:left">400.2969</td><td style="text-align:left">164</td><td style="text-align:left">60.00</td></tr></tbody></table><h4 id="ä¸»è¦ç»“è®º">ä¸»è¦ç»“è®º</h4><ol><li><p>GPU åŠ é€Ÿåœ¨ macOS ä¸Šçš„è¡¨ç°:</p><ul><li>å½“è¯·æ±‚ GPU è§£ç æ—¶ (<code>Config_Default_GPU</code>)ï¼Œå³ä½¿ PySceneDetect æ—¥å¿—æ˜¾ç¤ºå›é€€åˆ°æ ‡å‡†çš„ <code>VideoStreamCv2</code> åç«¯ (è€Œé <code>VideoStreamCv2Cuda</code>)ï¼Œå¤„ç†é€Ÿåº¦ç›¸æ¯”çº¯ CPU è§£ç  (<code>Config_Default_CPU</code>) ä»æœ‰çº¦ 5% çš„æå‡ (ä» 433.73 ç§’é™è‡³ 411.56 ç§’)ã€‚</li><li>è¿™è¡¨æ˜åœ¨ macOS ä¸Šï¼Œ<code>VideoStreamCv2</code> å¯èƒ½é—´æ¥åˆ©ç”¨äº†ç³»ç»Ÿçº§çš„ç¡¬ä»¶åŠ é€Ÿæ¡†æ¶ (å¦‚ AVFoundation/VideoToolbox) è¿›è¡Œè§†é¢‘è§£ç ã€‚</li><li>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§æå‡å¹…åº¦å¯èƒ½ä¸å¦‚åœ¨å…·æœ‰ä¸“ç”¨ NVIDIA GPU å’Œæ­£ç¡®é…ç½® CUDA çš„ç¯å¢ƒä¸­ä½¿ç”¨ <code>VideoStreamCv2Cuda</code> æ—¶æ˜¾è‘—ã€‚</li></ul></li><li><p>æ£€æµ‹å™¨é€‰æ‹©å¯¹æ€§èƒ½å’Œç»“æœçš„æ˜¾è‘—å½±å“:</p><ul><li>ä»…ä½¿ç”¨ <code>ContentDetector</code> (<code>Config_ContentDetectorOnly_CPU</code>) çš„é…ç½®é€Ÿåº¦æœ€å¿«ï¼Œå¤„ç†æ—¶é•¿ä¸º 400.30 ç§’ã€‚</li><li>ä¸ä½¿ç”¨ <code>MultiDetector</code> çš„ CPU é…ç½® (<code>Config_Default_CPU</code>) ç›¸æ¯”ï¼Œé€Ÿåº¦æå‡äº†çº¦ 7.7% (å¿«äº†çº¦ 33 ç§’)ã€‚</li><li>ç„¶è€Œï¼Œä»…ä½¿ç”¨ <code>ContentDetector</code> æ—¶ï¼Œæ£€æµ‹åˆ°çš„åœºæ™¯æ•°ä» 214 ä¸ªå‡å°‘åˆ° 164 ä¸ªï¼Œè¡¨æ˜ç‰ºç‰²äº†ä¸€å®šçš„æ£€æµ‹å…¨é¢æ€§ã€‚è¿™éœ€è¦åœ¨å¤„ç†æ•ˆç‡å’Œæ£€æµ‹ç»“æœçš„å®Œæ•´æ€§ä¹‹é—´è¿›è¡Œæƒè¡¡ã€‚</li></ul></li><li><p>PySceneDetect åç«¯è¡Œä¸º:</p><ul><li>æµ‹è¯•æ—¥å¿—ä¸­å‡ºç° <code>Backend None not available. Trying another backend: opencv</code>ï¼Œè¡¨æ˜ PySceneDetect åœ¨å°è¯•ä½¿ç”¨ä¸€ä¸ªï¼ˆå¯èƒ½æ˜¯ç”¨æˆ·é…ç½®çš„æˆ–åº“ä¼˜é€‰çš„ï¼‰åç«¯å¤±è´¥åï¼ŒæˆåŠŸå›é€€åˆ°äº† OpenCV åç«¯ (<code>VideoStreamCv2</code>)ã€‚è¿™å¯¹äºç†è§£å®é™…çš„è§£ç è·¯å¾„å’Œæ’æŸ¥é…ç½®é—®é¢˜éå¸¸é‡è¦ã€‚</li></ul></li><li><p>åº“çš„å…¼å®¹æ€§æç¤º:</p><ul><li>æ—¥å¿—ä¸­ <code>AdaptiveDetector</code> ç›¸å…³çš„è­¦å‘Š <code>min_delta_hsv is deprecated, use min_content_val instead.</code> æç¤ºéœ€è¦æ›´æ–°é…ç½®æ–‡ä»¶ä¸­çš„å‚æ•°ï¼Œä»¥ç¡®ä¿ä¸ PySceneDetect åº“çš„æŒç»­å…¼å®¹æ€§å’Œæœ€ä½³å®è·µã€‚</li></ul></li></ol><h3 id="windows-æµ‹è¯•ç»“æœ">windows æµ‹è¯•ç»“æœ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">D:\pythonProject\venv1\Scripts\python.exe D:\pythonProject\scene-detect-split1\src\tests\benchmark_scene_detector.py </span><br><span class="line">2025-05-30 14:11:57.528 | INFO     | config.config:initialize_settings:147 - Configuration successfully loaded from: D:\pythonProject\scene-detect-split1\src\run\config.ini</span><br><span class="line">2025-05-30 14:11:57.529 | INFO     | __main__:&lt;module&gt;:118 - Configuration loaded from: D:\pythonProject\scene-detect-split1\src\run\config.ini</span><br><span class="line">2025-05-30 14:11:57.869 | INFO     | __main__:&lt;module&gt;:210 - </span><br><span class="line">===== Processing Video: Z:\æ ·ä¾‹\CGæ¸²æŸ“æ ·ä¾‹\å»ºç­‘å®¶å›­\å»ºç­‘å®¶å›­-02.mp4 =====</span><br><span class="line">2025-05-30 14:11:57.869 | INFO     | __main__:&lt;module&gt;:214 - --- Running with Configuration: Config_Default_CPU ---</span><br><span class="line">2025-05-30 14:11:57.869 | INFO     | __main__:run_detection_benchmark:50 - --- Benchmarking: å»ºç­‘å®¶å›­-02.mp4 ---</span><br><span class="line">2025-05-30 14:11:57.869 | INFO     | __main__:run_detection_benchmark:51 - Detector Setup: ContentDetector</span><br><span class="line">2025-05-30 14:11:57.869 | INFO     | __main__:run_detection_benchmark:52 - Using GPU for OpenCV decode: False</span><br><span class="line">2025-05-30 14:11:57.870 | INFO     | video.scene_detector:detect_scenes:69 - [MainThread] Starting detect_scenes for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;</span><br><span class="line">Backend None not available.</span><br><span class="line">Trying another backend: opencv</span><br><span class="line">2025-05-30 14:11:58.075 | INFO     | video.scene_detector:detect_scenes:99 - [MainThread] Video &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27; opened with VideoStreamCv2.</span><br><span class="line">2025-05-30 14:11:58.075 | INFO     | video.scene_detector:detect_scenes:126 - [MainThread] Configured detector type: ContentDetector for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 14:11:58.075 | INFO     | video.scene_detector:detect_scenes:133 - [MainThread] Effective global min_scene_len (frames) for detectors: 15 for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 14:16:45.990 | INFO     | video.scene_detector:detect_scenes:302 - [MainThread] SceneManager detected 159 scenes in &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 14:16:45.990 | INFO     | video.scene_detector:detect_scenes:334 - [MainThread] Final 159 scenes for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27; after adjustments.</span><br><span class="line">2025-05-30 14:16:46.113 | INFO     | __main__:run_detection_benchmark:76 - Profiling data saved to: profiling_results\profile_å»ºç­‘å®¶å›­_02_Config_Default_CPU.prof</span><br><span class="line">2025-05-30 14:16:46.113 | INFO     | __main__:run_detection_benchmark:83 - Video: å»ºç­‘å®¶å›­-02.mp4</span><br><span class="line">2025-05-30 14:16:46.113 | INFO     | __main__:run_detection_benchmark:85 - Detected Scenes: 159</span><br><span class="line">2025-05-30 14:16:46.113 | INFO     | __main__:run_detection_benchmark:86 - Detected Frame Rate: 60.00 fps</span><br><span class="line">2025-05-30 14:16:46.113 | INFO     | __main__:run_detection_benchmark:87 - Processing Time: 288.2435 seconds</span><br><span class="line">2025-05-30 14:16:46.113 | INFO     | __main__:run_detection_benchmark:90 - --- Benchmark End ---</span><br><span class="line">2025-05-30 14:16:46.113 | INFO     | __main__:&lt;module&gt;:214 - --- Running with Configuration: Config_Default_GPU ---</span><br><span class="line">2025-05-30 14:16:46.113 | INFO     | __main__:run_detection_benchmark:50 - --- Benchmarking: å»ºç­‘å®¶å›­-02.mp4 ---</span><br><span class="line">2025-05-30 14:16:46.113 | INFO     | __main__:run_detection_benchmark:51 - Detector Setup: ContentDetector</span><br><span class="line">2025-05-30 14:16:46.113 | INFO     | __main__:run_detection_benchmark:52 - Using GPU for OpenCV decode: True</span><br><span class="line">2025-05-30 14:16:46.113 | INFO     | video.scene_detector:detect_scenes:69 - [MainThread] Starting detect_scenes for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;</span><br><span class="line">2025-05-30 14:16:46.147 | WARNING  | video.scene_detector:detect_scenes:93 - [MainThread] VideoStreamCv2Cuda not available. Using CPU for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">Backend None not available.</span><br><span class="line">Trying another backend: opencv</span><br><span class="line">2025-05-30 14:16:46.242 | INFO     | video.scene_detector:detect_scenes:99 - [MainThread] Video &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27; opened with VideoStreamCv2.</span><br><span class="line">2025-05-30 14:16:46.243 | INFO     | video.scene_detector:detect_scenes:126 - [MainThread] Configured detector type: ContentDetector for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 14:16:46.243 | INFO     | video.scene_detector:detect_scenes:133 - [MainThread] Effective global min_scene_len (frames) for detectors: 15 for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 14:20:35.982 | INFO     | video.scene_detector:detect_scenes:302 - [MainThread] SceneManager detected 159 scenes in &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 14:20:35.982 | INFO     | video.scene_detector:detect_scenes:334 - [MainThread] Final 159 scenes for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27; after adjustments.</span><br><span class="line">2025-05-30 14:20:36.101 | INFO     | __main__:run_detection_benchmark:76 - Profiling data saved to: profiling_results\profile_å»ºç­‘å®¶å›­_02_Config_Default_GPU.prof</span><br><span class="line">2025-05-30 14:20:36.101 | INFO     | __main__:run_detection_benchmark:83 - Video: å»ºç­‘å®¶å›­-02.mp4</span><br><span class="line">2025-05-30 14:20:36.102 | INFO     | __main__:run_detection_benchmark:85 - Detected Scenes: 159</span><br><span class="line">2025-05-30 14:20:36.102 | INFO     | __main__:run_detection_benchmark:86 - Detected Frame Rate: 60.00 fps</span><br><span class="line">2025-05-30 14:20:36.102 | INFO     | __main__:run_detection_benchmark:87 - Processing Time: 229.9882 seconds</span><br><span class="line">2025-05-30 14:20:36.102 | INFO     | __main__:run_detection_benchmark:90 - --- Benchmark End ---</span><br><span class="line">2025-05-30 14:20:36.102 | INFO     | __main__:&lt;module&gt;:214 - --- Running with Configuration: Config_ContentDetectorOnly_CPU ---</span><br><span class="line">2025-05-30 14:20:36.102 | INFO     | __main__:run_detection_benchmark:50 - --- Benchmarking: å»ºç­‘å®¶å›­-02.mp4 ---</span><br><span class="line">2025-05-30 14:20:36.102 | INFO     | __main__:run_detection_benchmark:51 - Detector Setup: ContentDetector</span><br><span class="line">2025-05-30 14:20:36.102 | INFO     | __main__:run_detection_benchmark:52 - Using GPU for OpenCV decode: False</span><br><span class="line">2025-05-30 14:20:36.102 | INFO     | video.scene_detector:detect_scenes:69 - [MainThread] Starting detect_scenes for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;</span><br><span class="line">Backend None not available.</span><br><span class="line">Trying another backend: opencv</span><br><span class="line">2025-05-30 14:20:36.194 | INFO     | video.scene_detector:detect_scenes:99 - [MainThread] Video &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27; opened with VideoStreamCv2.</span><br><span class="line">2025-05-30 14:20:36.194 | INFO     | video.scene_detector:detect_scenes:126 - [MainThread] Configured detector type: ContentDetector for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 14:20:36.194 | INFO     | video.scene_detector:detect_scenes:133 - [MainThread] Effective global min_scene_len (frames) for detectors: 15 for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 14:24:23.153 | INFO     | video.scene_detector:detect_scenes:302 - [MainThread] SceneManager detected 159 scenes in &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27;.</span><br><span class="line">2025-05-30 14:24:23.153 | INFO     | video.scene_detector:detect_scenes:334 - [MainThread] Final 159 scenes for &#x27;å»ºç­‘å®¶å›­-02.mp4&#x27; after adjustments.</span><br><span class="line">2025-05-30 14:24:23.278 | INFO     | __main__:run_detection_benchmark:83 - Video: å»ºç­‘å®¶å›­-02.mp4</span><br><span class="line">2025-05-30 14:24:23.278 | INFO     | __main__:run_detection_benchmark:85 - Detected Scenes: 159</span><br><span class="line">2025-05-30 14:24:23.278 | INFO     | __main__:run_detection_benchmark:86 - Detected Frame Rate: 60.00 fps</span><br><span class="line">2025-05-30 14:24:23.278 | INFO     | __main__:run_detection_benchmark:87 - Processing Time: 227.1770 seconds</span><br><span class="line">2025-05-30 14:24:23.278 | INFO     | __main__:run_detection_benchmark:90 - --- Benchmark End ---</span><br><span class="line">2025-05-30 14:24:23.278 | INFO     | __main__:&lt;module&gt;:236 - </span><br><span class="line"></span><br><span class="line">===== Benchmark Summary =====</span><br><span class="line">2025-05-30 14:24:23.280 | INFO     | __main__:&lt;module&gt;:238 - </span><br><span class="line">Video: å»ºç­‘å®¶å›­-02.mp4</span><br><span class="line">2025-05-30 14:24:23.280 | INFO     | __main__:&lt;module&gt;:240 -   Config: Config_Default_CPU             | Duration: 288.2435s | Scenes: 159</span><br><span class="line">2025-05-30 14:24:23.280 | INFO     | __main__:&lt;module&gt;:240 -   Config: Config_Default_GPU             | Duration: 229.9882s | Scenes: 159</span><br><span class="line">2025-05-30 14:24:23.280 | INFO     | __main__:&lt;module&gt;:240 -   Config: Config_ContentDetectorOnly_CPU | Duration: 227.1770s | Scenes: 159</span><br><span class="line">2025-05-30 14:24:23.280 | INFO     | __main__:&lt;module&gt;:242 - </span><br><span class="line">To analyze .prof files, use a tool like &#x27;snakeviz&#x27; or Python&#x27;s pstats module.</span><br><span class="line">2025-05-30 14:24:23.280 | INFO     | __main__:&lt;module&gt;:243 - Example: python -m pstats profiling_results/your_profile_file.prof</span><br><span class="line">2025-05-30 14:24:23.280 | INFO     | __main__:&lt;module&gt;:244 - Then in pstats shell: sort cumulative, stats 20</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Windows-å¹³å°åœºæ™¯æ£€æµ‹æ€§èƒ½æµ‹è¯•æ€»ç»“">Windows å¹³å°åœºæ™¯æ£€æµ‹æ€§èƒ½æµ‹è¯•æ€»ç»“</h4><p>æµ‹è¯•è§†é¢‘: <code>å»ºç­‘å®¶å›­-02.mp4</code> (60fps)<br>æµ‹è¯•æ—¥æœŸ: 2025-05-30<br>æµ‹è¯•å¹³å°: Windows</p><h5 id="å…³é”®æµ‹è¯•æ•°æ®-2">å…³é”®æµ‹è¯•æ•°æ®</h5><table><thead><tr><th style="text-align:left">æµ‹è¯•é…ç½®</th><th style="text-align:left">è§£ç æ–¹å¼</th><th style="text-align:left">æ£€æµ‹å™¨è®¾ç½®</th><th style="text-align:left">å¤„ç†æ—¶é•¿ (ç§’)</th><th style="text-align:left">æ£€æµ‹åœºæ™¯æ•°</th></tr></thead><tbody><tr><td style="text-align:left"><code>Config_Default_CPU</code></td><td style="text-align:left">CPU</td><td style="text-align:left">ContentDetector*</td><td style="text-align:left">288.2435</td><td style="text-align:left">159</td></tr><tr><td style="text-align:left"><code>Config_Default_GPU</code></td><td style="text-align:left">GPU (è¯·æ±‚)</td><td style="text-align:left">ContentDetector*</td><td style="text-align:left">229.9882</td><td style="text-align:left">159</td></tr><tr><td style="text-align:left"><code>Config_ContentDetectorOnly_CPU</code></td><td style="text-align:left">CPU</td><td style="text-align:left">ContentDetector</td><td style="text-align:left">227.1770</td><td style="text-align:left">159</td></tr></tbody></table><ul><li>é‡è¦: æ—¥å¿—æ˜¾ç¤ºæ‰€æœ‰é…ç½®ï¼ˆåŒ…æ‹¬ <code>Config_Default_CPU</code> å’Œ <code>Config_Default_GPU</code>ï¼‰çš„ <code>Detector Setup</code> å‡ä¸º <code>ContentDetector</code>ã€‚è¿™è¡¨æ˜ <code>benchmark_scene_detector.py</code> ä¸­çš„è¿™äº› â€œDefaultâ€ é…ç½®å¯èƒ½é”™è¯¯åœ°ä»…æŒ‡å®šäº† <code>ContentDetector</code>ï¼Œè€Œä¸æ˜¯ <code>config.ini</code> ä¸­å®šä¹‰çš„ <code>MultiDetector</code>ã€‚å› æ­¤ï¼Œä»¥ä¸‹åˆ†æåŸºäºæ‰€æœ‰æµ‹è¯•å®é™…ä¸Šéƒ½åªä½¿ç”¨äº† <code>ContentDetector</code>ã€‚</li></ul><h5 id="ä¸»è¦ç»“è®º-2">ä¸»è¦ç»“è®º</h5><ol><li><p>GPU åŠ é€Ÿè¯·æ±‚åœ¨ Windows ä¸Šçš„è¡¨ç° (å½“ CUDA åç«¯ä¸å¯ç”¨æ—¶):</p><ul><li>å½“è¯·æ±‚ GPU è§£ç æ—¶ (<code>Config_Default_GPU</code>)ï¼Œæ—¥å¿—æ˜ç¡®æŒ‡å‡º <code>VideoStreamCv2Cuda not available. Using CPU...</code>ã€‚æœ€ç»ˆè§†é¢‘æµé€šè¿‡æ ‡å‡†çš„ <code>VideoStreamCv2</code> åç«¯ç”± CPU å®Œæˆè§£ç ã€‚</li><li>å°½ç®¡å¦‚æ­¤ï¼Œ<code>Config_Default_GPU</code> (229.99 ç§’) ä»ç„¶æ¯” <code>Config_Default_CPU</code> (288.24 ç§’) å¿«äº†çº¦ 58.25 ç§’ï¼Œæ€§èƒ½æå‡çº¦ 20.2%ã€‚</li><li>è¿™å¯èƒ½å½’å› äº Windows å¹³å°ä¸Š OpenCV çš„ CPU è§£ç åç«¯ï¼ˆå¦‚ Media Foundation æˆ– DirectShowï¼‰åœ¨ç‰¹å®šè·¯å¾„æˆ–é’ˆå¯¹æŸäº›è§†é¢‘æ ¼å¼æ—¶ï¼Œç›¸æ¯”çº¯ç²¹çš„ CPU è·¯å¾„æœ‰æ›´ä¼˜åŒ–çš„è¡¨ç°ï¼Œæˆ–è€…ç³»ç»Ÿèµ„æºè°ƒåº¦å·®å¼‚ã€‚</li></ul></li><li><p><code>ContentDetectorOnly_CPU</code> ä½œä¸ºæœ€å¿«é…ç½®:</p><ul><li><code>Config_ContentDetectorOnly_CPU</code> (227.18 ç§’) æ˜¯æ‰€æœ‰é…ç½®ä¸­æœ€å¿«çš„ï¼Œç¬¦åˆé¢„æœŸã€‚</li><li>å®ƒä¸ <code>Config_Default_GPU</code> (å®é™…ä¹Ÿæ˜¯ ContentDetector + CPU è§£ç ) çš„æ€§èƒ½å·®å¼‚è¾ƒå° (çº¦ 2.8 ç§’)ï¼Œå¯èƒ½åœ¨æµ‹é‡è¯¯å·®èŒƒå›´å†…ã€‚</li></ul></li><li><p>PySceneDetect åç«¯å›é€€:</p><ul><li>æ—¥å¿—æ¸…æ™°å±•ç¤ºäº†å½“ä¼˜é€‰åç«¯ï¼ˆå¦‚ CUDAï¼‰ä¸å¯ç”¨æ—¶ï¼ŒPySceneDetect å›é€€åˆ°æ ‡å‡† OpenCV (<code>VideoStreamCv2</code>) çš„è¡Œä¸ºã€‚</li></ul></li><li><p>ä¸ macOS æµ‹è¯•çš„å¯¹æ¯” (é’ˆå¯¹åŒä¸€è§†é¢‘ï¼Œä½†æ£€æµ‹å™¨é…ç½®å¯èƒ½ä¸åŒ):</p><ul><li>åœ¨ Windows ä¸Šä»…ä½¿ç”¨ <code>ContentDetector</code> (CPU) å¤„ç†æ­¤è§†é¢‘ (çº¦ 227-288 ç§’) æ¯”ä¹‹å‰åœ¨ macOS ä¸Šä½¿ç”¨ <code>MultiDetector</code> (CPU) (çº¦ 433 ç§’) è¦å¿«ã€‚å¦‚æœ macOS ä¹Ÿä»…ç”¨ <code>ContentDetector</code> (çº¦ 400 ç§’)ï¼ŒWindows ä»ç„¶æ›´å¿«ã€‚è¿™å¯èƒ½åæ˜ äº†æ“ä½œç³»ç»Ÿåº•å±‚è§†é¢‘å¤„ç†æ¡†æ¶çš„æ•ˆç‡å·®å¼‚ã€‚</li><li>åœ¨â€œè¯·æ±‚GPUä½†å›é€€åˆ°CPUâ€çš„æƒ…å†µä¸‹ï¼ŒWindows å¹³å°æ˜¾ç¤ºå‡ºç›¸å¯¹æ›´å¤§çš„æ€§èƒ½æå‡ (çº¦ 20.2%)ï¼Œè€Œ macOS å¹³å° (é’ˆå¯¹ <code>MultiDetector</code>) çº¦ä¸º 5%ã€‚</li></ul></li></ol><h5 id="å…³é”®é—®é¢˜ç‚¹ä¸åç»­è¡ŒåŠ¨å»ºè®®">å…³é”®é—®é¢˜ç‚¹ä¸åç»­è¡ŒåŠ¨å»ºè®®</h5><ol><li><p>æ ¸å®å¹¶ä¿®æ­£ <code>benchmark_scene_detector.py</code> ä¸­çš„æµ‹è¯•é…ç½®:</p><ul><li>é¦–è¦ä»»åŠ¡: ç¡®ä¿ <code>Config_Default_CPU</code> å’Œ <code>Config_Default_GPU</code> é…ç½®æ­£ç¡®åœ°ä½¿ç”¨äº†æ‚¨æœŸæœ›çš„ <code>MultiDetector</code> è®¾ç½®ï¼ˆä» <code>config.ini</code> çš„ <code>[SceneDetectorSetup]</code> åŠ è½½ï¼‰ã€‚å¦‚æœå½“å‰å®ƒä»¬è¢«é”™è¯¯åœ°æŒ‡å‘äº†ä»… <code>ContentDetector</code>ï¼Œé‚£ä¹ˆå¯¹ <code>MultiDetector</code> çš„æ€§èƒ½è¯„ä¼°æ˜¯ä¸å‡†ç¡®çš„ã€‚</li></ul></li><li><p>å½»åº•æ’æŸ¥ <code>VideoStreamCv2Cuda not available</code> é—®é¢˜:</p><ul><li>æ£€æŸ¥ OpenCV-Python ç‰ˆæœ¬ (ç¡®ä¿æ˜¯ä¸º Windows ç¼–è¯‘çš„ã€åŒ…å« CUDA æ”¯æŒçš„ç‰ˆæœ¬)ã€‚</li><li>æ£€æŸ¥ CUDA Toolkit å’Œ cuDNN çš„å®‰è£…ä¸å…¼å®¹æ€§ã€‚</li><li>æ£€æŸ¥ ç³»ç»Ÿç¯å¢ƒå˜é‡ (å¦‚ <code>PATH</code>, <code>CUDA_PATH</code>)ã€‚</li><li>æ£€æŸ¥ NVIDIA é©±åŠ¨ç¨‹åºç‰ˆæœ¬ã€‚</li><li>è¿è¡Œé¡¹ç›®ä¸­çš„ <code>cuda_available_verify.py</code> è„šæœ¬è·å–ç›´æ¥åé¦ˆã€‚</li></ul></li><li><p>åœ¨ CUDA æˆåŠŸå¯ç”¨åé‡æ–°è¿›è¡ŒåŸºå‡†æµ‹è¯•:</p><ul><li>åªæœ‰å½“ <code>VideoStreamCv2Cuda</code> èƒ½å¤ŸæˆåŠŸåŠ è½½å’Œä½¿ç”¨æ—¶ï¼Œæ‰èƒ½çœŸæ­£è¯„ä¼° GPU å¯¹è§†é¢‘è§£ç çš„åŠ é€Ÿæ•ˆæœã€‚</li><li>å±Šæ—¶ï¼Œé‡ç‚¹å¯¹æ¯” <code>MultiDetector</code> é…ç½®ä¸‹ CPU ä¸ GPU (CUDA) çš„æ€§èƒ½ã€‚</li></ul></li><li><p>åˆ†æ <code>.prof</code> æ–‡ä»¶:</p><ul><li>å¯¹äºä¿®æ­£é…ç½®åçš„ <code>MultiDetector</code> æµ‹è¯•ï¼Œä½¿ç”¨ <code>snakeviz</code> åˆ†æ <code>.prof</code> æ–‡ä»¶ã€‚</li><li>å…³æ³¨è§†é¢‘ I/O (<code>cv2.VideoCapture</code> çš„ <code>retrieve</code> å’Œ <code>grab</code> æ–¹æ³•) å’Œå„ä¸ªå­æ£€æµ‹å™¨åœ¨ CPU ä¸ GPU é…ç½®ä¸‹çš„è€—æ—¶ã€‚</li></ul></li><li><p>ç»§ç»­æµ‹è¯•å¸§é™é‡‡æ ·:</p><ul><li>æ— è®º CUDA æ˜¯å¦æˆåŠŸå¯ç”¨ï¼Œå¦‚æœè§†é¢‘ I/O ä¾ç„¶æ˜¯ä¸»è¦ç“¶é¢ˆï¼Œå¸§é™é‡‡æ · (<code>frame_skip</code> å’Œ <code>downscale_factor</code>) éƒ½æ˜¯è‡³å…³é‡è¦çš„ä¼˜åŒ–ç­–ç•¥ã€‚</li></ul></li></ol><h2 id="åç»­åˆ†æå»ºè®®">åç»­åˆ†æå»ºè®®</h2><ul><li>æ·±å…¥å‰–æ <code>.prof</code> æ–‡ä»¶: ä½¿ç”¨ <code>snakeviz</code> æˆ– <code>pstats</code> åˆ†æ <code>MultiDetector</code> é…ç½®ä¸‹å„å…·ä½“æ£€æµ‹å™¨çš„è€—æ—¶ï¼Œä»¥ç²¾ç¡®å®šä½æ€§èƒ½ç“¶é¢ˆã€‚</li><li>æµ‹è¯•å¸§é™é‡‡æ ·: é‰´äºå½“å‰å¤„ç†æ—¶é—´è¾ƒé•¿ï¼Œå¼ºçƒˆå»ºè®®æµ‹è¯•å¸§é™é‡‡æ · (<code>frame_skip</code> æˆ– <code>downscale_factor</code>) å¯¹é•¿è§†é¢‘å¤„ç†æ•ˆç‡çš„å½±å“ã€‚</li><li>å‚æ•°è°ƒä¼˜: é’ˆå¯¹ <code>MultiDetector</code> ä¸­çš„å„ä¸ªæ£€æµ‹å™¨ï¼Œç»†è‡´è°ƒæ•´å…¶å‚æ•°ï¼Œå¯»æ‰¾æ€§èƒ½ä¸å‡†ç¡®åº¦çš„æœ€ä½³å¹³è¡¡ç‚¹ã€‚</li><li>å¤šæ ·åŒ–æµ‹è¯•: ä½¿ç”¨æ›´å¤šä¸åŒç±»å‹å’Œé•¿åº¦çš„è§†é¢‘è¿›è¡Œæµ‹è¯•ï¼Œä»¥éªŒè¯å½“å‰ç»“è®ºçš„æ™®é€‚æ€§ã€‚</li></ul><h4 id="æµ‹è¯•ç»“æœå¦‚å›¾">æµ‹è¯•ç»“æœå¦‚å›¾</h4><h5 id="macOSå¹³å°æµ‹è¯•ç»“æœå›¾ç¤º">macOSå¹³å°æµ‹è¯•ç»“æœå›¾ç¤º</h5><ul><li>cpu</li></ul><p><img src="/2025/05/30/scene-detect-benchmark/cpu_prof.png" class="lazyload placeholder" data-srcset="/2025/05/30/scene-detect-benchmark/cpu_prof.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><p><img src="/2025/05/30/scene-detect-benchmark/cpu_profile_1.png" class="lazyload placeholder" data-srcset="/2025/05/30/scene-detect-benchmark/cpu_profile_1.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li>gpu</li></ul><p><img src="/2025/05/30/scene-detect-benchmark/gpu_prof.png" class="lazyload placeholder" data-srcset="/2025/05/30/scene-detect-benchmark/gpu_prof.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><p><img src="/2025/05/30/scene-detect-benchmark/gpu_prof_1.png" class="lazyload placeholder" data-srcset="/2025/05/30/scene-detect-benchmark/gpu_prof_1.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h5 id="windowå¹³å°æµ‹è¯•ç»“æœå›¾ç¤º">windowå¹³å°æµ‹è¯•ç»“æœå›¾ç¤º</h5><ul><li>cpu</li></ul><p><img src="/2025/05/30/scene-detect-benchmark/cpu_win_pro.png" class="lazyload placeholder" data-srcset="/2025/05/30/scene-detect-benchmark/cpu_win_pro.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><p><img src="/2025/05/30/scene-detect-benchmark/cpu_win_pro_1.png" class="lazyload placeholder" data-srcset="/2025/05/30/scene-detect-benchmark/cpu_win_pro_1.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li>gpu</li></ul><p><img src="/2025/05/30/scene-detect-benchmark/gpu_win_pro.png" class="lazyload placeholder" data-srcset="/2025/05/30/scene-detect-benchmark/gpu_win_pro.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><p><img src="/2025/05/30/scene-detect-benchmark/gpu_win_pro_1.png" class="lazyload placeholder" data-srcset="/2025/05/30/scene-detect-benchmark/gpu_win_pro_1.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;åœºæ™¯æ£€æµ‹æ€§èƒ½ä¼˜åŒ–æ–¹å‘ä¸æµ‹è¯•æ–¹æ³•&lt;/h1&gt;
&lt;h2 id=&quot;1-å¼•è¨€&quot;&gt;1. å¼•è¨€&lt;/h2&gt;
&lt;p&gt;æœ¬æŒ‡å—æ—¨åœ¨æä¾›ä¸€å¥—ç³»ç»ŸåŒ–çš„æ–¹æ³•ï¼Œç”¨äºéªŒè¯å’Œåˆ†æè§†é¢‘å¤„ç†é¡¹ç›®çš„æ•ˆç‡ï¼Œç‰¹åˆ«æ˜¯é’ˆå¯¹åœºæ™¯æ£€æµ‹æ¨¡å—çš„æ€§èƒ½ã€‚é€šè¿‡æ”¶é›†å…³é”®æ€§èƒ½æŒ‡æ ‡ (KPIs)&lt;br&gt;
å’Œå‰–æä»£ç æ‰§è¡Œï¼Œæˆ‘ä»¬å¯ä»¥è¯†åˆ«æ€§èƒ½ç“¶</summary>
      
    
    
    
    
    <category term="python" scheme="https://caozhaoqi.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>PySceneDetect ä¸­åœºæ™¯æ£€æµ‹å™¨</title>
    <link href="https://caozhaoqi.github.io/2025/05/15/scene-detect-method/"/>
    <id>https://caozhaoqi.github.io/2025/05/15/scene-detect-method/</id>
    <published>2025-05-15T02:05:41.000Z</published>
    <updated>2025-11-25T15:05:10.362Z</updated>
    
    <content type="html"><![CDATA[<h1>PySceneDetect ä¸­åœºæ™¯æ£€æµ‹å™¨</h1><blockquote><p>ä¸»è¦åŒ…æ‹¬ï¼š<code>ContentDetector</code>, <code>ThresholdDetector</code>, <code>AdaptiveDetector</code>çš„ç®—æ³•åŠå‚æ•°å«ä¹‰ã€ç®—æ³•æ€æƒ³ä»¥åŠå¦‚ä½•ç¡®å®šè¿™äº›å‚æ•°ã€‚</p></blockquote><h2 id="é€šç”¨æ¦‚å¿µ"><strong>é€šç”¨æ¦‚å¿µ</strong></h2><ul><li><strong>åœºæ™¯ (Scene):</strong> ä¸€ç³»åˆ—è¿ç»­çš„ã€åœ¨è§†è§‰ä¸Šæˆ–å™äº‹ä¸Šæ„æˆä¸€ä¸ªå•å…ƒçš„é•œå¤´ã€‚</li><li><strong>åˆ‡ç‚¹ (Cut/Scene Break):</strong> ä¸¤ä¸ªä¸åŒåœºæ™¯ä¹‹é—´çš„è¾¹ç•Œã€‚</li><li><strong>å¸§é—´å·®å¼‚ (Frame-to-Frame Difference):</strong> æ£€æµ‹å™¨é€šå¸¸é€šè¿‡æ¯”è¾ƒè¿ç»­ï¼ˆæˆ–é—´éš”çš„ï¼‰è§†é¢‘å¸§ä¹‹é—´çš„å·®å¼‚æ¥è¯†åˆ«æ½œåœ¨çš„åˆ‡ç‚¹ã€‚å·®å¼‚çš„è®¡ç®—æ–¹å¼å› æ£€æµ‹å™¨è€Œå¼‚ã€‚</li><li><strong>é˜ˆå€¼ (Threshold):</strong> ä¸€ä¸ªé¢„è®¾çš„æ•°å€¼ã€‚å½“è®¡ç®—å‡ºçš„å¸§é—´å·®å¼‚è¶…è¿‡è¿™ä¸ªé˜ˆå€¼æ—¶ï¼Œæ£€æµ‹å™¨å°±è®¤ä¸ºå¯èƒ½å‘ç”Ÿäº†ä¸€ä¸ªåœºæ™¯åˆ‡æ¢ã€‚</li><li><strong>æœ€å°åœºæ™¯é•¿åº¦ (Min Scene Length / <code>min_scene_len</code>):</strong> æ£€æµ‹åˆ°çš„åœºæ™¯å¿…é¡»è¾¾åˆ°çš„æœ€çŸ­æŒç»­æ—¶é—´ï¼ˆé€šå¸¸ä»¥å¸§æ•°æˆ–æ—¶é—´ç è¡¨ç¤ºï¼‰ã€‚å¦‚æœä¸¤ä¸ªæ£€æµ‹åˆ°çš„åŸå§‹åˆ‡ç‚¹ä¹‹é—´çš„è·ç¦»å°äºè¿™ä¸ªå€¼ï¼Œå®ƒä»¬å¯èƒ½ä¼šè¢«åˆå¹¶ï¼Œä»¥é¿å…äº§ç”Ÿè¿‡å¤šéå¸¸çŸ­çš„ã€æ— æ„ä¹‰çš„åœºæ™¯ç‰‡æ®µã€‚<strong>ä¸ºäº†åˆ†æå’Œæ‰¾åˆ°æœ€ä½³æ£€æµ‹å‚æ•°ï¼Œæˆ‘ä»¬é€šå¸¸å°†è¿™ä¸ªå€¼è®¾ä¸º1å¸§ï¼Œä»¥è§‚å¯Ÿæ£€æµ‹å™¨æœ€åŸå§‹çš„è¾“å‡ºã€‚</strong></li></ul><hr><h2 id="ç®—æ³•æ¦‚è¿°">ç®—æ³•æ¦‚è¿°</h2><p><strong>1. <code>ThresholdDetector</code> (é˜ˆå€¼æ£€æµ‹å™¨)</strong></p><blockquote><p>ä¸»è¦æ£€æµ‹æ·¡å…¥æ·¡å‡ºåˆ°é»‘å±æˆ–ç™½å±åœºæ™¯</p></blockquote><ul><li><p><strong>å‘½ä»¤:</strong> <code>detect-threshold</code></p></li><li><p><strong>æ ¸å¿ƒæ€æƒ³:</strong> ä¸»è¦é€šè¿‡ç›‘æµ‹è§†é¢‘å¸§çš„<strong>å¹³å‡äº®åº¦/å¼ºåº¦</strong>æ˜¯å¦è·¨è¶Šä¸€ä¸ªå›ºå®šçš„é˜ˆå€¼æ¥åˆ¤æ–­æ·¡å…¥/æ·¡å‡ºäº‹ä»¶ã€‚å®ƒå‡è®¾åœºæ™¯åˆ‡æ¢ï¼ˆç‰¹åˆ«æ˜¯æ·¡å…¥æ·¡å‡ºï¼‰ä¼šä¼´éšç€ç”»é¢æ•´ä½“å˜äº®æˆ–å˜æš—åˆ°æŸä¸ªç¨‹åº¦ã€‚</p></li><li><p><strong>ä¸»è¦å‚æ•°åŠå…¶å«ä¹‰ï¼š</strong></p><ul><li><p><strong><code>threshold</code> (æˆ– <code>-t VAL</code>)</strong>:</p><ul><li><strong>å«ä¹‰:</strong> ä¸€ä¸ª 0-255 ä¹‹é—´çš„æ•´æ•°ï¼ˆæˆ–æµ®ç‚¹æ•°ï¼‰ã€‚è¿™æ˜¯åˆ¤æ–­ç”»é¢æ˜¯å¦è¿›å…¥â€œæ·¡å‡ºâ€æˆ–â€œæ·¡å…¥â€çŠ¶æ€çš„äº®åº¦åŸºå‡†ã€‚</li><li><strong>ç®—æ³•äº¤äº’:</strong> ä¸ <code>method</code> å‚æ•°é…åˆä½¿ç”¨ã€‚</li><li><strong>å¦‚ä½•ç¡®å®š:</strong><ol><li><strong>ä½¿ç”¨äº®åº¦åˆ†æå·¥å…· (å¦‚æˆ‘ä»¬ä¹‹å‰ç¼–å†™çš„ <code>analyze_brightness.py</code>)</strong>ï¼šæŸ¥çœ‹ä½ çš„è§†é¢‘åœ¨å‘ç”Ÿæ·¡å…¥æ·¡å‡ºåˆ°â€œé»‘å±â€æˆ–â€œç™½å±â€æ—¶ï¼Œé‚£äº›â€œé»‘/ç™½â€å¸§çš„å®é™…å¹³å‡äº®åº¦å€¼ã€‚</li><li>å¦‚æœä½¿ç”¨ <code>method = FLOOR</code> (æ£€æµ‹æ·¡å‡ºåˆ°æš—/ä»æš—æ·¡å…¥)ï¼š<code>threshold</code> åº”ç•¥é«˜äºè§†é¢‘ä¸­â€œé»‘å±â€çŠ¶æ€çš„å¹³å‡äº®åº¦ã€‚ä¾‹å¦‚ï¼Œå¦‚æœé»‘å±äº®åº¦åœ¨ 2-5 ä¹‹é—´ï¼Œä½ å¯ä»¥å°è¯• <code>threshold = 5</code> æˆ– <code>8</code> æˆ– <code>10</code>ã€‚å¦‚æœé˜ˆå€¼è®¾å¾—å¤ªä½ï¼ˆæ¯”å¦‚1ï¼‰ï¼Œé‚£ä¹ˆåªæœ‰å‡ ä¹çº¯é»‘çš„å¸§æ‰ä¼šè¢«è¯†åˆ«ã€‚</li><li>å¦‚æœä½¿ç”¨ <code>method = CEILING</code> (æ£€æµ‹æ·¡å‡ºåˆ°äº®/ä»äº®æ·¡å…¥)ï¼š<code>threshold</code> åº”ç•¥ä½äºè§†é¢‘ä¸­â€œç™½å±â€çŠ¶æ€çš„å¹³å‡äº®åº¦ã€‚ä¾‹å¦‚ï¼Œå¦‚æœç™½å±äº®åº¦åœ¨ 250-253 ä¹‹é—´ï¼Œä½ å¯ä»¥å°è¯• <code>threshold = 250</code> æˆ– <code>245</code>ã€‚</li><li><strong>å®éªŒæ³•ï¼š</strong> ä»ä¸€ä¸ªç›¸å¯¹å®½æ¾çš„å€¼å¼€å§‹ï¼ˆä¾‹å¦‚ï¼Œå¯¹äº FLOOR æ–¹æ³•ï¼Œä» 15-20 å¼€å§‹ï¼›å¯¹äº CEILINGï¼Œä» 230-240 å¼€å§‹ï¼‰ï¼Œç„¶åé€æ¸å‘æ›´ä¸¥æ ¼çš„å€¼è°ƒæ•´ï¼ˆFLOOR å‘ä¸‹è°ƒï¼ŒCEILING å‘ä¸Šè°ƒï¼‰ï¼ŒåŒæ—¶è§‚å¯Ÿ <code>save-images</code> çš„ç»“æœã€‚</li></ol></li></ul></li><li><p><strong><code>fade_bias</code> (æˆ– <code>-f PERCENT</code>)</strong>:</p><ul><li><strong>å«ä¹‰:</strong> ä¸€ä¸ªç™¾åˆ†æ¯”å€¼ï¼ˆå‘½ä»¤è¡Œæ˜¯ -100 åˆ° 100ï¼ŒPython ç±»å†…éƒ¨æ˜¯ -1.0 åˆ° +1.0ï¼‰ã€‚å®ƒè°ƒæ•´æ£€æµ‹åˆ°çš„æ·¡å…¥æ·¡å‡ºåˆ‡ç‚¹çš„<strong>ç²¾ç¡®ä½ç½®</strong>ã€‚</li><li><strong>ç®—æ³•äº¤äº’:</strong> å½“æ£€æµ‹å™¨è¯†åˆ«åˆ°ä¸€æ¬¡äº®åº¦ä»é˜ˆå€¼ä¸€ä¾§è·¨è¶Šåˆ°å¦ä¸€ä¾§ï¼ˆä¾‹å¦‚ï¼Œä»é«˜äºé˜ˆå€¼å˜ä¸ºä½äºé˜ˆå€¼ï¼Œå†æ¢å¤åˆ°é«˜äºé˜ˆå€¼ï¼Œè¿™æ„æˆä¸€æ¬¡æ·¡å‡ºå†æ·¡å…¥ï¼‰ï¼Œ<code>fade_bias</code> å†³å®šåˆ‡ç‚¹æ”¾åœ¨è¿™ä¸ªè¿‡ç¨‹çš„å“ªä¸ªé˜¶æ®µã€‚<ul><li>å‘½ä»¤è¡Œ <code>-100</code> (Python <code>-1.0</code>): åˆ‡ç‚¹å°½å¯èƒ½é è¿‘å®Œå…¨æ·¡å‡ºåˆ°é»‘/ç™½çš„æ—¶åˆ»ï¼Œæˆ–è€…åˆšå¼€å§‹ä»é»‘/ç™½æ¢å¤çš„æ—¶åˆ»ï¼ˆå–å†³äºå…·ä½“å®ç°å’Œæ·¡å…¥/æ·¡å‡ºæ–¹å‘ï¼‰ã€‚</li><li>å‘½ä»¤è¡Œ <code>0</code> (Python <code>0.0</code>): åˆ‡ç‚¹æ”¾åœ¨æ·¡å‡ºå’Œæ·¡å…¥è¿‡ç¨‹çš„ä¸­é—´ã€‚</li><li>å‘½ä»¤è¡Œ <code>+100</code> (Python <code>+1.0</code>): åˆ‡ç‚¹å°½å¯èƒ½é è¿‘åˆšå¼€å§‹æ·¡å‡ºæˆ–å®Œå…¨æ·¡å…¥å®Œæˆçš„æ—¶åˆ»ã€‚</li></ul></li><li><strong>å¦‚ä½•ç¡®å®š:</strong><ol><li>é€šå¸¸å¯¹äºè§†é¢‘é—´çš„åˆ‡æ¢ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨ç”»é¢å®Œå…¨å˜é»‘/ç™½ä¹‹åï¼Œæˆ–è€…åˆšå¼€å§‹æœ‰æ–°ç”»é¢æ—¶è¿›è¡Œåˆ‡å‰²ã€‚æ‰€ä»¥ä¸€ä¸ªä¸­ç­‰åˆ°è¾ƒå¤§çš„è´Ÿåç½®ï¼ˆä¾‹å¦‚å‘½ä»¤è¡Œçš„ <code>30</code> åˆ° <code>70</code>ï¼Œå¯¹åº” Python çš„ <code>(PERCENT/50.0) - 1.0</code>ï¼‰å¯èƒ½æ˜¯åˆé€‚çš„ï¼Œè¿™ä¼šä½¿åˆ‡ç‚¹æ›´å€¾å‘äºâ€œé»‘åœºâ€çš„è¾¹ç¼˜ã€‚</li><li><strong>å®éªŒæ³•ï¼š</strong> è®¾ç½®ä¸€ä¸ªåŸºç¡€çš„ <code>threshold</code>ï¼Œç„¶åå°è¯•ä¸åŒçš„ <code>fade_bias</code> å€¼ï¼ˆä¾‹å¦‚ -80, -50, 0, 50, 80ï¼‰ï¼Œè§‚å¯Ÿ <code>save-images</code> ä¸­åˆ‡ç‚¹å›¾ç‰‡çš„ä½ç½®ï¼Œçœ‹å“ªä¸ªæœ€ç¬¦åˆä½ çš„æœŸæœ›ã€‚</li></ol></li></ul></li><li><p><strong><code>method</code> (Python ç±»å‚æ•°ï¼Œ<code>ThresholdDetector.Method.FLOOR</code> æˆ– <code>ThresholdDetector.Method.CEILING</code>)</strong>:</p><ul><li><strong>å«ä¹‰:</strong> å®šä¹‰äº†å¦‚ä½•å°†å¸§çš„å¹³å‡äº®åº¦ä¸ <code>threshold</code> è¿›è¡Œæ¯”è¾ƒæ¥è§¦å‘äº‹ä»¶ã€‚<ul><li><code>FLOOR</code>: å½“å¸§äº®åº¦<strong>ä½äº (falls below)</strong> <code>threshold</code> æ—¶ï¼Œè®¤ä¸ºæ˜¯æ·¡å‡ºï¼ˆåˆ°æš—ï¼‰ï¼›å½“ä»ä½äºçŠ¶æ€æ¢å¤åˆ°<strong>é«˜äºç­‰äº</strong> <code>threshold</code> æ—¶ï¼Œè®¤ä¸ºæ˜¯æ·¡å…¥ï¼ˆä»æš—ï¼‰ã€‚</li><li><code>CEILING</code>: å½“å¸§äº®åº¦<strong>é«˜äº (rises above)</strong> <code>threshold</code> æ—¶ï¼Œè®¤ä¸ºæ˜¯æ·¡å‡ºï¼ˆåˆ°äº®ï¼‰ï¼›å½“ä»é«˜äºçŠ¶æ€æ¢å¤åˆ°<strong>ä½äº</strong> <code>threshold</code> æ—¶ï¼Œè®¤ä¸ºæ˜¯æ·¡å…¥ï¼ˆä»äº®ï¼‰ã€‚</li></ul></li><li><strong>å¦‚ä½•ç¡®å®š:</strong><ol><li>å¦‚æœä½ çš„è§†é¢‘ä¸»è¦æ˜¯æ·¡å…¥æ·¡å‡ºåˆ°<strong>é»‘è‰²</strong>ï¼Œæˆ–è€…ä»é»‘è‰²æ·¡å…¥ï¼Œé€‰æ‹© <code>FLOOR</code>ã€‚</li><li>å¦‚æœä½ çš„è§†é¢‘ä¸»è¦æ˜¯æ·¡å…¥æ·¡å‡ºåˆ°<strong>ç™½è‰²</strong>ï¼Œæˆ–è€…ä»ç™½è‰²æ·¡å…¥ï¼Œé€‰æ‹© <code>CEILING</code> (å¹¶é…åˆéå¸¸é«˜çš„ <code>threshold</code>)ã€‚</li><li>ä½ çš„ <code>config.ini</code> ä¸­ <code>method = FLOOR</code> (å› ä¸º <code>FRAME_AVERAGE</code> ä¼šå›é€€åˆ° <code>FLOOR</code>)ï¼Œæ‰€ä»¥å½“å‰æ˜¯é’ˆå¯¹æš—åœºæ™¯çš„ã€‚</li></ol></li></ul></li><li><p><strong><code>min_scene_len</code> (æˆ– <code>-m TIMECODE</code>ï¼Œå‘½ä»¤è¡Œæ˜¯ <code>-m 1</code> è¡¨ç¤º1å¸§)</strong>:</p><ul><li><strong>å«ä¹‰:</strong> æœ€å°åœºæ™¯é•¿åº¦ã€‚</li><li><strong>å¦‚ä½•ç¡®å®š:</strong> ä¸ºäº†åˆ†ææ£€æµ‹å™¨çš„åŸå§‹æ€§èƒ½å’Œæ‰¾åˆ°æœ€ä½³çš„ <code>threshold</code> / <code>fade_bias</code>ï¼Œ<strong>å§‹ç»ˆå°†å…¶è®¾ç½®ä¸º <code>1</code> (æˆ– <code>1f</code>ï¼Œæ ¹æ®å…·ä½“å‘½ä»¤æ ¼å¼)</strong>ã€‚åœ¨ç¡®å®šäº†æœ€ä½³æ£€æµ‹å‚æ•°åï¼Œå¦‚æœéœ€è¦é¿å…è¿‡å¤šçŸ­ç‰‡æ®µï¼Œå†åœ¨æœ€ç»ˆå¤„ç†æ—¶è€ƒè™‘å¢å¤§è¿™ä¸ªå€¼ã€‚</li></ul></li></ul></li></ul><hr><p><strong>2. <code>ContentDetector</code> (å†…å®¹æ£€æµ‹å™¨)</strong></p><ul><li><p><strong>å‘½ä»¤:</strong> <code>detect-content</code></p></li><li><p><strong>æ ¸å¿ƒæ€æƒ³:</strong> é€šè¿‡æ¯”è¾ƒè¿ç»­å¸§ä¹‹é—´<strong>è§†è§‰å†…å®¹çš„æ•´ä½“å·®å¼‚</strong>æ¥æ£€æµ‹åœºæ™¯åˆ‡æ¢ã€‚å®ƒä¸ä»…ä»…çœ‹äº®åº¦ï¼Œè¿˜ä¼šè€ƒè™‘é¢œè‰²åˆ†å¸ƒï¼ˆè‰²è°ƒ Hue, é¥±å’Œåº¦ Saturationï¼‰å’Œå¯èƒ½çš„è¾¹ç¼˜ä¿¡æ¯ã€‚å¯¹äºå¹³å‡äº®åº¦å˜åŒ–ä¸å¤§ä½†å†…å®¹å‘ç”Ÿæ˜¾è‘—æ”¹å˜çš„åˆ‡æ¢ï¼ˆå¦‚äº¤å‰æ·¡åŒ–ã€æŸäº›å¿«é€Ÿå‰ªè¾‘ï¼‰é€šå¸¸æ›´æœ‰æ•ˆã€‚</p></li><li><p><strong>ä¸»è¦å‚æ•°åŠå…¶å«ä¹‰ï¼š</strong></p><ul><li><p><strong><code>threshold</code> (æˆ– <code>-t VAL</code>)</strong>:</p><ul><li><strong>å«ä¹‰:</strong> ä¸€ä¸ªæµ®ç‚¹æ•°ï¼Œè¡¨ç¤ºå¸§é—´å†…å®¹å·®å¼‚çš„é˜ˆå€¼ã€‚è¿™ä¸ªå·®å¼‚å€¼æ˜¯ç»¼åˆäº†è‰²è°ƒã€é¥±å’Œåº¦ã€äº®åº¦ï¼ˆä»¥åŠå¯èƒ½æœ‰çš„è¾¹ç¼˜ï¼‰é€šé“çš„å˜åŒ–è®¡ç®—å‡ºæ¥çš„ã€‚</li><li><strong>ç®—æ³•äº¤äº’:</strong> å½“è®¡ç®—å‡ºçš„å¸§é—´å†…å®¹ç»¼åˆå·®å¼‚å€¼<strong>è¶…è¿‡</strong>æ­¤é˜ˆå€¼æ—¶ï¼Œè§¦å‘åˆ‡ç‚¹ã€‚</li><li><strong>å¦‚ä½•ç¡®å®š:</strong><ol><li><code>ContentDetector</code> çš„é˜ˆå€¼èŒƒå›´å’Œæ•æ„Ÿåº¦ä¸ <code>ThresholdDetector</code> ä¸åŒã€‚é»˜è®¤å€¼é€šå¸¸åœ¨ 20-35 ä¹‹é—´ã€‚</li><li><strong>è¾ƒä½çš„é˜ˆå€¼æ„å‘³ç€æ›´æ•æ„Ÿã€‚</strong> å¯¹äºå¹³æ»‘çš„äº¤å‰æ·¡åŒ–æˆ–ç»†å¾®çš„å†…å®¹å˜åŒ–ï¼Œä½ å¯èƒ½éœ€è¦å°†é˜ˆå€¼é™ä½åˆ° 15-25ï¼Œç”šè‡³æ›´ä½ï¼ˆ5-15ï¼‰ã€‚</li><li><strong>å®éªŒæ³•æ˜¯å…³é”®ï¼š</strong><ul><li><strong>ä½¿ç”¨ <code>threshold_explorer.py</code> å·¥å…·ï¼ˆä»£ç è§åï¼‰</strong>ï¼šè¿™æ˜¯æœ€ç³»ç»Ÿçš„æ–¹æ³•ã€‚è®¾å®šä¸€ä¸ªé˜ˆå€¼èŒƒå›´ï¼ˆä¾‹å¦‚ï¼Œä» 5.0 åˆ° 30.0ï¼Œæ­¥é•¿ 1.0 æˆ– 2.0ï¼‰ï¼Œå¯¹æŠ½æ ·è§†é¢‘è¿è¡Œã€‚</li><li><strong>è§‚å¯Ÿå›¾è¡¨ï¼š</strong> æŸ¥çœ‹â€œå¹³å‡åœºæ™¯æ•° vs. é˜ˆå€¼â€å›¾ã€‚å¯»æ‰¾æ›²çº¿çš„â€œæ‹ç‚¹â€â€”â€”å³é˜ˆå€¼å†é™ä½ï¼Œåœºæ™¯æ•°å¼€å§‹æ€¥å‰§å¢åŠ ï¼ˆå¯èƒ½å¼•å…¥å™ªå£°ï¼‰ï¼›æˆ–è€…é˜ˆå€¼å†å‡é«˜ï¼Œåœºæ™¯æ•°æ€¥å‰§å‡å°‘ï¼ˆå¯èƒ½é—æ¼åˆ‡æ¢ï¼‰çš„é‚£ä¸ªä¸´ç•ŒåŒºåŸŸã€‚</li><li><strong>ç»“åˆ <code>save-images</code>ï¼š</strong> å¯¹äºä½ åœ¨å›¾è¡¨ä¸Šæ‰¾åˆ°çš„å‡ ä¸ªæœ‰å¸Œæœ›çš„é˜ˆå€¼ç‚¹ï¼Œä½¿ç”¨ <code>--save_images_for</code> é€‰é¡¹ï¼ˆåœ¨ <code>threshold_explorer.py</code> ä¸­ï¼‰æˆ–ç›´æ¥ç”¨ <code>scenedetect</code> å‘½ä»¤è¡Œå·¥å…·ï¼ˆé…åˆ <code>save-images</code>ï¼‰æ¥å®é™…æŸ¥çœ‹è¿™äº›é˜ˆå€¼ä¸‹çš„åˆ‡ç‚¹å›¾ç‰‡ã€‚äººå·¥åˆ¤æ–­è¿™äº›åˆ‡ç‚¹æ˜¯å¦ç¬¦åˆä½ å¯¹äº¤å‰æ·¡åŒ–æˆ–å…¶ä»–åœºæ™¯åˆ‡æ¢çš„å®šä¹‰ã€‚</li></ul></li><li><strong>ä»ä¸€ä¸ªç›¸å¯¹ä¿å®ˆçš„å€¼å¼€å§‹ï¼ˆä¾‹å¦‚ 25-30ï¼‰ï¼Œå¦‚æœæ£€æµ‹ä¸åˆ°è¶³å¤Ÿçš„åœºæ™¯ï¼Œé€æ¸é™ä½é˜ˆå€¼ï¼Œå¹¶è§‚å¯Ÿç»“æœã€‚</strong></li></ol></li></ul></li><li><p><strong><code>min_scene_len</code> (æˆ– <code>-m TIMECODE</code>ï¼Œå‘½ä»¤è¡Œé€šå¸¸æ˜¯ <code>-m 1</code> è¡¨ç¤º1å¸§)</strong>:</p><ul><li><strong>å«ä¹‰:</strong> æœ€å°åœºæ™¯é•¿åº¦ã€‚</li><li><strong>å¦‚ä½•ç¡®å®š:</strong> åŒ <code>ThresholdDetector</code>ï¼Œåœ¨å‚æ•°æ¢ç´¢é˜¶æ®µï¼Œ<strong>å§‹ç»ˆå°†å…¶è®¾ç½®ä¸º <code>1</code></strong>ã€‚</li></ul></li><li><p><strong><code>weights</code> (Hue, Saturation, Luma, Edges - Python ç±»å‚æ•°)</strong>:</p><ul><li><strong>å«ä¹‰:</strong> å®šä¹‰åœ¨è®¡ç®—å¸§é—´å†…å®¹å·®å¼‚æ—¶ï¼Œè‰²è°ƒã€é¥±å’Œåº¦ã€äº®åº¦ã€è¾¹ç¼˜è¿™å‡ ä¸ªåˆ†é‡å„è‡ªæ‰€å çš„æƒé‡ã€‚</li><li><strong>ç®—æ³•äº¤äº’:</strong> å½±å“æœ€ç»ˆçš„ç»¼åˆå·®å¼‚å€¼ã€‚</li><li><strong>å¦‚ä½•ç¡®å®š:</strong><ol><li><strong>é€šå¸¸ä»é»˜è®¤æƒé‡å¼€å§‹ã€‚</strong> PySceneDetect çš„é»˜è®¤æƒé‡æ˜¯ç»è¿‡ä¸€å®šè°ƒä¼˜çš„ã€‚</li><li>å¦‚æœé»˜è®¤æƒé‡æ•ˆæœä¸ä½³ï¼Œå¹¶ä¸”ä½ å¯¹è§†é¢‘å†…å®¹çš„ç‰¹æ€§æœ‰äº†è§£ï¼š<ul><li>å¦‚æœåœºæ™¯åˆ‡æ¢ä¸»è¦ä½“ç°åœ¨<strong>é¢œè‰²</strong>å˜åŒ–ä¸Šï¼ˆä¾‹å¦‚ï¼Œä»å†·è‰²è°ƒåœºæ™¯äº¤å‰æ·¡åŒ–åˆ°æš–è‰²è°ƒåœºæ™¯ï¼‰ï¼Œå¯ä»¥å°è¯•<strong>å¢åŠ  <code>weights_hue</code> å’Œ <code>weights_saturation</code></strong> çš„æƒé‡ï¼ŒåŒæ—¶<strong>å‡å°‘ <code>weights_luma</code></strong> çš„æƒé‡ã€‚</li><li>å¦‚æœåœºæ™¯åˆ‡æ¢ä¸»è¦ä½“ç°åœ¨<strong>ç»“æ„æˆ–ç‰©ä½“è½®å»“</strong>å˜åŒ–ä¸Šï¼Œç¡®ä¿è¾¹ç¼˜æ£€æµ‹è¢«å¯ç”¨å¹¶ä¸” <code>weights_edges</code> æœ‰åˆé€‚çš„æƒé‡ã€‚</li><li>è¿™éƒ¨åˆ†è°ƒæ•´é€šå¸¸éœ€è¦æ›´å¤šçš„å®éªŒå’Œå¯¹è§†é¢‘å†…å®¹çš„ç»†è‡´åˆ†æã€‚ä½ çš„ <code>config.ini</code> å’Œ <code>scene_detector.py</code> å…è®¸ä½ è®¾ç½®è¿™äº›æƒé‡ã€‚</li></ul></li></ol></li></ul></li><li><p><strong><code>luma_only</code> (å¸ƒå°”å€¼)</strong>:</p><ul><li><strong>å«ä¹‰:</strong> å¦‚æœä¸º <code>true</code>ï¼Œåˆ™åœ¨è®¡ç®—å†…å®¹å·®å¼‚æ—¶åªè€ƒè™‘äº®åº¦é€šé“ï¼Œå¿½ç•¥è‰²è°ƒå’Œé¥±å’Œåº¦ã€‚</li><li><strong>ç®—æ³•äº¤äº’:</strong> ç›¸å½“äºå°† <code>weights_hue</code> å’Œ <code>weights_saturation</code> è®¾ä¸º 0ã€‚</li><li><strong>å¦‚ä½•ç¡®å®š:</strong><ol><li>å¯¹äºé¢œè‰²ä¿¡æ¯ä¸°å¯Œä¸”å¯¹åœºæ™¯åŒºåˆ†å¾ˆé‡è¦çš„è§†é¢‘ï¼ˆå°¤å…¶æ˜¯äº¤å‰æ·¡åŒ–ï¼‰ï¼Œé€šå¸¸åº”å°†æ­¤è®¾ä¸º <code>false</code>ï¼ˆé»˜è®¤ï¼‰ã€‚</li><li>å¦‚æœè§†é¢‘æ˜¯é»‘ç™½çš„ï¼Œæˆ–è€…é¢œè‰²ä¿¡æ¯å¹²æ‰°æ€§å¼ºä¸”ä¸é‡è¦ï¼Œå¯ä»¥è®¾ä¸º <code>true</code>ã€‚</li></ol></li></ul></li></ul></li></ul><hr><p><strong>3. <code>AdaptiveDetector</code> (è‡ªé€‚åº”æ£€æµ‹å™¨)</strong></p><ul><li><p><strong>å‘½ä»¤:</strong> <code>detect-adaptive</code></p></li><li><p><strong>æ ¸å¿ƒæ€æƒ³:</strong> ä¸ <code>ContentDetector</code> ç±»ä¼¼ï¼Œå®ƒä¹Ÿè®¡ç®—å¸§é—´å†…å®¹çš„å·®å¼‚ã€‚ä½†ä¸åŒä¹‹å¤„åœ¨äºï¼Œå®ƒä¸æ˜¯ä½¿ç”¨ä¸€ä¸ªå›ºå®šçš„å…¨å±€é˜ˆå€¼ï¼Œè€Œæ˜¯æ ¹æ®æœ€è¿‘ä¸€æ®µè§†é¢‘çª—å£å†…çš„å¸§é—´å·®å¼‚åŠ¨æ€åœ°è®¡ç®—ä¸€ä¸ªè‡ªé€‚åº”é˜ˆå€¼ã€‚å½“æŸä¸€å¸§çš„å·®å¼‚æ˜¾è‘—é«˜äºè¿™ä¸ªåŠ¨æ€è®¡ç®—å‡ºçš„å±€éƒ¨å¹³å‡å·®å¼‚æ—¶ï¼Œè§¦å‘åˆ‡ç‚¹ã€‚</p></li><li><p><strong>é€‚ç”¨åœºæ™¯:</strong> å¯¹äºè§†é¢‘æ•´ä½“äº®åº¦æˆ–å†…å®¹å˜åŒ–å¹…åº¦ä¸ä¸€è‡´çš„æƒ…å†µå¯èƒ½æœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªè§†é¢‘å¯èƒ½æœ‰äº›éƒ¨åˆ†å˜åŒ–å‰§çƒˆï¼Œæœ‰äº›éƒ¨åˆ†å˜åŒ–å¹³ç¼“ã€‚å›ºå®šé˜ˆå€¼å¯èƒ½éš¾ä»¥åŒæ—¶é€‚åº”è¿™ä¸¤ç§æƒ…å†µã€‚</p></li><li><p><strong>ä¸»è¦å‚æ•°åŠå…¶å«ä¹‰ï¼š</strong></p><ul><li><p><strong><code>adaptive_threshold</code> (æˆ– <code>-t VAL</code>)</strong>:</p><ul><li><strong>å«ä¹‰:</strong> ä¸€ä¸ªä¹˜æ•°å› å­ï¼ˆé€šå¸¸æ˜¯è¾ƒå°çš„æµ®ç‚¹æ•°ï¼Œä¾‹å¦‚ 2.0-5.0ï¼Œé»˜è®¤å¯èƒ½æ˜¯ 3.0ï¼‰ã€‚</li><li><strong>ç®—æ³•äº¤äº’:</strong> æ£€æµ‹å™¨ä¼šè®¡ç®—ä¸€ä¸ªåŸºäºæ»‘åŠ¨çª—å£çš„å¸§é—´å·®å¼‚çš„ç»Ÿè®¡é‡ï¼ˆä¾‹å¦‚å¹³å‡å€¼æˆ–ç§»åŠ¨å¹³å‡å€¼ï¼‰ã€‚å¦‚æœå½“å‰å¸§çš„å·®å¼‚è¶…è¿‡äº†è¿™ä¸ªç»Ÿè®¡é‡ä¹˜ä»¥ <code>adaptive_threshold</code>ï¼Œåˆ™è®¤ä¸ºæ˜¯ä¸€ä¸ªåˆ‡ç‚¹ã€‚å€¼è¶Šå¤§ï¼Œæ£€æµ‹è¶Šä¸æ•æ„Ÿï¼ˆéœ€è¦æ›´å¤§çš„ç›¸å¯¹å˜åŒ–ï¼‰ã€‚</li><li><strong>å¦‚ä½•ç¡®å®š:</strong><ol><li><strong>å®éªŒæ³•ï¼š</strong> ä»é»˜è®¤å€¼ï¼ˆä¾‹å¦‚ 3.0ï¼‰å¼€å§‹ã€‚</li><li>å¦‚æœæ£€æµ‹åˆ°çš„åœºæ™¯å¤ªå°‘ï¼Œå°è¯•é™ä½æ­¤å€¼ï¼ˆä¾‹å¦‚ 2.5, 2.0ï¼‰ã€‚</li><li>å¦‚æœæ£€æµ‹åˆ°çš„åœºæ™¯å¤ªå¤šï¼ˆå™ªå£°ï¼‰ï¼Œå°è¯•å¢åŠ æ­¤å€¼ï¼ˆä¾‹å¦‚ 3.5, 4.0ï¼‰ã€‚</li><li>åŒæ ·ï¼Œç»“åˆ <code>save-images</code> è¿›è¡Œäººå·¥æ£€æŸ¥ã€‚</li></ol></li></ul></li><li><p><strong><code>min_scene_len</code> (æˆ– <code>-m TIMECODE</code>)</strong>:</p><ul><li><strong>å«ä¹‰:</strong> æœ€å°åœºæ™¯é•¿åº¦ã€‚</li><li><strong>å¦‚ä½•ç¡®å®š:</strong> åŒä¸Šï¼Œå‚æ•°æ¢ç´¢é˜¶æ®µè®¾ä¸º <code>1</code>ã€‚</li></ul></li><li><p><strong><code>window_width</code> (æˆ– <code>--window_width VAL</code>, å¸§æ•°)</strong>:</p><ul><li><strong>å«ä¹‰:</strong> ç”¨äºè®¡ç®—è‡ªé€‚åº”é˜ˆå€¼çš„æ»‘åŠ¨çª—å£çš„å®½åº¦ï¼ˆä»¥å¸§ä¸ºå•ä½ï¼‰ã€‚å¦‚æœä¸º 0ï¼Œæ£€æµ‹å™¨é€šå¸¸ä¼šæ ¹æ®è§†é¢‘å¸§ç‡è‡ªåŠ¨è®¾ç½®ä¸€ä¸ªåˆç†çš„çª—å£å¤§å°ã€‚</li><li><strong>ç®—æ³•äº¤äº’:</strong> çª—å£è¶Šå¤§ï¼Œè‡ªé€‚åº”é˜ˆå€¼å¯¹å±€éƒ¨å¿«é€Ÿå˜åŒ–çš„æ•æ„Ÿåº¦è¶Šä½ï¼Œå¯¹è¾ƒé•¿æ—¶é—´çš„å¹³å‡å˜åŒ–æ›´æ•æ„Ÿã€‚çª—å£è¶Šå°ï¼Œå¯¹å±€éƒ¨çªå˜è¶Šæ•æ„Ÿã€‚</li><li><strong>å¦‚ä½•ç¡®å®š:</strong><ol><li>é€šå¸¸å¯ä»¥ä»é»˜è®¤å€¼ (0ï¼Œå³è‡ªåŠ¨) å¼€å§‹ã€‚</li><li>å¦‚æœè‡ªåŠ¨è®¾ç½®æ•ˆæœä¸ä½³ï¼Œå¯ä»¥æ ¹æ®è§†é¢‘çš„å¹³å‡é•œå¤´é•¿åº¦æˆ–å˜åŒ–èŠ‚å¥æ¥æ‰‹åŠ¨è®¾ç½®ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå¿«é€Ÿå‰ªè¾‘å¤šï¼Œå¯ä»¥å°è¯•è¾ƒå°çš„çª—å£ï¼›å¦‚æœé•¿é•œå¤´å¤šï¼Œå¯ä»¥å°è¯•è¾ƒå¤§çš„çª—å£ã€‚</li></ol></li></ul></li><li><p><strong><code>min_delta_hsv</code> (æµ®ç‚¹æ•° 0-255)</strong>:</p><ul><li><strong>å«ä¹‰:</strong> æœ‰äº›ç‰ˆæœ¬çš„ <code>AdaptiveDetector</code> å¯èƒ½ä½¿ç”¨è¿™ä¸ªå‚æ•°ã€‚å®ƒè®¾å®šäº†ä¸€ä¸ªå¸§é—´ HSVï¼ˆè‰²è°ƒã€é¥±å’Œåº¦ã€äº®åº¦ï¼‰å·®å¼‚çš„æœ€å°ç»å¯¹å€¼ã€‚å³ä½¿ç›¸å¯¹å·®å¼‚ï¼ˆé€šè¿‡ <code>adaptive_threshold</code> åˆ¤æ–­ï¼‰å¾ˆå¤§ï¼Œä½†å¦‚æœç»å¯¹å·®å¼‚æœ¬èº«éå¸¸å°ï¼ˆä¾‹å¦‚ï¼Œåœ¨å‡ ä¹å…¨é»‘çš„åœºæ™¯ä¸­å¾®å°çš„å™ªå£°å˜åŒ–ï¼‰ï¼Œä¹Ÿå¯èƒ½ä¸è¢«è§†ä¸ºåˆ‡ç‚¹ã€‚è¿™æœ‰åŠ©äºè¿‡æ»¤æ‰åœ¨éå¸¸ä½å¯¹æ¯”åº¦åŒºåŸŸçš„å™ªå£°ã€‚</li><li><strong>å¦‚ä½•ç¡®å®š:</strong><ol><li>å¦‚æœä½ çš„è§†é¢‘ä¸­æœ‰éå¸¸æš—æˆ–å¯¹æ¯”åº¦éå¸¸ä½çš„åŒºåŸŸï¼Œå¹¶ä¸” <code>AdaptiveDetector</code> åœ¨è¿™äº›åŒºåŸŸäº§ç”Ÿäº†è¯¯æŠ¥ï¼Œå¯ä»¥å°è¯•å¢åŠ æ­¤å€¼ï¼ˆä¾‹å¦‚ä»é»˜è®¤çš„ 10-15 å¢åŠ åˆ° 20-25ï¼‰ã€‚</li></ol></li></ul></li></ul></li></ul><h2 id="é€šç”¨å‚æ•°ç¡®å®šæµç¨‹ï¼š"><strong>é€šç”¨å‚æ•°ç¡®å®šæµç¨‹ï¼š</strong></h2><ol><li><p><strong>é€‰æ‹©æ£€æµ‹å™¨ç±»å‹ï¼š</strong></p><ul><li><strong>æ·¡å…¥æ·¡å‡ºåˆ°é»‘/ç™½ï¼š</strong> ä¼˜å…ˆå°è¯• <code>ThresholdDetector</code>ã€‚</li><li><strong>äº¤å‰æ·¡åŒ–ã€å†…å®¹å˜åŒ–æ˜æ˜¾ä½†äº®åº¦å˜åŒ–ä¸å¤§ï¼š</strong> ä¼˜å…ˆå°è¯• <code>ContentDetector</code>ã€‚</li><li><strong>è§†é¢‘å†…å®¹å˜åŒ–ç‰¹å¾ä¸ä¸€è‡´ï¼Œéš¾ä»¥ç”¨å›ºå®šé˜ˆå€¼æŠŠæ¡ï¼š</strong> å¯ä»¥å°è¯• <code>AdaptiveDetector</code>ã€‚</li><li><strong>ä¸ç¡®å®šæˆ–æƒ³ç»„åˆä½¿ç”¨ï¼š</strong> å¯ä»¥ä½¿ç”¨ <code>MultiDetector</code>ï¼Œå¹¶åˆ†åˆ«é…ç½®ä¸Šè¿°æ£€æµ‹å™¨ï¼ˆåœ¨ä½ çš„ <code>config.ini</code> ä¸­å°† <code>[SceneDetectorSetup]</code> çš„ <code>detector_type</code> è®¾ä¸º <code>MultiDetector</code>ï¼Œç„¶ååœ¨å„ä¸ªæ£€æµ‹å™¨çš„é…ç½®èŠ‚ä¸­è®¾ç½® <code>enabled = true</code> å’Œç›¸åº”çš„å‚æ•°ï¼‰ã€‚</li></ul></li><li><p><strong>è®¾ç½® <code>min_scene_len = 1</code>ï¼š</strong> åœ¨å¯»æ‰¾æœ€ä½³æ£€æµ‹å‚æ•°çš„é˜¶æ®µï¼Œå§‹ç»ˆè¿™æ ·åšã€‚</p></li><li><p><strong>é€‰æ‹©ä¸€ä¸ªï¼ˆæˆ–å‡ ä¸ªï¼‰ä»£è¡¨æ€§çš„æŠ½æ ·è§†é¢‘ï¼š</strong> è¿™äº›è§†é¢‘åº”è¯¥åŒ…å«ä½ æœŸæœ›æ£€æµ‹åˆ°çš„å„ç§åœºæ™¯åˆ‡æ¢æ•ˆæœã€‚</p></li><li><p><strong>å¯¹äºé€‰å®šçš„æ£€æµ‹å™¨ï¼Œç³»ç»Ÿåœ°æ‰«æå…¶ä¸»è¦é˜ˆå€¼å‚æ•°ï¼š</strong></p><ul><li><strong><code>ThresholdDetector</code></strong>: æ‰«æ <code>threshold</code> å’Œ <code>fade_bias</code>ã€‚</li><li><strong><code>ContentDetector</code></strong>: ä¸»è¦æ‰«æ <code>threshold</code>ã€‚å¯ä»¥åç»­å†è°ƒæ•´ <code>weights</code>ã€‚</li><li><strong><code>AdaptiveDetector</code></strong>: ä¸»è¦æ‰«æ <code>adaptive_threshold</code>ã€‚å¯ä»¥åç»­å†è°ƒæ•´ <code>window_width</code>ã€‚</li><li><strong>ä½¿ç”¨ä½ çš„ <code>threshold_explorer.py</code> å·¥å…·</strong> (å¦‚æœå®ƒæ˜¯é’ˆå¯¹ <code>ContentDetector</code> çš„ï¼Œä½ éœ€è¦ä¸ºå…¶ä»–æ£€æµ‹å™¨åšç±»ä¼¼çš„å‚æ•°æ‰«æé€»è¾‘ï¼Œæˆ–è€…ä¿®æ”¹å®ƒä½¿å…¶æ›´é€šç”¨)ã€‚</li></ul></li><li><p><strong>å¯è§†åŒ–å’Œäººå·¥æ£€æŸ¥ï¼š</strong></p><ul><li>æŸ¥çœ‹åœºæ™¯æ•°é‡éšé˜ˆå€¼å˜åŒ–çš„å›¾è¡¨ã€‚</li><li>å¯¹äºå‡ ä¸ªæœ‰å¸Œæœ›çš„é˜ˆå€¼è®¾ç½®ï¼Œä½¿ç”¨ <code>save-images</code> ç”Ÿæˆçš„å›¾ç‰‡è¿›è¡Œäººå·¥æ£€æŸ¥ï¼Œçœ‹åˆ‡ç‚¹æ˜¯å¦å‡†ç¡®ã€æ˜¯å¦æœ‰æ¼æ£€æˆ–è¯¯æŠ¥ã€‚</li></ul></li><li><p><strong>è¿­ä»£å’Œå¾®è°ƒï¼š</strong> æ ¹æ®å¯è§†åŒ–å’Œäººå·¥æ£€æŸ¥çš„ç»“æœï¼Œè°ƒæ•´å‚æ•°èŒƒå›´ï¼Œè¿›è¡Œæ›´ç»†è‡´çš„æ‰«æï¼Œæˆ–è€…å°è¯•è°ƒæ•´æ¬¡è¦å‚æ•°ï¼ˆå¦‚æƒé‡ã€çª—å£å®½åº¦ç­‰ï¼‰ã€‚</p></li><li><p><strong>é€‰æ‹©â€œæœ€ä½³â€å‚æ•°ï¼š</strong> â€œæœ€ä½³â€é€šå¸¸æ˜¯åœ¨â€œå¬å›ç‡â€ï¼ˆæ‰¾åˆ°æ‰€æœ‰æƒ³æ‰¾çš„åˆ‡æ¢ï¼‰å’Œâ€œç²¾ç¡®ç‡â€ï¼ˆæ‰¾åˆ°çš„åˆ‡æ¢éƒ½æ˜¯æ­£ç¡®çš„ï¼‰ä¹‹é—´çš„ä¸€ä¸ªå¹³è¡¡ã€‚è¿™å–å†³äºä½ çš„å…·ä½“éœ€æ±‚ã€‚å¯èƒ½æ²¡æœ‰ä¸€ç»„å‚æ•°å¯¹æ‰€æœ‰è§†é¢‘éƒ½å®Œç¾ï¼Œä½ å¯èƒ½éœ€è¦æ ¹æ®è§†é¢‘ç±»å‹é€‰æ‹©ä¸åŒçš„å‚æ•°é›†ï¼Œæˆ–è€…æ¥å—ä¸€å®šçš„æŠ˜è¡·ã€‚</p></li></ol><h2 id="å¯è§†åŒ–ç¡®å®šå†…å®¹æ£€æµ‹é˜ˆå€¼æ–¹æ³•">å¯è§†åŒ–ç¡®å®šå†…å®¹æ£€æµ‹é˜ˆå€¼æ–¹æ³•</h2><h3 id="å†…å®¹æ£€æµ‹å™¨é˜ˆå€¼å‚è€ƒä»£ç ">å†…å®¹æ£€æµ‹å™¨é˜ˆå€¼å‚è€ƒä»£ç </h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Tuple</span>, <span class="type">Dict</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> scenedetect <span class="keyword">import</span> open_video, SceneManager, ContentDetector, FrameTimecode, VideoStreamCv2</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">    <span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">    MATPLOTLIB_AVAILABLE = <span class="literal">True</span></span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    MATPLOTLIB_AVAILABLE = <span class="literal">False</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;è­¦å‘Š: Matplotlib æˆ– Pandas æœªå®‰è£…ï¼Œå°†æ— æ³•ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨ã€‚&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;è¯·è¿è¡Œ: pip install matplotlib pandas&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- æ—¥å¿—è®¾ç½® ---</span></span><br><span class="line">logger = logging.getLogger(<span class="string">&quot;ThresholdExplorer&quot;</span>)</span><br><span class="line">logging.basicConfig(level=logging.INFO, <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_video_files</span>(<span class="params">input_path: Path, extensions: <span class="type">List</span>[<span class="built_in">str</span>], recursive: <span class="built_in">bool</span></span>) -&gt; <span class="type">List</span>[Path]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä»æŒ‡å®šè·¯å¾„æ”¶é›†è§†é¢‘æ–‡ä»¶åˆ—è¡¨ã€‚&quot;&quot;&quot;</span></span><br><span class="line">    video_files = []</span><br><span class="line">    logger.info(<span class="string">f&quot;æ­£åœ¨æ‰«æç›®å½•: <span class="subst">&#123;input_path&#125;</span> (é€’å½’: <span class="subst">&#123;recursive&#125;</span>)ï¼Œå¯»æ‰¾æ‰©å±•å: <span class="subst">&#123;extensions&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> ext <span class="keyword">in</span> extensions:</span><br><span class="line">        pattern = <span class="string">f&quot;**/*<span class="subst">&#123;ext&#125;</span>&quot;</span> <span class="keyword">if</span> recursive <span class="keyword">else</span> <span class="string">f&quot;*<span class="subst">&#123;ext&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">for</span> file_path <span class="keyword">in</span> input_path.glob(pattern):</span><br><span class="line">            <span class="keyword">if</span> file_path.is_file() <span class="keyword">and</span> <span class="keyword">not</span> file_path.name.startswith(<span class="string">&#x27;._&#x27;</span>):</span><br><span class="line">                video_files.append(file_path)</span><br><span class="line">    logger.info(<span class="string">f&quot;åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æ‰¾åˆ° <span class="subst">&#123;<span class="built_in">len</span>(video_files)&#125;</span> ä¸ªè§†é¢‘æ–‡ä»¶ã€‚&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> video_files</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_sampled_videos</span>(<span class="params">video_list: <span class="type">List</span>[Path], sample_ratio: <span class="built_in">float</span> = -<span class="number">1.0</span>, num_samples: <span class="built_in">int</span> = -<span class="number">1</span></span>) -&gt; <span class="type">List</span>[Path]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æ ¹æ®æ¯”ä¾‹æˆ–æ•°é‡å¯¹è§†é¢‘åˆ—è¡¨è¿›è¡ŒæŠ½æ ·ã€‚&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> video_list:</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> num_samples &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> num_samples &gt;= <span class="built_in">len</span>(video_list):</span><br><span class="line">            <span class="keyword">return</span> video_list</span><br><span class="line">        <span class="keyword">return</span> random.sample(video_list, num_samples)</span><br><span class="line">    <span class="keyword">elif</span> <span class="number">0.0</span> &lt; sample_ratio &lt;= <span class="number">1.0</span>:</span><br><span class="line">        k = <span class="built_in">int</span>(<span class="built_in">len</span>(video_list) * sample_ratio)</span><br><span class="line">        <span class="keyword">if</span> k == <span class="number">0</span> <span class="keyword">and</span> <span class="built_in">len</span>(video_list) &gt; <span class="number">0</span>: k = <span class="number">1</span>  <span class="comment"># è‡³å°‘æŠ½ä¸€ä¸ªæ ·æœ¬</span></span><br><span class="line">        <span class="keyword">return</span> random.sample(video_list, k)</span><br><span class="line">    <span class="keyword">else</span>:  <span class="comment"># é»˜è®¤ä¸æŠ½æ ·ï¼Œå¤„ç†æ‰€æœ‰</span></span><br><span class="line">        <span class="keyword">return</span> video_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_detection_for_threshold</span>(<span class="params"></span></span><br><span class="line"><span class="params">        video_path: Path,</span></span><br><span class="line"><span class="params">        threshold_value: <span class="built_in">float</span>,</span></span><br><span class="line"><span class="params">        min_len: <span class="built_in">int</span> = <span class="number">1</span>,  <span class="comment"># ä¿æŒä¸º1ä»¥è·å¾—åŸå§‹åˆ‡ç‚¹</span></span></span><br><span class="line"><span class="params">        save_images_output_dir: Path = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        save_images_for_this_run: <span class="built_in">bool</span> = <span class="literal">False</span>  <span class="comment"># æ˜¯å¦ä¸ºæœ¬æ¬¡ç‰¹å®šçš„é˜ˆå€¼è¿è¡Œä¿å­˜å›¾åƒ</span></span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¯¹å•ä¸ªè§†é¢‘å’Œå•ä¸ªé˜ˆå€¼è¿è¡Œ ContentDetectorã€‚&quot;&quot;&quot;</span></span><br><span class="line">    scene_manager = SceneManager()</span><br><span class="line">    <span class="comment"># æ³¨æ„ï¼šContentDetector çš„å…¶ä»–å‚æ•°ï¼ˆå¦‚ weights, luma_onlyï¼‰è¿™é‡Œä½¿ç”¨é»˜è®¤å€¼ã€‚</span></span><br><span class="line">    <span class="comment"># å¦‚æœéœ€è¦ï¼Œä¹Ÿå¯ä»¥å°†å®ƒä»¬ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚</span></span><br><span class="line">    detector = ContentDetector(threshold=threshold_value, min_scene_len=min_len)</span><br><span class="line">    scene_manager.add_detector(detector)</span><br><span class="line"></span><br><span class="line">    video = <span class="literal">None</span></span><br><span class="line">    num_scenes = <span class="number">0</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        video = open_video(<span class="built_in">str</span>(video_path))</span><br><span class="line">        <span class="comment"># video.set_downscale_factor(1) # å¯ä»¥è€ƒè™‘é™é‡‡æ ·ä»¥åŠ é€Ÿï¼Œä½†å¯èƒ½å½±å“æ£€æµ‹ç²¾åº¦</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># è·å–æœ‰é™çš„å¸§æ•°è¿›è¡Œåˆ†æï¼Œè€Œä¸æ˜¯æ•´ä¸ªè§†é¢‘ï¼Œä»¥åŠ å¿«é€Ÿåº¦</span></span><br><span class="line">        <span class="comment"># è¿™é‡Œæˆ‘ä»¬ä»ç„¶å¤„ç†æ•´ä¸ªï¼ˆæŠ½æ ·çš„ï¼‰è§†é¢‘ï¼Œå› ä¸ºäº¤å‰æ·¡åŒ–å¯èƒ½åœ¨ä»»ä½•åœ°æ–¹</span></span><br><span class="line">        <span class="comment"># å¦‚æœè§†é¢‘éå¸¸é•¿ï¼Œå¯ä»¥è€ƒè™‘åªåˆ†æè§†é¢‘çš„ä¸€éƒ¨åˆ†ï¼Œä½†è¿™ä¼šä½¿æŠ½æ ·æ›´å¤æ‚</span></span><br><span class="line">        scene_manager.detect_scenes(video=video, show_progress=<span class="literal">False</span>)</span><br><span class="line">        scene_list = scene_manager.get_scene_list()</span><br><span class="line">        num_scenes = <span class="built_in">len</span>(scene_list)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> save_images_for_this_run <span class="keyword">and</span> save_images_output_dir <span class="keyword">and</span> scene_list:</span><br><span class="line">            <span class="keyword">from</span> scenedetect.video_splitter <span class="keyword">import</span> save_images <span class="keyword">as</span> save_images_func</span><br><span class="line">            video_images_dir = save_images_output_dir / <span class="string">f&quot;<span class="subst">&#123;video_path.stem&#125;</span>_thresh_<span class="subst">&#123;threshold_value:<span class="number">.1</span>f&#125;</span>&quot;</span></span><br><span class="line">            video_images_dir.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">            logger.info(<span class="string">f&quot;ä¸ºè§†é¢‘ <span class="subst">&#123;video_path.name&#125;</span> (é˜ˆå€¼ <span class="subst">&#123;threshold_value:<span class="number">.1</span>f&#125;</span>) ä¿å­˜åœºæ™¯å›¾ç‰‡åˆ° <span class="subst">&#123;video_images_dir&#125;</span>&quot;</span>)</span><br><span class="line">            save_images_func(</span><br><span class="line">                scene_list=scene_list,</span><br><span class="line">                video_manager=video,  <span class="comment"># open_video è¿”å›çš„æ˜¯ VideoManager æˆ–å…¶åç«¯å®ä¾‹</span></span><br><span class="line">                num_images=<span class="number">2</span>,  <span class="comment"># æ¯ä¸ªåˆ‡ç‚¹å‰åå„ä¸€å¼ </span></span><br><span class="line">                output_dir=<span class="built_in">str</span>(video_images_dir),</span><br><span class="line">                image_name_template=<span class="string">&#x27;$VIDEO_NAME-Scene-$SCENE_NUMBER-$IMAGE_NUMBER&#x27;</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;å¤„ç†è§†é¢‘ <span class="subst">&#123;video_path.name&#125;</span> (é˜ˆå€¼ <span class="subst">&#123;threshold_value&#125;</span>) æ—¶å‡ºé”™: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        num_scenes = -<span class="number">1</span>  <span class="comment"># è¡¨ç¤ºé”™è¯¯</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">if</span> video:</span><br><span class="line">            <span class="comment"># å°è¯•é€šç”¨çš„ release æ–¹æ³• (é€‚ç”¨äº VideoManager)</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">hasattr</span>(video, <span class="string">&#x27;release&#x27;</span>) <span class="keyword">and</span> <span class="built_in">callable</span>(<span class="built_in">getattr</span>(video, <span class="string">&#x27;release&#x27;</span>)):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    video.release()</span><br><span class="line">                    logger.debug(<span class="string">f&quot;Released video object for <span class="subst">&#123;video_path.name&#125;</span> via .release()&quot;</span>)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e_rel:</span><br><span class="line">                    logger.warning(<span class="string">f&quot;Error calling .release() on video object for <span class="subst">&#123;video_path.name&#125;</span>: <span class="subst">&#123;e_rel&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment"># é’ˆå¯¹ VideoStreamCv2 (ä»¥åŠç»§æ‰¿å®ƒçš„ VideoStreamCv2Cuda) çš„ç‰¹æ®Šå¤„ç†</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(video, VideoStreamCv2):  <span class="comment"># VideoStreamCv2 æ˜¯ä» scenedetect.backends.opencv å¯¼å…¥çš„</span></span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">hasattr</span>(video, <span class="string">&#x27;_cap&#x27;</span>) <span class="keyword">and</span> video._cap <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        <span class="keyword">if</span> video._cap.isOpened():</span><br><span class="line">                            video._cap.release()</span><br><span class="line">                            logger.debug(<span class="string">f&quot;Released VideoStreamCv2._cap for <span class="subst">&#123;video_path.name&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="keyword">except</span> Exception <span class="keyword">as</span> e_cap_rel:</span><br><span class="line">                        logger.warning(<span class="string">f&quot;Error releasing VideoStreamCv2._cap for <span class="subst">&#123;video_path.name&#125;</span>: <span class="subst">&#123;e_cap_rel&#125;</span>&quot;</span>)</span><br><span class="line">         <span class="keyword">else</span>:</span><br><span class="line">                logger.warning(</span><br><span class="line">                    <span class="string">f&quot;Video object for <span class="subst">&#123;video_path.name&#125;</span> (type: <span class="subst">&#123;<span class="built_in">type</span>(video).__name__&#125;</span>) &quot;</span></span><br><span class="line">                    <span class="string">&quot;does not have a public .release() method and is not a known direct backend &quot;</span></span><br><span class="line">                    <span class="string">&quot;with a specific release pattern. Relying on __del__ for cleanup.&quot;</span></span><br><span class="line">                )</span><br><span class="line">    <span class="keyword">return</span> num_scenes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">explore_thresholds</span>(<span class="params"></span></span><br><span class="line"><span class="params">        video_paths: <span class="type">List</span>[Path],</span></span><br><span class="line"><span class="params">        threshold_range: <span class="type">Tuple</span>[<span class="built_in">float</span>, <span class="built_in">float</span>, <span class="built_in">float</span>],  <span class="comment"># (start, end, step)</span></span></span><br><span class="line"><span class="params">        sample_ratio: <span class="built_in">float</span> = -<span class="number">1.0</span>,</span></span><br><span class="line"><span class="params">        num_sample_videos: <span class="built_in">int</span> = -<span class="number">1</span>,</span></span><br><span class="line"><span class="params">        min_scene_len: <span class="built_in">int</span> = <span class="number">1</span>,</span></span><br><span class="line"><span class="params">        output_dir_base: Path = Path(<span class="params"><span class="string">&quot;threshold_exploration_output&quot;</span></span>),</span></span><br><span class="line"><span class="params">        save_images_for_thresholds: <span class="type">List</span>[<span class="built_in">float</span>] = <span class="literal">None</span>  <span class="comment"># æŒ‡å®šå“ªäº›é˜ˆå€¼éœ€è¦ä¿å­˜å›¾åƒ</span></span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    å¯¹ä¸€æ‰¹è§†é¢‘ï¼Œåœ¨ä¸€ç³»åˆ—é˜ˆå€¼ä¸‹è¿è¡Œ ContentDetectorï¼Œå¹¶è®°å½•ç»“æœã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> video_paths:</span><br><span class="line">        logger.warning(<span class="string">&quot;æ²¡æœ‰æä¾›è§†é¢‘æ–‡ä»¶è¿›è¡Œåˆ†æã€‚&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    sampled_videos = get_sampled_videos(video_paths, sample_ratio, num_sample_videos)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> sampled_videos:</span><br><span class="line">        logger.warning(<span class="string">&quot;æŠ½æ ·åæ²¡æœ‰è§†é¢‘å¯ä¾›åˆ†æã€‚&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">f&quot;å°†å¯¹ä»¥ä¸‹ <span class="subst">&#123;<span class="built_in">len</span>(sampled_videos)&#125;</span> ä¸ªæŠ½æ ·è§†é¢‘è¿›è¡Œåˆ†æ:&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> vid_path <span class="keyword">in</span> sampled_videos:</span><br><span class="line">        logger.info(<span class="string">f&quot;  - <span class="subst">&#123;vid_path.name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    start_thresh, end_thresh, step_thresh = threshold_range</span><br><span class="line">    thresholds_to_test = np.arange(start_thresh, end_thresh + step_thresh / <span class="number">2</span>, step_thresh)  <span class="comment"># +step/2 ç¡®ä¿åŒ…å« end_thresh</span></span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">f&quot;å°†æµ‹è¯•ä»¥ä¸‹é˜ˆå€¼: <span class="subst">&#123;thresholds_to_test&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åˆ›å»ºä¸»è¾“å‡ºç›®å½•</span></span><br><span class="line">    output_dir_base.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    images_base_dir = output_dir_base / <span class="string">&quot;saved_scene_images&quot;</span></span><br><span class="line">    <span class="keyword">if</span> save_images_for_thresholds:</span><br><span class="line">        images_base_dir.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    results = []  <span class="comment"># å­˜å‚¨ (video_name, threshold, num_scenes)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> video_path <span class="keyword">in</span> sampled_videos:</span><br><span class="line">        logger.info(<span class="string">f&quot;--- å¼€å§‹å¤„ç†è§†é¢‘: <span class="subst">&#123;video_path.name&#125;</span> ---&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> threshold <span class="keyword">in</span> thresholds_to_test:</span><br><span class="line">            logger.info(<span class="string">f&quot;  æµ‹è¯•é˜ˆå€¼: <span class="subst">&#123;threshold:<span class="number">.2</span>f&#125;</span> for <span class="subst">&#123;video_path.name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            save_images_this_run = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">if</span> save_images_for_thresholds <span class="keyword">and</span> <span class="built_in">any</span>(</span><br><span class="line">                    <span class="built_in">abs</span>(threshold - t_save) &lt; <span class="number">1e-5</span> <span class="keyword">for</span> t_save <span class="keyword">in</span> save_images_for_thresholds):</span><br><span class="line">                save_images_this_run = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">            num_scenes = run_detection_for_threshold(</span><br><span class="line">                video_path,</span><br><span class="line">                threshold,</span><br><span class="line">                min_len=min_scene_len,</span><br><span class="line">                save_images_output_dir=images_base_dir <span class="keyword">if</span> save_images_this_run <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">                save_images_for_this_run=save_images_this_run</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">if</span> num_scenes != -<span class="number">1</span>:  <span class="comment"># å¦‚æœæ²¡æœ‰å‘ç”Ÿé”™è¯¯</span></span><br><span class="line">                results.append(&#123;</span><br><span class="line">                    <span class="string">&quot;video_name&quot;</span>: video_path.name,</span><br><span class="line">                    <span class="string">&quot;threshold&quot;</span>: threshold,</span><br><span class="line">                    <span class="string">&quot;num_scenes&quot;</span>: num_scenes</span><br><span class="line">                &#125;)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                logger.warning(<span class="string">f&quot;è·³è¿‡è®°å½•è§†é¢‘ <span class="subst">&#123;video_path.name&#125;</span> åœ¨é˜ˆå€¼ <span class="subst">&#123;threshold:<span class="number">.2</span>f&#125;</span> çš„ç»“æœï¼Œå› ä¸ºæ£€æµ‹å‡ºé”™ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> results:</span><br><span class="line">        logger.warning(<span class="string">&quot;æ²¡æœ‰æ”¶é›†åˆ°ä»»ä½•æœ‰æ•ˆçš„æ£€æµ‹ç»“æœã€‚&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    results_df = pd.DataFrame(results) <span class="keyword">if</span> MATPLOTLIB_AVAILABLE <span class="keyword">and</span> pd <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¿å­˜åŸå§‹æ•°æ®åˆ° CSV</span></span><br><span class="line">    csv_output_path = output_dir_base / <span class="string">&quot;threshold_scan_results.csv&quot;</span></span><br><span class="line">    <span class="keyword">if</span> results_df <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            results_df.to_csv(csv_output_path, index=<span class="literal">False</span>)</span><br><span class="line">            logger.info(<span class="string">f&quot;è¯¦ç»†æ‰«æç»“æœå·²ä¿å­˜åˆ°: <span class="subst">&#123;csv_output_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;æ— æ³•ä¿å­˜æ‰«æç»“æœåˆ° CSV: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:  <span class="comment"># å¦‚æœ pandas ä¸å¯ç”¨ï¼Œå°è¯•æ‰‹åŠ¨ä¿å­˜</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(csv_output_path, <span class="string">&#x27;w&#x27;</span>, newline=<span class="string">&#x27;&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                writer = csv.writer(f)</span><br><span class="line">                writer.writerow([<span class="string">&#x27;video_name&#x27;</span>, <span class="string">&#x27;threshold&#x27;</span>, <span class="string">&#x27;num_scenes&#x27;</span>])</span><br><span class="line">                <span class="keyword">for</span> res_dict <span class="keyword">in</span> results:</span><br><span class="line">                    writer.writerow([res_dict[<span class="string">&#x27;video_name&#x27;</span>], res_dict[<span class="string">&#x27;threshold&#x27;</span>], res_dict[<span class="string">&#x27;num_scenes&#x27;</span>]])</span><br><span class="line">            logger.info(<span class="string">f&quot;è¯¦ç»†æ‰«æç»“æœå·²ä¿å­˜åˆ°: <span class="subst">&#123;csv_output_path&#125;</span> (æ‰‹åŠ¨ä¿å­˜)&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;æ— æ³•æ‰‹åŠ¨ä¿å­˜æ‰«æç»“æœåˆ° CSV: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¯è§†åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> MATPLOTLIB_AVAILABLE <span class="keyword">and</span> results_df <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># å›¾1: æ¯ä¸ªè§†é¢‘çš„åœºæ™¯æ•° vs é˜ˆå€¼</span></span><br><span class="line">            plt.figure(figsize=(<span class="number">12</span>, <span class="number">7</span>))</span><br><span class="line">            <span class="keyword">for</span> video_name, group <span class="keyword">in</span> results_df.groupby(<span class="string">&quot;video_name&quot;</span>):</span><br><span class="line">                plt.plot(group[<span class="string">&quot;threshold&quot;</span>], group[<span class="string">&quot;num_scenes&quot;</span>], marker=<span class="string">&#x27;o&#x27;</span>, linestyle=<span class="string">&#x27;-&#x27;</span>, label=video_name)</span><br><span class="line">            plt.xlabel(<span class="string">&quot;ContentDetector Threshold&quot;</span>)</span><br><span class="line">            plt.ylabel(<span class="string">&quot;Number of Detected Scenes&quot;</span>)</span><br><span class="line">            plt.title(<span class="string">&quot;Number of Scenes vs. Threshold (Per Video)&quot;</span>)</span><br><span class="line">            plt.legend(bbox_to_anchor=(<span class="number">1.05</span>, <span class="number">1</span>), loc=<span class="string">&#x27;upper left&#x27;</span>, borderaxespad=<span class="number">0.</span>)</span><br><span class="line">            plt.grid(<span class="literal">True</span>)</span><br><span class="line">            plt.tight_layout(rect=[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0.85</span>, <span class="number">1</span>])  <span class="comment"># ç»™ legend ç•™ç©ºé—´</span></span><br><span class="line">            plot_path1 = output_dir_base / <span class="string">&quot;scenes_vs_threshold_per_video.png&quot;</span></span><br><span class="line">            plt.savefig(plot_path1)</span><br><span class="line">            logger.info(<span class="string">f&quot;æ¯ä¸ªè§†é¢‘çš„åœºæ™¯æ•°-é˜ˆå€¼å›¾å·²ä¿å­˜åˆ°: <span class="subst">&#123;plot_path1&#125;</span>&quot;</span>)</span><br><span class="line">            plt.close()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># å›¾2: å¹³å‡åœºæ™¯æ•° vs é˜ˆå€¼</span></span><br><span class="line">            avg_scenes_df = results_df.groupby(<span class="string">&quot;threshold&quot;</span>)[<span class="string">&quot;num_scenes&quot;</span>].mean().reset_index()</span><br><span class="line">            plt.figure(figsize=(<span class="number">10</span>, <span class="number">6</span>))</span><br><span class="line">            plt.plot(avg_scenes_df[<span class="string">&quot;threshold&quot;</span>], avg_scenes_df[<span class="string">&quot;num_scenes&quot;</span>], marker=<span class="string">&#x27;o&#x27;</span>, linestyle=<span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">            plt.xlabel(<span class="string">&quot;ContentDetector Threshold&quot;</span>)</span><br><span class="line">            plt.ylabel(<span class="string">&quot;Average Number of Detected Scenes&quot;</span>)</span><br><span class="line">            plt.title(<span class="string">&quot;Average Number of Scenes vs. Threshold (Across Sampled Videos)&quot;</span>)</span><br><span class="line">            plt.grid(<span class="literal">True</span>)</span><br><span class="line">            plot_path2 = output_dir_base / <span class="string">&quot;avg_scenes_vs_threshold.png&quot;</span></span><br><span class="line">            plt.savefig(plot_path2)</span><br><span class="line">            logger.info(<span class="string">f&quot;å¹³å‡åœºæ™¯æ•°-é˜ˆå€¼å›¾å·²ä¿å­˜åˆ°: <span class="subst">&#123;plot_path2&#125;</span>&quot;</span>)</span><br><span class="line">            plt.close()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;ç”Ÿæˆå›¾è¡¨æ—¶å‡ºé”™: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æå‡ºå»ºè®®ï¼ˆåŸºäºå¯å‘å¼ï¼Œç”¨æˆ·ä»éœ€åˆ¤æ–­ï¼‰</span></span><br><span class="line">    logger.info(<span class="string">&quot;--- é˜ˆå€¼é€‰æ‹©å»ºè®® ---&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> results_df <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># å¯å‘å¼ï¼šå¯»æ‰¾åœºæ™¯æ•°å¼€å§‹æ€¥å‰§ä¸‹é™ç„¶åè¶‹äºå¹³ç¼“çš„â€œæ‹ç‚¹â€</span></span><br><span class="line">        <span class="comment"># æˆ–è€…åœºæ™¯æ•°åœ¨ä¸€ä¸ªå°èŒƒå›´å†…æ³¢åŠ¨ä½†ç›¸å¯¹ç¨³å®šçš„åŒºåŸŸ</span></span><br><span class="line">        avg_scenes_series = results_df.groupby(<span class="string">&quot;threshold&quot;</span>)[<span class="string">&quot;num_scenes&quot;</span>].mean()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> avg_scenes_series.empty:</span><br><span class="line">            logger.info(<span class="string">&quot;è¯·æŸ¥çœ‹ &#x27;avg_scenes_vs_threshold.png&#x27; å›¾è¡¨ã€‚&quot;</span>)</span><br><span class="line">            logger.info(<span class="string">&quot;ç†æƒ³çš„é˜ˆå€¼é€šå¸¸ä½äºä»¥ä¸‹åŒºåŸŸï¼š&quot;</span>)</span><br><span class="line">            logger.info(<span class="string">&quot;  - åœºæ™¯æ•°é‡å¼€å§‹æ˜¾è‘—å‡å°‘ä¹‹å‰çš„ç‚¹ï¼ˆå¦‚æœä½ æƒ³æ•æ‰æ›´å¤šç»†èŠ‚ï¼‰ã€‚&quot;</span>)</span><br><span class="line">            logger.info(<span class="string">&quot;  - åœºæ™¯æ•°é‡è¶‹äºç¨³å®šï¼Œä¸å†éšé˜ˆå€¼å¢åŠ è€Œå¤§å¹…å‡å°‘çš„ç‚¹ï¼ˆå¦‚æœä½ æƒ³æ›´é²æ£’ï¼Œå‡å°‘è¯¯æŠ¥ï¼‰ã€‚&quot;</span>)</span><br><span class="line">            logger.info(<span class="string">&quot;  - é¿å…é˜ˆå€¼è¿‡ä½å¯¼è‡´åœºæ™¯æ•°è¿‡å¤šï¼ˆå¯èƒ½æ˜¯å™ªå£°æˆ–å¾®å°å˜åŒ–ï¼‰ã€‚&quot;</span>)</span><br><span class="line">            logger.info(<span class="string">&quot;  - é¿å…é˜ˆå€¼è¿‡é«˜å¯¼è‡´åœºæ™¯æ•°è¿‡å°‘ï¼ˆå¯èƒ½é—æ¼çœŸå®åˆ‡æ¢ï¼‰ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># å°è¯•æ‰¾åˆ°ä¸€ä¸ªâ€œæ‹ç‚¹â€çš„ç®€å•å¯å‘å¼</span></span><br><span class="line">            <span class="comment"># è®¡ç®—äºŒé˜¶å·®åˆ†ï¼Œå¯»æ‰¾å˜åŒ–æœ€å¤§çš„åœ°æ–¹ï¼Œä½†è¿™å¯èƒ½ä¸ç¨³å®š</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                diff1 = avg_scenes_series.diff().fillna(<span class="number">0</span>)</span><br><span class="line">                diff2 = diff1.diff().fillna(<span class="number">0</span>)</span><br><span class="line">                <span class="comment"># å¯»æ‰¾ diff2 ç»å¯¹å€¼æœ€å¤§çš„å‡ ä¸ªç‚¹ï¼Œæˆ–è€…ç¬¬ä¸€ä¸ªæ˜¾è‘—çš„æ­£å€¼ï¼ˆè¡¨ç¤ºä¸‹é™è¶‹åŠ¿å‡ç¼“ï¼‰</span></span><br><span class="line">                <span class="comment"># è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€åŒ–çš„æ–¹æ³•ï¼Œå®é™…æ•ˆæœå¯èƒ½æœ‰é™</span></span><br><span class="line">                potential_elbow_threshold = diff2.<span class="built_in">abs</span>().nlargest(<span class="number">3</span>).index.tolist()</span><br><span class="line">                <span class="keyword">if</span> potential_elbow_threshold:</span><br><span class="line">                    logger.info(</span><br><span class="line">                        <span class="string">f&quot;  æ ¹æ®ç®€å•çš„å˜åŒ–ç‡åˆ†æï¼Œå¯ä»¥å…³æ³¨ä»¥ä¸‹é˜ˆå€¼é™„è¿‘çš„è¡¨ç°ï¼š<span class="subst">&#123;<span class="built_in">sorted</span>(potential_elbow_threshold)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception:</span><br><span class="line">                <span class="keyword">pass</span>  <span class="comment"># å¯å‘å¼å¤±è´¥ï¼Œä¸å½±å“ä¸»è¦åŠŸèƒ½</span></span><br><span class="line"></span><br><span class="line">            logger.info(<span class="string">&quot;ç»“åˆ &#x27;saved_scene_images&#x27; (å¦‚æœç”Ÿæˆäº†) ä¸­çš„å®é™…åœºæ™¯å›¾ç‰‡è¿›è¡Œäººå·¥åˆ¤æ–­ã€‚&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logger.warning(<span class="string">&quot;æœªèƒ½è®¡ç®—å¹³å‡åœºæ™¯æ•°ï¼Œæ— æ³•æä¾›åŸºäºå›¾è¡¨çš„å»ºè®®ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">f&quot;è¯·æ£€æŸ¥è¾“å‡ºç›®å½• &#x27;<span class="subst">&#123;output_dir_base&#125;</span>&#x27; ä¸­çš„ç»“æœã€‚&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> results_df</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(</span><br><span class="line">        description=<span class="string">&quot;ä¸ºä¸€æ‰¹è§†é¢‘æ¢ç´¢ ContentDetector çš„æœ€ä½³é˜ˆå€¼ã€‚&quot;</span>,</span><br><span class="line">        formatter_class=argparse.ArgumentDefaultsHelpFormatter</span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(<span class="string">&quot;input_source&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;åŒ…å«è§†é¢‘æ–‡ä»¶çš„ç›®å½•è·¯å¾„ï¼Œæˆ–å•ä¸ªè§†é¢‘æ–‡ä»¶è·¯å¾„ã€‚&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-e&quot;</span>, <span class="string">&quot;--extensions&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&quot;.mp4,.mkv,.mov,.avi&quot;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;é€—å·åˆ†éš”çš„è§†é¢‘æ–‡ä»¶æ‰©å±•å (ä¾‹å¦‚: .mp4,.mov)ã€‚&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-r&quot;</span>, <span class="string">&quot;--recursive&quot;</span>, action=<span class="string">&quot;store_true&quot;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;å¦‚æœ input_source æ˜¯ç›®å½•ï¼Œåˆ™é€’å½’æ‰«æå­ç›®å½•ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æŠ½æ ·å‚æ•°</span></span><br><span class="line">    sample_group = parser.add_mutually_exclusive_group()</span><br><span class="line">    sample_group.add_argument(<span class="string">&quot;--sample_ratio&quot;</span>, <span class="built_in">type</span>=<span class="built_in">float</span>, default=-<span class="number">1.0</span>,</span><br><span class="line">                              <span class="built_in">help</span>=<span class="string">&quot;è¦å¤„ç†çš„è§†é¢‘å æ€»æ•°çš„æ¯”ä¾‹ (0.0 åˆ° 1.0)ã€‚ä¾‹å¦‚ 0.1 è¡¨ç¤º 10%%ã€‚é»˜è®¤ä¸º-1.0 (å¤„ç†æ‰€æœ‰)ã€‚&quot;</span>)</span><br><span class="line">    sample_group.add_argument(<span class="string">&quot;--num_sample_videos&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=-<span class="number">1</span>,</span><br><span class="line">                              <span class="built_in">help</span>=<span class="string">&quot;è¦éšæœºæŠ½å–çš„è§†é¢‘æ•°é‡ã€‚é»˜è®¤ä¸º-1 (å¤„ç†æ‰€æœ‰æˆ–æŒ‰æ¯”ä¾‹)ã€‚å¦‚æœæŒ‡å®šï¼Œåˆ™ä¼˜å…ˆäº sample_ratioã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ContentDetector å‚æ•°</span></span><br><span class="line">    parser.add_argument(<span class="string">&quot;--threshold_start&quot;</span>, <span class="built_in">type</span>=<span class="built_in">float</span>, default=<span class="number">15.0</span>, <span class="built_in">help</span>=<span class="string">&quot;æµ‹è¯•çš„ ContentDetector é˜ˆå€¼èµ·å§‹å€¼ã€‚&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--threshold_end&quot;</span>, <span class="built_in">type</span>=<span class="built_in">float</span>, default=<span class="number">35.0</span>, <span class="built_in">help</span>=<span class="string">&quot;æµ‹è¯•çš„ ContentDetector é˜ˆå€¼ç»“æŸå€¼ã€‚&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--threshold_step&quot;</span>, <span class="built_in">type</span>=<span class="built_in">float</span>, default=<span class="number">1.0</span>, <span class="built_in">help</span>=<span class="string">&quot;æµ‹è¯•çš„ ContentDetector é˜ˆå€¼æ­¥é•¿ã€‚&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--min_len&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">1</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;ä¼ é€’ç»™ ContentDetector çš„ min_scene_len å‚æ•° (å¸§æ•°)ã€‚å»ºè®®ä¿æŒä¸º1ä»¥åˆ†æåŸå§‹åˆ‡ç‚¹ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¾“å‡ºå’Œå¯è§†åŒ–</span></span><br><span class="line">    parser.add_argument(<span class="string">&quot;-o&quot;</span>, <span class="string">&quot;--output_dir&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="string">&quot;threshold_exploration_output&quot;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;ä¿å­˜ç»“æœ (CSV, å›¾è¡¨, å›¾ç‰‡) çš„ä¸»è¾“å‡ºç›®å½•ã€‚&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--save_images_for&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="literal">None</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;é€—å·åˆ†éš”çš„é˜ˆå€¼åˆ—è¡¨ï¼Œå°†ä¸ºè¿™äº›é˜ˆå€¼ä¸‹çš„æ£€æµ‹ç»“æœä¿å­˜åœºæ™¯å›¾ç‰‡ã€‚ä¾‹å¦‚ &#x27;15.0,20.0,25.0&#x27;ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) == <span class="number">1</span>:</span><br><span class="line">        parser.print_help(sys.stderr)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    input_path_obj = Path(args.input_source)</span><br><span class="line">    video_files_to_scan = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> input_path_obj.is_dir():</span><br><span class="line">        ext_list = [e.strip().lower() <span class="keyword">for</span> e <span class="keyword">in</span> args.extensions.split(<span class="string">&#x27;,&#x27;</span>) <span class="keyword">if</span> e.strip()]</span><br><span class="line">        video_files_to_scan = get_video_files(input_path_obj, ext_list, args.recursive)</span><br><span class="line">    <span class="keyword">elif</span> input_path_obj.is_file():</span><br><span class="line">        video_files_to_scan.append(input_path_obj)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.error(<span class="string">f&quot;è¾“å…¥è·¯å¾„ &#x27;<span class="subst">&#123;args.input_source&#125;</span>&#x27; ä¸æ˜¯æœ‰æ•ˆçš„æ–‡ä»¶æˆ–ç›®å½•ã€‚&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> video_files_to_scan:</span><br><span class="line">        logger.info(<span class="string">&quot;åœ¨æŒ‡å®šè·¯å¾„ä¸‹æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è§†é¢‘æ–‡ä»¶ã€‚&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    threshold_r = (args.threshold_start, args.threshold_end, args.threshold_step)</span><br><span class="line">    output_dir_base_path = Path(args.output_dir)</span><br><span class="line"></span><br><span class="line">    save_thresholds_for_images = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> args.save_images_for:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            save_thresholds_for_images = [<span class="built_in">float</span>(t.strip()) <span class="keyword">for</span> t <span class="keyword">in</span> args.save_images_for.split(<span class="string">&#x27;,&#x27;</span>)]</span><br><span class="line">        <span class="keyword">except</span> ValueError:</span><br><span class="line">            logger.error(<span class="string">&quot;`--save_images_for` å‚æ•°ä¸­çš„é˜ˆå€¼åˆ—è¡¨æ ¼å¼é”™è¯¯ã€‚åº”ä¸ºé€—å·åˆ†éš”çš„æ•°å­—ã€‚&quot;</span>)</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    explore_thresholds(</span><br><span class="line">        video_files_to_scan,</span><br><span class="line">        threshold_r,</span><br><span class="line">        sample_ratio=args.sample_ratio,</span><br><span class="line">        num_sample_videos=args.num_sample_videos,</span><br><span class="line">        min_scene_len=args.min_len,</span><br><span class="line">        output_dir_base=output_dir_base_path,</span><br><span class="line">        save_images_for_thresholds=save_thresholds_for_images</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">&quot;é˜ˆå€¼æ¢ç´¢å®Œæˆã€‚&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="äº®åº¦å‚æ•°é€‰å®šæ–¹æ³•å‚è€ƒä»£ç ">äº®åº¦å‚æ•°é€‰å®šæ–¹æ³•å‚è€ƒä»£ç </h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_average_brightness</span>(<span class="params">frame_bgr</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è®¡ç®— BGR å¸§çš„å¹³å‡äº®åº¦ã€‚</span></span><br><span class="line"><span class="string">    ä¸€ç§å¸¸è§çš„æ–¹æ³•æ˜¯å…ˆè½¬æ¢ä¸ºç°åº¦å›¾ï¼Œç„¶åè®¡ç®—å¹³å‡åƒç´ å€¼ã€‚</span></span><br><span class="line"><span class="string">    å¦ä¸€ç§æ˜¯ç›´æ¥è®¡ç®— BGR å„é€šé“çš„å¹³å‡å€¼ï¼Œç„¶åå†å–å¹³å‡ï¼Œæˆ–è€…ä½¿ç”¨åŠ æƒå¹³å‡ï¼ˆå¦‚äº®åº¦å…¬å¼ Y = 0.299R + 0.587G + 0.114Bï¼‰ã€‚</span></span><br><span class="line"><span class="string">    è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨è½¬æ¢ä¸ºç°åº¦å›¾çš„æ–¹æ³•ï¼Œå› ä¸ºå®ƒç›´æ¥åæ˜ äº†äººçœ¼æ„ŸçŸ¥çš„äº®åº¦ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    gray_frame = cv2.cvtColor(frame_bgr, cv2.COLOR_BGR2GRAY)</span><br><span class="line">    average_brightness = np.mean(gray_frame)</span><br><span class="line">    <span class="keyword">return</span> average_brightness</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">analyze_video_brightness</span>(<span class="params">video_path: <span class="built_in">str</span>, output_csv_path: <span class="built_in">str</span> = <span class="literal">None</span>, frame_skip: <span class="built_in">int</span> = <span class="number">0</span>, max_frames: <span class="built_in">int</span> = <span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    é€å¸§åˆ†æè§†é¢‘çš„å¹³å‡äº®åº¦ã€‚</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    å‚æ•°:</span></span><br><span class="line"><span class="string">        video_path (str): è§†é¢‘æ–‡ä»¶è·¯å¾„ã€‚</span></span><br><span class="line"><span class="string">        output_csv_path (str, optional): CSVæ–‡ä»¶è¾“å‡ºè·¯å¾„ã€‚å¦‚æœæä¾›ï¼Œåˆ™å°†ç»“æœä¿å­˜åˆ°æ­¤æ–‡ä»¶ã€‚</span></span><br><span class="line"><span class="string">        frame_skip (int, optional): æ¯éš”å¤šå°‘å¸§åˆ†æä¸€æ¬¡ï¼ˆ0 è¡¨ç¤ºé€å¸§åˆ†æï¼‰ã€‚</span></span><br><span class="line"><span class="string">        max_frames (int, optional): æœ€å¤šåˆ†æå¤šå°‘å¸§ã€‚å¦‚æœä¸º Noneï¼Œåˆ™åˆ†ææ•´ä¸ªè§†é¢‘ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> Path(video_path).exists():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;é”™è¯¯: è§†é¢‘æ–‡ä»¶æœªæ‰¾åˆ°: <span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    cap = cv2.VideoCapture(video_path)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cap.isOpened():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;é”™è¯¯: æ— æ³•æ‰“å¼€è§†é¢‘æ–‡ä»¶: <span class="subst">&#123;video_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    total_frames_video = <span class="built_in">int</span>(cap.get(cv2.CAP_PROP_FRAME_COUNT))</span><br><span class="line">    fps = cap.get(cv2.CAP_PROP_FPS)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;è§†é¢‘ä¿¡æ¯: <span class="subst">&#123;Path(video_path).name&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  æ€»å¸§æ•°: <span class="subst">&#123;total_frames_video&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  FPS: <span class="subst">&#123;fps:<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;å¸§å·\tå¹³å‡äº®åº¦&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line">    csv_data = []</span><br><span class="line">    frame_count = <span class="number">0</span></span><br><span class="line">    processed_frame_num = <span class="number">0</span>  <span class="comment"># å®é™…å¤„ç†çš„å¸§çš„è®¡æ•°å™¨ï¼Œç”¨äº max_frames</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        ret, frame = cap.read()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ret:</span><br><span class="line">            <span class="keyword">break</span>  <span class="comment"># è§†é¢‘ç»“æŸæˆ–è¯»å–é”™è¯¯</span></span><br><span class="line"></span><br><span class="line">        current_frame_num_video = <span class="built_in">int</span>(</span><br><span class="line">            cap.get(cv2.CAP_PROP_POS_FRAMES))  <span class="comment"># è·å–å½“å‰å¸§åœ¨è§†é¢‘ä¸­çš„å®é™…ç¼–å· (1-based for some backends, 0-based for others)</span></span><br><span class="line">        <span class="comment"># æˆ–è€…ç›´æ¥ç”¨ frame_count ä½œä¸º0-basedçš„å¸§å·</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> frame_count % (frame_skip + <span class="number">1</span>) == <span class="number">0</span>:  <span class="comment"># frame_skip=0 è¡¨ç¤ºæ¯å¸§éƒ½å¤„ç†</span></span><br><span class="line">            avg_brightness = calculate_average_brightness(frame)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;frame_count&#125;</span>\t<span class="subst">&#123;avg_brightness:<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> output_csv_path:</span><br><span class="line">                csv_data.append([frame_count, avg_brightness])</span><br><span class="line"></span><br><span class="line">            processed_frame_num += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> max_frames <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> processed_frame_num &gt;= max_frames:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;\nå·²è¾¾åˆ°æœ€å¤§åˆ†æå¸§æ•°é™åˆ¶: <span class="subst">&#123;max_frames&#125;</span> å¸§ã€‚&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        frame_count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    cap.release()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;åˆ†æå®Œæˆã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> output_csv_path <span class="keyword">and</span> csv_data:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            output_file = Path(output_csv_path)</span><br><span class="line">            output_file.parent.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)  <span class="comment"># åˆ›å»ºè¾“å‡ºç›®å½•</span></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(output_file, <span class="string">&#x27;w&#x27;</span>, newline=<span class="string">&#x27;&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                <span class="keyword">import</span> csv</span><br><span class="line">                writer = csv.writer(f)</span><br><span class="line">                writer.writerow([<span class="string">&#x27;FrameNumber&#x27;</span>, <span class="string">&#x27;AverageBrightness&#x27;</span>])  <span class="comment"># å†™å…¥è¡¨å¤´</span></span><br><span class="line">                writer.writerows(csv_data)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;äº®åº¦æ•°æ®å·²ä¿å­˜åˆ°: <span class="subst">&#123;output_file&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;é”™è¯¯: æ— æ³•ä¿å­˜ CSV æ–‡ä»¶åˆ° <span class="subst">&#123;output_csv_path&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&quot;åˆ†æè§†é¢‘æ¯å¸§çš„å¹³å‡äº®åº¦ã€‚&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;video_path&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, <span class="built_in">help</span>=<span class="string">&quot;è¦åˆ†æçš„è§†é¢‘æ–‡ä»¶è·¯å¾„ã€‚&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-o&quot;</span>, <span class="string">&quot;--output_csv&quot;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>, default=<span class="literal">None</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;å¯é€‰ï¼šå°†ç»“æœä¿å­˜åˆ°çš„ CSV æ–‡ä»¶è·¯å¾„ã€‚ä¾‹å¦‚ï¼šbrightness_data.csv&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-s&quot;</span>, <span class="string">&quot;--frame_skip&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">0</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;å¯é€‰ï¼šæ¯éš”å¤šå°‘å¸§åˆ†æä¸€æ¬¡ï¼ˆ0 è¡¨ç¤ºé€å¸§åˆ†æï¼Œ1 è¡¨ç¤ºéš”1å¸§åˆ†æ1å¸§ï¼Œå³å¤„ç†ç¬¬0,2,4...å¸§ï¼‰ã€‚é»˜è®¤ä¸º0ã€‚&quot;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;-m&quot;</span>, <span class="string">&quot;--max_frames&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="literal">None</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;å¯é€‰ï¼šæœ€å¤šåˆ†æçš„å¸§æ•°ã€‚ç”¨äºå¿«é€Ÿé¢„è§ˆé•¿è§†é¢‘ã€‚é»˜è®¤ä¸ºåˆ†ææ•´ä¸ªè§†é¢‘ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) == <span class="number">1</span>:  <span class="comment"># å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œæ‰“å°å¸®åŠ©ä¿¡æ¯å¹¶é€€å‡º</span></span><br><span class="line">        parser.print_help(sys.stderr)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    analyze_video_brightness(args.video_path, args.output_csv, args.frame_skip, args.max_frames)</span><br></pre></td></tr></table></figure><h2 id="é˜ˆå€¼é€‰æ‹©æ–¹æ³•">é˜ˆå€¼é€‰æ‹©æ–¹æ³•</h2><blockquote><p>æŸ¥çœ‹ avg_scenes_vs_threshold.png å›¾ã€‚é€šå¸¸ï¼Œä½ ä¼šå¯»æ‰¾ä¸€ä¸ªç‚¹ï¼Œåœ¨è¯¥ç‚¹ä¹‹åï¼Œè¿›ä¸€æ­¥é™ä½é˜ˆå€¼ä¼šå¯¼è‡´åœºæ™¯æ•°é‡æ€¥å‰§å¢åŠ ï¼ˆå¯èƒ½å¼•å…¥è¿‡å¤šå™ªå£°æˆ–éæœŸæœ›çš„åˆ‡ç‚¹ï¼‰ï¼Œæˆ–è€…åœ¨è¯¥ç‚¹ä¹‹å‰ï¼Œæé«˜é˜ˆå€¼ä¼šå¯¼è‡´åœºæ™¯æ•°é‡æ€¥å‰§å‡å°‘ï¼ˆå¯èƒ½é—æ¼çœŸå®åˆ‡ç‚¹ï¼‰ã€‚ä¸€ä¸ªâ€œå¹³ç¨³â€çš„åŒºåŸŸæˆ–è€…ä¸€ä¸ªæ˜æ˜¾çš„â€œæ‹ç‚¹â€å¯èƒ½æ˜¯å¥½çš„å€™é€‰èŒƒå›´ã€‚<br>å¯¹äºä½ åœ¨å›¾è¡¨ä¸Šé€‰å‡ºçš„å‡ ä¸ªå€™é€‰é˜ˆå€¼</p></blockquote><ul><li>å¯è§†åŒ–é˜ˆå€¼é€‰æ‹©å·¥å…·ä½¿ç”¨æ–¹æ³•</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">python threshold_explorer.py &quot;/Volumes/shared/czq/video/scene-detect/æ·¡å…¥æ·¡å‡º-result/æ— è½¬åœº-result/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº&quot; \</span><br><span class="line">   -e &quot;.mp4,.mkv&quot; \</span><br><span class="line">   -r \</span><br><span class="line">   --sample_ratio 0.2 \</span><br><span class="line">   --threshold_start 1.0 \</span><br><span class="line">   --threshold_end 30.0 \</span><br><span class="line">   --threshold_step 1.0 \</span><br><span class="line">   --min_len 1 \</span><br><span class="line">   --output_dir &quot;./content_detector_exploration&quot; \</span><br><span class="line">   --save_images_for &quot;8.0,12.0,15.0&quot;</span><br></pre></td></tr></table></figure><ul><li>äº®åº¦æ£€æµ‹å·¥å…·ä½¿ç”¨æ–¹æ³•</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python analyze_brightness.py &#x27;/Volumes/shared/czq/video/scene-detect/æ·¡å…¥æ·¡å‡º-result/æ— è½¬åœº-result/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº/æ— è½¬åœº/3 (15).mp4&#x27;</span><br></pre></td></tr></table></figure><h3 id="ç»“æœæ˜¾ç¤º">ç»“æœæ˜¾ç¤º</h3><blockquote><p>å¦‚å›¾</p></blockquote><ul><li>å¹³å‡é˜ˆå€¼</li></ul><p><img src="/2025/05/15/scene-detect-method/avg_scenes_vs_threshold.png" class="lazyload placeholder" data-srcset="/2025/05/15/scene-detect-method/avg_scenes_vs_threshold.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li>æ£€æµ‹è§†é¢‘æ‰€æœ‰é˜ˆå€¼</li></ul><p><img src="/2025/05/15/scene-detect-method/scenes_vs_threshold_per_video.png" class="lazyload placeholder" data-srcset="/2025/05/15/scene-detect-method/scenes_vs_threshold_per_video.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">2025-05-14 19:17:47,588 - INFO - --- é˜ˆå€¼é€‰æ‹©å»ºè®® ---</span><br><span class="line">2025-05-14 19:17:47,589 - INFO - è¯·æŸ¥çœ‹ &#x27;avg_scenes_vs_threshold.png&#x27; å›¾è¡¨ã€‚</span><br><span class="line">2025-05-14 19:17:47,589 - INFO - ç†æƒ³çš„é˜ˆå€¼é€šå¸¸ä½äºä»¥ä¸‹åŒºåŸŸï¼š</span><br><span class="line">2025-05-14 19:17:47,589 - INFO -   - åœºæ™¯æ•°é‡å¼€å§‹æ˜¾è‘—å‡å°‘ä¹‹å‰çš„ç‚¹ï¼ˆå¦‚æœä½ æƒ³æ•æ‰æ›´å¤šç»†èŠ‚ï¼‰ã€‚</span><br><span class="line">2025-05-14 19:17:47,589 - INFO -   - åœºæ™¯æ•°é‡è¶‹äºç¨³å®šï¼Œä¸å†éšé˜ˆå€¼å¢åŠ è€Œå¤§å¹…å‡å°‘çš„ç‚¹ï¼ˆå¦‚æœä½ æƒ³æ›´é²æ£’ï¼Œå‡å°‘è¯¯æŠ¥ï¼‰ã€‚</span><br><span class="line">2025-05-14 19:17:47,589 - INFO -   - é¿å…é˜ˆå€¼è¿‡ä½å¯¼è‡´åœºæ™¯æ•°è¿‡å¤šï¼ˆå¯èƒ½æ˜¯å™ªå£°æˆ–å¾®å°å˜åŒ–ï¼‰ã€‚</span><br><span class="line">2025-05-14 19:17:47,589 - INFO -   - é¿å…é˜ˆå€¼è¿‡é«˜å¯¼è‡´åœºæ™¯æ•°è¿‡å°‘ï¼ˆå¯èƒ½é—æ¼çœŸå®åˆ‡æ¢ï¼‰ã€‚</span><br><span class="line">2025-05-14 19:17:47,590 - INFO -   æ ¹æ®ç®€å•çš„å˜åŒ–ç‡åˆ†æï¼Œå¯ä»¥å…³æ³¨ä»¥ä¸‹é˜ˆå€¼é™„è¿‘çš„è¡¨ç°ï¼š[2.0, 3.0, 9.0]</span><br><span class="line">2025-05-14 19:17:47,590 - INFO - ç»“åˆ &#x27;saved_scene_images&#x27; (å¦‚æœç”Ÿæˆäº†) ä¸­çš„å®é™…åœºæ™¯å›¾ç‰‡è¿›è¡Œäººå·¥åˆ¤æ–­ã€‚</span><br><span class="line">2025-05-14 19:17:47,590 - INFO - è¯·æ£€æŸ¥è¾“å‡ºç›®å½• &#x27;content_detector_exploration&#x27; ä¸­çš„ç»“æœã€‚</span><br><span class="line">2025-05-14 19:17:47,590 - INFO - é˜ˆå€¼æ¢ç´¢å®Œæˆã€‚</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ">å‚è€ƒ</h2><ul><li><ol><li><a href="https://www.scenedetect.com/docs/latest/cli.html#detect-threshold">https://www.scenedetect.com/docs/latest/cli.html#detect-threshold</a></li></ol></li><li><ol start="2"><li><a href="https://caozhaoqi.github.io/2025/04/03/video-secene-detect/">https://caozhaoqi.github.io/2025/04/03/video-secene-detect/</a></li></ol></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;PySceneDetect ä¸­åœºæ™¯æ£€æµ‹å™¨&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;ä¸»è¦åŒ…æ‹¬ï¼š&lt;code&gt;ContentDetector&lt;/code&gt;, &lt;code&gt;ThresholdDetector&lt;/code&gt;, &lt;code&gt;AdaptiveDetector&lt;/cod</summary>
      
    
    
    
    
    <category term="python" scheme="https://caozhaoqi.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºyolov8æ ¹æ®CVATæ ‡æ³¨ç»“æœè®­ç»ƒæ¨¡å‹</title>
    <link href="https://caozhaoqi.github.io/2025/04/09/yolov8-train-model/"/>
    <id>https://caozhaoqi.github.io/2025/04/09/yolov8-train-model/</id>
    <published>2025-04-09T02:55:34.000Z</published>
    <updated>2025-11-25T15:05:10.387Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ¨¡å‹ç®€ä»‹">æ¨¡å‹ç®€ä»‹</h2><blockquote><p>YOLO æ˜¯ä¸€ç§å®æ—¶ç›®æ ‡æ£€æµ‹ç®—æ³•å®¶æ—çš„åç§°ã€‚ä¸ä¼ ç»Ÿçš„éœ€è¦å…ˆè¿›è¡ŒåŒºåŸŸæè®®ï¼ˆRegion Proposalï¼‰å†è¿›è¡Œåˆ†ç±»çš„ä¸¤é˜¶æ®µæ£€æµ‹å™¨ï¼ˆå¦‚ Faster R-CNNï¼‰ä¸åŒï¼ŒYOLO å°†ç›®æ ‡æ£€æµ‹è§†ä¸ºä¸€ä¸ªå›å½’é—®é¢˜ï¼Œç›´æ¥ä»æ•´ä¸ªå›¾åƒä¸­é¢„æµ‹è¾¹ç•Œæ¡†çš„ä½ç½®å’Œç±»åˆ«æ¦‚ç‡ï¼Œå®ç°äº†ç«¯åˆ°ç«¯ï¼ˆend-to-endï¼‰çš„æ£€æµ‹ã€‚</p></blockquote><ul><li><strong>æ ¸å¿ƒæ€æƒ³:</strong><ol><li><strong>ç½‘æ ¼åˆ’åˆ†:</strong> å°†è¾“å…¥å›¾åƒåˆ’åˆ†ä¸º S x S çš„ç½‘æ ¼ (Grid Cells)ã€‚</li><li><strong>å•å…ƒæ ¼è´Ÿè´£åˆ¶:</strong> å¦‚æœä¸€ä¸ªç‰©ä½“çš„ä¸­å¿ƒè½å…¥æŸä¸ªç½‘æ ¼å•å…ƒï¼Œåˆ™è¯¥å•å…ƒè´Ÿè´£æ£€æµ‹è¯¥ç‰©ä½“ã€‚</li><li><strong>è¾¹ç•Œæ¡†é¢„æµ‹:</strong> æ¯ä¸ªç½‘æ ¼å•å…ƒé¢„æµ‹ B ä¸ªè¾¹ç•Œæ¡† (Bounding Boxes) ä»¥åŠè¿™äº›æ¡†çš„ç½®ä¿¡åº¦ (Confidence Scoreï¼Œè¡¨ç¤ºæ¡†å†…å«æœ‰ç‰©ä½“çš„æ¦‚ç‡åŠæ¡†çš„å‡†ç¡®åº¦)ã€‚æ¯ä¸ªè¾¹ç•Œæ¡†åŒ…å« 5 ä¸ªé¢„æµ‹å€¼ï¼š<code>x</code>, <code>y</code> (æ¡†ä¸­å¿ƒç›¸å¯¹å•å…ƒæ ¼çš„åæ ‡), <code>w</code>, <code>h</code> (æ¡†å®½é«˜ç›¸å¯¹æ•´å¼ å›¾åƒçš„æ¯”ä¾‹), å’Œ <code>confidence</code>ã€‚</li><li><strong>ç±»åˆ«æ¦‚ç‡é¢„æµ‹:</strong> æ¯ä¸ªç½‘æ ¼å•å…ƒè¿˜é¢„æµ‹ C ä¸ªæ¡ä»¶ç±»åˆ«æ¦‚ç‡ (Conditional Class Probabilities)ï¼Œå³åœ¨åŒ…å«ç‰©ä½“çš„å‰æä¸‹ï¼Œè¯¥ç‰©ä½“å±äºæ¯ä¸ªç±»åˆ«çš„æ¦‚ç‡ã€‚</li><li><strong>æœ€ç»ˆæ£€æµ‹:</strong> å°†æ¯ä¸ªè¾¹ç•Œæ¡†çš„ç½®ä¿¡åº¦ä¸å¯¹åº”å•å…ƒæ ¼çš„ç±»åˆ«æ¦‚ç‡ç›¸ä¹˜ï¼Œå¾—åˆ°æ¯ä¸ªæ¡†é’ˆå¯¹æ¯ä¸ªç±»åˆ«çš„å¾—åˆ†ã€‚é€šè¿‡è®¾ç½®é˜ˆå€¼è¿‡æ»¤ä½åˆ†æ¡†ï¼Œå¹¶ä½¿ç”¨éæå¤§å€¼æŠ‘åˆ¶ (Non-Maximum Suppression, NMS) æ¶ˆé™¤å†—ä½™çš„é‡å æ¡†ï¼Œå¾—åˆ°æœ€ç»ˆçš„æ£€æµ‹ç»“æœã€‚</li></ol></li></ul><h2 id="CVATç®€ä»‹">CVATç®€ä»‹</h2><blockquote><p>åŸºäº Web çš„ã€åŠŸèƒ½å¼ºå¤§çš„è®¡ç®—æœºè§†è§‰æ•°æ®æ ‡æ³¨å·¥å…·ã€‚å®ƒæ”¯æŒå¯¹å›¾åƒå’Œè§†é¢‘è¿›è¡Œå¤šç§ç±»å‹çš„æ ‡æ³¨ï¼Œæ˜¯è®¡ç®—æœºè§†è§‰é¡¹ç›®ï¼ˆå°¤å…¶æ˜¯ç›‘ç£å­¦ä¹ ï¼‰ä¸­æ•°æ®å‡†å¤‡é˜¶æ®µçš„é‡è¦å·¥å…·</p></blockquote><ul><li><strong>ä¸»è¦åŠŸèƒ½:</strong><ul><li><strong>å¤šç§æ ‡æ³¨ç±»å‹:</strong><ul><li><strong>è¾¹ç•Œæ¡† (Bounding Boxes):</strong> ç”¨äºç›®æ ‡æ£€æµ‹ä»»åŠ¡ï¼Œæ¡†å‡ºç‰©ä½“çš„ä½ç½®ã€‚</li><li><strong>å¤šè¾¹å½¢ (Polygons):</strong> ç”¨äºå®ä¾‹åˆ†å‰²ä»»åŠ¡ï¼Œç²¾ç¡®å‹¾å‹’ç‰©ä½“çš„è½®å»“ã€‚</li><li><strong>å…³é”®ç‚¹ (Points / Skeleton):</strong> ç”¨äºå§¿æ€ä¼°è®¡ã€äººè„¸å…³é”®ç‚¹æ£€æµ‹ç­‰ä»»åŠ¡ã€‚</li><li><strong>åˆ†å‰²æ©ç  (Segmentation Masks):</strong> ç”¨äºè¯­ä¹‰åˆ†å‰²ä»»åŠ¡ï¼Œä¸ºå›¾åƒä¸­çš„æ¯ä¸ªåƒç´ åˆ†é…ç±»åˆ«ã€‚</li><li><strong>æ ‡ç­¾ (Tags):</strong> ç”¨äºå›¾åƒåˆ†ç±»ä»»åŠ¡ï¼Œä¸ºæ•´ä¸ªå›¾åƒåˆ†é…ç±»åˆ«æ ‡ç­¾ã€‚</li><li><strong>è½¨è¿¹/ç«‹æ–¹ä½“ (Tracks/Cuboids):</strong> æ”¯æŒè§†é¢‘æ ‡æ³¨ï¼Œå¯ä»¥è·Ÿè¸ªç‰©ä½“æˆ–æ ‡æ³¨3Dè¾¹ç•Œæ¡†ã€‚</li></ul></li><li><strong>å›¾åƒå’Œè§†é¢‘æ”¯æŒ:</strong> å¯ä»¥ç›´æ¥å¯¹å•å¼ å›¾ç‰‡æˆ–æ•´ä¸ªè§†é¢‘åºåˆ—è¿›è¡Œæ ‡æ³¨ã€‚è§†é¢‘æ ‡æ³¨æ”¯æŒæ’å€¼ï¼ˆinterpolationï¼‰ï¼Œå¯ä»¥å‡å°‘æ‰‹åŠ¨æ ‡æ³¨çš„å·¥ä½œé‡ã€‚</li><li><strong>åŠè‡ªåŠ¨å’Œè‡ªåŠ¨æ ‡æ³¨:</strong> é›†æˆäº†å¤šç§ AI æ¨¡å‹ï¼ˆå¦‚ç›®æ ‡æ£€æµ‹ã€åˆ†å‰²æ¨¡å‹ï¼ŒåŒ…æ‹¬ YOLOã€SAM ç­‰ï¼‰ï¼Œå¯ä»¥é¢„æ ‡æ³¨æ•°æ®ï¼Œç„¶åç”±äººå·¥è¿›è¡Œä¿®æ­£ï¼Œæé«˜æ•ˆç‡ã€‚æ”¯æŒè¿æ¥å¤–éƒ¨ AI æ¨¡å‹ï¼ˆå¦‚é€šè¿‡ Nuclioï¼‰ã€‚</li><li><strong>åä½œ:</strong> æ”¯æŒå¤šç”¨æˆ·åä½œï¼Œå¯ä»¥åˆ†é…ä»»åŠ¡ã€è¿›è¡Œå®¡æ ¸ç­‰ã€‚</li><li><strong>æ•°æ®ç®¡ç†:</strong> æä¾›é¡¹ç›® (Project) å’Œä»»åŠ¡ (Task) ç®¡ç†åŠŸèƒ½ï¼Œæ–¹ä¾¿ç»„ç»‡æ•°æ®ã€‚</li><li><strong>å¤šç§å¯¼å‡ºæ ¼å¼:</strong> æ”¯æŒå¯¼å‡ºä¸ºå¤šç§å¸¸è§çš„æ•°æ®é›†æ ¼å¼ï¼Œå¦‚ COCO JSON, Pascal VOC XML, YOLO, MOT, Segmentation Mask ç­‰ï¼Œæ–¹ä¾¿ä¸å„ç§æ·±åº¦å­¦ä¹ æ¡†æ¶å¯¹æ¥ã€‚</li><li><strong>å¯æ‰©å±•æ€§:</strong> å¼€æºï¼Œå¯ä»¥é€šè¿‡æ’ä»¶æˆ–é›†æˆè‡ªå®šä¹‰å·¥å…·è¿›è¡Œæ‰©å±•ã€‚</li><li><strong>éƒ¨ç½²:</strong> å¯ä»¥é€šè¿‡ Docker åœ¨æœ¬åœ°ã€æœåŠ¡å™¨æˆ–äº‘ä¸Šéƒ¨ç½²ã€‚</li></ul></li></ul><p><img src="/2025/04/09/yolov8-train-model/train_model.png" class="lazyload placeholder" data-srcset="/2025/04/09/yolov8-train-model/train_model.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="CVATæ ‡æ³¨ç»“æœå¯¼å‡º">CVATæ ‡æ³¨ç»“æœå¯¼å‡º</h2><blockquote><p>ä½¿ç”¨ä» CVAT å¯¼å‡ºçš„ YOLO æ ¼å¼æ•°æ®ï¼Œå¹¶åœ¨ <strong>CPU</strong> ä¸Šè®­ç»ƒä¸€ä¸ªæ–°çš„ YOLOv8 æ¨¡å‹ï¼ˆä½¿ç”¨ Ultralytics æ¡†æ¶ï¼‰ï¼Œä»¥ä¸‹è¯¦ç»†æ­¥éª¤ã€‚</p></blockquote><p><strong>é‡è¦æç¤ºï¼š</strong> åœ¨ CPU ä¸Šè®­ç»ƒç›®æ ‡æ£€æµ‹æ¨¡å‹ï¼ˆå°¤å…¶æ˜¯åƒ YOLOv8 è¿™æ ·è¾ƒç°ä»£çš„æ¨¡å‹ï¼‰å°†ä¼š<strong>éå¸¸éå¸¸æ…¢</strong>ã€‚æ ¹æ®ä½ çš„æ•°æ®é›†å¤§å°ã€æ¨¡å‹å¤§å°å’Œ CPU æ€§èƒ½ï¼Œä¸€ä¸ª epoch å¯èƒ½éœ€è¦æ•°å°æ—¶ç”šè‡³æ›´é•¿æ—¶é—´ã€‚è¿™é€šå¸¸åªé€‚ç”¨äºéå¸¸å°çš„æ•°æ®é›†ã€å¿«é€ŸåŸå‹éªŒè¯æˆ–æ²¡æœ‰ GPU å¯ç”¨çš„æƒ…å†µã€‚è¯·æœ‰å¿ƒç†å‡†å¤‡ã€‚</p><p><strong>æ­¥éª¤ 1ï¼šä» CVAT å¯¼å‡º YOLO æ ¼å¼æ•°æ®</strong></p><ol><li><strong>ç™»å½• CVAT</strong> å¹¶å¯¼èˆªåˆ°ä½ å·²å®Œæˆæ ‡æ³¨çš„ä»»åŠ¡ (Task)ã€‚</li><li>ç‚¹å‡»ä»»åŠ¡å¡ç‰‡ä¸Šçš„ <strong>â€œActionsâ€</strong> (æˆ–ä»»åŠ¡é¡µé¢å†…çš„èœå•æŒ‰é’®)ã€‚</li><li>é€‰æ‹© <strong>â€œExport task datasetâ€</strong>ã€‚</li><li>åœ¨å¼¹å‡ºçš„çª—å£ä¸­ï¼š<ul><li><strong>é€‰æ‹©æ ¼å¼:</strong> <strong>åŠ¡å¿…é€‰æ‹© <code>YOLO</code> æˆ– <code>YOLO ZIP</code></strong>ã€‚</li><li><strong>å­é›†åˆ’åˆ† (å¯é€‰ä½†æ¨è):</strong> å¦‚æœä½ åœ¨ CVAT ä¸­å·²å°†æ•°æ®åˆ†é…åˆ° <code>Train</code>, <code>Validation</code>, <code>Test</code> å­é›†ï¼Œè¯·ç¡®ä¿å‹¾é€‰äº†ç›¸åº”çš„é€‰é¡¹æ¥å¯¼å‡ºè¿™äº›å­é›†ã€‚è¿™ä¼šçœå»ä½ æ‰‹åŠ¨åˆ’åˆ†çš„æ­¥éª¤ã€‚å¦‚æœæ²¡åˆ’åˆ†ï¼Œåˆ™å¯¼å‡ºæ•´ä¸ªæ•°æ®é›†ã€‚</li><li><strong>ä¿å­˜å›¾åƒ:</strong> ç¡®ä¿å‹¾é€‰äº† â€œSave imagesâ€ é€‰é¡¹ã€‚</li></ul></li><li>ç‚¹å‡» <strong>â€œOKâ€</strong> æˆ– <strong>â€œExportâ€</strong>ã€‚</li><li>ç­‰å¾…å¯¼å‡ºä»»åŠ¡å®Œæˆï¼Œç„¶åä¸‹è½½ç”Ÿæˆçš„ <strong>ZIP æ–‡ä»¶</strong>ã€‚</li></ol><p><strong>æ­¥éª¤ 2ï¼šå‡†å¤‡æ•°æ®é›†æ–‡ä»¶</strong></p><ol><li><strong>è§£å‹ ZIP æ–‡ä»¶:</strong> å°†ä¸‹è½½çš„ ZIP æ–‡ä»¶è§£å‹åˆ°ä½ ç”µè„‘ä¸Šä¸€ä¸ªæ–¹ä¾¿è®¿é—®çš„ä½ç½®ï¼Œä¾‹å¦‚ <code>~/datasets/my_yolo_dataset</code>ã€‚</li><li><strong>æ£€æŸ¥æ–‡ä»¶ç»“æ„:</strong> è§£å‹åï¼Œæ£€æŸ¥é‡Œé¢çš„å†…å®¹ã€‚ä¸€ä¸ªå…¸å‹çš„ YOLO å¯¼å‡ºï¼ˆç‰¹åˆ«æ˜¯åŒ…å«å­é›†åˆ’åˆ†çš„ï¼‰å¯èƒ½åŒ…å«ï¼š<ul><li><code>data.yaml</code> (æˆ– <code>obj.data</code> å’Œ <code>obj.names</code> æ–‡ä»¶)ï¼šè¿™æ˜¯é…ç½®æ–‡ä»¶ï¼Œéå¸¸é‡è¦ã€‚</li><li><code>train/</code> (æˆ–ç±»ä¼¼çš„åç§°)<ul><li><code>images/</code>: åŒ…å«è®­ç»ƒé›†çš„å›¾åƒæ–‡ä»¶ (<code>.jpg</code>, <code>.png</code> ç­‰)ã€‚</li><li><code>labels/</code>: åŒ…å«è®­ç»ƒé›†çš„æ ‡æ³¨æ–‡ä»¶ (<code>.txt</code>)ï¼Œæ¯ä¸ªå›¾åƒå¯¹åº”ä¸€ä¸ªã€‚</li></ul></li><li><code>valid/</code> (æˆ– <code>val/</code>)<ul><li><code>images/</code>: åŒ…å«éªŒè¯é›†çš„å›¾åƒæ–‡ä»¶ã€‚</li><li><code>labels/</code>: åŒ…å«éªŒè¯é›†çš„æ ‡æ³¨æ–‡ä»¶ã€‚</li></ul></li><li><code>test/</code> (å¯é€‰)<ul><li><code>images/</code>: åŒ…å«æµ‹è¯•é›†çš„å›¾åƒæ–‡ä»¶ã€‚</li><li><code>labels/</code>: åŒ…å«æµ‹è¯•é›†çš„æ ‡æ³¨æ–‡ä»¶ã€‚</li></ul></li><li><em>å¦‚æœå¯¼å‡ºæ—¶æ²¡æœ‰åˆ’åˆ†:</em> ä½ å¯èƒ½åªæœ‰ä¸€ä¸ª <code>images/</code> å’Œä¸€ä¸ª <code>labels/</code> æ–‡ä»¶å¤¹ï¼Œä»¥åŠé…ç½®æ–‡ä»¶ã€‚</li></ul></li><li><strong>éªŒè¯/ä¿®æ”¹ <code>data.yaml</code> (æˆ–åˆ›å»ºå®ƒ):</strong> è¿™æ˜¯å‘Šè¯‰ YOLOv8 æ¡†æ¶å¦‚ä½•æ‰¾åˆ°ä½ çš„æ•°æ®çš„å…³é”®æ–‡ä»¶ã€‚<ul><li><strong>å¦‚æœå·²æœ‰ <code>data.yaml</code>:</strong> ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€å®ƒã€‚å®ƒçœ‹èµ·æ¥ç±»ä¼¼è¿™æ ·ï¼š<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">path:</span> <span class="string">../datasets/my_yolo_dataset</span> <span class="comment"># ï¼ï¼å¯èƒ½éœ€è¦ä¿®æ”¹ï¼šæ•°æ®é›†æ ¹ç›®å½•çš„ç›¸å¯¹æˆ–ç»å¯¹è·¯å¾„</span></span><br><span class="line"><span class="attr">train:</span> <span class="string">train/images</span>             <span class="comment"># ï¼ï¼è®­ç»ƒé›†å›¾ç‰‡è·¯å¾„ (ç›¸å¯¹äº path)</span></span><br><span class="line"><span class="attr">val:</span> <span class="string">valid/images</span>               <span class="comment"># ï¼ï¼éªŒè¯é›†å›¾ç‰‡è·¯å¾„ (ç›¸å¯¹äº path)</span></span><br><span class="line"><span class="comment"># test: test/images             # å¯é€‰ï¼šæµ‹è¯•é›†å›¾ç‰‡è·¯å¾„</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Classes</span></span><br><span class="line"><span class="attr">nc:</span> <span class="number">9</span>                           <span class="comment"># ï¼ï¼ç±»åˆ«æ•°é‡ï¼Œå¿…é¡»å‡†ç¡®</span></span><br><span class="line"><span class="attr">names:</span> [<span class="string">&#x27;bus&#x27;</span>, <span class="string">&#x27;car&#x27;</span>, <span class="string">&#x27;clock&#x27;</span>, <span class="string">...</span>] <span class="comment"># ï¼ï¼ç±»åˆ«åç§°åˆ—è¡¨ï¼Œé¡ºåºå¿…é¡»ä¸ labels/*.txt ä¸­çš„ç±»åˆ«ID (0, 1, 2...) å®Œå…¨å¯¹åº”ï¼</span></span><br></pre></td></tr></table></figure><strong>ä½ éœ€è¦ä»”ç»†æ£€æŸ¥å¹¶å¯èƒ½ä¿®æ”¹ï¼š</strong><ul><li><code>path</code>: ç¡®ä¿å®ƒæ­£ç¡®æŒ‡å‘ä½ è§£å‹æ•°æ®é›†çš„<strong>æ ¹ç›®å½•</strong>ã€‚<strong>ç›¸å¯¹äºä½ å°†è¦è¿è¡Œè®­ç»ƒå‘½ä»¤çš„ä½ç½®</strong>ã€‚ä½¿ç”¨ç»å¯¹è·¯å¾„é€šå¸¸æ›´å®‰å…¨ã€‚ä¾‹å¦‚ï¼š<code>/home/your_user/datasets/my_yolo_dataset</code>ã€‚</li><li><code>train</code>, <code>val</code>, <code>test</code>: ç¡®ä¿å®ƒä»¬æ­£ç¡®æŒ‡å‘åŒ…å«å›¾åƒæ–‡ä»¶çš„æ–‡ä»¶å¤¹ï¼ˆç›¸å¯¹äº <code>path</code> å®šä¹‰çš„è·¯å¾„ï¼‰ã€‚</li><li><code>nc</code>: ç¡®ä¿ç±»åˆ«æ•°é‡æ­£ç¡®æ— è¯¯ã€‚</li><li><code>names</code>: <strong>æå…¶é‡è¦ï¼</strong> ç¡®ä¿è¿™ä¸ªåˆ—è¡¨ä¸­çš„ç±»åˆ«åç§°<strong>é¡ºåº</strong>ä¸ CVAT å¯¼å‡ºæ—¶ä½¿ç”¨çš„ç±»åˆ« IDï¼ˆä» 0 å¼€å§‹ï¼‰ä»¥åŠ <code>labels/</code> æ–‡ä»¶å¤¹ä¸‹ <code>.txt</code> æ–‡ä»¶ä¸­ä½¿ç”¨çš„æ•°å­— ID å®Œå…¨ä¸€è‡´ã€‚CVAT å¯¼å‡º YOLO æ ¼å¼æ—¶é€šå¸¸ä¼šä¿è¯è¿™ä¸€ç‚¹ï¼Œä½†åŠ¡å¿…æ£€æŸ¥ã€‚</li></ul></li><li><strong>å¦‚æœåªæœ‰ <code>obj.data</code> å’Œ <code>obj.names</code>:</strong> ä½ éœ€è¦<strong>æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ª <code>data.yaml</code> æ–‡ä»¶</strong>ã€‚<ul><li>æ‰“å¼€ <code>obj.names</code>ï¼Œå°†é‡Œé¢çš„ç±»åˆ«åç§°æŒ‰é¡ºåºåˆ—å…¥ <code>data.yaml</code> çš„ <code>names</code> å­—æ®µã€‚è®¡ç®—ç±»åˆ«æ•°é‡å¡«å…¥ <code>nc</code>ã€‚</li><li>æ‰“å¼€ <code>obj.data</code>ï¼Œå®ƒé€šå¸¸åŒ…å«ç±»åˆ«æ•°é‡ã€è®­ç»ƒé›†/éªŒè¯é›†å›¾åƒåˆ—è¡¨æ–‡ä»¶çš„è·¯å¾„ç­‰ä¿¡æ¯ã€‚ä½ éœ€è¦æ ¹æ®è¿™äº›ä¿¡æ¯å’Œä½ çš„å®é™…æ–‡ä»¶ç»“æ„æ¥å¡«å†™ <code>data.yaml</code> ä¸­çš„ <code>path</code>, <code>train</code>, <code>val</code> å­—æ®µã€‚ä½ å¯èƒ½éœ€è¦å°† <code>obj.data</code> ä¸­æŒ‡å‘çš„å›¾åƒåˆ—è¡¨æ–‡ä»¶ï¼ˆä¾‹å¦‚ <code>train.txt</code>, <code>valid.txt</code>ï¼‰ä¹Ÿæ”¾åˆ°ä½ çš„æ•°æ®é›†ç›®å½•ä¸­ï¼Œæˆ–è€…ç›´æ¥ä¿®æ”¹ <code>data.yaml</code> æŒ‡å‘åŒ…å«å›¾åƒçš„æ–‡ä»¶å¤¹ã€‚åˆ›å»º <code>data.yaml</code> é€šå¸¸æ›´ç¬¦åˆç°ä»£ YOLOv8 çš„ä¹ æƒ¯ã€‚</li></ul></li></ul></li><li><strong>æ‰‹åŠ¨åˆ’åˆ†æ•°æ®é›† (å¦‚æœå¯¼å‡ºæ—¶æœªåˆ’åˆ†):</strong><ul><li>å¦‚æœä½ åªæœ‰ä¸€ä¸ª <code>images/</code> å’Œ <code>labels/</code> æ–‡ä»¶å¤¹ï¼Œä½ éœ€è¦æ‰‹åŠ¨å°†å…¶åˆ’åˆ†ä¸ºè®­ç»ƒé›†å’ŒéªŒè¯é›†ã€‚</li><li>åˆ›å»ºå­ç›®å½•ï¼šåœ¨æ•°æ®é›†æ ¹ç›®å½•ä¸‹åˆ›å»º <code>train/images</code>, <code>train/labels</code>, <code>valid/images</code>, <code>valid/labels</code>ã€‚</li><li>ç¼–å†™è„šæœ¬æˆ–æ‰‹åŠ¨ç§»åŠ¨æ–‡ä»¶ï¼š<ul><li>ç¡®å®šåˆ’åˆ†æ¯”ä¾‹ï¼ˆä¾‹å¦‚ï¼Œ80% è®­ç»ƒï¼Œ20% éªŒè¯ï¼‰ã€‚</li><li>éå† <code>images/</code> æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰å›¾åƒæ–‡ä»¶ã€‚</li><li>å¯¹äºæ¯ä¸ªå›¾åƒæ–‡ä»¶ï¼ˆä¾‹å¦‚ <code>image1.jpg</code>ï¼‰ï¼Œæ‰¾åˆ°å…¶å¯¹åº”çš„æ ‡æ³¨æ–‡ä»¶ï¼ˆ<code>labels/image1.txt</code>ï¼‰ã€‚</li><li>æ ¹æ®éšæœºæŠ½æ ·æˆ–å›ºå®šè§„åˆ™ï¼Œå°†è¿™å¯¹æ–‡ä»¶ï¼ˆå›¾åƒå’Œæ ‡æ³¨ï¼‰ç§»åŠ¨åˆ° <code>train/</code> æˆ– <code>valid/</code> ä¸‹ç›¸åº”çš„ <code>images</code> å’Œ <code>labels</code> æ–‡ä»¶å¤¹ä¸­ã€‚</li><li>ç¡®ä¿å›¾åƒå’Œå®ƒçš„ <code>.txt</code> æ ‡æ³¨æ–‡ä»¶å§‹ç»ˆåœ¨åŒä¸€é›†åˆï¼ˆtrain æˆ– validï¼‰ä¸­ã€‚</li></ul></li><li>æ›´æ–° <code>data.yaml</code> ä¸­çš„ <code>train</code> å’Œ <code>val</code> è·¯å¾„æŒ‡å‘ä½ æ–°åˆ›å»ºçš„ <code>train/images</code> å’Œ <code>valid/images</code> æ–‡ä»¶å¤¹ã€‚</li></ul></li></ol><p><strong>æ­¥éª¤ 3ï¼šè®¾ç½® Python å’Œ Ultralytics ç¯å¢ƒ</strong></p><ol><li><strong>å®‰è£… Python:</strong> ç¡®ä¿ä½ å®‰è£…äº†è¾ƒæ–°ç‰ˆæœ¬çš„ Pythonï¼ˆæ¨è 3.8 - 3.11ï¼‰ã€‚</li><li><strong>åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ (å¼ºçƒˆæ¨è):</strong> è¿™å¯ä»¥é¿å…åº“ç‰ˆæœ¬å†²çªã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ venv (Python å†…ç½®)</span></span><br><span class="line">python -m venv yolo_cpu_env</span><br><span class="line"><span class="built_in">source</span> yolo_cpu_env/bin/activate  <span class="comment"># Linux/macOS</span></span><br><span class="line"><span class="comment"># yolo_cpu_env\Scripts\activate  # Windows</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ–è€…ä½¿ç”¨ Conda</span></span><br><span class="line"><span class="comment"># conda create -n yolo_cpu_env python=3.9</span></span><br><span class="line"><span class="comment"># conda activate yolo_cpu_env</span></span><br></pre></td></tr></table></figure></li><li><strong>å®‰è£… Ultralytics YOLOv8:</strong> åœ¨æ¿€æ´»çš„è™šæ‹Ÿç¯å¢ƒä¸­è¿è¡Œï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install ultralytics</span><br></pre></td></tr></table></figure>è¿™ä¼šè‡ªåŠ¨å®‰è£… PyTorch çš„ CPU ç‰ˆæœ¬ï¼ˆå› ä¸ºå®ƒæ£€æµ‹ä¸åˆ°å…¼å®¹çš„ GPU/CUDAï¼‰ä»¥åŠå…¶ä»–å¿…è¦çš„ä¾èµ–åº“ã€‚</li></ol><p><strong>æ­¥éª¤ 4ï¼šé…ç½®è®­ç»ƒå‚æ•°</strong></p><ol><li><strong>é€‰æ‹©é¢„è®­ç»ƒæ¨¡å‹:</strong> ä¸ºäº†åˆ©ç”¨è¿ç§»å­¦ä¹ å¹¶åŠ å¿«ï¼ˆç›¸å¯¹è€Œè¨€ï¼‰æ”¶æ•›é€Ÿåº¦ï¼Œä½ éœ€è¦ä»ä¸€ä¸ªé¢„è®­ç»ƒæ¨¡å‹å¼€å§‹ã€‚å¯¹äº CPU è®­ç»ƒï¼Œ<strong>å¼ºçƒˆå»ºè®®ä»å°æ¨¡å‹å¼€å§‹</strong>ï¼š<ul><li><code>yolov8n.pt</code> (Nano): æœ€å¿«ï¼Œå ç”¨èµ„æºæœ€å°‘ï¼Œä½†ç²¾åº¦ç›¸å¯¹è¾ƒä½ã€‚<strong>CPU è®­ç»ƒçš„é¦–é€‰èµ·ç‚¹ã€‚</strong></li><li><code>yolov8s.pt</code> (Small): ç¨å¤§ï¼Œç¨æ…¢ï¼Œç²¾åº¦ç¨é«˜ã€‚å¦‚æœ <code>yolov8n</code> æ•ˆæœä¸ä½³ä¸”ä½ çš„ CPU å°šå¯æ‰¿å—ï¼Œå¯ä»¥å°è¯•ã€‚</li><li>æ›´å¤§çš„æ¨¡å‹ (<code>m</code>, <code>l</code>, <code>x</code>) åœ¨ CPU ä¸Šè®­ç»ƒå‡ ä¹ä¸å¯è¡Œã€‚</li><li>Ultralytics ä¼šåœ¨ä½ ç¬¬ä¸€æ¬¡ä½¿ç”¨æ¨¡å‹æ—¶è‡ªåŠ¨ä¸‹è½½ <code>.pt</code> æ–‡ä»¶ã€‚</li></ul></li><li><strong>ç¡®å®šè®­ç»ƒå‚æ•°:</strong><ul><li><strong><code>model</code>:</strong> ä½ é€‰æ‹©çš„é¢„è®­ç»ƒæ¨¡å‹ï¼Œä¾‹å¦‚ <code>yolov8n.pt</code>ã€‚</li><li><strong><code>data</code>:</strong> æŒ‡å‘ä½ å‡†å¤‡å¥½çš„ <code>data.yaml</code> æ–‡ä»¶çš„è·¯å¾„ã€‚</li><li><strong><code>epochs</code>:</strong> è®­ç»ƒçš„æ€»è½®æ•°ã€‚å¯¹äº CPUï¼Œå¯ä»¥å…ˆè®¾ç½®ä¸€ä¸ªè¾ƒå°çš„å€¼ï¼ˆä¾‹å¦‚ 10-50ï¼‰æ¥æµ‹è¯•æµç¨‹å’Œè§‚å¯Ÿåˆæ­¥ç»“æœï¼Œåç»­å†å¢åŠ ã€‚å®Œæ•´è®­ç»ƒå¯èƒ½éœ€è¦ 100-300 è½®ç”šè‡³æ›´å¤šï¼Œä½†è¿™åœ¨ CPU ä¸Šä¼šè€—è´¹æé•¿æ—¶é—´ã€‚</li><li><strong><code>batch</code>:</strong> æ‰¹å¤„ç†å¤§å°ã€‚<strong>CPU è®­ç»ƒçš„å…³é”®å‚æ•°</strong>ã€‚ç”±äº CPU è®¡ç®—èƒ½åŠ›å’Œå†…å­˜å¸¦å®½é™åˆ¶ï¼Œä½ éœ€è¦è®¾ç½®ä¸€ä¸ª<strong>éå¸¸å°</strong>çš„å€¼ï¼Œä¾‹å¦‚ <code>2</code>, <code>4</code>, <code>8</code>ã€‚å¯ä»¥ä» 4 æˆ– 8 å¼€å§‹å°è¯•ï¼Œå¦‚æœå†…å­˜ä¸è¶³ (OOM) æˆ– CPU å ç”¨è¿‡é«˜å¯¼è‡´ç³»ç»Ÿå¡é¡¿ï¼Œåˆ™éœ€è¦å‡å°ã€‚</li><li><strong><code>imgsz</code>:</strong> è¾“å…¥å›¾åƒçš„å°ºå¯¸ã€‚é€šå¸¸è®¾ç½®ä¸º 640ã€‚æ›´å¤§çš„å°ºå¯¸ä¼šæ˜¾è‘—å¢åŠ  CPU è®¡ç®—è´Ÿæ‹…å’Œå†…å­˜å ç”¨ã€‚CPU è®­ç»ƒå»ºè®®ä¿æŒ 640 æˆ–æ›´å°ã€‚</li><li><strong><code>device</code>:</strong> <strong>å¿…é¡»è®¾ç½®ä¸º <code>cpu</code></strong>ã€‚<code>device=cpu</code>ã€‚</li><li><strong><code>workers</code>:</strong> æ•°æ®åŠ è½½æ—¶ä½¿ç”¨çš„ CPU æ ¸å¿ƒæ•°ã€‚å¯ä»¥è®¾ç½®ä¸ºä½  CPU æ ¸å¿ƒæ•°çš„ä¸€éƒ¨åˆ†ï¼Œä¾‹å¦‚ <code>2</code>, <code>4</code>ã€‚ä¸ä¸€å®šè¶Šå¤šè¶Šå¥½ï¼Œè¿‡é«˜å¯èƒ½å¯¼è‡´ CPU äº‰ç”¨ã€‚</li></ul></li></ol><p><strong>æ­¥éª¤ 5ï¼šæ‰§è¡Œè®­ç»ƒ</strong></p><ol><li><p><strong>æ‰“å¼€ç»ˆç«¯æˆ–å‘½ä»¤è¡Œã€‚</strong></p></li><li><p><strong>æ¿€æ´»ä½ çš„è™šæ‹Ÿç¯å¢ƒ</strong> (å¦‚ <code>source yolo_cpu_env/bin/activate</code>)ã€‚</p></li><li><p><strong>å¯¼èˆªåˆ°ä½ çš„é¡¹ç›®ç›®å½•</strong> (é€šå¸¸æ˜¯ä½ å­˜æ”¾ <code>data.yaml</code> æˆ–æ‰“ç®—è¿è¡Œè„šæœ¬çš„åœ°æ–¹ï¼Œç¡®ä¿ <code>data.yaml</code> ä¸­çš„è·¯å¾„ç›¸å¯¹äºæ­¤ä½ç½®æ˜¯æ­£ç¡®çš„)ã€‚</p></li><li><p><strong>è¿è¡Œè®­ç»ƒå‘½ä»¤:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yolo train model=yolov8n.pt data=/path/to/your/data.yaml epochs=50 batch=4 imgsz=640 device=cpu workers=4</span><br></pre></td></tr></table></figure><ul><li><strong>è¯·å°† <code>/path/to/your/data.yaml</code> æ›¿æ¢ä¸ºä½ çš„ <code>data.yaml</code> æ–‡ä»¶çš„å®é™…è·¯å¾„ã€‚</strong></li><li><strong>æ ¹æ®éœ€è¦è°ƒæ•´ <code>epochs</code>, <code>batch</code>, <code>workers</code> çš„å€¼ã€‚</strong></li><li><strong>å†æ¬¡å¼ºè°ƒï¼šè¯·æœ‰è€å¿ƒï¼</strong> ä½ ä¼šçœ‹åˆ°è®­ç»ƒå¼€å§‹ï¼Œå¹¶æ˜¾ç¤ºæ¯ä¸ª epoch çš„è¿›åº¦ã€æŸå¤±å€¼ç­‰ï¼Œä½†è¿™ä¼šéå¸¸æ…¢ã€‚</li></ul></li><li><p><strong>æˆ–è€…ä½¿ç”¨ Python è„šæœ¬è¿›è¡Œè®­ç»ƒ:</strong> åˆ›å»ºä¸€ä¸ª Python æ–‡ä»¶ï¼ˆä¾‹å¦‚ <code>train_cpu.py</code>ï¼‰:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> YOLO</span><br><span class="line"><span class="keyword">import</span> torch <span class="comment"># å¯¼å…¥ torch ä»¥ä¾¿æ£€æŸ¥</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># æ£€æŸ¥ PyTorch æ˜¯å¦ç¡®å®åœ¨ä½¿ç”¨ CPU</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;PyTorch device: <span class="subst">&#123;torch.cuda.is_available() <span class="keyword">and</span> torch.device(<span class="string">&#x27;cuda&#x27;</span>) <span class="keyword">or</span> torch.device(<span class="string">&#x27;cpu&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># åŠ è½½ä¸€ä¸ªé¢„è®­ç»ƒæ¨¡å‹ (ä¾‹å¦‚ yolov8n.pt)</span></span><br><span class="line">    <span class="comment"># æ¨¡å‹æ–‡ä»¶å¦‚æœæœ¬åœ°æ²¡æœ‰ï¼Œé¦–æ¬¡è¿è¡Œæ—¶ä¼šè‡ªåŠ¨ä¸‹è½½</span></span><br><span class="line">    model = YOLO(<span class="string">&#x27;yolov8n.pt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¼€å§‹è®­ç»ƒ</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        results = model.train(</span><br><span class="line">            data=<span class="string">&#x27;/path/to/your/data.yaml&#x27;</span>,  <span class="comment"># ï¼ï¼æ›¿æ¢ä¸ºä½ çš„ data.yaml è·¯å¾„</span></span><br><span class="line">            epochs=<span class="number">50</span>,                      <span class="comment"># è®­ç»ƒè½®æ•°</span></span><br><span class="line">            batch=<span class="number">4</span>,                        <span class="comment"># æ‰¹å¤§å° (æ ¹æ®CPUå’Œå†…å­˜è°ƒæ•´)</span></span><br><span class="line">            imgsz=<span class="number">640</span>,                      <span class="comment"># å›¾åƒå°ºå¯¸</span></span><br><span class="line">            device=<span class="string">&#x27;cpu&#x27;</span>,                   <span class="comment"># ï¼ï¼æŒ‡å®šä½¿ç”¨ CPU</span></span><br><span class="line">            workers=<span class="number">4</span>,                      <span class="comment"># æ•°æ®åŠ è½½è¿›ç¨‹æ•° (æ ¹æ®CPUæ ¸å¿ƒæ•°è°ƒæ•´)</span></span><br><span class="line">            <span class="comment"># å…¶ä»–å¯é€‰å‚æ•°:</span></span><br><span class="line">            <span class="comment"># project=&#x27;runs/train_cpu&#x27;,     # è‡ªå®šä¹‰ä¿å­˜ç»“æœçš„é¡¹ç›®å</span></span><br><span class="line">            <span class="comment"># name=&#x27;exp_cpu_run1&#x27;,          # è‡ªå®šä¹‰æœ¬æ¬¡è¿è¡Œçš„åç§°</span></span><br><span class="line">            <span class="comment"># patience=20,                  # æ—©åœè½®æ•° (å¦‚æœéªŒè¯é›†æŒ‡æ ‡åœ¨20è½®å†…æ²¡æœ‰æå‡åˆ™åœæ­¢)</span></span><br><span class="line">            <span class="comment"># lr0=0.01,                     # åˆå§‹å­¦ä¹ ç‡ (é€šå¸¸ç”¨é»˜è®¤å€¼)</span></span><br><span class="line">        )</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;è®­ç»ƒå®Œæˆï¼&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;ç»“æœä¿å­˜åœ¨: <span class="subst">&#123;results.save_dir&#125;</span>&quot;</span>) <span class="comment"># results å¯¹è±¡åœ¨ v8 ä¸­ä¸ç›´æ¥åŒ…å« save_dirï¼Œéœ€è¦ä» model æˆ– trainer è·å–ï¼Œæˆ–è€…ç›´æ¥æŸ¥æ‰¾ runs/train ç›®å½•</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;è®­ç»ƒè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç„¶åè¿è¡Œè„šæœ¬ï¼š<code>python train_cpu.py</code></p></li></ol><ul><li>GPUç‰ˆæœ¬</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">pip install ultralytics</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> torch <span class="comment"># Import torch to check CUDA availability first</span></span><br><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> YOLO</span><br><span class="line"><span class="keyword">import</span> os <span class="comment"># Import os for path joining if needed</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># --- Verify CUDA Availability ---</span></span><br><span class="line">    <span class="keyword">if</span> torch.cuda.is_available():</span><br><span class="line">        device_to_use = <span class="number">0</span> <span class="comment"># Use the first available GPU (index 0)</span></span><br><span class="line">        <span class="comment"># device_to_use = &#x27;cuda&#x27; # Alternative way to specify default GPU</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;CUDA is available! Training on GPU device: <span class="subst">&#123;torch.cuda.get_device_name(device_to_use)&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;é”™è¯¯ï¼šæœªæ£€æµ‹åˆ°å…¼å®¹çš„ NVIDIA GPU æˆ– CUDA é…ç½®ä¸æ­£ç¡®ã€‚&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;è¯·æ£€æŸ¥é©±åŠ¨ã€CUDA Toolkitã€cuDNN å’Œ GPU ç‰ˆæœ¬çš„ PyTorch æ˜¯å¦å·²æ­£ç¡®å®‰è£…ã€‚&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;å°†å°è¯•åœ¨ CPU ä¸Šè¿è¡Œï¼Œä½†è¿™ä¼šéå¸¸æ…¢...&quot;</span>)</span><br><span class="line">        device_to_use = <span class="string">&#x27;cpu&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- Configuration ---</span></span><br><span class="line">    <span class="comment"># ï¼ï¼ç¡®ä¿ data.yaml è·¯å¾„æ­£ç¡®ï¼ï¼ (ä½¿ç”¨ os.path.join æˆ– pathlib æ›´ä½³)</span></span><br><span class="line">    data_yaml_path = <span class="string">r&#x27;C:\Users\DELL\Desktop\test_data\test_data\data.yaml&#x27;</span></span><br><span class="line">    model_to_load = <span class="string">&#x27;yolov8x.pt&#x27;</span> <span class="comment"># Using the extra-large model</span></span><br><span class="line">    num_epochs = <span class="number">50</span>            <span class="comment"># Number of training epochs</span></span><br><span class="line">    batch_size = <span class="number">16</span>            <span class="comment"># !! Batch size for GPU (Adjust based on VRAM: 8, 16, 32, etc.)</span></span><br><span class="line">    image_size = <span class="number">640</span>           <span class="comment"># Input image size</span></span><br><span class="line">    num_workers = <span class="number">4</span>            <span class="comment"># Data loading workers (Adjust based on CPU cores)</span></span><br><span class="line">    project_name = <span class="string">&#x27;runs/train_gpu&#x27;</span> <span class="comment"># Directory to save results</span></span><br><span class="line">    run_name = <span class="string">&#x27;exp_gpu_yolov8x&#x27;</span>    <span class="comment"># Specific name for this run</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- Load Model ---</span></span><br><span class="line">    <span class="comment"># Model file will be downloaded automatically if not present locally</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Loading model: <span class="subst">&#123;model_to_load&#125;</span>&quot;</span>)</span><br><span class="line">    model = YOLO(model_to_load)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- Start Training ---</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;å¼€å§‹è®­ç»ƒ...&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  Data YAML: <span class="subst">&#123;data_yaml_path&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  Epochs: <span class="subst">&#123;num_epochs&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  Batch Size: <span class="subst">&#123;batch_size&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  Image Size: <span class="subst">&#123;image_size&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  Device: <span class="subst">&#123;device_to_use&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  Workers: <span class="subst">&#123;num_workers&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        results = model.train(</span><br><span class="line">            data=data_yaml_path,</span><br><span class="line">            epochs=num_epochs,</span><br><span class="line">            batch=batch_size,</span><br><span class="line">            imgsz=image_size,</span><br><span class="line">            device=device_to_use,   <span class="comment"># !! Use the determined device (e.g., 0 or &#x27;cpu&#x27;)</span></span><br><span class="line">            workers=num_workers,</span><br><span class="line">            project=project_name,   <span class="comment"># Specify project directory</span></span><br><span class="line">            name=run_name,          <span class="comment"># Specify run name</span></span><br><span class="line">            <span class="comment"># Other potentially useful optional parameters for GPU:</span></span><br><span class="line">            <span class="comment"># cache=True,           # Cache images in RAM/disk for faster loading (if RAM/disk allows)</span></span><br><span class="line">            <span class="comment"># patience=20,          # Early stopping patience</span></span><br><span class="line">            <span class="comment"># lr0=0.01,             # Initial learning rate</span></span><br><span class="line">            <span class="comment"># optimizer=&#x27;AdamW&#x27;,    # Optimizer (e.g., &#x27;AdamW&#x27;, &#x27;SGD&#x27;)</span></span><br><span class="line">            <span class="comment"># amp=True,             # Use Automatic Mixed Precision (can speed up training, reduce memory, requires compatible GPU)</span></span><br><span class="line">        )</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;è®­ç»ƒå®Œæˆï¼&quot;</span>)</span><br><span class="line">        <span class="comment"># Note: The &#x27;results&#x27; object itself might not directly contain the save path in all versions/contexts.</span></span><br><span class="line">        <span class="comment"># The results are reliably saved in the project/name directory.</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;è®­ç»ƒç»“æœå’Œæ¨¡å‹æƒé‡ä¿å­˜åœ¨: <span class="subst">&#123;os.path.join(project_name, run_name)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> torch.cuda.OutOfMemoryError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;é”™è¯¯ï¼šGPU æ˜¾å­˜ä¸è¶³ (Out of Memory)ï¼&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;å°è¯•å‡å°æ‰¹å¤„ç†å¤§å° (batch=<span class="subst">&#123;batch_size&#125;</span>)ã€‚ä¾‹å¦‚ï¼Œå°è¯• batch=8 æˆ– batch=4ã€‚&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;å¦‚æœæ˜¾å­˜ä»ç„¶ä¸è¶³ï¼Œå¯ä»¥è€ƒè™‘å‡å°å›¾åƒå°ºå¯¸ (imgsz) æˆ–ä½¿ç”¨æ›´å°çš„æ¨¡å‹ (å¦‚ yolov8l.pt, yolov8m.pt)ã€‚&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;é”™è¯¯ï¼šæ‰¾ä¸åˆ°æ–‡ä»¶æˆ–ç›®å½•: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;è¯·ä»”ç»†æ£€æŸ¥ data.yaml æ–‡ä»¶ä¸­çš„è·¯å¾„é…ç½®æ˜¯å¦æ­£ç¡®ï¼Œç‰¹åˆ«æ˜¯ &#x27;path&#x27;, &#x27;train&#x27;, &#x27;val&#x27; å­—æ®µã€‚&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;ç¡®ä¿ data.yaml æ–‡ä»¶æœ¬èº«ä½äº: <span class="subst">&#123;data_yaml_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;è®­ç»ƒè¿‡ç¨‹ä¸­å‘ç”Ÿæ„å¤–é”™è¯¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">import</span> traceback</span><br><span class="line">        traceback.print_exc() <span class="comment"># Print detailed traceback for debugging</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/2025/04/09/yolov8-train-model/train_model_cycle.png" class="lazyload placeholder" data-srcset="/2025/04/09/yolov8-train-model/train_model_cycle.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><p><strong>æ­¥éª¤ 6ï¼šç›‘æ§è®­ç»ƒå’Œè¯„ä¼°ç»“æœ</strong></p><ol><li><strong>è§‚å¯Ÿç»ˆç«¯è¾“å‡º:</strong> æŸ¥çœ‹æ¯ä¸ª epoch çš„è¿›åº¦ã€æŸå¤±å‡½æ•°å€¼ï¼ˆbox_loss, cls_loss, dfl_lossï¼‰æ˜¯å¦åœ¨ä¸‹é™ï¼Œä»¥åŠåœ¨éªŒè¯é›†ä¸Šçš„æŒ‡æ ‡ï¼ˆå¦‚ P, R, mAP50, mAP50-95ï¼‰æ˜¯å¦åœ¨æå‡ã€‚</li><li><strong>æŸ¥æ‰¾ç»“æœ:</strong> è®­ç»ƒè¿‡ç¨‹å’Œç»“æœé»˜è®¤ä¼šä¿å­˜åœ¨ <code>runs/train/exp&lt;N&gt;</code> ç›®å½•ä¸‹ï¼ˆä¾‹å¦‚ <code>runs/train/exp</code>, <code>runs/train/exp2</code> ç­‰ï¼‰ã€‚é‡Œé¢åŒ…å«ï¼š<ul><li><code>weights/</code>: ä¿å­˜çš„æ¨¡å‹æƒé‡æ–‡ä»¶ã€‚<code>best.pt</code> æ˜¯åŸºäºéªŒè¯é›†æŒ‡æ ‡æœ€ä½³çš„æ¨¡å‹ï¼Œ<code>last.pt</code> æ˜¯æœ€åä¸€ä¸ª epoch çš„æ¨¡å‹ã€‚<strong><code>best.pt</code> é€šå¸¸æ˜¯ä½ éœ€è¦çš„æ¨¡å‹ã€‚</strong></li><li>æ—¥å¿—æ–‡ä»¶ (TensorBoard logs)ã€‚</li><li>é…ç½®æ–‡ä»¶å‰¯æœ¬ã€‚</li><li>éªŒè¯ç»“æœå›¾è¡¨å’Œå›¾ç‰‡ï¼ˆä¾‹å¦‚ <code>confusion_matrix.png</code>, <code>results.png</code>, <code>val_batch0_pred.jpg</code> ç­‰ï¼‰ã€‚</li></ul></li><li><strong>éªŒè¯æ¨¡å‹:</strong> è®­ç»ƒå®Œæˆåï¼ˆæˆ–ä¸­é€”ï¼‰ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>best.pt</code> åœ¨éªŒè¯é›†ä¸Šè¿›è¡Œè¯„ä¼°ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yolo val model=runs/train/exp&lt;N&gt;/weights/best.pt data=/path/to/your/data.yaml device=cpu</span><br></pre></td></tr></table></figure></li></ol><p><strong>æ­¥éª¤ 7ï¼šä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹</strong></p><p>è®­ç»ƒå®Œæˆåï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>best.pt</code> æ–‡ä»¶è¿›è¡Œæ¨ç†ï¼ˆç›®æ ‡æ£€æµ‹ï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yolo predict model=runs/train/exp&lt;N&gt;/weights/best.pt <span class="built_in">source</span>=/path/to/image.jpg device=cpu</span><br><span class="line"><span class="comment"># æˆ–è€…å¯¹è§†é¢‘è¿›è¡Œæ¨ç† (CPUä¸Šä¼šå¾ˆæ…¢)</span></span><br><span class="line"><span class="comment"># yolo predict model=runs/train/exp&lt;N&gt;/weights/best.pt source=/path/to/video.mp4 device=cpu</span></span><br></pre></td></tr></table></figure><p>æˆ–è€…åœ¨ Python è„šæœ¬ä¸­ä½¿ç”¨ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> YOLO</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½ä½ è®­ç»ƒå¥½çš„æ¨¡å‹</span></span><br><span class="line">model = YOLO(<span class="string">&#x27;runs/train/exp&lt;N&gt;/weights/best.pt&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›è¡Œé¢„æµ‹</span></span><br><span class="line">results = model.predict(source=<span class="string">&#x27;/path/to/image.jpg&#x27;</span>, device=<span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤„ç†ç»“æœ (ä¾‹å¦‚ï¼Œç»˜åˆ¶è¾¹ç•Œæ¡†)</span></span><br><span class="line"><span class="keyword">for</span> r <span class="keyword">in</span> results:</span><br><span class="line">    boxes = r.boxes  <span class="comment"># Boxes object for bounding box outputs</span></span><br><span class="line">    masks = r.masks  <span class="comment"># Masks object for segmentation masks outputs</span></span><br><span class="line">    keypoints = r.keypoints  <span class="comment"># Keypoints object for pose outputs</span></span><br><span class="line">    probs = r.probs  <span class="comment"># Probs object for classification outputs</span></span><br><span class="line">    <span class="comment"># r.show()  # display to screen</span></span><br><span class="line">    r.save(filename=<span class="string">&#x27;result.jpg&#x27;</span>) <span class="comment"># save to disk</span></span><br></pre></td></tr></table></figure><p><strong>CPUè®­ç»ƒçš„å±€é™æ€§:</strong></p><ul><li><strong>é€Ÿåº¦ææ…¢:</strong></li><li><strong>å†…å­˜é™åˆ¶:</strong> å°å¿ƒ RAM è€—å°½ï¼Œç‰¹åˆ«æ˜¯ä½¿ç”¨è¾ƒå¤§çš„ <code>batch</code> æˆ– <code>imgsz</code> æ—¶ã€‚</li><li><strong>å¯è¡Œæ€§:</strong> å¯¹äºéå¸¸å¤§çš„æ•°æ®é›†æˆ–éœ€è¦é«˜ç²¾åº¦ï¼ˆéœ€è¦è®­ç»ƒæ›´é•¿æ—¶é—´æˆ–æ›´å¤§æ¨¡å‹ï¼‰çš„ä»»åŠ¡ï¼ŒCPU è®­ç»ƒå¯èƒ½å®é™…ä¸Šä¸å¯è¡Œã€‚è€ƒè™‘ä½¿ç”¨ Google Colabï¼ˆæä¾›å…è´¹ GPUï¼‰ã€Kaggle Kernels æˆ–å…¶ä»–äº‘ GPU æœåŠ¡å¯èƒ½æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚</li></ul><h2 id="éªŒè¯æ•°æ®é›†è·å–">éªŒè¯æ•°æ®é›†è·å–</h2><blockquote><p>è·å–éªŒè¯æ•°æ®é›†ï¼ˆValidation Setï¼‰æ˜¯è®­ç»ƒè¿‡ç¨‹ä¸­éå¸¸é‡è¦çš„ä¸€æ­¥ï¼Œç”¨äºè¯„ä¼°æ¨¡å‹åœ¨æœªè§è¿‡æ•°æ®ä¸Šçš„è¡¨ç°å¹¶è°ƒæ•´è¶…å‚æ•°ã€‚å½“ä½ çš„æ•°æ®æ¥è‡ª CVAT å¹¶å¯¼å‡ºäº† YOLO æ ¼å¼æ—¶ï¼Œæœ‰ä»¥ä¸‹å‡ ç§ä¸»è¦æ–¹æ³•æ¥è·å–æˆ–æŒ‡å®šéªŒè¯æ•°æ®é›†ï¼š</p></blockquote><p><strong>æ–¹æ³•ä¸€ï¼šåœ¨ CVAT ä¸­åˆ’åˆ†å¹¶å¯¼å‡º (æ¨è)</strong></p><p>è¿™æ˜¯æœ€æ–¹ä¾¿ã€æœ€ä¸å®¹æ˜“å‡ºé”™çš„æ–¹æ³•ï¼Œæ¨èä¼˜å…ˆè€ƒè™‘ã€‚</p><ol><li><strong>åœ¨ CVAT ä¸­åˆ†é…å­é›† (Subset):</strong><ul><li>åœ¨ä½  CVAT çš„ä»»åŠ¡ (Task) ä¸­ï¼Œä½ å¯ä»¥å°†æ ‡æ³¨å¥½çš„æ•°æ®å¸§æˆ–å›¾ç‰‡åˆ†é…åˆ°ä¸åŒçš„å­é›†ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰æ•°æ®éƒ½åœ¨ <code>Default</code> æˆ– <code>Train</code> å­é›†ä¸­ã€‚</li><li>è¿›å…¥ä½ çš„ä»»åŠ¡ï¼Œé€‰æ‹©ä¸€äº›å¸§æˆ–å›¾ç‰‡ï¼ˆä¾‹å¦‚ï¼Œéšæœºé€‰æ‹©æ€»æ•°æ®çš„ 10-20%ï¼‰ã€‚</li><li>ç‚¹å‡» â€œActionsâ€ -&gt; â€œChange subsetâ€ã€‚</li><li>åœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­ï¼Œé€‰æ‹© <code>Validation</code> ä½œä¸ºç›®æ ‡å­é›†ï¼Œç„¶åç¡®è®¤ã€‚</li><li>è¿™æ ·ä½ å°±å‘Šè¯‰ CVATï¼Œè¿™äº›é€‰ä¸­çš„æ•°æ®å±äºéªŒè¯é›†ã€‚ä½ ä¹Ÿå¯ä»¥åŒæ ·åœ°åˆ†é… <code>Test</code> å­é›†ï¼ˆå¦‚æœéœ€è¦ï¼‰ã€‚</li></ul></li><li><strong>å¯¼å‡ºæ—¶åŒ…å«å­é›†:</strong><ul><li>åœ¨ä½ å¯¼å‡ºä»»åŠ¡æ•°æ®é›†æ—¶ï¼Œé€‰æ‹© <code>YOLO</code> æˆ– <code>YOLO ZIP</code> æ ¼å¼ã€‚</li><li><strong>å…³é”®:</strong> åœ¨å¯¼å‡ºé€‰é¡¹ä¸­ï¼Œç¡®ä¿ä½ é€‰æ‹©äº†å¯¼å‡ºæ‰€æœ‰å­é›†ï¼Œæˆ–è€…è¯¥æ ¼å¼é»˜è®¤å°±ä¼šå°†ä¸åŒçš„å­é›†åˆ†å¼€å¯¼å‡ºã€‚ä¾‹å¦‚ï¼Œ<code>YOLO ZIP</code> æ ¼å¼é€šå¸¸ä¼šè‡ªåŠ¨åˆ›å»º <code>train/</code>, <code>valid/</code>, <code>test/</code> è¿™æ ·çš„å­ç›®å½•ç»“æ„ã€‚</li></ul></li><li><strong>æ£€æŸ¥å¯¼å‡ºçš„æ–‡ä»¶:</strong><ul><li>è§£å‹ä¸‹è½½çš„ ZIP æ–‡ä»¶ã€‚</li><li>æ£€æŸ¥é‡Œé¢æ˜¯å¦å·²ç»åŒ…å«äº†ç±»ä¼¼ <code>train/</code> å’Œ <code>valid/</code> (æˆ– <code>val/</code>) çš„æ–‡ä»¶å¤¹ï¼Œæ¯ä¸ªæ–‡ä»¶å¤¹ä¸‹åˆåˆ†åˆ«æœ‰ <code>images/</code> å’Œ <code>labels/</code> å­ç›®å½•ã€‚</li><li>åŒæ—¶æ£€æŸ¥ <code>data.yaml</code> æ–‡ä»¶ï¼Œå®ƒåº”è¯¥å·²ç»è‡ªåŠ¨é…ç½®å¥½äº† <code>train:</code> å’Œ <code>val:</code> æŒ‡å‘è¿™äº›å¯¹åº”çš„æ–‡ä»¶å¤¹ï¼ˆä¾‹å¦‚ <code>train: train/images</code>, <code>val: valid/images</code>ï¼‰ã€‚</li><li>å¦‚æœå¯¼å‡ºæ–‡ä»¶å·²ç»æ˜¯è¿™ç§ç»“æ„ï¼Œé‚£ä¹ˆä½ <strong>ä¸éœ€è¦</strong>å†åšä»»ä½•äº‹æƒ…ï¼Œç›´æ¥ä½¿ç”¨è¿™ä¸ª <code>data.yaml</code> æ–‡ä»¶è¿›è¡Œè®­ç»ƒå³å¯ã€‚</li></ul></li></ol><p><strong>æ–¹æ³•äºŒï¼šæ‰‹åŠ¨åˆ’åˆ†å·²å¯¼å‡ºçš„æ•°æ®é›†</strong></p><p>å¦‚æœä½ ä» CVAT å¯¼å‡ºæ—¶æ²¡æœ‰åˆ’åˆ†å°å­é›†ï¼Œæˆ–è€…å¯¼å‡ºçš„æ ¼å¼æ²¡æœ‰è‡ªåŠ¨åŒºåˆ†ï¼Œé‚£ä¹ˆä½ åªæœ‰ä¸€ä¸ªåŒ…å«æ‰€æœ‰å›¾åƒå’Œæ ‡ç­¾çš„é›†åˆã€‚ä½ éœ€è¦æ‰‹åŠ¨å°†å…¶åˆ’åˆ†ä¸ºè®­ç»ƒé›†å’ŒéªŒè¯é›†ã€‚</p><ol><li><strong>ç¡®å®šåˆ’åˆ†æ¯”ä¾‹:</strong> æ ¹æ®ä½ çš„æ€»æ•°æ®é‡ï¼Œå†³å®šä¸€ä¸ªåˆé€‚çš„åˆ’åˆ†æ¯”ä¾‹ã€‚å¸¸è§çš„æ¯”ä¾‹æ˜¯ 80% è®­ç»ƒ / 20% éªŒè¯ï¼Œæˆ–è€… 70% / 30%ã€‚å¦‚æœæ•°æ®é‡å¾ˆå¤§ï¼ŒéªŒè¯é›†æ¯”ä¾‹å¯ä»¥é€‚å½“é™ä½ã€‚</li><li><strong>åˆ›å»ºç›®å½•ç»“æ„:</strong> åœ¨ä½ çš„æ•°æ®é›†æ ¹ç›®å½•ä¸‹ï¼ˆä¾‹å¦‚ <code>/home/user/my_dataset</code>ï¼‰ï¼Œåˆ›å»ºå¦‚ä¸‹ç»“æ„ï¼š<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">my_dataset/</span><br><span class="line">â”œâ”€â”€ train/</span><br><span class="line">â”‚   â”œâ”€â”€ images/</span><br><span class="line">â”‚   â””â”€â”€ labels/</span><br><span class="line">â”œâ”€â”€ valid/</span><br><span class="line">â”‚   â”œâ”€â”€ images/</span><br><span class="line">â”‚   â””â”€â”€ labels/</span><br><span class="line">â””â”€â”€ data.yaml  # ä½ éœ€è¦åˆ›å»ºæˆ–ä¿®æ”¹çš„æ–‡ä»¶</span><br></pre></td></tr></table></figure>ï¼ˆå¯èƒ½è¿˜éœ€è¦ä¿ç•™åŸå§‹çš„ <code>images/</code> å’Œ <code>labels/</code> æ–‡ä»¶å¤¹ï¼Œæˆ–è€…ç›´æ¥ä»é‚£é‡Œç§»åŠ¨æ–‡ä»¶ï¼‰ã€‚</li><li><strong>ç¼–å†™è„šæœ¬æˆ–æ‰‹åŠ¨ç§»åŠ¨æ–‡ä»¶ (æ¨èè„šæœ¬):</strong><ul><li><strong>æ ¸å¿ƒåŸåˆ™:</strong> å¿…é¡»ä¿è¯<strong>åŒä¸€å¼ å›¾ç‰‡</strong> (<code>.jpg</code>, <code>.png</code> ç­‰) å’Œå…¶<strong>å¯¹åº”çš„æ ‡æ³¨æ–‡ä»¶</strong> (<code>.txt</code>) <strong>å§‹ç»ˆè¢«åˆ’åˆ†åˆ°åŒä¸€ä¸ªé›†åˆ</strong> (è¦ä¹ˆéƒ½åœ¨ <code>train</code>ï¼Œè¦ä¹ˆéƒ½åœ¨ <code>valid</code>)ã€‚æ–‡ä»¶åé€šå¸¸æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼ˆé™¤äº†æ‰©å±•åï¼‰ã€‚</li><li><strong>è„šæœ¬æ–¹æ³• (Python ç¤ºä¾‹):</strong></li></ul></li></ol><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">import</span> yaml  <span class="comment"># éœ€è¦å®‰è£… PyYAML: pip install pyyaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- é…ç½® ---</span></span><br><span class="line"><span class="comment"># ï¼ï¼ä¿®æ”¹è¿™é‡Œä¸ºä½ è§£å‹åçš„ CVAT å¯¼å‡ºæ•°æ®é›†çš„æ ¹ç›®å½•ï¼ï¼</span></span><br><span class="line"><span class="comment"># ä½¿ç”¨ Path å¯¹è±¡å¤„ç†è·¯å¾„</span></span><br><span class="line">dataset_root = Path(<span class="string">r&#x27;/Users/zg/Downloads/task_13&#x27;</span>).resolve() <span class="comment"># &lt;&lt;--- ä¿®æ”¹è¿™é‡Œï¼Œå¹¶ç¡®ä¿æ˜¯ç»å¯¹è·¯å¾„</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ï¼ï¼æŒ‡å®šä½ æƒ³è¦åˆ›å»ºçš„æ–°æ•°æ®é›†æ ¹ç›®å½•ï¼ˆå¦‚æœæƒ³åˆ†å¼€å­˜æ”¾ï¼‰ï¼ï¼</span></span><br><span class="line"><span class="comment"># å¦‚æœè®¾ä¸º Noneï¼Œåˆ™åœ¨åŸ dataset_root ä¸‹åˆ›å»º train/valid ç›®å½•</span></span><br><span class="line"><span class="comment"># ä½¿ç”¨ Path å¯¹è±¡å¤„ç†è·¯å¾„</span></span><br><span class="line">output_root = dataset_root <span class="comment"># &lt;&lt;--- å¯ä»¥ä¿®æ”¹ä¸ºæ–°çš„è·¯å¾„ï¼Œä¾‹å¦‚ Path(&#x27;./yolov8_dataset&#x27;).resolve()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ Path å¯¹è±¡å®šä¹‰æºè·¯å¾„</span></span><br><span class="line">source_data_dir = dataset_root / <span class="string">&#x27;obj_train_data&#x27;</span> <span class="comment"># åŒ…å«å›¾åƒå’Œæ ‡ç­¾çš„æºæ–‡ä»¶å¤¹</span></span><br><span class="line">obj_names_file = dataset_root / <span class="string">&#x27;obj.names&#x27;</span>       <span class="comment"># ç±»åˆ«åç§°æ–‡ä»¶</span></span><br><span class="line">train_txt_file = dataset_root / <span class="string">&#x27;train.txt&#x27;</span>       <span class="comment"># åŸå§‹å›¾åƒåˆ—è¡¨æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line">train_ratio = <span class="number">0.8</span>  <span class="comment"># è®­ç»ƒé›†æ¯”ä¾‹ (ä¾‹å¦‚ 0.8 è¡¨ç¤º 80%)</span></span><br><span class="line">random_seed = <span class="number">42</span>   <span class="comment"># è®¾ç½®éšæœºç§å­ä»¥ä¿è¯æ¯æ¬¡åˆ’åˆ†ç»“æœä¸€è‡´ (å¯é€‰)</span></span><br><span class="line"><span class="comment"># ------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®éšæœºç§å­</span></span><br><span class="line"><span class="keyword">if</span> random_seed:</span><br><span class="line">    random.seed(random_seed)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- æ£€æŸ¥è¾“å…¥æ–‡ä»¶/ç›®å½•æ˜¯å¦å­˜åœ¨ ---</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> dataset_root.is_dir():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;é”™è¯¯ï¼šæ•°æ®é›†æ ¹ç›®å½•ä¸å­˜åœ¨: <span class="subst">&#123;dataset_root&#125;</span>&quot;</span>)</span><br><span class="line">    exit()</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> source_data_dir.is_dir():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;é”™è¯¯ï¼šæºæ•°æ®ç›®å½•ä¸å­˜åœ¨: <span class="subst">&#123;source_data_dir&#125;</span>&quot;</span>)</span><br><span class="line">    exit()</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> obj_names_file.is_file():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;é”™è¯¯ï¼šç±»åˆ«æ–‡ä»¶ä¸å­˜åœ¨: <span class="subst">&#123;obj_names_file&#125;</span>&quot;</span>)</span><br><span class="line">    exit()</span><br><span class="line"></span><br><span class="line">image_paths_from_txt = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> train_txt_file.is_file():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;è­¦å‘Šï¼šåŸå§‹ train.txt æ–‡ä»¶ä¸å­˜åœ¨: <span class="subst">&#123;train_txt_file&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;å°†å°è¯•ç›´æ¥æ‰«ææºæ•°æ®ç›®å½•ä¸­çš„å›¾åƒæ–‡ä»¶...&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># --- ä» train.txt è¯»å–å›¾åƒè·¯å¾„ ---</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;æ­£åœ¨ä» <span class="subst">&#123;train_txt_file&#125;</span> è¯»å–å›¾åƒè·¯å¾„...&quot;</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(train_txt_file, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="comment"># è¯»å–åŸå§‹è·¯å¾„è¡Œ</span></span><br><span class="line">            raw_paths = [line.strip() <span class="keyword">for</span> line <span class="keyword">in</span> f <span class="keyword">if</span> line.strip()]</span><br><span class="line"></span><br><span class="line">        image_paths_from_txt = []</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;æ­£åœ¨éªŒè¯ train.txt ä¸­çš„å›¾åƒè·¯å¾„...&quot;</span>)</span><br><span class="line">        processed_raw_paths_count = <span class="number">0</span> <span class="comment"># è®¡æ•°å™¨</span></span><br><span class="line">        <span class="keyword">for</span> raw_path <span class="keyword">in</span> raw_paths:</span><br><span class="line">            processed_raw_paths_count += <span class="number">1</span></span><br><span class="line">            <span class="comment"># --- ä¿®å¤é€»è¾‘å¼€å§‹ ---</span></span><br><span class="line">            <span class="comment"># 1. æå–æ–‡ä»¶å (ä¾‹å¦‚ &#x27;frame_000000.png&#x27;)</span></span><br><span class="line">            filename = Path(raw_path).name</span><br><span class="line">            <span class="comment"># 2. æ„å»ºé¢„æœŸåº”è¯¥å­˜åœ¨çš„è·¯å¾„ (åœ¨å·²çŸ¥çš„ source_data_dir ä¸‹)</span></span><br><span class="line">            <span class="comment">#    ä½¿ç”¨ resolve() ç¡®ä¿æ˜¯ç»å¯¹è·¯å¾„</span></span><br><span class="line">            expected_path = (source_data_dir / filename).resolve()</span><br><span class="line">            <span class="comment"># --- ä¿®å¤é€»è¾‘ç»“æŸ ---</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 3. éªŒè¯è¿™ä¸ªæ„å»ºå‡ºçš„é¢„æœŸè·¯å¾„æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">            <span class="keyword">if</span> expected_path.is_file():</span><br><span class="line">                image_paths_from_txt.append(expected_path) <span class="comment"># æ·»åŠ  *æ­£ç¡®ä¸”å­˜åœ¨çš„* è·¯å¾„</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># æ‰“å°æ›´å…·ä½“çš„è­¦å‘Šï¼Œæ˜¾ç¤ºåŸå§‹è¡Œå’Œå°è¯•æŸ¥æ‰¾çš„ä½ç½®</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;è­¦å‘Šï¼šåœ¨ <span class="subst">&#123;source_data_dir&#125;</span> ä¸­æ‰¾ä¸åˆ° train.txt è¡Œ &#x27;<span class="subst">&#123;raw_path&#125;</span>&#x27; å¯¹åº”çš„æ–‡ä»¶ &#x27;<span class="subst">&#123;filename&#125;</span>&#x27; (é¢„æœŸè·¯å¾„: <span class="subst">&#123;expected_path&#125;</span>)ï¼Œå°†è·³è¿‡ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;ä» <span class="subst">&#123;train_txt_file&#125;</span> åŸå§‹è¯»å– <span class="subst">&#123;<span class="built_in">len</span>(raw_paths)&#125;</span> è¡Œã€‚&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> image_paths_from_txt:</span><br><span class="line">             <span class="comment"># å¦‚æœä¿®æ­£åä»ç„¶æ²¡æœ‰æœ‰æ•ˆè·¯å¾„ï¼Œåˆ™è§¦å‘åå¤‡æ‰«æ</span></span><br><span class="line">             <span class="keyword">raise</span> ValueError(<span class="string">&quot;train.txt æ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœ‰æ•ˆä¸”å­˜åœ¨çš„å›¾åƒæ–‡ä»¶ã€‚&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;éªŒè¯åï¼Œæœ‰æ•ˆå›¾åƒè·¯å¾„æ•°é‡: <span class="subst">&#123;<span class="built_in">len</span>(image_paths_from_txt)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;å¤„ç† train.txt æ—¶å‡ºé”™: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;å°†å°è¯•ç›´æ¥æ‰«ææºæ•°æ®ç›®å½•ä¸­çš„å›¾åƒæ–‡ä»¶...&quot;</span>)</span><br><span class="line">        image_paths_from_txt = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- å¦‚æœæ— æ³•ä» train.txt è¯»å–æˆ–éªŒè¯å¤±è´¥ï¼Œåˆ™æ‰«æç›®å½• ---</span></span><br><span class="line"><span class="keyword">if</span> image_paths_from_txt <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;æ­£åœ¨æ‰«æç›®å½• <span class="subst">&#123;source_data_dir&#125;</span> ä¸­çš„å›¾åƒæ–‡ä»¶...&quot;</span>)</span><br><span class="line">    <span class="comment"># ç›´æ¥ä½¿ç”¨ source_data_dir (å·²ç»æ˜¯ Path å¯¹è±¡)</span></span><br><span class="line">    image_paths_from_dir = <span class="built_in">list</span>(source_data_dir.glob(<span class="string">&#x27;*.jpg&#x27;</span>)) + \</span><br><span class="line">                           <span class="built_in">list</span>(source_data_dir.glob(<span class="string">&#x27;*.png&#x27;</span>)) + \</span><br><span class="line">                           <span class="built_in">list</span>(source_data_dir.glob(<span class="string">&#x27;*.jpeg&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> image_paths_from_dir:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;é”™è¯¯ï¼šåœ¨ <span class="subst">&#123;source_data_dir&#125;</span> ä¸­æœªæ‰¾åˆ°ä»»ä½•å›¾åƒæ–‡ä»¶ã€‚&quot;</span>)</span><br><span class="line">        exit()</span><br><span class="line">    <span class="comment"># ç¡®ä¿è·¯å¾„æ˜¯ç»å¯¹è·¯å¾„</span></span><br><span class="line">    image_paths = [p.resolve() <span class="keyword">for</span> p <span class="keyword">in</span> image_paths_from_dir]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;åœ¨ç›®å½•ä¸­æ‰¾åˆ° <span class="subst">&#123;<span class="built_in">len</span>(image_paths)&#125;</span> ä¸ªå›¾åƒæ–‡ä»¶ã€‚&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># å¦‚æœä» train.txt æˆåŠŸè¯»å–å¹¶éªŒè¯äº†è·¯å¾„ï¼Œåˆ™ä½¿ç”¨è¿™ä¸ªåˆ—è¡¨</span></span><br><span class="line">    image_paths = image_paths_from_txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨ç»§ç»­ä¹‹å‰ï¼Œæœ€ç»ˆæ£€æŸ¥ image_paths æ˜¯å¦ä¸ºç©º</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> image_paths:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;é”™è¯¯ï¼šæœªèƒ½æ”¶é›†åˆ°ä»»ä½•æœ‰æ•ˆçš„å›¾åƒè·¯å¾„æ¥ç»§ç»­å¤„ç†ã€‚&quot;</span>)</span><br><span class="line">    exit()</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- è¯»å–ç±»åˆ«åç§° ---</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(obj_names_file, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        class_names = [line.strip() <span class="keyword">for</span> line <span class="keyword">in</span> f <span class="keyword">if</span> line.strip()]</span><br><span class="line">    num_classes = <span class="built_in">len</span>(class_names)</span><br><span class="line">    <span class="keyword">if</span> num_classes == <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;é”™è¯¯ï¼šç±»åˆ«æ–‡ä»¶ <span class="subst">&#123;obj_names_file&#125;</span> ä¸ºç©ºã€‚&quot;</span>)</span><br><span class="line">        exit()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;è¯»å–åˆ° <span class="subst">&#123;num_classes&#125;</span> ä¸ªç±»åˆ«: <span class="subst">&#123;class_names&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;è¯»å–ç±»åˆ«æ–‡ä»¶ <span class="subst">&#123;obj_names_file&#125;</span> æ—¶å‡ºé”™: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    exit()</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- åˆ›å»ºè¾“å‡ºç›®å½• ---</span></span><br><span class="line"><span class="comment"># ç¡®ä¿ output_root æ˜¯ Path å¯¹è±¡</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(output_root, Path):</span><br><span class="line">    output_root = Path(output_root).resolve()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ Path å¯¹è±¡å®šä¹‰ç›®æ ‡ç›®å½•</span></span><br><span class="line">train_img_dir = output_root / <span class="string">&#x27;train&#x27;</span> / <span class="string">&#x27;images&#x27;</span></span><br><span class="line">train_lbl_dir = output_root / <span class="string">&#x27;train&#x27;</span> / <span class="string">&#x27;labels&#x27;</span></span><br><span class="line">valid_img_dir = output_root / <span class="string">&#x27;valid&#x27;</span> / <span class="string">&#x27;images&#x27;</span></span><br><span class="line">valid_lbl_dir = output_root / <span class="string">&#x27;valid&#x27;</span> / <span class="string">&#x27;labels&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># exist_ok=True é¿å…ç›®å½•å·²å­˜åœ¨æ—¶æŠ¥é”™</span></span><br><span class="line">train_img_dir.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">train_lbl_dir.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">valid_img_dir.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">valid_lbl_dir.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- åˆ’åˆ†æ•°æ®é›† ---</span></span><br><span class="line"><span class="comment"># æ‰“ä¹±å›¾åƒè·¯å¾„åˆ—è¡¨ (Path å¯¹è±¡åˆ—è¡¨)</span></span><br><span class="line">random.shuffle(image_paths)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¡ç®—è®­ç»ƒé›†å’ŒéªŒè¯é›†çš„åˆ†å‰²ç‚¹</span></span><br><span class="line">split_index = <span class="built_in">int</span>(<span class="built_in">len</span>(image_paths) * train_ratio)</span><br><span class="line">train_image_paths = image_paths[:split_index]</span><br><span class="line">valid_image_paths = image_paths[split_index:]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;æ€»æœ‰æ•ˆå›¾åƒæ•°: <span class="subst">&#123;<span class="built_in">len</span>(image_paths)&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;åˆ’åˆ†åè®­ç»ƒé›†å›¾åƒæ•°: <span class="subst">&#123;<span class="built_in">len</span>(train_image_paths)&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;åˆ’åˆ†åéªŒè¯é›†å›¾åƒæ•°: <span class="subst">&#123;<span class="built_in">len</span>(valid_image_paths)&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- å¤åˆ¶æˆ–ç§»åŠ¨æ–‡ä»¶å‡½æ•° ---</span></span><br><span class="line"><span class="comment"># copy_mode=True å¤åˆ¶æ–‡ä»¶, copy_mode=False ç§»åŠ¨æ–‡ä»¶</span></span><br><span class="line">copy_mode = <span class="literal">True</span> <span class="comment"># å»ºè®®ä½¿ç”¨å¤åˆ¶ä»¥ä¿ç•™åŸå§‹æ•°æ®</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_files</span>(<span class="params">source_img_paths, target_img_dir, target_lbl_dir, copy=<span class="literal">True</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å°†æºå›¾åƒå’Œå¯¹åº”çš„æ ‡ç­¾æ–‡ä»¶å¤åˆ¶æˆ–ç§»åŠ¨åˆ°ç›®æ ‡ç›®å½•&quot;&quot;&quot;</span></span><br><span class="line">    processed_count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> img_path <span class="keyword">in</span> source_img_paths: <span class="comment"># img_path æ˜¯ Path å¯¹è±¡</span></span><br><span class="line">        <span class="comment"># æ„å»ºå¯¹åº”çš„æ ‡ç­¾æ–‡ä»¶è·¯å¾„ (.txt)ï¼Œæ ‡ç­¾æ–‡ä»¶åœ¨æºç›®å½• source_data_dir ä¸‹</span></span><br><span class="line">        <span class="comment"># ä½¿ç”¨ img_path.stem è·å–ä¸å¸¦æ‰©å±•åçš„æ–‡ä»¶å</span></span><br><span class="line">        lbl_path = source_data_dir / (img_path.stem + <span class="string">&#x27;.txt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ£€æŸ¥å›¾åƒå’Œæ ‡ç­¾æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="comment"># å›¾åƒè·¯å¾„ img_path å·²ç»éªŒè¯è¿‡å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> lbl_path.is_file():</span><br><span class="line">            <span class="comment"># ç›®æ ‡è·¯å¾„</span></span><br><span class="line">            target_img_path = target_img_dir / img_path.name</span><br><span class="line">            target_lbl_path = target_lbl_dir / lbl_path.name</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> copy:</span><br><span class="line">                    shutil.copy2(<span class="built_in">str</span>(img_path), <span class="built_in">str</span>(target_img_path)) <span class="comment"># copy2 æ¥æ”¶å­—ç¬¦ä¸²è·¯å¾„</span></span><br><span class="line">                    shutil.copy2(<span class="built_in">str</span>(lbl_path), <span class="built_in">str</span>(target_lbl_path))</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    shutil.move(<span class="built_in">str</span>(img_path), <span class="built_in">str</span>(target_img_path)) <span class="comment"># move æ¥æ”¶å­—ç¬¦ä¸²è·¯å¾„</span></span><br><span class="line">                    shutil.move(<span class="built_in">str</span>(lbl_path), <span class="built_in">str</span>(target_lbl_path))</span><br><span class="line">                processed_count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;å¤„ç†æ–‡ä»¶ <span class="subst">&#123;img_path.name&#125;</span> æ—¶å‡ºé”™: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># å›¾åƒæ–‡ä»¶åº”è¯¥å­˜åœ¨ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯ä»éªŒè¯è¿‡çš„åˆ—è¡¨å¤„ç†çš„</span></span><br><span class="line">            <span class="comment"># if not img_path.is_file():</span></span><br><span class="line">            <span class="comment">#      print(f&quot;è­¦å‘Šï¼šæ‰¾ä¸åˆ°å›¾åƒæ–‡ä»¶ &#123;img_path&#125;ï¼Œè·³è¿‡ã€‚&quot;)</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;è­¦å‘Šï¼šæ‰¾ä¸åˆ°å¯¹åº”çš„æ ‡ç­¾æ–‡ä»¶ <span class="subst">&#123;lbl_path&#125;</span>ï¼Œè·³è¿‡å›¾åƒ <span class="subst">&#123;img_path.name&#125;</span>ã€‚&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> processed_count</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- æ‰§è¡Œæ–‡ä»¶å¤„ç† ---</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;æ­£åœ¨<span class="subst">&#123;<span class="string">&#x27;å¤åˆ¶&#x27;</span> <span class="keyword">if</span> copy_mode <span class="keyword">else</span> <span class="string">&#x27;ç§»åŠ¨&#x27;</span>&#125;</span>è®­ç»ƒé›†æ–‡ä»¶...&quot;</span>)</span><br><span class="line">train_processed = process_files(train_image_paths, train_img_dir, train_lbl_dir, copy=copy_mode)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;æˆåŠŸå¤„ç† <span class="subst">&#123;train_processed&#125;</span> ä¸ªè®­ç»ƒé›†æ–‡ä»¶å¯¹ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;æ­£åœ¨<span class="subst">&#123;<span class="string">&#x27;å¤åˆ¶&#x27;</span> <span class="keyword">if</span> copy_mode <span class="keyword">else</span> <span class="string">&#x27;ç§»åŠ¨&#x27;</span>&#125;</span>éªŒè¯é›†æ–‡ä»¶...&quot;</span>)</span><br><span class="line">valid_processed = process_files(valid_image_paths, valid_img_dir, valid_lbl_dir, copy=copy_mode)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;æˆåŠŸå¤„ç† <span class="subst">&#123;valid_processed&#125;</span> ä¸ªéªŒè¯é›†æ–‡ä»¶å¯¹ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- ç”Ÿæˆ data.yaml æ–‡ä»¶ ---</span></span><br><span class="line">yaml_path = output_root / <span class="string">&#x27;data.yaml&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç›¸å¯¹äº output_root çš„è·¯å¾„</span></span><br><span class="line">yaml_data = &#123;</span><br><span class="line">    <span class="comment"># ä½¿ç”¨ resolve() è·å–ç»å¯¹è·¯å¾„å­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="string">&#x27;path&#x27;</span>: <span class="built_in">str</span>(output_root.resolve()),</span><br><span class="line">    <span class="comment"># ç›¸å¯¹è·¯å¾„æŒ‡å‘æ–°åˆ›å»ºçš„ç›®å½•</span></span><br><span class="line">    <span class="string">&#x27;train&#x27;</span>: <span class="string">&#x27;train/images&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;val&#x27;</span>: <span class="string">&#x27;valid/images&#x27;</span>,</span><br><span class="line">    <span class="comment"># &#x27;test&#x27;: &#x27;test/images&#x27;, # å¦‚æœæœ‰æµ‹è¯•é›†</span></span><br><span class="line">    <span class="string">&#x27;nc&#x27;</span>: num_classes,</span><br><span class="line">    <span class="string">&#x27;names&#x27;</span>: class_names</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(yaml_path, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        yaml.dump(yaml_data, f, sort_keys=<span class="literal">False</span>, default_flow_style=<span class="literal">False</span>) <span class="comment"># default_flow_style=False æ›´å¥½çœ‹</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;data.yaml æ–‡ä»¶å·²ç”Ÿæˆ: <span class="subst">&#123;yaml_path&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;å†…å®¹:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(yaml.dump(yaml_data, sort_keys=<span class="literal">False</span>, default_flow_style=<span class="literal">False</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;æ•°æ®é›†åˆ’åˆ†å®Œæˆï¼&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;ç”Ÿæˆ data.yaml æ–‡ä»¶æ—¶å‡ºé”™: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br></pre></td></tr></table></figure><ul><li><p>ä½ éœ€è¦æ ¹æ®ä½ çš„å®é™…æƒ…å†µä¿®æ”¹ <code>dataset_root</code>, <code>source_images_dir</code>, <code>source_labels_dir</code> å’Œ <code>train_ratio</code>ã€‚</p></li><li><p>è¿™ä¸ªè„šæœ¬ä¼šå°†æ–‡ä»¶<strong>ç§»åŠ¨</strong>åˆ°æ–°ç›®å½•ã€‚å¦‚æœä½ æƒ³ä¿ç•™åŸå§‹æ–‡ä»¶ï¼Œå¯ä»¥å°† <code>shutil.move</code> æ”¹ä¸º <code>shutil.copy</code>ã€‚</p></li><li><p><strong>æ‰‹åŠ¨æ–¹æ³• (ä»…é€‚ç”¨äºå°‘é‡æ•°æ®):</strong> åˆ›å»º <code>train</code> å’Œ <code>valid</code> å­ç›®å½•ï¼Œç„¶åæ‰‹åŠ¨å°†å›¾åƒå’Œå¯¹åº”çš„ <code>.txt</code> æ–‡ä»¶æ‹–æ‹½åˆ°ç›¸åº”çš„ <code>images</code> å’Œ <code>labels</code> æ–‡ä»¶å¤¹ä¸­ï¼Œç¡®ä¿æ¯”ä¾‹å¤§è‡´æ­£ç¡®ä¸”é…å¯¹æ— è¯¯ã€‚éå¸¸å®¹æ˜“å‡ºé”™ã€‚</p></li></ul><ol start="4"><li><strong>ä¿®æ”¹/åˆ›å»º <code>data.yaml</code> æ–‡ä»¶:</strong><ul><li>åœ¨ä½ æ‰‹åŠ¨åˆ›å»ºäº† <code>train/</code> å’Œ <code>valid/</code> ç›®å½•ç»“æ„åï¼Œä½ éœ€è¦åƒä¸‹é¢è¿™æ ·é…ç½® <code>data.yaml</code>ï¼š<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">path:</span> <span class="string">/home/user/my_dataset</span>   <span class="comment"># æ•°æ®é›†æ ¹ç›®å½•</span></span><br><span class="line"><span class="attr">train:</span> <span class="string">train/images</span>          <span class="comment"># æŒ‡å‘è®­ç»ƒå›¾åƒæ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="attr">val:</span> <span class="string">valid/images</span>            <span class="comment"># æŒ‡å‘éªŒè¯å›¾åƒæ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="comment"># test: test/images          # å¦‚æœæœ‰æµ‹è¯•é›†</span></span><br><span class="line"></span><br><span class="line"><span class="attr">nc:</span> <span class="number">3</span>                        <span class="comment"># ä½ çš„ç±»åˆ«æ•°é‡</span></span><br><span class="line"><span class="attr">names:</span> [<span class="string">&#x27;car&#x27;</span>, <span class="string">&#x27;person&#x27;</span>, <span class="string">&#x27;truck&#x27;</span>] <span class="comment"># ä½ çš„ç±»åˆ«åç§°åˆ—è¡¨</span></span><br></pre></td></tr></table></figure></li></ul></li></ol><p><strong>æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ <code>.txt</code> æ–‡ä»¶åˆ—è¡¨ (å¦‚æœä½ é€‰æ‹©äº†æ–¹æ¡ˆAæ¥åˆ›å»º<code>data.yaml</code>)</strong></p><p>å¦‚æœä½ æ˜¯æ ¹æ® <code>obj.data</code> æ–‡ä»¶ä¸­çš„ <code>train = .../train.txt</code> å’Œ <code>valid = .../valid.txt</code> æ¥é…ç½® <code>data.yaml</code> çš„ï¼Œé‚£ä¹ˆä½ éœ€è¦ç¡®ä¿ï¼š</p><ol><li><code>train.txt</code> æ–‡ä»¶ç¡®å®å­˜åœ¨ï¼Œå¹¶ä¸”é‡Œé¢åˆ—å‡ºäº†æ‰€æœ‰<strong>è®­ç»ƒé›†</strong>å›¾åƒçš„<strong>æ­£ç¡®è·¯å¾„</strong>ï¼ˆç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹äº <code>data.yaml</code> ä¸­ <code>path</code> çš„è·¯å¾„ï¼‰ã€‚</li><li>ä½ æœ‰ä¸€ä¸ªç±»ä¼¼çš„ <code>valid.txt</code> æ–‡ä»¶ï¼Œé‡Œé¢åˆ—å‡ºäº†æ‰€æœ‰<strong>éªŒè¯é›†</strong>å›¾åƒçš„<strong>æ­£ç¡®è·¯å¾„</strong>ã€‚</li><li><code>data.yaml</code> æ–‡ä»¶ä¸­çš„ <code>train:</code> å’Œ <code>val:</code> å­—æ®µæ­£ç¡®æŒ‡å‘äº†è¿™ä¸¤ä¸ª <code>.txt</code> æ–‡ä»¶ã€‚</li></ol><p>å¦‚æœä½ åªæœ‰ä¸€ä¸ªåŒ…å«æ‰€æœ‰å›¾åƒè·¯å¾„çš„ <code>.txt</code> æ–‡ä»¶ï¼Œä½ éœ€è¦åƒæ–¹æ³•äºŒä¸­åˆ’åˆ†æ–‡ä»¶ä¸€æ ·ï¼Œå°†è¿™ä¸ª <code>.txt</code> æ–‡ä»¶ä¹Ÿ<strong>åˆ’åˆ†æˆä¸¤ä¸ªæ–‡ä»¶</strong>ï¼š<code>train.txt</code> å’Œ <code>valid.txt</code>ï¼Œç¡®ä¿åˆ’åˆ†æ¯”ä¾‹åˆé€‚ã€‚</p><p><strong>æ€»ç»“:</strong></p><ul><li><strong>æœ€ä½³æ–¹å¼:</strong> åœ¨ CVAT ä¸­å°±ä½¿ç”¨ â€œSubsetâ€ åŠŸèƒ½åŒºåˆ†å¥½è®­ç»ƒé›†å’ŒéªŒè¯é›†ï¼Œç„¶åå¯¼å‡º <code>YOLO ZIP</code> æ ¼å¼ï¼Œé€šå¸¸ <code>data.yaml</code> å°±é…ç½®å¥½äº†ã€‚</li><li><strong>æ¬¡ä½³æ–¹å¼:</strong> å¦‚æœå¯¼å‡ºçš„æ•°æ®æœªåˆ’åˆ†ï¼Œä½¿ç”¨è„šæœ¬ï¼ˆå¦‚ä¸Šä¾‹ï¼‰å°†å…¶è‡ªåŠ¨åˆ’åˆ†ä¸º <code>train/</code> å’Œ <code>valid/</code> ç›®å½•ç»“æ„ï¼Œç„¶åç›¸åº”åœ°é…ç½® <code>data.yaml</code> æŒ‡å‘è¿™äº›ç›®å½•ã€‚</li><li><strong>å¦‚æœä¾èµ– <code>.txt</code> åˆ—è¡¨:</strong> ç¡®ä¿ä½ æœ‰åˆ†åˆ«åˆ—å‡ºè®­ç»ƒå›¾åƒå’ŒéªŒè¯å›¾åƒè·¯å¾„çš„ <code>train.txt</code> å’Œ <code>valid.txt</code> æ–‡ä»¶ï¼Œå¹¶åœ¨ <code>data.yaml</code> ä¸­æ­£ç¡®å¼•ç”¨å®ƒä»¬ã€‚</li></ul><p>æ— è®ºå“ªç§æ–¹æ³•ï¼Œæœ€ç»ˆç›®æ ‡éƒ½æ˜¯è¦æœ‰ä¸€ä¸ªæ˜ç¡®åŒºåˆ†çš„è®­ç»ƒæ•°æ®é›†å’Œä¸€ä¸ªéªŒè¯æ•°æ®é›†ï¼Œå¹¶ä¸” <code>data.yaml</code> æ–‡ä»¶èƒ½å¤Ÿå‡†ç¡®åœ°å‘Šè¯‰ YOLOv8 æ¡†æ¶å»å“ªé‡Œæ‰¾åˆ°å®ƒä»¬ã€‚</p><h3 id="è®­ç»ƒç»“æœ">è®­ç»ƒç»“æœ</h3><p><img src="/2025/04/09/yolov8-train-model/gpu_train_model.png" class="lazyload placeholder" data-srcset="/2025/04/09/yolov8-train-model/gpu_train_model.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">python train_model.py </span><br><span class="line">PyTorch device: cpu</span><br><span class="line">Ultralytics 8.3.105 ğŸš€ Python-3.12.3 torch-2.6.0+cu124 CPU (Intel Xeon E5-2690 v3 2.60GHz)</span><br><span class="line">engine/trainer: task=detect, mode=train, model=yolov8n.pt, data=/home/czq2/test_data/data.yaml, epochs=50, time=None, patience=100, batch=4, imgsz=640, save=True, save_period=-1, cache=False, device=cpu, workers=4, project=None, name=train2, exist_ok=False, pretrained=True, optimizer=auto, verbose=True, seed=0, deterministic=True, single_cls=False, rect=False, cos_lr=False, close_mosaic=10, resume=False, amp=True, fraction=1.0, profile=False, freeze=None, multi_scale=False, overlap_mask=True, mask_ratio=4, dropout=0.0, val=True, split=val, save_json=False, conf=None, iou=0.7, max_det=300, half=False, dnn=False, plots=True, source=None, vid_stride=1, stream_buffer=False, visualize=False, augment=False, agnostic_nms=False, classes=None, retina_masks=False, embed=None, show=False, save_frames=False, save_txt=False, save_conf=False, save_crop=False, show_labels=True, show_conf=True, show_boxes=True, line_width=None, format=torchscript, keras=False, optimize=False, int8=False, dynamic=False, simplify=True, opset=None, workspace=None, nms=False, lr0=0.01, lrf=0.01, momentum=0.937, weight_decay=0.0005, warmup_epochs=3.0, warmup_momentum=0.8, warmup_bias_lr=0.1, box=7.5, cls=0.5, dfl=1.5, pose=12.0, kobj=1.0, nbs=64, hsv_h=0.015, hsv_s=0.7, hsv_v=0.4, degrees=0.0, translate=0.1, scale=0.5, shear=0.0, perspective=0.0, flipud=0.0, fliplr=0.5, bgr=0.0, mosaic=1.0, mixup=0.0, copy_paste=0.0, copy_paste_mode=flip, auto_augment=randaugment, erasing=0.4, crop_fraction=1.0, cfg=None, tracker=botsort.yaml, save_dir=runs/detect/train2</span><br><span class="line">Downloading https://ultralytics.com/assets/Arial.Unicode.ttf to &#x27;/home/czq2/.config/Ultralytics/Arial.Unicode.ttf&#x27;...</span><br><span class="line"><span class="meta prompt_">100%</span><span class="language-bash">|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 22.2M/22.2M [00:01&lt;00:00, 21.2MB/s]</span></span><br><span class="line">Overriding model.yaml nc=80 with nc=4</span><br><span class="line"></span><br><span class="line">                   from  n    params  module                                       arguments                     </span><br><span class="line">  0                  -1  1       464  ultralytics.nn.modules.conv.Conv             [3, 16, 3, 2]                 </span><br><span class="line">  1                  -1  1      4672  ultralytics.nn.modules.conv.Conv             [16, 32, 3, 2]                </span><br><span class="line">  2                  -1  1      7360  ultralytics.nn.modules.block.C2f             [32, 32, 1, True]             </span><br><span class="line">  3                  -1  1     18560  ultralytics.nn.modules.conv.Conv             [32, 64, 3, 2]                </span><br><span class="line">  4                  -1  2     49664  ultralytics.nn.modules.block.C2f             [64, 64, 2, True]             </span><br><span class="line">  5                  -1  1     73984  ultralytics.nn.modules.conv.Conv             [64, 128, 3, 2]               </span><br><span class="line">  6                  -1  2    197632  ultralytics.nn.modules.block.C2f             [128, 128, 2, True]           </span><br><span class="line">  7                  -1  1    295424  ultralytics.nn.modules.conv.Conv             [128, 256, 3, 2]              </span><br><span class="line">  8                  -1  1    460288  ultralytics.nn.modules.block.C2f             [256, 256, 1, True]           </span><br><span class="line">  9                  -1  1    164608  ultralytics.nn.modules.block.SPPF            [256, 256, 5]                 </span><br><span class="line"> 10                  -1  1         0  torch.nn.modules.upsampling.Upsample         [None, 2, &#x27;nearest&#x27;]          </span><br><span class="line"> 11             [-1, 6]  1         0  ultralytics.nn.modules.conv.Concat           [1]                           </span><br><span class="line"> 12                  -1  1    148224  ultralytics.nn.modules.block.C2f             [384, 128, 1]                 </span><br><span class="line"> 13                  -1  1         0  torch.nn.modules.upsampling.Upsample         [None, 2, &#x27;nearest&#x27;]          </span><br><span class="line"> 14             [-1, 4]  1         0  ultralytics.nn.modules.conv.Concat           [1]                           </span><br><span class="line"> 15                  -1  1     37248  ultralytics.nn.modules.block.C2f             [192, 64, 1]                  </span><br><span class="line"> 16                  -1  1     36992  ultralytics.nn.modules.conv.Conv             [64, 64, 3, 2]                </span><br><span class="line"> 17            [-1, 12]  1         0  ultralytics.nn.modules.conv.Concat           [1]                           </span><br><span class="line"> 18                  -1  1    123648  ultralytics.nn.modules.block.C2f             [192, 128, 1]                 </span><br><span class="line"> 19                  -1  1    147712  ultralytics.nn.modules.conv.Conv             [128, 128, 3, 2]              </span><br><span class="line"> 20             [-1, 9]  1         0  ultralytics.nn.modules.conv.Concat           [1]                           </span><br><span class="line"> 21                  -1  1    493056  ultralytics.nn.modules.block.C2f             [384, 256, 1]                 </span><br><span class="line"> 22        [15, 18, 21]  1    752092  ultralytics.nn.modules.head.Detect           [4, [64, 128, 256]]           </span><br><span class="line">Model summary: 129 layers, 3,011,628 parameters, 3,011,612 gradients, 8.2 GFLOPs</span><br><span class="line"></span><br><span class="line">Transferred 319/355 items from pretrained weights</span><br><span class="line">Freezing layer &#x27;model.22.dfl.conv.weight&#x27;</span><br><span class="line">train: Scanning /home/czq2/test_data/train/labels... 495 images, 201 backgrounds, 0 corrupt: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 495/495 [00:14&lt;00:00, 34.44it/s]</span><br><span class="line">train: New cache created: /home/czq2/test_data/train/labels.cache</span><br><span class="line">val: Scanning /home/czq2/test_data/valid/labels... 124 images, 47 backgrounds, 0 corrupt: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 124/124 [00:03&lt;00:00, 37.91it/s]</span><br><span class="line">val: New cache created: /home/czq2/test_data/valid/labels.cache</span><br><span class="line">Plotting labels to runs/detect/train2/labels.jpg... </span><br><span class="line">/home/czq2/yolo_cpu_env/lib/python3.12/site-packages/ultralytics/utils/plotting.py:587: UserWarning: Glyph 35270 (\N&#123;CJK UNIFIED IDEOGRAPH-89C6&#125;) missing from font(s) DejaVu Sans.</span><br><span class="line">  plt.savefig(fname, dpi=200)</span><br><span class="line">/home/czq2/yolo_cpu_env/lib/python3.12/site-packages/ultralytics/utils/plotting.py:587: UserWarning: Glyph 39057 (\N&#123;CJK UNIFIED IDEOGRAPH-9891&#125;) missing from font(s) DejaVu Sans.</span><br><span class="line">optimizer: &#x27;optimizer=auto&#x27; found, ignoring &#x27;lr0=0.01&#x27; and &#x27;momentum=0.937&#x27; and determining best &#x27;optimizer&#x27;, &#x27;lr0&#x27; and &#x27;momentum&#x27; automatically... </span><br><span class="line">optimizer: AdamW(lr=0.00125, momentum=0.9) with parameter groups 57 weight(decay=0.0), 64 weight(decay=0.0005), 63 bias(decay=0.0)</span><br><span class="line">Image sizes 640 train, 640 val</span><br><span class="line">Using 0 dataloader workers</span><br><span class="line">Logging results to runs/detect/train2</span><br><span class="line">Starting training for 50 epochs...</span><br><span class="line"></span><br><span class="line">      Epoch    GPU_mem   box_loss   cls_loss   dfl_loss  Instances       Size</span><br><span class="line">       1/50         0G     0.6873      4.307      1.265          5        640:   2%|â–         | 2/124 [00:02&lt;02:20,  1.15s/it]Downloading https://ultralytics.com/assets/Arial.ttf to &#x27;/home/czq2/.config/Ultralytics/Arial.ttf&#x27;...</span><br><span class="line"><span class="meta prompt_">100%</span><span class="language-bash">|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 755k/755k [00:00&lt;00:00, 2.17MB/s]</span></span><br><span class="line">       1/50         0G      1.137      2.561      1.378          7        640: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 124/124 [02:08&lt;00:00,  1.03s/it]                   | 512k/755k [00:00&lt;00:00, 1.86MB/s]</span><br><span class="line">                 Class     Images  Instances      Box(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 16/16 [00:19&lt;00:00,  1.24s/it]</span><br><span class="line">                   all        124         77        0.7      0.948      0.802      0.538</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li><p>å‚æ•°å®šä¹‰</p></li><li><p>æˆ‘ä»¬æ¥è¯¦ç»†è§£é‡Šä¸€ä¸‹ YOLOv8 è®­ç»ƒè¿‡ç¨‹ä¸­è¿™ä¸€è¡Œè¾“å‡ºçš„å«ä¹‰ï¼š</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Epoch    GPU_mem   box_loss   cls_loss   dfl_loss  Instances       Size</span><br><span class="line">12/50         0G     0.8517     0.8027      1.157          4        640: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 124/124 [02:08&lt;00:00,  1.04s/it]</span><br></pre></td></tr></table></figure><p>å’Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class     Images  Instances      Box(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 16/16 [00:19&lt;00:00,  1.23s/it]</span><br><span class="line">  all        124         77          1      0.999      0.995      0.853</span><br></pre></td></tr></table></figure><p><strong>ç¬¬ä¸€éƒ¨åˆ†ï¼šè®­ç»ƒè¿›åº¦å’ŒæŸå¤± (Training Progress and Loss)</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Epoch    GPU_mem   box_loss   cls_loss   dfl_loss  Instances       Size</span><br><span class="line">12/50         0G     0.8517     0.8027      1.157          4        640: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 124/124 [02:08&lt;00:00,  1.04s/it]</span><br></pre></td></tr></table></figure><ul><li><strong><code>Epoch</code></strong>: <code>12/50</code><ul><li>è¡¨ç¤ºå½“å‰è®­ç»ƒæ­£åœ¨è¿›è¡Œç¬¬ <strong>12</strong> è½® (epoch)ï¼Œæ€»å…±è®¡åˆ’è®­ç»ƒ <strong>50</strong> è½®ã€‚ä¸€ä¸ª epoch æŒ‡çš„æ˜¯æ¨¡å‹å®Œæ•´åœ°çœ‹è¿‡ä¸€éæ‰€æœ‰çš„è®­ç»ƒæ•°æ®ã€‚</li></ul></li><li><strong><code>GPU_mem</code></strong>: <code>0G</code><ul><li>æ˜¾ç¤ºå½“å‰ <strong>GPU æ˜¾å­˜ (VRAM) çš„ä½¿ç”¨é‡</strong>ã€‚è¿™é‡Œæ˜¾ç¤º <code>0G</code> <strong>éå¸¸å¥‡æ€ª</strong>ï¼Œå°¤å…¶æ˜¯å¦‚æœä½ æŒ‡å®šäº†ä½¿ç”¨ GPU è¿›è¡Œè®­ç»ƒã€‚<ul><li><strong>å¯èƒ½çš„åŸå›  1 (æœ€å¯èƒ½):</strong> è®­ç»ƒå®é™…ä¸Šæ˜¯åœ¨ <strong>CPU</strong> ä¸Šè¿è¡Œçš„ï¼Œå³ä½¿ä½ å¯èƒ½æŒ‡å®šäº† <code>device=0</code> æˆ– <code>device='cuda'</code>ã€‚è¿™é€šå¸¸å‘ç”Ÿåœ¨ PyTorch æ— æ³•æ­£ç¡®æ£€æµ‹æˆ–ä½¿ç”¨ä½ çš„ GPU æ—¶ï¼ˆé©±åŠ¨ã€CUDAã€cuDNN æˆ– PyTorch ç‰ˆæœ¬é—®é¢˜ï¼‰ã€‚<strong>ä½ éœ€è¦å›è¿‡å¤´å»éªŒè¯ä½ çš„ GPU ç¯å¢ƒæ˜¯å¦é…ç½®æ­£ç¡®ï¼Œä»¥åŠ PyTorch æ˜¯å¦èƒ½çœŸæ­£ä½¿ç”¨ GPU (<code>torch.cuda.is_available()</code> å¿…é¡»ä¸º <code>True</code>)ã€‚</strong></li><li><strong>å¯èƒ½çš„åŸå›  2 (ä¸å¤ªå¯èƒ½):</strong> ä½ çš„æ¨¡å‹å’Œæ‰¹æ¬¡å¤§å°éå¸¸å°ï¼Œä»¥è‡³äºæ˜¾å­˜å ç”¨å¯ä»¥å¿½ç•¥ä¸è®¡ï¼ˆå¯¹äº YOLOv8 å°¤å…¶æ˜¯ <code>x</code> æ¨¡å‹å’Œ <code>batch=4</code> æ¥è¯´å‡ ä¹ä¸å¯èƒ½ï¼‰ã€‚</li><li><strong>å¯èƒ½çš„åŸå›  3 (æå°‘):</strong> ç›‘æ§æ˜¾å­˜çš„å·¥å…·æˆ–æ¥å£æš‚æ—¶å¤±æ•ˆã€‚</li></ul></li><li><strong>æ­£å¸¸çš„ GPU è®­ç»ƒ</strong> åº”è¯¥ä¼šæ˜¾ç¤ºä¸€ä¸ªéé›¶çš„æ˜¾å­˜ä½¿ç”¨å€¼ï¼Œä¾‹å¦‚ <code>5.8G</code>, <code>10.2G</code> ç­‰ï¼Œå…·ä½“å–å†³äºæ¨¡å‹å¤§å°ã€æ‰¹å¤§å°å’Œå›¾åƒå°ºå¯¸ã€‚</li></ul></li><li><strong><code>box_loss</code></strong>: <code>0.8517</code><ul><li><strong>è¾¹ç•Œæ¡†æŸå¤± (Bounding Box Loss)</strong>ã€‚è¿™ä¸ªå€¼è¡¡é‡çš„æ˜¯æ¨¡å‹é¢„æµ‹çš„è¾¹ç•Œæ¡†ä½ç½®/å¤§å°ä¸çœŸå®è¾¹ç•Œæ¡†ä¹‹é—´çš„å·®å¼‚ã€‚å€¼è¶Šä½è¶Šå¥½ã€‚</li></ul></li><li><strong><code>cls_loss</code></strong>: <code>0.8027</code><ul><li><strong>åˆ†ç±»æŸå¤± (Classification Loss)</strong>ã€‚è¿™ä¸ªå€¼è¡¡é‡çš„æ˜¯æ¨¡å‹é¢„æµ‹çš„ç‰©ä½“ç±»åˆ«ä¸çœŸå®ç±»åˆ«ä¹‹é—´çš„å·®å¼‚ã€‚å€¼è¶Šä½è¶Šå¥½ã€‚</li></ul></li><li><strong><code>dfl_loss</code></strong>: <code>1.157</code><ul><li><strong>åˆ†å¸ƒç„¦ç‚¹æŸå¤± (Distribution Focal Loss)</strong>ã€‚è¿™æ˜¯ YOLOv8ï¼ˆå°¤å…¶æ˜¯ v8 åŠæ›´æ–°ç‰ˆæœ¬ï¼‰å¼•å…¥çš„ä¸€ç§ç”¨äºè¾¹ç•Œæ¡†å›å½’çš„æŸå¤±ï¼Œå®ƒå°†è¾¹ç•Œæ¡†çš„è¿ç»­åæ ‡å›å½’é—®é¢˜è½¬åŒ–ä¸ºç¦»æ•£çš„æ¦‚ç‡åˆ†å¸ƒé¢„æµ‹é—®é¢˜ï¼Œæœ‰åŠ©äºæé«˜å®šä½ç²¾åº¦ã€‚å€¼è¶Šä½è¶Šå¥½ã€‚</li></ul></li><li><strong><code>Instances</code></strong>: <code>4</code><ul><li>å½“å‰æ­£åœ¨å¤„ç†çš„è¿™ä¸ªæ‰¹æ¬¡ (batch) ä¸­åŒ…å«çš„<strong>ç›®æ ‡å®ä¾‹ (objects) çš„æ•°é‡</strong>ã€‚è¿™é‡Œæ˜¯ 4 ä¸ªã€‚æ³¨æ„è¿™ä¸æ˜¯æ‰¹å¤§å°ï¼ˆbatch sizeï¼Œå³å›¾åƒæ•°é‡ï¼‰ã€‚</li></ul></li><li><strong><code>Size</code></strong>: <code>640</code><ul><li>è®­ç»ƒæ—¶è¾“å…¥æ¨¡å‹çš„<strong>å›¾åƒå°ºå¯¸</strong> (é€šå¸¸æ˜¯ height å’Œ width éƒ½è®¾ä¸ºè¿™ä¸ªå€¼ï¼Œå³ 640x640)ã€‚</li></ul></li><li><strong><code>100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 124/124 [02:08&lt;00:00, 1.04s/it]</code></strong>:<ul><li>è¿™æ˜¯ä¸€ä¸ª<strong>è¿›åº¦æ¡</strong>ï¼Œæ˜¾ç¤ºå½“å‰ epoch å†…è®­ç»ƒæ•°æ®çš„å¤„ç†è¿›åº¦ã€‚</li><li><code>100%</code>: è¡¨ç¤ºå½“å‰ epoch çš„è®­ç»ƒæ•°æ®å·²å…¨éƒ¨å¤„ç†å®Œæ¯•ã€‚</li><li><code>124/124</code>: è¡¨ç¤ºå½“å‰ epoch å…±å¤„ç†äº† 124 ä¸ªæ‰¹æ¬¡ (batches)ï¼Œç°åœ¨å·²ç»å®Œæˆäº†ç¬¬ 124 ä¸ªæ‰¹æ¬¡ã€‚ (æ€»æ‰¹æ¬¡æ•° = æ€»è®­ç»ƒå›¾åƒæ•° / batch_size)</li><li><code>[02:08&lt;00:00</code>]: å½“å‰ epoch å·²ç”¨æ—¶ 2 åˆ† 8 ç§’ï¼Œé¢„è®¡å‰©ä½™æ—¶é—´ 0 ç§’ã€‚</li><li><code>1.04s/it]</code>: å¤„ç†ä¸€ä¸ªæ‰¹æ¬¡ (iteration) å¹³å‡éœ€è¦ 1.04 ç§’ã€‚è¿™ä¸ªé€Ÿåº¦<strong>å¯¹äº GPU æ¥è¯´ç›¸å½“æ…¢</strong>ï¼Œè¿›ä¸€æ­¥å°è¯äº†å¯èƒ½æ˜¯åœ¨ CPU ä¸Šè¿è¡Œã€‚GPU è®­ç»ƒé€šå¸¸æ˜¯ <code>ms/it</code> (æ¯«ç§’æ¯è¿­ä»£)ã€‚</li></ul></li></ul><p><strong>ç¬¬äºŒéƒ¨åˆ†ï¼šéªŒè¯ç»“æœè¯„ä¼° (Validation Results Evaluation)</strong></p><p>è¿™éƒ¨åˆ†é€šå¸¸åœ¨æ¯ä¸ª epoch çš„è®­ç»ƒç»“æŸåï¼ˆæˆ–è€…æ ¹æ®è®¾ç½®çš„é¢‘ç‡ï¼‰è¿è¡Œï¼Œä½¿ç”¨éªŒè¯é›† (Validation Set) æ¥è¯„ä¼°å½“å‰æ¨¡å‹çš„æ€§èƒ½ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class     Images  Instances      Box(P          R      mAP50  mAP50-95): 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 16/16 [00:19&lt;00:00,  1.23s/it]</span><br><span class="line">  all        124         77          1      0.999      0.995      0.853</span><br></pre></td></tr></table></figure><ul><li><strong><code>Class</code></strong>: <code>all</code><ul><li>è¡¨ç¤ºè¿™ä¸€è¡Œæ˜¾ç¤ºçš„æ˜¯<strong>æ‰€æœ‰ç±»åˆ«</strong>çš„å¹³å‡æ€§èƒ½æŒ‡æ ‡ã€‚å¦‚æœä½ çš„æ•°æ®é›†æœ‰å¤šä¸ªç±»åˆ«ï¼Œé€šå¸¸è¿˜ä¼šåœ¨è¿™é‡Œæˆ–ä¸‹é¢å‡ è¡Œåˆ—å‡ºæ¯ä¸ªå•ç‹¬ç±»åˆ«çš„æŒ‡æ ‡ã€‚</li></ul></li><li><strong><code>Images</code></strong>: <code>124</code><ul><li>ä½ çš„<strong>éªŒè¯é›†</strong>ä¸­åŒ…å« <strong>124</strong> å¼ å›¾åƒã€‚</li></ul></li><li><strong><code>Instances</code></strong>: <code>77</code><ul><li>ä½ çš„<strong>éªŒè¯é›†</strong>ä¸­æ‰€æœ‰å›¾åƒæ€»å…±åŒ…å« <strong>77</strong> ä¸ªå·²æ ‡æ³¨çš„ç›®æ ‡å®ä¾‹ã€‚</li></ul></li><li><strong><code>Box(P R mAP50 mAP50-95)</code></strong>: è¿™æ˜¯ç›®æ ‡æ£€æµ‹ä»»åŠ¡æœ€æ ¸å¿ƒçš„è¯„ä¼°æŒ‡æ ‡ï¼š<ul><li><strong><code>P</code> (Precision / ç²¾ç¡®ç‡):</strong> <code>1</code><ul><li>æŒ‡æ¨¡å‹é¢„æµ‹ä¸ºæ­£ä¾‹ï¼ˆæ£€æµ‹åˆ°ç‰©ä½“ï¼‰çš„æ ·æœ¬ä¸­ï¼Œ<strong>çœŸæ­£æ˜¯æ­£ä¾‹</strong>çš„æ¯”ä¾‹ã€‚è®¡ç®—å…¬å¼ï¼š<code>TP / (TP + FP)</code> (çœŸé˜³æ€§ / (çœŸé˜³æ€§ + å‡é˜³æ€§))ã€‚</li><li>å€¼ä¸º <code>1</code> æ„å‘³ç€æ‰€æœ‰æ¨¡å‹æ£€æµ‹åˆ°çš„ç‰©ä½“éƒ½æ˜¯æ­£ç¡®çš„ï¼ˆæ²¡æœ‰è¯¯æŠ¥ï¼‰ã€‚è¿™ä¸ªå€¼é€šå¸¸åœ¨ IoU (Intersection over Union) é˜ˆå€¼ä¸º 0.5 æ—¶è®¡ç®—ï¼Œå¹¶ä¸”å¯èƒ½æ˜¯é’ˆå¯¹æŸä¸ªæœ€ä¼˜ç½®ä¿¡åº¦é˜ˆå€¼å¾—å‡ºçš„ã€‚</li></ul></li><li><strong><code>R</code> (Recall / å¬å›ç‡):</strong> <code>0.999</code><ul><li>æŒ‡æ‰€æœ‰<strong>çœŸå®çš„</strong>æ­£ä¾‹ï¼ˆæ‰€æœ‰å®é™…å­˜åœ¨çš„ç‰©ä½“ï¼‰ä¸­ï¼Œè¢«æ¨¡å‹<strong>æˆåŠŸé¢„æµ‹å‡ºæ¥</strong>çš„æ¯”ä¾‹ã€‚è®¡ç®—å…¬å¼ï¼š<code>TP / (TP + FN)</code> (çœŸé˜³æ€§ / (çœŸé˜³æ€§ + å‡é˜´æ€§))ã€‚</li><li>å€¼ <code>0.999</code> æ„å‘³ç€æ¨¡å‹æ‰¾å›äº†éªŒè¯é›†ä¸­å‡ ä¹æ‰€æœ‰ï¼ˆ99.9%ï¼‰çš„çœŸå®ç‰©ä½“ï¼ˆæ¼æŠ¥éå¸¸å°‘ï¼‰ã€‚è¿™ä¸ªå€¼é€šå¸¸ä¹Ÿæ˜¯åœ¨ IoU é˜ˆå€¼ä¸º 0.5 æ—¶è®¡ç®—ï¼Œå¹¶ä¸”å¯èƒ½æ˜¯é’ˆå¯¹æŸä¸ªæœ€ä¼˜ç½®ä¿¡åº¦é˜ˆå€¼å¾—å‡ºçš„ã€‚</li></ul></li><li><strong><code>mAP50</code> (mean Average Precision @ IoU=0.5):</strong> <code>0.995</code><ul><li>IoU (äº¤å¹¶æ¯”) é˜ˆå€¼è®¾ç½®ä¸º 0.5 æ—¶ï¼Œè®¡ç®—æ‰€æœ‰ç±»åˆ«çš„å¹³å‡ç²¾åº¦ (Average Precision, AP)ï¼Œç„¶åå¯¹æ‰€æœ‰ç±»åˆ«æ±‚å¹³å‡å€¼ (mean AP)ã€‚AP æ˜¯ç»¼åˆäº†ç²¾ç¡®ç‡å’Œå¬å›ç‡çš„æŒ‡æ ‡ï¼Œå®ƒè¡¡é‡çš„æ˜¯ PR æ›²çº¿ä¸‹çš„é¢ç§¯ã€‚</li><li><code>0.995</code> æ˜¯ä¸€ä¸ªéå¸¸é«˜çš„å€¼ï¼Œè¡¨ç¤ºåœ¨ IoU=0.5 çš„æ ‡å‡†ä¸‹ï¼Œæ¨¡å‹æ€§èƒ½éå¸¸å¥½ã€‚</li></ul></li><li><strong><code>mAP50-95</code> (mean Average Precision @ IoU=0.5:0.95):</strong> <code>0.853</code><ul><li>è¿™æ˜¯æ›´ä¸¥æ ¼ã€ä¹Ÿæ˜¯ COCO æ•°æ®é›†ç«èµ›ç­‰åœºæ™¯ä¸­æ›´å¸¸ç”¨çš„æ ‡å‡†ã€‚å®ƒè®¡ç®—äº† IoU é˜ˆå€¼ä» 0.5 åˆ° 0.95ã€æ­¥é•¿ä¸º 0.05 çš„ä¸€ç³»åˆ— IoU å€¼ä¸‹çš„ mAPï¼Œç„¶åå¯¹è¿™äº› mAP æ±‚å¹³å‡ã€‚</li><li>è¿™ä¸ªæŒ‡æ ‡å¯¹æ£€æµ‹æ¡†çš„å®šä½ç²¾åº¦è¦æ±‚æ›´é«˜ã€‚<code>0.853</code> (å³ 85.3%) æ˜¯ä¸€ä¸ªç›¸å½“ä¸é”™çš„æ€§èƒ½ï¼Œè¡¨æ˜æ¨¡å‹ä¸ä»…èƒ½æ£€æµ‹åˆ°ç‰©ä½“ï¼Œè€Œä¸”å®šä½ä¹Ÿæ¯”è¾ƒå‡†ç¡®ã€‚</li></ul></li></ul></li><li><strong><code>100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 16/16 [00:19&lt;00:00, 1.23s/it]</code></strong>:<ul><li>è¿™æ˜¯<strong>éªŒè¯è¿‡ç¨‹</strong>çš„è¿›åº¦æ¡ã€‚</li><li><code>16/16</code>: è¡¨ç¤ºéªŒè¯é›†è¢«åˆ†æˆäº† 16 ä¸ªæ‰¹æ¬¡è¿›è¡Œå¤„ç†ï¼Œç°åœ¨å·²ç»å¤„ç†å®Œäº†ã€‚ (éªŒè¯æ‰¹æ¬¡æ•° = æ€»éªŒè¯å›¾åƒæ•° / éªŒè¯æ‰¹å¤§å°ï¼ŒéªŒè¯æ‰¹å¤§å°å¯èƒ½ä¸è®­ç»ƒæ‰¹å¤§å°ä¸åŒ)ã€‚</li><li><code>[00:19&lt;00:00</code>]: æ•´ä¸ªéªŒè¯è¿‡ç¨‹ç”¨æ—¶ 19 ç§’ã€‚</li><li><code>1.23s/it]</code>: å¤„ç†ä¸€ä¸ªéªŒè¯æ‰¹æ¬¡å¹³å‡éœ€è¦ 1.23 ç§’ã€‚è¿™ä¸ªé€Ÿåº¦åŒæ ·è¯´æ˜å¾ˆå¯èƒ½æ˜¯åœ¨ CPU ä¸Šè¿è¡Œã€‚</li></ul></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;æ¨¡å‹ç®€ä»‹&quot;&gt;æ¨¡å‹ç®€ä»‹&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;YOLO æ˜¯ä¸€ç§å®æ—¶ç›®æ ‡æ£€æµ‹ç®—æ³•å®¶æ—çš„åç§°ã€‚ä¸ä¼ ç»Ÿçš„éœ€è¦å…ˆè¿›è¡ŒåŒºåŸŸæè®®ï¼ˆRegion Proposalï¼‰å†è¿›è¡Œåˆ†ç±»çš„ä¸¤é˜¶æ®µæ£€æµ‹å™¨ï¼ˆå¦‚ Faster R-CNNï¼‰ä¸åŒï¼ŒYOLO å°†ç›®æ ‡æ£€æµ‹è§†ä¸ºä¸€ä¸ªå›å½’é—®</summary>
      
    
    
    
    
    <category term="python" scheme="https://caozhaoqi.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>Nuclioä¸CVATä½¿ç”¨yolov8ç›®æ ‡æ£€æµ‹æ¨¡å‹å®ç°åŠè‡ªåŠ¨åŒ–æ ‡æ³¨</title>
    <link href="https://caozhaoqi.github.io/2025/04/07/nuclio-build-use/"/>
    <id>https://caozhaoqi.github.io/2025/04/07/nuclio-build-use/</id>
    <published>2025-04-07T07:19:21.000Z</published>
    <updated>2025-11-25T15:05:10.334Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Nuclio Dashboard æ˜¯ Nuclio Serverless å¹³å°çš„ä¸€ä¸ªåŸºäº Web çš„å›¾å½¢ç”¨æˆ·ç•Œé¢ï¼ˆGUIï¼‰ï¼Œå®ƒå…è®¸ç”¨æˆ·æ–¹ä¾¿åœ°ç®¡ç†ï¼ˆåˆ›å»ºã€æŸ¥çœ‹ã€ç¼–è¾‘ã€åˆ é™¤ã€éƒ¨ç½²ï¼‰Nuclio å‡½æ•°ã€é¡¹ç›®ã€äº‹ä»¶æºï¼ˆTriggersï¼‰ç­‰èµ„æºã€‚</p></blockquote><p><strong>æ ¸å¿ƒæ¦‚å¿µï¼š</strong></p><ol><li><p><strong>éƒ¨ç½² (Deployment) vs æ„å»º (Building from Source):</strong></p><ul><li><strong>éƒ¨ç½²:</strong> å¯¹äºå¤§å¤šæ•°ç”¨æˆ·æ¥è¯´ï¼Œâ€œæ„å»ºâ€ Nuclio Dashboard æ„å‘³ç€<strong>éƒ¨ç½²</strong>é¢„å…ˆæ„å»ºå¥½çš„ Docker é•œåƒã€‚è¿™æ˜¯æœ€å¸¸è§å’Œæ¨èçš„æ–¹å¼ã€‚ä½ ä¸éœ€è¦ä»æºä»£ç ç¼–è¯‘å®ƒã€‚</li><li><strong>ä»æºç æ„å»º:</strong> è¿™æ˜¯æŒ‡è·å– Nuclio Dashboard çš„æºä»£ç å¹¶è‡ªè¡Œç¼–è¯‘ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶æˆ– Docker é•œåƒã€‚è¿™é€šå¸¸åªåœ¨å¼€å‘ Nuclio æœ¬èº«æˆ–éœ€è¦ç‰¹æ®Šå®šåˆ¶æ—¶æ‰éœ€è¦ï¼Œå¯¹äºæ™®é€šç”¨æˆ·ä¸æ¨èã€‚</li></ul></li><li><p><strong>è¿è¡Œç¯å¢ƒ:</strong> Nuclioï¼ˆåŠå…¶ Dashboardï¼‰å¯ä»¥åœ¨å¤šç§ç¯å¢ƒä¸­è¿è¡Œï¼Œæœ€å¸¸è§çš„æ˜¯ï¼š</p><ul><li><strong>Standalone Docker:</strong> åœ¨å•ä¸ª Docker ä¸»æœºä¸Šè¿è¡Œã€‚</li><li><strong>Kubernetes:</strong> åœ¨ Kubernetes é›†ç¾¤ä¸­è¿è¡Œï¼Œè¿™æ˜¯ç”Ÿäº§ç¯å¢ƒä¸­æœ€å¸¸è§çš„æ–¹å¼ã€‚</li></ul></li></ol><p><strong>éƒ¨ç½²</strong> Nuclio Dashboard çš„æ–¹æ³•ä»¥åŠå¦‚ä½•<strong>ä½¿ç”¨</strong>å®ƒã€‚</p><hr><h3 id="ä¸€ã€éƒ¨ç½²-Nuclio-Dashboard">ä¸€ã€éƒ¨ç½² Nuclio Dashboard</h3><p>Nuclio Dashboard é€šå¸¸ä¸ Nuclio Controller ä¸€èµ·éƒ¨ç½²ã€‚Controller æ˜¯ Nuclio çš„æ ¸å¿ƒæ§åˆ¶å¹³é¢ï¼Œè€Œ Dashboard æ˜¯å…¶ UIã€‚</p><p><strong>æ–¹æ³•ä¸€ï¼šåœ¨ Standalone Docker ç¯å¢ƒä¸­éƒ¨ç½²</strong></p><p>è¿™æ˜¯æœ€ç®€å•çš„æ–¹æ³•ï¼Œé€‚åˆæœ¬åœ°æµ‹è¯•å’Œå¼€å‘ã€‚é€šå¸¸ï¼Œå½“ä½ è¿è¡Œ Nuclio Controller å®¹å™¨æ—¶ï¼Œå®ƒå·²ç»åŒ…å«äº† Dashboardã€‚</p><ol><li><p><strong>æ‹‰å–å¹¶è¿è¡Œ Nuclio Controller é•œåƒ:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8070:8070 -v /var/run/docker.sock:/var/run/docker.sock --name nuclio-dashboard quay.io/nuclio/dashboard:stable-amd64</span><br></pre></td></tr></table></figure><ul><li><code>-d</code>: åå°è¿è¡Œå®¹å™¨ã€‚</li><li><code>-p 8070:8070</code>: å°†ä¸»æœºçš„ 8070 ç«¯å£æ˜ å°„åˆ°å®¹å™¨çš„ 8070 ç«¯å£ï¼ˆNuclio Dashboard é»˜è®¤ç›‘å¬æ­¤ç«¯å£ï¼‰ã€‚</li><li><code>-v /var/run/docker.sock:/var/run/docker.sock</code>: å…è®¸ Nuclio Controller ä¸å®¿ä¸»æœºçš„ Dockerå®ˆæŠ¤è¿›ç¨‹é€šä¿¡ï¼Œä»¥ä¾¿æ„å»ºå’Œè¿è¡Œå‡½æ•°å®¹å™¨ã€‚<strong>ï¼ˆæ³¨æ„å®‰å…¨é£é™©ï¼‰</strong></li><li><code>-v /tmp:/tmp</code>: æä¾›ä¸´æ—¶æ–‡ä»¶å­˜å‚¨ã€‚</li><li><code>--name nuclio-controller</code>: ç»™å®¹å™¨å‘½åã€‚</li><li><code>nuclio/controller:stable</code>: ä½¿ç”¨çš„é•œåƒã€‚</li><li><code>--platform-kind &quot;local&quot;</code> æˆ– <code>&quot;docker&quot;</code>: æŒ‡å®šå¹³å°ç±»å‹ä¸ºæœ¬åœ° Docker ç¯å¢ƒã€‚</li></ul></li><li><p><strong>è®¿é—® Dashboard:</strong><br>éƒ¨ç½²æˆåŠŸåï¼Œåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ <code>http://&lt;ä½ çš„ä¸»æœºIP&gt;:8070</code> æˆ– <code>http://localhost:8070</code> å³å¯è®¿é—® Nuclio Dashboardã€‚</p></li></ol><p><strong>æ–¹æ³•äºŒï¼šåœ¨ Kubernetes ç¯å¢ƒä¸­éƒ¨ç½²</strong></p><p>è¿™æ˜¯åœ¨ç”Ÿäº§æˆ–é›†ç¾¤ç¯å¢ƒä¸­æœ€å¸¸ç”¨çš„æ–¹æ³•ã€‚æ¨èä½¿ç”¨ Helm Chart æ¥éƒ¨ç½² Nuclioã€‚</p><ol><li><p><strong>æ·»åŠ  Nuclio Helm ä»“åº“ (å¦‚æœå°šæœªæ·»åŠ ):</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm repo add nuclio https://nuclio.github.io/nuclio/charts</span><br><span class="line">helm repo update</span><br></pre></td></tr></table></figure></li><li><p><strong>å®‰è£… Nuclio Chart:</strong><br>è¿™å°†åŒæ—¶éƒ¨ç½² Nuclio Controllerï¼ˆåŒ…å« Dashboardï¼‰å’Œå…¶ä»–å¿…è¦çš„ç»„ä»¶ï¼ˆå¦‚ CRDsï¼‰ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ª namespace (æ¨è)</span></span><br><span class="line">kubectl create namespace nuclio</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ Helm å®‰è£…</span></span><br><span class="line">helm install nuclio nuclio/nuclio --namespace nuclio</span><br></pre></td></tr></table></figure><ul><li>ä½ å¯ä»¥é€šè¿‡åˆ›å»º <code>values.yaml</code> æ–‡ä»¶æˆ–ä½¿ç”¨ <code>--set</code> å‚æ•°æ¥è‡ªå®šä¹‰å®‰è£…é€‰é¡¹ï¼ˆä¾‹å¦‚ï¼ŒæŒ‡å®š Service ç±»å‹ã€èµ„æºé™åˆ¶ç­‰ï¼‰ã€‚</li></ul></li><li><p><strong>è®¿é—® Dashboard:</strong><br>éƒ¨ç½²åï¼Œéœ€è¦ä¸€ç§æ–¹å¼ä»é›†ç¾¤å¤–éƒ¨è®¿é—® Dashboard Serviceã€‚å¸¸ç”¨æ–¹æ³•æœ‰ï¼š</p><ul><li><strong>Port Forwarding (ç”¨äºä¸´æ—¶è®¿é—®/è°ƒè¯•):</strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰¾åˆ° Nuclio Dashboard Pod çš„åç§° (é€šå¸¸åŒ…å« &#x27;controller&#x27;)</span></span><br><span class="line">kubectl get pods -n nuclio</span><br><span class="line"><span class="comment"># å‡è®¾ pod åç§°ä¸º nuclio-controller-xxxxxxxxxx-yyyyy</span></span><br><span class="line">kubectl port-forward -n nuclio &lt;nuclio-controller-pod-name&gt; 8070:8070</span><br></pre></td></tr></table></figure>ç„¶ååœ¨æµè§ˆå™¨ä¸­è®¿é—® <code>http://localhost:8070</code>ã€‚</li><li><strong>LoadBalancer Service:</strong> å¦‚æœä½ çš„ Kubernetes é›†ç¾¤æ”¯æŒ LoadBalancer ç±»å‹çš„ Serviceï¼Œå¹¶ä¸”ä½ åœ¨ Helm å®‰è£…æ—¶é…ç½®äº† Dashboard Service ä¸º LoadBalancer ç±»å‹ï¼Œä½ å¯ä»¥è·å–å…¶å¤–éƒ¨ IP åœ°å€æ¥è®¿é—®ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc -n nuclio <span class="comment"># æŸ¥æ‰¾ dashboard service çš„ EXTERNAL-IP</span></span><br></pre></td></tr></table></figure>ç„¶ååœ¨æµè§ˆå™¨ä¸­è®¿é—® <code>http://&lt;EXTERNAL-IP&gt;:8070</code>ã€‚</li><li><strong>NodePort Service:</strong> å¦‚æœé…ç½®ä¸º NodePortï¼Œä½ å¯ä»¥é€šè¿‡ <code>http://&lt;ä»»æ„èŠ‚ç‚¹IP&gt;:&lt;NodePortç«¯å£&gt;</code> è®¿é—®ã€‚</li><li><strong>Ingress:</strong> é…ç½® Ingress èµ„æºï¼Œé€šè¿‡ Ingress Controller æä¾›çš„åŸŸåæˆ–è·¯å¾„æ¥è®¿é—® Dashboardã€‚è¿™æ˜¯ç”Ÿäº§ç¯å¢ƒä¸­æœ€æ¨èçš„æ–¹å¼ã€‚</li></ul></li></ol><p><img src="/2025/04/07/nuclio-build-use/nuclio_ui.png" class="lazyload placeholder" data-srcset="/2025/04/07/nuclio-build-use/nuclio_ui.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h3 id="äºŒã€ä½¿ç”¨-Nuclio-Dashboard">äºŒã€ä½¿ç”¨ Nuclio Dashboard</h3><p>å½“ä½ æˆåŠŸè®¿é—® Nuclio Dashboard åï¼Œä½ ä¼šçœ‹åˆ°ä¸€ä¸ªç”¨æˆ·å‹å¥½çš„ç•Œé¢ã€‚ä»¥ä¸‹æ˜¯ä¸»è¦åŠŸèƒ½åŒºåŸŸå’Œå¸¸è§æ“ä½œï¼š</p><ol><li><p><strong>æ¦‚è§ˆ (Overview / Dashboard):</strong></p><ul><li>é€šå¸¸æ˜¯è¿›å…¥åçš„é¦–é¡µï¼Œæ˜¾ç¤ºé¡¹ç›®å’Œå‡½æ•°çš„æ‘˜è¦ä¿¡æ¯ï¼Œä¾‹å¦‚æ€»æ•°ã€è¿è¡ŒçŠ¶æ€ç­‰ã€‚</li></ul></li><li><p><strong>é¡¹ç›® (Projects):</strong></p><ul><li>Nuclio ä½¿ç”¨é¡¹ç›®æ¥ç»„ç»‡å‡½æ•°ã€‚ä¸€ä¸ªé¡¹ç›®å¯ä»¥åŒ…å«å¤šä¸ªå‡½æ•°ã€‚</li><li><strong>åˆ›å»ºé¡¹ç›®:</strong> ç‚¹å‡» â€œNew Projectâ€ æˆ–ç±»ä¼¼æŒ‰é’®ï¼Œè¾“å…¥é¡¹ç›®åç§°å’Œå¯é€‰çš„æè¿°ã€æ ‡ç­¾ã€‚</li><li><strong>æŸ¥çœ‹é¡¹ç›®:</strong> ç‚¹å‡»é¡¹ç›®åç§°è¿›å…¥é¡¹ç›®è¯¦æƒ…é¡µï¼Œå¯ä»¥çœ‹åˆ°è¯¥é¡¹ç›®ä¸‹çš„æ‰€æœ‰å‡½æ•°ã€‚</li><li><strong>ç¼–è¾‘/åˆ é™¤é¡¹ç›®:</strong> åœ¨é¡¹ç›®åˆ—è¡¨æˆ–è¯¦æƒ…é¡µé€šå¸¸æœ‰ç¼–è¾‘å’Œåˆ é™¤çš„æ“ä½œæŒ‰é’®ã€‚</li></ul></li><li><p><strong>å‡½æ•° (Functions):</strong></p><ul><li>è¿™æ˜¯ Nuclio çš„æ ¸å¿ƒã€‚ä½ å¯ä»¥åœ¨é¡¹ç›®å†…éƒ¨åˆ›å»ºå’Œç®¡ç†å‡½æ•°ã€‚</li><li><strong>åˆ›å»ºå‡½æ•°:</strong><ul><li>è¿›å…¥ä¸€ä¸ªé¡¹ç›®ï¼Œç‚¹å‡» â€œNew Functionâ€ æˆ– â€œCreate Functionâ€ã€‚</li><li><strong>æ¨¡æ¿é€‰æ‹©:</strong> ä½ å¯ä»¥é€‰æ‹©ä¸€ä¸ªé¢„å®šä¹‰çš„æ¨¡æ¿ï¼ˆä¾‹å¦‚ï¼ŒGo çš„ HTTP å¤„ç†ã€Python çš„äº‹ä»¶å¤„ç†ç­‰ï¼‰ï¼Œæˆ–è€…ä»å¤´å¼€å§‹ã€‚</li><li><strong>é…ç½®:</strong><ul><li><strong>Function Name:</strong> å‡½æ•°çš„å”¯ä¸€åç§°ã€‚</li><li><strong>Description/Labels:</strong> å¯é€‰çš„æè¿°å’Œæ ‡ç­¾ã€‚</li><li><strong>Runtime:</strong> é€‰æ‹©å‡½æ•°çš„è¿è¡Œæ—¶è¯­è¨€ï¼ˆGo, Python, Node.js, Java, .NET Core, Shell, Binaryï¼‰ã€‚</li><li><strong>Source Code:</strong><ul><li><strong>Inline Editor:</strong> ç›´æ¥åœ¨ Web ç¼–è¾‘å™¨ä¸­ç¼–å†™ä»£ç ã€‚</li><li><strong>Upload:</strong> ä¸Šä¼ ä»£ç æ–‡ä»¶æˆ–å‹ç¼©åŒ… (zip, jar)ã€‚</li><li><strong>Git Repository:</strong> ä» Git ä»“åº“æ‹‰å–ä»£ç ï¼ˆéœ€è¦é…ç½®ï¼‰ã€‚</li><li><strong>Image:</strong> ä½¿ç”¨ä¸€ä¸ªå·²ç»åŒ…å«å‡½æ•°ä»£ç å’Œä¾èµ–çš„ Docker é•œåƒã€‚</li></ul></li><li><strong>Handler:</strong> æŒ‡å®šå‡½æ•°å…¥å£ç‚¹ï¼ˆä¾‹å¦‚ï¼ŒPython æ–‡ä»¶å:å‡½æ•°åï¼Œ<code>main:handler</code>ï¼‰ã€‚</li><li><strong>Dependencies:</strong> å¦‚æœä»£ç æœ‰å¤–éƒ¨ä¾èµ–ï¼Œéœ€è¦åœ¨è¿™é‡ŒæŒ‡å®šï¼ˆä¾‹å¦‚ï¼ŒPython çš„ <code>requirements.txt</code> å†…å®¹ï¼ŒGo çš„ <code>go.mod</code> ç­‰ï¼‰ã€‚Nuclio ä¼šåœ¨æ„å»ºè¿‡ç¨‹ä¸­å®‰è£…å®ƒä»¬ã€‚</li><li><strong>Triggers:</strong> é…ç½®è§¦å‘å‡½æ•°çš„æ–¹å¼ã€‚æœ€å¸¸è§çš„æ˜¯ <code>http</code>ï¼ˆé€šè¿‡ HTTP è¯·æ±‚è§¦å‘ï¼‰ï¼Œä½†ä¹Ÿæ”¯æŒ Kafka, Kinesis, RabbitMQ, Cron (å®šæ—¶ä»»åŠ¡) ç­‰å¤šç§äº‹ä»¶æºã€‚éœ€è¦é…ç½®è§¦å‘å™¨çš„è¯¦ç»†ä¿¡æ¯ï¼ˆå¦‚ HTTP è·¯å¾„ã€æ–¹æ³•ï¼ŒKafka ä¸»é¢˜ç­‰ï¼‰ã€‚</li><li><strong>Environment Variables:</strong> è®¾ç½®å‡½æ•°è¿è¡Œæ—¶å¯ä»¥è®¿é—®çš„ç¯å¢ƒå˜é‡ã€‚</li><li><strong>Volumes:</strong> (Kubernetes ç¯å¢ƒ) æŒ‚è½½å­˜å‚¨å·åˆ°å‡½æ•° Podã€‚</li><li><strong>Resources:</strong> é…ç½®å‡½æ•°çš„èµ„æºè¯·æ±‚å’Œé™åˆ¶ï¼ˆCPU, Memoryï¼‰ã€‚</li><li><strong>Scaling:</strong> é…ç½®è‡ªåŠ¨ä¼¸ç¼©å‚æ•°ï¼ˆæœ€å°/æœ€å¤§å‰¯æœ¬æ•°ï¼Œç›®æ ‡ CPU ä½¿ç”¨ç‡ç­‰ï¼‰ã€‚</li><li><strong>Build Settings:</strong> é…ç½®æ„å»ºè¿‡ç¨‹çš„å‚æ•°ï¼Œä¾‹å¦‚åŸºç¡€é•œåƒã€æ„å»ºå‘½ä»¤ç­‰ã€‚</li></ul></li></ul></li><li><strong>éƒ¨ç½²å‡½æ•°:</strong> é…ç½®å®Œæˆåï¼Œç‚¹å‡» â€œDeployâ€ æˆ– â€œCreateâ€ã€‚Nuclio Controller ä¼šå¼€å§‹æ„å»ºå‡½æ•°é•œåƒï¼ˆå¦‚æœéœ€è¦ï¼‰å¹¶å°†å…¶å®ä¾‹åŒ–ï¼ˆåœ¨ Docker ä¸­æ˜¯å¯åŠ¨å®¹å™¨ï¼Œåœ¨ Kubernetes ä¸­æ˜¯åˆ›å»º Deployment/Podï¼‰ã€‚éƒ¨ç½²çŠ¶æ€ä¼šæ˜¾ç¤ºåœ¨å‡½æ•°åˆ—è¡¨ä¸­ï¼ˆä¾‹å¦‚ï¼šBuilding, Ready, Errorï¼‰ã€‚</li><li><strong>æŸ¥çœ‹å‡½æ•°è¯¦æƒ…:</strong> ç‚¹å‡»å‡½æ•°åç§°è¿›å…¥è¯¦æƒ…é¡µã€‚<ul><li><strong>Code &amp; Configuration:</strong> æŸ¥çœ‹æˆ–ç¼–è¾‘å‡½æ•°çš„ä»£ç å’Œé…ç½®ã€‚</li><li><strong>Triggers:</strong> æŸ¥çœ‹è§¦å‘å™¨ä¿¡æ¯ï¼Œç‰¹åˆ«æ˜¯ HTTP è§¦å‘å™¨çš„è°ƒç”¨ URLã€‚</li><li><strong>Logs:</strong> æŸ¥çœ‹å‡½æ•°çš„å®æ—¶æˆ–å†å²æ—¥å¿—è¾“å‡ºã€‚</li><li><strong>Monitoring:</strong> æŸ¥çœ‹å‡½æ•°çš„è°ƒç”¨æ¬¡æ•°ã€å»¶è¿Ÿã€æˆåŠŸ/å¤±è´¥ç‡ç­‰æŒ‡æ ‡ï¼ˆå¯èƒ½éœ€è¦é›†æˆç›‘æ§ç³»ç»Ÿï¼‰ã€‚</li><li><strong>Versions:</strong> æŸ¥çœ‹å‡½æ•°çš„éƒ¨ç½²å†å²ç‰ˆæœ¬ã€‚</li></ul></li><li><strong>è°ƒç”¨/æµ‹è¯•å‡½æ•°:</strong> å¯¹äº HTTP è§¦å‘å™¨ï¼Œå¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨æˆ–ä½¿ç”¨ <code>curl</code> ç­‰å·¥å…·è®¿é—®å…¶ URL æ¥è°ƒç”¨å‡½æ•°ã€‚Dashboard æœ‰æ—¶ä¹Ÿæä¾›ç®€å•çš„è°ƒç”¨æµ‹è¯•ç•Œé¢ã€‚</li><li><strong>ç¼–è¾‘/åˆ é™¤å‡½æ•°:</strong> åœ¨å‡½æ•°åˆ—è¡¨æˆ–è¯¦æƒ…é¡µè¿›è¡Œæ“ä½œã€‚ç¼–è¾‘åéœ€è¦é‡æ–°éƒ¨ç½²æ‰èƒ½ç”Ÿæ•ˆã€‚</li></ul></li><li><p><strong>API Gateways:</strong> (å¦‚æœä½¿ç”¨äº† Nuclio çš„ API Gateway åŠŸèƒ½)</p><ul><li>ç”¨äºåˆ›å»ºå’Œç®¡ç† API ç½‘å…³ï¼Œå°†å¤–éƒ¨è¯·æ±‚è·¯ç”±åˆ°ä¸åŒçš„ Nuclio å‡½æ•°ã€‚</li><li>å¯ä»¥é…ç½®è·¯å¾„ã€æ–¹æ³•ã€è®¤è¯ã€é™æµç­‰ã€‚</li></ul></li><li><p><strong>è®¾ç½®/å¹³å°é…ç½® (Settings / Platform Configuration):</strong> (å¯èƒ½åœ¨æŸäº›ç‰ˆæœ¬æˆ–æ¨¡å¼ä¸‹å¯è§)</p><ul><li>æŸ¥çœ‹ Nuclio å¹³å°çš„é…ç½®ä¿¡æ¯ã€‚</li></ul></li></ol><h2 id="åŸºäºyolov8æ¨¡å‹éƒ¨ç½²å‡½æ•°è®¡ç®—åˆ°nuclio">åŸºäºyolov8æ¨¡å‹éƒ¨ç½²å‡½æ•°è®¡ç®—åˆ°nuclio</h2><h3 id="yml">yml</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">nuclio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Function</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">yolov8-detector</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nuclio</span> <span class="comment"># Or your preferred namespace</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nuclio.io/project-name:</span> <span class="comment"># Add your project name if using Nuclio projects</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">description:</span> <span class="string">&quot;YOLOv8 Object Detection Function using model copied during build&quot;</span></span><br><span class="line">  <span class="attr">runtime:</span> <span class="string">python:3.9</span> <span class="comment"># Ensure this matches the Python version you need</span></span><br><span class="line">  <span class="attr">handler:</span> <span class="string">main:handler</span> <span class="comment"># Points to main.py -&gt; handler function</span></span><br><span class="line">  <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HTTP_PROXY</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">http://192.168.10.123:7890</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HTTPS_PROXY</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">http://192.168.10.123:7890</span> <span class="comment"># æˆ–è€… https://... å¦‚æœä»£ç†æœ¬èº«ç”¨https</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NO_PROXY</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">localhost,127.0.0.1,kubernetes.default.svc</span> <span class="comment"># æ·»åŠ å…¶ä»–å†…éƒ¨åœ°å€</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">.</span> <span class="comment"># Build context is still copied somewhere by Nuclio, just maybe not where expected.</span></span><br><span class="line">    <span class="attr">commands:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;apt-get update &amp;&amp; apt-get install -y --no-install-recommends libgl1-mesa-glx libglib2.0-0&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;pip install --default-timeout=600 --no-cache-dir torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;pip install -i https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple --default-timeout=600 --no-cache-dir ultralytics Pillow nuclio-sdk numpy&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ---- Runtime Configuration ----</span></span><br><span class="line">  <span class="comment"># (Optional but Recommended) Set resource limits, especially memory for large models</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">limits:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&quot;4Gi&quot;</span>   <span class="comment"># Adjust memory limit based on yolov8x needs (e.g., 4Gi, 6Gi, 8Gi)</span></span><br></pre></td></tr></table></figure><h3 id="python-code">python code</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> nuclio_sdk</span><br><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> YOLO</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init_context</span>(<span class="params">context: nuclio_sdk.Context</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åˆå§‹åŒ–å‡½æ•°ä¸Šä¸‹æ–‡ï¼ŒåŠ è½½æ¨¡å‹&quot;&quot;&quot;</span></span><br><span class="line">    context.logger.info(<span class="string">&quot;Initializing YOLOv8 model...&quot;</span>)</span><br><span class="line">    <span class="comment"># ä»å‡½æ•°å·¥ä½œç›®å½•åŠ è½½æ¨¡å‹æ–‡ä»¶ (å‡è®¾ .pt æ–‡ä»¶å’Œ main.py åœ¨åŒä¸€ç›®å½•)</span></span><br><span class="line">    <span class="comment"># æˆ–è€…æä¾›æ¨¡å‹çš„ç»å¯¹è·¯å¾„ï¼ˆå¦‚æœåœ¨ function.yaml ä¸­æŒ‚è½½äº†ï¼‰</span></span><br><span class="line">    model_path = <span class="string">&quot;/detect/yolov8/yolov8x.pt&quot;</span></span><br><span class="line">    model = YOLO(model_path)</span><br><span class="line">    context.user_data.model = model</span><br><span class="line">    context.logger.info(<span class="string">&quot;Model loaded successfully.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handler</span>(<span class="params">context: nuclio_sdk.Context, event: nuclio_sdk.Event</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¤„ç†è¾“å…¥çš„ HTTP è¯·æ±‚&quot;&quot;&quot;</span></span><br><span class="line">    context.logger.info(<span class="string">&quot;Received event.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ£€æŸ¥è¯·æ±‚ä½“ç±»å‹</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(event.body, <span class="built_in">bytes</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = json.loads(event.body.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            context.logger.error(<span class="string">f&quot;Failed to decode JSON body: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> context.Response(body=<span class="string">f&quot;Bad request: <span class="subst">&#123;e&#125;</span>&quot;</span>, status_code=<span class="number">400</span>)</span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">isinstance</span>(event.body, <span class="built_in">dict</span>):</span><br><span class="line">        data = event.body</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> context.Response(body=<span class="string">&quot;Unsupported event body type&quot;</span>, status_code=<span class="number">400</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä»è¯·æ±‚ä¸­è·å– base64 ç¼–ç çš„å›¾åƒæ•°æ®</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;image&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">        <span class="keyword">return</span> context.Response(body=<span class="string">&quot;Missing &#x27;image&#x27; field in request body&quot;</span>, status_code=<span class="number">400</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        image_b64 = data[<span class="string">&#x27;image&#x27;</span>]</span><br><span class="line">        image_bytes = base64.b64decode(image_b64)</span><br><span class="line">        image = Image.<span class="built_in">open</span>(io.BytesIO(image_bytes)).convert(<span class="string">&#x27;RGB&#x27;</span>) <span class="comment"># ç¡®ä¿æ˜¯ RGB</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        context.logger.error(<span class="string">f&quot;Failed to decode base64 image: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> context.Response(body=<span class="string">f&quot;Invalid image data: <span class="subst">&#123;e&#125;</span>&quot;</span>, status_code=<span class="number">400</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä½¿ç”¨åŠ è½½çš„æ¨¡å‹è¿›è¡Œé¢„æµ‹</span></span><br><span class="line">    context.logger.info(<span class="string">&quot;Performing inference...&quot;</span>)</span><br><span class="line">    model = context.user_data.model</span><br><span class="line">    results = model(image) <span class="comment"># results æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œé€šå¸¸åŒ…å«ä¸€ä¸ª Results å¯¹è±¡</span></span><br><span class="line">    context.logger.info(<span class="string">&quot;Inference complete.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¤„ç†é¢„æµ‹ç»“æœ</span></span><br><span class="line">    detections = []</span><br><span class="line">    <span class="keyword">if</span> results <span class="keyword">and</span> results[<span class="number">0</span>]:</span><br><span class="line">        result = results[<span class="number">0</span>] <span class="comment"># è·å–ç¬¬ä¸€ä¸ªå›¾åƒçš„ç»“æœ</span></span><br><span class="line">        boxes = result.boxes  <span class="comment"># Boxes object</span></span><br><span class="line">        names = result.names  <span class="comment"># Class names dict &#123;id: name&#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(boxes)):</span><br><span class="line">            box = boxes[i]</span><br><span class="line">            xyxy = box.xyxy.cpu().numpy().flatten().tolist() <span class="comment"># [x1, y1, x2, y2]</span></span><br><span class="line">            conf = <span class="built_in">float</span>(box.conf.cpu().numpy()) <span class="comment"># ç½®ä¿¡åº¦</span></span><br><span class="line">            cls_id = <span class="built_in">int</span>(box.cls.cpu().numpy())   <span class="comment"># ç±»åˆ« ID</span></span><br><span class="line">            label = names[cls_id]                 <span class="comment"># ç±»åˆ«åç§°</span></span><br><span class="line"></span><br><span class="line">            detections.append(&#123;</span><br><span class="line">                <span class="string">&quot;label&quot;</span>: label,</span><br><span class="line">                <span class="string">&quot;confidence&quot;</span>: conf,</span><br><span class="line">                <span class="comment"># CVAT é€šå¸¸éœ€è¦ [xtl, ytl, xbr, ybr] æ ¼å¼çš„æ•´æ•°åæ ‡</span></span><br><span class="line">                <span class="string">&quot;points&quot;</span>: [<span class="built_in">int</span>(xyxy[<span class="number">0</span>]), <span class="built_in">int</span>(xyxy[<span class="number">1</span>]), <span class="built_in">int</span>(xyxy[<span class="number">2</span>]), <span class="built_in">int</span>(xyxy[<span class="number">3</span>])]</span><br><span class="line">                <span class="comment"># æˆ–è€…æ ¹æ®éœ€è¦è¿”å›å½’ä¸€åŒ–åæ ‡æˆ–å…¶ä»–æ ¼å¼</span></span><br><span class="line">                <span class="comment"># &quot;xtl&quot;: xyxy[0], &quot;ytl&quot;: xyxy[1], &quot;xbr&quot;: xyxy[2], &quot;ybr&quot;: xyxy[3]</span></span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">    context.logger.info(<span class="string">f&quot;Detected <span class="subst">&#123;<span class="built_in">len</span>(detections)&#125;</span> objects.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¿”å› JSON æ ¼å¼çš„æ£€æµ‹ç»“æœ</span></span><br><span class="line">    <span class="keyword">return</span> context.Response(body=json.dumps(detections),</span><br><span class="line">                            content_type=<span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">                            status_code=<span class="number">200</span>)</span><br></pre></td></tr></table></figure><h2 id="web-http-è°ƒç”¨-yolov8æ¨¡å‹">web http è°ƒç”¨ yolov8æ¨¡å‹</h2><blockquote><p>å¯è¾“å‡º cvat v1.1æ ¼å¼çš„æ ‡æ³¨åxmlæ–‡ä»¶ï¼Œæ ¹æ®è¾“å…¥è§†é¢‘è¾“å‡ºç›®æ ‡æ£€æµ‹æ ‡æ³¨ç»“æœç”Ÿæˆä»£ç  è·å¾—æ ‡æ³¨ç»“æœå å‹ç¼©æ ‡æ³¨ç»“æœæ–‡ä»¶ å¯¼å…¥cvatå¯¹åº”é¡¹ç›®å¯¹åº”task</p></blockquote><ul><li>ä»£ç å¦‚ä¸‹ï¼š</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -</span></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta</span><br><span class="line"><span class="keyword">import</span> xml.etree.ElementTree <span class="keyword">as</span> ET</span><br><span class="line"><span class="keyword">from</span> xml.dom <span class="keyword">import</span> minidom <span class="comment"># ç”¨äºç¾åŒ–æ‰“å°XML</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- é…ç½®åŒº ---</span></span><br><span class="line">VIDEO_PATH = <span class="string">&quot;/Users/zg/PycharmProjects/CVAT_model_nuclio/src/run/data/1.mp4&quot;</span>  <span class="comment"># &lt;&lt;&lt;--- ä¿®æ”¹è¿™é‡Œ: ä½ çš„è§†é¢‘æ–‡ä»¶çš„å®Œæ•´è·¯å¾„</span></span><br><span class="line">NUCLIO_FUNCTION_URL = <span class="string">&quot;http://192.168.10.158:32774&quot;</span> <span class="comment"># YOLOv8æ£€æµ‹å™¨çš„ç«¯å£</span></span><br><span class="line">OUTPUT_DIR = <span class="string">&quot;./data/&quot;</span>  <span class="comment"># è¾“å‡ºXMLæ–‡ä»¶çš„ç›®å½•</span></span><br><span class="line">LOG_FILE = <span class="string">&quot;./logs/video_processing_cvat_images_cn.log&quot;</span>  <span class="comment"># æ—¥å¿—æ–‡ä»¶å</span></span><br><span class="line">FRAME_SKIP = <span class="number">5</span>  <span class="comment"># å¤„ç†æ¯ N å¸§ (1 = å¤„ç†æ‰€æœ‰å¸§, 5 = æ¯5å¸§å¤„ç†1å¸§)</span></span><br><span class="line">REQUEST_TIMEOUT = <span class="number">30</span>  <span class="comment"># ç­‰å¾…Nuclioå“åº”çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæ—¥å¿—å’Œæ•°æ®ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰</span></span><br><span class="line">os.makedirs(<span class="string">&#x27;./logs/&#x27;</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">os.makedirs(OUTPUT_DIR, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- è®¾ç½®æ—¥å¿—è®°å½• ---</span></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    level=logging.INFO, <span class="comment"># æ—¥å¿—çº§åˆ«</span></span><br><span class="line">    <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(levelname)s - %(message)s&#x27;</span>, <span class="comment"># æ—¥å¿—æ ¼å¼</span></span><br><span class="line">    handlers=[</span><br><span class="line">        logging.FileHandler(LOG_FILE, encoding=<span class="string">&#x27;utf-8&#x27;</span>),  <span class="comment"># è¾“å‡ºæ—¥å¿—åˆ°æ–‡ä»¶ï¼Œä½¿ç”¨utf-8ç¼–ç </span></span><br><span class="line">        logging.StreamHandler()  <span class="comment"># åŒæ—¶è¾“å‡ºæ—¥å¿—åˆ°æ§åˆ¶å°</span></span><br><span class="line">    ]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- è¾…åŠ©å‡½æ•° ---</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode_frame_to_base64</span>(<span class="params">frame</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å°†OpenCVè¯»å–çš„å¸§(NumPyæ•°ç»„)ç¼–ç ä¸ºBase64å­—ç¬¦ä¸²ã€‚&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># å°†å¸§ç¼–ç ä¸ºå†…å­˜ä¸­çš„JPEGæ ¼å¼</span></span><br><span class="line">        is_success, buffer = cv2.imencode(<span class="string">&quot;.jpg&quot;</span>, frame)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> is_success:</span><br><span class="line">            logging.error(<span class="string">&quot;æ— æ³•å°†å¸§ç¼–ç ä¸ºJPEGã€‚&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="comment"># å°†å­—èŠ‚ç¼“å†²åŒºç¼–ç ä¸ºBase64å­—ç¬¦ä¸²</span></span><br><span class="line">        b64_string = base64.b64encode(buffer).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> b64_string</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;å¸§ç¼–ç è¿‡ç¨‹ä¸­å‡ºé”™: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">call_nuclio_detector</span>(<span class="params">base64_image_string, frame_number</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å°†Base64ç¼–ç çš„å›¾åƒå‘é€ç»™Nuclioå‡½æ•°å¹¶è¿”å›æ£€æµ‹ç»“æœã€‚&quot;&quot;&quot;</span></span><br><span class="line">    payload = json.dumps(&#123;<span class="string">&quot;image&quot;</span>: base64_image_string&#125;)</span><br><span class="line">    headers = &#123;<span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        start_time = time.time()</span><br><span class="line">        <span class="comment"># å‘é€POSTè¯·æ±‚</span></span><br><span class="line">        response = requests.post(NUCLIO_FUNCTION_URL, headers=headers, data=payload, timeout=REQUEST_TIMEOUT)</span><br><span class="line">        end_time = time.time()</span><br><span class="line">        logging.info(<span class="string">f&quot;å¸§ <span class="subst">&#123;frame_number&#125;</span>: Nuclioè¯·æ±‚è€—æ—¶ <span class="subst">&#123;end_time - start_time:<span class="number">.2</span>f&#125;</span> ç§’ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ£€æŸ¥å“åº”çŠ¶æ€ç </span></span><br><span class="line">        <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                detections = response.json()</span><br><span class="line">                <span class="comment"># éªŒè¯æ£€æµ‹ç»“æœçš„åŸºæœ¬ç»“æ„</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(detections, <span class="built_in">list</span>):</span><br><span class="line">                     logging.error(<span class="string">f&quot;å¸§ <span class="subst">&#123;frame_number&#125;</span>: Nuclioå“åº”ä¸æ˜¯åˆ—è¡¨ã€‚æ”¶åˆ°ç±»å‹: <span class="subst">&#123;<span class="built_in">type</span>(detections)&#125;</span>&quot;</span>)</span><br><span class="line">                     <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">                valid_detections = []</span><br><span class="line">                <span class="keyword">for</span> det <span class="keyword">in</span> detections:</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">isinstance</span>(det, <span class="built_in">dict</span>) <span class="keyword">and</span> <span class="string">&#x27;label&#x27;</span> <span class="keyword">in</span> det <span class="keyword">and</span> <span class="string">&#x27;points&#x27;</span> <span class="keyword">in</span> det <span class="keyword">and</span> <span class="string">&#x27;confidence&#x27;</span> <span class="keyword">in</span> det:</span><br><span class="line">                         <span class="keyword">if</span> <span class="built_in">isinstance</span>(det[<span class="string">&#x27;points&#x27;</span>], <span class="built_in">list</span>) <span class="keyword">and</span> <span class="built_in">len</span>(det[<span class="string">&#x27;points&#x27;</span>]) == <span class="number">4</span>:</span><br><span class="line">                              valid_detections.append(det)</span><br><span class="line">                         <span class="keyword">else</span>:</span><br><span class="line">                              logging.warning(<span class="string">f&quot;å¸§ <span class="subst">&#123;frame_number&#125;</span>: è·³è¿‡æ— æ•ˆ&#x27;points&#x27;çš„æ£€æµ‹ç»“æœ: <span class="subst">&#123;det.get(<span class="string">&#x27;points&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                         logging.warning(<span class="string">f&quot;å¸§ <span class="subst">&#123;frame_number&#125;</span>: è·³è¿‡ç¼ºå°‘é”®æˆ–ç±»å‹é”™è¯¯çš„æ£€æµ‹ç»“æœ: <span class="subst">&#123;det&#125;</span>&quot;</span>)</span><br><span class="line">                logging.info(<span class="string">f&quot;å¸§ <span class="subst">&#123;frame_number&#125;</span>: æ”¶åˆ° <span class="subst">&#123;<span class="built_in">len</span>(valid_detections)&#125;</span> ä¸ªæœ‰æ•ˆæ£€æµ‹ç»“æœã€‚&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> valid_detections</span><br><span class="line">            <span class="keyword">except</span> json.JSONDecodeError:</span><br><span class="line">                logging.error(<span class="string">f&quot;å¸§ <span class="subst">&#123;frame_number&#125;</span>: è§£æNuclioçš„JSONå“åº”å¤±è´¥ã€‚çŠ¶æ€ç : <span class="subst">&#123;response.status_code&#125;</span>, å“åº”ä½“(å‰200å­—ç¬¦): <span class="subst">&#123;response.text[:<span class="number">200</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e_val:</span><br><span class="line">                 logging.error(<span class="string">f&quot;å¸§ <span class="subst">&#123;frame_number&#125;</span>: éªŒè¯Nuclioå“åº”ç»“æ„æ—¶å‡ºé”™: <span class="subst">&#123;e_val&#125;</span>&quot;</span>)</span><br><span class="line">                 <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logging.error(<span class="string">f&quot;å¸§ <span class="subst">&#123;frame_number&#125;</span>: Nuclioå‡½æ•°è¿”å›é”™è¯¯ã€‚çŠ¶æ€ç : <span class="subst">&#123;response.status_code&#125;</span>, å“åº”ä½“(å‰200å­—ç¬¦): <span class="subst">&#123;response.text[:<span class="number">200</span>]&#125;</span>...&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.Timeout:</span><br><span class="line">        logging.error(<span class="string">f&quot;å¸§ <span class="subst">&#123;frame_number&#125;</span>: è¯·æ±‚Nuclioå‡½æ•°è¶…æ—¶ (<span class="subst">&#123;REQUEST_TIMEOUT&#125;</span>ç§’)ã€‚&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.RequestException <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;å¸§ <span class="subst">&#123;frame_number&#125;</span>: è¯·æ±‚Nuclioå‡½æ•°å¤±è´¥: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;å¸§ <span class="subst">&#123;frame_number&#125;</span>: è°ƒç”¨Nuclioæ—¶å‘ç”Ÿæ„å¤–é”™è¯¯: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- XML ç”Ÿæˆ ---</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pretty_print_xml</span>(<span class="params">elem</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;è¿”å›åŒ…å«å£°æ˜ä¸”æ ¼å¼åŒ–ï¼ˆç¾åŒ–ï¼‰çš„XMLå­—ç¬¦ä¸²ã€‚&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># å°†ElementTreeå…ƒç´ è½¬æ¢ä¸ºutf-8å­—èŠ‚å­—ç¬¦ä¸²</span></span><br><span class="line">        rough_string = ET.tostring(elem, <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="comment"># ä½¿ç”¨minidomè§£æå­—èŠ‚å­—ç¬¦ä¸²</span></span><br><span class="line">        reparsed = minidom.parseString(rough_string)</span><br><span class="line">        <span class="comment"># ä½¿ç”¨toprettyxmlè¿›è¡Œæ ¼å¼åŒ–ï¼ŒåŒ…å«ç¼©è¿›å’ŒXMLå£°æ˜</span></span><br><span class="line">        <span class="comment"># ç¡®ä¿å®ƒè¿”å›utf-8ç¼–ç çš„å­—èŠ‚å­—ç¬¦ä¸²ï¼Œç„¶åè§£ç ä¸ºpythonå­—ç¬¦ä¸²</span></span><br><span class="line">        xml_str = reparsed.toprettyxml(indent=<span class="string">&quot;  &quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> xml_str</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;XMLç¾åŒ–æ‰“å°è¿‡ç¨‹ä¸­å‡ºé”™: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># è¿”å›Noneï¼Œè¡¨ç¤ºéœ€è¦è°ƒç”¨å‡½æ•°ä¸­çš„åå¤‡æ–¹æ¡ˆ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_results_to_cvat_image_xml</span>(<span class="params">all_results, xml_output_path, video_filename, frame_width, frame_height, total_processed_frames, original_total_frames</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å°†æ£€æµ‹ç»“æœä¿å­˜ä¸º CVAT XML 1.1 for Images æ ¼å¼ã€‚&quot;&quot;&quot;</span></span><br><span class="line">    logging.info(<span class="string">f&quot;æ­£åœ¨ä¸º <span class="subst">&#123;<span class="built_in">len</span>(all_results)&#125;</span> ä¸ªå¤„ç†è¿‡çš„å¸§æ„å»ºCVATå›¾åƒXMLè¾“å‡º...&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- æ„å»ºXMLç»“æ„ ---</span></span><br><span class="line">    root = ET.Element(<span class="string">&quot;annotations&quot;</span>)</span><br><span class="line">    ET.SubElement(root, <span class="string">&quot;version&quot;</span>).text = <span class="string">&quot;1.1&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Metaå…ƒä¿¡æ¯</span></span><br><span class="line">    meta = ET.SubElement(root, <span class="string">&quot;meta&quot;</span>)</span><br><span class="line">    task = ET.SubElement(meta, <span class="string">&quot;task&quot;</span>)</span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;id&quot;</span>).text = <span class="string">&quot;N/A&quot;</span> <span class="comment"># å ä½ç¬¦</span></span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;name&quot;</span>).text = video_filename <span class="comment"># ä½¿ç”¨è§†é¢‘åä½œä¸ºä»»åŠ¡å</span></span><br><span class="line">    <span class="comment"># æ³¨æ„: sizeåœ¨è¿™é‡Œè¡¨ç¤ºæ ‡æ³¨çš„å›¾åƒæ•°é‡ (å³å¤„ç†è¿‡çš„å¸§æ•°)</span></span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;size&quot;</span>).text = <span class="built_in">str</span>(total_processed_frames)</span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;mode&quot;</span>).text = <span class="string">&quot;annotation&quot;</span> <span class="comment"># æ¨¡å¼æ”¹ä¸º annotation (å›¾åƒæ¨¡å¼)</span></span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;overlap&quot;</span>).text = <span class="string">&quot;0&quot;</span></span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;bugtracker&quot;</span>).text = <span class="string">&quot;&quot;</span></span><br><span class="line">    current_time_utc = time.strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S.%f&quot;</span>)[:-<span class="number">3</span>] + <span class="string">&quot;+00:00&quot;</span> <span class="comment"># å½“å‰UTCæ—¶é—´</span></span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;created&quot;</span>).text = current_time_utc</span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;updated&quot;</span>).text = current_time_utc</span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;start_frame&quot;</span>).text = <span class="string">&quot;0&quot;</span></span><br><span class="line">    <span class="comment"># stop_frameå¯¹åº”æœ€åä¸€å¸§çš„ç´¢å¼•(0-based)</span></span><br><span class="line">    <span class="comment"># æˆ‘ä»¬åŸºäºå¤„ç†è¿‡çš„å¸§æ¥è®¡ç®—ï¼Œæ‰¾åˆ°æœ€å¤§çš„å¸§å·</span></span><br><span class="line">    last_processed_frame_num = <span class="built_in">max</span>(all_results.keys()) <span class="keyword">if</span> all_results <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;stop_frame&quot;</span>).text = <span class="built_in">str</span>(last_processed_frame_num - <span class="number">1</span> <span class="keyword">if</span> last_processed_frame_num &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;frame_filter&quot;</span>).text = <span class="string">&quot;&quot;</span> <span class="comment"># å¦‚æœæœ‰è·³å¸§ï¼Œå¯ä»¥å†™åœ¨è¿™é‡Œï¼Œä½†é€šå¸¸å¯¼å…¥æ—¶ä¸éœ€è¦</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æå–å¹¶æ·»åŠ æ ‡ç­¾ä¿¡æ¯</span></span><br><span class="line">    labels = <span class="built_in">set</span>()</span><br><span class="line">    <span class="keyword">if</span> all_results:</span><br><span class="line">        <span class="keyword">for</span> frame_dets <span class="keyword">in</span> all_results.values():</span><br><span class="line">            <span class="keyword">if</span> frame_dets:</span><br><span class="line">                <span class="keyword">for</span> det <span class="keyword">in</span> frame_dets:</span><br><span class="line">                    labels.add(<span class="built_in">str</span>(det.get(<span class="string">&#x27;label&#x27;</span>, <span class="string">&#x27;unknown&#x27;</span>)))</span><br><span class="line"></span><br><span class="line">    labels_elem = ET.SubElement(task, <span class="string">&quot;labels&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> labels: <span class="comment"># å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°ä»»ä½•æ ‡ç­¾ï¼Œæ·»åŠ ä¸€ä¸ªé»˜è®¤æ ‡ç­¾</span></span><br><span class="line">        logging.warning(<span class="string">&quot;åœ¨æ£€æµ‹ç»“æœä¸­æœªæ‰¾åˆ°æ ‡ç­¾ï¼Œæ·»åŠ é»˜è®¤&#x27;unknown&#x27;æ ‡ç­¾ã€‚&quot;</span>)</span><br><span class="line">        labels.add(<span class="string">&#x27;unknown&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> label_name <span class="keyword">in</span> <span class="built_in">sorted</span>(<span class="built_in">list</span>(labels)):</span><br><span class="line">         label_elem = ET.SubElement(labels_elem, <span class="string">&quot;label&quot;</span>)</span><br><span class="line">         ET.SubElement(label_elem, <span class="string">&quot;name&quot;</span>).text = label_name</span><br><span class="line">         ET.SubElement(label_elem, <span class="string">&quot;color&quot;</span>).text = <span class="string">&quot;&quot;</span> <span class="comment"># CVATä¼šè‡ªåŠ¨åˆ†é…é¢œè‰²</span></span><br><span class="line">         ET.SubElement(label_elem, <span class="string">&quot;type&quot;</span>).text = <span class="string">&quot;rectangle&quot;</span> <span class="comment"># å‡è®¾éƒ½æ˜¯çŸ©å½¢æ¡†</span></span><br><span class="line">         ET.SubElement(label_elem, <span class="string">&quot;attributes&quot;</span>) <span class="comment"># è¿™é‡Œä¸å®šä¹‰å±æ€§</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ·»åŠ æœ€å°åŒ–çš„ segments ä¿¡æ¯ (CVATæ ¼å¼è¦æ±‚)</span></span><br><span class="line">    segments = ET.SubElement(task, <span class="string">&quot;segments&quot;</span>)</span><br><span class="line">    segment = ET.SubElement(segments, <span class="string">&quot;segment&quot;</span>)</span><br><span class="line">    ET.SubElement(segment, <span class="string">&quot;id&quot;</span>).text = <span class="string">&quot;0&quot;</span></span><br><span class="line">    ET.SubElement(segment, <span class="string">&quot;start&quot;</span>).text = <span class="string">&quot;0&quot;</span></span><br><span class="line">    ET.SubElement(segment, <span class="string">&quot;stop&quot;</span>).text = <span class="built_in">str</span>(original_total_frames - <span class="number">1</span>) <span class="comment"># ä½¿ç”¨åŸå§‹è§†é¢‘çš„æ€»å¸§æ•°</span></span><br><span class="line">    ET.SubElement(segment, <span class="string">&quot;url&quot;</span>).text = <span class="string">&quot;N/A&quot;</span> <span class="comment"># å ä½ç¬¦</span></span><br><span class="line"></span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;owner&quot;</span>) <span class="comment"># ç©ºçš„ owner</span></span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;assignee&quot;</span>) <span class="comment"># ç©ºçš„ assignee</span></span><br><span class="line">    ET.SubElement(task, <span class="string">&quot;subset&quot;</span>).text = <span class="string">&quot;Default&quot;</span> <span class="comment"># é»˜è®¤å­é›†</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åŸå§‹å°ºå¯¸ä¿¡æ¯ (éœ€è¦)</span></span><br><span class="line">    original_size = ET.SubElement(meta, <span class="string">&quot;original_size&quot;</span>)</span><br><span class="line">    ET.SubElement(original_size, <span class="string">&quot;width&quot;</span>).text = <span class="built_in">str</span>(frame_width)</span><br><span class="line">    ET.SubElement(original_size, <span class="string">&quot;height&quot;</span>).text = <span class="built_in">str</span>(frame_height)</span><br><span class="line"></span><br><span class="line">    ET.SubElement(meta, <span class="string">&quot;dumped&quot;</span>).text = current_time_utc <span class="comment"># å¯¼å‡ºæ—¶é—´</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¸ºæ¯ä¸ªå¤„ç†è¿‡çš„å¸§æ·»åŠ  &lt;image&gt; æ ‡æ³¨</span></span><br><span class="line">    <span class="keyword">if</span> all_results:</span><br><span class="line">        <span class="keyword">for</span> frame_number <span class="keyword">in</span> <span class="built_in">sorted</span>(all_results.keys()): <span class="comment"># æŒ‰å¸§å·æ’åº</span></span><br><span class="line">            detections = all_results[frame_number]</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> detections: <span class="comment"># å¦‚æœè¯¥å¸§æ²¡æœ‰æ£€æµ‹ç»“æœï¼Œè·³è¿‡ï¼ˆç†è®ºä¸Šä¸åº”å‘ç”Ÿï¼Œå› ä¸ºæˆ‘ä»¬åªå­˜å‚¨æœ‰ç»“æœçš„å¸§ï¼‰</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># åˆ›å»º &lt;image&gt; å…ƒç´ </span></span><br><span class="line">            image_elem = ET.SubElement(root, <span class="string">&quot;image&quot;</span>)</span><br><span class="line">            <span class="comment"># CVAT ä½¿ç”¨ 0-based ç´¢å¼•ä½œä¸º id</span></span><br><span class="line">            image_elem.<span class="built_in">set</span>(<span class="string">&quot;id&quot;</span>, <span class="built_in">str</span>(frame_number - <span class="number">1</span>))</span><br><span class="line">            <span class="comment"># ç”Ÿæˆä¸€ä¸ªè§„èŒƒçš„å¸§å (å¯é€‰ï¼Œä½†æ¨è)</span></span><br><span class="line">            image_elem.<span class="built_in">set</span>(<span class="string">&quot;name&quot;</span>, <span class="string">f&quot;frame_<span class="subst">&#123;frame_number:06d&#125;</span>&quot;</span>) <span class="comment"># æ ¼å¼åŒ–å¸§å·ï¼Œå¦‚ frame_000123</span></span><br><span class="line">            image_elem.<span class="built_in">set</span>(<span class="string">&quot;width&quot;</span>, <span class="built_in">str</span>(frame_width))</span><br><span class="line">            image_elem.<span class="built_in">set</span>(<span class="string">&quot;height&quot;</span>, <span class="built_in">str</span>(frame_height))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># åœ¨ &lt;image&gt; å…ƒç´ å†…éƒ¨æ·»åŠ  &lt;box&gt; å…ƒç´ </span></span><br><span class="line">            <span class="keyword">for</span> det <span class="keyword">in</span> detections:</span><br><span class="line">                box_elem = ET.SubElement(image_elem, <span class="string">&quot;box&quot;</span>)</span><br><span class="line">                box_elem.<span class="built_in">set</span>(<span class="string">&quot;label&quot;</span>, <span class="built_in">str</span>(det.get(<span class="string">&#x27;label&#x27;</span>, <span class="string">&#x27;unknown&#x27;</span>)))</span><br><span class="line"></span><br><span class="line">                points = det.get(<span class="string">&#x27;points&#x27;</span>, [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>])</span><br><span class="line">                <span class="comment"># åæ ‡ä½¿ç”¨ä¸¤ä½å°æ•°çš„æµ®ç‚¹æ•°æ ¼å¼</span></span><br><span class="line">                box_elem.<span class="built_in">set</span>(<span class="string">&quot;xtl&quot;</span>, <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">float</span>(points[<span class="number">0</span>]):<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">                box_elem.<span class="built_in">set</span>(<span class="string">&quot;ytl&quot;</span>, <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">float</span>(points[<span class="number">1</span>]):<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">                box_elem.<span class="built_in">set</span>(<span class="string">&quot;xbr&quot;</span>, <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">float</span>(points[<span class="number">2</span>]):<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">                box_elem.<span class="built_in">set</span>(<span class="string">&quot;ybr&quot;</span>, <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">float</span>(points[<span class="number">3</span>]):<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># å¯¹äºå›¾åƒæ ¼å¼ï¼Œé€šå¸¸ä¸éœ€è¦ outsideï¼Œä½† occluded å¯ä»¥ä¿ç•™</span></span><br><span class="line">                box_elem.<span class="built_in">set</span>(<span class="string">&quot;occluded&quot;</span>, <span class="string">&quot;0&quot;</span>) <span class="comment"># 0 è¡¨ç¤ºæœªé®æŒ¡ (å‡è®¾)</span></span><br><span class="line">                <span class="comment"># åœ¨ CVAT for Images æ ¼å¼ä¸­ï¼Œä¸éœ€è¦ keyframe å’Œ outside</span></span><br><span class="line">                <span class="comment"># box_elem.set(&quot;outside&quot;, &quot;0&quot;) # é€šå¸¸ä¸éœ€è¦ä¸ºå›¾åƒè®¾ç½®outside</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># å°†ç½®ä¿¡åº¦æ·»åŠ ä¸ºå±æ€§</span></span><br><span class="line">                attr_conf = ET.SubElement(box_elem, <span class="string">&quot;attribute&quot;</span>, name=<span class="string">&quot;confidence&quot;</span>)</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    confidence_val = <span class="built_in">float</span>(det.get(<span class="string">&#x27;confidence&#x27;</span>, <span class="number">0.0</span>))</span><br><span class="line">                <span class="keyword">except</span> (ValueError, TypeError):</span><br><span class="line">                    confidence_val = <span class="number">0.0</span></span><br><span class="line">                attr_conf.text = <span class="string">f&quot;<span class="subst">&#123;confidence_val:<span class="number">.4</span>f&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- ç»“æŸæ„å»ºXMLç»“æ„ ---</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- å†™å…¥ XML æ–‡ä»¶ ---</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># è·å–åŒ…å«å£°æ˜ä¸”æ ¼å¼åŒ–çš„å®Œæ•´XMLå­—ç¬¦ä¸²</span></span><br><span class="line">        full_xml_string = pretty_print_xml(root)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> full_xml_string:</span><br><span class="line">            <span class="comment"># åœ¨å†™å…¥å‰ç¡®ä¿å­—ç¬¦ä¸²ä»¥ &lt;?xml å¼€å¤´</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> full_xml_string.strip().startswith(<span class="string">&quot;&lt;?xml&quot;</span>):</span><br><span class="line">                 logging.error(<span class="string">&quot;ç¾åŒ–æ‰“å°æœªèƒ½ç”Ÿæˆæœ‰æ•ˆçš„XMLå¼€å¤´ã€‚&quot;</span>)</span><br><span class="line">                 <span class="keyword">raise</span> ValueError(<span class="string">&quot;ç¾åŒ–æ‰“å°å¤±è´¥ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(xml_output_path, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                <span class="comment"># ç›´æ¥å†™å…¥å®Œæ•´çš„å­—ç¬¦ä¸²</span></span><br><span class="line">                f.write(full_xml_string)</span><br><span class="line">            logging.info(<span class="string">f&quot;æ£€æµ‹ç»“æœå·²ä¿å­˜è‡³ CVAT å›¾åƒ XML: <span class="subst">&#123;xml_output_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># å¦‚æœ pretty_print_xml è¿”å› Noneï¼Œä½¿ç”¨åå¤‡æ–¹æ¡ˆ</span></span><br><span class="line">            logging.warning(<span class="string">&quot;ç¾åŒ–æ‰“å°å¤±è´¥ï¼Œå›é€€åˆ°åŸºç¡€XMLå†™å…¥å™¨ã€‚&quot;</span>)</span><br><span class="line">            tree = ET.ElementTree(root)</span><br><span class="line">            <span class="comment"># å¦‚æœ Python &gt;= 3.9, å¯ä»¥ä½¿ç”¨ ET.indent æ·»åŠ åŸºæœ¬ç¼©è¿›</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">hasattr</span>(ET, <span class="string">&#x27;indent&#x27;</span>):</span><br><span class="line">                 ET.indent(tree, space=<span class="string">&quot;  &quot;</span>, level=<span class="number">0</span>)</span><br><span class="line">            <span class="comment"># ä½¿ç”¨ ElementTree å†™å…¥ï¼Œå¹¶è¯·æ±‚ XML å£°æ˜</span></span><br><span class="line">            tree.write(xml_output_path, encoding=<span class="string">&#x27;utf-8&#x27;</span>, xml_declaration=<span class="literal">True</span>)</span><br><span class="line">            logging.info(<span class="string">f&quot;æ£€æµ‹ç»“æœå·²ä¿å­˜è‡³åŸºç¡€ CVAT XML (åå¤‡æ–¹æ¡ˆ): <span class="subst">&#123;xml_output_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;ä¿å­˜ç»“æœåˆ° CVAT XML æ–‡ä»¶å¤±è´¥: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- ä¸»å¤„ç†é€»è¾‘ ---</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    logging.info(<span class="string">f&quot;å¼€å§‹å¤„ç†è§†é¢‘: <span class="subst">&#123;VIDEO_PATH&#125;</span>&quot;</span>)</span><br><span class="line">    logging.info(<span class="string">f&quot;Nuclio å‡½æ•° URL: <span class="subst">&#123;NUCLIO_FUNCTION_URL&#125;</span>&quot;</span>)</span><br><span class="line">    logging.info(<span class="string">f&quot;å¤„ç†å¸§é—´éš”: æ¯ <span class="subst">&#123;FRAME_SKIP&#125;</span> å¸§&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(VIDEO_PATH):</span><br><span class="line">        logging.error(<span class="string">f&quot;è§†é¢‘æ–‡ä»¶æœªæ‰¾åˆ°: <span class="subst">&#123;VIDEO_PATH&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    cap = cv2.VideoCapture(VIDEO_PATH)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cap.isOpened():</span><br><span class="line">        logging.error(<span class="string">f&quot;æ‰“å¼€è§†é¢‘æ–‡ä»¶é”™è¯¯: <span class="subst">&#123;VIDEO_PATH&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># è·å–è§†é¢‘å…ƒæ•°æ®</span></span><br><span class="line">    original_total_frames = <span class="built_in">int</span>(cap.get(cv2.CAP_PROP_FRAME_COUNT))</span><br><span class="line">    fps = cap.get(cv2.CAP_PROP_FPS)</span><br><span class="line">    frame_width = <span class="built_in">int</span>(cap.get(cv2.CAP_PROP_FRAME_WIDTH))</span><br><span class="line">    frame_height = <span class="built_in">int</span>(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))</span><br><span class="line">    <span class="keyword">if</span> original_total_frames &lt;= <span class="number">0</span>:</span><br><span class="line">        logging.error(<span class="string">f&quot;è§†é¢‘æ–‡ä»¶ä¼¼ä¹ä¸ºç©ºæˆ–å…ƒæ•°æ®é”™è¯¯ (æ€»å¸§æ•°: <span class="subst">&#123;original_total_frames&#125;</span>)ã€‚&quot;</span>)</span><br><span class="line">        cap.release()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    logging.info(<span class="string">f&quot;è§†é¢‘ä¿¡æ¯: æ€»å¸§æ•°: <span class="subst">&#123;original_total_frames&#125;</span>, FPS: <span class="subst">&#123;fps:<span class="number">.2</span>f&#125;</span>, å°ºå¯¸: <span class="subst">&#123;frame_width&#125;</span>x<span class="subst">&#123;frame_height&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    frame_count = <span class="number">0</span> <span class="comment"># å·²è¯»å–çš„å¸§è®¡æ•° (1-based for logging)</span></span><br><span class="line">    processed_frame_count = <span class="number">0</span> <span class="comment"># å®é™…å¤„ç†çš„å¸§è®¡æ•°</span></span><br><span class="line">    all_results = &#123;&#125; <span class="comment"># å­˜å‚¨ç»“æœ: &#123;å¸§å· (1-based): [æ£€æµ‹åˆ—è¡¨]&#125;</span></span><br><span class="line">    start_process_time = time.time() <span class="comment"># å¼€å§‹è®¡æ—¶</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment"># è¯»å–ä¸€å¸§</span></span><br><span class="line">        ret, frame = cap.read()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ£€æŸ¥æ˜¯å¦æˆåŠŸè¯»å–</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ret:</span><br><span class="line">            <span class="keyword">if</span> frame_count &lt; original_total_frames:</span><br><span class="line">                logging.warning(<span class="string">f&quot;æ— æ³•è¯»å–å¸§ <span class="subst">&#123;frame_count + <span class="number">1</span>&#125;</span> (æ€»å¸§æ•° <span class="subst">&#123;original_total_frames&#125;</span>)ï¼Œå‡å®šè§†é¢‘ç»“æŸã€‚&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                 logging.info(<span class="string">&quot;è§†é¢‘å¤„ç†åˆ°è¾¾ç»“å°¾ã€‚&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span> <span class="comment"># é€€å‡ºå¾ªç¯</span></span><br><span class="line"></span><br><span class="line">        frame_count += <span class="number">1</span> <span class="comment"># æ›´æ–°å·²è¯»å–å¸§è®¡æ•°</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- è·³å¸§é€»è¾‘ ---</span></span><br><span class="line">        <span class="keyword">if</span> FRAME_SKIP &gt; <span class="number">1</span> <span class="keyword">and</span> frame_count % FRAME_SKIP != <span class="number">0</span> :</span><br><span class="line">            <span class="keyword">continue</span> <span class="comment"># è·³è¿‡å½“å‰å¸§</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- å¤„ç†å½“å‰å¸§ ---</span></span><br><span class="line">        processed_frame_count += <span class="number">1</span> <span class="comment"># æ›´æ–°å·²å¤„ç†å¸§è®¡æ•°</span></span><br><span class="line">        logging.info(<span class="string">f&quot;æ­£åœ¨å¤„ç†å¸§ <span class="subst">&#123;frame_count&#125;</span>/<span class="subst">&#123;original_total_frames&#125;</span>...&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç¼–ç å¸§</span></span><br><span class="line">        b64_string = encode_frame_to_base64(frame)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> b64_string:</span><br><span class="line">            logging.warning(<span class="string">f&quot;å› ç¼–ç é”™è¯¯è·³è¿‡å¸§ <span class="subst">&#123;frame_count&#125;</span>ã€‚&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># è°ƒç”¨ Nuclio æ£€æµ‹å™¨</span></span><br><span class="line">        detections = call_nuclio_detector(b64_string, frame_count)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å­˜å‚¨æ£€æµ‹ç»“æœ (ä»…å½“æ£€æµ‹ç»“æœéç©ºæ—¶å­˜å‚¨)</span></span><br><span class="line">        <span class="keyword">if</span> detections:</span><br><span class="line">            all_results[frame_count] = detections <span class="comment"># ä½¿ç”¨ 1-based å¸§å·ä½œä¸ºé”®</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># --- è¿›åº¦ä¼°è®¡ (å¯é€‰) ---</span></span><br><span class="line">        <span class="keyword">if</span> processed_frame_count &gt; <span class="number">0</span> <span class="keyword">and</span> processed_frame_count % <span class="number">10</span> == <span class="number">0</span>: <span class="comment"># æ¯å¤„ç†10å¸§æ›´æ–°ä¸€æ¬¡è¿›åº¦</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                elapsed_time = time.time() - start_process_time</span><br><span class="line">                <span class="comment"># ä¼°è®¡æ€»å…±éœ€è¦å¤„ç†çš„å¸§æ•°</span></span><br><span class="line">                estimated_total_to_process = (original_total_frames // FRAME_SKIP) <span class="keyword">if</span> FRAME_SKIP &gt; <span class="number">1</span> <span class="keyword">else</span> original_total_frames</span><br><span class="line">                <span class="keyword">if</span> estimated_total_to_process &gt; <span class="number">0</span>:</span><br><span class="line">                    fraction_done = processed_frame_count / estimated_total_to_process</span><br><span class="line">                    <span class="comment"># é¿å…é™¤é›¶é”™è¯¯å’Œè¿›åº¦è¶…è¿‡100%çš„æƒ…å†µ</span></span><br><span class="line">                    <span class="keyword">if</span> fraction_done &gt; <span class="number">0</span> <span class="keyword">and</span> fraction_done &lt;= <span class="number">1</span>:</span><br><span class="line">                        total_estimated_time = elapsed_time / fraction_done</span><br><span class="line">                        estimated_remaining_time = <span class="built_in">max</span>(<span class="number">0</span>, total_estimated_time - elapsed_time) <span class="comment"># ç¡®ä¿ä¸ä¸ºè´Ÿ</span></span><br><span class="line">                        logging.info(</span><br><span class="line">                            <span class="string">f&quot;è¿›åº¦: å¸§ <span class="subst">&#123;frame_count&#125;</span>/<span class="subst">&#123;original_total_frames&#125;</span>ã€‚å·²å¤„ç† <span class="subst">&#123;processed_frame_count&#125;</span> å¸§ã€‚é¢„è®¡å‰©ä½™æ—¶é—´: <span class="subst">&#123;timedelta(seconds=<span class="built_in">int</span>(estimated_remaining_time))&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> ZeroDivisionError:</span><br><span class="line">                logging.warning(<span class="string">&quot;æ— æ³•ä¼°è®¡å‰©ä½™æ—¶é—´ (é™¤é›¶é”™è¯¯)ã€‚&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e_est:</span><br><span class="line">                logging.warning(<span class="string">f&quot;æ— æ³•ä¼°è®¡å‰©ä½™æ—¶é—´: <span class="subst">&#123;e_est&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- æ¸…ç†ä¸ä¿å­˜ ---</span></span><br><span class="line">    cap.release() <span class="comment"># é‡Šæ”¾è§†é¢‘æ•è·å¯¹è±¡</span></span><br><span class="line">    logging.info(<span class="string">&quot;è§†é¢‘æ•è·å·²é‡Šæ”¾ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç¡®å®šè¾“å‡ºXMLæ–‡ä»¶å</span></span><br><span class="line">    video_basename = os.path.basename(VIDEO_PATH)</span><br><span class="line">    video_name_no_ext, _ = os.path.splitext(video_basename)</span><br><span class="line">    <span class="comment"># æ–‡ä»¶åè¡¨æ˜æ˜¯CVATå›¾åƒæ ¼å¼</span></span><br><span class="line">    xml_output_filename = <span class="string">f&quot;<span class="subst">&#123;video_name_no_ext&#125;</span>_cvat_images.xml&quot;</span></span><br><span class="line">    xml_output_path = os.path.join(OUTPUT_DIR, xml_output_filename)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¿å­˜ä¸º CVAT å›¾åƒ XML</span></span><br><span class="line">    <span class="keyword">if</span> all_results:</span><br><span class="line">         <span class="comment"># ä¼ é€’å¤„ç†è¿‡çš„å¸§æ•°ç»™sizeå­—æ®µ</span></span><br><span class="line">         save_results_to_cvat_image_xml(</span><br><span class="line">             all_results,</span><br><span class="line">             xml_output_path,</span><br><span class="line">             video_basename,</span><br><span class="line">             frame_width,</span><br><span class="line">             frame_height,</span><br><span class="line">             processed_frame_count, <span class="comment"># ä¼ é€’å¤„ç†è¿‡çš„å¸§æ•°</span></span><br><span class="line">             original_total_frames <span class="comment"># ä¼ é€’åŸå§‹æ€»å¸§æ•°</span></span><br><span class="line">         )</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">         logging.warning(<span class="string">&quot;æ²¡æœ‰è®°å½•åˆ°ä»»ä½•æ£€æµ‹ç»“æœï¼Œå°†ä¸ä¼šåˆ›å»ºCVAT XMLæ–‡ä»¶ã€‚&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- ç»“æŸå¤„ç† ---</span></span><br><span class="line">    end_process_time = time.time()</span><br><span class="line">    total_time = <span class="built_in">max</span>(<span class="number">0</span>, end_process_time - start_process_time) <span class="comment"># ç¡®ä¿æ€»æ—¶é—´éè´Ÿ</span></span><br><span class="line">    logging.info(<span class="string">f&quot;è§†é¢‘å¤„ç†å®Œæˆã€‚æ€»è€—æ—¶: <span class="subst">&#123;timedelta(seconds=<span class="built_in">int</span>(total_time))&#125;</span>&quot;</span>)</span><br><span class="line">    logging.info(<span class="string">f&quot;æ€»å…±è¯»å–å¸§æ•°: <span class="subst">&#123;frame_count&#125;</span>ã€‚å®é™…å¤„ç†å¸§æ•°: <span class="subst">&#123;processed_frame_count&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- ç¨‹åºå…¥å£ ---</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="see">see</h2><ul><li>1.<a href="https://github.com/nuclio/nuclio?tab=readme-ov-file#quick-start-steps">https://github.com/nuclio/nuclio?tab=readme-ov-file#quick-start-steps</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;Nuclio Dashboard æ˜¯ Nuclio Serverless å¹³å°çš„ä¸€ä¸ªåŸºäº Web çš„å›¾å½¢ç”¨æˆ·ç•Œé¢ï¼ˆGUIï¼‰ï¼Œå®ƒå…è®¸ç”¨æˆ·æ–¹ä¾¿åœ°ç®¡ç†ï¼ˆåˆ›å»ºã€æŸ¥çœ‹ã€ç¼–è¾‘ã€åˆ é™¤ã€éƒ¨ç½²ï¼‰Nuclio å‡½æ•°ã€é¡¹ç›®ã€äº‹ä»¶æºï¼ˆTriggersï¼‰ç­‰èµ„æºã€‚&lt;/p&gt;
&lt;</summary>
      
    
    
    
    
    <category term="python" scheme="https://caozhaoqi.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>ffmpegåˆ†å‰²è§†é¢‘ä¸éŸ³é¢‘ä¸­çš„å¤„ç†é—®é¢˜åˆ†æ</title>
    <link href="https://caozhaoqi.github.io/2025/04/07/ffmpeg-problem-video/"/>
    <id>https://caozhaoqi.github.io/2025/04/07/ffmpeg-problem-video/</id>
    <published>2025-04-07T03:25:47.000Z</published>
    <updated>2025-11-25T15:05:10.304Z</updated>
    
    <content type="html"><![CDATA[<h2 id="èƒŒæ™¯">èƒŒæ™¯</h2><blockquote><p>ffmpeg is a universal media converter. It can read a wide variety of inputs - including live grabbing/recording devices - filter, and transcode them into a plethora of output formats.</p></blockquote><blockquote><p>ffmpgåŒ…å«äº†ä¸€æ•´å¥—ç”¨äºå¤„ç†éŸ³é¢‘ã€è§†é¢‘ã€å­—å¹•ä»¥åŠå…¶ä»–å¤šmÃ©diaæ•°æ®æµçš„åº“ï¼ˆlibrariesï¼‰å’Œç¨‹åºï¼ˆprogramsï¼‰ã€‚</p></blockquote><h2 id="è§†é¢‘å¤„ç†">è§†é¢‘å¤„ç†</h2><h3 id="è§†é¢‘å¸§">è§†é¢‘å¸§</h3><blockquote><p>å¦‚å›¾</p></blockquote><p><img src="/2025/04/07/ffmpeg-problem-video/kf.png" class="lazyload placeholder" data-srcset="/2025/04/07/ffmpeg-problem-video/kf.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li><strong>I å¸§ (å…³é”®å¸§)</strong>: å®Œæ•´çš„å›¾åƒï¼Œç‹¬ç«‹è§£ç ï¼Œæ˜¯è§£ç èµ·ç‚¹å’Œå‚è€ƒåŸºå‡†ï¼Œå‹ç¼©ç‡æœ€ä½ï¼Œæ•°æ®é‡æœ€å¤§ã€‚</li><li><strong>P å¸§</strong>: å­˜å‚¨ä¸å‰ä¸€å¸§çš„å·®å¼‚ï¼Œä¾èµ–å‰ä¸€å¸§è§£ç ï¼Œå‹ç¼©ç‡è¾ƒé«˜ï¼Œæ•°æ®é‡ä¸­ç­‰ã€‚</li><li><strong>B å¸§</strong>: å­˜å‚¨ä¸å‰ã€åå¸§çš„å·®å¼‚ï¼Œä¾èµ–å‰åå¸§è§£ç ï¼Œå‹ç¼©ç‡æœ€é«˜ï¼Œæ•°æ®é‡æœ€å°ã€‚</li><li><strong>GOP</strong>: ç”±ä¸€ä¸ª I å¸§å’Œè‹¥å¹² P/B å¸§ç»„æˆçš„åºåˆ—ï¼Œå…¶é•¿åº¦å½±å“å‹ç¼©ç‡å’Œéšæœºè®¿é—®æ€§èƒ½ã€‚</li></ul><h3 id="å¸§æ„æˆ">å¸§æ„æˆ</h3><blockquote><p>å¦‚å›¾</p></blockquote><p><img src="/2025/04/07/ffmpeg-problem-video/gop.png" class="lazyload placeholder" data-srcset="/2025/04/07/ffmpeg-problem-video/gop.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li><p><strong>I å¸§ (Intra-coded Picture / Keyframe / å…³é”®å¸§)</strong></p></li><li><p><strong>æ„æˆ</strong>: I å¸§æ˜¯ä¸€å¸§<strong>å®Œæ•´</strong>çš„å›¾åƒã€‚å®ƒä¸ä¾èµ–äºä»»ä½•å…¶ä»–å¸§æ¥è¿›è¡Œè§£ç ã€‚å®ƒæœ¬èº«åŒ…å«äº†åœ¨è¯¥æ—¶é—´ç‚¹æ˜¾ç¤ºå®Œæ•´ç”»é¢æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ã€‚</p></li><li><p><strong>ç¼–ç æ–¹å¼</strong>: å®ƒåªåˆ©ç”¨äº†<strong>ç©ºé—´å†—ä½™</strong>è¿›è¡Œå‹ç¼©ï¼Œå…¶ç¼–ç æ–¹å¼ç±»ä¼¼äºé™æ€å›¾åƒå‹ç¼©ï¼ˆå¦‚ JPEGï¼‰ã€‚å®ƒä¸å¯¹å‰åå¸§è¿›è¡Œå‚è€ƒã€‚</p></li><li><p><strong>ä½œç”¨</strong>:</p></li><li><p><strong>è§£ç èµ·ç‚¹</strong>: æ’­æ”¾å™¨å¯ä»¥ä»ä»»ä½•ä¸€ä¸ª I å¸§å¼€å§‹è§£ç å¹¶æ­£ç¡®æ˜¾ç¤ºè§†é¢‘ï¼Œå› æ­¤ I å¸§æ˜¯è§†é¢‘éšæœºè®¿é—®ï¼ˆå¿«è¿›ã€å¿«é€€ã€å®šä½æ’­æ”¾ï¼‰çš„åŸºç¡€ã€‚</p></li><li><p><strong>å‚è€ƒåŸºå‡†</strong>: å®ƒä½œä¸ºåç»­ P å¸§å’Œ B å¸§è¿›è¡Œé¢„æµ‹å’Œå‚è€ƒçš„â€œåŸºå‡†å¸§â€ã€‚</p></li><li><p><strong>é”™è¯¯éš”ç¦»</strong>: å¦‚æœä¼ è¾“æˆ–å­˜å‚¨ä¸­å‡ºç°é”™è¯¯ï¼Œé”™è¯¯çš„å½±å“é€šå¸¸åªæŒç»­åˆ°ä¸‹ä¸€ä¸ª I å¸§ï¼ŒI å¸§å¯ä»¥é˜»æ­¢é”™è¯¯çš„è¿›ä¸€æ­¥ä¼ æ’­ã€‚</p></li><li><p><strong>ç‰¹ç‚¹</strong>: æ•°æ®é‡æœ€å¤§ï¼Œå‹ç¼©ç‡æœ€ä½ï¼ˆç›¸æ¯” P/B å¸§ï¼‰ã€‚</p></li><li><p><strong>P å¸§ (Predicted Picture / å‰å‘é¢„æµ‹å¸§)</strong></p></li><li><p><strong>æ„æˆ</strong>: P å¸§ä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„å›¾åƒã€‚å®ƒå­˜å‚¨çš„æ˜¯å½“å‰ç”»é¢ä¸<strong>ä¹‹å‰</strong>çš„æŸä¸ª I å¸§æˆ– P å¸§ä¹‹é—´çš„<strong>å·®å¼‚ä¿¡æ¯</strong>ã€‚</p></li><li><p><strong>ç¼–ç æ–¹å¼</strong>: å®ƒåˆ©ç”¨äº†<strong>æ—¶é—´å†—ä½™</strong>ã€‚ç¼–ç å™¨ä¼šåˆ†æå½“å‰ P å¸§ä¸å®ƒå‚è€ƒçš„å‰ä¸€å¸§ï¼ˆI æˆ– Pï¼‰ä¹‹é—´çš„åŒºåˆ«ï¼Œä¸»è¦æ˜¯ç‰©ä½“çš„è¿åŠ¨ï¼ˆé€šè¿‡<strong>è¿åŠ¨çŸ¢é‡ (Motion Vectors</strong> æè¿°ç‰©ä½“ç§»åŠ¨çš„æ–¹å‘å’Œè·ç¦»ï¼‰ä»¥åŠè¿åŠ¨è¡¥å¿åçš„æ®‹å·®ä¿¡æ¯ï¼ˆé¢„æµ‹ä¸å®Œå…¨å‡†ç¡®çš„éƒ¨åˆ†ï¼‰ã€‚</p></li><li><p><strong>ä½œç”¨</strong>: å¤§å¤§æé«˜å‹ç¼©ç‡ï¼Œå› ä¸ºåªå­˜å‚¨å˜åŒ–çš„éƒ¨åˆ†ï¼Œæ•°æ®é‡è¿œå°äº I å¸§ã€‚</p></li><li><p><strong>ä¾èµ–æ€§</strong>: è§£ç  P å¸§<strong>å¿…é¡»</strong>å…ˆè§£ç å®ƒæ‰€å‚è€ƒçš„é‚£ä¸ªå‰é¢çš„ I å¸§æˆ– P å¸§ã€‚</p></li><li><p><strong>ç‰¹ç‚¹</strong>: æ•°æ®é‡ä»‹äº I å¸§å’Œ B å¸§ä¹‹é—´ï¼Œå‹ç¼©ç‡è¾ƒé«˜ã€‚</p></li><li><p><strong>B å¸§ (Bi-directionally Predicted Picture / åŒå‘é¢„æµ‹å¸§)</strong></p></li><li><p><strong>æ„æˆ</strong>: B å¸§ä¹Ÿä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„å›¾åƒã€‚å®ƒå­˜å‚¨çš„æ˜¯å½“å‰ç”»é¢ä¸å®ƒ<strong>å‰é¢</strong>çš„ä¸€ä¸ªå‚è€ƒå¸§ï¼ˆI æˆ– Pï¼‰ä»¥åŠ<strong>åé¢</strong>çš„ä¸€ä¸ªå‚è€ƒå¸§ï¼ˆI æˆ– Pï¼‰ä¹‹é—´çš„å·®å¼‚ä¿¡æ¯ã€‚</p></li><li><p><strong>ç¼–ç æ–¹å¼</strong>: å®ƒåˆ©ç”¨äº†æ›´å……åˆ†çš„<strong>æ—¶é—´å†—ä½™</strong>ã€‚ç¼–ç å™¨å¯ä»¥åŒæ—¶å‚è€ƒè¿‡å»å’Œæœªæ¥çš„å¸§æ¥é¢„æµ‹å½“å‰ B å¸§çš„å†…å®¹ï¼Œé€šå¸¸èƒ½æ‰¾åˆ°æ›´ç›¸ä¼¼çš„å—ï¼Œä»è€Œæ›´æœ‰æ•ˆåœ°æè¿°å·®å¼‚ï¼ˆè¿åŠ¨çŸ¢é‡å’Œæ®‹å·®ï¼‰ã€‚</p></li><li><p><strong>ä½œç”¨</strong>: æä¾›æœ€é«˜çš„å‹ç¼©ç‡ï¼Œæ•°æ®é‡é€šå¸¸æ˜¯æœ€å°çš„ã€‚</p></li><li><p><strong>ä¾èµ–æ€§</strong>: è§£ç  B å¸§<strong>å¿…é¡»</strong>å…ˆè§£ç å®ƒæ‰€å‚è€ƒçš„å‰ã€åä¸¤ä¸ªå‚è€ƒå¸§ã€‚è¿™æ„å‘³ç€è§£ç å™¨éœ€è¦å…ˆè§£ç æœªæ¥çš„å‚è€ƒå¸§ï¼Œæ‰èƒ½å›å¤´è§£ç å½“å‰çš„ B å¸§ï¼Œè¿™ä¼šå¼•å…¥ä¸€å®šçš„è§£ç å»¶è¿Ÿã€‚</p></li><li><p><strong>ç‰¹ç‚¹</strong>: æ•°æ®é‡æœ€å°ï¼Œå‹ç¼©ç‡æœ€é«˜ã€‚</p></li></ul><h3 id="å›¾åƒåºåˆ—">å›¾åƒåºåˆ—</h3><ul><li><strong>GOP (Group of Pictures / å›¾åƒç»„)</strong></li></ul><blockquote><p>è¿™äº› Iã€Pã€B å¸§é€šå¸¸è¢«ç»„ç»‡æˆä¸€ä¸ªç§°ä¸º GOP çš„åºåˆ—ã€‚ä¸€ä¸ª GOP ä»¥ä¸€ä¸ª I å¸§å¼€å§‹ï¼Œåé¢è·Ÿç€ä¸€ç³»åˆ— P å¸§å’Œ B å¸§ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ª I å¸§ã€‚</p></blockquote><ul><li><strong>ç»“æ„ç¤ºä¾‹</strong>: ä¸€ä¸ªå¸¸è§çš„ GOP ç»“æ„å¯èƒ½æ˜¯ <code>I B B P B B P B B I</code>ã€‚è¿™ä¸ªåºåˆ—ä¼šé‡å¤å‡ºç°ã€‚</li><li><strong>GOP é•¿åº¦</strong>: æŒ‡ä¸¤ä¸ªè¿ç»­ I å¸§ä¹‹é—´çš„è·ç¦»ï¼ˆä»¥å¸§æ•°æˆ–æ—¶é—´è¡¡é‡ï¼‰ã€‚</li><li><strong>é•¿ GOP</strong>: åŒ…å«æ›´å¤šçš„ P å’Œ B å¸§ï¼Œå‹ç¼©ç‡æ›´é«˜ï¼Œä½†éšæœºè®¿é—®æ€§èƒ½å·®ï¼ˆå®šä½æ’­æ”¾æ—¶éœ€è¦æ‰¾åˆ°æ›´ä¹…ä¹‹å‰çš„ I å¸§ï¼‰ï¼Œé”™è¯¯æ¢å¤æ…¢ã€‚</li><li><strong>çŸ­ GOP</strong>: I å¸§æ›´é¢‘ç¹ï¼Œå‹ç¼©ç‡è¾ƒä½ï¼Œä½†éšæœºè®¿é—®å¿«ï¼Œé”™è¯¯æ¢å¤å¿«ã€‚ç›´æ’­æˆ–éœ€è¦é¢‘ç¹ç¼–è¾‘çš„åœºæ™¯é€šå¸¸ä½¿ç”¨è¾ƒçŸ­çš„ GOPã€‚</li></ul><blockquote><p>ç”±äº B å¸§éœ€è¦å‚è€ƒåé¢çš„å¸§ï¼Œæ‰€ä»¥è§£ç å™¨å¤„ç†å¸§çš„é¡ºåºï¼ˆè§£ç é¡ºåºï¼‰å¯èƒ½ä¸æœ€ç»ˆå±å¹•ä¸Šæ’­æ”¾çš„é¡ºåºï¼ˆæ˜¾ç¤ºé¡ºåºï¼‰ä¸åŒã€‚è§£ç å™¨éœ€è¦å…ˆè§£ç  B å¸§æ‰€ä¾èµ–çš„åé¢çš„å‚è€ƒå¸§ï¼Œç„¶åæ‰èƒ½è§£ç  B å¸§æœ¬èº«ï¼Œä¸Šè¿°è§†é¢‘å¸§åœ¨è§£ç ä¸æ˜¾ç¤ºè§†é¢‘æ—¶å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p></blockquote><p><img src="/2025/04/07/ffmpeg-problem-video/keyframe.png" class="lazyload placeholder" data-srcset="/2025/04/07/ffmpeg-problem-video/keyframe.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="ä¸»è¦åŠŸèƒ½åŠæ„æˆ">ä¸»è¦åŠŸèƒ½åŠæ„æˆ</h2><h3 id="åŠŸèƒ½">åŠŸèƒ½</h3><ol><li><strong>æ ¼å¼è½¬æ¢ (Transcoding / Format Conversion):</strong> FFmpeg æœ€å¸¸ç”¨çš„åŠŸèƒ½ä¹‹ä¸€ã€‚å®ƒå¯ä»¥è½»æ¾åœ°å°†è§†é¢‘æˆ–éŸ³é¢‘æ–‡ä»¶ä»ä¸€ç§æ ¼å¼è½¬æ¢ä¸ºå¦ä¸€ç§æ ¼å¼ï¼ˆä¾‹å¦‚ï¼ŒMP4 è½¬ AVIï¼ŒWAV è½¬ MP3ï¼‰ã€‚</li><li><strong>ç¼–ç ä¸è§£ç  (Encoding / Decoding):</strong> æ”¯æŒå‡ ä¹æ‰€æœ‰å·²çŸ¥çš„éŸ³é¢‘å’Œè§†é¢‘ç¼–è§£ç å™¨ï¼ˆCodecsï¼‰ã€‚ä½ å¯ä»¥ç”¨å®ƒæ¥å‹ç¼©åª’ä½“æ–‡ä»¶ï¼ˆç¼–ç ï¼‰æˆ–æ’­æ”¾/å¤„ç†å®ƒä»¬ï¼ˆè§£ç ï¼‰ã€‚</li><li><strong>å°è£…ä¸è§£å°è£… (Muxing / Demuxing):</strong> å¯ä»¥å°†å•ç‹¬çš„éŸ³é¢‘æµå’Œè§†é¢‘æµåˆå¹¶åˆ°ä¸€ä¸ªå®¹å™¨æ–‡ä»¶ï¼ˆå¦‚ MP4, MKVï¼‰ä¸­ï¼ˆå°è£…ï¼‰ï¼Œæˆ–è€…ä»ä¸€ä¸ªå®¹å™¨æ–‡ä»¶ä¸­æå–å‡ºå•ç‹¬çš„éŸ³é¢‘ã€è§†é¢‘æˆ–å­—å¹•æµï¼ˆè§£å°è£…ï¼‰ã€‚</li><li><strong>æµåª’ä½“å¤„ç† (Streaming):</strong> FFmpeg å¯ä»¥æ•æ‰ã€ç¼–ç å¹¶å°†éŸ³è§†é¢‘æµå®æ—¶æ¨é€åˆ°æµåª’ä½“æœåŠ¡å™¨ï¼ˆå¦‚ RTMP, HLSï¼‰ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºå®¢æˆ·ç«¯æ¥æ”¶å’Œå¤„ç†æµã€‚</li><li><strong>ç¼–è¾‘ä¸å¤„ç† (Editing &amp; Filtering):</strong><ul><li><strong>è£å‰ª (Cropping):</strong> æˆªå–è§†é¢‘ç”»é¢çš„ç‰¹å®šåŒºåŸŸã€‚</li><li><strong>ç¼©æ”¾ (Scaling):</strong> æ”¹å˜è§†é¢‘åˆ†è¾¨ç‡ã€‚</li><li><strong>æ—‹è½¬/ç¿»è½¬ (Rotating/Flipping):</strong> è°ƒæ•´è§†é¢‘æ–¹å‘ã€‚</li><li><strong>åˆå¹¶/åˆ†å‰² (Concatenating/Splitting):</strong> è¿æ¥æˆ–åˆ‡åˆ†åª’ä½“æ–‡ä»¶ã€‚</li><li><strong>æ·»åŠ æ°´å°/å­—å¹• (Watermarking/Subtitles):</strong> åœ¨è§†é¢‘ä¸Šå åŠ å›¾ç‰‡æˆ–æ–‡å­—ã€‚</li><li><strong>è°ƒæ•´é€Ÿåº¦ (Speed Adjustment):</strong> å¿«æ”¾æˆ–æ…¢æ”¾ã€‚</li><li><strong>åº”ç”¨æ»¤é•œ (Applying Filters):</strong> è°ƒæ•´äº®åº¦ã€å¯¹æ¯”åº¦ã€é¥±å’Œåº¦ï¼Œæ·»åŠ æ¨¡ç³Šã€é”åŒ–ç­‰å„ç§è§†è§‰æ•ˆæœï¼Œä»¥åŠéŸ³é¢‘æ•ˆæœå¦‚éŸ³é‡è°ƒæ•´ã€é™å™ªç­‰ã€‚</li></ul></li><li><strong>å±å¹•å½•åˆ¶ä¸è®¾å¤‡æ•æ‰ (Screen Recording &amp; Device Capture):</strong> å¯ä»¥å½•åˆ¶æ¡Œé¢å±å¹•ã€æ‘„åƒå¤´è¾“å…¥æˆ–éº¦å…‹é£éŸ³é¢‘ã€‚</li><li><strong>åª’ä½“ä¿¡æ¯åˆ†æ (Media Information Analysis):</strong> é€šè¿‡ <code>ffprobe</code> å·¥å…·ï¼Œå¯ä»¥è¯¦ç»†åˆ†æåª’ä½“æ–‡ä»¶çš„å„ç§å‚æ•°ï¼Œå¦‚ç¼–ç æ ¼å¼ã€åˆ†è¾¨ç‡ã€æ¯”ç‰¹ç‡ã€å¸§ç‡ã€æ—¶é•¿ç­‰ã€‚</li></ol><h3 id="å…³é”®æµç¨‹è§£è¯»">å…³é”®æµç¨‹è§£è¯»</h3><ul><li>FFmpeg çš„åŸºæœ¬å·¥ä½œæµç¨‹å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå¤„ç†ç®¡çº¿ï¼š</li></ul><blockquote><p>è§£å¤ç”¨ (Demuxing): ffmpeg è¯»å–è¾“å…¥æ–‡ä»¶ (-i input.mkv)ã€‚è§£å¤ç”¨å™¨ (Demuxer) è´Ÿè´£è§£æå®¹å™¨æ ¼å¼ (å¦‚ MKV, MP4, AVI)ï¼Œå¹¶å°†å…¶ä¸­åŒ…å«çš„å„ä¸ªåŸºæœ¬æµ (Elementary Streams, ES) åˆ†ç¦»å‡ºæ¥ï¼Œè¿™äº›æµæ˜¯ç¼–ç è¿‡çš„æ•°æ®åŒ… (Packets)ã€‚</p></blockquote><blockquote><p>è§£ç  (Decoding): å¯¹äºéœ€è¦å¤„ç†æˆ–é‡æ–°ç¼–ç çš„æµï¼Œå…¶æ•°æ®åŒ…ä¼šè¢«é€å…¥ç›¸åº”çš„è§£ç å™¨ (Decoder)ã€‚è§£ç å™¨å°†å‹ç¼©çš„ç¼–ç æ•°æ®è¿˜åŸæˆåŸå§‹çš„ã€æœªå‹ç¼©çš„å¸§ (Frames) - è§†é¢‘å¸§æˆ–éŸ³é¢‘é‡‡æ ·ã€‚å¦‚æœä½¿ç”¨äº† -c copy (æµå¤åˆ¶)ï¼Œåˆ™è·³è¿‡æ­¤æ­¥éª¤ã€‚</p></blockquote><blockquote><p>æ»¤é•œ (Filtering): è§£ç åçš„åŸå§‹å¸§å¯ä»¥è¢«é€å…¥æ»¤é•œå›¾ (Filtergraph) (-vf, -af, -filter_complex) è¿›è¡Œå¤„ç†ã€‚æ»¤é•œå¯ä»¥ä¿®æ”¹å¸§çš„å†…å®¹ï¼Œä¾‹å¦‚ï¼š<br>è§†é¢‘æ»¤é•œï¼šç¼©æ”¾ã€è£å‰ªã€æ—‹è½¬ã€å åŠ æ°´å°ã€è°ƒè‰²ã€å»éš”è¡Œç­‰ã€‚<br>éŸ³é¢‘æ»¤é•œï¼šé‡é‡‡æ ·ã€æ”¹å˜éŸ³é‡ã€æ··éŸ³ã€é™å™ªç­‰ã€‚<br>å¦‚æœæœªä½¿ç”¨æ»¤é•œï¼Œåˆ™è·³è¿‡æ­¤æ­¥éª¤ã€‚</p></blockquote><blockquote><p>ç¼–ç  (Encoding): ç»è¿‡æ»¤é•œå¤„ç†ï¼ˆæˆ–ç›´æ¥æ¥è‡ªè§£ç å™¨ï¼‰çš„åŸå§‹å¸§è¢«é€å…¥æŒ‡å®šçš„ç¼–ç å™¨ (Encoder) (-c:v libx264, -c:a aac ç­‰)ã€‚ç¼–ç å™¨å°†åŸå§‹å¸§å‹ç¼©æˆç¼–ç åçš„æ•°æ®åŒ… (Packets)ã€‚å¦‚æœä½¿ç”¨äº† -c copy (æµå¤åˆ¶)ï¼Œåˆ™è·³è¿‡æ­¤æ­¥éª¤ã€‚</p></blockquote><blockquote><p>å¤ç”¨ (Muxing): ç¼–ç åçš„æ•°æ®åŒ…ï¼ˆæˆ–è€…ä»æµå¤åˆ¶ç›´æ¥è¿‡æ¥çš„æ•°æ®åŒ…ï¼‰è¢«é€å…¥å¤ç”¨å™¨ (Muxer) (-f mp4 ç­‰æŒ‡å®šæ ¼å¼)ã€‚å¤ç”¨å™¨è´Ÿè´£å°†æ¥è‡ªä¸åŒæµçš„æ•°æ®åŒ…æŒ‰ç…§ç›®æ ‡å®¹å™¨æ ¼å¼ (å¦‚ MP4, MKV, FLV) çš„è§„èŒƒï¼Œäº¤ç»‡å†™å…¥åˆ°è¾“å‡ºæ–‡ä»¶ä¸­ (output.mp4)ã€‚</p></blockquote><h3 id="æ„æˆ">æ„æˆ</h3><ul><li><strong><code>ffmpeg</code>:</strong> æ ¸å¿ƒçš„å‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºæ‰§è¡Œä¸Šè¿°å¤§éƒ¨åˆ†çš„è½¬æ¢ã€å¤„ç†ä»»åŠ¡ã€‚</li><li><strong><code>ffplay</code>:</strong> ä¸€ä¸ªåŸºäº SDL å’Œ FFmpeg åº“çš„ç®€å•åª’ä½“æ’­æ”¾å™¨ã€‚</li><li><strong><code>ffprobe</code>:</strong> ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºåˆ†æåª’ä½“æ–‡ä»¶å¹¶ä»¥æ–‡æœ¬ã€JSONã€XML ç­‰å¤šç§æ ¼å¼è¾“å‡ºè¯¦ç»†ä¿¡æ¯ã€‚</li><li><strong><code>libavcodec</code>:</strong> åŒ…å«äº†æ‰€æœ‰éŸ³é¢‘/è§†é¢‘ç¼–ç å™¨å’Œè§£ç å™¨çš„åº“ã€‚</li><li><strong><code>libavformat</code>:</strong> åŒ…å«äº†å¤„ç†å„ç§åª’ä½“å®¹å™¨æ ¼å¼ï¼ˆå°è£…/è§£å°è£…ï¼‰çš„åº“ã€‚</li><li><strong><code>libavfilter</code>:</strong> åŒ…å«äº†å„ç§éŸ³é¢‘å’Œè§†é¢‘æ»¤é•œçš„åº“ã€‚</li><li><strong><code>libswscale</code>:</strong> ç”¨äºå›¾åƒç¼©æ”¾å’Œé¢œè‰²ç©ºé—´/åƒç´ æ ¼å¼è½¬æ¢çš„åº“ã€‚</li><li><strong><code>libswresample</code>:</strong> ç”¨äºéŸ³é¢‘é‡é‡‡æ ·ã€æ ¼å¼è½¬æ¢å’Œé€šé“å¸ƒå±€ç®¡ç†çš„åº“ã€‚</li><li><strong><code>libavutil</code>:</strong> åŒ…å«å„ç§è¾…åŠ©å·¥å…·å‡½æ•°çš„åŸºç¡€åº“ã€‚</li></ul><h2 id="é€‰é¡¹æŒ‡å®š">é€‰é¡¹æŒ‡å®š</h2><ul><li><strong><code>-i url</code></strong>: æŒ‡å®šè¾“å…¥æ–‡ä»¶æˆ–æ¥æºã€‚å¯ä»¥æœ‰å¤šä¸ª <code>-i</code>ã€‚</li><li><strong><code>-f fmt</code></strong>: å¼ºåˆ¶æŒ‡å®šè¾“å‡ºæ–‡ä»¶æ ¼å¼ (å¦‚ <code>-f mp4</code>, <code>-f flv</code>)ã€‚é€šå¸¸ FFmpeg èƒ½æ ¹æ®æ‰©å±•åè‡ªåŠ¨åˆ¤æ–­ï¼Œä½†æœ‰æ—¶éœ€è¦å¼ºåˆ¶æŒ‡å®šã€‚</li><li><strong><code>-map [-]input_file_id[:stream_specifier][?]</code></strong>: <strong>æå…¶é‡è¦</strong>ã€‚ç”¨äºæ‰‹åŠ¨æ§åˆ¶å“ªäº›è¾“å…¥æµè¢«åŒ…å«åˆ°å“ªä¸ªè¾“å‡ºæ–‡ä»¶ä¸­ã€‚<ul><li><code>0:v</code> é€‰æ‹©ç¬¬ä¸€ä¸ªè¾“å…¥æ–‡ä»¶çš„æ‰€æœ‰è§†é¢‘æµã€‚</li><li><code>0:a:1</code> é€‰æ‹©ç¬¬ä¸€ä¸ªè¾“å…¥æ–‡ä»¶çš„ç¬¬äºŒä¸ªéŸ³é¢‘æµ (ç´¢å¼•ä»0å¼€å§‹)ã€‚</li><li><code>1:s?</code> é€‰æ‹©ç¬¬äºŒä¸ªè¾“å…¥æ–‡ä»¶çš„ç¬¬ä¸€ä¸ªå­—å¹•æµï¼ˆå¦‚æœå­˜åœ¨ï¼‰ã€‚</li><li><code>-map 0</code> é€‰æ‹©ç¬¬ä¸€ä¸ªè¾“å…¥æ–‡ä»¶çš„æ‰€æœ‰æµã€‚</li><li><code>-map -0:a</code> ä»è‡ªåŠ¨é€‰æ‹©ä¸­æ’é™¤ç¬¬ä¸€ä¸ªè¾“å…¥æ–‡ä»¶çš„æ‰€æœ‰éŸ³é¢‘æµã€‚</li></ul></li><li><strong><code>-c[:stream_specifier] codec</code></strong>: <strong>æå…¶é‡è¦</strong>ã€‚é€‰æ‹©ç¼–ç å™¨ã€‚<ul><li><code>-c copy</code>: è¿›è¡Œæµå¤åˆ¶ (Stream Copy)ï¼Œä¸é‡æ–°ç¼–ç ã€‚</li><li><code>-c:v libx264</code>: ä¸ºè§†é¢‘æµé€‰æ‹© H.264 (libx264) ç¼–ç å™¨ã€‚</li><li><code>-c:a aac</code>: ä¸ºéŸ³é¢‘æµé€‰æ‹© AAC ç¼–ç å™¨ã€‚</li><li><code>-c:s mov_text</code>: ä¸ºå­—å¹•æµé€‰æ‹© mov_text ç¼–ç å™¨ã€‚</li><li><code>-vn</code>, <code>-an</code>, <code>-sn</code>: åˆ†åˆ«æ˜¯ <code>-c:v copy -an -sn</code>ã€<code>-c:a copy -vn -sn</code>ã€<code>-c:s copy -vn -an</code> çš„ç®€å†™ï¼Œä½†æ›´å¸¸ç”¨çš„å«ä¹‰æ˜¯å®Œå…¨<strong>ç¦ç”¨</strong>è§†é¢‘/éŸ³é¢‘/å­—å¹•çš„å½•åˆ¶/è¾“å‡º (ç›¸å½“äºæ˜ å°„åˆ° /dev/null)ã€‚</li></ul></li><li><strong><code>-t duration</code></strong>: æŒ‡å®šè¾“å‡ºæ–‡ä»¶çš„æ—¶é•¿ã€‚</li><li><strong><code>-to position</code></strong>: æŒ‡å®šè¾“å‡ºæ–‡ä»¶çš„ç»“æŸæ—¶é—´ç‚¹ã€‚</li><li><strong><code>-ss position</code></strong>: æŒ‡å®šè¾“å‡ºæ–‡ä»¶çš„<strong>å¼€å§‹æ—¶é—´ç‚¹</strong> (å¦‚æœæ”¾åœ¨è¾“å‡ºé€‰é¡¹ä½ç½®ï¼Œé€šå¸¸ä¼šè¿›è¡Œç²¾ç¡®æŸ¥æ‰¾ï¼Œä½†å¯èƒ½è¾ƒæ…¢ï¼›æ”¾åœ¨è¾“å…¥é€‰é¡¹ <code>-i</code> ä¹‹å‰åˆ™æŸ¥æ‰¾æ›´å¿«ä½†ä¸ç²¾ç¡®)ã€‚</li><li><strong><code>-vf filtergraph</code></strong>: è®¾ç½®è§†é¢‘æ»¤é•œé“¾ (ç®€å•æ»¤é•œå›¾)ã€‚</li><li><strong><code>-af filtergraph</code></strong>: è®¾ç½®éŸ³é¢‘æ»¤é•œé“¾ (ç®€å•æ»¤é•œå›¾)ã€‚</li><li><strong><code>-filter_complex filtergraph</code></strong>: è®¾ç½®å¤æ‚æ»¤é•œå›¾ï¼Œç”¨äºå¤„ç†å¤šä¸ªè¾“å…¥/è¾“å‡ºæµæˆ–éœ€è¦å¤æ‚è¿æ¥çš„æ»¤é•œã€‚</li><li><strong>æ¯”ç‰¹ç‡/è´¨é‡æ§åˆ¶</strong>:<ul><li><code>-b:v bitrate</code>: è®¾ç½®è§†é¢‘ç›®æ ‡æ¯”ç‰¹ç‡ (å¦‚ <code>-b:v 1M</code> è¡¨ç¤º 1 Mbps)ã€‚</li><li><code>-b:a bitrate</code>: è®¾ç½®éŸ³é¢‘ç›®æ ‡æ¯”ç‰¹ç‡ (å¦‚ <code>-b:a 128k</code> è¡¨ç¤º 128 kbps)ã€‚</li><li><code>-crf value</code> (Constant Rate Factor): æ’å®šè´¨é‡å› å­ï¼Œæ˜¯ x264/x265 ç­‰ç¼–ç å™¨å¸¸ç”¨çš„è´¨é‡æ§åˆ¶æ¨¡å¼ï¼Œæ•°å€¼è¶Šä½è´¨é‡è¶Šå¥½ï¼Œæ–‡ä»¶è¶Šå¤§ã€‚</li><li><code>-q:v value</code> / <code>-qscale:v value</code>: æ§åˆ¶è§†é¢‘è´¨é‡ï¼ˆæŸäº›ç¼–ç å™¨ï¼‰ã€‚</li></ul></li><li><strong>è§†é¢‘é€‰é¡¹</strong>:<ul><li><code>-r fps</code>: è®¾ç½®å¸§ç‡ (å¦‚ <code>-r 25</code>)ã€‚</li><li><code>-s WxH</code>: è®¾ç½®è§†é¢‘åˆ†è¾¨ç‡ (å¦‚ <code>-s 1280x720</code>)ã€‚</li><li><code>-aspect ratio</code>: è®¾ç½®ç”»é¢å®½é«˜æ¯” (å¦‚ <code>-aspect 16:9</code>)ã€‚</li><li><code>-pix_fmt format</code>: è®¾ç½®åƒç´ æ ¼å¼ã€‚</li></ul></li><li><strong>éŸ³é¢‘é€‰é¡¹</strong>:<ul><li><code>-ar freq</code>: è®¾ç½®éŸ³é¢‘é‡‡æ ·ç‡ (å¦‚ <code>-ar 44100</code>)ã€‚</li><li><code>-ac channels</code>: è®¾ç½®éŸ³é¢‘é€šé“æ•° (å¦‚ <code>-ac 2</code> è¡¨ç¤ºç«‹ä½“å£°)ã€‚</li><li><code>-vol volume</code>: è°ƒæ•´éŸ³é‡ (å¦‚ <code>-vol 512</code> è¡¨ç¤º 2 å€éŸ³é‡)ã€‚</li></ul></li></ul><p><strong>æµæŒ‡å®šç¬¦ (Stream Specifiers):</strong></p><p>è¿™æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æœºåˆ¶ï¼Œå…è®¸ä½ å°†é€‰é¡¹ç²¾ç¡®åœ°åº”ç”¨åˆ°ç‰¹å®šçš„æµä¸Šã€‚æ ¼å¼é€šå¸¸æ˜¯ <code>é€‰é¡¹å:æµç±»å‹[:æµç´¢å¼•]</code>ã€‚</p><ul><li><code>-c:v libx264</code>: å°†ç¼–ç å™¨ <code>libx264</code> åº”ç”¨äºæ‰€æœ‰è§†é¢‘æµã€‚</li><li><code>-b:a:1 192k</code>: å°†æ¯”ç‰¹ç‡ <code>192k</code> åº”ç”¨äºç¬¬äºŒä¸ªéŸ³é¢‘æµã€‚</li><li><code>-disposition:s:0 default</code>: å°†ç¬¬ä¸€ä¸ªå­—å¹•æµçš„ disposition è®¾ç½®ä¸º defaultã€‚</li><li><code>-map 0:v -map 0:a:0</code>: é€‰æ‹©ç¬¬ä¸€ä¸ªè¾“å…¥æ–‡ä»¶çš„æ‰€æœ‰è§†é¢‘æµå’Œç¬¬ä¸€ä¸ªéŸ³é¢‘æµã€‚</li></ul><h2 id="é—®é¢˜">é—®é¢˜</h2><h3 id="è§†é¢‘åˆ‡å‰²ä¸­å­˜åœ¨çš„é—®é¢˜">è§†é¢‘åˆ‡å‰²ä¸­å­˜åœ¨çš„é—®é¢˜</h3><ul><li>åˆ‡å‰²è§†é¢‘åå­˜åœ¨å¼€å§‹å‰å‡ ç§’ä¸ºé»‘å±</li></ul><blockquote><p>é—®é¢˜åˆ†æ</p></blockquote><blockquote><p>å¸¸è§çš„åŸå› æ˜¯å‰ªè¾‘çš„èµ·å§‹ç‚¹ (-ss) æ²¡æœ‰è½åœ¨å…³é”®å¸§ (Keyframe / I-frame) ä¸Šã€‚</p></blockquote><blockquote><p>æµæ‹·è´æ¨¡å¼ç›´æ¥å¤åˆ¶è§†é¢‘æ•°æ®åŒ…ï¼Œè€Œä¸è¿›è¡Œè§£ç å’Œé‡æ–°ç¼–ç ã€‚è§†é¢‘æ’­æ”¾å™¨é€šå¸¸éœ€è¦ä»ä¸€ä¸ªå…³é”®å¸§å¼€å§‹è§£ç ï¼Œå¦‚æœå‰ªè¾‘åçš„è§†é¢‘ç‰‡æ®µå¼€å¤´ä¸æ˜¯å…³é”®å¸§ï¼Œè€Œæ˜¯ P å¸§æˆ– B å¸§ï¼ˆå®ƒä»¬ä¾èµ–äºä¹‹å‰çš„å¸§è¿›è¡Œè§£ç ï¼‰ï¼Œæ’­æ”¾å™¨å°±æ— æ³•æ­£ç¡®æ˜¾ç¤ºç”»é¢ï¼Œå¯¼è‡´é»‘å±æˆ–èŠ±å±ï¼Œç›´åˆ°é‡åˆ°ç¬¬ä¸€ä¸ªå…³é”®å¸§ä¸ºæ­¢ï¼›é‡æ–°ç¼–ç å¯è§£å†³æ­¤é—®é¢˜ã€‚</p></blockquote><ul><li>æŒ‰ç…§nç§’åˆ‡å‰²ï¼Œå¤§æ‰¹é‡åˆ‡å‰²æ—¶å­˜åœ¨ï¼šn-1æˆ–n+1ç§’è§†é¢‘å­˜åœ¨</li></ul><blockquote><p>é—®é¢˜åˆ†æ</p></blockquote><ol><li><strong>æµæ‹·è´ (<code>-c copy</code>)</strong>: æ­¤æ¨¡å¼ä¸è§£ç å’Œé‡æ–°ç¼–ç è§†é¢‘ã€‚å®ƒç›´æ¥å¤åˆ¶åŸå§‹è§†é¢‘æµçš„æ•°æ®åŒ…ã€‚</li><li><strong>å…³é”®å¸§ (Keyframes)</strong>: è§†é¢‘å‹ç¼©ï¼ˆå¦‚ H.264, H.265ï¼‰ä¾èµ–äºå…³é”®å¸§ã€‚åªæœ‰å…³é”®å¸§å¯ä»¥ç‹¬ç«‹è§£ç ï¼Œåç»­çš„ P å¸§å’Œ B å¸§éœ€è¦ä¾èµ–å…³é”®å¸§æˆ–å…¶ä»–å¸§æ‰èƒ½è§£ç ã€‚å› æ­¤ï¼Œä¸€ä¸ªç‹¬ç«‹çš„ã€å¯æ’­æ”¾çš„è§†é¢‘ç‰‡æ®µ<strong>å¿…é¡»</strong>ä»¥å…³é”®å¸§å¼€å§‹ã€‚</li><li><strong>åˆ†å‰²ç‚¹</strong>: å½“æŒ‡å®šæŒ‰ <code>n</code> ç§’åˆ†å‰²æ—¶ï¼Œ<code>ffmpeg</code>ï¼ˆç‰¹åˆ«æ˜¯ä½¿ç”¨ <code>segment</code> muxer æˆ–ç±»ä¼¼çš„åˆ‡å‰²é€»è¾‘é…åˆ <code>-c copy</code> æ—¶ï¼‰ä¼šå¯»æ‰¾æ—¶é—´æˆ³æ¥è¿‘ <code>n</code>, <code>2n</code>, <code>3n</code>â€¦ çš„ä½ç½®ã€‚ä½†æ˜¯ï¼Œä¸ºäº†ç¡®ä¿è¾“å‡ºçš„æ¯ä¸ªç‰‡æ®µéƒ½èƒ½ç‹¬ç«‹æ’­æ”¾ï¼Œå®ƒ<strong>ä¸èƒ½</strong>åœ¨ä»»æ„å¸§ï¼ˆå¦‚ P å¸§æˆ– B å¸§ï¼‰å¤„åˆ‡å‰²ï¼Œè€Œå¿…é¡»åœ¨åˆ†å‰²ç‚¹<strong>ä¹‹å‰æˆ–ä¹‹åæœ€è¿‘çš„å…³é”®å¸§</strong>å¤„è¿›è¡Œå®é™…åˆ‡å‰²ã€‚</li><li><strong>æ—¶é•¿åå·®</strong>:<ul><li>å¦‚æœ <code>n</code> ç§’å¤„æ°å¥½æ˜¯å…³é”®å¸§ï¼Œé‚£ä¹ˆåˆ†å‰²å¯èƒ½æ¯”è¾ƒå‡†ç¡®ã€‚</li><li>å¦‚æœ <code>n</code> ç§’å¤„ä¸æ˜¯å…³é”®å¸§ï¼Œ<code>ffmpeg</code> é€šå¸¸ä¼šå›æº¯åˆ°<strong>ä¹‹å‰</strong>çš„é‚£ä¸ªå…³é”®å¸§ä½œä¸ºä¸Šä¸€ä¸ªç‰‡æ®µçš„ç»“æŸç‚¹ï¼Œå¹¶ä»è¿™ä¸ªå…³é”®å¸§å¼€å§‹æ–°çš„ç‰‡æ®µã€‚</li><li>è¿™å°±å¯¼è‡´äº†å®é™…åˆ†å‰²ç‚¹ä¸ç†è®ºä¸Šçš„ <code>n</code> ç§’ç‚¹æœ‰åå·®ã€‚è¿™ä¸ªåå·®å–å†³äºå…³é”®å¸§ä¹‹é—´çš„è·ç¦»ï¼ˆGOP sizeï¼‰ã€‚å¦‚æœå…³é”®å¸§é—´éš”å¾ˆå¤§ï¼ˆæ¯”å¦‚ 10 ç§’ï¼‰ï¼Œåå·®å¯èƒ½ä¼šå¾ˆæ˜æ˜¾ã€‚å¦‚æœå…³é”®å¸§é—´éš”å°ï¼ˆæ¯”å¦‚ 1 ç§’ï¼‰ï¼Œåå·®é€šå¸¸è¾ƒå°ï¼Œä½†ä»å¯èƒ½å¯¼è‡´ <code>n-1</code> æˆ– <code>n+1</code> ç§’çš„æƒ…å†µã€‚</li></ul></li></ol><ul><li>command å¦‚ä¸‹ï¼š</li></ul> <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">command</span> = [</span><br><span class="line">    <span class="string">&#x27;ffmpeg&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-i&#x27;</span>, str(input_path),         <span class="comment"># Input file</span></span><br><span class="line">    <span class="string">&#x27;-ss&#x27;</span>, start_timecode_str,     <span class="comment"># Start time</span></span><br><span class="line">    <span class="string">&#x27;-to&#x27;</span>, end_timecode_str,       <span class="comment"># End time</span></span><br><span class="line">    <span class="string">&#x27;-copyts&#x27;</span>,                     <span class="comment"># Copy timestamps</span></span><br><span class="line">    <span class="string">&#x27;-avoid_negative_ts&#x27;</span>, <span class="string">&#x27;make_zero&#x27;</span>, <span class="comment"># Handle timestamp issues</span></span><br><span class="line">    <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;copy&#x27;</span>,                  <span class="comment"># Copy codecs (no re-encoding)</span></span><br><span class="line">    <span class="string">&#x27;-y&#x27;</span>,                          <span class="comment"># Overwrite output file if it exists</span></span><br><span class="line">    str(output_path)               <span class="comment"># Output file</span></span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>ä½¿ç”¨ä¸Šè¿°commandåˆ‡å‰²è§†é¢‘åå­˜åœ¨é»‘å±ã€åˆ†æ®µè§†é¢‘æ—¶é•¿å°äºç›®æ ‡æ—¶é•¿é—®é¢˜ commandé‡‡ç”¨copyè§†é¢‘æµ</p></blockquote><ul><li>æ›´æ¢ä»¥ä¸‹command é‡æ–°ç¼–ç è§†é¢‘æµ</li></ul> <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">command</span> = [</span><br><span class="line">    ffmpeg_path,</span><br><span class="line">    <span class="string">&#x27;-y&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-ss&#x27;</span>, str(start_segment_time),</span><br><span class="line">    <span class="string">&#x27;-i&#x27;</span>, video_file,</span><br><span class="line">    <span class="string">&#x27;-t&#x27;</span>, str(end_segment_time - start_segment_time),</span><br><span class="line">    <span class="string">&#x27;-c:v&#x27;</span>, <span class="string">&#x27;h264_nvenc&#x27;</span> <span class="keyword">if</span> gpu_available <span class="keyword">else</span> <span class="string">&#x27;libx264&#x27;</span>, <span class="comment"># ä½¿ç”¨NVIDIA GPUåŠ é€Ÿçš„ç¼–ç å™¨, å¦‚æœæ²¡æœ‰GPUï¼Œåˆ™ä½¿ç”¨CPU</span></span><br><span class="line">    <span class="string">&#x27;-preset&#x27;</span>, preset,</span><br><span class="line">    <span class="string">&#x27;-crf&#x27;</span>, str(crf),  <span class="comment"># æŒ‡å®šè§†è§‰è´¨é‡</span></span><br><span class="line">    <span class="string">&#x27;-pix_fmt&#x27;</span>, <span class="string">&#x27;yuv420p&#x27;</span>,  <span class="comment"># æŒ‡å®šåƒç´ æ ¼å¼</span></span><br><span class="line">    <span class="string">&#x27;-c:a&#x27;</span>, <span class="string">&#x27;copy&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-avoid_negative_ts&#x27;</span>, <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    output_file</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h2 id="ffmpeg-è½¬ç ">ffmpeg è½¬ç </h2><ul><li>è½¬ç è¿‡ç¨‹å¦‚ä¸‹</li></ul><blockquote><p>è½¬ç æ˜¯æŒ‡å…ˆè§£ç  (decode) ä¸€ä¸ªæµå¾—åˆ°åŸå§‹æ•°æ®ï¼ˆå¦‚è§†é¢‘å¸§æˆ–éŸ³é¢‘æ ·æœ¬ï¼‰ï¼Œç„¶åå†ç”¨æŒ‡å®šçš„ç¼–ç å™¨é‡æ–°ç¼–ç  (encode) è¿™äº›æ•°æ®çš„è¿‡ç¨‹</p></blockquote><p><img src="/2025/04/07/ffmpeg-problem-video/decode.png" class="lazyload placeholder" data-srcset="/2025/04/07/ffmpeg-problem-video/decode.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li>å¤åˆ¶æ•°æ®æµï¼ˆæµå¤åˆ¶ï¼‰</li></ul><blockquote><p>æµå¤åˆ¶æ˜¯æŒ‡ç›´æ¥ä»è¾“å…¥æ–‡ä»¶ä¸­â€œæå–â€åª’ä½“æµï¼ˆå¦‚è§†é¢‘æµã€éŸ³é¢‘æµï¼‰çš„æ•°æ®åŒ… (packets)ï¼Œç„¶ååŸå°ä¸åŠ¨åœ°å°†è¿™äº›æ•°æ®åŒ…â€œæ”¾å…¥â€è¾“å‡ºæ–‡ä»¶ä¸­ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸ç»è¿‡è§£ç å’Œé‡æ–°ç¼–ç ã€‚</p></blockquote><blockquote><p>å›¾ä¸­ç”¨æµå¤åˆ¶åˆå¹¶è§†é¢‘ä¸éŸ³é¢‘æµ æµå¤åˆ¶å¯ç”¨äºåˆå¹¶ã€åˆ†å‰²ã€æå–æ•°æ®æµ</p></blockquote><p><img src="/2025/04/07/ffmpeg-problem-video/encode.png" class="lazyload placeholder" data-srcset="/2025/04/07/ffmpeg-problem-video/encode.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><ul><li>æµå¤åˆ¶ç”¨äºè§†é¢‘åˆ†å‰²è¿‡ç¨‹</li></ul><blockquote><p>demuxer åˆ†ç¦»å‡ºä¸¤ä¸ªæµï¼Œæµ 0 è¢«é€åˆ° muxer 0 ç”Ÿæˆ OUTPUT0.mp4ï¼Œæµ 1 è¢«é€åˆ° muxer 1 ç”Ÿæˆ OUTPUT1.mp4</p></blockquote><p><img src="/2025/04/07/ffmpeg-problem-video/encode_split.png" class="lazyload placeholder" data-srcset="/2025/04/07/ffmpeg-problem-video/encode_split.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="å‚è€ƒ">å‚è€ƒ</h2><ul><li>1.<a href="https://www.ffmpeg.org/ffmpeg.html">https://www.ffmpeg.org/ffmpeg.html</a></li><li>2.<a href="https://www.ffmpeg.org/ffprobe.html">https://www.ffmpeg.org/ffprobe.html</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;èƒŒæ™¯&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;ffmpeg is a universal media converter. It can read a wide variety of inputs - including live grabbing/re</summary>
      
    
    
    
    
    <category term="python" scheme="https://caozhaoqi.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>è§†é¢‘åœºæ™¯åˆ‡æ¢æ£€æµ‹</title>
    <link href="https://caozhaoqi.github.io/2025/04/03/video-secene-detect/"/>
    <id>https://caozhaoqi.github.io/2025/04/03/video-secene-detect/</id>
    <published>2025-04-03T06:02:33.000Z</published>
    <updated>2025-11-25T15:05:10.374Z</updated>
    
    <content type="html"><![CDATA[<h2 id="èƒŒæ™¯">èƒŒæ™¯</h2><p>ä¸€ä¸ªæ‘„åƒæœºè¿ç»­æ‹æ‘„çš„ä¸€æ®µè§†é¢‘ç‰‡æ®µï¼Œæ²¡æœ‰è¿›è¡Œä¸­æ–­ã€‚ä¸€ä¸ªé•œå¤´é€šå¸¸æ˜¯è§†é¢‘å™äº‹çš„åŸºæœ¬å•ä½ã€‚</p><p><strong>2. é•œå¤´è¯†åˆ«çš„æ„ä¹‰ï¼š</strong></p><ul><li><strong>è§†é¢‘åˆ†æå’Œç†è§£ï¼š</strong> é•œå¤´è¯†åˆ«æ˜¯è§†é¢‘åˆ†æå’Œç†è§£çš„åŸºç¡€ï¼Œå¯ä»¥å¸®åŠ©æå–è§†é¢‘å†…å®¹ï¼Œè¿›è¡Œç»“æ„åŒ–åˆ†æï¼Œä¾‹å¦‚åœºæ™¯æ£€æµ‹ã€æ•…äº‹åˆ†å‰²ç­‰ã€‚</li><li><strong>è§†é¢‘æ£€ç´¢ï¼š</strong> å¯ä»¥ç”¨äºåŸºäºå†…å®¹çš„è§†é¢‘æ£€ç´¢ï¼Œä¾‹å¦‚æŸ¥æ‰¾åŒ…å«ç‰¹å®šå¯¹è±¡çš„é•œå¤´ã€‚</li><li><strong>è§†é¢‘æ‘˜è¦ï¼š</strong> å¯ä»¥ç”¨äºç”Ÿæˆè§†é¢‘æ‘˜è¦ï¼Œé€‰å–å…³é”®é•œå¤´æ¥ä»£è¡¨è§†é¢‘å†…å®¹ã€‚</li><li><strong>è§†é¢‘ç¼–è¾‘ï¼š</strong> æ–¹ä¾¿è§†é¢‘ç¼–è¾‘äººå‘˜å¯¹è§†é¢‘è¿›è¡Œåˆ†å‰²ã€é‡ç»„ç­‰æ“ä½œã€‚</li><li><strong>è§†é¢‘ç›‘æ§ï¼š</strong> å¼‚å¸¸äº‹ä»¶æ£€æµ‹ï¼Œè¡Œä¸ºåˆ†æç­‰ã€‚</li></ul><p><strong>3. é•œå¤´è¯†åˆ«çš„ä¸»è¦æ–¹æ³•ï¼š</strong></p><p>é•œå¤´è¯†åˆ«ä¸»è¦åŸºäºåˆ†æè¿ç»­å¸§ä¹‹é—´çš„å˜åŒ–ï¼Œé€šè¿‡æ£€æµ‹åœºæ™¯è¾¹ç•Œæ¥è¯†åˆ«é•œå¤´ã€‚å¸¸è§çš„æ–¹æ³•åŒ…æ‹¬ï¼š</p><ul><li><strong>åŸºäºé˜ˆå€¼çš„é•œå¤´è¯†åˆ«ï¼š</strong><ul><li><strong>åŸç†ï¼š</strong> é€šè¿‡è®¡ç®—è¿ç»­å¸§ä¹‹é—´çš„å·®å¼‚ï¼ˆä¾‹å¦‚é¢œè‰²ç›´æ–¹å›¾å·®å¼‚ã€åƒç´ å·®å¼‚ã€è¾¹ç¼˜å·®å¼‚ç­‰ï¼‰ï¼Œå½“å·®å¼‚å€¼è¶…è¿‡é¢„è®¾çš„é˜ˆå€¼æ—¶ï¼Œåˆ™è®¤ä¸ºå‘ç”Ÿäº†é•œå¤´åˆ‡æ¢ã€‚</li><li><strong>ä¼˜ç‚¹ï¼š</strong> ç®€å•å¿«é€Ÿï¼Œæ˜“äºå®ç°ã€‚</li><li><strong>ç¼ºç‚¹ï¼š</strong> å¯¹é˜ˆå€¼çš„é€‰æ‹©æ•æ„Ÿï¼Œå®¹æ˜“å—åˆ°å…‰ç…§å˜åŒ–ã€è¿åŠ¨ç­‰å› ç´ çš„å½±å“ã€‚</li></ul></li><li><strong>åŸºäºç»Ÿè®¡æ¨¡å‹çš„é•œå¤´è¯†åˆ«ï¼š</strong><ul><li><strong>åŸç†ï¼š</strong> ä½¿ç”¨ç»Ÿè®¡æ¨¡å‹ï¼ˆä¾‹å¦‚éšé©¬å°”å¯å¤«æ¨¡å‹ HMMï¼‰æ¥æè¿°è§†é¢‘å¸§çš„ç‰¹å¾å˜åŒ–ï¼Œé€šè¿‡æ£€æµ‹æ¨¡å‹çŠ¶æ€çš„å˜åŒ–æ¥è¯†åˆ«é•œå¤´ã€‚</li><li><strong>ä¼˜ç‚¹ï¼š</strong> å¯¹å™ªå£°å’Œå…‰ç…§å˜åŒ–å…·æœ‰ä¸€å®šçš„é²æ£’æ€§ã€‚</li><li><strong>ç¼ºç‚¹ï¼š</strong> æ¨¡å‹è®­ç»ƒéœ€è¦å¤§é‡çš„æ ‡æ³¨æ•°æ®ï¼Œè®¡ç®—å¤æ‚åº¦è¾ƒé«˜ã€‚</li></ul></li><li><strong>åŸºäºæœºå™¨å­¦ä¹ å’Œæ·±åº¦å­¦ä¹ çš„é•œå¤´è¯†åˆ«ï¼š</strong><ul><li><strong>åŸç†ï¼š</strong> ä½¿ç”¨æœºå™¨å­¦ä¹ æˆ–æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼ˆä¾‹å¦‚æ”¯æŒå‘é‡æœº SVMã€å·ç§¯ç¥ç»ç½‘ç»œ CNNã€å¾ªç¯ç¥ç»ç½‘ç»œ RNNï¼‰æ¥å­¦ä¹ è§†é¢‘å¸§çš„ç‰¹å¾ï¼Œå¹¶å¯¹é•œå¤´è¾¹ç•Œè¿›è¡Œåˆ†ç±»ã€‚</li><li><strong>ä¼˜ç‚¹ï¼š</strong> å¯ä»¥å­¦ä¹ å¤æ‚çš„ç‰¹å¾è¡¨ç¤ºï¼Œå…·æœ‰è¾ƒé«˜çš„è¯†åˆ«ç²¾åº¦ã€‚</li><li><strong>ç¼ºç‚¹ï¼š</strong> éœ€è¦å¤§é‡çš„æ ‡æ³¨æ•°æ®è¿›è¡Œè®­ç»ƒï¼Œè®¡ç®—èµ„æºéœ€æ±‚è¾ƒé«˜ã€‚</li></ul></li></ul><p><strong>4. å…·ä½“æ­¥éª¤ï¼š</strong></p><ol><li><strong>è§†é¢‘é¢„å¤„ç†ï¼š</strong><ul><li><strong>è§£ç ï¼š</strong> å°†è§†é¢‘æ–‡ä»¶è§£ç ä¸ºå¸§åºåˆ—ã€‚</li><li><strong>é™å™ªï¼š</strong> å¯¹å¸§åºåˆ—è¿›è¡Œé™å™ªå¤„ç†ï¼Œä¾‹å¦‚ä½¿ç”¨é«˜æ–¯æ»¤æ³¢æˆ–ä¸­å€¼æ»¤æ³¢ã€‚</li><li><strong>è°ƒæ•´å¤§å°ï¼š</strong> å°†å¸§åºåˆ—è°ƒæ•´åˆ°ç»Ÿä¸€çš„å¤§å°ï¼Œä»¥ä¾¿è¿›è¡Œåç»­å¤„ç†ã€‚</li></ul></li><li><strong>ç‰¹å¾æå–ï¼š</strong>  æå–è§†é¢‘å¸§çš„ç‰¹å¾ï¼Œç”¨äºæè¿°è§†é¢‘å†…å®¹ã€‚å¸¸ç”¨çš„ç‰¹å¾åŒ…æ‹¬ï¼š<ul><li><strong>é¢œè‰²ç›´æ–¹å›¾ï¼š</strong>  æè¿°å›¾åƒçš„é¢œè‰²åˆ†å¸ƒã€‚</li><li><strong>ç°åº¦å…±ç”ŸçŸ©é˜µ (GLCM)ï¼š</strong> æè¿°å›¾åƒçš„çº¹ç†ç‰¹å¾ã€‚</li><li><strong>å…‰æµï¼š</strong> æè¿°å›¾åƒä¸­ç‰©ä½“çš„è¿åŠ¨ä¿¡æ¯ã€‚</li><li><strong>å±€éƒ¨äºŒå€¼æ¨¡å¼ (LBP)ï¼š</strong> æè¿°å›¾åƒçš„å±€éƒ¨çº¹ç†ç‰¹å¾ã€‚</li><li><strong>æ·±åº¦å­¦ä¹ ç‰¹å¾ï¼š</strong> ä½¿ç”¨é¢„è®­ç»ƒçš„æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼ˆä¾‹å¦‚ VGGNetã€ResNetï¼‰æå–å›¾åƒçš„ç‰¹å¾ã€‚</li></ul></li><li><strong>å·®å¼‚è®¡ç®—ï¼š</strong>  è®¡ç®—è¿ç»­å¸§ä¹‹é—´çš„å·®å¼‚ã€‚ å¸¸ç”¨çš„å·®å¼‚è®¡ç®—æ–¹æ³•åŒ…æ‹¬ï¼š<ul><li><strong>æ¬§æ°è·ç¦»ï¼š</strong>  è®¡ç®—ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„è·ç¦»ã€‚</li><li><strong>ä½™å¼¦ç›¸ä¼¼åº¦ï¼š</strong> è®¡ç®—ä¸¤ä¸ªå‘é‡ä¹‹é—´çš„è§’åº¦ã€‚</li><li><strong>å¡æ–¹è·ç¦»ï¼š</strong>  è®¡ç®—ä¸¤ä¸ªç›´æ–¹å›¾ä¹‹é—´çš„è·ç¦»ã€‚</li></ul></li><li><strong>é•œå¤´è¾¹ç•Œæ£€æµ‹ï¼š</strong><ul><li><strong>é˜ˆå€¼æ³•ï¼š</strong>  å½“å·®å¼‚å€¼è¶…è¿‡é¢„è®¾çš„é˜ˆå€¼æ—¶ï¼Œåˆ™è®¤ä¸ºå‘ç”Ÿäº†é•œå¤´åˆ‡æ¢ã€‚</li><li><strong>æœºå™¨å­¦ä¹ æ–¹æ³•ï¼š</strong>  ä½¿ç”¨æœºå™¨å­¦ä¹ æ¨¡å‹å¯¹é•œå¤´è¾¹ç•Œè¿›è¡Œåˆ†ç±»ã€‚</li></ul></li><li><strong>åå¤„ç†ï¼š</strong><ul><li><strong>åˆå¹¶çŸ­é•œå¤´ï¼š</strong>  å°†é•¿åº¦å°äºä¸€å®šé˜ˆå€¼çš„é•œå¤´åˆå¹¶åˆ°ç›¸é‚»çš„é•œå¤´ä¸­ã€‚</li><li><strong>å¹³æ»‘é•œå¤´è¾¹ç•Œï¼š</strong>  å¯¹é•œå¤´è¾¹ç•Œè¿›è¡Œå¹³æ»‘å¤„ç†ï¼Œä»¥æé«˜è§†é¢‘è§‚çœ‹ä½“éªŒã€‚</li></ul></li></ol><p><strong>5. æŠ€æœ¯ç»†èŠ‚:</strong></p><ul><li><strong>å¸§é€Ÿç‡ï¼ˆFrame Rateï¼‰ï¼š</strong> å½±å“åˆ†æçš„ç²¾åº¦å’Œè®¡ç®—æˆæœ¬ã€‚é«˜å¸§é€Ÿç‡æä¾›æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼Œä½†ä¹Ÿéœ€è¦æ›´å¤šçš„è®¡ç®—èµ„æºã€‚</li><li><strong>ç‰¹å¾é€‰æ‹©ï¼š</strong> é€‰æ‹©åˆé€‚çš„ç‰¹å¾å¯¹é•œå¤´è¯†åˆ«çš„ç²¾åº¦è‡³å…³é‡è¦ã€‚ ä¾‹å¦‚ï¼Œå¯¹äºå¿«é€Ÿè¿åŠ¨çš„åœºæ™¯ï¼Œå…‰æµç‰¹å¾å¯èƒ½æ›´æœ‰æ•ˆã€‚</li><li><strong>é˜ˆå€¼è®¾å®šï¼š</strong> é˜ˆå€¼çš„è®¾å®šéœ€è¦æ ¹æ®å…·ä½“çš„è§†é¢‘å†…å®¹è¿›è¡Œè°ƒæ•´ã€‚</li><li><strong>æ·±åº¦å­¦ä¹ æ¨¡å‹çš„é€‰æ‹©ï¼š</strong> é€‰æ‹©åˆé€‚çš„æ·±åº¦å­¦ä¹ æ¨¡å‹éœ€è¦æ ¹æ®å…·ä½“çš„åº”ç”¨åœºæ™¯è¿›è¡Œè€ƒè™‘ã€‚</li></ul><h2 id="å®ç°æŠ€æœ¯">å®ç°æŠ€æœ¯</h2><ul><li><strong>OpenCV:</strong>  ä¸€ä¸ªå¼ºå¤§çš„è®¡ç®—æœºè§†è§‰åº“ï¼Œæä¾›äº†å›¾åƒå¤„ç†ã€ç‰¹å¾æå–ã€è§†é¢‘åˆ†æç­‰åŠŸèƒ½ã€‚</li><li><strong>FFmpeg:</strong>  ä¸€ä¸ªå¼€æºçš„å¤šåª’ä½“æ¡†æ¶ï¼Œå¯ä»¥ç”¨äºè§†é¢‘è§£ç ã€ç¼–ç ã€æ ¼å¼è½¬æ¢ç­‰æ“ä½œã€‚</li><li><strong>Scikit-learn:</strong>  ä¸€ä¸ªæµè¡Œçš„æœºå™¨å­¦ä¹ åº“ï¼Œæä¾›äº†å„ç§æœºå™¨å­¦ä¹ ç®—æ³•ã€‚</li><li><strong>TensorFlow/PyTorch:</strong>  æ·±åº¦å­¦ä¹ æ¡†æ¶ï¼Œå¯ä»¥ç”¨äºæ„å»ºå’Œè®­ç»ƒæ·±åº¦å­¦ä¹ æ¨¡å‹ã€‚</li><li><strong>PySceneDetect:</strong> ä¸€ä¸ªä¸“é—¨ç”¨äºåœºæ™¯åˆ†å‰²ï¼ˆå³é•œå¤´è¯†åˆ«ï¼‰çš„Pythonåº“ï¼Œå®ƒåŸºäºOpenCVå’ŒNumPyã€‚</li></ul><h2 id="æŠ€æœ¯é€‰æ‹©">æŠ€æœ¯é€‰æ‹©</h2><p><strong>PySceneDetect:</strong></p><ul><li><strong>æè¿°:</strong> PySceneDetect æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äºåœºæ™¯åˆ†å‰²çš„ Python åº“ï¼Œå®ƒæ„å»ºåœ¨ OpenCV å’Œ NumPy ä¹‹ä¸Šã€‚å®ƒæä¾›äº†å¤šç§åœºæ™¯æ£€æµ‹ç®—æ³•ï¼ŒåŒ…æ‹¬åŸºäºå†…å®¹çš„æ¯”è¾ƒï¼ˆContentDetectorï¼‰ã€é˜ˆå€¼æ£€æµ‹ï¼ˆThresholdDetectorï¼‰ç­‰ã€‚</li><li><strong>ä¼˜ç‚¹:</strong><ul><li>æ˜“äºä½¿ç”¨ï¼šæä¾›äº†ç®€å•çš„ APIï¼Œæ–¹ä¾¿å¿«é€Ÿä¸Šæ‰‹ã€‚</li><li>å¤šç§ç®—æ³•ï¼šå†…ç½®äº†å¤šç§åœºæ™¯æ£€æµ‹ç®—æ³•ï¼Œå¯ä»¥æ ¹æ®è§†é¢‘å†…å®¹é€‰æ‹©åˆé€‚çš„ç®—æ³•ã€‚</li><li>å¯å®šåˆ¶æ€§ï¼šå…è®¸è‡ªå®šä¹‰åœºæ™¯æ£€æµ‹ç®—æ³•ã€‚</li><li>æ–‡æ¡£å®Œå–„ï¼šæ‹¥æœ‰æ¯”è¾ƒå®Œå–„çš„æ–‡æ¡£ã€‚</li></ul></li><li><strong>ç¼ºç‚¹:</strong><ul><li>æ€§èƒ½ï¼šå¯¹äºéå¸¸å¤§çš„è§†é¢‘ï¼Œå¯èƒ½éœ€è¦ä¼˜åŒ–æ€§èƒ½ã€‚</li><li>ç²¾åº¦ï¼šé»˜è®¤å‚æ•°å¯èƒ½ä¸é€‚ç”¨äºæ‰€æœ‰ç±»å‹çš„è§†é¢‘ï¼Œéœ€è¦è°ƒæ•´å‚æ•°ã€‚</li></ul></li></ul><h2 id="ç¬¬ä¸‰æ–¹åº“å®‰è£…ä½¿ç”¨">ç¬¬ä¸‰æ–¹åº“å®‰è£…ä½¿ç”¨</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install scenedetect opencv-python tqdm</span><br></pre></td></tr></table></figure><h3 id="ç®€æ˜“demo">ç®€æ˜“demo</h3><ul><li>æ£€æµ‹è§†é¢‘ä¸­çš„åœºæ™¯åˆ‡æ¢å¸§ï¼Œè¾“å‡ºå›¾ç‰‡ä¸csvæ–‡ä»¶</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scenedetect --input goldeneye.mp4 detect-adaptive list-scenes save-images</span><br></pre></td></tr></table></figure><h3 id="å…³äºåœºæ™¯åˆ‡æ¢æ£€æµ‹é˜ˆå€¼çš„ç¡®è®¤">å…³äºåœºæ™¯åˆ‡æ¢æ£€æµ‹é˜ˆå€¼çš„ç¡®è®¤</h3><blockquote><p>ä¾‹å¦‚ï¼Œå¯¹äºdetect-contentï¼Œå¦‚æœé»˜è®¤é˜ˆå€¼27æ²¡æœ‰äº§ç”Ÿæ­£ç¡®çš„ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é¦–å…ˆç”Ÿæˆç»Ÿè®¡æ–‡ä»¶æ¥ç¡®å®šé€‚å½“çš„é˜ˆå€¼ï¼š</p></blockquote><blockquote><p>scenedetect --input goldeneye.mp4 --stats goldeneye.stats.csv detect-adaptive<br>ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ç»˜åˆ¶content_valåˆ—çš„å€¼</p></blockquote><ul><li>ä»£ç å¦‚ä¸‹ï¼š</li></ul><blockquote><p>å…³é”®ä»£ç å±•ç¤º</p></blockquote><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">generate_stats_csv</span>(<span class="params">video_path, output_dir, threshold</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Detects scenes and saves frame statistics (Frame Num, content_val) to a CSV.</span></span><br><span class="line"><span class="string">    Returns True on success, False on failure.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    thread_name = threading.current_thread().name</span><br><span class="line">    video_filename_base = os.path.splitext(os.path.basename(video_path))[<span class="number">0</span>]</span><br><span class="line">    output_csv_path = os.path.join(output_dir, <span class="string">f&quot;<span class="subst">&#123;video_filename_base&#125;</span>_stats.csv&quot;</span>)</span><br><span class="line">    temp_stats_path = os.path.join(output_dir, <span class="string">f&quot;<span class="subst">&#123;video_filename_base&#125;</span>_temp_full_stats.csv&quot;</span>)</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Processing: <span class="subst">&#123;os.path.basename(video_path)&#125;</span>&quot;</span>)</span><br><span class="line">    video_manager = <span class="literal">None</span></span><br><span class="line">    stats_manager = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 1. Initialize</span></span><br><span class="line">        video_manager = VideoStreamCv2(video_path)</span><br><span class="line">        stats_manager = StatsManager()</span><br><span class="line">        scene_manager = SceneManager(stats_manager)</span><br><span class="line">        scene_manager.add_detector(ContentDetector(threshold=threshold))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2. Get duration</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            total_frames = video_manager.duration.get_frames()</span><br><span class="line">            <span class="keyword">if</span> total_frames &lt;= <span class="number">0</span>:</span><br><span class="line">                logger.warning(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Video <span class="subst">&#123;os.path.basename(video_path)&#125;</span> reported 0 frames. Skipping.&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> info_err:</span><br><span class="line">             logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Error getting video duration for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;info_err&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">             <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3. Run detection</span></span><br><span class="line">        logger.debug(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Running detect_scenes for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>&quot;</span>)</span><br><span class="line">        scene_manager.detect_scenes(frame_source=video_manager)</span><br><span class="line">        logger.debug(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] detect_scenes finished for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 4. Save *full* statistics temporarily by passing a FILE HANDLE</span></span><br><span class="line">        logger.debug(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Saving full stats to temporary file: <span class="subst">&#123;temp_stats_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># --- MODIFIED PART ---</span></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(temp_stats_path, <span class="string">&#x27;w&#x27;</span>, newline=<span class="string">&#x27;&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                 stats_manager.save_to_csv(f) <span class="comment"># Pass the open file handle &#x27;f&#x27; directly</span></span><br><span class="line">            <span class="comment"># ---------------------</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(temp_stats_path):</span><br><span class="line">                 logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] StatsManager failed to create the temporary stats file: <span class="subst">&#123;temp_stats_path&#125;</span>&quot;</span>)</span><br><span class="line">                 <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">except</span> TypeError <span class="keyword">as</span> te:</span><br><span class="line">             <span class="comment"># Catch if even passing a handle is wrong</span></span><br><span class="line">             logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] TypeError calling save_to_csv for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>. API mismatch. Error: <span class="subst">&#123;te&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">             <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> save_err:</span><br><span class="line">             logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Error saving temporary stats file <span class="subst">&#123;temp_stats_path&#125;</span>: <span class="subst">&#123;save_err&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">             <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 5. Read the temp stats CSV and extract desired columns</span></span><br><span class="line">        <span class="comment"># (Keep this part the same as the previous version)</span></span><br><span class="line">        logger.debug(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Reading temporary stats file: <span class="subst">&#123;temp_stats_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            stats_df = pd.read_csv(temp_stats_path, skipinitialspace=<span class="literal">True</span>)</span><br><span class="line">            stats_df.columns = stats_df.columns.<span class="built_in">str</span>.strip()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> FRAME_NUM_COL <span class="keyword">not</span> <span class="keyword">in</span> stats_df.columns <span class="keyword">or</span> CONTENT_VAL_COL <span class="keyword">not</span> <span class="keyword">in</span> stats_df.columns:</span><br><span class="line">                logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Temporary stats file (<span class="subst">&#123;temp_stats_path&#125;</span>) is missing required columns. Found: <span class="subst">&#123;stats_df.columns.tolist()&#125;</span>. Expected: &#x27;<span class="subst">&#123;FRAME_NUM_COL&#125;</span>&#x27;, &#x27;<span class="subst">&#123;CONTENT_VAL_COL&#125;</span>&#x27;&quot;</span>)</span><br><span class="line">                <span class="comment"># Keep the temp file for inspection if columns are missing</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span> <span class="comment"># Return failure</span></span><br><span class="line"></span><br><span class="line">            output_df = stats_df[[FRAME_NUM_COL, CONTENT_VAL_COL]]</span><br><span class="line">            logger.debug(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Saving extracted stats to final file: <span class="subst">&#123;output_csv_path&#125;</span>&quot;</span>)</span><br><span class="line">            output_df.to_csv(output_csv_path, index=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">            logger.info(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Successfully generated stats CSV: <span class="subst">&#123;os.path.basename(output_csv_path)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span> <span class="comment"># Return success</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> pd.errors.EmptyDataError:</span><br><span class="line">            logger.warning(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Temporary stats file was empty: <span class="subst">&#123;temp_stats_path&#125;</span>. No scenes likely detected or error during stats generation.&quot;</span>)</span><br><span class="line">            <span class="comment"># Create an empty output file with correct headers</span></span><br><span class="line">            pd.DataFrame(columns=[FRAME_NUM_COL, CONTENT_VAL_COL]).to_csv(output_csv_path, index=<span class="literal">False</span>)</span><br><span class="line">            logger.info(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Created empty stats CSV (as temp was empty): <span class="subst">&#123;os.path.basename(output_csv_path)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span> <span class="comment"># Count as processed successfully (empty result)</span></span><br><span class="line">        <span class="keyword">except</span> KeyError <span class="keyword">as</span> e:</span><br><span class="line">             logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Column not found in temporary stats file (<span class="subst">&#123;temp_stats_path&#125;</span>): <span class="subst">&#123;e&#125;</span>. Available columns: <span class="subst">&#123;stats_df.columns.tolist()&#125;</span>&quot;</span>)</span><br><span class="line">             <span class="comment"># Keep the temp file for inspection</span></span><br><span class="line">             <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Error processing temporary stats file <span class="subst">&#123;temp_stats_path&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> VideoOpenFailure <span class="keyword">as</span> vf_err:</span><br><span class="line">        logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Failed to open video <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;vf_err&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Error during scene detection/stats generation for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">if</span> video_manager <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">hasattr</span>(video_manager, <span class="string">&#x27;_cap&#x27;</span>) <span class="keyword">and</span> video_manager._cap <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="built_in">hasattr</span>(video_manager._cap, <span class="string">&#x27;release&#x27;</span>):</span><br><span class="line">                    video_manager._cap.release()</span><br><span class="line">                <span class="keyword">del</span> video_manager</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> del_e:</span><br><span class="line">                 logger.warning(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Exception while cleaning up video_manager for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;del_e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Clean up temporary stats file ONLY IF the final CSV was successfully created or was intentionally empty</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;output_df&#x27;</span> <span class="keyword">in</span> <span class="built_in">locals</span>() <span class="keyword">or</span> ( <span class="string">&#x27;stats_df&#x27;</span> <span class="keyword">in</span> <span class="built_in">locals</span>() <span class="keyword">and</span> stats_df.empty ): <span class="comment"># Check if processing reached CSV saving/empty handling stage</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;temp_stats_path&#x27;</span> <span class="keyword">in</span> <span class="built_in">locals</span>() <span class="keyword">and</span> os.path.exists(temp_stats_path):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    os.remove(temp_stats_path)</span><br><span class="line">                    logger.debug(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Removed temporary stats file: <span class="subst">&#123;temp_stats_path&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">except</span> OSError <span class="keyword">as</span> e:</span><br><span class="line">                    logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Failed to remove temporary stats file <span class="subst">&#123;temp_stats_path&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">             <span class="comment"># If processing failed before reading/writing the final CSV, keep the temp file for debugging</span></span><br><span class="line">              <span class="keyword">if</span> <span class="string">&#x27;temp_stats_path&#x27;</span> <span class="keyword">in</span> <span class="built_in">locals</span>() <span class="keyword">and</span> os.path.exists(temp_stats_path):</span><br><span class="line">                    logger.warning(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Keeping temporary stats file due to processing error: <span class="subst">&#123;temp_stats_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ... (Rest of the code remains the same: process_video, find_video_files, move_video, main, __main__) ...</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">root_dir, dest_dir, num_threads, threshold</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Main function to orchestrate the CSV generation process.&quot;&quot;&quot;</span></span><br><span class="line">    root_dir = os.path.normpath(root_dir)</span><br><span class="line">    dest_dir = os.path.normpath(dest_dir)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Ensure destination directory exists</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        os.makedirs(dest_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">        logger.info(<span class="string">f&quot;Ensured destination directory exists: <span class="subst">&#123;dest_dir&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> OSError <span class="keyword">as</span> e:</span><br><span class="line">        logger.critical(<span class="string">f&quot;Failed to create destination directory &#x27;<span class="subst">&#123;dest_dir&#125;</span>&#x27;: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="comment"># Cannot proceed without output directory</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">         logger.critical(<span class="string">f&quot;Unexpected error creating destination directory &#x27;<span class="subst">&#123;dest_dir&#125;</span>&#x27;: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">         <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Find video files, excluding any already in the destination</span></span><br><span class="line">    video_files_all = find_video_files(root_dir)</span><br><span class="line">    abs_dest_dir = os.path.abspath(dest_dir)</span><br><span class="line">    video_files = [f <span class="keyword">for</span> f <span class="keyword">in</span> video_files_all <span class="keyword">if</span> <span class="keyword">not</span> os.path.abspath(f).startswith(abs_dest_dir)]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(video_files) &lt; <span class="built_in">len</span>(video_files_all):</span><br><span class="line">         logger.warning(<span class="string">f&quot;Filtered out <span class="subst">&#123;<span class="built_in">len</span>(video_files_all) - <span class="built_in">len</span>(video_files)&#125;</span> files potentially inside the destination directory &#x27;<span class="subst">&#123;dest_dir&#125;</span>&#x27;.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> video_files:</span><br><span class="line">        logger.error(<span class="string">f&quot;No valid video files found in &#x27;<span class="subst">&#123;root_dir&#125;</span>&#x27; (excluding destination directory).&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">f&quot;Starting stats CSV generation for <span class="subst">&#123;<span class="built_in">len</span>(video_files)&#125;</span> videos from &#x27;<span class="subst">&#123;root_dir&#125;</span>&#x27; using <span class="subst">&#123;num_threads&#125;</span> threads.&quot;</span>)</span><br><span class="line">    logger.info(<span class="string">f&quot;Output CSV files will be saved in: <span class="subst">&#123;dest_dir&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    start_overall_time = time.time()</span><br><span class="line">    processed_count = <span class="number">0</span></span><br><span class="line">    successful_runs = <span class="number">0</span></span><br><span class="line">    failed_runs = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(max_workers=num_threads, thread_name_prefix=<span class="string">&#x27;StatsGenWorker&#x27;</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        <span class="comment"># Submit tasks: Pass video path, output dir, and threshold</span></span><br><span class="line">        futures = &#123;executor.submit(generate_stats_csv, video_file, dest_dir, threshold): video_file <span class="keyword">for</span> video_file <span class="keyword">in</span> video_files&#125;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;All tasks submitted. Waiting for completion...&quot;</span>)</span><br><span class="line">        <span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> as_completed</span><br><span class="line">        <span class="comment"># Use tqdm with as_completed for better progress feedback</span></span><br><span class="line">        <span class="keyword">for</span> future <span class="keyword">in</span> tqdm(as_completed(futures), total=<span class="built_in">len</span>(futures), desc=<span class="string">&quot;Overall Progress&quot;</span>):</span><br><span class="line">            video_file = futures[future] <span class="comment"># Get associated video file</span></span><br><span class="line">            processed_count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                success = future.result() <span class="comment"># Get boolean result from generate_stats_csv</span></span><br><span class="line">                <span class="keyword">if</span> success:</span><br><span class="line">                    successful_runs += <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    failed_runs += <span class="number">1</span></span><br><span class="line">                    <span class="comment"># Error is already logged within the function</span></span><br><span class="line">                    logger.debug(<span class="string">f&quot;Task for <span class="subst">&#123;os.path.basename(video_file)&#125;</span> completed with failure (logged previously).&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">                <span class="comment"># Catch exceptions that might occur if future.result() itself fails unexpectedly</span></span><br><span class="line">                failed_runs += <span class="number">1</span></span><br><span class="line">                logger.error(<span class="string">f&quot;Unexpected error getting result for <span class="subst">&#123;os.path.basename(video_file)&#125;</span>: <span class="subst">&#123;exc&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    end_overall_time = time.time()</span><br><span class="line">    logger.info(<span class="string">f&quot;Stats CSV generation complete.&quot;</span>)</span><br><span class="line">    logger.info(<span class="string">f&quot;Summary: <span class="subst">&#123;<span class="built_in">len</span>(video_files)&#125;</span> videos submitted. <span class="subst">&#123;successful_runs&#125;</span> processed successfully, <span class="subst">&#123;failed_runs&#125;</span> encountered errors.&quot;</span>)</span><br><span class="line">    logger.info(<span class="string">f&quot;Total execution time: <span class="subst">&#123;end_overall_time - start_overall_time:<span class="number">.2</span>f&#125;</span> seconds.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># --- Initial Checks ---</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> check_ffmpeg():</span><br><span class="line">        <span class="comment"># Optional: Decide whether to proceed without FFmpeg warning or exit</span></span><br><span class="line">        <span class="comment"># sys.exit(1)</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    check_acceleration_support()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- Setup Directories ---</span></span><br><span class="line">    root_directory = <span class="string">r&#x27;/Volumes/shared/æ ‡æ³¨/å½±è§†&#x27;</span></span><br><span class="line">    destination_directory = <span class="string">r&#x27;./data&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Use defaults if not using argparse</span></span><br><span class="line">    detection_threshold = DEFAULT_THRESHOLD</span><br><span class="line">    thread_count = DEFAULT_NUM_THREADS</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- Directory Validation ---</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(root_directory):</span><br><span class="line">        logger.critical(<span class="string">f&quot;Input root directory &#x27;<span class="subst">&#123;root_directory&#125;</span>&#x27; not found or is not a directory.&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># Destination directory creation is handled in main()</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- Run Main Process ---</span></span><br><span class="line">    main(root_directory, destination_directory, thread_count, detection_threshold)</span><br></pre></td></tr></table></figure><h2 id="æµ‹è¯•demo">æµ‹è¯•demo</h2><blockquote><p>ä½¿ç”¨ PySceneDetect å¿«é€Ÿåˆ†æè§†é¢‘ å¹¶è¾“å‡ºå„ç§å‚æ•°åˆ°csv</p></blockquote> <figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥ç¡¬ä»¶åŠ é€Ÿæ”¯æŒ</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detect_scenes</span>(<span class="params">video_path, threshold=<span class="number">30.0</span>, downscale_width=<span class="number">640</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Detects scene changes in a video using PySceneDetect with VideoStreamCv2.&quot;&quot;&quot;</span></span><br><span class="line">    video_manager = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 1. åˆå§‹åŒ–</span></span><br><span class="line">        logging.debug(<span class="string">f&quot;Initializing VideoStreamCv2 for: <span class="subst">&#123;os.path.basename(video_path)&#125;</span>&quot;</span>)</span><br><span class="line">        video_manager = VideoStreamCv2(video_path)</span><br><span class="line">        logging.info(<span class="string">f&quot;Initialized VideoStreamCv2 for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        stats_manager = StatsManager()</span><br><span class="line">        scene_manager = SceneManager(stats_manager)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 2. æ·»åŠ åœºæ™¯æ£€æµ‹å™¨</span></span><br><span class="line">        scene_manager.add_detector(ContentDetector(threshold=threshold))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3. è·å–è§†é¢‘ä¿¡æ¯ for Progress Bar</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            total_frames = video_manager.duration.get_frames()</span><br><span class="line">            logging.debug(<span class="string">f&quot;Video Info: Total Frames=<span class="subst">&#123;total_frames&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> info_err:</span><br><span class="line">             logging.error(<span class="string">f&quot;Error getting video info (duration) for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;info_err&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">             <span class="keyword">if</span> video_manager <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>: <span class="keyword">del</span> video_manager</span><br><span class="line">             <span class="keyword">return</span> <span class="literal">None</span>, video_path</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> total_frames &lt;= <span class="number">0</span>:</span><br><span class="line">             logging.warning(<span class="string">f&quot;Video <span class="subst">&#123;os.path.basename(video_path)&#125;</span> reported 0 frames. Skipping processing.&quot;</span>)</span><br><span class="line">             <span class="keyword">if</span> video_manager <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>: <span class="keyword">del</span> video_manager</span><br><span class="line">             <span class="keyword">return</span> <span class="number">0</span>, video_path</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 4. è®¾ç½®(ç®€åŒ–çš„)è¿›åº¦æ¡å¹¶æ‰§è¡Œæ£€æµ‹</span></span><br><span class="line">        <span class="comment"># The frame-by-frame callback doesn&#x27;t work with this version.</span></span><br><span class="line">        <span class="comment"># The tqdm bar will show progress only after detect_scenes finishes for the file.</span></span><br><span class="line">        <span class="keyword">with</span> tqdm(total=total_frames, desc=<span class="string">f&quot;Processing <span class="subst">&#123;os.path.basename(video_path)&#125;</span>&quot;</span>, unit=<span class="string">&quot;frame&quot;</span>, leave=<span class="literal">False</span>) <span class="keyword">as</span> pbar:</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 5. æ‰§è¡Œåœºæ™¯æ£€æµ‹ - Pass the video_manager as frame_source</span></span><br><span class="line">            scene_manager.detect_scenes(frame_source=video_manager)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Manually update pbar to 100% after completion if needed,</span></span><br><span class="line">            <span class="comment"># though tqdm might do this automatically on exit from &#x27;with&#x27;.</span></span><br><span class="line">            pbar.n = total_frames <span class="comment"># Set progress to max</span></span><br><span class="line">            pbar.refresh()       <span class="comment"># Refresh display</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 6. è·å–ç»“æœ</span></span><br><span class="line">        scene_list = scene_manager.get_scene_list()</span><br><span class="line"></span><br><span class="line">        logging.info(<span class="string">f&quot;Detected <span class="subst">&#123;<span class="built_in">len</span>(scene_list)&#125;</span> scenes in <span class="subst">&#123;os.path.basename(video_path)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 7. èµ„æºç®¡ç†</span></span><br><span class="line">        <span class="comment"># del video_manager</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(scene_list), video_path</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> cv2.error <span class="keyword">as</span> cv_err:</span><br><span class="line">         logging.error(<span class="string">f&quot;OpenCV error processing <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;cv_err&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">None</span>, video_path</span><br><span class="line">    <span class="keyword">except</span> VideoOpenFailure <span class="keyword">as</span> vf_err:</span><br><span class="line">         logging.error(<span class="string">f&quot;Failed to open video <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;vf_err&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">None</span>, video_path</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logging.error(<span class="string">f&quot;Generic error processing <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, video_path</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">         <span class="keyword">if</span> <span class="string">&#x27;video_manager&#x27;</span> <span class="keyword">in</span> <span class="built_in">locals</span>() <span class="keyword">and</span> video_manager <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">             <span class="keyword">try</span>: <span class="keyword">del</span> video_manager</span><br><span class="line">             <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ... (Keep process_video, find_video_files, move_video, main, __main__ block the same) ...</span></span><br><span class="line"><span class="comment"># ... [Rest of the code] ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_video</span>(<span class="params">video_path, threshold, dest_dir, downscale_width</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;å¤„ç†å•ä¸ªè§†é¢‘ï¼Œæ•è·å¼‚å¸¸, å¹¶ç§»åŠ¨è§†é¢‘&quot;&quot;&quot;</span></span><br><span class="line">    thread_name = threading.current_thread().name</span><br><span class="line">    logging.info(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Starting processing for: <span class="subst">&#123;os.path.basename(video_path)&#125;</span>&quot;</span>)</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    num_scenes = <span class="literal">None</span>  <span class="comment"># Initialize</span></span><br><span class="line">    processed_video_path = video_path  <span class="comment"># Assume original path initially</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        num_scenes, processed_video_path = detect_scenes(video_path, threshold, downscale_width)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Check if detect_scenes returned None for path (shouldn&#x27;t happen with current logic, but defensive)</span></span><br><span class="line">        <span class="keyword">if</span> processed_video_path <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            logging.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Video path became None during processing for <span class="subst">&#123;video_path&#125;</span>. Skipping move.&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span>  <span class="comment"># Explicitly return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> num_scenes <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> num_scenes &gt; <span class="number">1</span>:</span><br><span class="line">            <span class="comment"># Check if the source file still exists before moving (it might fail during processing)</span></span><br><span class="line">            <span class="keyword">if</span> os.path.exists(processed_video_path):</span><br><span class="line">                move_video(processed_video_path, dest_dir)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                logging.warning(</span><br><span class="line">                    <span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Source file <span class="subst">&#123;processed_video_path&#125;</span> not found after processing. Cannot move.&quot;</span>)</span><br><span class="line">        <span class="keyword">elif</span> num_scenes <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:  <span class="comment"># Includes case where num_scenes is 0 because no frames were processed</span></span><br><span class="line">            logging.info(</span><br><span class="line">                <span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Video <span class="subst">&#123;os.path.basename(processed_video_path)&#125;</span> is single scene or failed processing. No move needed.&quot;</span>)</span><br><span class="line">        <span class="comment"># else case (num_scenes is None) is implicitly handled by the warning below</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> num_scenes <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># This case means detect_scenes failed and returned None for num_scenes</span></span><br><span class="line">            logging.warning(</span><br><span class="line">                <span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Video <span class="subst">&#123;os.path.basename(processed_video_path)&#125;</span> failed processing entirely. No move needed.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># Catch any unexpected error during the move decision or logging</span></span><br><span class="line">        logging.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Top-level error in process_video for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>,</span><br><span class="line">                      exc_info=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        end_time = time.time()</span><br><span class="line">        status = <span class="string">&quot;failed&quot;</span> <span class="keyword">if</span> num_scenes <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> <span class="string">f&quot;<span class="subst">&#123;num_scenes&#125;</span> scenes&quot;</span></span><br><span class="line">        logging.info(</span><br><span class="line">            <span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Finished processing <span class="subst">&#123;os.path.basename(video_path)&#125;</span> (<span class="subst">&#123;status&#125;</span>) in <span class="subst">&#123;end_time - start_time:<span class="number">.2</span>f&#125;</span> seconds.&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="åœºæ™¯åˆ‡å‰²">åœºæ™¯åˆ‡å‰²</h2><ul><li>æ ¹æ®è§†é¢‘å†…åœºæ™¯åˆ‡æ¢ åˆ‡å‰²è§†é¢‘</li></ul><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detect_scenes</span>(<span class="params">video_path, threshold=<span class="number">30.0</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Detects scene changes in a video using PySceneDetect with VideoStreamCv2.&quot;&quot;&quot;</span></span><br><span class="line">    video_manager = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        logger.debug(<span class="string">f&quot;Initializing VideoStreamCv2 for: <span class="subst">&#123;os.path.basename(video_path)&#125;</span>&quot;</span>)</span><br><span class="line">        video_manager = VideoStreamCv2(video_path)</span><br><span class="line">        logger.info(<span class="string">f&quot;Initialized VideoStreamCv2 for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        stats_manager = StatsManager()</span><br><span class="line">        scene_manager = SceneManager(stats_manager)</span><br><span class="line">        scene_manager.add_detector(ContentDetector(threshold=threshold))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            total_frames = video_manager.duration.get_frames()</span><br><span class="line">            <span class="comment"># base_timecode = video_manager.base_timecode # No longer needed for get_scene_list</span></span><br><span class="line">            logging.debug(<span class="string">f&quot;Video Info: Total Frames=<span class="subst">&#123;total_frames&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> info_err:</span><br><span class="line">             logger.error(<span class="string">f&quot;Error getting video info (duration) for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;info_err&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">             <span class="keyword">return</span> <span class="literal">None</span>, video_path, <span class="literal">None</span> <span class="comment"># Return None for scene list</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> total_frames &lt;= <span class="number">0</span>:</span><br><span class="line">             logger.warning(<span class="string">f&quot;Video <span class="subst">&#123;os.path.basename(video_path)&#125;</span> reported 0 frames. Skipping processing.&quot;</span>)</span><br><span class="line">             <span class="keyword">return</span> <span class="number">0</span>, video_path, [] <span class="comment"># Return 0 scenes, empty list</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Execute scene detection (no progress bar here as callback wasn&#x27;t reliable)</span></span><br><span class="line">        logger.debug(<span class="string">f&quot;Starting scene detection for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>&quot;</span>)</span><br><span class="line">        scene_manager.detect_scenes(frame_source=video_manager)</span><br><span class="line">        logger.debug(<span class="string">f&quot;Finished scene detection for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Get scene list (without base_timecode)</span></span><br><span class="line">        scene_list = scene_manager.get_scene_list()</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">f&quot;Detected <span class="subst">&#123;<span class="built_in">len</span>(scene_list)&#125;</span> scenes in <span class="subst">&#123;os.path.basename(video_path)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Return scene count, path, and the actual scene list for splitting</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(scene_list), video_path, scene_list</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> cv2.error <span class="keyword">as</span> cv_err:</span><br><span class="line">         logger.error(<span class="string">f&quot;OpenCV error processing <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;cv_err&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">None</span>, video_path, <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> VideoOpenFailure <span class="keyword">as</span> vf_err:</span><br><span class="line">         logger.error(<span class="string">f&quot;Failed to open video <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;vf_err&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">None</span>, video_path, <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;Generic error during scene detection for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, video_path, <span class="literal">None</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">         <span class="comment"># Ensure the video file is closed/released by deleting the reference</span></span><br><span class="line">         <span class="keyword">if</span> <span class="string">&#x27;video_manager&#x27;</span> <span class="keyword">in</span> <span class="built_in">locals</span>() <span class="keyword">and</span> video_manager <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">             <span class="keyword">try</span>:</span><br><span class="line">                 <span class="comment"># Explicitly call internal capture release if possible</span></span><br><span class="line">                 <span class="keyword">if</span> <span class="built_in">hasattr</span>(video_manager, <span class="string">&#x27;_cap&#x27;</span>) <span class="keyword">and</span> video_manager._cap <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="built_in">hasattr</span>(video_manager._cap, <span class="string">&#x27;release&#x27;</span>):</span><br><span class="line">                     video_manager._cap.release()</span><br><span class="line">                 <span class="keyword">del</span> video_manager</span><br><span class="line">             <span class="keyword">except</span> Exception <span class="keyword">as</span> del_e:</span><br><span class="line">                 logger.warning(<span class="string">f&quot;Exception while cleaning up video_manager for <span class="subst">&#123;os.path.basename(video_path)&#125;</span>: <span class="subst">&#123;del_e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">split_video_scene</span>(<span class="params">input_path, output_path, start_timecode_str, end_timecode_str</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Splits a video segment using FFmpeg without re-encoding.&quot;&quot;&quot;</span></span><br><span class="line">    thread_name = threading.current_thread().name</span><br><span class="line">    logger.info(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Splitting scene: <span class="subst">&#123;os.path.basename(output_path)&#125;</span> (<span class="subst">&#123;start_timecode_str&#125;</span> -&gt; <span class="subst">&#123;end_timecode_str&#125;</span>)&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Ensure output directory exists</span></span><br><span class="line">    os.makedirs(os.path.dirname(output_path), exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Construct FFmpeg command</span></span><br><span class="line">    <span class="comment"># Using -ss after -i and -copyts is generally more frame-accurate for splitting with -c copy</span></span><br><span class="line">    command = [</span><br><span class="line">        <span class="string">&#x27;ffmpeg&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;-i&#x27;</span>, <span class="built_in">str</span>(input_path),         <span class="comment"># Input file</span></span><br><span class="line">        <span class="string">&#x27;-ss&#x27;</span>, start_timecode_str,     <span class="comment"># Start time</span></span><br><span class="line">        <span class="string">&#x27;-to&#x27;</span>, end_timecode_str,       <span class="comment"># End time</span></span><br><span class="line">        <span class="string">&#x27;-copyts&#x27;</span>,                     <span class="comment"># Copy timestamps</span></span><br><span class="line">        <span class="string">&#x27;-avoid_negative_ts&#x27;</span>, <span class="string">&#x27;make_zero&#x27;</span>, <span class="comment"># Handle timestamp issues</span></span><br><span class="line">        <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;copy&#x27;</span>,                  <span class="comment"># Copy codecs (no re-encoding)</span></span><br><span class="line">        <span class="string">&#x27;-y&#x27;</span>,                          <span class="comment"># Overwrite output file if it exists</span></span><br><span class="line">        <span class="built_in">str</span>(output_path)               <span class="comment"># Output file</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># Run FFmpeg command</span></span><br><span class="line">        <span class="comment"># creationflags prevents console window popup on Windows</span></span><br><span class="line">        process = subprocess.run(</span><br><span class="line">            command,</span><br><span class="line">            stdout=subprocess.PIPE,</span><br><span class="line">            stderr=subprocess.PIPE,</span><br><span class="line">            check=<span class="literal">True</span>, <span class="comment"># Raise CalledProcessError if ffmpeg returns non-zero exit code</span></span><br><span class="line">            creationflags=subprocess.CREATE_NO_WINDOW <span class="keyword">if</span> platform.system() == <span class="string">&quot;Windows&quot;</span> <span class="keyword">else</span> <span class="number">0</span>,</span><br><span class="line">            encoding=<span class="string">&#x27;utf-8&#x27;</span>, <span class="comment"># Capture output as text</span></span><br><span class="line">            errors=<span class="string">&#x27;replace&#x27;</span> <span class="comment"># Handle potential decoding errors in ffmpeg output</span></span><br><span class="line">        )</span><br><span class="line">        logger.info(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Successfully split: <span class="subst">&#123;os.path.basename(output_path)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># logger.debug(f&quot;FFmpeg stdout:\n&#123;process.stdout&#125;&quot;) # Usually empty for -c copy</span></span><br><span class="line">        <span class="comment"># logger.debug(f&quot;FFmpeg stderr:\n&#123;process.stderr&#125;&quot;) # Contains progress/info</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> subprocess.CalledProcessError <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] FFmpeg failed for <span class="subst">&#123;os.path.basename(output_path)&#125;</span>.&quot;</span>)</span><br><span class="line">        logger.error(<span class="string">f&quot;  Command: <span class="subst">&#123;<span class="string">&#x27; &#x27;</span>.join(command)&#125;</span>&quot;</span>) <span class="comment"># Log the command for easier debugging</span></span><br><span class="line">        logger.error(<span class="string">f&quot;  Return Code: <span class="subst">&#123;e.returncode&#125;</span>&quot;</span>)</span><br><span class="line">        logger.error(<span class="string">f&quot;  Stderr:\n<span class="subst">&#123;e.stderr&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment"># Optionally log stdout too: logger.error(f&quot;  Stdout:\n&#123;e.stdout&#125;&quot;)</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        logger.critical(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] FFmpeg command not found during split. Ensure FFmpeg is installed and in PATH.&quot;</span>)</span><br><span class="line">        <span class="comment"># No point continuing if ffmpeg isn&#x27;t found for any split</span></span><br><span class="line">        <span class="keyword">raise</span> <span class="comment"># Re-raise to potentially stop the whole process</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Unexpected error splitting <span class="subst">&#123;os.path.basename(output_path)&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_video</span>(<span class="params">video_path, threshold, base_dest_dir, originals_dir, downscale_width</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Detects scenes, splits video if multiple scenes are found, and moves original.&quot;&quot;&quot;</span></span><br><span class="line">    thread_name = threading.current_thread().name</span><br><span class="line">    base_name = os.path.splitext(os.path.basename(video_path))[<span class="number">0</span>]</span><br><span class="line">    file_ext = os.path.splitext(video_path)[<span class="number">1</span>]</span><br><span class="line">    logger.info(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Starting processing for: <span class="subst">&#123;base_name&#125;</span><span class="subst">&#123;file_ext&#125;</span>&quot;</span>)</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    split_success_count = <span class="number">0</span></span><br><span class="line">    split_fail_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        num_scenes, _, scene_list = detect_scenes(video_path, threshold) <span class="comment"># Get scene_list now</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> num_scenes <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            logger.warning(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Video <span class="subst">&#123;base_name&#125;</span><span class="subst">&#123;file_ext&#125;</span> failed scene detection. Skipping.&quot;</span>)</span><br><span class="line">            <span class="comment"># Optionally move failed files to a specific error directory</span></span><br><span class="line">            <span class="keyword">return</span> <span class="comment"># Stop processing this file</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> num_scenes &lt;= <span class="number">1</span>:</span><br><span class="line">            logger.info(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Video <span class="subst">&#123;base_name&#125;</span><span class="subst">&#123;file_ext&#125;</span> has <span class="subst">&#123;num_scenes&#125;</span> scene(s). No splitting needed.&quot;</span>)</span><br><span class="line">            <span class="comment"># Decide if you want to move single-scene videos somewhere else or leave them</span></span><br><span class="line">            <span class="comment"># Example: move_video(video_path, os.path.join(base_dest_dir, &quot;single_scene&quot;))</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logger.info(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Video <span class="subst">&#123;base_name&#125;</span><span class="subst">&#123;file_ext&#125;</span> has <span class="subst">&#123;num_scenes&#125;</span> scenes. Starting split...&quot;</span>)</span><br><span class="line">            <span class="comment"># Create a subdirectory for this video&#x27;s scenes</span></span><br><span class="line">            video_scene_dir = os.path.join(base_dest_dir, base_name)</span><br><span class="line">            os.makedirs(video_scene_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> i, (start_tc, end_tc) <span class="keyword">in</span> <span class="built_in">enumerate</span>(scene_list):</span><br><span class="line">                scene_num = i + <span class="number">1</span></span><br><span class="line">                output_filename = <span class="string">f&quot;<span class="subst">&#123;base_name&#125;</span>_scene_<span class="subst">&#123;scene_num:03d&#125;</span><span class="subst">&#123;file_ext&#125;</span>&quot;</span></span><br><span class="line">                output_filepath = os.path.join(video_scene_dir, output_filename)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Use get_timecode() for FFmpeg compatible strings</span></span><br><span class="line">                start_str = start_tc.get_timecode()</span><br><span class="line">                end_str = end_tc.get_timecode()</span><br><span class="line"></span><br><span class="line">                success = split_video_scene(video_path, output_filepath, start_str, end_str)</span><br><span class="line">                <span class="keyword">if</span> success:</span><br><span class="line">                    split_success_count += <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    split_fail_count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># After attempting all splits, move the original file</span></span><br><span class="line">            <span class="keyword">if</span> split_fail_count == <span class="number">0</span> <span class="keyword">and</span> split_success_count &gt; <span class="number">0</span>: <span class="comment"># Only move original if all splits succeeded</span></span><br><span class="line">                logger.info(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] All <span class="subst">&#123;split_success_count&#125;</span> scenes split successfully for <span class="subst">&#123;base_name&#125;</span><span class="subst">&#123;file_ext&#125;</span>. Moving original.&quot;</span>)</span><br><span class="line">                move_video(video_path, originals_dir)</span><br><span class="line">            <span class="keyword">elif</span> split_success_count &gt; <span class="number">0</span>: <span class="comment"># Some splits succeeded, some failed</span></span><br><span class="line">                logger.warning(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Completed splitting for <span class="subst">&#123;base_name&#125;</span><span class="subst">&#123;file_ext&#125;</span> with <span class="subst">&#123;split_fail_count&#125;</span> failures out of <span class="subst">&#123;num_scenes&#125;</span>. Original NOT moved.&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>: <span class="comment"># All splits failed</span></span><br><span class="line">                logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] All <span class="subst">&#123;num_scenes&#125;</span> split attempts failed for <span class="subst">&#123;base_name&#125;</span><span class="subst">&#123;file_ext&#125;</span>. Original NOT moved.&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Top-level error processing <span class="subst">&#123;base_name&#125;</span><span class="subst">&#123;file_ext&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        end_time = time.time()</span><br><span class="line">        result_summary = <span class="string">f&quot;<span class="subst">&#123;num_scenes&#125;</span> scenes detected&quot;</span> <span class="keyword">if</span> num_scenes <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">else</span> <span class="string">&quot;failed detection&quot;</span></span><br><span class="line">        <span class="keyword">if</span> num_scenes <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> num_scenes &gt; <span class="number">1</span>:</span><br><span class="line">             result_summary += <span class="string">f&quot; (<span class="subst">&#123;split_success_count&#125;</span> split OK, <span class="subst">&#123;split_fail_count&#125;</span> split failed)&quot;</span></span><br><span class="line">        logger.info(<span class="string">f&quot;[<span class="subst">&#123;thread_name&#125;</span>] Finished processing <span class="subst">&#123;base_name&#125;</span><span class="subst">&#123;file_ext&#125;</span> (<span class="subst">&#123;result_summary&#125;</span>) in <span class="subst">&#123;end_time - start_time:<span class="number">.2</span>f&#125;</span> seconds.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">root_dir, dest_dir, num_threads=<span class="number">4</span>, threshold=<span class="number">30.0</span>, downscale_width=<span class="number">640</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Main function to process multiple videos in parallel.&quot;&quot;&quot;</span></span><br><span class="line">    root_dir = os.path.normpath(root_dir)</span><br><span class="line">    dest_dir = os.path.normpath(dest_dir)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Define directory for processed original files</span></span><br><span class="line">    originals_processed_dir = os.path.join(dest_dir, <span class="string">&quot;originals_processed&quot;</span>)</span><br><span class="line">    os.makedirs(originals_processed_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Filter out files already in the destination or originals directory</span></span><br><span class="line">    video_files_all = find_video_files(root_dir)</span><br><span class="line">    abs_dest_dir = os.path.abspath(dest_dir) <span class="comment"># Includes originals_processed_dir</span></span><br><span class="line">    video_files = [f <span class="keyword">for</span> f <span class="keyword">in</span> video_files_all <span class="keyword">if</span> <span class="keyword">not</span> os.path.abspath(f).startswith(abs_dest_dir)]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(video_files) &lt; <span class="built_in">len</span>(video_files_all):</span><br><span class="line">         logger.warning(<span class="string">f&quot;Filtered out <span class="subst">&#123;<span class="built_in">len</span>(video_files_all) - <span class="built_in">len</span>(video_files)&#125;</span> files potentially inside destination subdirectories.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> video_files:</span><br><span class="line">        logger.error(<span class="string">f&quot;No valid video files found in <span class="subst">&#123;root_dir&#125;</span> (excluding destination).&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    logging.info(<span class="string">f&quot;Starting scene splitting on <span class="subst">&#123;<span class="built_in">len</span>(video_files)&#125;</span> videos from <span class="subst">&#123;root_dir&#125;</span> using <span class="subst">&#123;num_threads&#125;</span> threads.&quot;</span>)</span><br><span class="line">    logging.info(<span class="string">f&quot;Output segments will be in subfolders under: <span class="subst">&#123;dest_dir&#125;</span>&quot;</span>)</span><br><span class="line">    logging.info(<span class="string">f&quot;Originals (if successfully split) will be moved to: <span class="subst">&#123;originals_processed_dir&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    start_overall_time = time.time()</span><br><span class="line">    processed_count = <span class="number">0</span></span><br><span class="line">    successful_runs = <span class="number">0</span></span><br><span class="line">    failed_runs = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(max_workers=num_threads, thread_name_prefix=<span class="string">&#x27;SceneSplitWorker&#x27;</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        futures = &#123;executor.submit(process_video, video_file, threshold, dest_dir, originals_processed_dir, downscale_width): video_file <span class="keyword">for</span> video_file <span class="keyword">in</span> video_files&#125;</span><br><span class="line"></span><br><span class="line">        logging.info(<span class="string">&quot;All tasks submitted. Waiting for completion...&quot;</span>)</span><br><span class="line">        <span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> as_completed</span><br><span class="line">        <span class="keyword">for</span> future <span class="keyword">in</span> tqdm(as_completed(futures), total=<span class="built_in">len</span>(futures), desc=<span class="string">&quot;Overall Progress&quot;</span>):</span><br><span class="line">            video_file = futures[future]</span><br><span class="line">            processed_count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                future.result() <span class="comment"># Check for exceptions from the thread</span></span><br><span class="line">                successful_runs += <span class="number">1</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">                <span class="comment"># Exception already logged in thread or called functions</span></span><br><span class="line">                failed_runs += <span class="number">1</span></span><br><span class="line">                logging.debug(<span class="string">f&quot;Worker thread for <span class="subst">&#123;os.path.basename(video_file)&#125;</span> failed top-level (already logged).&quot;</span>)</span><br><span class="line"></span><br><span class="line">    end_overall_time = time.time()</span><br><span class="line">    logging.info(<span class="string">f&quot;Scene splitting complete.&quot;</span>)</span><br><span class="line">    logging.info(<span class="string">f&quot;Summary: <span class="subst">&#123;<span class="built_in">len</span>(video_files)&#125;</span> videos submitted. <span class="subst">&#123;successful_runs&#125;</span> processed without top-level errors, <span class="subst">&#123;failed_runs&#125;</span> encountered errors.&quot;</span>)</span><br><span class="line">    logging.info(<span class="string">f&quot;Total execution time: <span class="subst">&#123;end_overall_time - start_overall_time:<span class="number">.2</span>f&#125;</span> seconds.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># --- CHECK FFMPEG FIRST ---</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> check_ffmpeg():</span><br><span class="line">        sys.exit(<span class="number">1</span>) <span class="comment"># Exit if FFmpeg is not found</span></span><br><span class="line"></span><br><span class="line">    root_dir = <span class="string">r&quot;/Volumes/shared/æ ‡æ³¨/å½±è§†&quot;</span></span><br><span class="line">    dest_dir = <span class="string">r&quot;/Volumes/shared/0328-1-detect-scene-ret&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Standard directory checks</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(root_dir) <span class="keyword">or</span> <span class="keyword">not</span> os.path.isdir(root_dir):</span><br><span class="line">        logging.critical(<span class="string">f&quot;Root directory &#x27;<span class="subst">&#123;root_dir&#125;</span>&#x27; not found or is not a directory.&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        os.makedirs(dest_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">        logging.info(<span class="string">f&quot;Ensured base destination directory exists: <span class="subst">&#123;dest_dir&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> OSError <span class="keyword">as</span> e:</span><br><span class="line">        logging.critical(<span class="string">f&quot;Failed to create base destination directory &#x27;<span class="subst">&#123;dest_dir&#125;</span>&#x27;: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">         logging.critical(<span class="string">f&quot;Unexpected error creating destination directory &#x27;<span class="subst">&#123;dest_dir&#125;</span>&#x27;: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">         sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    check_acceleration_support()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Run main process</span></span><br><span class="line">    <span class="comment"># Adjust num_threads, threshold, downscale_width as needed</span></span><br><span class="line">    main(root_dir, dest_dir, num_threads=<span class="number">4</span>, threshold=<span class="number">27.0</span>, downscale_width=<span class="number">640</span>)</span><br></pre></td></tr></table></figure><h2 id="æµ‹è¯•ç»“æœå±•ç¤º">æµ‹è¯•ç»“æœå±•ç¤º</h2><blockquote><p>å€¼ä¸­çš„å³°å€¼å¯¹åº”äºè¾“å…¥è§†é¢‘ä¸­çš„åœºæ™¯ä¸­æ–­ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½éœ€è¦ç›¸åº”åœ°æé«˜æˆ–é™ä½é˜ˆå€¼ã€‚</p></blockquote><p><img src="/2025/04/03/video-secene-detect/example.png" class="lazyload placeholder" data-srcset="/2025/04/03/video-secene-detect/example.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="see">see</h2><ul><li>1.<a href="https://www.scenedetect.com/cli/#quickstart">https://www.scenedetect.com/cli/#quickstart</a></li><li>2.<a href="https://github.com/Breakthrough/PySceneDetect">https://github.com/Breakthrough/PySceneDetect</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;èƒŒæ™¯&lt;/h2&gt;
&lt;p&gt;ä¸€ä¸ªæ‘„åƒæœºè¿ç»­æ‹æ‘„çš„ä¸€æ®µè§†é¢‘ç‰‡æ®µï¼Œæ²¡æœ‰è¿›è¡Œä¸­æ–­ã€‚ä¸€ä¸ªé•œå¤´é€šå¸¸æ˜¯è§†é¢‘å™äº‹çš„åŸºæœ¬å•ä½ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2. é•œå¤´è¯†åˆ«çš„æ„ä¹‰ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;è§†é¢‘åˆ†æå’Œç†è§£ï¼š&lt;/strong&gt; </summary>
      
    
    
    
    
    <category term="python" scheme="https://caozhaoqi.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>åœ¨ubuntuä½¿ç”¨Postfixæ­å»ºé‚®ä»¶æœåŠ¡å™¨</title>
    <link href="https://caozhaoqi.github.io/2025/03/26/mail-server-Postfix/"/>
    <id>https://caozhaoqi.github.io/2025/03/26/mail-server-Postfix/</id>
    <published>2025-03-26T06:32:54.000Z</published>
    <updated>2025-11-25T15:05:10.331Z</updated>
    
    <content type="html"><![CDATA[<h1>åœ¨ubuntuä½¿ç”¨Postfixæ­å»ºé‚®ä»¶æœåŠ¡å™¨</h1><blockquote><p>åœ¨ Ubuntu æœåŠ¡å™¨ä¸Šæ­å»ºé‚®ä»¶æœåŠ¡å™¨çš„æ•™ç¨‹ã€‚ Postfix ä½œä¸ºé‚®ä»¶ä¼ è¾“ä»£ç† (MTA)ï¼ŒDovecot ä½œä¸ºé‚®ä»¶æŠ•é€’ä»£ç† (MDA)</p></blockquote><p><strong>ç›®æ ‡ï¼š</strong></p><ul><li>åœ¨ Ubuntu æœåŠ¡å™¨ä¸Šæ­å»ºä¸€ä¸ªåŠŸèƒ½å®Œå–„çš„é‚®ä»¶æœåŠ¡å™¨ã€‚</li><li>æ”¯æŒå‘é€å’Œæ¥æ”¶é‚®ä»¶ã€‚</li><li>å®ç°åŸºæœ¬çš„å®‰å…¨æªæ–½ï¼Œé˜²æ­¢åƒåœ¾é‚®ä»¶å’Œæœªç»æˆæƒçš„è®¿é—®ã€‚</li></ul><p><strong>å‡†å¤‡å·¥ä½œï¼š</strong></p><ol><li><strong>ä¸€å°è¿è¡Œ Ubuntu Server çš„æœåŠ¡å™¨ã€‚</strong> æ¨èä½¿ç”¨ Ubuntu 20.04 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚</li><li><strong>å…·æœ‰ <code>sudo</code> æƒé™çš„é root ç”¨æˆ·ã€‚</strong></li><li><strong>ä¸€ä¸ªåŸŸåã€‚</strong> ä½ éœ€è¦ä¸€ä¸ªæ³¨å†Œçš„åŸŸåï¼Œä»¥ä¾¿è®¾ç½®é‚®ä»¶æœåŠ¡å™¨çš„ DNS è®°å½•ã€‚</li><li><strong>ä¸€ä¸ªé™æ€ IP åœ°å€ã€‚</strong> ä½ çš„æœåŠ¡å™¨éœ€è¦ä¸€ä¸ªé™æ€ IP åœ°å€ï¼Œä»¥ä¾¿ DNS è®°å½•å¯ä»¥æ­£ç¡®è§£æåˆ°ä½ çš„æœåŠ¡å™¨ã€‚</li><li><strong>ç¡®ä¿æœåŠ¡å™¨ä¸»æœºåè®¾ç½®æ­£ç¡®ã€‚</strong> ä½¿ç”¨ <code>hostnamectl</code> å‘½ä»¤è®¾ç½®ä¸»æœºåã€‚ä¸»æœºååº”è¯¥ä¸ä½ çš„åŸŸåæˆ–å­åŸŸåç›¸å…³ã€‚ä¾‹å¦‚ï¼Œ<code>mail.example.com</code>ã€‚</li></ol><p><strong>æ­¥éª¤ 1ï¼šå®‰è£… Postfix</strong></p><p>Postfix æ˜¯ä¸€ä¸ªæµè¡Œçš„ã€å®‰å…¨çš„ã€æ˜“äºé…ç½®çš„é‚®ä»¶ä¼ è¾“ä»£ç† (MTA)ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install postfix</span><br></pre></td></tr></table></figure><p>åœ¨å®‰è£…è¿‡ç¨‹ä¸­ï¼Œä¼šå¼¹å‡ºä¸€ä¸ªé…ç½®çª—å£ã€‚é€‰æ‹© â€œInternet Siteâ€ å¹¶è¾“å…¥ä½ çš„åŸŸåï¼ˆä¾‹å¦‚ï¼Œ<code>example.com</code>ï¼‰ã€‚</p><p><strong>æ­¥éª¤ 2ï¼šé…ç½® Postfix</strong></p><p>ç¼–è¾‘ Postfix çš„ä¸»é…ç½®æ–‡ä»¶ <code>main.cf</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> nano /etc/postfix/main.cf</span><br></pre></td></tr></table></figure><p>è¿›è¡Œä»¥ä¸‹ä¿®æ”¹ï¼š</p><ul><li><p><strong><code>myhostname</code>ï¼š</strong> è®¾ç½®æœåŠ¡å™¨çš„ä¸»æœºåã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myhostname = mail.example.com</span><br></pre></td></tr></table></figure></li><li><p><strong><code>myorigin</code>ï¼š</strong> è®¾ç½®å‘é€é‚®ä»¶æ—¶ä½¿ç”¨çš„åŸŸåã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myorigin = example.com</span><br></pre></td></tr></table></figure></li><li><p><strong><code>mydestination</code>ï¼š</strong> è®¾ç½®æœåŠ¡å™¨æ¥æ”¶é‚®ä»¶çš„åŸŸåã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mydestination = mail.example.com, example.com, localhost.localdomain, localhost</span><br></pre></td></tr></table></figure></li><li><p><strong><code>mynetworks</code>ï¼š</strong> è®¾ç½®å…è®¸é€šè¿‡æ­¤æœåŠ¡å™¨å‘é€é‚®ä»¶çš„ç½‘ç»œã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128</span><br></pre></td></tr></table></figure></li><li><p><strong><code>relayhost</code>ï¼š</strong> å¦‚æœä½ éœ€è¦é€šè¿‡å¦ä¸€ä¸ªé‚®ä»¶æœåŠ¡å™¨å‘é€é‚®ä»¶ï¼Œè¯·è®¾ç½®æ­¤é€‰é¡¹ã€‚ å¦åˆ™ï¼Œæ³¨é‡Šæ‰æˆ–ç•™ç©ºã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#relayhost =</span><br></pre></td></tr></table></figure></li><li><p><strong><code>inet_interfaces</code>ï¼š</strong> è®¾ç½® Postfix ç›‘å¬çš„ç½‘ç»œæ¥å£ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inet_interfaces = all</span><br></pre></td></tr></table></figure></li><li><p><strong><code>inet_protocols</code>ï¼š</strong> è®¾ç½® Postfix ä½¿ç”¨çš„ç½‘ç»œåè®®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inet_protocols = all</span><br></pre></td></tr></table></figure></li></ul><p>ä¿å­˜å¹¶å…³é—­æ–‡ä»¶ã€‚</p><p><strong>æ­¥éª¤ 3ï¼šå®‰è£… Dovecot</strong></p><p>Dovecot æ˜¯ä¸€ä¸ªæµè¡Œçš„ã€å®‰å…¨çš„é‚®ä»¶æŠ•é€’ä»£ç† (MDA)ã€‚ å®ƒè´Ÿè´£å°†é‚®ä»¶æŠ•é€’åˆ°ç”¨æˆ·çš„é‚®ç®±ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install dovecot-core dovecot-imapd dovecot-pop3d</span><br></pre></td></tr></table></figure><p><strong>æ­¥éª¤ 4ï¼šé…ç½® Dovecot</strong></p><p>é…ç½® Dovecot ä»¥ä½¿ç”¨ Postfix è¿›è¡Œé‚®ä»¶æŠ•é€’ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> nano /etc/dovecot/dovecot.conf</span><br></pre></td></tr></table></figure><p>å–æ¶ˆæ³¨é‡Šä»¥ä¸‹è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">!include conf.d/10-mail.conf</span><br><span class="line">!include conf.d/10-auth.conf</span><br><span class="line">!include conf.d/10-master.conf</span><br></pre></td></tr></table></figure><p>ä¿å­˜å¹¶å…³é—­æ–‡ä»¶ã€‚</p><p>ç¼–è¾‘ <code>10-mail.conf</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> nano /etc/dovecot/conf.d/10-mail.conf</span><br></pre></td></tr></table></figure><p>è®¾ç½® <code>mail_location</code> é€‰é¡¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mail_location = mbox:~/mail:INBOX=/var/mail/%u</span><br></pre></td></tr></table></figure><p>ä¿å­˜å¹¶å…³é—­æ–‡ä»¶ã€‚</p><p>ç¼–è¾‘ <code>10-auth.conf</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> nano /etc/dovecot/conf.d/10-auth.conf</span><br></pre></td></tr></table></figure><p>å–æ¶ˆæ³¨é‡Š <code>disable_plaintext_auth</code> é€‰é¡¹å¹¶å°†å…¶è®¾ç½®ä¸º <code>no</code>ã€‚<strong>ï¼ˆæ³¨æ„ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¼ºçƒˆå»ºè®®å¯ç”¨ TLS/SSL åŠ å¯†ï¼Œå¹¶ä¿æŒ <code>disable_plaintext_auth = yes</code> ä»¥æé«˜å®‰å…¨æ€§ã€‚ï¼‰</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">disable_plaintext_auth = no</span><br></pre></td></tr></table></figure><p>æ‰¾åˆ° <code>auth_mechanisms</code> è¡Œï¼Œå¹¶ç¡®ä¿å®ƒåŒ…å« <code>plain</code> å’Œ <code>login</code>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auth_mechanisms = plain login</span><br></pre></td></tr></table></figure><p>ä¿å­˜å¹¶å…³é—­æ–‡ä»¶ã€‚</p><p>ç¼–è¾‘ <code>10-master.conf</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> nano /etc/dovecot/conf.d/10-master.conf</span><br></pre></td></tr></table></figure><p>æ‰¾åˆ° <code>service auth</code> éƒ¨åˆ†ï¼Œå¹¶ç¡®ä¿ <code>unix_listener /var/spool/postfix/private/auth</code> è¡Œå­˜åœ¨ä¸”æœªæ³¨é‡Šï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">service auth &#123;</span><br><span class="line">  unix_listener /var/spool/postfix/private/auth &#123;</span><br><span class="line">    mode = 0660</span><br><span class="line">    user = postfix</span><br><span class="line">    group = postfix</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰¾åˆ° <code>service imap-login</code> å’Œ <code>service pop3-login</code> éƒ¨åˆ†ï¼Œç¡®ä¿ <code>inet_listener</code> é€‰é¡¹å­˜åœ¨ä¸”æœªæ³¨é‡Šã€‚</p><p>ä¿å­˜å¹¶å…³é—­æ–‡ä»¶ã€‚</p><p><strong>æ­¥éª¤ 5ï¼šé…ç½® Postfix ä»¥ä½¿ç”¨ Dovecot è¿›è¡Œèº«ä»½éªŒè¯</strong></p><p>ç¼–è¾‘ Postfix çš„ <code>main.cf</code> æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> nano /etc/postfix/main.cf</span><br></pre></td></tr></table></figure><p>æ·»åŠ ä»¥ä¸‹è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">smtpd_sasl_type = dovecot</span><br><span class="line">smtpd_sasl_path = private/auth</span><br><span class="line">smtpd_sasl_auth_enable = yes</span><br><span class="line">smtpd_relay_restrictions = permit_mynetworks,permit_sasl_authenticated,defer_unauth_destination</span><br><span class="line">broken_sasl_auth_clients = yes</span><br></pre></td></tr></table></figure><p>ä¿å­˜å¹¶å…³é—­æ–‡ä»¶ã€‚</p><p><strong>æ­¥éª¤ 6ï¼šè®¾ç½® DNS è®°å½•</strong></p><p>ä½ éœ€è¦è®¾ç½®ä»¥ä¸‹ DNS è®°å½•ï¼Œä»¥ä¾¿é‚®ä»¶æœåŠ¡å™¨å¯ä»¥æ­£å¸¸å·¥ä½œï¼š</p><ul><li><p><strong>A è®°å½•ï¼š</strong> å°†ä½ çš„åŸŸåæˆ–å­åŸŸåï¼ˆä¾‹å¦‚ï¼Œ<code>mail.example.com</code>ï¼‰æŒ‡å‘ä½ çš„æœåŠ¡å™¨çš„é™æ€ IP åœ°å€ã€‚</p></li><li><p><strong>MX è®°å½•ï¼š</strong> æŒ‡ç¤ºé‚®ä»¶æœåŠ¡å™¨çš„åŸŸåã€‚ å°† MX è®°å½•æŒ‡å‘ä½ çš„åŸŸåæˆ–å­åŸŸåï¼ˆä¾‹å¦‚ï¼Œ<code>mail.example.com</code>ï¼‰ã€‚</p></li><li><p><strong>TXT è®°å½• (SPF)ï¼š</strong> SPF è®°å½•ç”¨äºé˜²æ­¢åƒåœ¾é‚®ä»¶ã€‚ æ·»åŠ ä¸€ä¸ª TXT è®°å½•ï¼ŒæŒ‡å®šå…è®¸ä»ä½ çš„åŸŸåå‘é€é‚®ä»¶çš„æœåŠ¡å™¨ã€‚ ä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v=spf1 mx a ip4:ä½ çš„æœåŠ¡å™¨IPåœ°å€ -all</span><br></pre></td></tr></table></figure></li><li><p><strong>TXT è®°å½• (DMARC)ï¼š</strong> DMARC è®°å½•ç”¨äºè¿›ä¸€æ­¥æé«˜é‚®ä»¶å®‰å…¨æ€§ã€‚ æ·»åŠ ä¸€ä¸ª DMARC è®°å½•ï¼ŒæŒ‡ç¤ºå¦‚ä½•å¤„ç†æœªé€šè¿‡ SPF å’Œ DKIM æ£€æŸ¥çš„é‚®ä»¶ã€‚ ä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v=DMARC1; p=none; rua=mailto:postmaster@example.com;</span><br></pre></td></tr></table></figure><p><em>æ³¨æ„ï¼š<code>rua=mailto:postmaster@example.com;</code> è¿™éƒ¨åˆ†æ˜¯å¯é€‰çš„ï¼Œç”¨äºæŒ‡å®šæ¥æ”¶ DMARC æŠ¥å‘Šçš„é‚®ç®±ã€‚</em></p><p>å…·ä½“çš„ DNS è®°å½•è®¾ç½®æ–¹æ³•å–å†³äºä½ çš„åŸŸåæ³¨å†Œå•†ã€‚</p></li></ul><p><strong>æ­¥éª¤ 7ï¼šé‡æ–°å¯åŠ¨æœåŠ¡</strong></p><p>é‡æ–°å¯åŠ¨ Postfix å’Œ Dovecot æœåŠ¡ä»¥åº”ç”¨æ›´æ”¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl restart postfix</span><br><span class="line"><span class="built_in">sudo</span> systemctl restart dovecot</span><br></pre></td></tr></table></figure><p><strong>æ­¥éª¤ 8ï¼šæµ‹è¯•é‚®ä»¶æœåŠ¡å™¨</strong></p><ol><li><strong>åˆ›å»ºç”¨æˆ·:</strong> åˆ›å»ºä¸€ä¸ªç³»ç»Ÿç”¨æˆ·ç”¨äºé‚®ä»¶æµ‹è¯•</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> adduser testuser</span><br></pre></td></tr></table></figure><ol start="2"><li><strong>å‘é€é‚®ä»¶:</strong> ä½¿ç”¨ <code>mail</code> å‘½ä»¤å‘é€é‚®ä»¶ã€‚</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;This is a test email.&quot;</span> | mail -s <span class="string">&quot;Test Email&quot;</span> testuser@example.com</span><br></pre></td></tr></table></figure><ol start="3"><li><strong>æ¥æ”¶é‚®ä»¶:</strong> ä½¿ç”¨ <code>dovecot</code> æä¾›çš„å·¥å…·æˆ–è€… <code>mutt</code> å‘½ä»¤æ¥æ¥æ”¶é‚®ä»¶ã€‚ é¦–å…ˆå®‰è£… <code>mutt</code>:</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install mutt</span><br></pre></td></tr></table></figure><p>ç„¶åè¿è¡Œ <code>mutt</code>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mutt -f /var/mail/testuser</span><br></pre></td></tr></table></figure><p>ä½ åº”è¯¥èƒ½çœ‹åˆ°ä½ å‘é€çš„æµ‹è¯•é‚®ä»¶ã€‚</p><p><strong>æ­¥éª¤ 9ï¼šå®‰å…¨åŠ å›º (é‡è¦!)</strong></p><ul><li><p><strong>å¯ç”¨ TLS/SSL åŠ å¯†ï¼š</strong> ä½¿ç”¨ Letâ€™s Encrypt è·å–å…è´¹çš„ TLS/SSL è¯ä¹¦ï¼Œå¹¶é…ç½® Postfix å’Œ Dovecot ä»¥ä½¿ç”¨åŠ å¯†è¿æ¥ã€‚ è¿™å¯ä»¥ä¿æŠ¤ä½ çš„é‚®ä»¶åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¸è¢«çªƒå¬ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install certbot python3-certbot-nginx</span><br><span class="line"><span class="built_in">sudo</span> certbot --nginx -d mail.example.com</span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œç¼–è¾‘ <code>main.cf</code> å’Œ <code>10-ssl.conf</code> æ–‡ä»¶ä»¥é…ç½® TLS/SSL åŠ å¯†ã€‚</p></li><li><p><strong>é…ç½®é˜²ç«å¢™ï¼š</strong> ä½¿ç”¨ <code>ufw</code> é˜²ç«å¢™ï¼Œåªå…è®¸å¿…è¦çš„ç«¯å£ï¼ˆä¾‹å¦‚ï¼Œ25, 143, 993, 587ï¼‰é€šè¿‡ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> ufw allow 25</span><br><span class="line"><span class="built_in">sudo</span> ufw allow 143</span><br><span class="line"><span class="built_in">sudo</span> ufw allow 993</span><br><span class="line"><span class="built_in">sudo</span> ufw allow 587</span><br><span class="line"><span class="built_in">sudo</span> ufw <span class="built_in">enable</span></span><br></pre></td></tr></table></figure></li><li><p><strong>å®‰è£…å’Œé…ç½® Fail2banï¼š</strong> Fail2ban å¯ä»¥è‡ªåŠ¨é˜»æ­¢å°è¯•æš´åŠ›ç ´è§£ä½ çš„æœåŠ¡å™¨çš„ IP åœ°å€ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install fail2ban</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> /etc/fail2ban/jail.conf /etc/fail2ban/jail.local</span><br><span class="line"><span class="built_in">sudo</span> nano /etc/fail2ban/jail.local</span><br></pre></td></tr></table></figure><p>ç¼–è¾‘ <code>jail.local</code> æ–‡ä»¶ï¼Œå¯ç”¨å¯¹ Postfix å’Œ Dovecot çš„ä¿æŠ¤ã€‚</p></li><li><p><strong>å®šæœŸæ›´æ–°ç³»ç»Ÿï¼š</strong> ä¿æŒä½ çš„ Ubuntu æœåŠ¡å™¨æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œä»¥ä¿®è¡¥å®‰å…¨æ¼æ´ã€‚</p></li></ul><p><strong>æ­¥éª¤ 10ï¼šé˜²æ­¢åƒåœ¾é‚®ä»¶</strong></p><ul><li><strong>è®¾ç½®åå‘ DNS (PTR) è®°å½•ï¼š</strong> ç¡®ä¿ä½ çš„æœåŠ¡å™¨ IP åœ°å€å…·æœ‰æ­£ç¡®çš„åå‘ DNS è®°å½•ã€‚ è¿™å¯ä»¥å¸®åŠ©éªŒè¯ä½ çš„æœåŠ¡å™¨æ˜¯å¦æ˜¯ä¸€ä¸ªåˆæ³•çš„é‚®ä»¶æœåŠ¡å™¨ã€‚ è”ç³»ä½ çš„æœåŠ¡å™¨æä¾›å•†è®¾ç½® PTR è®°å½•ã€‚</li><li><strong>ä½¿ç”¨ DKIMï¼š</strong> DKIMï¼ˆDomainKeys Identified Mailï¼‰æ˜¯ä¸€ç§ç”µå­é‚®ä»¶èº«ä»½éªŒè¯æ–¹æ³•ï¼Œå…è®¸ä½ çš„é‚®ä»¶æœåŠ¡å™¨å¯¹å‘å‡ºçš„é‚®ä»¶è¿›è¡Œæ•°å­—ç­¾åã€‚</li><li><strong>ä½¿ç”¨ DMARCï¼š</strong> DMARCï¼ˆDomain-based Message Authentication, Reporting &amp; Conformanceï¼‰æ˜¯ä¸€ç§ç”µå­é‚®ä»¶èº«ä»½éªŒè¯ç­–ç•¥ï¼Œå…è®¸ä½ æŒ‡å®šå¦‚ä½•å¤„ç†æœªé€šè¿‡ SPF å’Œ DKIM æ£€æŸ¥çš„é‚®ä»¶ã€‚</li></ul><p><strong>æ³¨æ„äº‹é¡¹ï¼š</strong></p><ul><li><strong>å®‰å…¨æ€§ï¼š</strong> è®¾ç½®é‚®ä»¶æœåŠ¡å™¨éœ€è¦éå¸¸é‡è§†å®‰å…¨æ€§ã€‚ è¯·åŠ¡å¿…é‡‡å–æ‰€æœ‰å¿…è¦çš„å®‰å…¨æªæ–½ï¼Œä»¥é˜²æ­¢åƒåœ¾é‚®ä»¶ã€ç½‘ç»œé’“é±¼å’Œå…¶ä»–æ¶æ„æ´»åŠ¨ã€‚</li><li><strong>å¯é€è¾¾æ€§ï¼š</strong> ç¡®ä¿ä½ çš„é‚®ä»¶æœåŠ¡å™¨ç¬¦åˆç”µå­é‚®ä»¶å‘é€çš„æœ€ä½³å®è·µï¼Œä»¥æé«˜é‚®ä»¶çš„å¯é€è¾¾æ€§ã€‚ è¿™åŒ…æ‹¬è®¾ç½®æ­£ç¡®çš„ DNS è®°å½•ã€ä½¿ç”¨ DKIM å’Œ DMARCï¼Œä»¥åŠé¿å…å‘é€åƒåœ¾é‚®ä»¶ã€‚</li><li><strong>ç›‘æ§ï¼š</strong> æŒç»­ç›‘æ§ä½ çš„é‚®ä»¶æœåŠ¡å™¨çš„æ€§èƒ½å’Œå®‰å…¨çŠ¶å†µã€‚ æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ï¼Œä»¥ä¾¿åŠæ—¶å‘ç°å’Œè§£å†³ä»»ä½•é—®é¢˜ã€‚</li><li>**IPä¿¡èª‰ï¼š**ä¿æŒIPä¿¡èª‰è‰¯å¥½å¯¹äºé‚®ä»¶çš„æˆåŠŸå‘é€è‡³å…³é‡è¦ï¼ŒåŠ¡å¿…éµå®ˆå‘é€è§„åˆ™å’Œé¿å…å‘é€åƒåœ¾é‚®ä»¶ï¼Œå¦åˆ™ä½ çš„é‚®ä»¶å¯èƒ½è¢«æ ‡è®°ä¸ºåƒåœ¾é‚®ä»¶ã€‚</li></ul><h2 id="å®¢æˆ·ç«¯ä½¿ç”¨">å®¢æˆ·ç«¯ä½¿ç”¨</h2><p>åœ¨æœ¬åœ°æµ‹è¯•é‚®ä»¶æœåŠ¡å™¨çš„å¯ç”¨æ€§ï¼Œæ˜¯æŒ‡åœ¨ä½ çš„é‚®ä»¶æœåŠ¡å™¨æ­å»ºå¥½åï¼Œåœ¨ä¸æ¶‰åŠåˆ°å¤–éƒ¨ç½‘ç»œçš„æƒ…å†µä¸‹ï¼ŒéªŒè¯å®ƒæ˜¯å¦èƒ½å¤Ÿæ­£ç¡®åœ°å‘é€å’Œæ¥æ”¶é‚®ä»¶ã€‚ è¿™é€šå¸¸åœ¨ä½ æœåŠ¡å™¨æ­å»ºçš„åˆæœŸé˜¶æ®µè¿›è¡Œï¼Œç”¨äºæ’æŸ¥åŸºæœ¬é…ç½®é—®é¢˜ã€‚</p><p>ä»¥ä¸‹æ˜¯å‡ ç§åœ¨æœ¬åœ°æµ‹è¯•é‚®ä»¶æœåŠ¡å™¨å¯ç”¨æ€§çš„æ–¹æ³•ï¼š</p><p><strong>æ–¹æ³• 1ï¼šä½¿ç”¨ <code>mail</code> å‘½ä»¤ï¼ˆç®€å•å¿«é€Ÿï¼‰</strong></p><p><code>mail</code> å‘½ä»¤æ˜¯ä¸€ä¸ªç®€å•çš„å‘½ä»¤è¡Œé‚®ä»¶å®¢æˆ·ç«¯ï¼Œé€‚ç”¨äºå¿«é€Ÿæµ‹è¯•ã€‚</p><ol><li><p><strong>ç¡®ä¿ <code>mail</code> å‘½ä»¤å·²å®‰è£…ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install mailutils</span><br></pre></td></tr></table></figure></li><li><p><strong>å‘é€é‚®ä»¶åˆ°æœ¬åœ°ç”¨æˆ·ï¼š</strong><br>å‡è®¾ä½ çš„ç³»ç»Ÿä¸Šæœ‰ä¸€ä¸ªç”¨æˆ·åä¸º <code>testuser</code>ï¼Œå¹¶ä¸”é‚®ä»¶æœåŠ¡å™¨é…ç½®äº†åŸŸå <code>example.com</code>ï¼Œä½ å¯ä»¥å°è¯•å‘ <code>testuser@example.com</code> å‘é€é‚®ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;This is a test email.&quot;</span> | mail -s <span class="string">&quot;Test Email&quot;</span> testuser@example.com</span><br></pre></td></tr></table></figure></li><li><p><strong>æ£€æŸ¥æœ¬åœ°ç”¨æˆ·çš„é‚®ç®±ï¼š</strong></p><p>æœ¬åœ°ç”¨æˆ·çš„é‚®ç®±é€šå¸¸ä½äº <code>/var/mail/&lt;ç”¨æˆ·å&gt;</code>ã€‚ ä½¿ç”¨ <code>mutt</code> æˆ–è€…ç›´æ¥æŸ¥çœ‹æ–‡ä»¶å†…å®¹ï¼š</p><ul><li><p><strong>ä½¿ç”¨ <code>mutt</code>ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install mutt  <span class="comment"># å¦‚æœæ²¡æœ‰å®‰è£…</span></span><br><span class="line">mutt -f /var/mail/testuser</span><br></pre></td></tr></table></figure></li><li><p><strong>ç›´æ¥æŸ¥çœ‹æ–‡ä»¶ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">cat</span> /var/mail/testuser</span><br></pre></td></tr></table></figure></li></ul><p>å¦‚æœé‚®ä»¶æœåŠ¡å™¨é…ç½®æ­£ç¡®ï¼Œä½ åº”è¯¥èƒ½åœ¨ <code>testuser</code> çš„é‚®ç®±ä¸­çœ‹åˆ°ä½ å‘é€çš„æµ‹è¯•é‚®ä»¶ã€‚</p></li></ol><p><strong>æ–¹æ³• 2ï¼šä½¿ç”¨ <code>swaks</code> å‘½ä»¤ï¼ˆæ›´è¯¦ç»†çš„æµ‹è¯•ï¼‰</strong></p><p><code>swaks</code> (Swiss Army Knife for SMTP) æ˜¯ä¸€ä¸ªæ›´å¼ºå¤§çš„å‘½ä»¤è¡Œ SMTP æµ‹è¯•å·¥å…·ã€‚ å®ƒå¯ä»¥è®©ä½ æ›´è¯¦ç»†åœ°æ§åˆ¶é‚®ä»¶å‘é€è¿‡ç¨‹ï¼Œå¹¶æ£€æŸ¥æœåŠ¡å™¨çš„å“åº”ã€‚</p><ol><li><p><strong>å®‰è£… <code>swaks</code>ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install swaks</span><br></pre></td></tr></table></figure></li><li><p><strong>å‘é€é‚®ä»¶å¹¶æ£€æŸ¥å“åº”ï¼š</strong></p><p>ä½¿ç”¨ <code>swaks</code> å‘½ä»¤å‘é€é‚®ä»¶ï¼Œå¹¶æ£€æŸ¥æœåŠ¡å™¨çš„å“åº”ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swaks --to testuser@example.com --from youruser@example.com --server localhost --header <span class="string">&quot;Subject: Test Email from Swaks&quot;</span> --body <span class="string">&quot;This is a test email from swaks.&quot;</span> --verbose</span><br></pre></td></tr></table></figure><ul><li><code>--to</code>ï¼šæ”¶ä»¶äººåœ°å€ã€‚</li><li><code>--from</code>ï¼šå‘ä»¶äººåœ°å€ï¼ˆå¿…é¡»æ˜¯é‚®ä»¶æœåŠ¡å™¨å…è®¸å‘é€çš„åœ°å€ï¼‰ã€‚</li><li><code>--server</code>ï¼šé‚®ä»¶æœåŠ¡å™¨åœ°å€ (localhost è¡¨ç¤ºæœ¬åœ°æœåŠ¡å™¨)ã€‚</li><li><code>--header</code>ï¼šé‚®ä»¶å¤´éƒ¨ä¿¡æ¯ (ä¾‹å¦‚ï¼Œä¸»é¢˜)ã€‚</li><li><code>--body</code>ï¼šé‚®ä»¶æ­£æ–‡ã€‚</li><li><code>--verbose</code>ï¼šæ˜¾ç¤ºè¯¦ç»†çš„å‘é€è¿‡ç¨‹å’ŒæœåŠ¡å™¨å“åº”ã€‚</li></ul><p>æ£€æŸ¥ <code>swaks</code> çš„è¾“å‡ºï¼Œç¡®ä¿æœåŠ¡å™¨è¿”å›äº† â€œ250 OKâ€ æˆ–ç±»ä¼¼çš„æˆåŠŸä»£ç ã€‚ å¦‚æœå‡ºç°é”™è¯¯ï¼Œå¯ä»¥æ ¹æ®é”™è¯¯ä¿¡æ¯æ’æŸ¥é—®é¢˜ã€‚</p></li></ol><p><strong>æ–¹æ³• 3ï¼šä½¿ç”¨æœ¬åœ°é‚®ä»¶å®¢æˆ·ç«¯ï¼ˆä¾‹å¦‚ Thunderbirdï¼‰</strong></p><p>å¦‚æœä½ çš„ç³»ç»Ÿä¸Šå®‰è£…äº†å›¾å½¢ç•Œé¢çš„é‚®ä»¶å®¢æˆ·ç«¯ (ä¾‹å¦‚ Thunderbird)ï¼Œä½ å¯ä»¥é…ç½®å®ƒæ¥è¿æ¥åˆ°æœ¬åœ°é‚®ä»¶æœåŠ¡å™¨ï¼Œå¹¶å‘é€å’Œæ¥æ”¶é‚®ä»¶ã€‚</p><ol><li><p><strong>é…ç½®é‚®ä»¶å®¢æˆ·ç«¯ï¼š</strong></p><ul><li><strong>è´¦æˆ·ç±»å‹ï¼š</strong> æ‰‹åŠ¨é…ç½®è´¦æˆ·ã€‚</li><li><strong>æ”¶ä»¶æœåŠ¡å™¨ (IMAP/POP3)ï¼š</strong><ul><li>æœåŠ¡å™¨åœ°å€ï¼š<code>localhost</code> æˆ– <code>127.0.0.1</code></li><li>ç«¯å£ï¼š143 (IMAP) æˆ– 110 (POP3) - å¦‚æœå¯ç”¨äº† SSL/TLSï¼Œåˆ™ä½¿ç”¨ 993 (IMAPS) æˆ– 995 (POP3S)</li><li>å®‰å…¨è¿æ¥ï¼šæ ¹æ®ä½ çš„æœåŠ¡å™¨é…ç½®é€‰æ‹© â€œSTARTTLSâ€ æˆ– â€œSSL/TLSâ€ã€‚ å¦‚æœä½ æ²¡æœ‰å¯ç”¨ TLS/SSLï¼Œåˆ™é€‰æ‹© â€œæ— åŠ å¯†â€ã€‚</li><li>èº«ä»½éªŒè¯æ–¹æ³•ï¼šé€‰æ‹© â€œæ™®é€šå¯†ç â€ æˆ– â€œåŠ å¯†å¯†ç â€ã€‚</li></ul></li><li><strong>å‘ä»¶æœåŠ¡å™¨ (SMTP)ï¼š</strong><ul><li>æœåŠ¡å™¨åœ°å€ï¼š<code>localhost</code> æˆ– <code>127.0.0.1</code></li><li>ç«¯å£ï¼š25 æˆ– 587 (å¦‚æœä½¿ç”¨ STARTTLS) - å¦‚æœå¯ç”¨äº† SSL/TLSï¼Œåˆ™ä½¿ç”¨ 465 (SMTPS)</li><li>å®‰å…¨è¿æ¥ï¼šæ ¹æ®ä½ çš„æœåŠ¡å™¨é…ç½®é€‰æ‹© â€œSTARTTLSâ€ æˆ– â€œSSL/TLSâ€ã€‚ å¦‚æœä½ æ²¡æœ‰å¯ç”¨ TLS/SSLï¼Œåˆ™é€‰æ‹© â€œæ— åŠ å¯†â€ã€‚</li><li>èº«ä»½éªŒè¯æ–¹æ³•ï¼šé€‰æ‹© â€œæ™®é€šå¯†ç â€ æˆ– â€œåŠ å¯†å¯†ç â€ã€‚</li><li>ç”¨æˆ·åï¼šå¿…é¡»è®¾ç½®ä¸ºå¯ç”¨çš„ç”¨æˆ·ï¼Œè®¾ç½®éœ€è¦å‘é€è´¦å·å’Œç”¨æˆ·å¯†ç </li></ul></li></ul></li><li><p><strong>å‘é€å’Œæ¥æ”¶é‚®ä»¶ï¼š</strong><br>ä½¿ç”¨é‚®ä»¶å®¢æˆ·ç«¯å‘é€é‚®ä»¶åˆ°æœ¬åœ°ç”¨æˆ·ï¼ˆä¾‹å¦‚ï¼Œ<code>testuser@example.com</code>ï¼‰ï¼Œå¹¶æ£€æŸ¥æ˜¯å¦èƒ½å¤ŸæˆåŠŸæ¥æ”¶ã€‚</p></li></ol><p><strong>æ–¹æ³• 4ï¼šæ£€æŸ¥é‚®ä»¶æ—¥å¿—</strong></p><p>æ— è®ºä½¿ç”¨å“ªç§æ–¹æ³•æµ‹è¯•ï¼Œéƒ½åº”è¯¥æ£€æŸ¥é‚®ä»¶æœåŠ¡å™¨çš„æ—¥å¿—æ–‡ä»¶ï¼Œä»¥äº†è§£é‚®ä»¶çš„å‘é€å’Œæ¥æ”¶æƒ…å†µã€‚</p><ul><li><strong>Postfix æ—¥å¿—ï¼š</strong> <code>/var/log/mail.log</code> æˆ– <code>/var/log/maillog</code></li><li><strong>Dovecot æ—¥å¿—ï¼š</strong> <code>/var/log/dovecot.log</code></li></ul><h2 id="å¯è§†åŒ–æ³¨å†Œä¸ä½¿ç”¨æ–¹æ¡ˆ">å¯è§†åŒ–æ³¨å†Œä¸ä½¿ç”¨æ–¹æ¡ˆ</h2><p>åœ¨ Ubuntu æœåŠ¡å™¨ä¸Šæ­å»ºé‚®ä»¶æœåŠ¡å™¨åï¼Œå¹¶ä¸èƒ½ç›´æ¥â€œå›¾å½¢åŒ–æ³¨å†Œé‚®ç®±â€ã€‚ ä¸Šè¿°æ•™ç¨‹æ­å»ºçš„æ˜¯é‚®ä»¶æœåŠ¡å™¨çš„åº•å±‚åŸºç¡€ï¼Œéœ€è¦æ‰‹åŠ¨åˆ›å»º Linux ç³»ç»Ÿç”¨æˆ·ï¼Œè¿™äº›ç”¨æˆ·æ‰èƒ½é€šè¿‡ IMAP/POP3 ç­‰åè®®è®¿é—®é‚®ä»¶ã€‚ å¦‚æœä½ æƒ³è¦æä¾›ä¸€ç§â€œå›¾å½¢åŒ–æ³¨å†Œé‚®ç®±â€çš„ä½“éªŒï¼Œä½ éœ€è¦é¢å¤–çš„è½¯ä»¶æ¥ç®¡ç†é‚®ç®±è´¦æˆ·ï¼Œå¹¶æä¾›ä¸€ä¸ª Web ç•Œé¢ä¾›ç”¨æˆ·æ³¨å†Œå’Œç®¡ç†ä»–ä»¬çš„é‚®ç®±ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€äº›å¯è¡Œçš„æ–¹æ¡ˆï¼Œå®ƒä»¬éƒ½éœ€è¦å®‰è£…é¢å¤–çš„è½¯ä»¶ï¼Œå¹¶è¿›è¡Œé…ç½®ã€‚</p><p><strong>æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ iRedMail (æ¨è)</strong></p><p>iRedMail æ˜¯ä¸€ä¸ªéå¸¸æµè¡Œçš„ã€å¼€æºçš„é‚®ä»¶æœåŠ¡å™¨è§£å†³æ–¹æ¡ˆï¼Œå®ƒæä¾›äº†ä¸€ä¸ª Web ç•Œé¢ï¼Œç”¨äºç®¡ç†é‚®ç®±ã€ç”¨æˆ·å’ŒåŸŸåã€‚ iRedMail å¯ä»¥è‡ªåŠ¨åŒ–é…ç½® Postfixã€Dovecotã€Roundcube Webmail ç­‰ç»„ä»¶ï¼Œå¹¶æä¾›äº†ä¸€ä¸ªæ˜“äºä½¿ç”¨çš„ç®¡ç†ç•Œé¢ã€‚</p><ol><li><p><strong>ä¸‹è½½ iRedMail å®‰è£…è„šæœ¬ï¼š</strong><br>è®¿é—® <a href="https://www.iredmail.org/">https://www.iredmail.org/</a> ä¸‹è½½æœ€æ–°çš„ iRedMail å®‰è£…è„šæœ¬ã€‚</p></li><li><p><strong>è¿è¡Œå®‰è£…è„šæœ¬ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar xzf iRedMail-x.y.z.tar.gz  <span class="comment"># è§£å‹ä¸‹è½½çš„å‹ç¼©åŒ…</span></span><br><span class="line"><span class="built_in">cd</span> iRedMail-x.y.z</span><br><span class="line"><span class="built_in">sudo</span> bash iRedMail.sh</span><br></pre></td></tr></table></figure><p>æŒ‰ç…§å®‰è£…è„šæœ¬çš„æç¤ºè¿›è¡Œæ“ä½œã€‚ ä½ éœ€è¦è®¾ç½®ç®¡ç†å‘˜å¯†ç ã€é€‰æ‹©æ•°æ®åº“ç±»å‹ã€è®¾ç½®åŸŸåç­‰ã€‚</p></li><li><p><strong>è®¿é—® iRedMail Web ç®¡ç†ç•Œé¢ï¼š</strong><br>å®‰è£…å®Œæˆåï¼Œè®¿é—® iRedMail Web ç®¡ç†ç•Œé¢ã€‚ ç•Œé¢åœ°å€é€šå¸¸æ˜¯ <code>https://ä½ çš„æœåŠ¡å™¨IPåœ°å€/iredadmin/</code> æˆ– <code>https://ä½ çš„åŸŸå/iredadmin/</code>ã€‚</p></li><li><p><strong>ä½¿ç”¨ Web ç•Œé¢åˆ›å»ºé‚®ç®±è´¦æˆ·ï¼š</strong><br>ä½¿ç”¨ç®¡ç†å‘˜è´¦æˆ·ç™»å½• iRedMail Web ç®¡ç†ç•Œé¢ï¼Œç„¶åä½ å¯ä»¥åˆ›å»ºæ–°çš„é‚®ç®±è´¦æˆ·ï¼Œè®¾ç½®å¯†ç ç­‰ã€‚</p></li><li><p><strong>è®©ç”¨æˆ·è®¿é—®Webé‚®ç®±</strong></p><p>iRedMail é›†æˆäº† Roundcube Webmailã€‚ ç”¨æˆ·å¯ä»¥ä½¿ç”¨æµè§ˆå™¨è®¿é—®ä»–ä»¬çš„é‚®ç®±ï¼Œåœ°å€é€šå¸¸æ˜¯<code>https://ä½ çš„æœåŠ¡å™¨IPåœ°å€/mail/</code> æˆ– <code>https://ä½ çš„åŸŸå/mail/</code>ã€‚</p></li></ol><p><strong>æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ Mail-in-a-Box</strong></p><p>Mail-in-a-Box æ˜¯å¦ä¸€ä¸ªæ˜“äºä½¿ç”¨çš„é‚®ä»¶æœåŠ¡å™¨è§£å†³æ–¹æ¡ˆï¼Œæ—¨åœ¨ç®€åŒ–é‚®ä»¶æœåŠ¡å™¨çš„è®¾ç½®å’Œç®¡ç†ã€‚ å®ƒä¹Ÿæä¾›äº†ä¸€ä¸ª Web ç•Œé¢ï¼Œç”¨äºç®¡ç†é‚®ç®±ã€ç”¨æˆ·å’ŒåŸŸåã€‚</p><ol><li><p><strong>ä¸‹è½½ Mail-in-a-Box å®‰è£…è„šæœ¬ï¼š</strong><br>è®¿é—® <a href="https://mailinabox.email/">https://mailinabox.email/</a> è·å–æœ€æ–°çš„å®‰è£…è¯´æ˜ã€‚</p></li><li><p><strong>è¿è¡Œå®‰è£…è„šæœ¬ï¼š</strong><br>æŒ‰ç…§ Mail-in-a-Box çš„å®‰è£…è¯´æ˜è¿›è¡Œæ“ä½œã€‚ å®‰è£…è¿‡ç¨‹ç›¸å¯¹ç®€å•ï¼Œä¼šè‡ªåŠ¨é…ç½®æ‰€éœ€çš„ç»„ä»¶ã€‚</p></li><li><p><strong>è®¿é—® Mail-in-a-Box Web ç®¡ç†ç•Œé¢ï¼š</strong><br>å®‰è£…å®Œæˆåï¼Œè®¿é—® Mail-in-a-Box Web ç®¡ç†ç•Œé¢ã€‚</p></li><li><p><strong>ä½¿ç”¨ Web ç•Œé¢åˆ›å»ºé‚®ç®±è´¦æˆ·ï¼š</strong><br>ä½¿ç”¨ç®¡ç†å‘˜è´¦æˆ·ç™»å½• Mail-in-a-Box Web ç®¡ç†ç•Œé¢ï¼Œç„¶åä½ å¯ä»¥åˆ›å»ºæ–°çš„é‚®ç®±è´¦æˆ·ã€‚</p></li></ol><p><strong>æ–¹æ¡ˆ 3ï¼šæ‰‹åŠ¨é…ç½® Roundcube Webmail æˆ– Rainloop (æ›´å¤æ‚)</strong></p><p>å¦‚æœä½ ä¸æƒ³ä½¿ç”¨å®Œæ•´çš„é‚®ä»¶æœåŠ¡å™¨è§£å†³æ–¹æ¡ˆï¼Œä½ å¯ä»¥æ‰‹åŠ¨å®‰è£…å’Œé…ç½® Roundcube Webmail æˆ– Rainloop Webmailï¼Œå¹¶å°†å…¶ä¸ä½ çš„ Postfix å’Œ Dovecot é‚®ä»¶æœåŠ¡å™¨é›†æˆã€‚</p><ol><li><p><strong>å®‰è£… Web æœåŠ¡å™¨ï¼š</strong><br>é¦–å…ˆï¼Œä½ éœ€è¦å®‰è£…ä¸€ä¸ª Web æœåŠ¡å™¨ï¼ˆä¾‹å¦‚ï¼ŒApache æˆ– Nginxï¼‰ã€‚</p></li><li><p><strong>å®‰è£… PHPï¼š</strong><br>ä½ éœ€è¦å®‰è£… PHP å’Œä¸€äº›å¿…è¦çš„ PHP æ‰©å±•ã€‚</p></li><li><p><strong>ä¸‹è½½å’Œå®‰è£… Roundcube Webmail æˆ– Rainloopï¼š</strong><br>ä»å®˜æ–¹ç½‘ç«™ä¸‹è½½ Roundcube Webmail æˆ– Rainloop çš„æœ€æ–°ç‰ˆæœ¬ï¼Œå¹¶å°†å…¶è§£å‹åˆ°ä½ çš„ Web æœåŠ¡å™¨çš„æ–‡æ¡£æ ¹ç›®å½•ä¸­ã€‚</p></li><li><p><strong>é…ç½® Roundcube Webmail æˆ– Rainloopï¼š</strong><br>æŒ‰ç…§ Roundcube Webmail æˆ– Rainloop çš„å®‰è£…è¯´æ˜è¿›è¡Œé…ç½®ã€‚ ä½ éœ€è¦è®¾ç½®æ•°æ®åº“è¿æ¥ä¿¡æ¯ã€IMAP å’Œ SMTP æœåŠ¡å™¨åœ°å€ã€èº«ä»½éªŒè¯æ–¹æ³•ç­‰ã€‚</p></li><li><p><strong>åˆ›å»º Web ç•Œé¢ç”¨äºæ³¨å†Œç”¨æˆ·ï¼š</strong><br>å¼€å‘è‡ªå·±çš„Webç•Œé¢ï¼Œç”¨äºæ·»åŠ ç”¨æˆ·åˆ°æ•°æ®åº“ä¸­ã€‚</p></li></ol><p><strong>æ–¹æ¡ˆå¯¹æ¯”</strong></p><table><thead><tr><th>ç‰¹æ€§</th><th>iRedMail</th><th>Mail-in-a-Box</th><th>æ‰‹åŠ¨é…ç½® Webmail</th></tr></thead><tbody><tr><td>æ˜“ç”¨æ€§</td><td>ç®€å•</td><td>ç®€å•</td><td>å¤æ‚</td></tr><tr><td>Web ç®¡ç†ç•Œé¢</td><td>æœ‰</td><td>æœ‰</td><td>éœ€è¦æ‰‹åŠ¨æ·»åŠ </td></tr><tr><td>è‡ªåŠ¨é…ç½®</td><td>æ˜¯</td><td>æ˜¯</td><td>å¦</td></tr><tr><td>çµæ´»æ€§</td><td>è¾ƒä½</td><td>è¾ƒä½</td><td>é«˜</td></tr><tr><td>ç¤¾åŒºæ”¯æŒ</td><td>æ´»è·ƒ</td><td>æ´»è·ƒ</td><td>å–å†³äºé€‰æ‹©çš„ Webmail</td></tr><tr><td>é€‚ç”¨åœºæ™¯</td><td>å¿«é€Ÿæ­å»ºé‚®ä»¶æœåŠ¡å™¨</td><td>å¿«é€Ÿæ­å»ºé‚®ä»¶æœåŠ¡å™¨</td><td>è‡ªå®šä¹‰ç¨‹åº¦é«˜çš„åœºæ™¯</td></tr></tbody></table><p><strong>é€‰æ‹©å“ªä¸ªæ–¹æ¡ˆï¼Ÿ</strong></p><ul><li><p><strong>iRedMail æˆ– Mail-in-a-Boxï¼š</strong> å¦‚æœä½ å¸Œæœ›å¿«é€Ÿæ­å»ºä¸€ä¸ªåŠŸèƒ½å®Œå–„çš„é‚®ä»¶æœåŠ¡å™¨ï¼Œå¹¶ä¸”ä¸éœ€è¦å¤ªå¤šçš„è‡ªå®šä¹‰ï¼Œé‚£ä¹ˆ iRedMail æˆ– Mail-in-a-Box æ˜¯ä¸é”™çš„é€‰æ‹©ã€‚</p></li><li><p><strong>æ‰‹åŠ¨é…ç½®Webmail:</strong> å¦‚æœä½ éœ€è¦é«˜åº¦è‡ªå®šä¹‰ï¼Œ é‚£ä¹ˆé€‰æ‹©è¿™ä¸ªæ–¹å¼ã€‚</p></li></ul><p><strong>æ€»ç»“ï¼š</strong></p><p>è¦å®ç°â€œå›¾å½¢åŒ–æ³¨å†Œé‚®ç®±â€çš„åŠŸèƒ½ï¼Œä½ éœ€è¦å®‰è£…é¢å¤–çš„è½¯ä»¶ï¼Œå¹¶æä¾›ä¸€ä¸ª Web ç•Œé¢ä¾›ç”¨æˆ·æ³¨å†Œå’Œç®¡ç†ä»–ä»¬çš„é‚®ç®±ã€‚ iRedMail å’Œ Mail-in-a-Box æ˜¯ä¸¤ç§æµè¡Œçš„é€‰æ‹©ï¼Œå®ƒä»¬æä¾›äº†æ˜“äºä½¿ç”¨çš„ Web ç®¡ç†ç•Œé¢ï¼Œå¯ä»¥ç®€åŒ–é‚®ä»¶æœåŠ¡å™¨çš„ç®¡ç†ã€‚ ä½ ä¹Ÿå¯ä»¥é€‰æ‹©æ‰‹åŠ¨å®‰è£…å’Œé…ç½® Roundcube Webmail æˆ– Rainloop Webmailï¼Œä½†è¿™ç§æ–¹æ³•æ›´å¤æ‚ã€‚ è¯·åŠ¡å¿…ä»”ç»†é˜…è¯»æ‰€é€‰æ–¹æ¡ˆçš„æ–‡æ¡£ï¼Œå¹¶æŒ‰ç…§è¯´æ˜è¿›è¡Œæ“ä½œã€‚</p><h2 id="æ—¥å¿—è¯Šæ–­">æ—¥å¿—è¯Šæ–­</h2><ul><li>nginx</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> less /var/log/nginx/error.log</span><br><span class="line"><span class="built_in">sudo</span> less /var/log/nginx/access.log</span><br></pre></td></tr></table></figure><ul><li>mail</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">tail</span> -n 50 /var/log/mail.err</span><br></pre></td></tr></table></figure><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;åœ¨ubuntuä½¿ç”¨Postfixæ­å»ºé‚®ä»¶æœåŠ¡å™¨&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;åœ¨ Ubuntu æœåŠ¡å™¨ä¸Šæ­å»ºé‚®ä»¶æœåŠ¡å™¨çš„æ•™ç¨‹ã€‚ Postfix ä½œä¸ºé‚®ä»¶ä¼ è¾“ä»£ç† (MTA)ï¼ŒDovecot ä½œä¸ºé‚®ä»¶æŠ•é€’ä»£ç† (MDA)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p</summary>
      
    
    
    
    
    <category term="ubuntu" scheme="https://caozhaoqi.github.io/tags/ubuntu/"/>
    
  </entry>
  
  <entry>
    <title>æ­å»º Git æˆ– SVN æœåŠ¡å™¨å¹¶é€šè¿‡ Samba å…±äº«</title>
    <link href="https://caozhaoqi.github.io/2025/03/18/smb-git-svn/"/>
    <id>https://caozhaoqi.github.io/2025/03/18/smb-git-svn/</id>
    <published>2025-03-18T03:40:56.000Z</published>
    <updated>2025-11-25T15:05:10.365Z</updated>
    
    <content type="html"><![CDATA[<p><strong>ä¸€ã€æ­å»º Git æœåŠ¡å™¨å¹¶é€šè¿‡ Samba å…±äº«</strong></p><p>è¿™ç§æ–¹å¼ä¸‹ï¼ŒGit æœåŠ¡å™¨æœ¬èº«å¤„ç†ç‰ˆæœ¬æ§åˆ¶é€»è¾‘ï¼ŒSamba åªè´Ÿè´£å…±äº« Git ä»“åº“æ‰€åœ¨çš„ç›®å½•ã€‚</p><p><strong>1. å®‰è£… Git å’Œ Samba</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install git samba</span><br></pre></td></tr></table></figure><p><strong>2. åˆ›å»º Git ä»“åº“</strong></p><ul><li><p><strong>åˆ›å»ºä¸€ä¸ªç”¨äºå­˜æ”¾ Git ä»“åº“çš„ç›®å½•ï¼ˆä¾‹å¦‚ <code>/srv/git</code>ï¼‰ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /srv/git</span><br></pre></td></tr></table></figure></li><li><p><strong>è¿›å…¥è¯¥ç›®å½•å¹¶åˆå§‹åŒ–ä¸€ä¸ªè£¸ä»“åº“ï¼ˆbare repositoryï¼‰ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /srv/git</span><br><span class="line"><span class="built_in">sudo</span> git init --bare myproject.git  <span class="comment"># &quot;myproject&quot; æ˜¯ä½ çš„é¡¹ç›®åç§°</span></span><br></pre></td></tr></table></figure><p>è£¸ä»“åº“åªåŒ…å«ç‰ˆæœ¬æ§åˆ¶ä¿¡æ¯ï¼Œæ²¡æœ‰å·¥ä½œç›®å½•ã€‚</p></li><li><p><strong>è®¾ç½®æƒé™</strong></p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> -R www-data:www-data /srv/git/myproject.git <span class="comment">#å‡è®¾ä½ çš„sambaç”¨æˆ·æ˜¯www-data</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> -R 775 /srv/git/myproject.git</span><br></pre></td></tr></table></figure></li></ul><p><strong>3. é…ç½® Samba å…±äº«</strong></p><ul><li><p><strong>ç¼–è¾‘ Samba é…ç½®æ–‡ä»¶ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> vim /etc/samba/smb.conf</span><br></pre></td></tr></table></figure></li><li><p><strong>åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼ˆæ ¹æ®ä½ çš„å®é™…æƒ…å†µä¿®æ”¹ï¼‰ï¼š</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[git-repos]</span></span><br><span class="line">    <span class="attr">comment</span> = Git Repositories</span><br><span class="line">    <span class="attr">path</span> = /srv/git</span><br><span class="line">    <span class="attr">browseable</span> = <span class="literal">yes</span></span><br><span class="line">    read <span class="attr">only</span> = <span class="literal">no</span></span><br><span class="line">    guest <span class="attr">ok</span> = <span class="literal">no</span>  <span class="comment"># å¦‚æœéœ€è¦åŒ¿åè®¿é—®ï¼Œè®¾ç½®ä¸º yes</span></span><br><span class="line">    valid <span class="attr">users</span> = @gitusers  <span class="comment"># å…è®¸è®¿é—®çš„ç”¨æˆ·ç»„ (è§ä¸‹ä¸€æ­¥)</span></span><br><span class="line">    create <span class="attr">mask</span> = <span class="number">0664</span></span><br><span class="line">    directory <span class="attr">mask</span> = <span class="number">0775</span></span><br><span class="line">    force <span class="attr">group</span> = gitusers <span class="comment">#å¼ºåˆ¶ç»„</span></span><br></pre></td></tr></table></figure><ul><li><code>[git-repos]</code>: å…±äº«åç§°ï¼Œå®¢æˆ·ç«¯è®¿é—®æ—¶ä½¿ç”¨ã€‚</li><li><code>path</code>: Git ä»“åº“æ‰€åœ¨çš„ç›®å½•ã€‚</li><li><code>valid users</code>: å…è®¸è®¿é—®çš„ç”¨æˆ·æˆ–ç”¨æˆ·ç»„ï¼ˆéœ€è¦å…ˆåˆ›å»ºç”¨æˆ·/ç»„ï¼‰ã€‚</li><li><code>guest ok</code>: æ˜¯å¦å…è®¸åŒ¿åè®¿é—®ï¼ˆä¸æ¨èï¼‰ã€‚</li></ul></li><li><p><strong>åˆ›å»ºä¸€ä¸ª Samba ç”¨æˆ·ç»„ï¼ˆä¾‹å¦‚ <code>gitusers</code>ï¼‰å¹¶å°†ç”¨æˆ·æ·»åŠ åˆ°è¯¥ç»„ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> groupadd gitusers</span><br><span class="line"><span class="built_in">sudo</span> usermod -aG gitusers nas  </span><br><span class="line"><span class="built_in">sudo</span> smbpasswd -a nas   </span><br></pre></td></tr></table></figure><p>é‡å¤<code>usermod</code>å’Œ<code>smbpasswd</code>å‘½ä»¤ï¼Œæ·»åŠ å¤šä¸ªç”¨æˆ·ã€‚</p></li><li><p><strong>é‡å¯ Samba æœåŠ¡ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl restart smbd</span><br></pre></td></tr></table></figure></li></ul><p><strong>4. å®¢æˆ·ç«¯è®¿é—®</strong></p><ul><li><p><strong>åœ¨ Windows ä¸Šï¼š</strong></p><ul><li>æ‰“å¼€æ–‡ä»¶èµ„æºç®¡ç†å™¨ï¼Œåœ¨åœ°å€æ è¾“å…¥ <code>\\your_server_ip\git-repos</code> ï¼ˆå°† <code>your_server_ip</code> æ›¿æ¢ä¸ºä½ çš„æœåŠ¡å™¨ IP åœ°å€æˆ–ä¸»æœºåï¼‰ã€‚</li><li>è¾“å…¥ä½ çš„ Samba ç”¨æˆ·åå’Œå¯†ç ã€‚</li><li>ä½ åº”è¯¥èƒ½çœ‹åˆ° <code>myproject.git</code> ç›®å½•ã€‚</li></ul></li><li><p><strong>åœ¨ Linux/macOS ä¸Šï¼š</strong></p><ul><li>å¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œæˆ–å›¾å½¢ç•Œé¢çš„ SMB/CIFS å®¢æˆ·ç«¯è®¿é—®ã€‚</li><li>æŒ‚è½½ Samba å…±äº«ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> mount -t cifs //your_server_ip/git-repos /mnt/git -o username=yourusername,password=yourpassword</span><br></pre></td></tr></table></figure>(å°† <code>/mnt/git</code> æ›¿æ¢ä¸ºä½ æƒ³è¦æŒ‚è½½åˆ°çš„æœ¬åœ°ç›®å½•)ã€‚</li></ul></li><li><p><strong>ä½¿ç”¨ Git å®¢æˆ·ç«¯å…‹éš†ä»“åº“ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> smb://your_server_ip/git-repos/myproject.git</span><br><span class="line"><span class="comment"># æˆ–è€…, å¦‚æœå·²ç»æŒ‚è½½:</span></span><br><span class="line">git <span class="built_in">clone</span> /mnt/git/myproject.git  </span><br></pre></td></tr></table></figure><p>ä¹‹åå°±å¯ä»¥åƒä½¿ç”¨æ™®é€šçš„ Git ä»“åº“ä¸€æ ·è¿›è¡Œ <code>add</code>ã€<code>commit</code>ã€<code>push</code>ã€<code>pull</code> ç­‰æ“ä½œã€‚</p></li></ul><p><strong>äºŒã€æ­å»º SVN æœåŠ¡å™¨å¹¶é€šè¿‡ Samba å…±äº«</strong></p><p>ä¸ Git ç±»ä¼¼ï¼ŒSVN æœåŠ¡å™¨å¤„ç†ç‰ˆæœ¬æ§åˆ¶ï¼ŒSamba å…±äº« SVN ä»“åº“ç›®å½•ã€‚</p><p><strong>1. å®‰è£… SVN å’Œ Samba</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install subversion samba libapache2-mod-svn</span><br></pre></td></tr></table></figure><p><code>libapache2-mod-svn</code> æä¾›äº†é€šè¿‡ Apache è¿›è¡Œ SVN è®¿é—®çš„åŠŸèƒ½ (å¯é€‰, ä½†æ›´å®‰å…¨, æ¨è)</p><p><strong>2. åˆ›å»º SVN ä»“åº“</strong></p><ul><li><p><strong>åˆ›å»ºä¸€ä¸ªç”¨äºå­˜æ”¾ SVN ä»“åº“çš„ç›®å½•ï¼ˆä¾‹å¦‚ <code>/srv/svn</code>ï¼‰ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /srv/svn</span><br></pre></td></tr></table></figure></li><li><p><strong>è¿›å…¥è¯¥ç›®å½•å¹¶åˆ›å»ºä¸€ä¸ª SVN ä»“åº“ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /srv/svn</span><br><span class="line"><span class="built_in">sudo</span> svnadmin create myproject  <span class="comment"># &quot;myproject&quot; æ˜¯ä½ çš„é¡¹ç›®åç§°</span></span><br></pre></td></tr></table></figure></li><li><p><strong>è®¾ç½®æƒé™</strong></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> -R www-data:www-data /srv/svn/myproject</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> -R 775 /srv/svn/myproject</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>3.  (å¯é€‰, æ¨è) é…ç½® Apache + SVN (æ›´å®‰å…¨)</strong></p><ul><li><p><strong>åˆ›å»º SVN çš„å¯†ç æ–‡ä»¶ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> htpasswd -c /etc/apache2/dav_svn.passwd yourusername  <span class="comment"># åˆ›å»ºç¬¬ä¸€ä¸ªç”¨æˆ·</span></span><br><span class="line"><span class="built_in">sudo</span> htpasswd /etc/apache2/dav_svn.passwd anotheruser     <span class="comment"># æ·»åŠ æ›´å¤šç”¨æˆ·</span></span><br></pre></td></tr></table></figure></li><li><p><strong>åˆ›å»ºä¸€ä¸ª Apache é…ç½®æ–‡ä»¶ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> nano /etc/apache2/mods-available/dav_svn.conf</span><br></pre></td></tr></table></figure><p>æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;Location /svn&gt;</span></span><br><span class="line">   <span class="attribute">DAV</span> svn</span><br><span class="line">   <span class="attribute">SVNParentPath</span> /srv/svn</span><br><span class="line">   <span class="attribute">AuthType</span> Basic</span><br><span class="line">   <span class="attribute">AuthName</span> <span class="string">&quot;Subversion Repository&quot;</span></span><br><span class="line">   <span class="attribute">AuthUserFile</span> /etc/apache2/dav_svn.passwd</span><br><span class="line">   <span class="attribute">Require</span> valid-user</span><br><span class="line"><span class="section">&lt;/Location&gt;</span></span><br></pre></td></tr></table></figure></li><li><p><strong>å¯ç”¨å¿…è¦çš„ Apache æ¨¡å—å¹¶é‡å¯ Apacheï¼š</strong></p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> a2enmod dav</span><br><span class="line"><span class="built_in">sudo</span> a2enmod dav_svn</span><br><span class="line"><span class="built_in">sudo</span> systemctl restart apache2</span><br></pre></td></tr></table></figure><ul><li>ç°åœ¨, å¯ä»¥é€šè¿‡ <code>http://your_server_ip/svn/myproject</code> æ¥è®¿é—® SVN ä»“åº“ (éœ€è¦ç”¨æˆ·åå’Œå¯†ç ).</li></ul></li></ul><p><strong>4. é…ç½® Samba å…±äº« (å¦‚æœä¸ç”¨ Apache, å¯ä»¥é€šè¿‡ Samba å…±äº«)</strong></p><ul><li><p><strong>ç¼–è¾‘ Samba é…ç½®æ–‡ä»¶ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> nano /etc/samba/smb.conf</span><br></pre></td></tr></table></figure></li><li><p><strong>åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[svn-repos]</span></span><br><span class="line">    <span class="attr">comment</span> = SVN Repositories</span><br><span class="line">    <span class="attr">path</span> = /srv/svn</span><br><span class="line">    <span class="attr">browseable</span> = <span class="literal">yes</span></span><br><span class="line">    read <span class="attr">only</span> = <span class="literal">no</span></span><br><span class="line">    guest <span class="attr">ok</span> = <span class="literal">no</span>  <span class="comment"># å¦‚æœéœ€è¦åŒ¿åè®¿é—®ï¼Œè®¾ç½®ä¸º yes</span></span><br><span class="line">    valid <span class="attr">users</span> = @svnusers <span class="comment">#åŒä¸Šï¼Œéœ€è¦åˆ›å»ºsvnusersç»„å’Œç”¨æˆ·</span></span><br><span class="line">    create <span class="attr">mask</span> = <span class="number">0664</span></span><br><span class="line">    directory <span class="attr">mask</span> = <span class="number">0775</span></span><br><span class="line">    force <span class="attr">group</span> = svnusers</span><br></pre></td></tr></table></figure></li><li><p><strong>åˆ›å»º Samba ç”¨æˆ·ç»„å’Œç”¨æˆ· (å‚è€ƒ Git éƒ¨åˆ†çš„æ­¥éª¤)ã€‚</strong></p></li><li><p><strong>é‡å¯ Samba æœåŠ¡ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl restart smbd</span><br></pre></td></tr></table></figure></li></ul><p><strong>5. å®¢æˆ·ç«¯è®¿é—®</strong></p><ul><li>å¦‚æœä½¿ç”¨ Apache + SVN, ä½¿ç”¨ SVN å®¢æˆ·ç«¯é€šè¿‡ <code>http://your_server_ip/svn/myproject</code> è®¿é—®.</li><li>å¦‚æœä½¿ç”¨ Samba å…±äº«ï¼š<ul><li><strong>Windows:</strong>  <code>\\your_server_ip\svn-repos</code></li><li><strong>Linux/macOS:</strong>  <code>smb://your_server_ip/svn-repos</code> (æˆ–æŒ‚è½½)</li><li>ä½¿ç”¨ SVN å®¢æˆ·ç«¯ï¼ˆå¦‚ TortoiseSVNã€<code>svn</code> å‘½ä»¤è¡Œå·¥å…·ï¼‰è¿›è¡Œ <code>checkout</code>ã€<code>commit</code>ã€<code>update</code> ç­‰æ“ä½œã€‚</li></ul></li></ul><h2 id="smb-å¯ç”¨å›æ”¶ç«™">smb å¯ç”¨å›æ”¶ç«™</h2><p>Samba çš„ <code>vfs_recycle</code> æ¨¡å—æä¾›äº†ä¸€ä¸ªç®€å•ä½†å®ç”¨çš„å›æ”¶ç«™åŠŸèƒ½ï¼Œå¯ä»¥é˜²æ­¢ç”¨æˆ·æ„å¤–åˆ é™¤å…±äº«æ–‡ä»¶ã€‚å½“ç”¨æˆ·é€šè¿‡ Samba åˆ é™¤æ–‡ä»¶æ—¶ï¼Œæ–‡ä»¶ä¸ä¼šè¢«ç«‹å³ä»æœåŠ¡å™¨ä¸Šæ°¸ä¹…åˆ é™¤ï¼Œè€Œæ˜¯ä¼šè¢«ç§»åŠ¨åˆ°ä¸€ä¸ªç‰¹æ®Šçš„å›æ”¶ç«™ç›®å½•ä¸­ã€‚ç®¡ç†å‘˜å¯ä»¥é…ç½®å›æ”¶ç«™çš„ä¿ç•™ç­–ç•¥ï¼Œä¾‹å¦‚æ–‡ä»¶ä¿ç•™æ—¶é—´ã€å›æ”¶ç«™æœ€å¤§å®¹é‡ç­‰ã€‚</p><p>ä¸‹é¢æ˜¯å…³äº <code>vfs_recycle</code> æ¨¡å—çš„è¯¦ç»†è¯´æ˜å’Œé…ç½®æ–¹æ³•ï¼š</p><p><strong>1. å·¥ä½œåŸç†</strong></p><ul><li>å½“ç”¨æˆ·é€šè¿‡ Samba å®¢æˆ·ç«¯åˆ é™¤æ–‡ä»¶æ—¶ï¼Œ<code>vfs_recycle</code> æ¨¡å—ä¼šæ‹¦æˆªåˆ é™¤æ“ä½œã€‚</li><li>æ–‡ä»¶ä¸ä¼šè¢«çœŸæ­£åˆ é™¤ï¼Œè€Œæ˜¯è¢«ç§»åŠ¨åˆ°é¢„å…ˆé…ç½®å¥½çš„å›æ”¶ç«™ç›®å½•ä¸­ã€‚</li><li>ç§»åŠ¨åˆ°å›æ”¶ç«™çš„æ–‡ä»¶ä¼šä¿ç•™ä¸€æ®µæ—¶é—´ï¼ˆå¯é…ç½®ï¼‰ï¼Œè¶…è¿‡ä¿ç•™æ—¶é—´åæ‰ä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚</li><li>ç®¡ç†å‘˜å¯ä»¥æ‰‹åŠ¨æ¸…ç†å›æ”¶ç«™ï¼Œæˆ–è€…æ¢å¤å›æ”¶ç«™ä¸­çš„æ–‡ä»¶ã€‚</li></ul><p><strong>2. é…ç½®æ–¹æ³•</strong></p><p><code>vfs_recycle</code> æ¨¡å—çš„é…ç½®ä¸»è¦åœ¨ Samba çš„é…ç½®æ–‡ä»¶ (<code>/etc/samba/smb.conf</code>) ä¸­å®Œæˆã€‚ä½ å¯ä»¥åœ¨å…¨å±€é…ç½®éƒ¨åˆ† (<code>[global]</code>) ä¸­è®¾ç½®é»˜è®¤çš„å›æ”¶ç«™å‚æ•°ï¼Œä¹Ÿå¯ä»¥åœ¨å•ä¸ªå…±äº«é…ç½®éƒ¨åˆ†ä¸­ä¸ºç‰¹å®šçš„å…±äº«è®¾ç½®ä¸åŒçš„å›æ”¶ç«™å‚æ•°ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªé…ç½®ç¤ºä¾‹ï¼Œæ·»åŠ åˆ°ä½ çš„ <code>smb.conf</code> æ–‡ä»¶ä¸­ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[global]</span></span><br><span class="line">    <span class="comment"># ... å…¶ä»–å…¨å±€é…ç½® ...</span></span><br><span class="line"></span><br><span class="line">    vfs <span class="attr">objects</span> = recycle  <span class="comment"># åœ¨å…¨å±€é…ç½®ä¸­å¯ç”¨ recycle æ¨¡å—</span></span><br><span class="line"></span><br><span class="line">    recycle:<span class="attr">repository</span> = .recycle/%U  <span class="comment"># å›æ”¶ç«™ç›®å½•ï¼Œ%U ä»£è¡¨ç”¨æˆ·å</span></span><br><span class="line">    recycle:<span class="attr">keeptree</span> = <span class="literal">Yes</span>            <span class="comment"># ä¿ç•™åŸå§‹ç›®å½•ç»“æ„</span></span><br><span class="line">    recycle:<span class="attr">versions</span> = <span class="literal">Yes</span>            <span class="comment"># å¯ç”¨ç‰ˆæœ¬æ§åˆ¶ (å¦‚æœæ–‡ä»¶åç›¸åŒ)</span></span><br><span class="line">    recycle:<span class="attr">touch</span> = <span class="literal">Yes</span>               <span class="comment"># æ›´æ–°æ–‡ä»¶çš„è®¿é—®æ—¶é—´</span></span><br><span class="line">    recycle:<span class="attr">maxsize</span> = <span class="number">0</span>               <span class="comment"># å›æ”¶ç«™æœ€å¤§å®¹é‡ (0 è¡¨ç¤ºæ— é™åˆ¶)</span></span><br><span class="line">    recycle:<span class="attr">exclude</span> = *.tmp, *.temp    <span class="comment"># æ’é™¤çš„æ–‡ä»¶ç±»å‹</span></span><br><span class="line">    recycle:<span class="attr">exclude_dir</span> = /tmp, /cache <span class="comment"># æ’é™¤çš„ç›®å½•</span></span><br><span class="line">    recycle:<span class="attr">noversions</span> = *.doc        <span class="comment"># ä¸ä¿ç•™ç‰ˆæœ¬çš„æ–‡ä»¶ç±»å‹</span></span><br><span class="line">    <span class="comment"># recycle:minsize = 1024            # æœ€å°æ–‡ä»¶å¤§å° (å•ä½: å­—èŠ‚)</span></span><br><span class="line">    <span class="comment"># recycle:days_kept = 30           # æ–‡ä»¶ä¿ç•™å¤©æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="section">[myshare]</span></span><br><span class="line">    <span class="attr">comment</span> = My Shared Folder</span><br><span class="line">    <span class="attr">path</span> = /path/to/myshare</span><br><span class="line">    <span class="comment"># ... å…¶ä»–å…±äº«é…ç½® ...</span></span><br><span class="line"></span><br><span class="line">    vfs <span class="attr">objects</span> = recycle  <span class="comment"># ä¹Ÿå¯ä»¥åœ¨å•ä¸ªå…±äº«ä¸­å¯ç”¨ recycle æ¨¡å—</span></span><br><span class="line">    recycle:<span class="attr">repository</span> = .recycle/%U <span class="comment">#å¯é€‰ï¼Œå¦‚æœéœ€è¦å’Œå…¨å±€ä¸ä¸€æ ·çš„é…ç½®</span></span><br></pre></td></tr></table></figure><p><strong>å‚æ•°è¯´æ˜:</strong></p><ul><li><strong><code>vfs objects = recycle</code></strong>: å¯ç”¨ <code>vfs_recycle</code> æ¨¡å—ã€‚å¯ä»¥æ”¾åœ¨ <code>[global]</code> éƒ¨åˆ†ï¼ˆå¯¹æ‰€æœ‰å…±äº«ç”Ÿæ•ˆï¼‰æˆ–å•ä¸ªå…±äº«é…ç½®éƒ¨åˆ†ï¼ˆåªå¯¹è¯¥å…±äº«ç”Ÿæ•ˆï¼‰ã€‚</li><li><strong><code>recycle:repository = .recycle/%U</code></strong>:<ul><li>æŒ‡å®šå›æ”¶ç«™ç›®å½•çš„ä½ç½®ã€‚</li><li><code>.recycle</code> æ˜¯å›æ”¶ç«™ç›®å½•çš„åç§°ï¼ˆå¯ä»¥è‡ªå®šä¹‰ï¼‰ã€‚</li><li><code>%U</code> æ˜¯ä¸€ä¸ªå˜é‡ï¼Œä»£è¡¨åˆ é™¤æ–‡ä»¶çš„ç”¨æˆ·åï¼Œè¿™æ ·å¯ä»¥ä¸ºæ¯ä¸ªç”¨æˆ·åˆ›å»ºå•ç‹¬çš„å›æ”¶ç«™ã€‚</li><li>ä¹Ÿå¯ä»¥ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œä¾‹å¦‚ <code>/path/to/recycle/%U</code>ã€‚</li><li>å¦‚æœä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚ <code>.recycle</code>ï¼‰ï¼Œå›æ”¶ç«™ç›®å½•ä¼šåˆ›å»ºåœ¨å…±äº«ç›®å½•çš„æ ¹ç›®å½•ä¸‹ã€‚</li></ul></li><li><strong><code>recycle:keeptree = Yes</code></strong>:  åœ¨å›æ”¶ç«™ä¸­ä¿ç•™æ–‡ä»¶è¢«åˆ é™¤å‰çš„åŸå§‹ç›®å½•ç»“æ„ã€‚å¦‚æœè®¾ç½®ä¸º <code>No</code>ï¼Œæ‰€æœ‰æ–‡ä»¶éƒ½ä¼šè¢«ç›´æ¥æ”¾åœ¨å›æ”¶ç«™æ ¹ç›®å½•ä¸‹ã€‚</li><li><strong><code>recycle:versions = Yes</code></strong>:<ul><li>å¦‚æœå›æ”¶ç«™ä¸­å·²ç»å­˜åœ¨åŒåæ–‡ä»¶ï¼Œæ˜¯å¦åˆ›å»ºæ–°ç‰ˆæœ¬ã€‚</li><li>è®¾ç½®ä¸º <code>Yes</code> æ—¶ï¼Œæ–°ç‰ˆæœ¬çš„æ–‡ä»¶åä¼šé™„åŠ ä¸€ä¸ªç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚ <code>file.txt.1</code>ã€<code>file.txt.2</code>ï¼‰ã€‚</li><li>è®¾ç½®ä¸º <code>No</code> æ—¶ï¼Œæ–°æ–‡ä»¶ä¼šè¦†ç›–æ—§æ–‡ä»¶ã€‚</li></ul></li><li><strong><code>recycle:touch = Yes</code></strong>:  å½“æ–‡ä»¶è¢«ç§»åŠ¨åˆ°å›æ”¶ç«™æ—¶ï¼Œæ›´æ–°æ–‡ä»¶çš„è®¿é—®æ—¶é—´ï¼ˆatimeï¼‰ã€‚</li><li><strong><code>recycle:maxsize = 0</code></strong>:<ul><li>è®¾ç½®å›æ”¶ç«™çš„æœ€å¤§å®¹é‡ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚</li><li><code>0</code> è¡¨ç¤ºæ— é™åˆ¶ã€‚</li><li>å½“å›æ”¶ç«™è¾¾åˆ°æœ€å¤§å®¹é‡æ—¶ï¼Œæœ€æ—©çš„æ–‡ä»¶ä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚</li></ul></li><li><strong><code>recycle:exclude = *.tmp, *.temp</code></strong>:  æŒ‡å®šä¸æ”¾å…¥å›æ”¶ç«™çš„æ–‡ä»¶ç±»å‹ï¼ˆä½¿ç”¨é€šé…ç¬¦ï¼‰ã€‚</li><li><strong><code>recycle:exclude_dir = /tmp, /cache</code></strong>:  æŒ‡å®šä¸æ”¾å…¥å›æ”¶ç«™çš„ç›®å½•ï¼ˆç»å¯¹è·¯å¾„ï¼‰ã€‚</li><li><strong><code>recycle:noversions = *.doc</code></strong>:  æŒ‡å®šä¸ä¿ç•™ç‰ˆæœ¬çš„æ–‡ä»¶ç±»å‹ï¼ˆå³ä½¿ <code>recycle:versions = Yes</code>ï¼‰ã€‚</li><li><strong><code>recycle:minsize = 1024</code></strong>:  æŒ‡å®šåªæœ‰å¤§äºæ­¤å¤§å°ï¼ˆå­—èŠ‚ï¼‰çš„æ–‡ä»¶æ‰ä¼šè¢«æ”¾å…¥å›æ”¶ç«™ã€‚</li><li><strong><code>recycle:days_kept = 30</code></strong>:  æŒ‡å®šæ–‡ä»¶åœ¨å›æ”¶ç«™ä¸­ä¿ç•™çš„å¤©æ•°ã€‚è¶…è¿‡æ­¤å¤©æ•°çš„æ–‡ä»¶ä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚</li></ul><p><strong>3. æ³¨æ„äº‹é¡¹</strong></p><ul><li><strong>æƒé™:</strong> ç¡®ä¿ Samba ç”¨æˆ·å¯¹å›æ”¶ç«™ç›®å½•æœ‰è¯»å†™æƒé™ã€‚</li><li><strong>æ€§èƒ½:</strong> å¦‚æœå›æ”¶ç«™ä¸­æ–‡ä»¶è¿‡å¤šï¼Œå¯èƒ½ä¼šå½±å“ Samba çš„æ€§èƒ½ã€‚å»ºè®®å®šæœŸæ¸…ç†å›æ”¶ç«™ã€‚</li><li><strong>åˆ é™¤</strong>: å›æ”¶ç«™ä¸­çš„æ–‡ä»¶ï¼Œæ˜¯çœŸæ­£è¢«åˆ é™¤ã€‚</li><li><strong>ä¸ç‰ˆæœ¬æ§åˆ¶çš„åŒºåˆ«:</strong> <code>vfs_recycle</code> æ¨¡å—åªæ˜¯ä¸€ä¸ªç®€å•çš„å›æ”¶ç«™åŠŸèƒ½ï¼Œå®ƒä¸èƒ½åƒ Gitã€SVN é‚£æ ·è¿›è¡Œç»†ç²’åº¦çš„ç‰ˆæœ¬æ§åˆ¶ï¼ˆè®°å½•æ¯æ¬¡ä¿®æ”¹ã€å›æ»šåˆ°ç‰¹å®šç‰ˆæœ¬ç­‰ï¼‰ã€‚å®ƒåªèƒ½æ¢å¤è¢«åˆ é™¤çš„æ–‡ä»¶ï¼Œè€Œä¸èƒ½æ¢å¤æ–‡ä»¶çš„å†å²ç‰ˆæœ¬ï¼ˆé™¤éå¯ç”¨äº† <code>recycle:versions</code> å¹¶ä¸”æ–‡ä»¶åç›¸åŒï¼‰ã€‚</li><li><strong>å®¢æˆ·ç«¯å…¼å®¹æ€§</strong>: é€šè¿‡smbåˆ é™¤çš„æ–‡ä»¶æ‰ä¼šè¿›å…¥å›æ”¶ç«™ï¼Œç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šé€šè¿‡<code>rm</code>ç­‰å‘½ä»¤åˆ é™¤ï¼Œä¸ä¼šè¿›å…¥å›æ”¶ç«™ã€‚</li></ul><p><strong>4. ä½¿ç”¨æ–¹æ³•</strong></p><p>é…ç½®å®Œæˆåï¼Œç”¨æˆ·é€šè¿‡ Samba å®¢æˆ·ç«¯åˆ é™¤æ–‡ä»¶æ—¶ï¼Œæ–‡ä»¶ä¼šè‡ªåŠ¨è¿›å…¥å›æ”¶ç«™ã€‚ç®¡ç†å‘˜å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ç®¡ç†å›æ”¶ç«™ï¼š</p><ul><li><strong>ç›´æ¥è®¿é—®å›æ”¶ç«™ç›®å½•:</strong> å›æ”¶ç«™ç›®å½•é€šå¸¸ä½äºå…±äº«ç›®å½•çš„æ ¹ç›®å½•ä¸‹ï¼ˆå¦‚æœä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼‰æˆ–æŒ‡å®šçš„ç»å¯¹è·¯å¾„ä¸‹ã€‚ç®¡ç†å‘˜å¯ä»¥ç›´æ¥è®¿é—®è¯¥ç›®å½•æ¥æŸ¥çœ‹ã€æ¢å¤æˆ–åˆ é™¤å›æ”¶ç«™ä¸­çš„æ–‡ä»¶ã€‚</li><li><strong>ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·:</strong> å¯ä»¥ç¼–å†™è„šæœ¬ï¼Œå®šæœŸæ¸…ç†å›æ”¶ç«™ä¸­è¶…è¿‡ä¿ç•™æ—¶é—´çš„æ–‡ä»¶ã€‚</li></ul><p>é€šè¿‡åˆç†é…ç½® <code>vfs_recycle</code> æ¨¡å—ï¼Œä½ å¯ä»¥ä¸º Samba å…±äº«æä¾›ä¸€ä¸ªç®€å•æœ‰æ•ˆçš„å›æ”¶ç«™åŠŸèƒ½ï¼Œé˜²æ­¢ç”¨æˆ·è¯¯åˆ é™¤æ–‡ä»¶ï¼Œæé«˜æ•°æ®å®‰å…¨æ€§ã€‚</p><h2 id="about-me-ä¸ªäººå¾®ä¿¡">about me ä¸ªäººå¾®ä¿¡</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/me.jpeg?Expires=1741078870&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=3OQ42kDkDuA1517Z6lKc2ZUhiQU%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p><h2 id="wechat-offical-å¾®ä¿¡å…¬ä¼—å·">wechat offical å¾®ä¿¡å…¬ä¼—å·</h2><p><img src="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" class="lazyload placeholder" data-srcset="https://czq-blog.oss-cn-beijing.aliyuncs.com/wechat.jpg?Expires=1741078900&amp;OSSAccessKeyId=TMP.3Kqnu2nGq3bZ4KHKg3CKb4cix6tBsmx7Nhi7A7qcv84ZvM8W24oGTuKCih6se8FQJtPuh8fHNK6NqbkbsbkDAwGCfmeBHV&amp;Signature=y3fPR2LjlkZXW%2FAQCh5n%2ByfHcxQ%3D" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;strong&gt;ä¸€ã€æ­å»º Git æœåŠ¡å™¨å¹¶é€šè¿‡ Samba å…±äº«&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;è¿™ç§æ–¹å¼ä¸‹ï¼ŒGit æœåŠ¡å™¨æœ¬èº«å¤„ç†ç‰ˆæœ¬æ§åˆ¶é€»è¾‘ï¼ŒSamba åªè´Ÿè´£å…±äº« Git ä»“åº“æ‰€åœ¨çš„ç›®å½•ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;1. å®‰è£… Git å’Œ Samba&lt;/stron</summary>
      
    
    
    
    
    <category term="git" scheme="https://caozhaoqi.github.io/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>ä¼ä¸šçº§VPNæ­å»ºæ–¹æ¡ˆå¯¹æ¯”ä¸æŒ‡å¯¼</title>
    <link href="https://caozhaoqi.github.io/2025/03/17/vpn-ee-build/"/>
    <id>https://caozhaoqi.github.io/2025/03/17/vpn-ee-build/</id>
    <published>2025-03-17T06:18:31.000Z</published>
    <updated>2025-11-25T15:05:10.374Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æŠ€æœ¯é€‰å‹">æŠ€æœ¯é€‰å‹</h2><ul><li><p><strong>SoftEther VPN:</strong></p><ul><li><strong>æœåŠ¡ç«¯:</strong> SoftEther VPN Server</li><li><strong>å®¢æˆ·ç«¯:</strong> SoftEther VPN Client (å®˜æ–¹æä¾›ï¼Œè·¨å¹³å°), æˆ–è€…å…¶ä»–å…¼å®¹çš„ VPN å®¢æˆ·ç«¯ (å¦‚ OpenVPN å®¢æˆ·ç«¯, ç³»ç»Ÿå†…ç½®çš„ L2TP/IPsec å®¢æˆ·ç«¯ç­‰)</li></ul></li><li><p><strong>OpenVPN Access Server:</strong></p><ul><li><strong>æœåŠ¡ç«¯:</strong> OpenVPN Access Server</li><li><strong>å®¢æˆ·ç«¯:</strong> OpenVPN Connect (å®˜æ–¹æä¾›ï¼Œè·¨å¹³å°), æˆ–è€…å…¶ä»–å…¼å®¹çš„ OpenVPN å®¢æˆ·ç«¯</li></ul></li><li><p><strong>WireGuard (é€šè¿‡ Algo æˆ– wg-easy):</strong></p><ul><li><strong>æœåŠ¡ç«¯:</strong> Algo æˆ– wg-easy éƒ¨ç½²çš„ WireGuard æœåŠ¡</li><li><strong>å®¢æˆ·ç«¯:</strong> WireGuard å®˜æ–¹å®¢æˆ·ç«¯ (è·¨å¹³å°)</li></ul></li><li><p><strong>Pritunl:</strong></p><ul><li><strong>æœåŠ¡ç«¯:</strong> Pritunl Server</li><li><strong>å®¢æˆ·ç«¯:</strong> Pritunl Client (å®˜æ–¹æä¾›ï¼Œè·¨å¹³å°), æˆ–è€…å…¶ä»–å…¼å®¹çš„ OpenVPN å®¢æˆ·ç«¯.</li></ul></li></ul><h2 id="æ–¹æ¡ˆé€‰æ‹©">æ–¹æ¡ˆé€‰æ‹©</h2><p>é€‰æ‹© wg-easy + WireGuardï¼Ÿ**</p><ul><li><strong>ç®€å•æ€§:</strong> WireGuard çš„é…ç½®éå¸¸ç®€æ´ï¼Œè€Œ wg-easy è¿›ä¸€æ­¥ç®€åŒ–äº†éƒ¨ç½²å’Œç®¡ç†è¿‡ç¨‹ï¼Œæä¾›äº†å›¾å½¢åŒ–ç•Œé¢ã€‚</li><li><strong>é€Ÿåº¦:</strong> WireGuard ä»¥å…¶å“è¶Šçš„æ€§èƒ½è€Œé—»åï¼Œæ¯” OpenVPN å’Œ IPsec æ›´å¿«ã€‚</li><li><strong>å®‰å…¨æ€§:</strong> WireGuard ä½¿ç”¨æœ€å…ˆè¿›çš„åŠ å¯†æŠ€æœ¯ï¼Œå¹¶ä¸”ä»£ç åº“éå¸¸å°ï¼Œæ˜“äºå®¡è®¡ã€‚</li><li><strong>æœªæ¥è¶‹åŠ¿:</strong> WireGuard æ­£åœ¨è¿…é€Ÿæˆä¸º VPN åè®®çš„æ–°æ ‡å‡†ï¼Œè®¸å¤šå¤§å‹å…¬å¸å’Œé¡¹ç›®éƒ½åœ¨é‡‡ç”¨å®ƒã€‚</li><li><strong>Dockeréƒ¨ç½²:</strong> æ–¹ä¾¿éƒ¨ç½²ã€æ›´æ–°å’Œè¿ç§»ã€‚</li></ul><p><strong>è¯¦ç»†æ­å»ºæ­¥éª¤ï¼š</strong></p><p><strong>1. å‡†å¤‡å·¥ä½œ</strong></p><ul><li><strong>æœåŠ¡å™¨ï¼š</strong><ul><li>ä¸€å°å…·æœ‰å…¬ç½‘ IP åœ°å€çš„æœåŠ¡å™¨ï¼ˆVPS æˆ– ç‹¬ç«‹æœåŠ¡å™¨ï¼‰ã€‚</li><li>æ“ä½œç³»ç»Ÿï¼šæ¨èä½¿ç”¨ Linux å‘è¡Œç‰ˆï¼ˆå¦‚ Ubuntu Serverã€Debianã€CentOSï¼‰ã€‚</li><li>æœåŠ¡å™¨éœ€è¦å¼€æ”¾ UDP 51820 ç«¯å£ (WireGuard é»˜è®¤ç«¯å£) å’Œ TCP 51821 ç«¯å£ (wg-easy Web UI ç«¯å£).  å¦‚æœä½ ä½¿ç”¨äº‘æœåŠ¡å•†, éœ€è¦åœ¨å®‰å…¨ç»„/é˜²ç«å¢™è§„åˆ™ä¸­æ”¾è¡Œè¿™ä¸¤ä¸ªç«¯å£.</li></ul></li><li><strong>åŸŸå (å¯é€‰ï¼Œå¼ºçƒˆæ¨è)ï¼š</strong><ul><li>ä¸€ä¸ªåŸŸåï¼Œä¾‹å¦‚ <code>vpn.yourcompany.com</code>ã€‚</li><li>å°†åŸŸåè§£æåˆ°æ‚¨çš„æœåŠ¡å™¨å…¬ç½‘ IP åœ°å€ã€‚</li></ul></li><li><strong>æœ¬åœ°ç¯å¢ƒï¼š</strong><ul><li>å®‰è£…äº† Docker å’Œ Docker Compose çš„ç”µè„‘ï¼ˆç”¨äºç®¡ç†æœåŠ¡å™¨ä¸Šçš„ wg-easy å®¹å™¨ï¼‰ã€‚</li></ul></li></ul><p><strong>2. æœåŠ¡å™¨ç«¯éƒ¨ç½² (ä½¿ç”¨ wg-easy)</strong></p><ul><li><p><strong>SSH è¿æ¥åˆ°æ‚¨çš„æœåŠ¡å™¨ã€‚</strong></p></li><li><p><strong>å®‰è£… Docker å’Œ Docker Composeï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu/Debian</span></span><br><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install docker.io docker-compose -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS</span></span><br><span class="line"><span class="built_in">sudo</span> yum install -y yum-utils</span><br><span class="line"><span class="built_in">sudo</span> yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"><span class="built_in">sudo</span> yum install docker-ce docker-ce-cli containerd.io -y</span><br><span class="line"><span class="built_in">sudo</span> systemctl start docker</span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> docker</span><br><span class="line"><span class="built_in">sudo</span> curl -L <span class="string">&quot;https://github.com/docker/compose/releases/download/v2.2.2/docker-compose-<span class="subst">$(uname -s)</span>-<span class="subst">$(uname -m)</span>&quot;</span> -o /usr/local/bin/docker-compose  <span class="comment">#æ³¨æ„, è¿™ä¸ªç‰ˆæœ¬å·å¯èƒ½ä¼šè¿‡æ—¶, è¯·å» https://github.com/docker/compose/releases/ ç¡®è®¤æœ€æ–°ç‰ˆæœ¬.</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> +x /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure></li><li><p><strong>åˆ›å»º <code>docker-compose.yml</code> æ–‡ä»¶ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano docker-compose.yml</span><br></pre></td></tr></table></figure><p>å°†ä»¥ä¸‹å†…å®¹å¤åˆ¶åˆ°æ–‡ä»¶ä¸­ï¼Œå¹¶æ ¹æ®æ‚¨çš„å®é™…æƒ…å†µä¿®æ”¹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">wg-easy:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">weejewel/wg-easy</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">wg-easy</span></span><br><span class="line">    <span class="attr">cap_add:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">NET_ADMIN</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SYS_MODULE</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">WG_HOST=your_server_public_ip_or_domain</span>  <span class="comment"># æ›¿æ¢ä¸ºä½ çš„æœåŠ¡å™¨å…¬ç½‘ IP æˆ–åŸŸå</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PASSWORD=your_web_ui_password</span>  <span class="comment"># æ›¿æ¢ä¸º Web UI çš„å¯†ç ï¼ŒåŠ¡å¿…è®¾ç½®å¼ºå¯†ç ï¼</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">WG_DEFAULT_ADDRESS=10.8.0.x</span>  <span class="comment"># VPN å®¢æˆ·ç«¯çš„ IP åœ°å€æ®µï¼Œä¸è¦ä¸å†…ç½‘ IP å†²çª</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">WG_DEFAULT_DNS=1.1.1.1</span>  <span class="comment"># é»˜è®¤ DNS æœåŠ¡å™¨ï¼Œå¯ä»¥æ”¹ä¸ºå†…ç½‘ DNS æˆ–å…¶ä»–å…¬å…± DNS</span></span><br><span class="line">      <span class="comment"># å…¶ä»–å¯é€‰ç¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼‰ï¼š</span></span><br><span class="line">      <span class="comment"># - WG_PORT=51820  # WireGuard ç›‘å¬ç«¯å£ï¼Œé»˜è®¤ä¸º 51820</span></span><br><span class="line">      <span class="comment"># - WG_ALLOWED_IPS=0.0.0.0/0  # å…è®¸è¿æ¥çš„å®¢æˆ·ç«¯ IP èŒƒå›´ï¼Œé»˜è®¤ä¸ºæ‰€æœ‰ IP</span></span><br><span class="line">      <span class="comment"># - WG_MTU=1420  # MTU å€¼ï¼Œé€šå¸¸ä¸éœ€è¦ä¿®æ”¹</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./wg-data:/etc/wireguard</span>  <span class="comment"># å°† WireGuard é…ç½®æŒä¹…åŒ–åˆ°å®¿ä¸»æœºçš„ ./wg-data ç›®å½•</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;51820:51820/udp&quot;</span>  <span class="comment"># WireGuard ç«¯å£</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;51821:51821/tcp&quot;</span>  <span class="comment"># wg-easy Web UI ç«¯å£</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">sysctls:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">net.ipv4.ip_forward=1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">net.ipv4.conf.all.src_valid_mark=1</span></span><br></pre></td></tr></table></figure></li><li><p><strong>å¯åŠ¨ wg-easy å®¹å™¨ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure></li><li><p><strong>ç¡®è®¤å®¹å™¨æ­£åœ¨è¿è¡Œï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></table></figure><p>åº”è¯¥èƒ½çœ‹åˆ°åä¸º <code>wg-easy</code> çš„å®¹å™¨æ­£åœ¨è¿è¡Œã€‚</p></li></ul><p><strong>3. é…ç½® wg-easy Web UI</strong></p><ul><li><strong>åœ¨æµè§ˆå™¨ä¸­è®¿é—® <code>http://your_server_ip:51821</code> æˆ– <code>http://your_domain:51821</code>ã€‚</strong></li><li><strong>ä½¿ç”¨æ‚¨åœ¨ <code>docker-compose.yml</code> æ–‡ä»¶ä¸­è®¾ç½®çš„å¯†ç ç™»å½•ã€‚</strong></li><li><strong>åœ¨ Web UI ä¸­åˆ›å»ºå®¢æˆ·ç«¯é…ç½®ï¼š</strong><ul><li>ç‚¹å‡» â€œNewâ€ æŒ‰é’®ã€‚</li><li>è¾“å…¥å®¢æˆ·ç«¯åç§°ï¼ˆä¾‹å¦‚ â€œuser1â€ï¼‰ã€‚</li><li>ç‚¹å‡» â€œCreateâ€ æŒ‰é’®ã€‚</li><li>ç‚¹å‡»æ–°åˆ›å»ºçš„å®¢æˆ·ç«¯æ—è¾¹çš„ä¸‹è½½æŒ‰é’®ï¼Œä¸‹è½½ <code>.conf</code> é…ç½®æ–‡ä»¶ã€‚  æˆ–è€…ç‚¹å‡»äºŒç»´ç å›¾æ ‡, ç”¨æ‰‹æœºå®¢æˆ·ç«¯æ‰«æäºŒç»´ç .</li></ul></li></ul><p><strong>4. å®¢æˆ·ç«¯é…ç½®</strong></p><ul><li><p><strong>ä¸‹è½½å¹¶å®‰è£… WireGuard å®¢æˆ·ç«¯ï¼š</strong></p><ul><li><strong>Windowsã€macOSã€Androidã€iOSï¼š</strong> ä» WireGuard å®˜ç½‘ä¸‹è½½å¹¶å®‰è£…ç›¸åº”çš„å®¢æˆ·ç«¯ï¼š<a href="https://www.wireguard.com/install/">https://www.wireguard.com/install/</a></li><li><strong>Linux:</strong> ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu/Debian</span></span><br><span class="line"><span class="built_in">sudo</span> apt install wireguard</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS</span></span><br><span class="line"><span class="built_in">sudo</span> yum install epel-release</span><br><span class="line"><span class="built_in">sudo</span> yum install wireguard-tools</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>å¯¼å…¥å®¢æˆ·ç«¯é…ç½®æ–‡ä»¶ï¼š</strong></p><ul><li><strong>Windowsã€macOSã€Androidã€iOSï¼š</strong> æ‰“å¼€ WireGuard å®¢æˆ·ç«¯ï¼Œç‚¹å‡» â€œImport tunnel(s) from fileâ€ï¼Œé€‰æ‹©æ‚¨ä» wg-easy Web UI ä¸‹è½½çš„ <code>.conf</code> æ–‡ä»¶ã€‚</li><li><strong>Linux:</strong> å°† <code>.conf</code> æ–‡ä»¶å¤åˆ¶åˆ° <code>/etc/wireguard/</code> ç›®å½•ï¼Œå¹¶é‡å‘½åä¸º <code>wg0.conf</code> (æˆ–å…¶ä»–æ‚¨å–œæ¬¢çš„åç§°, ä¾‹å¦‚<code>client1.conf</code>)ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> user1.conf /etc/wireguard/wg0.conf</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>è¿æ¥ VPNï¼š</strong></p><ul><li><strong>Windowsã€macOSã€Androidã€iOSï¼š</strong> åœ¨ WireGuard å®¢æˆ·ç«¯ä¸­ï¼Œç‚¹å‡»æ‚¨å¯¼å…¥çš„é…ç½®æ–‡ä»¶çš„ â€œActivateâ€ æˆ– â€œConnectâ€ æŒ‰é’®ã€‚</li><li><strong>Linux:</strong> ä½¿ç”¨ <code>wg-quick</code> å‘½ä»¤å¯åŠ¨ VPN è¿æ¥ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> wg-quick up wg0  <span class="comment"># wg0 æ˜¯æ‚¨çš„é…ç½®æ–‡ä»¶åï¼ˆä¸å¸¦ .confï¼‰</span></span><br><span class="line"><span class="comment"># æ–­å¼€è¿æ¥ï¼š</span></span><br><span class="line"><span class="built_in">sudo</span> wg-quick down wg0</span><br><span class="line"> <span class="comment">#è®¾ç½®å¼€æœºè‡ªå¯</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> wg-quick@wg0</span><br></pre></td></tr></table></figure></li></ul></li></ul><p><strong>5. æµ‹è¯•è¿æ¥</strong></p><ul><li>è¿æ¥ VPN åï¼Œè®¿é—®ä¸€ä¸ªå¯ä»¥æ˜¾ç¤ºæ‚¨ IP åœ°å€çš„ç½‘ç«™ï¼ˆä¾‹å¦‚ <a href="https://www.whatismyip.com/">https://www.whatismyip.com/</a>ï¼‰ï¼Œç¡®è®¤æ‚¨çš„ IP åœ°å€å·²å˜ä¸ºæœåŠ¡å™¨çš„å…¬ç½‘ IP åœ°å€ã€‚</li><li>å°è¯•è®¿é—®æ‚¨å†…ç½‘çš„èµ„æºï¼Œç¡®è®¤å¯ä»¥æ­£å¸¸è®¿é—®ã€‚</li></ul><p><strong>åç»­ç»´æŠ¤ï¼š</strong></p><ul><li><strong>æ·»åŠ æ–°ç”¨æˆ·ï¼š</strong> åœ¨ wg-easy Web UI ä¸­åˆ›å»ºæ–°çš„å®¢æˆ·ç«¯é…ç½®å³å¯ã€‚</li><li><strong>æ’¤é”€ç”¨æˆ·ï¼š</strong> åœ¨ wg-easy Web UI ä¸­åˆ é™¤ç›¸åº”çš„å®¢æˆ·ç«¯é…ç½®ã€‚</li><li><strong>æ›´æ–° wg-easyï¼š</strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-compose pull</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure></li><li><strong>æŸ¥çœ‹ WireGuard çŠ¶æ€:</strong> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> wg show</span><br></pre></td></tr></table></figure></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;æŠ€æœ¯é€‰å‹&quot;&gt;æŠ€æœ¯é€‰å‹&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;SoftEther VPN:&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;æœåŠ¡ç«¯:&lt;/strong&gt; SoftEther VPN Server&lt;/li&gt;
&lt;li&gt;&lt;stron</summary>
      
    
    
    
    
  </entry>
  
</feed>
